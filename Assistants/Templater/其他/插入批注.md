<%* 
let position = await tp.system.suggester(
    ["å³ä¾§æ‰¹æ³¨ï¼ˆçº¯æ–‡æœ¬ï¼‰", "å·¦ä¾§æ‰¹æ³¨ï¼ˆçº¯æ–‡æœ¬ï¼‰", "å³ä¾§æ‰¹æ³¨+æœ¬åœ°å›¾ç‰‡", "å·¦ä¾§æ‰¹æ³¨+æœ¬åœ°å›¾ç‰‡"],
    ["right", "left", "right-image", "left-image"]
);

if (position) {
    let userInput = await tp.system.prompt("è¯·è¾“å…¥æ‰¹æ³¨å†…å®¹");
    if (userInput) {
        if (position === "left") {
            tR += `<sup>ğŸ’¬</sup><span class="sidenote-L">${userInput}<img src="" width="100"></span> `;
        } else if (position === "right") {
            tR += `<sup>ğŸ’¬</sup><span class="sidenote">${userInput}<img src="" width="100"></span> `;
        } else if (position === "left-image" || position === "right-image") {
            try {
                // è·å– LocalImagePicker.js æ–‡ä»¶
                const file = app.vault.getAbstractFileByPath('Assistants/Templater/Scripï¼ˆç”¨äºæ›´æ–°ï¼Œå‹¿åˆ ï¼‰/LocalImagePicker.js');
                if (!file) {
                    throw new Error('æ‰¾ä¸åˆ° LocalImagePicker.js æ–‡ä»¶');
                }
                
                // è¯»å–æ–‡ä»¶å†…å®¹
                const content = await app.vault.read(file);
                
                // ä½¿ç”¨ Function æ„é€ å™¨æ¥æ‰§è¡Œä»£ç 
                const LocalImagePicker = (new Function('tp', 'tR', 'settings', content + '; return LocalImagePicker;'))(tp, tR, {
                    size: ["100x100"],
                    useMask: false
                });
                
                // åˆ›å»ºå›¾ç‰‡é€‰æ‹©å™¨å®ä¾‹å¹¶ç›´æ¥è®¾ç½®å°ºå¯¸
                const imagePicker = new LocalImagePicker(tp, tR, {
                    size: ["100x100"],
                    useMask: false
                });
                imagePicker.selectedSize = "100x100"; // ç›´æ¥è®¾ç½®å°ºå¯¸ï¼Œè·³è¿‡é€‰æ‹©æ­¥éª¤
                
                // è·å–é€‰æ‹©çš„å›¾ç‰‡
                const result = await imagePicker.createImageSelectionModal();
                
                // æå–å›¾ç‰‡è·¯å¾„
                const imgMatch = result.match(/src="([^"]+)"/);
                const imgPath = imgMatch ? imgMatch[1] : '';
                
                // æ ¹æ®ä½ç½®æ·»åŠ æ‰¹æ³¨ï¼Œä½¿ç”¨ç®€åŒ–çš„æ ¼å¼
                if (position === "left-image") {
                    tR += `<sup>ğŸ’¬</sup><span class="sidenote-L">${userInput}<img src="${imgPath}" width="100"></span> `;
                } else {
                    tR += `<sup>ğŸ’¬</sup><span class="sidenote">${userInput}<img src="${imgPath}" width="100"></span> `;
                }
            } catch (error) {
                console.error('åŠ è½½å›¾ç‰‡é€‰æ‹©å™¨æ—¶å‡ºé”™:', error);
                tR += `<span class="sidenote">åŠ è½½å›¾ç‰‡é€‰æ‹©å™¨å¤±è´¥: ${error.message}</span>`;
            }
        }
    } else {
        tR += `<span class="sidenote">è¯·è¾“å…¥æ‰¹æ³¨å†…å®¹</span>`;
    }
} 
_%>