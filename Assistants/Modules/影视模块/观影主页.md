---
cssclasses:
  - cards
  - cards-cover, cards-2-3, table-max, cards-cols-6
---

`````ad-flex
collapse: open
color:
icon: film
<div style="width:100%;flex: none;">

ç±»å‹`INPUT[inlineSelect(option(å…¨éƒ¨),option(å–œå‰§), option(çˆ±æƒ…), option(åŠ¨ä½œ), option(ç§‘å¹»), option(åŠ¨ç”»), option(æ‚¬ç–‘), option(çŠ¯ç½ª), option(æƒŠæ‚š), option(å†’é™©), option(éŸ³ä¹), option(å†å²), option(å¥‡å¹»), option(ææ€–), option(æˆ˜äº‰), option(ä¼ è®°), option(æ­Œèˆ), option(æ­¦ä¾ ), option(æƒ…è‰²), option(ç¾éš¾), option(è¥¿éƒ¨), option(çºªå½•ç‰‡), option(çŸ­ç‰‡)):moviegenre.genre0]` `INPUT[text(placeholder(ğŸ”æœç´¢è¯)):moviesearch.search0]`  æ’åº`INPUT[inlineSelect(option(score), option(datePublished)):moviesort.sort0]` `INPUT[text(placeholder(ğŸ“…å¹´ä»½/ä»£),class(meta-bind-small-width)):movieyear.year0]` åœ°åŒº`INPUT[inlineSelect(option(å…¨éƒ¨åœ°åŒº),option(ä¸­å›½å¤§é™†),option(ä¸­å›½é¦™æ¸¯), option(ä¸­å›½å°æ¹¾),option(ç¾å›½), option(æ³•å›½), option(æ—¥æœ¬), option(å°åº¦), option(è‹±å›½), option(éŸ©å›½), option(å¾·å›½), option(æ„å¤§åˆ©), option(è¥¿ç­ç‰™), option(æ³°å›½), option(ä¿„ç½—æ–¯), option(åŠ æ‹¿å¤§), option(çˆ±å°”å…°), option(ç‘å…¸), option(å·´è¥¿), option(ä¸¹éº¦)):moviecountry.country0]`

````dataviewjs
// åˆ›å»ºæ ·å¼
const style = dv.container.createEl("style");
style.textContent = `
    .table-wrapper {
        width: 100%;
    }
    .movie-cover img {
        max-width: 200px;
        height: auto;
        border-radius: 8px;
    }
`;

// åˆ›å»ºè¡¨æ ¼åŒ…è£…å™¨
const tableWrapper = dv.container.createEl("div", {
    cls: "table-wrapper cards"
});

// ä»å¯¹è±¡ä¸­è·å–ç‰¹å®šå‰ç¼€çš„å€¼
const getTermsFromObject = (obj, prefix) => {
    if (!obj) return [];
    return Object.keys(obj)
        .filter(key => key.startsWith(prefix))
        .map(key => String(obj[key]))
        .filter(Boolean);
};

// è·å–å¹´ä»½å€¼
const getAllYearTerms = (current) => 
    getTermsFromObject(current?.movieyear, 'year0');

// è·å–ç±»å‹å€¼
const getAllGenreTerms = (current) => {
    const genres = getTermsFromObject(current?.moviegenre, 'genre0');
    return genres.length > 0 ? genres : ['å…¨éƒ¨'];
};

// è·å–æœç´¢å€¼
const getAllSearchTerms = (current) => 
    getTermsFromObject(current?.moviesearch, 'search0');

// è·å–æ’åºå€¼
const getAllSortTerms = (current) => {
    const sorts = getTermsFromObject(current?.moviesort, 'sort0');
    return sorts.length > 0 ? sorts : ['score'];
};

// è·å–å›½å®¶å€¼
const getAllCountryTerms = (current) => {
    const countries = getTermsFromObject(current?.moviecountry, 'country0')
        .concat(getTermsFromObject(current?.moviecountry, 'country1'));
    return countries.length > 0 ? countries : ['å…¨éƒ¨åœ°åŒº'];
};

// å°†å€¼è½¬æ¢ä¸ºå­—ç¬¦ä¸²
const safeToString = (value) => 
    Array.isArray(value) ? value.map(v => String(v || '')).join(' ') : String(value || '');

// è§£ææœç´¢è¯­æ³•
const parseSearchTerms = (searchString) => {
    const terms = { and: [], or: [], not: [] };
    searchString.split('|')
        .map(s => s.trim())
        .filter(Boolean)
        .forEach(group => {
            group.split(' ')
                .filter(Boolean)
                .forEach(word => {
                    if (word.startsWith('-')) {
                        const notTerm = word.slice(1).toLowerCase();
                        if (notTerm) terms.not.push(notTerm);
                    } else if (group.includes('|')) {
                        terms.or.push(word.toLowerCase());
                    } else {
                        terms.and.push(word.toLowerCase());
                    }
                });
        });
    return terms;
};

// æ£€æŸ¥æ–‡æœ¬æ˜¯å¦åŒ¹é…æœç´¢æ¡ä»¶
const matchesSearchTerms = (text, searchTerms) => {
    const normalizedText = text.toLowerCase();
    return (!searchTerms.and.length || searchTerms.and.every(term => normalizedText.includes(term))) &&
           (!searchTerms.or.length || searchTerms.or.some(term => normalizedText.includes(term))) &&
           searchTerms.not.every(term => !normalizedText.includes(term));
};

// æ£€æŸ¥æ—¥æœŸæ˜¯å¦åŒ¹é…å¹´ä»½æœç´¢æ¡ä»¶
const matchesYear = (page, yearTerms) => {
    if (!yearTerms?.length) return true;
    const pageYear = page.datePublished ? 
        new Date(page.datePublished).getFullYear().toString() : null;
    return pageYear && yearTerms.some(year => pageYear.includes(year));
};

// æ£€æŸ¥ç”µå½±æ˜¯å¦åŒ¹é…å›½å®¶æ¡ä»¶
const matchesCountry = (page, countryTerms) => {
    if (!countryTerms?.length || countryTerms.includes('å…¨éƒ¨åœ°åŒº')) return true;
    const pageCountries = Array.isArray(page.country) ? page.country : [page.country];
    return countryTerms.some(country => pageCountries.includes(country));
};

// æ’åºå‡½æ•°
const sortMovies = (pages, sortTerms) => {
    const sortFunctions = {
        score: (a, b) => (parseFloat(b.score) || 0) - (parseFloat(a.score) || 0),
        datePublished: (a, b) => (b.datePublished ? new Date(b.datePublished) : new Date(0)) - 
                                (a.datePublished ? new Date(a.datePublished) : new Date(0)),
        title: (a, b) => safeToString(a.file?.name).localeCompare(safeToString(b.file?.name))
    };

    return pages.sort((a, b) => {
        for (const sortBy of sortTerms) {
            const comparison = sortFunctions[sortBy]?.(a, b) || 0;
            if (comparison !== 0) return comparison;
        }
        return 0;
    });
};

// å¤„ç†å›¾ç‰‡è·¯å¾„çš„å‡½æ•°
const getImageHtml = (page) => {
    if (!page?.imageData) return "";
    
    // ç¡®ä¿ imgData æ˜¯å­—ç¬¦ä¸²
    const imgData = String(page.imageData);
    const altText = safeToString(page.file?.name);
    
    // æ·»åŠ è°ƒè¯•æ—¥å¿—
    console.log('Processing image:', { imgData, type: typeof imgData });
    
    // å¤„ç† base64 æˆ– URL
    if (imgData.startsWith('data:') || imgData.startsWith('http')) {
        return `<div class="movie-cover"><img src="${imgData}" alt="${altText}"></div>`;
    }
    
    // å¤„ç† wiki é“¾æ¥æ ¼å¼
    if (imgData.includes('![[') && imgData.includes(']]')) {
        const startIndex = imgData.indexOf('![[') + 3;
        const endIndex = imgData.indexOf(']]');
        if (startIndex > 2 && endIndex > startIndex) {
            const imageName = imgData.slice(startIndex, endIndex);
            try {
                // ä½¿ç”¨ getFirstLinkpathDest è·å–å®é™…æ–‡ä»¶è·¯å¾„
                const imageFile = app.metadataCache.getFirstLinkpathDest(imageName, page.file.path);
                if (imageFile) {
                    const imagePath = app.vault.adapter.getResourcePath(imageFile.path);
                    return `<div class="movie-cover"><img src="${imagePath}" alt="${altText}"></div>`;
                }
                console.log('Wiki image processing:', { imageName, imageFile });
            } catch (error) {
                console.error('Error processing wiki image link:', error);
            }
        }
    }
    
    // å¤„ç†æ™®é€šæœ¬åœ°è·¯å¾„
    try {
        const imagePath = app.vault.adapter.getResourcePath(
            app.metadataCache.getFirstLinkpathDest(imgData, page.file.path)?.path || imgData
        );
        return `<div class="movie-cover"><img src="${imagePath}" alt="${altText}"></div>`;
    } catch (error) {
        console.error('Error processing image path:', error);
        return "";
    }
};

// åˆ›å»ºæ›´æ–°å‡½æ•°ä»¥å“åº”ç­›é€‰æ¡ä»¶å˜åŒ–
const updateTable = (genres, searches, years, sorts, countries) => {
    let moviePages = dv.pages('"Documents/Douban/movie"');
    
    if (!genres.includes('å…¨éƒ¨')) {
        moviePages = moviePages.where(p => {
            const pageGenres = Array.isArray(p.genre) ? p.genre : [p.genre];
            return genres.some(genre => pageGenres.includes(genre));
        });
    }
    
    if (searches.length || years.length || !countries.includes('å…¨éƒ¨åœ°åŒº')) {
        moviePages = moviePages.where(p => {
            const searchFields = [
                p.file?.name,
                p.director,
                p.description,
                p.genre
            ].map(safeToString).join(' ');

            const matchesSearch = !searches.length || searches.some(search => 
                matchesSearchTerms(searchFields, parseSearchTerms(search))
            );

            return matchesSearch && matchesYear(p, years) && matchesCountry(p, countries);
        });
    }

    moviePages = sortMovies(moviePages, sorts);

    const headers = ["Cover", "Title", "Director", "Rating"];
    const rows = moviePages.map(page => [
        getImageHtml(page),
        page.file?.link || '',
        page.director ? `**å¯¼æ¼”: ${Array.isArray(page.director) ? page.director.join(", ") : page.director}**` : "",
        page.score ? `è¯„ä»·: ${page.score} (${page.scoreStar || ''})` : ""
    ]);

    tableWrapper.innerHTML = '';
    dv.table(headers, rows, tableWrapper);
};

// åˆå§‹åŒ–è¡¨æ ¼
const current = dv.current();
updateTable(
    getAllGenreTerms(current),
    getAllSearchTerms(current),
    getAllYearTerms(current),
    getAllSortTerms(current),
    getAllCountryTerms(current)
);

// è®¾ç½®å®¹å™¨æ ·å¼å’Œç±»
dv.container.style.maxWidth = "100%";
dv.container.style.overflow = "auto";

const gridClasses = Array.from(
    dv.container.closest('.markdown-preview-view')?.classList || []
).filter(cls => cls.startsWith('cards-cols-'));

if (gridClasses.length) {
    tableWrapper.classList.add(...gridClasses);
}
````
</div>
`````

