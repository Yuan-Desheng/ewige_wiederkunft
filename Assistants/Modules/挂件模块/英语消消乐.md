---
title: 倒计时模块（简约）
tags: 
- 倒计时
- 模块
multiFile: 
---
```dataviewjs
const uniqueWords = new Set();
const targetWordCount = 20;//这里设置显示的单词数
const documentsPath = "Documents"; //这里设置单词获取路径
const BACKUP_TOKEN = '3975l6lr5pcbvidl6jl2';//测试Token，不保证可用
const CAIYUN_TOKEN_KEY = 'caiyun_translate_token';//不要在这里修改Token，请通过游戏界面左上角⚙️按钮设置Token
async function getTranslationToken() {
    try {
        const savedToken = localStorage.getItem(CAIYUN_TOKEN_KEY);
        return savedToken || BACKUP_TOKEN;
    } catch (error) {
        console.error('Failed to load token:', error);
        return BACKUP_TOKEN;
    }
}

async function saveTranslationToken(token) {
    try {
        localStorage.setItem(CAIYUN_TOKEN_KEY, token);
        return true;
    } catch (error) {
        console.error('Failed to save token:', error);
        return false;
    }
}

const container = dv.container;
const containerDiv = document.createElement("div");
containerDiv.style.cssText = "position: relative; width: 100%; height: 350px;";

const buttonContainer = document.createElement("div");
buttonContainer.style.cssText = "position: absolute; top: 6px; left: 20px; z-index: 1000; display: flex; gap: 5px;";

const tokenButton = document.createElement("button");
tokenButton.innerHTML = "⚙️";
tokenButton.style.cssText = 
    "padding: 5px 3px; border-radius: 50%; background: rgb(86 73 73);" +
    "color: white; border: none; cursor: pointer; font-size: 14px; height: 24px";

const refreshButton = document.createElement("button");
refreshButton.innerHTML = "↻";
refreshButton.style.cssText = 
    "padding: 5px 5px; border-radius: 45%; background: rgb(233 116 107);" +
    "color: white; border: none; cursor: pointer; font-size: 16px; height: 24px";

const gameFrame = document.createElement("div");
gameFrame.style.cssText = "width: 100%; height: 100%; overflow: hidden;";

const tokenDialog = document.createElement("div");
tokenDialog.style.cssText = 
    "display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);" +
    "background: white; padding: 20px; border-radius: 8px; z-index: 1001; box-shadow: 0 2px 10px rgba(0,0,0,0.1);" +
    "min-width: 300px;";

tokenDialog.innerHTML = `
    <div style="margin-bottom: 15px;">
        <h3 style="margin-bottom: 5px;">设置彩云小译Token</h3>
        <div style="font-size: 12px; color: #666;">
            <a href="https://platform.caiyunapp.com/regist" target="_blank" style="color: #1a73e8; text-decoration: none;">
                点击获取彩云小译Token →
            </a>
        </div>
    </div>
    <input type="text" id="caiyun-token-input" style="width: 100%; padding: 8px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px;" placeholder="请输入Token">
    <div style="display: flex; justify-content: flex-end; gap: 10px;">
        <button id="caiyun-save-token" style="padding: 5px 15px; border-radius: 4px; background: #4CAF50; color: white; border: none; cursor: pointer;">保存</button>
        <button id="caiyun-cancel-token" style="padding: 5px 15px; border-radius: 4px; background: #666; color: white; border: none; cursor: pointer;">取消</button>
    </div>
`;

const overlay = document.createElement("div");
overlay.style.cssText = 
    "display: none; position: absolute; top: 0; left: 0; right: 0; bottom: 0;" +
    "background: rgba(0,0,0,0.5); z-index: 1000;";

buttonContainer.appendChild(tokenButton);
buttonContainer.appendChild(refreshButton);
containerDiv.appendChild(buttonContainer);
containerDiv.appendChild(tokenDialog);
containerDiv.appendChild(overlay);
containerDiv.appendChild(gameFrame);
container.appendChild(containerDiv);

async function showTokenDialog() {
    tokenDialog.style.display = 'block';
    overlay.style.display = 'block';
    
    const savedToken = await getTranslationToken();
    if (savedToken !== BACKUP_TOKEN) {
        document.getElementById('caiyun-token-input').value = savedToken;
    }
}

function hideTokenDialog() {
    tokenDialog.style.display = 'none';
    overlay.style.display = 'none';
}

async function handleSaveToken() {
    const tokenInput = document.getElementById('caiyun-token-input');
    const token = tokenInput.value.trim();
    
    if (token) {
        const success = await saveTranslationToken(token);
        if (success) {
            new Notice('Token已保存');
            hideTokenDialog();
            processFiles(); 
        } else {
            new Notice('Token保存失败，请重试');
        }
    } else {
        new Notice('请输入有效的Token');
    }
}

async function getFileContent(file) {
    try {
        return await app.vault.cachedRead(file);
    } catch (error) {
        return '';
    }
}

function extractWords(text) {
    const matches = text.match(/\b[A-Za-z]{3,15}\b/g) || [];
    return matches.filter(word => {
        const w = word.toLowerCase();
        return !['the', 'and', 'for', 'that', 'this', 'with', 'from', 'have', 'what', 'where', 'when'].includes(w);
    });
}

function isInDocumentsPath(file) {
    return file.path.startsWith(documentsPath + "/") || file.path === documentsPath;
}

async function translateWords(words) {
    const CAIYUN_API_URL = 'http://api.interpreter.caiyunai.com/v1/translator';
    const token = await getTranslationToken();

    try {
        const response = await requestUrl({
            url: CAIYUN_API_URL,
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                'X-Authorization': 'token ' + token
            },
            body: JSON.stringify({
                source: words,
                trans_type: 'en2zh',
                request_id: 'demo'
            })
        });

        if (response.json && response.json.target && Array.isArray(response.json.target)) {
            return response.json.target;
        }
        throw new Error('Invalid response format');
    } catch (error) {
        console.error('Translation error:', error);
        return useFallbackTranslations(words);
    }
}

function useFallbackTranslations(words) {
    const fallbackDict = {
        'apple': '苹果', 'banana': '香蕉', 'cat': '猫', 'dog': '狗',
        'book': '书', 'pen': '钢笔', 'pencil': '铅笔', 'ruler': '尺子',
        'school': '学校', 'teacher': '老师', 'student': '学生',
        'classroom': '教室', 'desk': '桌子', 'chair': '椅子',
    };
    
    return words.map(word => fallbackDict[word.toLowerCase()] || `[${word}]`);
}

async function processFiles() {
    uniqueWords.clear();
    const allFiles = app.vault.getMarkdownFiles();
    const files = allFiles.filter(file => isInDocumentsPath(file));
    
    console.log(`找到 ${files.length} 个文件在 ${documentsPath} 路径下`);
    let processedFiles = 0;
    for (const file of files) {
        try {
            const content = await getFileContent(file);
            if (!content) continue;
            
            const words = extractWords(content);
            if (words.length > 0) {
                processedFiles++;
                words.forEach(w => uniqueWords.add(w.toLowerCase()));
            }
            
            if (uniqueWords.size >= 100) break;
        } catch (error) {
            continue;
        }
    }
    const selectedWords = shuffle([...uniqueWords]).slice(0, targetWordCount);
    const translations = await translateWords(selectedWords);
    const baseUrl = 'https://ytmaps.vip/english-match-game.html';
    const gameData = {
        words: selectedWords,
        translations: translations
    };
    const dataParam = encodeURIComponent(JSON.stringify(gameData));
    const widgetUrl = `${baseUrl}?data=${dataParam}`;
    gameFrame.innerHTML = '';
    const iframe = document.createElement("iframe");
    iframe.src = widgetUrl;
    iframe.style.cssText = "width: 100%; height: 100%; border: none;";
    gameFrame.appendChild(iframe);
    
    console.log(`已处理 ${processedFiles} 个文件，提取了 ${uniqueWords.size} 个单词`); }
function shuffle(array) {
    const newArr = [...array];
    for (let i = newArr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArr[i], newArr[j]] = [newArr[j], newArr[i]];
    }
    return newArr;
}

containerDiv.addEventListener('click', async (e) => {
    const target = e.target;
    
    if (target === tokenButton) {
        showTokenDialog();
    } else if (target === refreshButton) {
        processFiles();
    } else if (target.id === 'caiyun-save-token') {
        await handleSaveToken();
    } else if (target.id === 'caiyun-cancel-token') {
        hideTokenDialog();
    }
});

getTranslationToken().then(token => {
    if (token === BACKUP_TOKEN) {
        showTokenDialog();
    }
    processFiles(); 
});
```
