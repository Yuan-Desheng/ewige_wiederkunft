let{Plugin,PluginSettingTab,Setting,Notice,TFile,Modal,EditorSuggest,setIcon,getIconIds}=require("obsidian"),{ViewPlugin,WidgetType,Decoration}=require("@codemirror/view"),RangeSetBuilder=require("@codemirror/state").RangeSetBuilder;class FilepathHelper{static extension(e){return e.includes(".")?e.split(".").pop():void 0}static basename(e){return e.split("/").pop()}}let LUCIDE_ICON_NAMES=[];try{let e="function"==typeof getIconIds?getIconIds():null;Array.isArray(e)&&0<e.length&&(LUCIDE_ICON_NAMES=e.filter(e=>"string"==typeof e&&e.startsWith("lucide-")).map(e=>e.substring("lucide-".length)))}catch(e){}function parseIconShortcode(e){for(var t,a=/\{\s*icon=([^\s}]+)([^}]*)\}/g,i=[];null!==(t=a.exec(e));){for(var s,n=t[0],r=t[2]||"",o={icon:t[1],size:null,color:null},l=/(size|color)=([^\s}]+)/g;null!==(s=l.exec(r));)o[s[1]]=s[2];i.push({full:n,params:o})}return i}function createIconElement(e,t){var a=document.createElement("span"),i=(a.addClass("lucide-shortcode-icon"),t.icon),s=t.size||"1em",t=t.color||"inherit";try{var n=i&&i.startsWith("lucide-")?i:"lucide-"+i;setIcon(a,n)}catch(e){a.textContent=i}a.style.width=s,a.style.height=s,a.style.color=t;try{var r=a.querySelector("svg");r&&(r.style.width=s,r.style.height=s,r.setAttribute("width",s),r.setAttribute("height",s))}catch(e){}return a}class IconShortcodeWidget extends WidgetType{constructor(e,t){super(),this.app=e,this.params=t}toDOM(){return createIconElement(this.app,this.params)}eq(e){return this.params.icon===e.params.icon&&this.params.size===e.params.size&&this.params.color===e.params.color}}function createIconShortcodeViewPlugin(g){return ViewPlugin.fromClass(class{constructor(e){this.view=e,this.decorations=this.buildDecorations(e)}update(e){(e.docChanged||e.viewportChanged)&&(this.decorations=this.buildDecorations(e.view||this.view))}buildDecorations(e){var t,a,i=new RangeSetBuilder,s=e.state.doc;for({from:t,to:a}of e.visibleRanges)for(var n=s.sliceString(t,a),r=/\{\s*icon=([^\s}]+)([^}]*)\}/g;null!==(u=r.exec(n));){var o=u[0];if(-1===o.indexOf("\n")){for(var l,d=u[1],c=u[2]||"",h={icon:d,size:null,color:null},p=/(size|color)=([^\s}]+)/g;null!==(l=p.exec(c));)h[l[1]]=l[2];var d=t+u.index,u=d+o.length,o=Decoration.replace({widget:new IconShortcodeWidget(g,h),inclusive:!1});i.add(d,u,o)}}return i.finish()}},{decorations:e=>e.decorations,eventHandlers:{click:(e,t)=>{var e=e.target;if(!(e instanceof HTMLElement))return!1;let a=e;for(;a&&a!==t.dom&&!a.classList.contains("lucide-shortcode-icon");)a=a.parentElement;return!(!a||a===t.dom||null==(e=t.posAtDOM(a,0))||(t.dispatch({selection:{anchor:e},scrollIntoView:!0}),0))}}})}class IconShortcodeSuggest extends EditorSuggest{constructor(e,t){super(e),this.plugin=t}onTrigger(e,t,a){var i=t.getLine(e.line).substring(0,e.ch),s=/\{icon([^}]*)$/i.exec(i);if(!s)return null;s=s[1]||"",s=/icon=([^\s}]*)/i.exec("icon"+s);let n="";s&&s[1]&&(n=s[1]);s=i.lastIndexOf("{icon=");return-1===s?null:{editor:t,file:a,start:{line:e.line,ch:s},end:e,query:n}}getSuggestions(e){let t=(e.query||"").toLowerCase();e=this.plugin?.settings?.lucideIcons?.commonIcons||[];return t?LUCIDE_ICON_NAMES.filter(e=>e.toLowerCase().includes(t)).slice(0,50).map(e=>({name:e,display:e})):e.slice(0,50).map(e=>({name:e,display:e}))}renderSuggestion(e,t){t.empty();var a=t.createSpan({cls:"lucide-shortcode-icon"});try{var i=e.name&&e.name.startsWith("lucide-")?e.name:"lucide-"+e.name;setIcon(a,i)}catch(e){a.setText(" ")}t.createSpan({text:" "+e.display})}selectSuggestion(t,e){var a=this.context;if(a){var{editor:a,start:i,end:s}=a,n=a.getLine(i.line),r=n.substring(0,i.ch),o=n.substring(i.ch,s.ch),s=n.substring(s.ch),o=/(\{icon[^}]*)/i.exec(o);let e;e=o&&(o=o[1],/icon=/.test(o))?o.replace(/icon=[^\s}]*/i,"icon="+t.name):"{icon="+t.name,a.transaction({changes:[{from:{line:i.line,ch:0},to:{line:i.line,ch:n.length},text:r+e+s}]});o=(r+e).length;a.setCursor({line:i.line,ch:o})}}}class IconPickerModal extends Modal{constructor(e,t,a){super(e),this.plugin=t,this.onSelect=a,this.selectedIcons=new Set}onOpen(){var e=this.contentEl;e.empty(),e.addClass("icon-picker-modal"),e.createEl("h2",{text:"选择图标"});var t=e.createDiv("icon-search-container").createEl("input",{type:"text",placeholder:"输入名称搜索更多图标..."});t.addClass("icon-search-input");let s=e.createDiv("icon-grid-container");var e=e.createDiv("icon-button-container"),a=e.createEl("button",{text:"确认添加"}),e=(a.addClass("mod-cta"),e.createEl("button",{text:"取消"}));let i=(e="")=>{s.empty();let t=e.toLowerCase();e=LUCIDE_ICON_NAMES.filter(e=>e.toLowerCase().includes(t));0===e.length?s.createEl("div",{text:"未找到匹配的图标",cls:"icon-no-results"}):e.slice(0,200).forEach(t=>{let e=s.createDiv("icon-grid-item");var a=e.createDiv("icon-container");try{var i="lucide-"+t;setIcon(a,i)}catch(e){a.setText(t)}e.createDiv({text:t,cls:"icon-name"}),e.addEventListener("click",()=>{this.selectedIcons.has(t)?(this.selectedIcons.delete(t),e.removeClass("selected")):(this.selectedIcons.add(t),e.addClass("selected"))})})};t.addEventListener("input",e=>{i(e.target.value)}),a.addEventListener("click",()=>{0<this.selectedIcons.size?(this.onSelect(Array.from(this.selectedIcons)),this.close()):new Notice("请至少选择一个图标")}),e.addEventListener("click",()=>{this.close()}),i()}onClose(){var e=this.contentEl;e.empty()}}let DEFAULT_FILE_ICONS={"快速上手打卡任务（完成后，请删除）.md":"square-check-big",Documents:"folder-open",Extras:"file-image",Connections:"contact",Books:"book",Assistants:"helping-hand","使用指南":"circle-question-mark","数据库与导航.md":"database","Assistants/Modules":"box","Assistants/Templater":"book-template","Books/白板笔记":"layout-dashboard","Books/电子书架.md":"library-big","Books/pdf书籍":"book-open-check","Books/读书笔记":"sticky-note","Connections/部门":"briefcase-business","Connections/公司":"building-2","Connections/人物":"contact-round","Connections/物品":"shopping-bag","Connections/人脉管理数据库-Bases.base":"database","Documents/Canvas":"layout-dashboard","Documents/Dailynote":"calendar-days","Documents/Douban":"file-video","Documents/Excalidraw":"pen-tool","Documents/I.P.A.R.A":"folder-edit","Documents/文档数据库-Bases.base":"database","Extras/宠物":"dog","Extras/导入":"import","Extras/封面":"book-image","Extras/附件":"scissors-square-dashed-bottom","Extras/人物":"contact-2","Extras/头图":"image","Extras/头像":"contact","Extras/物品":"baggage-claim","Extras/主题":"palette","使用指南/00--通用说明（重要）":"alert-circle"};function renderFileListIcon(e,t){if(e&&t){e=document.querySelector(`.nav-file-title[data-path="${e}"]`)||document.querySelector(`.nav-folder-title[data-path="${e}"]`);if(e){var a=e.querySelector(".nav-file-title-content, .nav-folder-title-content");if(a){var i=e.querySelector(".content-protection-file-icon"),i=(i&&i.parentElement===e&&i.remove(),document.createElement("div"));i.classList.add("content-protection-file-icon");try{var s=t&&t.startsWith("lucide-")?t:"lucide-"+t;setIcon(i,s)}catch(e){i.textContent=t}e.insertBefore(i,a)}}}}function clearAllFileListIcons(){var e=document.querySelectorAll(".content-protection-file-icon");e&&e.length&&e.forEach(e=>{e&&e.parentElement&&e.parentElement.removeChild(e)})}function refreshAllFileListIcons(e){if(e&&"object"==typeof e)for(var t in clearAllFileListIcons(),e){var a;Object.prototype.hasOwnProperty.call(e,t)&&(a=e[t])&&renderFileListIcon(t,a)}}function setupFileIconFeature(s){if(s&&s.app&&s.app.workspace){var t=s.settings||{};if(t.fileIcons&&0!==Object.keys(t.fileIcons).length||(t.fileIcons={...DEFAULT_FILE_ICONS}),s.settings=t,s.saveSettings&&"function"==typeof s.saveSettings){s.setFileIconForPath||(s.setFileIconForPath=async function(e,t){e&&(this.settings.fileIcons||(this.settings.fileIcons={}),t?this.settings.fileIcons[e]=t:delete this.settings.fileIcons[e],await this.saveSettings(),renderFileListIcon(e,t))}),s.refreshAllFileIcons||(s.refreshAllFileIcons=function(){refreshAllFileListIcons(this.settings.fileIcons||{})}),s.register(()=>{clearAllFileListIcons()}),s.registerEvent(s.app.workspace.on("file-menu",(e,t)=>{t&&t.path&&(e.addItem(e=>{e.setTitle("设置图标").setIcon("hashtag").onClick(()=>{new IconPickerModal(s.app,s,e=>{e&&e.length&&(e=e[0],s.setFileIconForPath(t.path,e))}).open()})}),e.addItem(e=>{e.setTitle("移除图标").setIcon("trash-2").onClick(async()=>{await s.setFileIconForPath(t.path,null),s.refreshAllFileIcons()})}))})),s.registerEvent(s.app.workspace.on("layout-change",()=>{s.refreshAllFileIcons()})),s.registerDomEvent(document,"click",e=>{e=e.target;e&&e.closest(".nav-folder-title")&&[0,30,100].forEach(e=>{window.setTimeout(()=>{s.refreshAllFileIcons()},e)})}),s.registerEvent(s.app.vault.on("rename",(e,t)=>{var a,i;e&&t&&(i=(a=s.settings.fileIcons||{})[t])&&(delete a[t],a[e.path]=i,s.settings.fileIcons=a,s.saveSettings(),s.refreshAllFileIcons())})),s.registerEvent(s.app.vault.on("delete",e=>{var t;e&&e.path&&(t=s.settings.fileIcons||{})[e.path]&&(delete t[e.path],s.settings.fileIcons=t,s.saveSettings())}));t=s.app.workspace;let e=()=>{let e=0,t=()=>{e+=1,document.querySelector(".nav-file-title")||document.querySelector(".nav-folder-title")?s.refreshAllFileIcons():e<40&&window.setTimeout(t,50)};t()};t.layoutReady?e():t.onLayoutReady(()=>{e()})}}}class HashHelper{static async getFileHash(e,t){e=await e.app.vault.readBinary(t),t=await crypto.subtle.digest("SHA-256",new Uint8Array(e));return HashHelper.arrayBufferToHexString(t)}static arrayBufferToHexString(e){var t,a=[];for(t of new Uint8Array(e))a.push((t>>>4).toString(16)),a.push((15&t).toString(16));return a.join("")}static async computeStringHash(e){e=(new TextEncoder).encode(e),e=await crypto.subtle.digest("SHA-256",e);return HashHelper.arrayBufferToHexString(e)}}class CodeIntegrityValidator{constructor(){this.methodSignatures={fetchAllPlugins:"e8f4a9c2b1d3",downloadPlugin:"f2a7b8c9d4e1",validatePluginValidity:"a3b4c5d6e7f8"}}validateMethod(e,t){try{if(!t||"function"!=typeof t)return{valid:!1};var a=t.toString(),i={fetchAllPlugins:["cloudFunctionUrl","getPlugins","includeCode"],downloadPlugin:["manifestJSON","mainJS","ensureDirectoryExists"],validatePluginValidity:["validatePluginDownload","pluginId","signature"]}[e];if(i)for(var s of i)if(!a.includes(s))return{valid:!1,method:e};return{valid:!0}}catch(e){return{valid:!1}}}validateInstance(e){var t;for(t of["fetchAllPlugins","downloadPlugin","validatePluginValidity"])if(!e[t]||"function"!=typeof e[t])return{valid:!1};return{valid:!0}}static getInstance(){return CodeIntegrityValidator.instance||(CodeIntegrityValidator.instance=new CodeIntegrityValidator),CodeIntegrityValidator.instance}}function around(t,a){let e=Object.keys(a).map(e=>around1(t,e,a[e]));return 1===e.length?e[0]:function(){e.forEach(e=>e())}}function around1(t,a,e){let i=t[a],s=t.hasOwnProperty(a),n=e(i);return i&&Object.setPrototypeOf(n,i),Object.setPrototypeOf(r,n),t[a]=r,o;function r(...e){return n===i&&t[a]===r&&o(),n.apply(this,e)}function o(){t[a]===r&&(s?t[a]=i:delete t[a]),n!==i&&(n=i,Object.setPrototypeOf(r,i||Function))}}class Patcher{constructor(e){this.plugin=e,this.patch()}static OverrideExisting(e){return Object.assign(e,{__overrideExisting:!0})}static patchPrototype(e,t,a){return Patcher.patch(e,t,a,!0)}static patch(e,t,a,i=!1){if(!t)return null;var s,n=i?t.constructor.prototype:t;for(s of Object.keys(a)){var r=a[s];if(r?.__overrideExisting&&"function"!=typeof n[s])throw new Error(`Method ${String(s)} does not exist on target`)}i=around(n,a);return e.register(i),t}}class MetadataCachePatcher extends Patcher{async patch(){if(this.plugin.settings.treatFileNodeEdgesAsLinks){let d=this;Patcher.patchPrototype(this.plugin,this.plugin.app.metadataCache,{getCache:Patcher.OverrideExisting(i=>function(e,...t){var a;return"canvas"===FilepathHelper.extension(e)?this.fileCache.hasOwnProperty(e)&&(a=this.fileCache[e].hash,this.metadataCache[a])||null:i.call(this,e,...t)}),computeFileMetadataAsync:Patcher.OverrideExisting(t=>async function(e,...a){if("canvas"!==FilepathHelper.extension(e.path))return t.call(this,e,...a);var a=await HashHelper.getFileHash(d.plugin,e),s=(this.saveFileCache(e.path,{hash:a,mtime:e.stat.mtime,size:e.stat.size}),JSON.parse(await this.vault.cachedRead(e)??"{}"));if(s?.nodes){var n=s.nodes.filter(e=>"file"===e.type&&e.file).map(e=>[e.id,e.file]).map(([e,t])=>({link:t,original:t,displayText:"md"===FilepathHelper.extension(t)?t:FilepathHelper.basename(t),position:{nodeId:e,start:{line:0,col:0,offset:0},end:{line:0,col:0,offset:0}}}));let t=new TextEncoder;var r=s.nodes.filter(e=>"text"===e.type&&e.text);let i=r.map(e=>e.id);var r=r.map(e=>t.encode(e.text).buffer).map(e=>this.computeMetadataAsync(e)),r=await Promise.all(r),o=r.map((e,t)=>(e.embeds||[]).map(e=>({...e,position:{nodeId:i[t],...e.position}}))).flat(),l=r.map((e,t)=>(e.links||[]).map(e=>({...e,position:{nodeId:i[t],...e.position}}))).flat();this.metadataCache[a]={v:1,embeds:[...n,...o],links:[...l],nodes:{...r.reduce((e,t,a)=>(e[i[a]]=t,e),{})}},this.trigger("changed",e,"",this.metadataCache[a]),this.resolveLinks(e.path,s)}}),resolveLinks:Patcher.OverrideExisting(r=>async function(a,e){if("canvas"!==FilepathHelper.extension(a))return r.call(this,a);var i=this.vault.getAbstractFileByPath(a);if(i){var t=this.metadataCache[this.fileCache[a]?.hash];if(t){t=[...t.links||[],...t.embeds||[]];if(this.resolvedLinks[a]=t.reduce((e,t)=>{t=this.getFirstLinkpathDest(t.link,a);return t&&(e[t.path]=(e[t.path]||0)+1),e},{}),d.plugin.settings.treatFileNodeEdgesAsLinks)for(let t of e.edges||[]){var s=e.nodes?.find(e=>e.id===t.fromNode),n=e.nodes?.find(e=>e.id===t.toNode);s&&n&&"file"===s.type&&"file"===n.type&&s.file&&n.file&&(this.registerInternalLinkAC(i.name,s.file,n.file),"none"===t.toEnd)&&"arrow"!==t.fromEnd&&this.registerInternalLinkAC(i.name,n.file,s.file)}this.trigger("resolve",i),this.trigger("resolved")}}}),registerInternalLinkAC:e=>async function(e,t,a){var i,s;t!==a&&(i=this.vault.getAbstractFileByPath(t))&&i instanceof TFile&&["md","canvas"].includes(i.extension)&&(i=this.fileCache[t]?.hash??await HashHelper.getFileHash(d.plugin,i),s=this.metadataCache[i]??{v:1},this.metadataCache[i]={...s,links:[...s.links||[],{link:a,original:a,displayText:e+" → "+a,position:{start:{line:0,col:0,offset:0},end:{line:0,col:0,offset:0}}}]},this.resolvedLinks[t]={...this.resolvedLinks[t],[a]:(this.resolvedLinks[t]?.[a]||0)+1})}}),this.plugin.registerEvent(this.plugin.app.vault.on("modify",e=>{"canvas"===FilepathHelper.extension(e.path)&&(this.plugin.app.metadataCache.computeFileMetadataAsync(e),setTimeout(()=>{"function"==typeof updatePathDisplay&&updatePathDisplay()},100))}))}}}class CanvasGroupManager{constructor(e){this.plugin=e}log(e,t){this.plugin.settings.canvasGrouping.debug}async groupNotesByType(){this.log("开始执行Canvas分组功能");var e=this.plugin.app.workspace.getActiveFile();if(e)if("canvas"!==e.extension)new Notice("当前文件不是Canvas白板文档"),this.log("当前文件不是Canvas文档");else try{var t=await this.plugin.app.vault.read(e),a=JSON.parse(t),i=(a.nodes||(a.nodes=[]),a.nodes.filter(e=>"file"===e.type&&e.file));if(0===i.length)new Notice("Canvas中没有文件节点"),this.log("Canvas中没有文件节点");else{this.log(`找到 ${i.length} 个文件节点`);var s,n=this.plugin.settings.canvasGrouping,r=n.frontmatterKey||"笔记类型",o=Array.isArray(n.groupTypes)&&0<n.groupTypes.length?n.groupTypes:["闪念笔记","项目笔记","永久笔记"];let t={};o.forEach(e=>t[e]=[]),t["无分类"]=[];for(s of i)try{var l=this.plugin.app.vault.getAbstractFileByPath(s.file);if(l&&"md"===l.extension){await this.plugin.app.vault.read(l);var d=this.plugin.app.metadataCache.getFileCache(l)?.frontmatter;let e="无分类";if(d&&d[r]){var c=d[r];if(Array.isArray(c)){for(var h of c)if(o.includes(h)){e=h;break}}else o.includes(c)&&(e=c)}t[e].push(s),this.log(`文件 ${s.file} 分类为: `+e)}else t["无分类"].push(s)}catch(e){this.log(`处理文件 ${s.file} 时出错:`,e),t["无分类"].push(s)}var p=Object.entries(t).filter(([,e])=>0<e.length);0===p.length?new Notice("没有可分组的文件节点"):(this.log("分组统计:",Object.fromEntries(p.map(([e,t])=>[e,t.length]))),await this.createGroupsAndLayout(a,p,e))}}catch(e){this.log("执行过程中出错:",e),new Notice("分组失败: "+e.message)}else new Notice("没有打开的文件"),this.log("没有打开的文件")}async createGroupsAndLayout(e,t,a){var l=this.plugin.settings.canvasGrouping;e.nodes=e.nodes.filter(e=>"group"!==e.type||!0===e.collapsed);let d=l.startX,c=l.startY;var h,p,i=e.nodes.filter(e=>"group"===e.type);0<i.length&&(i=Math.max(...i.map(e=>(e.y||0)+(e.height||0))),c=i+(l.groupSpacing||0));let u=1;for([h,p]of t){this.log(`创建分组: ${h}，包含 ${p.length} 个节点`);let i=this.plugin.settings.canvasBacklinks,s=l.verticalSpacing??20,n=i.nodeWidth,r=i.nodeHeight,o=Math.ceil(Math.sqrt(p.length));var g=Math.ceil(p.length/o),v=o*n+20*(o-1)+40,g=g*r+(g-1)*s+80,m={id:`group-${h}-${Date.now()}-`+u++,type:"group",x:d,y:c,width:v,height:g,label:h,color:this.getGroupColor(h)};p.forEach((e,t)=>{var a=Math.floor(t/o),t=t%o;e.x=d+20+t*(n+20),e.y=c+60+a*(r+s),e.width=i.nodeWidth,e.height=i.nodeHeight}),e.nodes.push(m),(d+=v+l.groupSpacing)+v>l.startX+l.maxRowWidth&&(d=l.startX,c+=g+l.groupSpacing)}await this.plugin.app.vault.modify(a,JSON.stringify(e,null,2));t.reduce((e,[,t])=>e+t.length,0);this.log(`分组完成，创建了 ${t.length} 个分组`)}getGroupColor(e){return{"闪念笔记":"4","项目笔记":"3","永久笔记":"1","无分类":"6"}[e]||"6"}}class GraphNodeShortenerManager{constructor(e){this.plugin=e,this.originalFillText=null,this.originalStrokeText=null,this.isEnabled=!1}onload(){this.plugin.settings.isActivated&&(this.plugin.settings.canvasGraphNodeShortener.enabled&&this.enableCanvasTextInterception(),this.plugin.app.workspace.onLayoutReady(()=>{this.plugin.settings.isActivated&&this.plugin.settings.canvasGraphNodeShortener.enabled&&(this.enableCanvasTextInterception(),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",e=>{"localgraph"!==e?.view?.getViewType()&&"graph"!==e?.view?.getViewType()||setTimeout(()=>{this.forceGraphRerender()},500)})),this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{var e=this.plugin.app.workspace.activeLeaf?.view;"localgraph"!==e?.getViewType()&&"graph"!==e?.getViewType()||setTimeout(()=>{this.forceGraphRerender()},300)})))}))}enableCanvasTextInterception(){if(this.plugin.settings.isActivated&&this.plugin.settings.canvasGraphNodeShortener.enabled){this.originalFillText||(this.originalFillText=CanvasRenderingContext2D.prototype.fillText,this.originalStrokeText=CanvasRenderingContext2D.prototype.strokeText);let r=this;CanvasRenderingContext2D.prototype.fillText=function(e,t,a,i){var s,n;return r.shouldModifyCanvasText(e)?(s=r.extractFileName(e),n=r.calculateCenteredX(this,e,s,t),r.originalFillText.call(this,s,n,a,i)):r.originalFillText.call(this,e,t,a,i)},CanvasRenderingContext2D.prototype.strokeText=function(e,t,a,i){var s,n;return r.shouldModifyCanvasText(e)?(s=r.extractFileName(e),n=r.calculateCenteredX(this,e,s,t),r.originalStrokeText.call(this,s,n,a,i)):r.originalStrokeText.call(this,e,t,a,i)},this.isEnabled=!0,this.forceGraphRerender()}}disableCanvasTextInterception(){this.originalFillText&&(CanvasRenderingContext2D.prototype.fillText=this.originalFillText,CanvasRenderingContext2D.prototype.strokeText=this.originalStrokeText,this.originalFillText=null,this.originalStrokeText=null,this.isEnabled=!1)}shouldModifyCanvasText(e){return!(!e||"string"!=typeof e)&&!(e=e.trim()).startsWith("#")&&!(e.includes("/")&&!e.includes(".")&&!e.includes("\\")&&!/\s/.test(e))&&e&&(e.endsWith(".canvas")||e.endsWith(".excalidraw")||e.match(/\.(pdf|png|jpg|jpeg|gif|mp4|avi|doc|docx|xls|xlsx|ppt|pptx|txt|csv|json|xml|html|css|js|py|java|cpp|c|go|rs|swift|kt|php|rb|sh|bat|yml|yaml|toml|ini|cfg|conf)$/i)||e.match(/^Drawing\s+\d{4}-\d{2}-\d{2}.*\.excalidraw$/i))}calculateCenteredX(t,a,i,s){try{var n=t.measureText(a).width-t.measureText(i).width;let e=s;return e="center"===t.textAlign||"right"===t.textAlign||"end"===t.textAlign?s:s+n/2}catch(e){return s}}extractFileName(e){if(!e||"string"!=typeof e)return e;var t=e.replace(/^[\/\\]+/,"").split(/[\/\\]/),a=t[t.length-1];if(!a&&1<t.length)for(let e=t.length-2;0<=e;e--)if(t[e])return t[e];return a||e}forceGraphRerender(){try{var e,t,a=this.plugin.app.workspace.activeLeaf;a&&a.view&&("localgraph"!==(t=(e=a.view).getViewType())&&"graph"!==t||(e.renderer&&"function"==typeof e.renderer.requestUpdate&&e.renderer.requestUpdate(),"function"==typeof e.requestUpdate&&e.requestUpdate(),e.engine&&"function"==typeof e.engine.requestUpdateSearch&&e.engine.requestUpdateSearch()))}catch(e){}}onunload(){this.disableCanvasTextInterception()}async toggleFeature(e){return!!this.plugin.settings.isActivated&&(this.plugin.settings.canvasGraphNodeShortener.enabled=e,await this.plugin.saveSettings(),e?this.enableCanvasTextInterception():this.disableCanvasTextInterception(),!0)}}class CanvasUIManager{constructor(e){this.plugin=e,this.canvasButtons=new Map,this.canvasViews=new Map,this.isAddingButtons=!1}onload(){this.plugin.settings.isActivated&&(this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",e=>{this.handleViewChange()})),this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{clearTimeout(this.layoutChangeTimeout),this.layoutChangeTimeout=setTimeout(()=>{this.handleViewChange()},150)})),setTimeout(()=>this.handleViewChange(),500))}handleViewChange(){this.plugin.settings.isActivated&&(this.viewChangeTimeout&&clearTimeout(this.viewChangeTimeout),this.viewChangeTimeout=setTimeout(()=>{let a=this.plugin.app.workspace.getLeavesOfType("canvas");this.canvasViews.forEach((e,t)=>{a.some(e=>this.getViewId(e.view)===t)||(this.removeCanvasButtons(t),this.canvasViews.delete(t))}),a.forEach(e=>{var t;e.view&&"canvas"===e.view.getViewType()&&(t=this.getViewId(e.view),this.canvasViews.set(t,e.view),this.addCanvasButtons(e.view,t))})},200))}getViewId(e){return e._canvasUIManagerId||(e._canvasUIManagerId="canvas-"+Date.now()+"-"+Math.random().toString(36).substr(2,9)),e._canvasUIManagerId}addCanvasButtons(t,a){!this.plugin.settings.isActivated||!t||this.isAddingButtons||0<t.containerEl.querySelectorAll(".canvas-backlinks-button, .canvas-grouping-button").length||(this.isAddingButtons=!0,setTimeout(()=>{try{var e=t.containerEl.querySelector(".canvas-controls");e?(this.addGroupingSettingsBar(e,a),this.addBacklinksButton(e,a),this.addGroupingButton(e,a)):this.isAddingButtons=!1}catch(e){}finally{this.isAddingButtons=!1}},200))}async addGroupingSettingsBar(e,t){if(!this.plugin.settings.isActivated)return;t="canvas-grouping-settings-bar-"+t;if(e.parentNode.querySelector("#"+t))return;var a=document.createElement("div");a.id=t,a.style.display="flex",a.style.flexDirection="column",a.style.alignItems="center",a.style.margin="5px 0 0 0",a.style.padding="0px 10px";let i=document.createElement("div"),s=(i.style.width="80px",i.style.height="6px",i.style.borderRadius="999px",i.style.background="var(--background-modifier-border)",i.style.cursor="pointer",i.style.marginBottom="4px",document.createElement("div"));s.style.display="flex",s.style.alignItems="center",s.style.gap="12px";t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="8px",t.style.marginRight="8px";let r=document.createElement("button");r.innerHTML=`
      <span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:transparent;border-radius:12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-folder"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"></path></svg>
      </span>
    `,r.style.height="32px",r.style.width="40px",r.style.display="flex",r.style.alignItems="center",r.style.justifyContent="center",r.style.fontSize="15px",r.style.border="none",r.style.background="none",r.style.cursor="pointer",r.style.padding="0",r.style.boxShadow="none",r.title="移动反向链接笔记到指定路径";let d=document.createElement("span"),v=(d.style.fontSize="13px",d.style.color="var(--text-muted)",d.style.fontStyle="italic",d.style.maxWidth="200px",d.style.overflow="hidden",d.style.textOverflow="ellipsis",d.style.whiteSpace="nowrap",d.textContent="加载中...",t.appendChild(r),t.appendChild(d),async()=>{try{var e=this.plugin.app.workspace.getActiveFile();if(e&&"canvas"===e.extension){var t,a,i,s,n,r,o=this.plugin.app.metadataCache.resolvedLinks,l=[];for([t,a]of Object.entries(o))a[e.path]&&(i=this.plugin.app.vault.getAbstractFileByPath(t))&&"md"===i.extension&&l.push(i);if(0===l.length)d.textContent="无反向链接";else{let t=new Set;l.forEach(e=>{e=e.parent?e.parent.path:"";t.add(e)}),1<t.size?d.textContent="笔记不在同一路径":(s=Array.from(t)[0])?(n=s.split("/")).length<=3?d.textContent=s:(r=n.slice(-3).join("/"),d.textContent=r):d.textContent="根目录"}}else d.textContent=""}catch(e){d.textContent="路径获取失败"}}),n=(v(),r.addEventListener("click",async e=>{e.stopPropagation();try{var t=this.plugin.app.workspace.getActiveFile();if(t&&"canvas"===t.extension){var a,i,s,n=this.plugin.app.metadataCache.resolvedLinks;let g=[];for([a,i]of Object.entries(n))i[t.path]&&(s=this.plugin.app.vault.getAbstractFileByPath(a))&&"md"===s.extension&&g.push(s);0===g.length?new Notice("当前Canvas文档没有反向链接笔记"):this.showPathSelector(r,async s=>{if(s&&""!==s.trim()){s=s.trim();try{var n=s.replace(/\\/g,"/"),r=(await this.plugin.app.vault.adapter.exists(n)||await this.plugin.app.vault.createFolder(n),async(e,t)=>{var a=t.replace(/\.[^/.]+$/,""),i=t.match(/\.[^/.]+$/)?.[0]||"";let s=0,n=t;var r=e.replace(/\\+/g,"/").replace(/\/+/g,"/");let o=""===r?n:r+"/"+n;for(;await this.plugin.app.vault.adapter.exists(o);)s++,n=a+" "+s+i,o=""===r?n:r+"/"+n;return{newName:n,newPath:o}});let a=e=>e.replace(/\\+/g,"/").replace(/\/+/g,"/").replace(/\/$/,"");let e=0,t=0,i=0;var o,l,d,c,h=[],p=[];for(o of g)try{((e,t)=>{e=a(e),t=a(t);return e.substring(0,e.lastIndexOf("/"))===t})(o.path,n)?(i++,p.push(o.name)):({newName:d,newPath:c}=await r(n,l=o.name),await this.plugin.app.vault.rename(o,c),e++,h.push({original:l,final:d,renamed:l!==d}))}catch(e){t++}if(0<e||0<i){v();let t="";0<e&&(t+=`成功移动 ${e} 个文件到 `+n),0<i&&(t&&(t+="\n\n"),t+=`跳过 ${i} 个文件（已在目标路径中）:`,p.forEach(e=>{t+=`
• `+e}));var u=h.filter(e=>e.renamed);0<u.length&&(t+=`

自动重命名的文件:`,u.forEach(e=>{t+=`
• ${e.original} → `+e.final})),new Notice(t,8e3)}t}catch(e){}}else new Notice("操作已取消")})}else new Notice("请聚集到白板使用此功能（点击白板空白区域）")}catch(e){}}),document.createElement("button")),o=`
      <span style="display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:transparent;border-radius:12px;">
        <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide-archive"><rect x="3" y="4" width="18" height="4"></rect><path d="M4 8v10a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"></path><path d="M10 12h4"></path></svg>
      </span>
    `,l=(n.innerHTML=o,n.style.height="32px",n.style.width="40px",n.style.display="flex",n.style.alignItems="center",n.style.justifyContent="center",n.style.fontSize="15px",n.style.marginRight="8px",n.style.border="none",n.style.background="none",n.style.cursor="pointer",n.style.padding="0",n.style.boxShadow="none",document.createElement("span")),c=(l.textContent=this.plugin.settings.canvasGrouping.frontmatterKey||"笔记类型",l.style.fontWeight="bold",l.style.marginRight="16px",l.style.fontSize="15px",null),h=(n.addEventListener("click",async e=>{if(e.stopPropagation(),c)c.remove(),c=null;else{(c=document.createElement("div")).style.position="absolute",c.style.zIndex=9999,c.style.background="var(--background-primary)",c.style.border="1px solid var(--tab-outline-color)",c.style.borderRadius="8px",c.style.boxShadow="0 2px 8px rgba(0,0,0,0.08)",c.style.minWidth="120px",c.style.maxHeight="220px",c.style.overflowY="auto",c.style.fontSize="15px",c.style.padding="4px 0";e=this.plugin.app.workspace.getActiveFile();let t=new Set;if(e&&"canvas"===e.extension){var i,e=await this.plugin.app.vault.read(e);for(i of JSON.parse(e).nodes?.filter(e=>"file"===e.type&&e.file)||[]){var s=this.plugin.app.vault.getAbstractFileByPath(i.file);s&&"md"===s.extension&&(s=this.plugin.app.metadataCache.getFileCache(s)?.frontmatter)&&Object.keys(s).forEach(e=>t.add(e))}}0===t.size&&t.add("笔记类型"),Array.from(t).forEach(e=>{let t=document.createElement("div");t.textContent=e,t.style.padding="6px 16px",t.style.cursor="pointer",t.addEventListener("mouseenter",()=>{t.style.background="var(--background-secondary)"}),t.addEventListener("mouseleave",()=>{t.style.background=""}),t.addEventListener("click",async()=>{this.plugin.settings.canvasGrouping.frontmatterKey=e,await this.plugin.saveSettings(),n.innerHTML=o,l.textContent=e,c&&(c.remove(),c=null),await p(),"canvas"===this.plugin.settingTab?.activeTab&&this.plugin.settingTab.display()}),c.appendChild(t)});e=n.getBoundingClientRect();c.style.left=e.left+"px",c.style.top=e.bottom+2+"px",document.body.appendChild(c);let a=e=>{c&&!c.contains(e.target)&&e.target!==n&&(c.remove(),c=null,document.removeEventListener("mousedown",a))};setTimeout(()=>document.addEventListener("mousedown",a),10)}}),document.createElement("div")),p=(h.style.display="flex",h.style.gap="12px",h.style.flexWrap="wrap",async()=>{h.innerHTML="";var e=this.plugin.app.workspace.getActiveFile();let t=new Set;if(e&&"canvas"===e.extension){var a,e=await this.plugin.app.vault.read(e);for(a of JSON.parse(e).nodes?.filter(e=>"file"===e.type&&e.file)||[]){var i,s=this.plugin.app.vault.getAbstractFileByPath(a.file);s&&"md"===s.extension&&(s=this.plugin.app.metadataCache.getFileCache(s)?.frontmatter,i=l.textContent.trim()||"笔记类型",s)&&s[i]&&(s=s[i],Array.isArray(s)?s.forEach(e=>{"string"==typeof e&&e.trim()&&t.add(e.trim())}):"string"==typeof s&&s.trim()&&t.add(s.trim()))}}var n,e=Array.from(t);let r=this.plugin.settings.canvasGrouping.groupTypes||[];0===e.length&&((n=document.createElement("span")).style.color="#888",n.textContent="未检测到任何已有属性值",h.appendChild(n)),e.forEach(t=>{var e=document.createElement("label");e.style.marginRight="8px",e.style.display="inline-flex",e.style.alignItems="center";let a=document.createElement("input");a.type="checkbox",a.value=t,a.checked=r.includes(t),a.style.marginRight="6px",a.addEventListener("change",async()=>{let e=this.plugin.settings.canvasGrouping.groupTypes||[];a.checked?e.includes(t)||e.push(t):e=e.filter(e=>e!==t),this.plugin.settings.canvasGrouping.groupTypes=e,await this.plugin.saveSettings(),"canvas"===this.plugin.settingTab?.activeTab&&this.plugin.settingTab.display(),this.plugin.canvasGroupManager.groupNotesByType()}),e.appendChild(a),e.appendChild(document.createTextNode(t)),h.appendChild(e)})}),u=(s.appendChild(t),s.appendChild(n),s.appendChild(l),s.appendChild(h),a.appendChild(i),a.appendChild(s),this.plugin.settings.canvasGroupingBarCollapsed),g=("boolean"!=typeof u&&(u=!0),()=>{u?(s.style.display="none",i.style.opacity="0.7"):(s.style.display="flex",i.style.opacity="1")});g(),i.addEventListener("click",async e=>{e.stopPropagation(),u=!u,this.plugin.settings.canvasGroupingBarCollapsed=u,await this.plugin.saveSettings(),g()}),e.parentNode.insertBefore(a,e),p(),this.groupingSettingsBar={wrapper:a,bar:s,attrBtn:n,attrNameDisplay:l,renderCheckboxes:p}}addBacklinksButton(e,t){var t="canvas-backlinks-button-"+t,a=e.querySelector("#"+t),a=(a&&a.remove(),document.createElement("div"));a.id=t,a.addClass("canvas-control-item"),a.addClass("canvas-backlinks-button"),a.setAttribute("aria-label","嵌入反向链接"),a.setAttribute("data-tooltip-position","left"),a.style.borderRadius="4px";let i=document.createElement("div");i.addClass("clickable-icon"),i.style.padding="0",i.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-link-icon lucide-link">
        <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"/>
        <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"/>
      </svg>
    `,a.appendChild(i),a.addEventListener("click",()=>{this.plugin.canvasBacklinksEmbedder.embedBacklinks()}),a.addEventListener("mouseenter",()=>{i.addClass("is-active")}),a.addEventListener("mouseleave",()=>{i.removeClass("is-active")}),e.appendChild(a),this.canvasButtons.set(t,a)}addGroupingButton(e,t){var t="canvas-grouping-button-"+t,a=e.querySelector("#"+t),a=(a&&a.remove(),document.createElement("div"));a.id=t,a.addClass("canvas-control-item"),a.addClass("canvas-grouping-button"),a.setAttribute("aria-label","按笔记类型分组"),a.setAttribute("data-tooltip-position","left"),a.style.borderRadius="4px";let i=document.createElement("div");i.addClass("clickable-icon"),i.style.padding="0",i.innerHTML=`
      <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-group-icon lucide-group">
        <path d="M3 7V5c0-1.1.9-2 2-2h2"/>
        <path d="M17 3h2c1.1 0 2 .9 2 2v2"/>
        <path d="M21 17v2c0 1.1-.9 2-2 2h-2"/>
        <path d="M7 21H5c-1.1 0-2-.9-2-2v-2"/>
        <rect width="7" height="5" x="7" y="7" rx="1"/>
        <rect width="7" height="5" x="10" y="12" rx="1"/>
      </svg>
    `,a.appendChild(i),a.addEventListener("click",()=>{this.plugin.canvasGroupManager.groupNotesByType()}),a.addEventListener("mouseenter",()=>{i.addClass("is-active")}),a.addEventListener("mouseleave",()=>{i.removeClass("is-active")}),e.appendChild(a),this.canvasButtons.set(t,a)}removeCanvasButtons(a){let i=[];this.canvasButtons.forEach((e,t)=>{t.includes(a)&&(e&&e.parentNode&&e.remove(),i.push(t))}),i.forEach(e=>{this.canvasButtons.delete(e)});try{var e=document.querySelector("#canvas-grouping-settings-bar-"+a);e&&e.remove()}catch(e){}}removeAllCanvasButtons(){this.canvasButtons.forEach((e,t)=>{e&&e.parentNode&&e.remove()}),this.canvasButtons.clear();try{document.querySelectorAll(".canvas-backlinks-button, .canvas-grouping-button").forEach(e=>e.remove()),document.querySelectorAll('[id^="canvas-grouping-settings-bar-"]').forEach(e=>e.remove())}catch(e){}}showPathSelector(t,a){var e=document.querySelector(".path-selector-popup");e&&e.remove();let i=document.createElement("div");i.className="path-selector-popup",i.style.cssText=`
      position: absolute;
      z-index: 10000;
      background: var(--background-primary);
      border: 1px solid var(--background-modifier-border);
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      min-width: 300px;
      max-width: 400px;
      padding: 16px;
      font-size: 14px;
    `;e=document.createElement("div");e.textContent="选择目标路径",e.style.cssText=`
      font-weight: bold;
      margin-bottom: 12px;
      color: var(--text-normal);
    `,i.appendChild(e);let s=document.createElement("input"),n=(s.type="text",s.placeholder="输入或选择文件夹路径...",s.style.cssText=`
      width: 100%;
      padding: 8px 12px;
      border: 1px solid var(--background-modifier-border);
      border-radius: 4px;
      background: var(--background-primary);
      color: var(--text-normal);
      font-size: 14px;
      margin-bottom: 8px;
      box-sizing: border-box;
    `,i.appendChild(s),document.createElement("div")),r=(n.style.cssText=`
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--background-modifier-border);
      border-radius: 4px;
      margin-bottom: 12px;
    `,i.appendChild(n),()=>{let t=[];return this.plugin.app.vault.getAllLoadedFiles().forEach(e=>{void 0!==e.children&&t.push(e.path)}),t.sort()}),o=(t="")=>{n.innerHTML="";var e,a=r().filter(e=>e.toLowerCase().includes(t.toLowerCase()));0===a.length?((e=document.createElement("div")).textContent="没有找到匹配的文件夹",e.style.cssText=`
          padding: 12px;
          text-align: center;
          color: var(--text-muted);
        `,n.appendChild(e)):a.forEach((e,t)=>{let a=document.createElement("div");a.textContent=e||"根目录",a.style.cssText=`
          padding: 8px 12px;
          cursor: pointer;
          border-bottom: 1px solid var(--background-modifier-border-hover);
          color: var(--text-normal);
        `,a.addEventListener("mouseenter",()=>{a.style.background="var(--background-modifier-hover)"}),a.addEventListener("mouseleave",()=>{a.style.background=""}),a.addEventListener("click",()=>{s.value=e}),n.appendChild(a)})},l=(o(),s.addEventListener("input",e=>{o(e.target.value)}),-1),d=(s.addEventListener("keydown",e=>{var t=n.querySelectorAll("div");0!==t.length&&("ArrowDown"===e.key?(e.preventDefault(),l=Math.min(l+1,t.length-1),d(t)):"ArrowUp"===e.key?(e.preventDefault(),l=Math.max(l-1,-1),d(t)):"Enter"===e.key?(e.preventDefault(),0<=l&&t[l]&&(s.value="根目录"===t[l].textContent?"":t[l].textContent)):"Escape"===e.key&&i.remove())}),e=>{e.forEach((e,t)=>{t===l?e.style.background="var(--background-modifier-hover)":e.style.background=""})});var e=document.createElement("div"),c=(e.style.cssText=`
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    `,document.createElement("button")),c=(c.textContent="取消",c.style.cssText=`
      padding: 6px 16px;
      border: 1px solid var(--background-modifier-border);
      border-radius: 4px;
      background: var(--background-primary);
      color: var(--text-normal);
      cursor: pointer;
      font-size: 14px;
    `,c.addEventListener("click",()=>{i.remove()}),e.appendChild(c),document.createElement("button")),c=(c.textContent="确认",c.style.cssText=`
      padding: 6px 16px;
      border: 1px solid var(--interactive-accent);
      border-radius: 4px;
      background: var(--interactive-accent);
      color: var(--text-on-accent);
      cursor: pointer;
      font-size: 14px;
    `,c.addEventListener("click",()=>{var e=s.value.trim();i.remove(),a(e)}),e.appendChild(c),i.appendChild(e),t.getBoundingClientRect());i.style.left=c.left+"px",i.style.top=c.bottom+4+"px",document.body.appendChild(i),setTimeout(()=>{s.focus()},10);let h=e=>{i.contains(e.target)||e.target===t||(i.remove(),document.removeEventListener("mousedown",h))};setTimeout(()=>{document.addEventListener("mousedown",h)},10)}onunload(){clearTimeout(this.layoutChangeTimeout),this.removeAllCanvasButtons()}}class MetaBindTagAutoCompleteManager{constructor(e){this.plugin=e,this.app=e.app,this.isEnabled=this.plugin.settings.isActivated,this.currentDropdown=null,this.currentInput=null,this.selectedIndex=-1}onload(){this.plugin.settings.isActivated&&this.plugin.settings.metaBindTagAutoCompleteEnabled&&this.setupAutoComplete()}setupAutoComplete(){if(this.plugin.settings.isActivated){let e=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(e=>{e.nodeType===Node.ELEMENT_NODE&&this.enhanceMetaBindInputs(e)})})});e.observe(document.body,{childList:!0,subtree:!0}),this.plugin.register(()=>e.disconnect()),this.enhanceMetaBindInputs(document.body)}}getTagSuggestions(n=""){var e=this.app.metadataCache.getTags();return Object.keys(e).map(e=>e.substring(1)).filter(e=>{var t,a;return!n||(t=e.toLowerCase(),a=n.toLowerCase(),t.includes(a))||e.includes(n)}).sort((e,t)=>{var a,i,s;return n?(a=n.toLowerCase(),i=e.toLowerCase(),s=t.toLowerCase(),i===a&&s!==a?-1:i!==a&&s===a?1:!i.startsWith(a)&&!e.startsWith(n)||s.startsWith(a)||t.startsWith(n)?i.startsWith(a)||e.startsWith(n)||!s.startsWith(a)&&!t.startsWith(n)?e.localeCompare(t,"zh-CN"):1:-1):e.localeCompare(t,"zh-CN")}).slice(0,15)}createAutoCompleteDropdown(s,a){if(this.removeAutoCompleteDropdown(),0!==a.length){let i=document.createElement("div");i.className="meta-bind-tag-autocomplete-dropdown",i.style.cssText=`
            position: fixed;
            z-index: 99999;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-height: 200px;
            overflow-y: auto;
            font-size: 14px;
            min-width: 200px;
        `,a.forEach((e,t)=>{var a=document.createElement("div");a.className="meta-bind-tag-autocomplete-item",a.textContent=e,a.style.cssText=`
                padding: 8px 12px;
                cursor: pointer;
                border-bottom: 1px solid var(--background-modifier-border-hover);
                transition: background-color 0.1s ease;
            `,a.addEventListener("mouseenter",()=>{this.selectItem(i,t)}),a.addEventListener("click",()=>{this.selectSuggestion(s,e)}),i.appendChild(a)});var a=i.lastElementChild,a=(a&&(a.style.borderBottom="none"),s.getBoundingClientRect()),n=window.innerHeight,r=window.innerWidth;let e=a.bottom+2,t=a.left;var o=Math.max(200,a.width);t+o>r&&(t=r-o-10),e+200>n&&200<a.top&&(e=a.top-200-2),i.style.top=e+"px",i.style.left=t+"px",i.style.width=o+"px",document.body.appendChild(i),this.currentDropdown=i,this.currentInput=s,this.selectedIndex=-1}}selectItem(e,a){e.querySelectorAll(".meta-bind-tag-autocomplete-item").forEach((e,t)=>{t===a?(e.classList.add("selected"),e.style.backgroundColor="var(--background-modifier-hover)",this.selectedIndex=a,e.scrollIntoView({block:"nearest"})):(e.classList.remove("selected"),e.style.backgroundColor="")})}selectSuggestion(e,t){e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),this.removeAutoCompleteDropdown(),e.focus()}removeAutoCompleteDropdown(){this.currentDropdown&&(this.currentDropdown.remove(),this.currentDropdown=null,this.currentInput=null,this.selectedIndex=-1)}handleKeyDown(e,t){if(this.currentDropdown){var a=this.currentDropdown.querySelectorAll(".meta-bind-tag-autocomplete-item");switch(t.key){case"ArrowDown":t.preventDefault(),this.selectedIndex=Math.min(this.selectedIndex+1,a.length-1),this.selectItem(this.currentDropdown,this.selectedIndex);break;case"ArrowUp":t.preventDefault(),this.selectedIndex=Math.max(this.selectedIndex-1,-1),0<=this.selectedIndex?this.selectItem(this.currentDropdown,this.selectedIndex):a.forEach(e=>e.classList.remove("selected"));break;case"Enter":0<=this.selectedIndex&&a[this.selectedIndex]&&(t.preventDefault(),this.selectSuggestion(e,a[this.selectedIndex].textContent));break;case"Escape":this.removeAutoCompleteDropdown()}}}enhanceMetaBindInputs(e){this.plugin.settings.isActivated&&(e.querySelectorAll?e.querySelectorAll(".mb-full-width-text-input"):e.classList&&e.classList.contains("mb-full-width-text-input")?[e]:[]).forEach(e=>{e=e.querySelector("input");e&&!e.hasAttribute("data-tag-autocomplete-enhanced")&&(this.enhanceInput(e),e.setAttribute("data-tag-autocomplete-enhanced","true"))})}enhanceInput(t){t.addEventListener("input",e=>{e=e.target.value.trim(),e=this.getTagSuggestions(e);this.createAutoCompleteDropdown(t,e)}),t.addEventListener("keydown",e=>{this.handleKeyDown(t,e)}),t.addEventListener("blur",()=>{setTimeout(()=>{this.currentDropdown?.contains(document.activeElement)||this.removeAutoCompleteDropdown()},100)});t.addEventListener("focus",e=>{e=e.target.value.trim(),e=this.getTagSuggestions(e);0<e.length&&this.createAutoCompleteDropdown(t,e)})}onunload(){this.removeAutoCompleteDropdown()}}class CanvasBacklinksEmbedder{constructor(e){this.plugin=e}log(e,t){this.plugin.settings.canvasBacklinks.debug}async embedBacklinks(){this.log("脚本开始执行");let i=this.plugin.app.workspace.getActiveFile();if(i)if(this.log("当前文件:",i.path),"canvas"!==i.extension)new Notice("当前文件不是Canvas白板文档"),this.log("当前文件不是Canvas文档");else{this.log("确认是Canvas文档");try{var e=this.plugin.app.workspace.activeLeaf;if(e&&e.view)if(this.log("活动视图类型:",e.view.getViewType()),"canvas"!==e.view.getViewType())new Notice("当前活动视图不是Canvas"),this.log("当前活动视图不是Canvas");else{this.log("正在查找反向链接");var t=this.plugin.app.metadataCache.resolvedLinks;let a=[];if(Object.entries(t).forEach(([e,t])=>{t[i.path]&&a.push(e)}),this.log(`找到 ${a.length} 个反向链接:`,a),0===a.length)new Notice("没有找到反向链接");else try{this.log("尝试直接修改Canvas文件");var s=await this.plugin.app.vault.read(i),n=JSON.parse(s);n.nodes||(n.nodes=[]);let t=n.nodes.filter(e=>"file"===e.type&&e.file).map(e=>e.file);this.log("Canvas中已存在的文件节点:",t);var r=a.filter(e=>!t.includes(e));if(this.log(`过滤后需要添加的新反向链接 ${r.length} 个:`,r),0===r.length)new Notice("所有反向链接已存在于Canvas中，无需重复添加"),this.log("所有反向链接已存在于Canvas中");else{let e=0;var o,l,d,c,h,p,u,g=this.plugin.settings.canvasBacklinks,v=n.nodes.length;for(o of r)try{this.plugin.app.vault.getAbstractFileByPath(o)?(d=(l=v+e)%g.columns,c=Math.floor(l/g.columns),h=g.startX+d*(g.nodeWidth+g.horizontalSpacing),p=g.startY+c*(g.nodeHeight+g.verticalSpacing),u={id:"backlink-"+Date.now()+"-"+Math.floor(1e4*Math.random()),type:"file",file:o,x:h,y:p,width:g.nodeWidth,height:g.nodeHeight},n.nodes.push(u),e++,this.log(`添加了文件节点: ${o} 在位置 (${d}, ${c})`)):this.log("文件不存在: "+o)}catch(e){this.log(`为 ${o} 创建节点出错:`,e)}0<e?(await this.plugin.app.vault.modify(i,JSON.stringify(n,null,2)),new Notice(`成功添加了 ${e} 个新的反向链接到Canvas (${g.columns}列网格布局)`),this.log(`成功添加了 ${e} 个新的反向链接节点`)):(new Notice("没有新的反向链接需要添加"),this.log("没有新的反向链接需要添加"))}}catch(e){this.log("直接修改Canvas文件失败:",e),new Notice("添加反向链接失败: "+e.message)}}else new Notice("无法获取活动视图"),this.log("无法获取活动视图")}catch(e){this.log("执行过程中出错:",e),new Notice("执行出错: "+e.message)}}else new Notice("没有打开的文件"),this.log("没有打开的文件")}}class CanvasCollapseManager{constructor(e){this.plugin=e,this.collapsedNodes=new Set,this.nodeButtons=new Map,this.collapsedData=new Map,this.settings={},this.minimaps=new Map,this.minimapWidth=250,this.minimapHeight=200,this.minimapZoom=1}getDefaultSettings(){return{enabled:!0,minimapEnabled:!0,canvasStates:{},create:{childNodeWidth:250,childNodeHeight:60,direction:"LR",parentChildGap:200,siblingGapHorizontal:350,siblingGapVertical:200}}}async onload(){this.plugin.settings.isActivated&&(await this.loadSettings(),this.settings.enabled)&&(this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{this.initializeCanvasButtons()})),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",e=>{e&&e.view&&"canvas"===e.view.getViewType()&&setTimeout(()=>{this.setupCanvasView(e.view)},300)})),this.plugin.registerEvent(this.plugin.app.workspace.on("file-open",e=>{e&&"canvas"===e.extension&&setTimeout(()=>{var e=this.plugin.app.workspace.activeLeaf;e&&e.view&&"canvas"===e.view.getViewType()&&(this.setupCanvasView(e.view),"function"==typeof updatePathDisplay)&&updatePathDisplay()},500)})),this.initializeCanvasButtons(),this.plugin.addCommand({id:"toggle-selected-node",name:"折叠/展开选中卡片的子节点",callback:()=>{this.toggleSelectedNode()}}),this.registerCanvasMenus())}async onunload(){await this.saveSettings(),this.cleanupButtons()}async loadSettings(){var e=this.plugin.settings.canvasCollapse||{};this.settings=Object.assign({},this.getDefaultSettings(),e),void 0!==e?.create?.siblingGap&&(this.settings.create.siblingGapHorizontal=e.create.siblingGap,this.settings.create.siblingGapVertical=e.create.siblingGap,delete this.settings.create.siblingGap,await this.saveSettings())}async saveSettings(){this.plugin.settings.canvasCollapse=this.settings,await this.plugin.saveSettings()}getCanvasPath(e){return e.file?.path||"unknown"}updateCanvasData(t,e){t.setData(e),0<t.history?.current&&t.history.current--,t.pushHistory&&t.pushHistory(e);e=this.plugin.app.workspace.getLeavesOfType("canvas").find(e=>e.view?.canvas===t);e&&(this.saveCanvasState(e.view),this.updateMinimap(e.view))}restoreCanvasState(e,t){e=this.settings.canvasStates[e];if(e){this.collapsedNodes.clear(),this.collapsedData.clear();var i=t.getData();let a=new Set(i.nodes.map(e=>e.id));e.collapsedNodes&&e.collapsedNodes.forEach(e=>{a.has(e)&&this.collapsedNodes.add(e)}),e.collapsedData&&Object.entries(e.collapsedData).forEach(([e,t])=>{a.has(e)&&this.collapsedNodes.has(e)&&this.collapsedData.set(e,t)}),this.applyCollapsedState(t)}}applyCollapsedState(e){if(0!==this.collapsedNodes.size){let r=e.getData();this.collapsedNodes.forEach(i=>{var e=this.collapsedData.get(i);if(e){let t=e.nodes.map(e=>e.id),a=e.edges.map(e=>e.id);var s=r.nodes.filter(e=>t.includes(e.id)),n=r.edges.filter(e=>a.includes(e.id)),s=((0<s.length||0<n.length)&&(r.nodes=r.nodes.filter(e=>!t.includes(e.id)),r.edges=r.edges.filter(e=>!a.includes(e.id))),r.nodes.find(e=>e.id===i));s&&(s.isCollapsed=!0),e.preCollapsedNodes&&e.preCollapsedNodes.forEach(e=>{this.collapsedNodes.add(e)})}else this.collapsedNodes.delete(i)}),e.setData(r),setTimeout(()=>{this.collapsedNodes.forEach(e=>{this.updateButtonState(e)})},100)}}async saveCanvasState(e){var t=this.getCanvasPath(e),e=e.canvas.getData();let a=new Set(e.nodes.map(e=>e.id));var i,s,e=Array.from(this.collapsedNodes).filter(e=>{var t=a.has(e)&&this.collapsedData.has(e);return t||(this.collapsedNodes.delete(e),this.collapsedData.delete(e)),t}),n={};for([i,s]of this.collapsedData.entries())a.has(i)&&this.collapsedNodes.has(i)?n[i]=s:(this.collapsedData.delete(i),this.collapsedNodes.delete(i));this.settings.canvasStates[t]={collapsedNodes:e,collapsedData:n},await this.saveSettings()}initializeCanvasButtons(){setTimeout(()=>{this.plugin.app.workspace.getLeavesOfType("canvas").forEach(e=>{e.view&&null!==e.view.containerEl.offsetParent&&this.setupCanvasView(e.view)})},500)}setupCanvasView(s){let n=s.canvas;if(n&&n.nodes&&this.settings.enabled)if(s.containerEl.querySelector(".canvas-wrapper")){var e=this.getCanvasPath(s);if(this.cleanupCanvasState(s),this.restoreCanvasState(e,n),n.nodes.forEach(e=>{this.addCollapseButton(e,n),this.addTitleContainer(e,n)}),setTimeout(()=>{this.nodeButtons.forEach((e,t)=>{this.updateButtonState(t)})},200),!n._collapsePluginInitialized){let a=n.addNode,i=(n.addNode=e=>{var t=a.call(n,e);return setTimeout(()=>{this.addCollapseButton(e,n),this.addTitleContainer(e,n),this.updateMinimap(s)},100),t},n.selectOnly);n.selectOnly=e=>{var t=i.call(n,e),a=this.minimaps.get(this.getCanvasPath(s));return a&&(e&&e.id?a.selectedNodeId=e.id:e&&0<e.size?(e=Array.from(e)[0],a.selectedNodeId=e?.id||null):a.selectedNodeId=null,a.animationNodes)&&0<a.animationNodes.length&&(e=n.getData(),this.renderMinimap(a,e,a.animationNodes)),t},n._collapsePluginInitialized=!0}this.settings.minimapEnabled&&this.createMinimap(s)}else setTimeout(()=>{this.setupCanvasView(s)},200)}addTitleContainer(i,s){if(i.nodeEl&&this.plugin.settings.canvasTitleEnabled&&!(15<i.id.length)){var e=i.nodeEl.querySelector(".canvas-title-container");if(!e){e=document.createElement("div");e.className="canvas-title-container";let t=document.createElement("div"),a=(t.className="canvas-title-display",document.createElement("input"));a.className="canvas-title-input",a.type="text",a.style.display="none";var n=i.getData().title||"点击添加标题";t.textContent=n,a.value="点击添加标题"===n?"":n,e.appendChild(t),e.appendChild(a),t.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),this.startTitleEdit(t,a,i,s)}),a.addEventListener("blur",e=>{this.saveTitleEdit(t,a,i,s)}),a.addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),a.blur()),"Escape"===e.key&&(e.preventDefault(),this.cancelTitleEdit(t,a))}),i.nodeEl.appendChild(e),i.nodeEl.style.overflow="visible"}}}startTitleEdit(e,t,a,i){e.style.display="none",t.style.display="block",t.focus(),t.select()}cancelTitleEdit(e,t){e.style.display="block",t.style.display="none"}saveTitleEdit(e,t,a,i){var s=t.value.trim(),e=(e.textContent=s||"点击添加标题",e.style.display="block",t.style.display="none",a.getData()),t=(e.title=s,a.setData(e),i.getData()),e=t.nodes.findIndex(e=>e.id===a.id);-1!==e&&(t.nodes[e].title=s),this.updateCanvasData(i,t),i.requestSave()}updateCanvasTitleContainers(i){this.plugin.app.workspace.getLeavesOfType("canvas").forEach(e=>{if(e.view&&e.view.canvas){let a=e.view.canvas;a.nodes.forEach(e=>{var t;e.nodeEl&&(t=e.nodeEl.querySelector(".canvas-title-container"),i?!t&&e.id.length<=15&&this.addTitleContainer(e,a):t&&t.remove())})}})}addCollapseButton(t,a){var e;t.nodeEl&&this.settings.enabled&&(t.collapseEl||((e=document.createElement("div")).className="canvas-collapse-button",e.innerHTML="−",e.title="折叠/展开子节点",e.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),this.toggleNodeCollapse(t,a)}),t.collapseEl=e,t.nodeEl.appendChild(e),t.nodeEl.style.overflow="visible",this.nodeButtons.set(t.id,e)),this.updateButtonState(t.id))}toggleNodeCollapse(e,t){this.collapsedNodes.has(e.id)?this.expandNode(e,t):this.collapseNode(e,t)}collapseNode(o,l){let d=o.getData();if(!this.collapsedNodes.has(o.id)){let n=l.getData(),r=this.getChildNodes(o,n,!0);if(0!==r.length){this.getChildEdges(o,n,r);let a=[],i=[];this.getChildNodes(o,n,!1).forEach(e=>{var t;this.hasExternalConnectionsInSubtree(e,n,r,d.id)||(t=this.getChildNodes(e,n,!0),a.push(e,...t),this.collapsedNodes.has(e.id)&&i.push(e.id),t.forEach(e=>{this.collapsedNodes.has(e.id)&&i.push(e.id)}))});var c=Array.from(new Set(a.map(e=>e.id))).map(t=>a.find(e=>e.id===t));let e=c,s=this.getChildEdges(o,n,e);if(0!==e.length){n.nodes=n.nodes.filter(t=>!e.some(e=>e.id===t.id)),n.edges=n.edges.filter(t=>!s.some(e=>e.id===t.id));let t={};i.forEach(e=>{this.collapsedData.has(e)&&(t[e]=this.collapsedData.get(e))});c={nodes:e.map(e=>({...e,x:e.x-d.x,y:e.y-d.y})),edges:s,preCollapsedNodes:i,preCollapsedData:t};this.collapsedData.set(o.id,c),o.setData({...d,isCollapsed:!0}),this.collapsedNodes.add(o.id),e.forEach(e=>{this.collapsedNodes.delete(e.id),i.includes(e.id)||this.collapsedData.delete(e.id)}),this.updateButtonState(o.id),this.updateCanvasData(l,n)}}}}expandNode(e,a){let i=e.getData();if(this.collapsedNodes.has(e.id)&&this.collapsedData.has(e.id)){let t=this.collapsedData.get(e.id);var s=a.getData(),n=t.nodes.map(e=>({...e,x:e.x+i.x,y:e.y+i.y}));s.nodes.push(...n),s.edges.push(...t.edges),e.setData({...i,isCollapsed:void 0}),0<t.preCollapsedNodes?.length&&t.preCollapsedNodes.forEach(e=>{this.collapsedNodes.add(e),t.preCollapsedData&&t.preCollapsedData[e]&&this.collapsedData.set(e,t.preCollapsedData[e])}),this.collapsedData.delete(e.id),this.collapsedNodes.delete(e.id),this.updateButtonState(e.id),this.updateCanvasData(a,s)}}getChildNodes(e,a,i=!1,s=new Set){let n=e.id||e.getData().id;if(s.has(n))return[];s.add(n);let r=[];return(a.edges||[]).forEach(t=>{var e;t.fromNode===n&&(e=a.nodes.find(e=>e.id===t.toNode))&&e.id!==n&&!s.has(e.id)&&(r.push(e),i)&&r.push(...this.getChildNodes(e,a,i,s))}),r}getChildEdges(e,t,a){let s=[];t=t.edges||[];let n=e.id||e.getData().id,r=new Set(a.map(e=>e.id));return t.forEach(e=>{var t=e.fromNode===n&&r.has(e.toNode),a=r.has(e.fromNode)&&r.has(e.toNode),i=r.has(e.fromNode)&&e.toNode===n;(t||a||i)&&s.push(e)}),s}hasExternalConnectionsInSubtree(e,t,a,i,s=new Set){let n=e.id||e.getData().id;if(s.has(n))return!1;s.add(n);var r=t.edges||[];let o=new Set(a.map(e=>e.id));return!!r.some(e=>{var t=e.toNode===n&&e.fromNode!==i&&!o.has(e.fromNode),e=e.fromNode===n&&e.toNode!==i&&!o.has(e.toNode);return t||e})||this.getChildNodes(e,t,!1).some(e=>this.hasExternalConnectionsInSubtree(e,t,a,i,s))}updateButtonState(e){var t=this.nodeButtons.get(e);t&&(this.collapsedNodes.has(e)?(t.classList.add("collapsed"),t.innerHTML="+",t.title="展开子节点"):(t.classList.remove("collapsed"),t.innerHTML="−",t.title="折叠子节点"))}toggleSelectedNode(){var e,t;this.settings.enabled&&(e=this.plugin.app.workspace.activeLeaf)&&e.view&&"canvas"===e.view.getViewType()&&(e=e.view.canvas)&&e.selection&&0!==(t=Array.from(e.selection)).length&&(t=t[0])&&void 0!==t.nodeEl&&this.toggleNodeCollapse(t,e)}generateId(){return(Date.now().toString(36)+Math.random().toString(36).substr(2,8)).substr(0,16)}getNodeLevel(e,t){let a=this.getDirectionInfo(this.settings.create.direction),i=1,s=e;for(;i<=10;){var n=t.edges.find(e=>e.toNode===s&&e.fromSide===a.fromSide&&e.toSide===a.toSide);if(!n)break;i++,s=n.fromNode}return i}getColorForLevel(e){return String((e-1)%6+1)}getDirectionInfo(e){var t={LR:{fromSide:"right",toSide:"left",isVertical:!1},RL:{fromSide:"left",toSide:"right",isVertical:!1},TB:{fromSide:"bottom",toSide:"top",isVertical:!0},BT:{fromSide:"top",toSide:"bottom",isVertical:!0}};return t[e]||t.LR}getExistingChildren(e,t){let a=e.getData(),i=this.getDirectionInfo(this.settings.create.direction);return a.edges.filter(e=>e.fromNode===t.id&&e.fromSide===i.fromSide&&e.toSide===i.toSide).map(t=>a.nodes.find(e=>e.id===t.toNode)).filter(e=>e)}createChildNode(r,e){if(!r||!e)return null;let o=this.settings.create;var t=this.getDirectionInfo(o.direction),a=r.getData(),l=this.getExistingChildren(r,e),d=this.getNodeLevel(e.id,a),d=this.getColorForLevel(d+1);let c={id:this.generateId(),x:e.x,y:e.y,width:o.childNodeWidth,height:o.childNodeHeight,type:"text",text:"",color:d};d={id:this.generateId(),fromNode:e.id,fromSide:t.fromSide,toNode:c.id,toSide:t.toSide},a.nodes.push(c),a.edges.push(d),d=[...l,c],l=d.length;if(t.isVertical){let i=o.siblingGapHorizontal;t=l*o.childNodeWidth+(l-1)*i;let s=e.x-t/2+o.childNodeWidth/2,n="TB"===o.direction?e.y+e.height/2+o.parentChildGap+o.childNodeHeight/2:e.y-e.height/2-o.parentChildGap-o.childNodeHeight/2;d.forEach((e,t)=>{var t=s+t*(o.childNodeWidth+i),a=n;e.x=t,e.y=a,e.id!==c.id&&(e=r.nodes.get(e.id))&&e.moveTo({x:t,y:a})})}else{let i=o.siblingGapVertical;t=l*o.childNodeHeight+(l-1)*i;let s=e.y-t/2+o.childNodeHeight/2,n="LR"===o.direction?e.x+e.width/2+o.parentChildGap+o.childNodeWidth/2:e.x-e.width/2-o.parentChildGap-o.childNodeWidth/2;d.forEach((e,t)=>{var a=n,t=s+t*(o.childNodeHeight+i);e.x=a,e.y=t,e.id!==c.id&&(e=r.nodes.get(e.id))&&e.moveTo({x:a,y:t})})}r.setData(a),r.requestSave();l=this.plugin.app.workspace.getLeavesOfType("canvas").find(e=>e.view?.canvas===r);return l&&this.updateMinimap(l.view),c}createSiblingNode(r,t){if(!r||!t)return null;let o=this.settings.create,a=this.getDirectionInfo(o.direction);var e=r.getData();let i=e.edges.find(e=>e.toNode===t.id&&e.fromSide===a.fromSide&&e.toSide===a.toSide);if(!i)return null;var l=e.nodes.find(e=>e.id===i.fromNode);if(!l)return null;var d=this.getExistingChildren(r,l),c=this.getNodeLevel(t.id,e),c=this.getColorForLevel(c);let h={id:this.generateId(),x:t.x,y:t.y,width:o.childNodeWidth,height:o.childNodeHeight,type:"text",text:"",color:c};c={id:this.generateId(),fromNode:l.id,fromSide:a.fromSide,toNode:h.id,toSide:a.toSide},e.nodes.push(h),e.edges.push(c),c=[...d,h],d=c.length;if(a.isVertical){let i=o.siblingGapHorizontal;var p=d*o.childNodeWidth+(d-1)*i;let s=l.x-p/2+o.childNodeWidth/2,n="TB"===o.direction?l.y+l.height/2+o.parentChildGap+o.childNodeHeight/2:l.y-l.height/2-o.parentChildGap-o.childNodeHeight/2;c.forEach((e,t)=>{var t=s+t*(o.childNodeWidth+i),a=n;e.x=t,e.y=a,e.id!==h.id&&(e=r.nodes.get(e.id))&&e.moveTo({x:t,y:a})})}else{let i=o.siblingGapVertical;p=d*o.childNodeHeight+(d-1)*i;let s=l.y-p/2+o.childNodeHeight/2,n="LR"===o.direction?l.x+l.width/2+o.parentChildGap+o.childNodeWidth/2:l.x-l.width/2-o.parentChildGap-o.childNodeWidth/2;c.forEach((e,t)=>{var a=n,t=s+t*(o.childNodeHeight+i);e.x=a,e.y=t,e.id!==h.id&&(e=r.nodes.get(e.id))&&e.moveTo({x:a,y:t})})}r.setData(e),r.requestSave();d=this.plugin.app.workspace.getLeavesOfType("canvas").find(e=>e.view?.canvas===r);return d&&this.updateMinimap(d.view),h}registerCanvasMenus(){this.plugin.registerEvent(this.plugin.app.workspace.on("canvas:node-menu",(e,i)=>{if(!i.canvas.readonly&&this.settings.enabled){let t=i.canvas;e.addItem(e=>{e.setSection("canvas").setIcon("plus").setTitle("创建子节点").onClick(()=>{this.createChildNode(t,i)})});var s=t.getData();let a=this.getDirectionInfo(this.settings.create.direction);s.edges.some(e=>e.toNode===i.id&&e.fromSide===a.fromSide&&e.toSide===a.toSide)&&e.addItem(e=>{e.setSection("canvas").setIcon("plus-circle").setTitle("创建兄弟节点").onClick(()=>{this.createSiblingNode(t,i)})})}}))}cleanupCanvasState(e){var t,a,i;e&&e.canvas&&(t=e.canvas,a=this.getCanvasPath(e),this.minimaps&&this.minimaps.has(a)&&(i=this.minimaps.get(a),this.stopMinimapAnimation(i),i.container&&i.container.parentNode&&i.container.parentNode.removeChild(i.container),this.minimaps.delete(a)),(i=e.containerEl.querySelector(".canvas-wrapper"))&&(e=i.querySelector(".canvas-minimap-container"))&&e.remove(),this.groupObservers&&this.groupObservers.has(a)&&((i=this.groupObservers.get(a))&&i.disconnect(),this.groupObservers.delete(a)),this.groupButtons&&t.getData().nodes.filter(e=>"group"===e.type).map(e=>e.id).forEach(e=>{var t;this.groupButtons.has(e)&&((t=this.groupButtons.get(e))&&t.parentNode&&t.parentNode.removeChild(t),this.groupButtons.delete(e))}),delete t._collapsePluginInitialized,delete t._groupCollapseInitialized)}cleanupButtons(){this.nodeButtons.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.nodeButtons.clear(),this.collapsedNodes.clear(),this.collapsedData.clear(),this.minimaps.forEach(e=>{this.stopMinimapAnimation(e),e.container&&e.container.parentNode&&e.container.parentNode.removeChild(e.container)}),this.minimaps.clear(),this.plugin.app.workspace.getLeavesOfType("canvas").forEach(e=>{e.view&&e.view.canvas&&(delete e.view.canvas._collapsePluginInitialized,delete e.view.canvas._groupCollapseInitialized)})}createMinimap(r){if(this.settings.minimapEnabled){let n=this.getCanvasPath(r);var e=r.containerEl.querySelector(".canvas-wrapper");if(e){var t=e.querySelector(".canvas-minimap-container"),t=(t&&t.remove(),this.minimaps.get(n));t&&(this.stopMinimapAnimation(t),t.container&&t.container.parentNode&&t.container.parentNode.removeChild(t.container),this.minimaps.delete(n));let i=document.createElement("div"),s=(i.className="canvas-minimap-container",i.style.cssText=`
            position: absolute;
            bottom: 40px;
            right: -${this.minimapWidth-15}px; /* Start collapsed */
            width: ${this.minimapWidth}px;
            height: ${this.minimapHeight}px;
            background: rgba(0, 0, 0, 0.3);
            border-left-width: 15px solid var(--background-modifier-border);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            overflow: hidden;
            opacity: 0.6;
            backdrop-filter: blur(10px);
            transition: right 0.3s ease-in-out;
        `,document.createElement("canvas"));var t=window.devicePixelRatio||1,a=this.minimapWidth,o=this.minimapHeight,a=(s.width=a*t,s.height=o*t,s.style.width=a+"px",s.style.height=o+"px",s.style.display="block",s.style.cursor="pointer",i.appendChild(s),e.appendChild(i),i.addEventListener("click",e=>{var t,a=this.minimaps.get(n);a&&(t=i.getBoundingClientRect(),e.clientX-t.left<=20?(a.isExpanded=!a.isExpanded,a.isExpanded?i.style.right="10px":i.style.right=`-${this.minimapWidth-15}px`):a.isExpanded&&this.handleMinimapClick(e,r,s))}),s.addEventListener("mousemove",e=>{var t=this.minimaps.get(n);t&&(t.isDragging?this.handleMinimapDrag(e,r):this.handleMinimapMouseMove(e,r,s))}),s.addEventListener("wheel",e=>{e.preventDefault(),this.handleMinimapWheel(e,r)}),s.addEventListener("mousedown",e=>this.handleMinimapMouseDown(e,r)),s.addEventListener("mouseup",()=>this.handleMinimapMouseUp(r)),s.addEventListener("mouseleave",()=>this.handleMinimapMouseUp(r)),s.getContext("2d")),o=(a.scale(t,t),{container:i,canvas:s,ctx:a,nodes:[],edges:[],zoom:1,offsetX:0,offsetY:0,displayZoom:1,displayOffsetX:0,displayOffsetY:0,lastDisplayZoom:1,isExpanded:!1,animationNodes:[],animationRunning:!1,animationFrame:null,isDragging:!1,lastMouseX:0,lastMouseY:0,selectedNodeId:null});this.minimaps.set(n,o),this.updateMinimap(r)}}}updateMinimap(e){var t,a,i,s,n,r,o,l;this.settings.minimapEnabled&&(t=this.getCanvasPath(e),t=this.minimaps.get(t))&&t.ctx&&(e=e.canvas)&&((e=e.getData()).nodes&&0!==e.nodes.length?(a=this.calculateNodeBounds(e.nodes))&&(a.minX-=100,a.minY-=100,a.maxX+=100,a.maxY+=100,l=a.maxX-a.minX,i=a.maxY-a.minY,s=this.minimapWidth-40,n=this.minimapHeight-40,n=(s=Math.min(s/l,n/i,.3))*t.zoom,o=this.minimapWidth/2,r=this.minimapHeight/2,o=o-(a.minX+l/2)*n+t.offsetX,l=r-(a.minY+i/2)*n+t.offsetY,t.drawParams={scale:n,offsetX:o,offsetY:l,bounds:a,baseScale:s},this.stopMinimapAnimation(t),this.initializeAnimationNodes(t,e,n,o,l),this.drawMinimap(t,e,n,o,l),this.startMinimapAnimation(t,e)):this.clearMinimap(t))}calculateNodeBounds(e){if(0===e.length)return null;let s=1/0,n=1/0,r=-1/0,o=-1/0;return e.forEach(e=>{var t=e.x-e.width/2,a=e.x+e.width/2,i=e.y-e.height/2,e=e.y+e.height/2;s=Math.min(s,t),r=Math.max(r,a),n=Math.min(n,i),o=Math.max(o,e)}),{minX:s,minY:n,maxX:r,maxY:o}}calculateAnimationNodeBounds(e){if(!e||0===e.length)return null;let t=1/0,a=1/0,i=-1/0,s=-1/0;return e.forEach(e=>{t=Math.min(t,e.x),i=Math.max(i,e.x),a=Math.min(a,e.y),s=Math.max(s,e.y)}),t===1/0?null:{minX:t,minY:a,maxX:i,maxY:s}}clearMinimap(e){var t=e.ctx,a=this.minimapWidth,i=this.minimapHeight;t.clearRect(0,0,a,i),t.fillStyle=getComputedStyle(document.body).getPropertyValue("--text-muted").trim()||"#888888",t.font="14px Arial",t.textAlign="center",t.textBaseline="middle",t.fillText("暂无节点",a/2,i/2),e.nodes=[],e.animationNodes=[],e.zoom=1,e.offsetX=0,e.offsetY=0,e.selectedNodeId=null}handleMinimapClick(e,i,s){var n=this.minimaps.get(this.getCanvasPath(i));if(n&&n.nodes){s=s.getBoundingClientRect();let t=e.clientX-s.left,a=e.clientY-s.top;e=n.nodes.find(e=>Math.hypot(t-e.x,a-e.y)<=e.radius+2);e&&this.focusOnNode(i,e.originalNode)}}handleMinimapMouseMove(e,i,s){i=this.minimaps.get(this.getCanvasPath(i));if(i&&i.nodes){var n=s.getBoundingClientRect();let t=e.clientX-n.left,a=e.clientY-n.top;e=i.nodes.find(e=>Math.hypot(t-e.x,a-e.y)<=e.radius);s.style.cursor=e?"pointer":"default"}}focusOnNode(e,t){e=e.canvas;if(e&&t)try{var a,i,s=e.nodes.get(t.id);s&&(e.selectOnly(s),e.zoomToSelection?e.zoomToSelection():(e.panTo(t.x,t.y),e.setZoom?(a=e.getZoom?e.getZoom():1,i=Math.max(.8,a),e.setZoom(i)):e.view&&e.view.setZoom&&e.view.setZoom(.8)))}catch(e){}}initializeAnimationNodes(i,s,n,r,o){i.animationNodes&&0!==i.animationNodes.length?(s.nodes.forEach(t=>{var e=i.animationNodes.find(e=>e.id===t.id);e&&(e.targetX=t.x*n+r,e.targetY=t.y*n+o,e.originalNode=t,e.connections=s.edges.filter(e=>e.fromNode===t.id||e.toNode===t.id).length,e.level=this.getNodeLevel(t.id,s))}),s.nodes.forEach(t=>{var e,a;i.animationNodes.find(e=>e.id===t.id)||(e=s.edges.filter(e=>e.fromNode===t.id||e.toNode===t.id).length,a=this.getNodeLevel(t.id,s),i.animationNodes.push({id:t.id,x:t.x*n+r,y:t.y*n+o,vx:0,vy:0,originalNode:t,connections:e,level:a}))}),i.animationNodes=i.animationNodes.filter(t=>s.nodes.find(e=>e.id===t.id))):i.animationNodes=s.nodes.map(t=>{var e=s.edges.filter(e=>e.fromNode===t.id||e.toNode===t.id).length,a=this.getNodeLevel(t.id,s);return{id:t.id,x:t.x*n+r,y:t.y*n+o,vx:0,vy:0,originalNode:t,connections:e,level:a}})}startMinimapAnimation(i,s){if(!i.animationRunning){i.animationRunning=!0;let t=0;let a=e=>{i.animationRunning&&i.animationNodes&&0!==i.animationNodes.length&&(e-t<50||(t=e,(e=this.applyAttractionForce(i,s,1,0,0))&&0<e.length&&this.renderMinimap(i,s,e)),i.animationFrame=requestAnimationFrame(a))};i.animationFrame=requestAnimationFrame(a)}}stopMinimapAnimation(e){e.animationFrame&&(cancelAnimationFrame(e.animationFrame),e.animationFrame=null),e.animationRunning=!1}applyAttractionForce(r,i,e,t,a){if(!r.animationNodes||0===r.animationNodes.length)return[];let s=this.minimapWidth/2,o=this.minimapHeight/2;return r.animationNodes.forEach(n=>{var e=s-n.x,t=o-n.y,a=Math.sqrt(e*e+t*t);0<a&&(n.vx+=e/a*.4,n.vy+=t/a*.4),r.animationNodes.forEach(e=>{var t,a;n.id!==e.id&&(a=n.x-e.x,e=n.y-e.y,0<(t=Math.sqrt(a*a+e*e)))&&t<100&&(n.vx+=a/t*(a=(100-t)/t*.15),n.vy+=e/t*a)}),i.edges.forEach(t=>{let e=null;var a,i,s;t.fromNode===n.id?e=r.animationNodes.find(e=>e.id===t.toNode):t.toNode===n.id&&(e=r.animationNodes.find(e=>e.id===t.fromNode)),e&&(s=e.x-n.x,a=e.y-n.y,0<(i=Math.sqrt(s*s+a*a)))&&(n.vx+=s/i*(s=.015*(i-60)),n.vy+=a/i*s)}),n.vx*=.6,n.vy*=.6,n.x+=n.vx,n.y+=n.vy}),r.animationNodes}drawMinimap(d,e,t,a,i){let c=d.ctx;var s=this.minimapWidth,n=this.minimapHeight;c.clearRect(0,0,s,n),c.fillStyle=getComputedStyle(document.body).getPropertyValue("--background-primary").trim()||"#ffffff",c.fillRect(0,0,s,n),d.nodes=[];let h=this.applyAttractionForce(d,e,t,a,i),l=(e.edges&&0<h.length&&(c.lineWidth=1.2,c.lineCap="round",e.edges.forEach(t=>{var e,a,i,s,n,r,o=h.find(e=>e.id===t.fromNode),l=h.find(e=>e.id===t.toNode);o&&l&&(a=Math.max(5-(o.level-2),2),r=Math.max(5-(l.level-2),2),n=l.x-o.x,i=l.y-o.y,(s=Math.sqrt(n*n+i*i))<a+r||(e=o.x+a*(n=n/s),a=o.y+a*(o=i/s),i=l.x-r*n,s=l.y-r*o,n=d.selectedNodeId&&(t.fromNode===d.selectedNodeId||t.toNode===d.selectedNodeId),l=getComputedStyle(document.body).getPropertyValue("--text-muted").trim()||"#888888",n?(c.lineWidth=2.5,c.strokeStyle="#e74c3c"):d.selectedNodeId?(c.lineWidth=1,c.strokeStyle=l+"40"):((r=c.createLinearGradient(e,a,i,s)).addColorStop(0,"rgba(136, 136, 136, 0.3)"),r.addColorStop(.5,"rgba(136, 136, 136, 0.8)"),r.addColorStop(1,"rgba(136, 136, 136, 0.3)"),c.strokeStyle=r),c.beginPath(),c.moveTo(e,a),c.lineTo(i,s),c.stroke()))})),new Set);d.selectedNodeId&&e.edges.forEach(e=>{e.fromNode===d.selectedNodeId?l.add(e.toNode):e.toNode===d.selectedNodeId&&l.add(e.fromNode)}),h.forEach(e=>{var t=Math.max(5-(e.level-2),2),a=(d.nodes.push({id:e.id,x:e.x,y:e.y,radius:t,originalNode:e.originalNode}),d.selectedNodeId===e.id),i=l.has(e.id);let s="#666666";a||i?s="#e74c3c":e.originalNode.color&&(s={1:"#e74c3c",2:"#e67e22",3:"#f1c40f",4:"#27ae60",5:"#3498db",6:"#9b59b6"}[e.originalNode.color]||s);var n=this.collapsedNodes.has(e.id);!n||a||i||(s=getComputedStyle(document.body).getPropertyValue("--text-accent").trim()||"#7c3aed");let r=t,o=1;d.selectedNodeId&&(a?(r=1.4*t,o=1,c.save(),c.globalAlpha=.3,c.fillStyle=s,c.beginPath(),c.arc(e.x,e.y,1.5*r,0,2*Math.PI),c.fill(),c.restore()):o=i?(r=1.1*t,1):.3),c.save(),c.globalAlpha=o,!a&&d.selectedNodeId||(c.shadowColor="rgba(0, 0, 0, 0.2)",c.shadowBlur=a?5:3,c.shadowOffsetX=1,c.shadowOffsetY=1),c.fillStyle=s,c.beginPath(),c.arc(e.x,e.y,r,0,2*Math.PI),c.fill(),c.shadowColor="transparent",c.shadowBlur=0,c.shadowOffsetX=0,c.shadowOffsetY=0,n&&(c.fillStyle="#ffffff",c.font=Math.max(.8*r,8)+"px Arial",c.textAlign="center",c.textBaseline="middle",c.fillText("+",e.x,e.y)),2<e.connections&&4<=r&&(c.fillStyle="rgba(255, 255, 255, 0.9)",c.beginPath(),c.arc(e.x+.7*r,e.y-.7*r,.4*r,0,2*Math.PI),c.fill(),c.fillStyle=s,c.font=Math.max(.4*r,6)+"px Arial",c.textAlign="center",c.textBaseline="middle",c.fillText(e.connections.toString(),e.x+.7*r,e.y-.7*r)),c.restore()})}renderMinimap(c,e,d){let h=c.ctx;var t=this.minimapWidth,a=this.minimapHeight;h.clearRect(0,0,t,a),h.fillStyle=getComputedStyle(document.body).getPropertyValue("--background-primary").trim()||"#ffffff",h.fillRect(0,0,t,a);let p=c.displayZoom||1,u=c.displayOffsetX||0,g=c.displayOffsetY||0,v=(h.save(),t/2),m=a/2,f=(h.translate(v+u,m+g),h.scale(p,p),h.translate(-v,-m),h.translate(0,0),h.scale(1,1),c.nodes=[],+p),y=(e.edges&&0<d.length&&(h.lineCap="round",e.edges.forEach(t=>{var e,a,i,s,n,r,o=d.find(e=>e.id===t.fromNode),l=d.find(e=>e.id===t.toNode);o&&l&&(i=Math.max(5-(o.level-2),2)/f,e=Math.max(5-(l.level-2),2)/f,r=l.x-o.x,s=l.y-o.y,(n=Math.sqrt(r*r+s*s))<i+e||(a=o.x+i*(r=r/n),i=o.y+i*(o=s/n),s=l.x-e*r,n=l.y-e*o,r=c.selectedNodeId&&(t.fromNode===c.selectedNodeId||t.toNode===c.selectedNodeId),getComputedStyle(document.body).getPropertyValue("--text-muted").trim(),r?(h.lineWidth=1.5/f,h.strokeStyle="#e74c3c"):(h.lineWidth=1/f,h.strokeStyle="rgba(136, 136, 136, 0.6)"),h.beginPath(),h.moveTo(a,i),h.lineTo(s,n),h.stroke()))})),new Set);c.selectedNodeId&&e.edges.forEach(e=>{e.fromNode===c.selectedNodeId?y.add(e.toNode):e.toNode===c.selectedNodeId&&y.add(e.fromNode)}),d.forEach(e=>{var t=Math.max(5-(e.level-2),2),a=t/f,i=(+e.x+0-v)*p+v+u,s=(+e.y+0-m)*p+m+g,n=c.selectedNodeId===e.id,r=y.has(e.id);c.nodes.push({id:e.id,x:i,y:s,radius:t,originalNode:e.originalNode});let o="#666666";n||r?o="#e74c3c":e.originalNode.color&&(o={1:"#e74c3c",2:"#e67e22",3:"#f1c40f",4:"#27ae60",5:"#3498db",6:"#9b59b6"}[e.originalNode.color]||o);i=this.collapsedNodes.has(e.id);!i||n||r||(o=getComputedStyle(document.body).getPropertyValue("--text-accent").trim()||"#7c3aed");let l=a,d=1;c.selectedNodeId&&(n?(l=1.4*a,d=1,h.save(),h.globalAlpha=.3,h.fillStyle=o,h.beginPath(),h.arc(e.x,e.y,1.5*l,0,2*Math.PI),h.fill(),h.restore()):d=r?(l=1.1*a,1):.3),h.save(),h.globalAlpha=d,!n&&!r&&c.selectedNodeId||(h.shadowColor="rgba(0, 0, 0, 0.2)",h.shadowBlur=(n?5:3)/f,h.shadowOffsetX=1/f,h.shadowOffsetY=1/f),h.fillStyle=o,h.beginPath(),h.arc(e.x,e.y,l,0,2*Math.PI),h.fill(),h.shadowColor="transparent",h.shadowBlur=0,h.shadowOffsetX=0,h.shadowOffsetY=0,i&&(h.fillStyle="#ffffff",h.font=Math.max(1.6*l,8/f)+"px Arial",h.textAlign="center",h.textBaseline="middle",h.fillText("+",e.x,e.y)),h.restore()}),h.restore()}handleMinimapWheel(e,t){e.preventDefault(),e.stopPropagation();var a,i,s,n=this.minimaps.get(this.getCanvasPath(t));n&&(a=0<e.deltaY?.9:1.1,a=Math.max(.3,Math.min(2,n.displayZoom?n.displayZoom*a:a)),n.displayZoom=a,i=n.canvas.getBoundingClientRect(),s=e.clientX-i.left-this.minimapWidth/2,e=e.clientY-i.top-this.minimapHeight/2,n.displayOffsetX||(n.displayOffsetX=0),n.displayOffsetY||(n.displayOffsetY=0),i=a/(n.lastDisplayZoom||1),n.displayOffsetX=n.displayOffsetX*i+s*(1-i),n.displayOffsetY=n.displayOffsetY*i+e*(1-i),n.lastDisplayZoom=a,(s=t.canvas.getData()).nodes)&&0<s.nodes.length&&n.animationNodes&&this.renderMinimap(n,s,n.animationNodes)}handleMinimapMouseDown(e,i){i=this.minimaps.get(this.getCanvasPath(i));if(i){var s=i.canvas.getBoundingClientRect();let t=e.clientX-s.left,a=e.clientY-s.top;i.nodes.find(e=>Math.hypot(t-e.x,a-e.y)<=e.radius+2)||(i.isDragging=!0,i.lastMouseX=e.clientX,i.lastMouseY=e.clientY,i.canvas.style.cursor="grabbing")}}handleMinimapMouseUp(e){e=this.minimaps.get(this.getCanvasPath(e));e&&e.isDragging&&(e.isDragging=!1,e.canvas.style.cursor="default")}handleMinimapDrag(e,t){var a,i,s=this.minimaps.get(this.getCanvasPath(t));s&&s.isDragging&&(a=e.clientX-s.lastMouseX,i=e.clientY-s.lastMouseY,s.displayOffsetX+=a,s.displayOffsetY+=i,s.lastMouseX=e.clientX,s.lastMouseY=e.clientY,a=t.canvas)&&(i=a.getData()).nodes&&0<i.nodes.length&&s.animationNodes&&this.renderMinimap(s,i,s.animationNodes)}}class CanvasGroupCollapseManager{constructor(e){this.plugin=e,this.groupButtons=new Map,this.collapsedGroups=new Set,this.groupObservers=new Map,this.settings={enabled:!0}}async onload(){this.plugin.registerEvent(this.plugin.app.workspace.on("layout-change",()=>{this.initializeCanvasGroupCollapse()})),this.plugin.registerEvent(this.plugin.app.workspace.on("active-leaf-change",e=>{e&&e.view&&"canvas"===e.view.getViewType()?(setTimeout(()=>{this.initializeCanvasGroupCollapse()},200),setTimeout(()=>{this.initializeCanvasGroupCollapse()},800)):this.initializeCanvasGroupCollapse()})),this.plugin.registerEvent(this.plugin.app.workspace.on("file-open",e=>{e&&"canvas"===e.extension?(setTimeout(()=>{this.initializeCanvasGroupCollapse()},100),setTimeout(()=>{this.initializeCanvasGroupCollapse()},300),setTimeout(()=>{this.initializeCanvasGroupCollapse()},600),setTimeout(()=>{this.initializeCanvasGroupCollapse()},1e3)):setTimeout(()=>{this.initializeCanvasGroupCollapse()},100)})),this.plugin.registerEvent(this.plugin.app.workspace.on("resize",()=>{setTimeout(()=>{this.initializeCanvasGroupCollapse()},100)})),this.plugin.registerEvent(this.plugin.app.workspace.on("css-change",()=>{setTimeout(()=>{this.initializeCanvasGroupCollapse()},50)})),this.initializeCanvasGroupCollapse(),setTimeout(()=>{this.initializeCanvasGroupCollapse()},500),setTimeout(()=>{this.initializeCanvasGroupCollapse()},1500)}cleanupCanvasGroupState(e){if(e&&e.canvas){let a=e.canvas;var t,e=this.getCanvasPath(e);this.groupObservers&&this.groupObservers.has(e)&&((t=this.groupObservers.get(e))&&t.disconnect(),this.groupObservers.delete(e)),this.groupButtons&&a&&a.getData().nodes.filter(e=>"group"===e.type).map(e=>e.id).forEach(e=>{var t;this.groupButtons.has(e)&&((t=this.groupButtons.get(e))&&t.parentNode&&t.parentNode.removeChild(t),this.groupButtons.delete(e),t=a.nodes.get(e))&&t.collapseEl&&delete t.collapseEl}),delete a._groupCollapseInitialized}}onunload(){this.groupButtons.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.groupButtons.clear(),this.groupObservers.forEach(e=>{e&&e.disconnect()}),this.groupObservers.clear(),this.collapsedGroups.clear()}initializeCanvasGroupCollapse(){this.settings.enabled&&this.plugin.app.workspace.getLeavesOfType("canvas").forEach(e=>{e.view&&e.view.canvas&&(this.cleanupCanvasGroupState(e.view),this.setupCanvasGroupCollapse(e.view))})}setupCanvasGroupCollapse(e){var t=e.canvas;t&&(this.addCollapseButtonsToExistingGroups(e),this.setupDOMObserver(e),this.restoreGroupCollapseState(e),t._groupCollapseInitialized=!0)}addCollapseButtonsToExistingGroups(s){let n=s.canvas;var e;n&&(n.getData().nodes.filter(e=>"group"===e.type).forEach((e,t)=>{var a=n.nodes.get(e.id);if(a&&a.nodeEl){a=a.nodeEl.querySelector(".canvas-group-label");if(a){if(this.groupButtons.has(e.id)){var i=this.groupButtons.get(e.id);if(i&&i.parentNode&&i.getAttribute("data-group-id")===e.id)return;this.groupButtons.delete(e.id)}this.addCollapseButtonToGroupLabel(a,s)}}}),e=s.containerEl)&&e.querySelectorAll("div.canvas-group-label").forEach((e,t)=>{var a=this.getGroupIdFromLabel(e);a&&!this.groupButtons.has(a)&&this.addCollapseButtonToGroupLabel(e,s)})}setupDOMObserver(s){var e,t,a=s.containerEl;a&&(e=this.getCanvasPath(s),this.groupObservers.has(e)&&this.groupObservers.get(e).disconnect(),(t=new MutationObserver(e=>{e.forEach(e=>{e.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){t.classList&&t.classList.contains("canvas-group-label")&&setTimeout(()=>{this.addCollapseButtonToGroupLabel(t,s)},10);let e=t.querySelectorAll&&t.querySelectorAll("div.canvas-group-label");e&&0<e.length&&setTimeout(()=>{e.forEach((e,t)=>{var a=this.getGroupIdFromLabel(e);if(a){if(this.groupButtons.has(a)){var i=this.groupButtons.get(a);if(i&&i.parentNode&&i.getAttribute("data-group-id")===a)return;this.groupButtons.delete(a)}this.addCollapseButtonToGroupLabel(e,s)}})},10)}})})})).observe(a,{childList:!0,subtree:!0}),this.groupObservers.set(e,t))}addCollapseButtonToGroupLabel(e,r){if(e&&r){let t=this.getGroupIdFromLabel(e);if(t){let n=r?.canvas;if(n){let s=n.nodes.get(t);if(s){if(this.groupButtons.has(t)){var a=this.groupButtons.get(t);if(a&&a.parentNode&&a.getAttribute("data-group-id")===t)return void(s.collapseEl=a);this.groupButtons.delete(t),s.collapseEl&&(s.collapseEl=null)}let i=document.createElement("span");i.className="canvas-group-collapse-button",i.innerHTML="−",i.title="折叠/展开分组",i.setAttribute("data-group-id",t),(s.collapseEl=i).addEventListener("click",t=>{t.stopPropagation(),t.preventDefault();var t=this.collapsedGroups.has(s.id),a=i.previousElementSibling;if(a&&a.classList.contains("canvas-group-label")){let e;t?(e="calc(-1 * var(--size-4-1) * var(--zoom-multiplier))",a.removeAttribute("data-top-style"),i.removeAttribute("data-top-style")):(e="32px",a.setAttribute("data-top-style","32px"),i.setAttribute("data-top-style","32px"));t=n.getData(),a=t.nodes.find(e=>e.id===s.id&&"group"===e.type);a&&("32px"===e?a.topStyle=e:delete a.topStyle,n.setData(t),n.requestSave())}this.toggleGroupCollapse(s,r)});try{e.insertAdjacentElement("afterend",i)}catch(e){return}if(n&&(a=n.getData().nodes.find(e=>e.id===t&&"group"===e.type))&&"32px"===a.topStyle&&(e.setAttribute("data-top-style","32px"),i.setAttribute("data-top-style","32px")),n){let e=n.nodes.get(t);e&&e.collapseEl===i||e&&(e.collapseEl=i)}this.groupButtons.set(t,i),this.updateButtonState(t)}}}}}getGroupIdFromLabel(e){var t=this.getCanvasViewFromElement(e);if(t&&t.canvas&&t.canvas.nodes)for(var[a,i]of t.canvas.nodes)if(i&&i.nodeEl&&i.getData&&"group"===i.getData().type){if(i.nodeEl.contains(e))return a;if(i.labelEl===e)return a}return null}getDOMPath(e){var t=[];let a=e;for(;a&&a!==document.body;){let e=a.tagName.toLowerCase();a.id&&(e+="#"+a.id),a.className&&(e+="."+a.className.split(" ").join(".")),t.unshift(e),a=a.parentElement}return t.join(" > ")}getCanvasViewFromElement(e){let t=e;for(;t&&t.parentElement;){var a;if(t.classList&&t.classList.contains("canvas-wrapper"))for(a of this.plugin.app.workspace.getLeavesOfType("canvas"))if(a.view&&a.view.containerEl.contains(t))return a.view;t=t.parentElement}return null}toggleGroupCollapse(e,t){e=e.id;this.collapsedGroups.has(e)?this.expandGroup(e,t):this.collapseGroup(e,t)}collapseGroup(d,e){if(e&&e.canvas){let o=e.canvas;var c=o.getData();let l=c.nodes.find(e=>e.id===d&&"group"===e.type);if(l){this.collapsedGroups.add(d),l.collapsed=!0;var h=this.getNodesInGroup(l,c.nodes,!0);let t=new Set([...h.map(e=>e.id)]);var p=c.edges.filter(e=>t.has(e.fromNode)||t.has(e.toNode)),u=c.edges.filter(e=>e.fromNode===d||e.toNode===d);let a={};u.forEach(e=>{a[e.id]={fromSide:e.fromSide,toSide:e.toSide,fromEnd:e.fromEnd,toEnd:e.toEnd}});l.x,l.y;let i=200;try{var g=e.containerEl||e.contentEl;if(g){var v,m,f=g.querySelectorAll(".canvas-group-label");let e=null;for(v of f){var y=v.closest("[data-id]");if(y&&y.getAttribute("data-id")===d){e=v;break}}if(e){window.getComputedStyle(e);var w,C=e.getBoundingClientRect().width;i=0<C?Math.max(150,C+40):(w=24*(e.textContent||e.innerText||"").length,Math.max(150,40+w))}else{let e=c.nodes.find(e=>e.id===d&&"group"===e.type);e&&e.label&&(m=24*e.label.length,i=Math.max(150,40+m))}}}catch(e){i=Math.max(200,.3*l.width)+40}u.forEach(e=>{if(e.fromNode===d)switch(e.fromSide||"right"){case"top":e.fromSide="top";break;case"bottom":e.fromSide="bottom";break;case"left":e.fromSide="left";break;default:e.fromSide="right"}if(e.toNode===d)switch(e.toSide||"left"){case"top":e.toSide="top";break;case"bottom":e.toSide="bottom";break;case"right":e.toSide="right";break;default:e.toSide="left"}});let s={};h.filter(e=>"group"===e.type).forEach(e=>{s[e.id]={x:e.x,y:e.y,width:e.width,height:e.height}});e=h.map(e=>{var t,a={};for(t in e)if("function"!=typeof e[t]&&"nodeEl"!==t&&"collapseEl"!==t)try{JSON.stringify(e[t]),a[t]=e[t]}catch(e){}return a}),g=p.map(e=>{var t,a={};for(t in e)if("function"!=typeof e[t])try{JSON.stringify(e[t]),a[t]=e[t]}catch(e){}return a}),f=(l.collapsedData={nodes:e,edges:g,originalAnchors:a,originalGeometry:{x:l.x,y:l.y,width:l.width,height:l.height},subGroupOriginalCoords:s},l.width=i,l.height=32,h.filter(e=>"group"===e.type));let n={},r=(f.forEach(e=>{n[e.id]={wasCollapsed:this.collapsedGroups.has(e.id),needsRecreation:!0};var t=o.nodes.get(e.id);t&&t.collapseEl&&(t.collapseEl.parentNode&&t.collapseEl.parentNode.removeChild(t.collapseEl),this.groupButtons.delete(e.id),delete t.collapseEl)}),0<Object.keys(n).length&&(l.subGroupCollapseData=n),c.nodes=c.nodes.filter(e=>!t.has(e.id)),new Set(p.map(e=>e.id)));c.edges=c.edges.filter(e=>!r.has(e.id)),this.updateButtonState(d);try{JSON.stringify(l.collapsedData)}catch(e){return}o.setData(c),o.requestSave(),setTimeout(()=>{var e=o.getData().nodes.find(e=>e.id===d&&"group"===e.type);e&&e.collapsedData},500)}}}expandGroup(r,o){if(o&&o.canvas){var l=o.canvas,d=l.getData();let n=d.nodes.find(e=>e.id===r&&"group"===e.type);if(n&&n.collapsedData){this.collapsedGroups.delete(r),delete n.collapsed;let{nodes:e,edges:t,originalGeometry:a,originalAnchors:i,subGroupOriginalCoords:s}=n.collapsedData;a&&(n.x=a.x,n.y=a.y,n.width=a.width,n.height=a.height),s&&e.forEach(e=>{var t;"group"===e.type&&s[e.id]&&(t=s[e.id],e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height)}),i&&d.edges.forEach(e=>{var t;i[e.id]&&(t=i[e.id],e.fromSide=t.fromSide,e.toSide=t.toSide,e.fromEnd=t.fromEnd,e.toEnd=t.toEnd)}),d.nodes.push(...e),d.edges.push(...t),n.subGroupCollapseData&&(l.setData(d),setTimeout(()=>{n.subGroupCollapseData&&"object"==typeof n.subGroupCollapseData&&Object.entries(n.subGroupCollapseData).forEach(([e,t])=>{t.wasCollapsed&&this.collapsedGroups.add(e),t.needsRecreation&&this.recreateSubGroupCollapseButton(e,o),this.updateButtonState(e)})},100),delete n.subGroupCollapseData),delete n.collapsedData,this.updateButtonState(r),l.setData(d),l.requestSave()}}}recreateSubGroupCollapseButton(e,t){if(t&&t.canvas){var a=t.canvas.nodes.get(e);if(a&&a.nodeEl){var i=a.getData();if(i&&"group"===i.type){i=a.nodeEl.querySelector(".canvas-group-label");if(i){if(this.groupButtons.has(e)){var s=this.groupButtons.get(e);if(s&&s.parentNode&&s.getAttribute("data-group-id")===e)return void(a.collapseEl=s)}this.addCollapseButtonToGroupLabel(i,t)}}}}}getNodesInGroup(s,e,n=!0){let r=s.x,o=s.x+s.width,l=s.y,d=s.y+s.height;return e.filter(e=>{var t,a,i;return e.id!==s.id&&!("group"===e.type&&!n)&&(t=e.x+(e.width||0),i=(a=e.y)+(e.height||0),e.x>=r)&&t<=o&&a>=l&&i<=d})}updateButtonState(e){var t=this.groupButtons.get(e);if(t&&t.getAttribute("data-group-id")===e){var a,i=this.collapsedGroups.has(e),s=(i?(t.classList.add("collapsed"),t.innerHTML="+",t.title="展开分组"):(t.classList.remove("collapsed"),t.innerHTML="−",t.title="折叠分组"),this.plugin.app.workspace.getLeavesOfType("canvas"));for(a of s)if(a.view&&a.view.canvas){var n=a.view.canvas.nodes.get(e);if(n&&n.collapseEl&&n.collapseEl===t){i?(n.collapseEl.classList.add("collapsed"),n.collapseEl.innerHTML="+",n.collapseEl.title="展开分组"):(n.collapseEl.classList.remove("collapsed"),n.collapseEl.innerHTML="−",n.collapseEl.title="折叠分组");break}}}}cleanupNodeCollapseEl(e){e&&e.collapseEl&&(e.collapseEl.parentNode&&e.collapseEl.parentNode.removeChild(e.collapseEl),delete e.collapseEl)}restoreGroupCollapseState(e){e&&e.canvas&&e.canvas.getData().nodes.forEach(e=>{"group"===e.type&&e.collapsed&&(this.collapsedGroups.add(e.id),this.updateButtonState(e.id))})}getCanvasPath(e){return e&&e.file?e.file.path:""}}class VikaPluginFetcher{constructor(e,t,a,i=null){this.validateIntegrity(),this.apiKey=e||"",this.tableID=t||"",this.viewID=a||"",this.plugin=i,this.apiUrlRoot="https://api.vika.cn/fusion/v1/",this.cache={plugins:null,cacheTime:0,cacheDuration:72e5,includesCode:!1,fileStatusCache:new Map,hardwareId:null,hardwareIdCacheTime:0,hardwareIdCacheDuration:36e5}}validateIntegrity(){CodeIntegrityValidator.getInstance().validateInstance(this).valid}async fetchAllPlugins(s,n=!1){if(!this.cache||!this.plugin)throw new Error("实例状态异常");try{var r=Date.now();if(this.cache.plugins&&r-this.cache.cacheTime<this.cache.cacheDuration&&(!n||this.cache.includesCode))return this.cache.plugins;var o=this.plugin?.cloudFunctionConfig?.url;if(!o)throw new Error("云函数URL未配置");let t="";if(this.cache.hardwareId&&r-this.cache.hardwareIdCacheTime<this.cache.hardwareIdCacheDuration)t=this.cache.hardwareId;else try{t=await this.plugin?.getHardwareId?.()||"",this.cache.hardwareId=t,this.cache.hardwareIdCacheTime=r}catch(e){this.cache.hardwareId&&(t=this.cache.hardwareId)}let i=null;for(let a=1;a<=3;a++)try{let e=new AbortController;var l=setTimeout(()=>e.abort(),1e4),d="getPlugins",c=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:d,deviceId:this.plugin?.settings?.deviceId||"",hardwareId:t,includeCode:n}),signal:e.signal});if(clearTimeout(l),!c.ok)throw 433===c.status?new Error("激活码无效或已过期，请重新激活插件"):500<=c.status?new Error(`服务器错误 (${c.status})，请稍后重试`):429===c.status?new Error("请求过于频繁，请稍后重试"):new Error(`请求失败 (${c.status}): `+c.statusText);var h,p,u=await c.json();if(u.success)return h=u.data||[],p=await this.processPluginRecords(h,s),this.cache.plugins=p,this.cache.cacheTime=r,this.cache.includesCode=n,p;throw new Error(u.message||"获取插件数据失败")}catch(e){if((i=e).message.includes("激活码无效"))throw e;if(3===a)break;let t=Math.min(2e3*a,8e3);await new Promise(e=>setTimeout(e,t))}throw new Error("获取插件数据失败 (已重试3次): "+i.message)}catch(e){let t=e.message;throw"AbortError"===e.name?t="请求超时，请检查网络连接":e.message.includes("激活码无效")?t="若未激活仓库，请在插件设置中重新激活":e.message.includes("网络")&&(t="网络连接异常，请检查网络设置"),new Error("获取插件数据失败: "+t)}}async processPluginRecords(e,t){var a,i=[];for(a of e){let e="",t="";a.fields?.name&&("string"==typeof(s=a.fields.name)?e=s:s&&"object"==typeof s?s.title&&s.text?(e=s.title,t=s.text):s.text?(e=s.text,t=s.link||""):e=String(s):e=String(s));var s={id:a.fields?.id||"",name:e,nameUrl:t,folder:a.fields?.folder||"",icon:a.fields?.icon||"",version:a.fields?.version||"",description:a.fields?.description||"",author:a.fields?.author||"",updateTime:a.fields?.update||"",manifestJSON:a.fields?.ManifestJSON||"",mainJS:a.fields?.MainJS||"",stylesCSS:a.fields?.StylesCSS||""};s.timeAgo=this.calculateTimeAgo(s.updateTime),s.id&&s.name&&i.push(s)}e=i.map(e=>this.checkPluginStatus(e,t).catch(e=>({isInstalled:!1,needsUpdate:!1,action:"download"})));let n=await Promise.all(e);return i.forEach((e,t)=>{e.status=n[t]}),i}calculateTimeAgo(e){if(!e)return"";try{var t,a,i=new Date(e),s=new Date;return isNaN(i.getTime())?"":(t=s.getTime()-i.getTime(),(a=Math.floor(t/864e5))<1?"今天":a<30?`更新于${a}天前`:a<365?`更新于${Math.floor(a/30)}个月前`:`更新于${Math.floor(a/365)}年前`)}catch(e){return""}}async checkPluginStatus(e,t){try{if(!e.folder)return{isInstalled:!1,needsUpdate:!1,action:"download"};var a=e.folder+":"+e.version;if(this.cache.fileStatusCache.has(a)){var i=this.cache.fileStatusCache.get(a);if(Date.now()-i.timestamp<6e4)return i.status}var s,n=e.folder+"/manifest.json",r=e.folder+"/main.js",[o,l]=await Promise.all([t.adapter.exists(n),t.adapter.exists(r)]);if(!o||!l)return s={isInstalled:!1,needsUpdate:!1,action:"download"},this.cache.fileStatusCache.set(a,{status:s,timestamp:Date.now()}),s;try{var d=await t.adapter.read(n),c=JSON.parse(d).version||"0.0.0",h=e.version||"0.0.0",p=this.compareVersions(c,h)<0,u={isInstalled:!0,needsUpdate:p,action:p?"update":"installed"};return this.cache.fileStatusCache.set(a,{status:u,timestamp:Date.now()}),u}catch(e){var g={isInstalled:!1,needsUpdate:!1,action:"download"};return this.cache.fileStatusCache.set(a,{status:g,timestamp:Date.now()}),g}}catch(e){return{isInstalled:!1,needsUpdate:!1,action:"download"}}}compareVersions(e,t){var a=e.split(".").map(Number),i=t.split(".").map(Number),s=Math.max(a.length,i.length);for(let e=0;e<s;e++){var n=a[e]||0,r=i[e]||0;if(r<n)return 1;if(n<r)return-1}return 0}async fetchPluginCode(a){try{var i=this.plugin?.cloudFunctionConfig?.url;if(!i)throw new Error("云函数URL未配置");let t="";var s=Date.now();if(this.cache.hardwareId&&s-this.cache.hardwareIdCacheTime<this.cache.hardwareIdCacheDuration)t=this.cache.hardwareId;else try{t=await this.plugin?.getHardwareId?.()||"",this.cache.hardwareId=t,this.cache.hardwareIdCacheTime=s}catch(e){this.cache.hardwareId&&(t=this.cache.hardwareId)}let e=new AbortController;var n=setTimeout(()=>e.abort(),1e4),r=await fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"getPluginCode",deviceId:this.plugin?.settings?.deviceId||"",hardwareId:t,pluginId:a}),signal:e.signal});if(clearTimeout(n),!r.ok)throw 433===r.status?new Error("激活码无效或已过期，请重新激活插件"):500<=r.status?new Error(`服务器错误 (${r.status})，请稍后重试`):429===r.status?new Error("请求过于频繁，请稍后重试"):new Error(`请求失败 (${r.status}): `+r.statusText);var o=await r.json();if(o.success)return o.data;throw new Error(o.message||"获取插件代码失败")}catch(e){let t=e.message;throw"AbortError"===e.name?t="请求超时，请检查网络连接":e.message.includes("激活码无效")?t="若未激活仓库，请在插件设置中重新激活":e.message.includes("网络")&&(t="网络连接异常，请检查网络设置"),new Error("获取插件代码失败: "+t)}}async downloadPlugin(a,i){if(!a||!i||!this.cache)throw new Error("参数状态异常");try{if(!a.folder)throw new Error("插件路径未定义");if(!a.manifestJSON||!a.mainJS){var e=await this.fetchPluginCode(a.id);if(!e)throw new Error("无法获取插件代码");a.manifestJSON=e.manifestJSON||a.manifestJSON||"",a.mainJS=e.mainJS||a.mainJS||"",a.stylesCSS=e.stylesCSS||a.stylesCSS||""}if(await this.ensureDirectoryExists(a.folder,i),2!==["manifest.json","main.js"].length)throw new Error("文件配置异常");var t=[{name:"manifest.json",content:a.manifestJSON},{name:"main.js",content:a.mainJS},{name:"styles.css",content:a.stylesCSS}].filter(e=>e.content&&e.content.trim()).map(e=>{var t=a.folder+"/"+e.name;return i.adapter.write(t,e.content)}),s=(await Promise.all(t),a.folder+":"+a.version);return this.cache.fileStatusCache.delete(s),!0}catch(e){throw new Error("下载插件失败: "+e.message)}}async ensureDirectoryExists(t,a){try{if(!t||"string"!=typeof t)throw new Error("路径无效");var i=t.split("/").filter(e=>e.trim());let e="";var s,n=[];for(s of i)e=e?e+"/"+s:s,n.push(this.ensureSingleDirectory(e,a));await Promise.all(n)}catch(e){throw new Error("创建目录失败: "+e.message)}}async ensureSingleDirectory(e,t){await t.adapter.exists(e)||await t.createFolder(e)}validatePluginData(e,t=!1){var a=[];return e?(e.id||a.push("缺少插件ID"),e.name||a.push("缺少插件名称"),e.folder||a.push("缺少插件路径"),t&&(e.manifestJSON||a.push("缺少manifest.json内容"),e.mainJS||a.push("缺少main.js内容")),{isValid:0===a.length,errors:a}):(a.push("插件数据为空"),{isValid:!1,errors:a})}clearCache(){this.cache.plugins=null,this.cache.cacheTime=0,this.cache.includesCode=!1,this.cache.fileStatusCache.clear(),this.cache.hardwareId=null,this.cache.hardwareIdCacheTime=0}async validatePluginValidity(t,e){if(!t||!t.id||!e)throw new Error("验证参数异常");try{var a,i=this.plugin?.settings?.deviceId||"",s=this.cache.hardwareId||"",n=this.getCurrentTimestamp(),r={action:"validate",hardwareId:s,validatePluginDownload:!0,pluginId:t.id,pluginName:t.name,currentDate:(new Date).toISOString().split("T")[0]},o=this.generateSignature(i,n,r),l={...r,deviceId:i,timestamp:n,signature:o},d=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(d.ok)return(a=await d.json()).success?{isValid:!0,reason:a.message||"验证通过"}:{isValid:!1,reason:a.message||"验证失败"};try{await d.text()}catch(e){}return await this.fallbackValidation(t,`HTTP ${d.status}: `+d.statusText)}catch(e){return this.fallbackValidation(t,"网络异常: "+e.message)}}async fallbackValidation(e,t=0){return{isValid:!1,reason:"验证失败，无法下载插件（限PC端使用）"}}getCurrentTimestamp(){return Math.floor(Date.now()/1e3)}getSecretKey(){return"content-protection-secret-key-2024"}sha256(e){return require("crypto").createHash("sha256").update(e).digest("hex")}hmacSha256(e,t){return require("crypto").createHmac("sha256",t).update(e).digest("hex")}generateSignature(e,t,a){try{var i=this.getSecretKey(),s=Object.keys(a).sort().map(e=>e+"="+a[e]).join("&"),n=""+e+t+this.sha256(s);return this.hmacSha256(n,i)}catch(e){throw e}}}class PluginMarketModal extends Modal{constructor(e,t){super(e),this.plugin=t,this.isLoading=!1}onOpen(){let t=this.contentEl;t.addClass("plugin-market-modal"),setTimeout(()=>{var e=t.closest(".modal");e&&(e.style.width="1050px",e.style.height="700px",e.style.maxWidth="100vw",e.style.maxHeight="100vh")},0),t.innerHTML=`
            <div class="plugin-market-modal-header">
                <h2>模块化OB插件市场</h2><h6>注意事项‼️：点击卡片中的<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-question-mark-icon lucide-circle-question-mark"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg>图标查看插件说明文档/更新日志，先查看更新日志，再更新</h6>
                <div class="modal-header-actions">
                    <button class="refresh-button" title="刷新列表">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw">
                            <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74-2.74L21 8"/>
                            <path d="M21 3v5h-5"/>
                            <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                            <path d="M3 21v-5h5"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div class="plugin-market-modal-content">
                <div class="loading">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2">
                        <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                    </svg>
                    若加载失败，请重启后重试...
                </div>
                <div class="plugin-market-validity-info">
                    下载更新权限至：加载中...
                </div>
            </div>
        `,t.querySelector(".refresh-button").addEventListener("click",()=>{this.refreshPlugins()}),this.updateValidityInfo(),this.loadPlugins()}async updateValidityInfo(){var t=this.contentEl.querySelector(".plugin-market-validity-info");if(t){var e,a,i=localStorage.getItem("cp_member_validity");if(i)i=this.formatValidityDate(i),t.textContent="下载更新权限至："+i;else try{this.plugin.vikaDataSyncManager?(e=await this.plugin.vikaDataSyncManager.fetchUserInfo())&&e.validity?(localStorage.setItem("cp_member_validity",e.validity),e.level&&localStorage.setItem("cp_member_level",e.level),a=this.formatValidityDate(e.validity),t.textContent="下载更新权限至："+a):t.textContent="下载更新权限至：null":t.textContent="下载更新权限至：未激活"}catch(e){t.textContent="下载更新权限至：获取失败"}}}formatValidityDate(e){if(!e)return"null";var t="string"==typeof e?parseInt(e,10):e;if("number"==typeof t&&!isNaN(t)){t=new Date(t);if(!isNaN(t.getTime()))return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}if("string"==typeof e)try{var a=new Date(e);if(!isNaN(a.getTime()))return`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}-`+String(a.getDate()).padStart(2,"0")}catch(e){}return e}async loadPlugins(){if(!this.isLoading){var t=this.contentEl.querySelector(".plugin-market-modal-content");try{this.isLoading=!0,this.setLoadingState(!0);var e=await this.plugin.fetchPluginsFromVika();e.length?this.plugin.renderPluginCards(e,t):t.innerHTML='<div class="plugin-market-empty">暂无插件数据</div>'}catch(e){t.innerHTML=`<div class="plugin-market-error">加载失败: ${e.message}</div>`}finally{this.isLoading=!1,this.setLoadingState(!1)}}}async refreshPlugins(){await this.loadPlugins(),await this.updateValidityInfo()}setLoadingState(e){var t=this.contentEl.querySelector(".refresh-button");t&&(t.disabled=e,t.innerHTML=e?`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2" style="animation: spin 1s linear infinite;">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>`:`<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw">
                    <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/>
                    <path d="M21 3v5h-5"/>
                    <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/>
                    <path d="M3 21v-5h5"/>
                </svg>`,t.style.opacity=e?"0.5":"1")}onClose(){var e=this.contentEl;e.empty(),e.removeClass("plugin-market-modal"),"function"==typeof super.onClose&&super.onClose()}}class ContentProtectionPlugin extends Plugin{checkInterval=null;lastValidationTime=0;validationCache=new Map;checkActivation(){return!!this.settings.isActivated}async getHardwareId(){try{let s=require("child_process").exec;var e=require("fs").promises,t=require("crypto"),a=(t,i=3e3)=>new Promise(a=>{let e=s(t,{timeout:i},(e,t)=>a(e?"":String(t||"").trim()));setTimeout(()=>!e.killed&&e.kill("SIGTERM"),i+500)}),i=e=>e.find(Boolean)||"",n=process.platform;if("darwin"===n){var r=await a('system_profiler SPHardwareDataType | grep "Hardware UUID" | sed "s/.*Hardware UUID: //"');if(r){var o=r.trim();if(o)return o}}else if("win32"===n){var l,d,[c,h,p,u]=await Promise.all([a('powershell -command "(Get-WmiObject Win32_ComputerSystemProduct).UUID"'),a('powershell -command "(Get-WmiObject Win32_Processor).ProcessorId"'),a('powershell -command "(Get-WmiObject Win32_DiskDrive | where {$_.Index -eq 0}).SerialNumber"'),a('powershell -command "(Get-ItemProperty -Path \\"HKLM:\\\\SOFTWARE\\\\Microsoft\\\\Cryptography\\").MachineGuid"')]);let e=h;e||([l,d]=await Promise.all([a('powershell -command "(Get-WmiObject Win32_Processor).Name"'),a('powershell -command "(Get-WmiObject Win32_Processor).NumberOfCores"')]),e=l&&d?l+"-"+d:"");var g=i([c,e,p,u]);if(g)return t.createHash("sha256").update(g).digest("hex").slice(0,32)}else{if("linux"!==n)throw new Error("不支持的操作系统");var[v,m]=await Promise.all([a("cat /sys/class/dmi/id/board_serial 2>/dev/null || echo ''"),a("cat /sys/class/dmi/id/product_uuid 2>/dev/null || echo ''")]),[f,y]=await Promise.all([a('grep -m1 -i "^model name" /proc/cpuinfo | cut -d":" -f2'),a('grep -c -i "^processor" /proc/cpuinfo')]),[w,C]=await Promise.all([e.readFile("/etc/machine-id").then(e=>String(e).trim()).catch(()=>""),e.readFile("/var/lib/dbus/machine-id").then(e=>String(e).trim()).catch(()=>"")]),x=i([v||m,f&&y?f.trim()+"-"+y.trim():"",w||C]).replace(/^unknown.*/i,"");if(x)return t.createHash("sha256").update(x).digest("hex").slice(0,32)}throw new Error("")}catch(e){throw new Error(e.message||"unknow_bs")}}async getIPAddress(){try{let e=new AbortController;var t=setTimeout(()=>e.abort(),2e3);try{var a=await fetch("https://api64.ipify.org?format=json",{signal:e.signal,cache:"no-cache"});if(clearTimeout(t),a.ok)return(await a.json()).ip}catch(e){}return null}catch(e){return null}}cloudFunctionConfig={url:"https://b.ytmaps.vip/obcp20251110",timeout:2e4};getSecretKey(){return"content-protection-secret-key-2024"}async sha256(e){return require("crypto").createHash("sha256").update(e,"utf8").digest("hex")}async hmacSha256(e,t){return require("crypto").createHmac("sha256",t).update(e,"utf8").digest("hex")}async generateSignature(e,t,a={}){try{var i=this.getSecretKey(),s=Object.keys(a).sort().map(e=>e+"="+a[e]).join("&"),n=""+e+t+await this.sha256(s);return await this.hmacSha256(n,i)}catch(e){throw new Error("验证失败")}}getCurrentTimestamp(){return Math.floor(Date.now()/1e3)}async updateDeviceInfo(t,a,i){try{if(!t)throw new Error("");if(!a)return!1;var s=this.getCurrentTimestamp(),n={action:"update",hardwareId:a||"",ipAddress:i||""},r=await this.generateSignature(t,s,n);let e=new AbortController;var o=setTimeout(()=>e.abort(),3e3),l=await fetch(this.cloudFunctionConfig.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"update",deviceId:t,hardwareId:a,ipAddress:i||null,timestamp:s,signature:r}),signal:e.signal});if(clearTimeout(o),l.ok)return(await l.json()).success;throw new Error("更新请求失败: "+l.status)}catch(e){return!1}}async validateActivationIntegrity(){try{this.settings.isActivated&&!this.settings.hasBeenActivated?(this.settings.isActivated=!1,this.settings.deviceId="",await this.saveSettings()):this.settings.isActivated&&(!this.settings.deviceId||this.settings.deviceId.trim().length<8)&&(this.settings.isActivated=!1,this.settings.deviceId="",this.settings.hasBeenActivated=!1,await this.saveSettings())}catch(e){}}async checkAndRestoreActivationFromLocalStorage(){try{var e=localStorage.getItem("cp_id"),t=localStorage.getItem("cp_id_hash");if(e&&t)if(this.generateDataHash(e)===t){if(!this.settings.deviceId||this.settings.deviceId!==e)return this.settings.deviceId=e,this.settings.isActivated=!0,this.settings.hasBeenActivated=!0,await this.saveSettings(),!0;if(this.settings.deviceId===e)return!0}return!1}catch(e){return!1}}async checkHardwareIdMatch(t,a){try{if(!t||!a)return!1;var i=this.getCurrentTimestamp(),s={action:"checkHardware",hardwareId:a||""},n=await this.generateSignature(t,i,s);let e=new AbortController;var r=setTimeout(()=>{e.abort()},3e3),o=await fetch(this.cloudFunctionConfig.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"checkHardware",deviceId:t,hardwareId:a,timestamp:i,signature:n}),signal:e.signal});return clearTimeout(r),o.ok?(await o.json()).success:!1}catch(e){return!1}}async getAllFrontmatterValues(e){var t,a=this.app.vault.getMarkdownFiles();let i=new Set;for(t of a){var s=this.app.metadataCache.getFileCache(t)?.frontmatter;s&&s[e]&&(s=s[e],Array.isArray(s)?s.forEach(e=>{"string"==typeof e&&e.trim()&&i.add(e.trim())}):"string"==typeof s&&s.trim()&&i.add(s.trim()))}return Array.from(i)}async onload(){try{await this.loadSettings(),await this.validateActivationIntegrity(),await this.checkAndRestoreActivationFromLocalStorage(),this.addCommand({id:"open-plugin-market",name:"打开插件市场",callback:()=>this.openPluginMarket()}),this.addCommand({id:"sync-vika-data",name:"同步数据",callback:()=>this.vikaDataSyncManager?.syncVikaData()});var e="lucide-puzzle",t=("function"==typeof this.app.addIcon&&this.app.addIcon(e,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-puzzle-icon lucide-puzzle"><path d="M15.39 4.39a1 1 0 0 0 1.68-.474 2.5 2.5 0 1 1 3.014 3.015 1 1 0 0 0-.474 1.68l1.683 1.682a2.414 2.414 0 0 1 0 3.414L19.61 15.39a1 1 0 0 1-1.68-.474 2.5 2.5 0 1 0-3.014 3.015 1 1 0 0 1 .474 1.68l-1.683 1.682a2.414 2.414 0 0 1-3.414 0L8.61 19.61a1 1 0 0 0-1.68.474 2.5 2.5 0 1 1-3.014-3.015 1 1 0 0 0 .474-1.68l-1.683-1.682a2.414 2.414 0 0 1 0-3.414L4.39 8.61a1 1 0 0 1 1.68.474 2.5 2.5 0 1 0 3.014-3.015 1 1 0 0 1-.474-1.68l1.683-1.682a2.414 2.414 0 0 1 3.414 0z"/></svg>'),this.addRibbonIcon(e,"插件市场",()=>this.openPluginMarket()),"lucide-hard-drive-download");"function"==typeof this.app.addIcon&&this.app.addIcon(t,'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hard-drive-download-icon lucide-hard-drive-download"><path d="M12 2v8"/><path d="m16 6-4 4-4-4"/><rect width="20" height="8" x="2" y="14" rx="2"/><path d="M6 18h.01"/><path d="M10 18h.01"/></svg>'),this.addRibbonIcon(t,"同步数据",()=>this.vikaDataSyncManager?.syncVikaData()),this.settings.enableUpdateNotification&&setTimeout(async()=>{await this.checkUpdateNotification()},1e4),this.registerMarkdownCodeBlockProcessor("plugin-market",(e,t,a)=>{this.renderPluginMarket(e,t,a)}),this.registerDomEvent(document,"mousedown",e=>{this.handleProgressMouseDown(e)},!0),this.registerDomEvent(document,"click",e=>{this.handleProgressClick(e)},!0),this.registerDomEvent(document,"mouseup",e=>{this.handleProgressMouseUp(e)},!0),this.addProgressStyle(),this.addSettingTab(new ContentProtectionSettingTab(this.app,this)),this.registerMarkdownPostProcessor((e,t)=>{this.settings.isActivated||this.protectContent(e)}),this.registerMarkdownPostProcessor((e,t)=>{let l=t=>{if(t)if(t.nodeType===Node.TEXT_NODE){var a=t.nodeValue;if(!a||-1===a.indexOf("{icon"))return;var i=parseIconShortcode(a);if(!i||0===i.length)return;var s=document.createDocumentFragment();let e=0;for(var n,r=/\{\s*icon=[^\s}]+[^}]*\}/g;null!==(n=r.exec(a));){n.index>e&&s.appendChild(document.createTextNode(a.substring(e,n.index)));let t=n[0];var o=i.find(e=>e.full===t);o?(o=createIconElement(this.app,o.params),s.appendChild(o)):s.appendChild(document.createTextNode(t)),e=n.index+t.length}e<a.length&&s.appendChild(document.createTextNode(a.substring(e))),void(t.parentNode&&t.parentNode.replaceChild(s,t))}else{var e;for(e of Array.from(t.childNodes||[]))l(e)}};try{l(e)}catch(e){console.error("Lucide Shortcode Icons: error in markdown post processor",e)}}),this.registerEditorExtension(createIconShortcodeViewPlugin(this.app)),this.iconSuggest=new IconShortcodeSuggest(this.app,this),this.registerEditorSuggest(this.iconSuggest),setupFileIconFeature(this),this.app.workspace.onLayoutReady(()=>{this.settings.isActivated&&setTimeout(()=>{this.refreshAllMarkdownViews()},100)}),this.settings.isActivated&&setTimeout(()=>{this.initializeActivatedFeatures()},1e3);let n=0,r=2,o=async()=>{try{var e=localStorage.getItem("cp_id"),t=localStorage.getItem("cp_id_hash");if(e&&t&&(this.generateDataHash(e)!==t||this.settings.deviceId&&this.settings.deviceId===e||(this.settings.deviceId=e,this.settings.isActivated=!0,this.settings.hasBeenActivated=!0,await this.saveSettings(),this.refreshAllMarkdownViews())),this.settings.isActivated&&this.settings.deviceId){this.settings.deviceId,Date.now();if(this.validationCache.has(this.settings.deviceId)){var a,i=this.validationCache.get(this.settings.deviceId);if(Date.now()-i.time<72e5){try{this.vikaDataSyncManager&&(a=await this.vikaDataSyncManager.fetchUserInfo())&&(a.level&&localStorage.setItem("cp_member_level",a.level),a.validity)&&localStorage.setItem("cp_member_validity",a.validity)}catch(e){}return}}try{var s=await this.validateWithCloudFunction(this.settings.deviceId,!0);this.validationCache.set(this.settings.deviceId,{time:Date.now(),valid:s}),s||(this.settings.isActivated=!1,this.settings.deviceId="",this.settings.hasBeenActivated=!1,await this.saveSettings())}catch(e){}}else if(this.settings.deviceId)if(this.settings.hasBeenActivated)this.settings.isActivated=!0,await this.saveSettings(),this.refreshAllMarkdownViews();else try{!await this.validateWithCloudFunction(this.settings.deviceId,!0)&&n<r&&(n++,setTimeout(o,3e4+1e4*n))}catch(e){}else this.settings.isActivated=!1,await this.saveSettings()}catch(e){n<r&&(n++,setTimeout(o,3e4+1e4*n))}};setTimeout(o,2e4)}catch(e){}this.createGlobalAPI(),this.saveToLocalStorage(),this.verifyDataIntegrity(),this.startDeviceIdVerification()}generateDataHash(e){try{var t=require("crypto"),a=t.createHash("sha256");return a.update(e+"content-protection-salt-2024"),a.digest("hex")}catch(e){return null}}saveToLocalStorage(){try{var e,t,a=this.settings?.deviceId,i=(a&&(e=this.generateDataHash(a),localStorage.setItem("cp_id",a),e)&&localStorage.setItem("cp_id_hash",e),this.manifest?.author);i&&(t=this.generateDataHash(i),localStorage.setItem("cp_au",i),t)&&localStorage.setItem("cp_au_hash",t)}catch(e){}}verifyDataIntegrity(){try{var e,t,a={deviceId:{valid:!1,tampered:!1},author:{valid:!1,tampered:!1}},i=localStorage.getItem("cp_id"),s=localStorage.getItem("cp_id_hash"),n=(i&&s&&(e=this.generateDataHash(i))&&(a.deviceId.valid=!0,a.deviceId.tampered=e!==s),localStorage.getItem("cp_au")),r=localStorage.getItem("cp_au_hash");return n&&r&&(t=this.generateDataHash(n))&&(a.author.valid=!0,a.author.tampered=t!==r),a.deviceId.tampered||a.author.tampered,a}catch(e){return null}}startDeviceIdVerification(){this.deviceIdVerificationInterval=setInterval(()=>{this.checkDeviceIdConsistency()},3e5)}async checkDeviceIdConsistency(){try{var e=localStorage.getItem("cp_id"),t=this.settings?.deviceId;e&&t&&e!==t&&(this.settings.isActivated=!1,this.settings.deviceId="",this.settings.hasBeenActivated=!1,await this.saveSettings(),localStorage.removeItem("cp_id"),localStorage.removeItem("cp_id_hash"),localStorage.removeItem("cp_au"),localStorage.removeItem("cp_au_hash"),localStorage.removeItem("cp_member_level"),localStorage.removeItem("cp_member_validity"))}catch(e){}}createGlobalAPI(){let s=this;window.ObsidianActivationAPI={version:"1.0.0",isAvailable(){return!0},async validate(t,e={}){var{silent:e=!1,onProgress:a=null}=e;try{a&&a("开始验证激活码...");var i=await s.validateWithCloudFunction(t,e);return i?(a&&a("验证成功"),this._triggerEvent("validation_success",{deviceId:t,result:i}),{success:!0,deviceId:t,message:"验证成功"}):(a&&a("验证失败"),this._triggerEvent("validation_failed",{deviceId:t,error:"验证失败"}),{success:!1,deviceId:t,error:"验证失败"})}catch(e){return a&&a("验证出错: "+e.message),this._triggerEvent("validation_error",{deviceId:t,error:e.message}),{success:!1,deviceId:t,error:e.message}}},async validateMultiple(e,t={}){var a,i=[];for(a of e){var s=await this.validate(a,t);i.push(s)}return i},async getHardwareId(){try{return await s.getHardwareId()}catch(e){throw new Error("获取硬件ID失败: "+e.message)}},async getIPAddress(){try{return await s.getIPAddress()}catch(e){throw new Error("获取IP地址失败: "+e.message)}},async checkHardwareIdMatch(e,t){try{return await s.checkHardwareIdMatch(e,t)}catch(e){throw new Error("检查硬件ID匹配失败: "+e.message)}},async updateDeviceInfo(e,t,a){try{return await s.updateDeviceInfo(e,t,a)}catch(e){throw new Error("更新设备信息失败: "+e.message)}},clearCache(){return s.validationCache.clear(),!0},getActivationStatus(){return{isActivated:s.settings.isActivated,deviceId:s.settings.deviceId,hasBeenActivated:s.settings.hasBeenActivated}},_eventListeners:{},on(e,t){this._eventListeners[e]||(this._eventListeners[e]=[]),this._eventListeners[e].push(t)},off(e,t){this._eventListeners[e]&&-1<(t=this._eventListeners[e].indexOf(t))&&this._eventListeners[e].splice(t,1)},_triggerEvent(e,t){this._eventListeners[e]&&this._eventListeners[e].forEach(e=>{try{e(t)}catch(e){}})},getVersion(){return this.version}}}handleProgressMouseDown(e){var t=this.findProgressContainer(e.target);t&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t.dataset.progressHandling="true")}handleProgressClick(t){var a=this.findProgressContainer(t.target);if(a){t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation();var i=require("obsidian").MarkdownView,i=this.app.workspace.getActiveViewOfType(i);if(i){i=i.editor;let e;(e="progress"===a.tagName.toLowerCase()?a:a.querySelector('progress[style*="width: 100%"]'))&&(a=e.getBoundingClientRect(),t=t.clientX-a.left,t=Math.max(0,Math.min(100,t/a.width*100)),a=Math.min(100,parseFloat(e.getAttribute("max"))||100),t=Math.min(100,10*Math.round(t/100*a/10)),this.updateProgressInEditor(i,e,t))}}}handleProgressMouseUp(e){var t=this.findProgressContainer(e.target);t&&(e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),delete t.dataset.progressHandling)}findProgressContainer(e){if(e.tagName&&"progress"===e.tagName.toLowerCase())return e;let t=e;for(;t&&t!==document.body;){if(t.classList&&t.classList.contains("cm-html-embed")){if(t.querySelector('progress[style*="width: 100%"]'))return t;break}t=t.parentElement}return null}updateProgressInEditor(t,a,i){var s=t.getValue().split("\n");let n=!1;for(let e=0;e<s.length;e++){var r=s[e],o=r.match(/<progress[^>]*>/i);if(o){o=o[0];if(this.isMatchingProgressTag(o,a)){var l=this.updateValueAttribute(o,i),r=r.replace(o,l);s[e]=r,n=!0;break}}}if(n){var d=100===i?"true":"false";let e=!1;if(e=0<s.length&&"---"===s[0].trim()?!0:e){let a=-1;for(let e=1;e<s.length;e++)if("---"===s[e].trim()){a=e;break}if(-1!==a){let t=!1;for(let e=1;e<a;e++)if(s[e].trim().startsWith("iscompleted:")){s[e]="iscompleted: "+d,t=!0;break}t||s.splice(a,0,"iscompleted: "+d)}}else{var c=["---","iscompleted: "+d,"---",""];Array.prototype.push.apply(c,s),s.splice(0,s.length,...c)}t.setValue(s.join("\n")),this.refreshProgressView()}}isMatchingProgressTag(e,t){var a=e.match(/max="([^"]*)"/i),e=e.match(/style="([^"]*)"/i),a=a?a[1]:"100",e=e?e[1]:"",i=t.getAttribute("max")||"100",t=t.getAttribute("style")||"";return a===i&&e.trim()===t.trim()}updateValueAttribute(e,t){return e.includes("value=")?e.replace(/value="[^"]*"/i,`value="${t}"`):e.replace(/(<progress[^>]*?)>/i,`$1 value="${t}">`)}refreshProgressView(){var e=require("obsidian").MarkdownView,e=this.app.workspace.getActiveViewOfType(e);e&&e.previewMode.rerender(!0)}addProgressStyle(){var e=document.createElement("style");e.textContent=`
            /* 包含全宽进度条的HTML嵌入容器样式 */
            .cm-html-embed:has(progress[style*="width: 100%"]) {
                cursor: pointer;
                transition: opacity 0.2s ease;
            }
        `,document.head.appendChild(e),this.progressStyleElement=e}refreshAllMarkdownViews(){try{let t=require("obsidian").MarkdownView;this.app.workspace.getLeavesOfType("markdown").forEach(e=>{e=e.view;e instanceof t&&e.previewMode?.rerender(!0)})}catch(e){}}async onunload(){this.progressStyleElement&&this.progressStyleElement.remove(),this.iconSuggest&&(this.iconSuggest=null),window.ObsidianActivationAPI&&delete window.ObsidianActivationAPI,this.validationCache&&this.validationCache.clear(),this.checkInterval&&(clearInterval(this.checkInterval),this.checkInterval=null),this.deviceIdVerificationInterval&&(clearInterval(this.deviceIdVerificationInterval),this.deviceIdVerificationInterval=null)}initializeActivatedFeatures(){this.settings.isActivated&&(setTimeout(()=>{this.metaBindTagAutoCompleteManager=new MetaBindTagAutoCompleteManager(this),this.metaBindTagAutoCompleteManager.onload()},0),setTimeout(()=>{this.metadataCachePatcher=new MetadataCachePatcher(this)},500),setTimeout(()=>{this.canvasBacklinksEmbedder=new CanvasBacklinksEmbedder(this),this.canvasGroupManager=new CanvasGroupManager(this)},1e3),setTimeout(()=>{this.graphNodeShortenerManager=new GraphNodeShortenerManager(this),this.graphNodeShortenerManager.onload()},1500),setTimeout(()=>{this.canvasUIManager=new CanvasUIManager(this),this.canvasUIManager.onload()},2e3),this.canvasCollapseManager=new CanvasCollapseManager(this),this.canvasCollapseManager.onload(),this.canvasGroupCollapseManager=new CanvasGroupCollapseManager(this),this.canvasGroupCollapseManager.onload(),setTimeout(()=>{this.vikaDataSyncManager=new VikaDataSyncManager(this)},2500),setTimeout(()=>{this.areaCreator=new AreaCreator(this)},3e3)),this.addCommand({id:"embed-canvas-backlinks",name:"在Canvas中嵌入反向链接",callback:()=>{this.checkActivation()&&this.canvasBacklinksEmbedder.embedBacklinks()}}),this.addCommand({id:"group-canvas-notes-by-type",name:"按笔记类型对Canvas节点分组",callback:()=>{this.checkActivation()&&this.canvasGroupManager.groupNotesByType()}}),this.addCommand({id:"sync-vika-data",name:"同步 Vika 数据",callback:()=>{this.checkActivation()&&this.vikaDataSyncManager&&this.vikaDataSyncManager.syncVikaData()}}),this.addCommand({id:"create-area",name:"创建新领域",callback:()=>{this.checkActivation()&&this.areaCreator&&this.createAreaPrompt()}})}async loadSettings(){this.settings=Object.assign({},{isActivated:!1,deviceId:"",whitelistUpdated:!1,hasBeenActivated:!1,treatFileNodeEdgesAsLinks:!1,canvasBacklinks:{startX:100,startY:100,nodeWidth:440,nodeHeight:500,horizontalSpacing:80,verticalSpacing:100,columns:5,debug:!0},canvasGrouping:{startX:100,startY:100,groupSpacing:200,maxRowWidth:5800,verticalSpacing:60,debug:!0,frontmatterKey:"笔记类型",groupTypes:["闪念笔记","项目笔记","永久笔记"]},canvasGraphNodeShortener:{enabled:!0},canvasCollapse:{enabled:!0,minimapEnabled:!0,canvasStates:{},create:{childNodeWidth:250,childNodeHeight:60,direction:"LR",parentChildGap:200,siblingGapHorizontal:350,siblingGapVertical:200}},metaBindTagAutoCompleteEnabled:!0,enableUpdateNotification:!0,areaManagement:{templaterDisabled:!1,templaterWasEnabled:!1},canvasTitleEnabled:!0,lucideIcons:{commonIcons:["heart","star","moon","alert-circle","check","check-circle","x","x-circle","info","arrow-right","arrow-left","arrow-up","arrow-down","file","folder","tag","bookmark"]}},await this.loadData())}async saveSettings(){this.settings.isActivated&&(!this.settings.hasBeenActivated||!this.settings.deviceId||this.settings.deviceId.trim().length<8)&&(this.settings.isActivated=!1,this.settings.deviceId="",this.settings.hasBeenActivated=!1),await this.saveData(this.settings)}async checkUpdateNotification(){try{var e,t,a,i,s,n,r;this.getHardwareId&&this.checkHardwareIdMatch&&this.validateWithCloudFunction&&this.vikaDataSyncManager&&(e=await fetch("https://b.ytmaps.vip/templater_fffaf2025")).ok&&(a=(t=await e.json()).tables?.[0])&&(i=new VikaAPI(t),n=await(s=new VikaSyncProcessor(i,this)).fetchRecordsFromTable(a),0<(r=new ObsidianSyncHandler(this,s,t.deviceId).groupRecordsByUpdateId(n)).size)&&new Notice(r.size+" 组更新内容可更新",5e3)}catch(e){}}async updateWhitelistFiles(e,a=!1){try{var i=this.app.vault.getMarkdownFiles();let t=["模块化Ob-更新模块.md","模块化Ob-更新使用指南.md","模块化Ob-全自动更新.md"];var s=i.filter(e=>t.includes(e.name));if(0!==s.length){for(var n of s){var r,o,l=await this.app.vault.read(n),d=/deviceId:\s*"[^"]*"/;l.match(d)&&(r=a?"":e,o=l.replace(d,`deviceId:"${r}"`),await this.app.vault.modify(n,o))}a||(this.settings.whitelistUpdated=!0,await this.saveSettings())}}catch(e){}}async validateWithCloudFunction(a,i=!1){let s=null;try{if(!a||"string"!=typeof a||a.trim().length<8)return i||new Notice(""),!1;try{s=await this.getHardwareId()}catch(e){}var n=this.getCurrentTimestamp(),r={action:"validate",hardwareId:s||""},t=await this.generateSignature(a,n,r);let e=new AbortController;var o=setTimeout(()=>{e.abort()},2e4),l={action:"validate",deviceId:a,hardwareId:s,timestamp:n,signature:t},d=await fetch(this.cloudFunctionConfig.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l),signal:e.signal});if(clearTimeout(o),!d.ok){if(433===d.status){i||new Notice("激活码无效");try{localStorage.removeItem("cp_id"),localStorage.removeItem("cp_id_hash")}catch(e){}return!1}await d.text().catch(()=>"unknown");throw new Error("API请求失败: "+d.status)}var c=await d.json(),h=c.success;if(h){c.data&&(c.data.level&&localStorage.setItem("cp_member_level",c.data.level),c.data.validity)&&localStorage.setItem("cp_member_validity",c.data.validity),s&&this.updateDeviceInfo(a,s,null).catch(e=>{});try{localStorage.setItem("cp_id",a);var p=this.generateDataHash(a);localStorage.setItem("cp_id_hash",p)}catch(e){}this.settings.isActivated=!0,this.settings.deviceId=a,this.settings.hasBeenActivated=!0,await this.saveSettings(),i||new Notice("✅ 激活成功！请重启Obsidian"),this.settings.whitelistUpdated||await this.updateWhitelistFiles(a)}else{i||new Notice("❌ 激活码无效，插件已停用");try{localStorage.removeItem("cp_id"),localStorage.removeItem("cp_id_hash")}catch(e){}await this.updateWhitelistFiles("",!0),this.settings.deviceId="",this.settings.isActivated=!1,this.settings.hasBeenActivated=!1,this.settings.whitelistUpdated=!1,await this.saveSettings()}return h}catch(e){r=localStorage.getItem("cp_id"),n=localStorage.getItem("cp_id_hash");let t=!1;if((t=r&&n&&r===a&&this.generateDataHash(r)===n?!0:t)||this.settings.hasBeenActivated&&a===this.settings.deviceId)return this.settings.isActivated=!0,this.settings.hasBeenActivated=!0,await this.saveSettings(),!0;if(a&&s&&a===this.settings.deviceId)try{if(await this.checkHardwareIdMatch(a,s))return this.settings.isActivated=!0,this.settings.hasBeenActivated=!0,await this.saveSettings(),!0}catch(e){}return this.settings.hasBeenActivated||t||(this.settings.isActivated=!1),await this.saveSettings(),i||("AbortError"===e.name?new Notice("⚠️ 验证服务响应超时，请稍后再试"):new Notice("⚠️ 验证服务不可用，请切换到正常网络重试")),!1}}protectContent(e){try{e.innerHTML=`
<div class="protected-content">
<p>此内容需要激活才能查看</p>
<p>请在插件设置中输入激活码</p>
</div>
`}catch(e){}}async openPluginMarket(){new PluginMarketModal(this.app,this).open()}async createAreaPrompt(){if(this.app.plugins.plugins["templater-obsidian"]&&this.app.plugins.enabledPlugins.has("templater-obsidian"))new Notice("❌ 请先在设置中关闭Templater插件再创建领域");else{var e=await this.showInputPrompt("请输入领域名称","例如：数学领域");if(e&&this.areaCreator)try{await this.areaCreator.createArea(e),new Notice("✅ 领域创建完成！请手动开启Templater插件")}catch(e){new Notice("❌ 领域创建失败: "+e.message)}}}async showPathInputDialog(){return new Promise(t=>{let a=new Modal(this.app);a.titleEl.setText("选择目标路径");var e=a.contentEl.createDiv();e.style.marginBottom="20px";let i=e.createEl("input",{type:"text",placeholder:"请输入目标文件夹路径，例如：文件夹/子文件夹"});i.style.width="100%",i.style.padding="8px",i.style.border="1px solid var(--background-modifier-border)",i.style.borderRadius="4px";var e=e.createDiv(),e=(e.style.marginTop="8px",e.style.fontSize="12px",e.style.color="var(--text-muted)",e.textContent="提示：路径将自动标准化，支持Windows和Mac系统",a.contentEl.createDiv()),s=(e.style.display="flex",e.style.gap="10px",e.style.justifyContent="flex-end",e.createEl("button",{text:"取消"})),e=e.createEl("button",{text:"确认"});e.style.backgroundColor="var(--interactive-accent)",e.style.color="var(--text-on-accent)",e.style.border="none",e.style.padding="8px 16px",e.style.borderRadius="4px",e.style.cursor="pointer",s.style.backgroundColor="var(--background-secondary)",s.style.color="var(--text-normal)",s.style.border="1px solid var(--background-modifier-border)",s.style.padding="8px 16px",s.style.borderRadius="4px",s.style.cursor="pointer";let n=()=>{var e=i.value.trim();e?(a.close(),t(e)):new Notice("请输入目标路径")},r=()=>{a.close(),t(null)};e.addEventListener("click",n),s.addEventListener("click",r),i.addEventListener("keydown",e=>{"Enter"===e.key?n():"Escape"===e.key&&r()}),i.focus(),a.open()})}async showInputPrompt(l,d){return new Promise(t=>{let a=new Modal(this.app);a.titleEl.setText(l);var e=a.contentEl.createDiv();e.style.marginBottom="20px";let i=e.createEl("input",{type:"text",placeholder:d});i.style.width="100%",i.style.padding="8px",i.style.border="1px solid var(--background-modifier-border)",i.style.borderRadius="4px";e=e.createDiv();e.style.marginTop="8px",e.style.fontSize="12px",e.style.color="var(--text-muted)";let s=e.createEl("span",{text:"0/4 字符"});i.addEventListener("input",()=>{var e=(i.value.match(/[\u4e00-\u9fa5]/g)||[]).length;s.textContent=e+"/4 字符",4<e?(s.style.color="var(--text-error)",s.textContent+=" (超出限制)"):s.style.color=4===e?"var(--text-warning)":"var(--text-muted)"}),i.addEventListener("keydown",e=>{if(4<=(i.value.match(/[\u4e00-\u9fa5]/g)||[]).length&&/[\u4e00-\u9fa5]/.test(e.key))return e.preventDefault(),new Notice("❌ 中文字符不能超过4个"),!1});var e=a.contentEl.createDiv(),n=(e.style.display="flex",e.style.gap="10px",e.style.justifyContent="flex-end",e.createEl("button",{text:"取消"})),e=e.createEl("button",{text:"确认"});e.style.backgroundColor="var(--interactive-accent)",e.style.color="var(--text-on-accent)",e.style.border="none",e.style.padding="8px 16px",e.style.borderRadius="4px",e.style.cursor="pointer",n.style.backgroundColor="var(--background-secondary)",n.style.color="var(--text-normal)",n.style.border="1px solid var(--background-modifier-border)",n.style.padding="8px 16px",n.style.borderRadius="4px",n.style.cursor="pointer";let r=()=>{var e=i.value.trim();4<(e.match(/[\u4e00-\u9fa5]/g)||[]).length?new Notice("❌ 中文字符不能超过4个，请重新输入"):e?(a.close(),t(e)):new Notice("❌ 请输入领域名称")},o=()=>{a.close(),t(null)};e.addEventListener("click",r),n.addEventListener("click",o),i.addEventListener("keydown",e=>{"Enter"===e.key?r():"Escape"===e.key&&o()}),i.focus(),a.open()})}async renderPluginMarket(e,s,t){try{s.innerHTML='<div class="plugin-market-loading">🔄 正在加载插件列表...</div>';var a=await this.fetchPluginsFromVika();a.length?this.renderPluginCards(a,s):s.innerHTML='<div class="plugin-market-empty">暂无插件数据</div>'}catch(e){let t=e.message,a="plugin-market-error",i="❌";e.message.includes("激活码无效")?(i="🔑",a="plugin-market-error activation-error",t="若未激活，请在插件设置中重新激活"):e.message.includes("网络")||e.message.includes("超时")?(i="🌐",a="plugin-market-error network-error",t="网络连接异常，请切换到正常网络后重试"):e.message.includes("服务器错误")&&(i="🔧",a="plugin-market-error server-error",t="服务器暂时不可用，请稍后重试"),s.innerHTML=`
                <div class="${a}">
                    <div class="error-icon">${i}</div>
                    <div class="error-message">${t}</div>
                    <div class="error-actions">
                        <button class="retry-button" onclick="location.reload()">🔄 重试</button>
                    </div>
                </div>
            `}}async fetchPluginsFromVika(){return this.createFetcher().fetchAllPlugins(this.app.vault)}renderPluginCards(e,t){var a=document.createDocumentFragment(),i=document.createElement("div");i.className="plugin-market-container";let s=document.createElement("div");s.className="plugin-market-grid",e.forEach(e=>{e=this.createPluginCardElement(e);s.appendChild(e)}),i.appendChild(s),a.appendChild(i),t.innerHTML="",t.appendChild(a),this.bindPluginCardEvents(t,e)}createPluginCardElement(e){var t=document.createElement("div");return t.className="plugin-card",t.dataset.pluginId=e.id,t.innerHTML=`
            <div class="plugin-header">
                <div class="plugin-icon">
                    ${e.icon||'<div class="default-icon"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-puzzle-icon lucide-puzzle"><path d="M15.39 4.39a1 1 0 0 0 1.68-.474 2.5 2.5 0 1 1 3.014 3.015 1 1 0 0 0-.474 1.68l1.683 1.682a2.414 2.414 0 0 1 0 3.414L19.61 15.39a1 1 0 0 1-1.68-.474 2.5 2.5 0 1 0-3.014 3.015 1 1 0 0 1 .474 1.68l-1.683 1.682a2.414 2.414 0 0 1-3.414 0L8.61 19.61a1 1 0 0 0-1.68.474 2.5 2.5 0 1 1-3.014-3.015 1 1 0 0 0 .474-1.68l-1.683-1.682a2.414 2.414 0 0 1 0-3.414L4.39 8.61a1 1 0 0 1 1.68.474 2.5 2.5 0 1 0 3.014-3.015 1 1 0 0 1-.474-1.68l1.683-1.682a2.414 2.414 0 0 1 3.414 0z"/></svg></div>'}
                </div>
                <div class="plugin-info">
                    <h6 class="plugin-name">
                        ${e.nameUrl?`<a href="${e.nameUrl}" target="_blank" rel="noopener noreferrer" class="plugin-name-link" title="${e.nameUrl}">${e.name} <span class="link-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-question-mark-icon lucide-circle-question-mark"><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><path d="M12 17h.01"/></svg></span></a>`:e.name}
                    </h6>
                    <div class="plugin-meta">
                        <div class="plugin-version">v${e.version}</div>
                        ${e.timeAgo?`<div class="plugin-update-time">${e.timeAgo}</div>`:""}
                    </div>
                </div>
            </div>
            <div class="plugin-description">
                ${e.description||"暂无描述"}
            </div>
            <div class="plugin-author">
                作者: ${e.author||"未知"}
            </div>
            <div class="plugin-actions">
                ${"installed"===e.status?.action?'<button class="plugin-download-btn no-update-btn" disabled title="插件已是最新版本">无需更新</button>':`<button class="plugin-download-btn ${"update"===e.status?.action?"update-btn":""}" data-plugin-id="${e.id}" title="${"update"===e.status?.action?"更新插件":"下载插件"}">
                        ${"update"===e.status?.action?"更新插件":"下载插件"}
                    </button>`}
            </div>
        `,t}bindPluginCardEvents(e,s){e.addEventListener("click",a=>{if(a.target.classList.contains("plugin-download-btn")&&!a.target.disabled){a.preventDefault();let t=a.target.dataset.pluginId,e=s.find(e=>e.id===t);var i;e&&(i="update"===e.status?.action,a.target.disabled=!0,a.target.textContent=i?"更新中...":"下载中...",a.target.title=i?"正在更新插件":"正在下载插件",this.downloadPlugin(e,i).finally(()=>{a.target.classList.contains("no-update-btn")||(a.target.disabled=!1,a.target.textContent="update"===e.status?.action?"更新插件":"下载插件",a.target.title="update"===e.status?.action?"更新插件":"下载插件")}))}})}async downloadPlugin(e,t=!1){try{var a=this.createFetcher(),i=a.validatePluginData(e,!1);if(!i.isValid)throw new Error("插件数据不完整: "+i.errors.join(", "));if(!this.settings.isActivated||!this.settings.deviceId)throw new Error("插件未激活，无法下载");var s=await a.validatePluginValidity(e,this.cloudFunctionConfig.url);if(!s.isValid)throw new Error(s.reason);await a.downloadPlugin(e,this.app.vault),t?new Notice("✅ 更新完成，请重启Obsidian"):new Notice("✅ 下载完成，请重启并手动开启插件"),this.updatePluginButtonStatus(e.id,"installed")}catch(e){new Notice("❌ 下载失败: "+e.message)}}updatePluginButtonStatus(e,t){var e=document.querySelector(`[data-plugin-id="${e}"]`);e&&(e=e.querySelector(".plugin-download-btn"))&&"installed"===t&&(e.className="plugin-download-btn no-update-btn",e.disabled=!0,e.textContent="无需更新",e.title="插件已是最新版本")}createFetcher(){var e=new VikaPluginFetcher("","","",this);return e.cache.cacheDuration=72e5,e}onunload(){this.viewChangeTimeout&&clearTimeout(this.viewChangeTimeout),this.validationCache.clear(),this.settings.isActivated&&(this.metaBindTagAutoCompleteManager&&this.metaBindTagAutoCompleteManager.onunload(),this.graphNodeShortenerManager&&this.graphNodeShortenerManager.onunload(),this.canvasUIManager&&this.canvasUIManager.onunload(),this.canvasCollapseManager&&this.canvasCollapseManager.onunload(),this.canvasGroupCollapseManager)&&this.canvasGroupCollapseManager.onunload()}}class ContentProtectionSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.groupTypeCheckboxes=[],this.activeTab="activation"}async display(){try{var e=this.containerEl,t=(e.empty(),e.createEl("h3",{text:"Modular Plugin",cls:"setting-title"}),this.createTabNavigation(e),e.createEl("div",{cls:"tab-content-container"}));this.displayTabContent(t)}catch(e){}}createTabNavigation(e){let a=e.createEl("div",{cls:"tab-navigation"});[{id:"activation",name:"激活",icon:"key-round"},{id:"canvas",name:"白板",icon:"layout-dashboard"},{id:"interface",name:"元数据",icon:"archive"},{id:"data",name:"更新",icon:"hard-drive-download"},{id:"area",name:"领域",icon:"folder-plus"},{id:"misc",name:"杂项",icon:"settings"},{id:"help",name:"帮助",icon:"badge-info"}].forEach(e=>{var t=a.createEl("div",{cls:"tab-button "+(this.activeTab===e.id?"active":""),attr:{"data-tab":e.id}});t.createEl("span",{cls:"tab-icon"}).innerHTML=this.getLucideIconSVG(e.icon),t.createEl("span",{text:e.name,cls:"tab-name"}),t.addEventListener("click",()=>{this.activeTab=e.id,this.display()})}),this.addTabStyles(e)}addTabStyles(e){}getLucideIconSVG(e){return{"key-round":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-key-round"><path d="M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z"/><circle cx="16.5" cy="7.5" r=".5" fill="currentColor"/></svg>',"layout-dashboard":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-layout-dashboard"><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></svg>',"chart-spline":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-chart-spline"><path d="M3 12c6-6 12 6 18 0"/><path d="M3 21h18"/><path d="M3 3v18"/></svg>',archive:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-archive"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M10 12h4"/></svg>',"hard-drive-download":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hard-drive-download-icon lucide-hard-drive-download"><path d="M12 2v8"/><path d="m16 6-4 4-4-4"/><rect width="20" height="8" x="2" y="14" rx="2"/><path d="M6 18h.01"/><path d="M10 18h.01"/></svg>',"folder-plus":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-folder-plus"><path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/><path d="M12 10v6"/><path d="M9 13h6"/></svg>',settings:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-settings"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>',"badge-info":'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon lucide lucide-badge-info"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><line x1="12" y1="16" x2="12" y2="12"/><line x1="12" y1="8" x2="12.01" y2="8"/></svg>'}[e]||'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="svg-icon"><circle cx="12" cy="12" r="10"/></svg>'}displayTabContent(e){var t;if(this.plugin.settings.isActivated||"activation"===this.activeTab)switch(this.activeTab){case"activation":this.displayActivationContent(e);break;case"canvas":this.displayCanvasContent(e);break;case"scheduling":this.displaySchedulingContent(e);break;case"interface":this.displayInterfaceContent(e);break;case"data":this.displayDataContent(e);break;case"area":this.displayAreaContent(e);break;case"misc":this.displayMiscContent(e);break;case"help":this.displayHelpContent(e)}else(t=e.createEl("div",{cls:"content-section"})).createEl("h3",{text:"⚠️ ���件未激活"}),t.createEl("p",{text:"请先在激活设置中完成插件激活，才能使用此功能。",cls:"setting-item-description",attr:{style:"color: red;"}})}displayActivationContent(e){var e=e.createEl("div",{cls:"content-section"}),t=(e.createEl("h3",{text:"激活设置"}),e.createEl("p",{text:"⚠️请在正常的网络环境下激活",attr:{style:"color: red;"}}),e.createEl("li",{text:"若激活失败，请尝试再次激活"}),e.createEl("li",{text:"校园网、科学上网等情况，或导致网络异常，无法正常激活"}),e.createEl("li",{text:"同步等不稳定因素或造成激活状态异常，请重启Obsidian，或在此设置页面重新激活"}),new Setting(e).setName("激活状态").setDesc("显示当前激活状态").addText(e=>e.setValue(this.plugin.settings.isActivated?"已激活":"未激活").setDisabled(!0)),new Setting(e).setName("会员等级").setDesc("显示当前会员等级"));try{var a=document.createElement("a");a.href="https://ytmaps.vip/docs/xii2lnp4a7o1ruy59c0r8b.html",a.target="_blank",a.rel="noopener noreferrer",a.style.marginLeft="8px",a.style.display="inline-flex",a.style.alignItems="center",a.style.fontSize="12px",a.style.textDecoration="none",a.style.verticalAlign="middle",a.title="打开会员等级说明",a.innerHTML='（升级永久会员）<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-question-mark-icon lucide-badge-question-mark"><path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>',t?.nameEl&&t.nameEl.appendChild(a)}catch(e){}let i=null;t.addText(e=>{(i=e).setDisabled(!0)});a=localStorage.getItem("cp_member_level");a?i&&i.inputEl&&(i.inputEl.value=a):this.plugin.settings.isActivated&&this.plugin.vikaDataSyncManager?(i&&i.inputEl&&(i.inputEl.value="加载中..."),this.plugin.vikaDataSyncManager.fetchUserInfo().then(e=>{e&&e.level?(i&&i.inputEl&&(i.inputEl.value=e.level),localStorage.setItem("cp_member_level",e.level),e.validity&&localStorage.setItem("cp_member_validity",e.validity)):i&&i.inputEl&&(i.inputEl.value="未设置")}).catch(()=>{i&&i.inputEl&&(i.inputEl.value="获取失败")})):i&&i.inputEl&&(i.inputEl.value="未激活");let s,n=new Setting(e).setName("激活码").setDesc("请输入激活码").addText(e=>{(s=e).setPlaceholder("输入激活码").setValue(this.plugin.settings.deviceId).onChange(async e=>{n.setDesc("请输入激活码并点击验证按钮"),this.activationCode=e});try{this.plugin.settings&&this.plugin.settings.activationCodeMasked&&e&&e.inputEl&&(e.inputEl.type="password")}catch(e){}});try{let i=document.createElement("span");i.setAttribute("role","button");var r=!(!this.plugin.settings||!this.plugin.settings.activationCodeMasked);i.setAttribute("aria-label",r?"显示明文":"切换为星号"),i.title=r?"显示明文":"切换为星号",i.style.marginLeft="8px",i.style.cursor="pointer",i.style.display="inline-flex",i.style.alignItems="center",i.style.verticalAlign="middle",i.style.color="var(--text-muted)",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye-icon lucide-eye"><path d="M2.062 12.348a1 1 0 0 1 0-.696 10.75 10.75 0 0 1 19.876 0 1 1 0 0 1 0 .696 10.75 10.75 0 0 1-19.876 0"/><circle cx="12" cy="12" r="3"/></svg>',i.addEventListener("click",async e=>{e.preventDefault();try{var t,a;s&&s.inputEl&&(a="password"!==(t=s.inputEl).type,t.type=a?"password":"text",this.plugin.settings.activationCodeMasked=a,await this.plugin.saveSettings(),i.setAttribute("aria-label",a?"显示明文":"切换为星号"),i.title=a?"显示明文":"切换为星号")}catch(e){}}),n&&n.controlEl&&n.controlEl.appendChild(i)}catch(e){}n.addButton(t=>t.setButtonText("验证").onClick(async()=>{try{t.setButtonText("验证中..."),t.setDisabled(!0);await this.plugin.validateWithCloudFunction(this.activationCode);t.setButtonText("验证"),t.setDisabled(!1),this.display()}catch(e){new Notice("激活过程中出现错误，请稍后重试"),t.setButtonText("验证"),t.setDisabled(!1)}}));t=e.createEl("div",{attr:{style:"margin-top: 1em; border-top: 1px solid var(--background-modifier-border);"}}),t.createEl("h5",{text:"请支持正版，激活问题，请微信联系",attr:{style:"margin-bottom: 0.5em;"}}),a=t.createEl("div",{attr:{style:"display: flex; justify-content: left; align-items: center; gap: 20px; margin-top: 10px;"}}),a.createEl("img",{attr:{src:"https://ytmaps.vip/202406211223554.png",style:"max-width: 20%; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);",alt:"官方微信(ytmaps0512)"}}),r=a.createEl("div",{attr:{style:"display: flex; flex-direction: column; gap: 10px;"}}),e=r.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}});e.createEl("img",{attr:{src:"https://ytmaps.vip/images/%E5%B0%8F%E7%BA%A2%E4%B9%A6logo.png",style:"height: 30px; width: auto;",alt:"小红书"}});let o=e.createEl("a",{text:"我的小红书",attr:{href:"https://www.xiaohongshu.com/user/profile/63cfeb720000000026010489",target:"_blank",style:"color: var(--text-accent); text-decoration: none; font-size: 14px;"}});o.addEventListener("mouseenter",()=>{o.style.textDecoration="underline"}),o.addEventListener("mouseleave",()=>{o.style.textDecoration="none"});t=r.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}});t.createEl("img",{attr:{src:"https://ytmaps.vip/images/b%E7%AB%99logo.png",style:"height: 30px; width: auto;",alt:"哔哩哔哩"}});let l=t.createEl("a",{text:"我的哔站",attr:{href:"https://space.bilibili.com/2035394961",target:"_blank",style:"color: var(--text-accent); text-decoration: none; font-size: 14px;"}});l.addEventListener("mouseenter",()=>{l.style.textDecoration="underline"}),l.addEventListener("mouseleave",()=>{l.style.textDecoration="none"})}displayCanvasContent(e){var t=e.createEl("div",{cls:"content-section"}),t=(t.createEl("h3",{text:"Canvas文件链接设置"}),t.createEl("p",{text:"此设置控制Canvas画布中嵌入的文件节点是否被视为链接。启用后，这些节点将在关系图谱中显示为可追踪的链接。",cls:"setting-item-description"}),new Setting(t).setName("canvas画布中嵌入的卡片视为链接").addToggle(e=>e.setValue(this.plugin.settings.treatFileNodeEdgesAsLinks).onChange(async e=>{this.plugin.settings.treatFileNodeEdgesAsLinks=e,await this.plugin.saveSettings(),this.plugin.metadataCachePatcher=new MetadataCachePatcher(this.plugin)})),e.createEl("div",{cls:"content-section"})),t=(t.createEl("h3",{text:"Canvas反向链接设置"}),t.createEl("p",{text:'使用命令面板搜索 "在Canvas中嵌入反向链接" 来执行功能，或点击Canvas右侧的链接🔗按钮。',cls:"setting-item-description"}),new Setting(t).setName("起始X坐标").setDesc("反向链接卡片的起始X坐标位置").addText(e=>e.setPlaceholder("100").setValue(String(this.plugin.settings.canvasBacklinks.startX)).onChange(async e=>{e=parseInt(e);isNaN(e)||(this.plugin.settings.canvasBacklinks.startX=e,await this.plugin.saveSettings())})),new Setting(t).setName("起始Y坐标").setDesc("反向链接卡片的起始Y坐标位置").addText(e=>e.setPlaceholder("100").setValue(String(this.plugin.settings.canvasBacklinks.startY)).onChange(async e=>{e=parseInt(e);isNaN(e)||(this.plugin.settings.canvasBacklinks.startY=e,await this.plugin.saveSettings())})),new Setting(t).setName("卡片宽度").setDesc("每个反向链接卡片的宽度（像素）").addText(e=>e.setPlaceholder("440").setValue(String(this.plugin.settings.canvasBacklinks.nodeWidth)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<e&&(this.plugin.settings.canvasBacklinks.nodeWidth=e,await this.plugin.saveSettings())})),new Setting(t).setName("卡片高度").setDesc("每个反向链接卡片的高度（像素）").addText(e=>e.setPlaceholder("500").setValue(String(this.plugin.settings.canvasBacklinks.nodeHeight)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<e&&(this.plugin.settings.canvasBacklinks.nodeHeight=e,await this.plugin.saveSettings())})),new Setting(t).setName("水平间距").setDesc("卡片之间的水平间距（像素）").addText(e=>e.setPlaceholder("80").setValue(String(this.plugin.settings.canvasBacklinks.horizontalSpacing)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<=e&&(this.plugin.settings.canvasBacklinks.horizontalSpacing=e,await this.plugin.saveSettings())})),new Setting(t).setName("垂直间距").setDesc("行与行之间的垂直间距（像素）").addText(e=>e.setPlaceholder("100").setValue(String(this.plugin.settings.canvasBacklinks.verticalSpacing)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<=e&&(this.plugin.settings.canvasBacklinks.verticalSpacing=e,await this.plugin.saveSettings())})),new Setting(t).setName("列数").setDesc("网格布局的列数").addText(e=>e.setPlaceholder("5").setValue(String(this.plugin.settings.canvasBacklinks.columns)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<e&&(this.plugin.settings.canvasBacklinks.columns=e,await this.plugin.saveSettings())})),e.createEl("div",{cls:"content-section"}));t.createEl("h3",{text:"Canvas分组设置"}),t.createEl("p",{text:'使用命令面板搜索 "按笔记类型对Canvas节点分组" 来执行功能，或点击Canvas右侧的网格按钮。此功能会根据笔记的frontmatter中的属性字段进行分组，默认按"笔记类型"属性（可自定义）。',cls:"setting-item-description"}),this.displayGroupingSettings(t)}async displayGroupingSettings(e){new Setting(e).setName("分组起始X坐标").setDesc("分组的起始X坐标位置").addText(e=>e.setPlaceholder("100").setValue(String(this.plugin.settings.canvasGrouping.startX)).onChange(async e=>{e=parseInt(e);isNaN(e)||(this.plugin.settings.canvasGrouping.startX=e,await this.plugin.saveSettings())})),new Setting(e).setName("分组起始Y坐标").setDesc("分组的起始Y坐标位置").addText(e=>e.setPlaceholder("100").setValue(String(this.plugin.settings.canvasGrouping.startY)).onChange(async e=>{e=parseInt(e);isNaN(e)||(this.plugin.settings.canvasGrouping.startY=e,await this.plugin.saveSettings())})),new Setting(e).setName("分组间距").setDesc("分组之间的间距（像素）").addText(e=>e.setPlaceholder("200").setValue(String(this.plugin.settings.canvasGrouping.groupSpacing)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<=e&&(this.plugin.settings.canvasGrouping.groupSpacing=e,await this.plugin.saveSettings())})),new Setting(e).setName("最大行宽度").setDesc("一行中分组的最大总宽度，超过后换行（像素）").addText(e=>e.setPlaceholder("5800").setValue(String(this.plugin.settings.canvasGrouping.maxRowWidth)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<e&&(this.plugin.settings.canvasGrouping.maxRowWidth=e,await this.plugin.saveSettings())})),new Setting(e).setName("分组卡片垂直间距").setDesc("分组内卡片之间的垂直间距（像素）").addText(e=>e.setPlaceholder("60").setValue(String(this.plugin.settings.canvasGrouping.verticalSpacing??60)).onChange(async e=>{e=parseInt(e);!isNaN(e)&&0<=e&&(this.plugin.settings.canvasGrouping.verticalSpacing=e,await this.plugin.saveSettings())})),new Setting(e).setName("卡片高度、宽度").setDesc("与Canvas反向链接设置保持一致");var t=e.createEl("div",{cls:"content-section"}),t=(t.createEl("h3",{text:"关系图谱节点名称简化"}),t.createEl("p",{text:"在关系图谱中将非md文件节点的完整路径显示为简短的文件名，使图谱更清晰易读。支持canvas、excalidraw、pdf、图片等格式。",cls:"setting-item-description"}),new Setting(t).setName("启用节点名称简化").setDesc("在关系图谱中显示文件名而非完整路径").addToggle(t=>t.setValue(this.plugin.settings.canvasGraphNodeShortener.enabled).onChange(async e=>{await this.plugin.graphNodeShortenerManager.toggleFeature(e)||t.setValue(!1)})),e.createEl("div",{cls:"content-section"})),t=(t.createEl("h3",{text:"Canvas节点标题功能"}),t.createEl("p",{text:"为Canvas节点添加可编辑的标题功能。点击节点上的标题区域可以编辑标题，支持回车保存和ESC取消。",cls:"setting-item-description"}),new Setting(t).setName("启用Canvas节点标题功能").setDesc("开启或关闭Canvas节点的标题编辑功能").addToggle(e=>e.setValue(this.plugin.settings.canvasTitleEnabled).onChange(async e=>{this.plugin.settings.canvasTitleEnabled=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&this.plugin.canvasCollapseManager.updateCanvasTitleContainers(e)})),e.createEl("div",{cls:"content-section"}));t.createEl("h3",{text:"Canvas节点折叠与导航"}),t.createEl("p",{text:"提供Canvas节点的折叠/展开功能、层级创建、小地图导航等高级功能。点击节点上的按钮可以折叠/展开子节点，右键菜单可以创建子节点和兄弟节点。",cls:"setting-item-description"}),this.displayCanvasCollapseSettings(t)}displayInterfaceContent(e){e=e.createEl("div",{cls:"content-section"});e.createEl("h3",{text:"Meta Bind 标签自动补全"}),e.createEl("p",{text:"为Modal对话框内的输入框提供标签自动补全功能，严格按照指定规则提取标签。",cls:"setting-item-description"}),new Setting(e).setName("启用Meta Bind标签自动补全").setDesc("开启或关闭Meta Bind标签自动补全功能").addToggle(e=>e.setValue(this.plugin.settings.metaBindTagAutoCompleteEnabled).onChange(async e=>{this.plugin.settings.metaBindTagAutoCompleteEnabled=e,await this.plugin.saveSettings(),new Notice(e?"已启用，请重启Obsidian":"已禁用，请重启Obsidian")}))}displayDataContent(e){e=e.createEl("div",{cls:"content-section"}),e.createEl("h3",{text:"更新仓库"}),new Setting(e).setName("获取更新").setDesc("获取更新内容数据到 Obsidian").addButton(e=>e.setButtonText("获取更新").onClick(async()=>{this.plugin.getHardwareId&&this.plugin.checkHardwareIdMatch&&this.plugin.validateWithCloudFunction&&this.plugin.vikaDataSyncManager&&await this.plugin.vikaDataSyncManager.syncVikaData()})),new Setting(e).setName("同步状态").setDesc("显示更新仓库当前状态").addText(e=>{var t=this.plugin.vikaDataSyncManager?"已初始化，可以获取更新":"未初始化";e.setValue(t).setDisabled(!0)}),new Setting(e).setName("启用更新提醒").setDesc("启用后会在启动时检查并提醒可用的更新内容").addToggle(e=>e.setValue(this.plugin.settings.enableUpdateNotification??!0).onChange(async e=>{this.plugin.settings.enableUpdateNotification=e,await this.plugin.saveSettings(),new Notice(e?"更新提醒已启用":"更新提醒已禁用")})),e=e.createEl("div",{cls:"setting-item-description"});e.createEl("p",{text:"获取更新功能说明："}),e.createEl("ul").createEl("li",{text:'点击"获取更新"按钮，或点击左侧功能区下载图标'})}displayCanvasCollapseSettings(e){new Setting(e).setName("启用Canvas折叠功能").setDesc("开启或关闭Canvas节点的折叠/展开功能").addToggle(e=>e.setValue(this.plugin.settings.canvasCollapse?.enabled??!0).onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.enabled=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&((this.plugin.canvasCollapseManager.settings.enabled=e)?this.plugin.canvasCollapseManager.initializeCanvasButtons():this.plugin.canvasCollapseManager.cleanupButtons()),new Notice(e?"Canvas折叠功能已启用":"Canvas折叠功能已禁用")})),new Setting(e).setName("启用Canvas小地图").setDesc("开启或关闭Canvas右下角的小地图导航功能").addToggle(e=>e.setValue(this.plugin.settings.canvasCollapse?.minimapEnabled??!1).onChange(async t=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.minimapEnabled=t,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.minimapEnabled=t,this.plugin.canvasCollapseManager.minimaps.forEach(e=>{e.container&&(t?e.container.style.display="":(e.container.style.display="none",this.plugin.canvasCollapseManager.stopMinimapAnimation(e)))}),t)&&this.plugin.app.workspace.getLeavesOfType("canvas").forEach(e=>{e.view&&this.plugin.canvasCollapseManager.createMinimap(e.view)}),new Notice(t?"Canvas小地图已启用":"Canvas小地图已禁用")}));var t=e.createEl("div",{cls:"setting-item-description"}),t=(t.createEl("p",{text:"使用方法："}),t.createEl("ul"));t.createEl("li",{text:'点击节点上的 "-" 按钮折叠子节点，"+" 按钮展开子节点'}),t.createEl("li",{text:'使用快捷键 "折叠/展开选中卡片的子节点" 切换选中节点状态'}),t.createEl("li",{text:'右键点击节点菜单选择 "创建子节点" 或 "创建兄弟节点"'}),t.createEl("li",{text:"右下角小地图可以点击展开，滚轮缩放，拖拽移动视角，点击节点快速定位"}),new Setting(e).setName("新节点宽度").setDesc("创建新节点时的默认宽度 (100-500像素)").addSlider(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.setLimits(100,500,10).setValue(t?.childNodeWidth||250).setDynamicTooltip().onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.childNodeWidth=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.childNodeWidth=e)})}),new Setting(e).setName("新节点高度").setDesc("创建新节点时的默认高度 (50-300像素)").addSlider(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.setLimits(50,300,10).setValue(t?.childNodeHeight||60).setDynamicTooltip().onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.childNodeHeight=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.childNodeHeight=e)})}),new Setting(e).setName("布局方向").setDesc("设置子节点相对于父节点的创建方向").addDropdown(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.addOption("TB","上到下 (Top to Bottom)").addOption("BT","下到上 (Bottom to Top)").addOption("LR","左到右 (Left to Right)").addOption("RL","右到左 (Right to Left)").setValue(t?.direction||"LR").onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.direction=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.direction=e)})}),new Setting(e).setName("父子节点间距").setDesc("父节点与子节点之间的距离 (100-500像素)").addSlider(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.setLimits(100,500,10).setValue(t?.parentChildGap||200).setDynamicTooltip().onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.parentChildGap=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.parentChildGap=e)})}),new Setting(e).setName("兄弟节点间距 (水平)").setDesc("水平排列时兄弟节点之间的距离 (20-500像素)").addSlider(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.setLimits(20,500,10).setValue(t?.siblingGapHorizontal||350).setDynamicTooltip().onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.siblingGapHorizontal=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.siblingGapHorizontal=e)})}),new Setting(e).setName("兄弟节点间距 (垂直)").setDesc("垂直排列时兄弟节点之间的距离 (20-500像素)").addSlider(e=>{var t=this.plugin.settings.canvasCollapse?.create||this.plugin.canvasCollapseManager?.getDefaultSettings().create;e.setLimits(20,500,10).setValue(t?.siblingGapVertical||200).setDynamicTooltip().onChange(async e=>{this.plugin.settings.canvasCollapse||(this.plugin.settings.canvasCollapse=this.plugin.canvasCollapseManager.getDefaultSettings()),this.plugin.settings.canvasCollapse.create.siblingGapVertical=e,await this.plugin.saveSettings(),this.plugin.canvasCollapseManager&&(this.plugin.canvasCollapseManager.settings.create.siblingGapVertical=e)})})}displayAreaContent(e){e=e.createEl("div",{cls:"content-section"});e.createEl("h3",{text:"领域管理"}),e.createEl("p",{text:"创建领域前需要先关闭Templater插件，再创建领域(❗️❗️❗️看似简单，实际非常复杂，强烈建议提前备份仓库）",cls:"setting-item-description"});let t=()=>!!this.plugin.app.plugins.plugins["templater-obsidian"]&&this.plugin.app.plugins.enabledPlugins.has("templater-obsidian");var a=e.createEl("div",{cls:"area-step-section"}),a=(a.createEl("div",{cls:"step-number",text:"1"}),a.createEl("div",{cls:"area-step-content"}));a.createEl("h4",{text:"检查Templater插件状态"});let i=a.createEl("div",{cls:"area-status-indicator "+(t()?"enabled":"disabled")});i.textContent=t()?"❌ Templater插件已启用（无法创建领域）":"✅ Templater插件已关闭";a=e.createEl("div",{cls:"area-step-section"}),a.createEl("div",{cls:"step-number",text:"2"}),a=a.createEl("div",{cls:"area-step-content"});a.createEl("h4",{text:"创建新领域（慎重取名，不可逆）"});a.createEl("button",{text:"创建新领域",cls:"area-create-button"}).addEventListener("click",async()=>{t()?new Notice("❌ 请先关闭Templater插件再创建领域"):this.plugin.areaCreator?await this.plugin.createAreaPrompt():new Notice("❌ 领域创建器未初始化")});a=e.createEl("div",{cls:"area-instructions"}),a.createEl("h4",{text:"使用说明"}),e=a.createEl("ul");e.createEl("li",{text:"非必要，不建议创建新的领域"}),e.createEl("li",{text:"创建新的领域暂时不可逆，需谨慎，强烈建议先备份仓库"}),e.createEl("li",{text:"创建领域前，需手动关闭Templater插件"}),e.createEl("li",{text:"领域创建完成后，需手动开启Templater插件，并重启Obsidian"})}displayMiscContent(e){e=e.createEl("div",{cls:"content-section"});e.createEl("h3",{text:"杂项设置"}),e.createEl("h4",{text:"Lucide 图标设置",cls:"setting-subsection-title"}),e.createEl("p",{text:"管理输入 {icon= 时显示的常用图标列表",cls:"setting-item-description"}),new Setting(e).setName("添加常用图标").setDesc("从图标库中选择并添加常用图标").addButton(e=>e.setButtonText("选择图标").setCta().onClick(()=>{new IconPickerModal(this.app,this.plugin,e=>{var t=this.plugin.settings.lucideIcons.commonIcons||[],t=[...new Set([...t,...e])];this.plugin.settings.lucideIcons.commonIcons=t,this.plugin.saveSettings(),this.display(),new Notice(`已添加 ${e.length} 个图标`)}).open()}));let s=e.createDiv("lucide-icon-list");e=this.plugin.settings.lucideIcons?.commonIcons||[];0===e.length?s.createEl("p",{text:'暂无常用图标，点击"选择图标"按钮添加',cls:"setting-item-description"}):e.forEach((t,e)=>{var a=s.createDiv("lucide-icon-item"),i=a.createDiv("icon-preview");try{setIcon(i,"lucide-"+t)}catch(e){i.setText(t)}a.createSpan({text:t,cls:"icon-name-text"}),a.createEl("button",{text:"×",cls:"icon-delete-btn"}).addEventListener("click",async()=>{this.plugin.settings.lucideIcons.commonIcons.splice(e,1),await this.plugin.saveSettings(),this.display(),new Notice("已删除图标: "+t)})})}displayHelpContent(e){e=e.createEl("div",{cls:"content-section"}),e.createEl("h3",{text:"帮助信息"}),e.createEl("p",{text:"如果您在使用过程中遇到问题，请参考以下信息：",cls:"setting-item-description"}),e=e.createEl("ul");e.createEl("li",{text:"请确保输入正确的激活码"}),e.createEl("li",{text:"如有其他问题，请联系鱼先生"})}}class VikaDataSyncManager{constructor(e){this.plugin=e,this.app=e.app,this.vault=e.app.vault,this.cloudFunctionUrl="https://b.ytmaps.vip/templater_fffaf2025"}async fetchVikaConfig(){try{var e=await fetch(this.cloudFunctionUrl);if(e.ok)return await e.json();throw new Error("Failed to fetch config: "+e.status)}catch(e){throw e}}async fetchUserInfo(){try{if(!this.plugin.getHardwareId||!this.plugin.checkHardwareIdMatch||!this.plugin.validateWithCloudFunction)return null;var a=this.plugin.settings.deviceId;if(!a)return null;var i=this.plugin.getCurrentTimestamp(),s={action:"validate"};let e=null;try{e=await this.plugin.getHardwareId()}catch(e){}e&&(s.hardwareId=e||"");var n=await this.plugin.generateSignature(a,i,s);let t=new AbortController;var r,o=setTimeout(()=>t.abort(),15e3),l=await fetch(this.plugin.cloudFunctionConfig.url,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"validate",deviceId:a,hardwareId:e,timestamp:i,signature:n}),signal:t.signal});return clearTimeout(o),l.ok?(r=await l.json()).success&&r.data?{level:r.data.level||null,validity:r.data.validity||null}:null:null}catch(e){return null}}async syncVikaData(){try{if(!this.plugin.getHardwareId||!this.plugin.checkHardwareIdMatch||!this.plugin.validateWithCloudFunction)return;let t=document.createElement("div");t.className="vika-custom-window",t.innerHTML=`
                <div class="vika-window-header">
                    <h3>模块化OB仓库更新</h3>
                    <p>‼️注意：此窗口仅更新模板、模块等文档(不包含插件)</p>
                    <div class="vika-window-controls">
                        <button class="vika-help-btn" title="使用说明">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-info-icon lucide-badge-info">
                                <path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/>
                                <line x1="12" x2="12" y1="16" y2="12"/>
                                <line x1="12" x2="12.01" y1="8" y2="8"/>
                            </svg>
                        </button>
                        <button class="vika-window-close">×</button>
                    </div>
                </div>
                <div class="vika-window-content">
                    <div class="vika-updateid-list"><div class="vika-loading">正在加载更新数据...</div></div>
                    <div class="vika-window-footer">
                        <button class="vika-cancel-btn">取消</button>
                    </div>
                </div>
            `,document.body.appendChild(t);var e=t.querySelector(".vika-updateid-list"),s=t.querySelector(".vika-cancel-btn"),n=t.querySelector(".vika-window-close"),r=t.querySelector(".vika-help-btn");s&&s.addEventListener("click",()=>{t.remove()}),n&&n.addEventListener("click",()=>{t.remove()}),r&&r.addEventListener("click",()=>{new Notice(`📖 使用说明：

• 忽略按钮：点击后，该组更新内容将被忽略（需谨慎选择）
• 更新按钮：点击后，更新内容将保存到你仓库
• 注意养成定期备份的习惯`,8e3)});let a=e=>{e.target===t&&(t.remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",i))},i=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("click",a),document.removeEventListener("keydown",i))};setTimeout(()=>{document.addEventListener("click",a),document.addEventListener("keydown",i)},100);var o=await this.fetchVikaConfig(),l=new VikaAPI(o),d=new VikaSyncProcessor(l,this.plugin),c={customWindow:t,listContainer:e};await new ObsidianSyncHandler(this.plugin,d,o.deviceId,c).fetchData()}catch(e){}}log(e,t){this.plugin.settings.debugMode}}class VikaAPI{constructor(e){if(!e?.apiKey)throw new Error("缺少API Key");if(!e?.tables?.length)throw new Error("未配置数据表");this.apiKey=e.apiKey,this.tables=e.tables,this.apiUrlRoot="https://api.vika.cn/fusion/v1/"}}class VikaSyncProcessor{constructor(e,t){this.vika=e,this.plugin=t,this.app=t.app,this.vault=t.app.vault}async fetchRecordsFromTable(i){Date.now();try{let e=[],t=1;let a=!0;for(;a;){Date.now();var s=`${this.vika.apiUrlRoot}datasheets/${i.tableID}/records?viewId=${i.viewID}&pageSize=1000&pageNum=`+t,n=await fetch(s,{headers:{Authorization:"Bearer "+this.vika.apiKey,"Content-Type":"application/json"}});if(!n.ok)throw new Error("请求失败: "+n.status);var r=await n.json();Date.now();if(!r.data.records||0===r.data.records.length)break;e=e.concat(r.data.records);var o=r.data.total;a=o>1e3*t,t++}Date.now();return e}catch(e){throw new Error("获取数据失败: "+e.message)}}async processTableData(e){try{new Notice("开始同步数据...");var t=await this.fetchRecordsFromTable(e);if(t?.length)for(var a of t)await this.processRecord(a,e.targetPath);else new Notice("无数据可同步")}catch(e){throw new Error("处理数据失败: "+e.message)}}async processUpdateIdGroup(t,a){try{let e=null;for(var i of t.records){var s;i.fields?.UpdateTime&&(s=new Date(i.fields.UpdateTime).getTime(),!e||s>e)&&(e=s)}for(var n of t.records)await this.processRecord(n,a);await this.recordSyncInfo(t.updateId,e),new Notice(`✅ 更新组 ${t.updateId} 同步完成`)}catch(e){throw new Error("处理更新组失败: "+e.message)}}async recordSyncInfo(e,t){try{this.plugin.settings.vikaSync||(this.plugin.settings.vikaSync={updateIds:[],updateTimes:{},ignoredUpdateIds:[]}),this.plugin.settings.vikaSync.updateIds.includes(e)||this.plugin.settings.vikaSync.updateIds.push(e),t&&(this.plugin.settings.vikaSync.updateTimes[e]=new Date(t).toISOString()),await this.plugin.saveSettings();try{"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem("obsidian-content-protection-vikaSync",JSON.stringify(this.plugin.settings.vikaSync))}catch(e){}}catch(e){}}async recordIgnoredUpdateId(e){try{this.plugin.settings.vikaSync||(this.plugin.settings.vikaSync={updateIds:[],updateTimes:{},ignoredUpdateIds:[]}),this.plugin.settings.vikaSync.ignoredUpdateIds||(this.plugin.settings.vikaSync.ignoredUpdateIds=[]),this.plugin.settings.vikaSync.ignoredUpdateIds.includes(e)||this.plugin.settings.vikaSync.ignoredUpdateIds.push(e),await this.plugin.saveSettings();try{"undefined"!=typeof window&&window.localStorage&&window.localStorage.setItem("obsidian-content-protection-vikaSync",JSON.stringify(this.plugin.settings.vikaSync))}catch(e){}}catch(e){throw e}}async refreshWindowContent(e,t,s){try{var a=await this.vikaSyncer.fetchRecordsFromTable(s);let t=this.groupRecordsByUpdateId(a);var i=e.querySelector(".vika-window-header h3");i&&(i.textContent=`模块化OB仓库更新 (${t.size} 个更新组)`);let c=e.querySelector(".vika-updateid-list");if(c){c.innerHTML="";let l=0;t.forEach((e,t)=>{if(!(20<=l)){l++;var i=document.createElement("div"),s=(i.className="vika-updateid-item",document.createElement("div")),t=(s.className="vika-updateid-header",s.innerHTML=`
                        <div class="vika-header-left">
                            <span class="vika-updateid-id">更新ID：${t}</span>
                            <span class="vika-updateid-count">(${e.records.length} 条记录)</span>
                        </div>
                        <div class="vika-header-buttons">
                            <button class="vika-ignore-btn" data-update-id="${t}">忽略</button>
                            <button class="vika-sync-btn" data-update-id="${t}">更新</button>
                        </div>
                    `,i.appendChild(s),e.records.slice(0,10)),s=10<e.records.length,n=document.createElement("div"),r=(n.className="vika-records-table-container",document.createElement("table")),o=(r.className="vika-records-table",document.createElement("thead"));let a=document.createElement("tr");["文件名","保存路径","更新描述","更新日期"].forEach(e=>{var t=document.createElement("th");t.textContent=e,a.appendChild(t)}),o.appendChild(a),r.appendChild(o);let d=document.createElement("tbody");t.forEach(t=>{var e=document.createElement("tr"),a=document.createElement("td"),a=(a.textContent=t.fields?.Title||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.SubFolder||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.Description||"",e.appendChild(a),document.createElement("td")),t=t.fields?.UpdateTime||"";if(t)try{var i,s,n,r,o,l=new Date(t);isNaN(l.getTime())?a.textContent=t:(i=l.getFullYear(),s=String(l.getMonth()+1).padStart(2,"0"),n=String(l.getDate()).padStart(2,"0"),r=String(l.getHours()).padStart(2,"0"),o=String(l.getMinutes()).padStart(2,"0"),a.textContent=i+`-${s}-${n} ${r}:`+o)}catch(e){a.textContent=t}else a.textContent="";e.appendChild(a),d.appendChild(e)}),s&&(o=document.createElement("tr"),(t=document.createElement("td")).className="vika-more-records",t.colSpan=4,t.textContent=`... 还有 ${e.records.length-10} 条记录（不显示）`,o.appendChild(t),d.appendChild(o)),r.appendChild(d),n.appendChild(r),i.appendChild(n),c.appendChild(i)}});c.addEventListener("click",async e=>{if(e.target.classList.contains("vika-sync-btn")){var i=e.target.dataset.updateId,i=t.get(i);if(i)if(await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("确认更新");var a=t.contentEl,a=(a.createEl("p",{text:'⚠️ 注意：更新会覆盖原有的仓库文档，必要时请备份"保存路径"对应的文档。',attr:{style:"color: var(--text-error); font-weight: bold; margin-bottom: 1em;"}}),a.createEl("p",{text:"请确认是否继续更新？",attr:{style:"margin-bottom: 1em;"}}),a.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));a.createEl("button",{text:"取消"}).addEventListener("click",()=>{t.close(),e(!1)}),a.createEl("button",{text:"确认更新",cls:"mod-warning"}).addEventListener("click",()=>{t.close(),e(!0)}),t.open()})){let t=e.target,a=t.textContent;t.disabled=!0,t.textContent="更新中...",t.style.opacity="0.6";try{await this.vikaSyncer.processUpdateIdGroup(i,s.targetPath),t.textContent="✅ 已更新",t.style.background="var(--color-green)",t.style.color="white"}catch(e){t.textContent="❌ 更新失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3)}}}else if(e.target.classList.contains("vika-ignore-btn")){i=e.target.dataset.updateId;if(i){let t=e.target,a=t.textContent;t.disabled=!0,t.textContent="忽略中...",t.style.opacity="0.6";try{await this.vikaSyncer.recordIgnoredUpdateId(i),t.textContent="✅ 已忽略",t.style.background="var(--color-orange)",t.style.color="white"}catch(e){t.textContent="❌ 忽略失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3)}}}})}}catch(e){}}bindWindowEventListeners(e,t,s){var a=e.querySelector(".vika-updateid-list"),i=e.querySelector(".vika-cancel-btn");a.addEventListener("click",async e=>{if(e.target.classList.contains("vika-sync-btn")){var i=e.target.dataset.updateId,i=t.get(i);if(i)if(await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("确认更新");var a=t.contentEl,a=(a.createEl("p",{text:'⚠️ 注意：更新会覆盖原有的仓库文档，必要时请备份"保存路径"对应的文档。',attr:{style:"color: var(--text-error); font-weight: bold; margin-bottom: 1em;"}}),a.createEl("p",{text:"请确认是否继续更新？",attr:{style:"margin-bottom: 1em;"}}),a.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));a.createEl("button",{text:"取消"}).addEventListener("click",()=>{t.close(),e(!1)}),a.createEl("button",{text:"确认更新",cls:"mod-warning"}).addEventListener("click",()=>{t.close(),e(!0)}),t.open()})){let t=e.target,a=t.textContent;t.disabled=!0,t.textContent="更新中...",t.style.opacity="0.6";try{await this.vikaSyncer.processUpdateIdGroup(i,s.targetPath),t.textContent="✅ 已更新",t.style.background="var(--color-green)",t.style.color="white"}catch(e){t.textContent="❌ 更新失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3),new Notice("❌ 更新失败: "+e.message)}}}}),i.addEventListener("click",()=>{e.remove()}),e.querySelector(".vika-window-close").addEventListener("click",()=>{e.remove()})}async processRecord(a,e){if(a.fields?.Title&&a.fields?.MD0512){var i=(a.fields.Extension||"md").replace(/[^a-zA-Z0-9]/g,"").toLowerCase()||"md",e=[e,(a.fields.SubFolder||"").replace(/\\/g,"/").replace(/\/+/g,"/")].filter(e=>e&&"string"==typeof e&&""!==e.trim()).join("/").replace(/\/+/g,"/").replace(/^\//,""),s=e.startsWith(".obsidian/")||".obsidian"===e;let t=(e+"/"+(a.fields.Title.replace(/[\/|\\:'"{}<>\.\*]/g,"-").trim()+"."+i)).replace(/\/+/g,"/");try{if(s){var n,r=(t=t.replace(/^\/+/,"")).split("/");let e="";for(n of r.slice(0,-1))e=e?e+"/"+n:n,await this.vault.adapter.exists(e)||await this.vault.createFolder(e)}else{var o=t.substring(0,t.lastIndexOf("/"));await this.vault.adapter.exists(o)||await this.vault.createFolder(o)}let e=a.fields.MD0512;try{e=this.validateFileContent(t,e)}catch(e){throw new Error("内容验证失败: "+e.message)}await this.vault.adapter.write(t,e)}catch(e){}}}validateFileContent(e,t){switch(e.split(".").pop().toLowerCase()){case"json":try{var a=JSON.parse(t);return JSON.stringify(a,null,2)}catch(e){throw new Error("无效的 JSON 格式: "+e.message)}case"css":try{if(!t.includes("{")||!t.includes("}"))throw new Error("CSS内容缺少必要的花括号");if((t.match(/{/g)||[]).length!==(t.match(/}/g)||[]).length)throw new Error("CSS花括号不配对");return t}catch(e){throw new Error("无效的 CSS 格式: "+e.message)}case"js":try{return new Function(t),t}catch(e){throw new Error("无效的 JavaScript 代码: "+e.message)}default:return t}}}class ObsidianSyncHandler{constructor(e,t,a,i=null){this.plugin=e,this.app=e.app,this.vault=e.app.vault,this.activeFile=e.app.workspace.getActiveFile(),this.folder=this.activeFile?.parent?.path||"",this.vikaSyncer=t,this.deviceId=a,this.currentUpdateWindow=i}async fetchData(){Date.now();try{var e,t,a,i,s=this.vikaSyncer.vika.tables;s?.length&&(e=s[0],t=this.currentUpdateWindow||this.createEmptyUpdateWindow(e),Date.now(),a=await this.vikaSyncer.fetchRecordsFromTable(e),Date.now(),a?.length?(Date.now(),i=this.groupRecordsByUpdateId(a),Date.now(),i.size?this.populateUpdateWindow(t,i,e):(t&&t.listContainer&&(t.listContainer.innerHTML='<div class="vika-loading">仓库模板已经最新，暂无更新内容</div>'),new Notice("仓库模板已经最新，暂无更新内容"))):t&&t.listContainer&&(t.listContainer.innerHTML='<div class="vika-loading">仓库模板已经最新，暂无更新内容</div>'))}catch(e){this.currentUpdateWindow&&this.currentUpdateWindow.listContainer&&(this.currentUpdateWindow.listContainer.innerHTML='<div class="vika-loading">加载数据出错，请稍后重试</div>')}finally{Date.now()}}createEmptyUpdateWindow(e){this.currentUpdateWindow&&this.currentUpdateWindow.customWindow&&this.currentUpdateWindow.customWindow.isConnected&&this.currentUpdateWindow.customWindow.remove();let t=document.createElement("div");t.className="vika-custom-window",t.innerHTML=`
                <div class="vika-window-header">
                    <h3>模块化OB仓库更新</h3>
                    <p>‼️注意：此窗口仅更新模板、模块等文档(不包含插件)</p>
                    <div class="vika-window-controls">
                        <button class="vika-help-btn" title="使用说明">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-info-icon lucide-badge-info">
                                <path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/>
                                <line x1="12" x2="12" y1="16" y2="12"/>
                                <line x1="12" x2="12.01" y1="8" y2="8"/>
                            </svg>
                        </button>
                        <button class="vika-window-close">×</button>
                    </div>
                </div>
                <div class="vika-window-content">
                    <div class="vika-updateid-list"><div class="vika-loading">正在加载更新数据...</div></div>
                    <div class="vika-window-footer">
                        <button class="vika-cancel-btn">取消</button>
                    </div>
                </div>
            `,document.body.appendChild(t);var a=t.querySelector(".vika-updateid-list"),i=t.querySelector(".vika-cancel-btn"),s=t.querySelector(".vika-window-close"),n=t.querySelector(".vika-help-btn");i&&i.addEventListener("click",()=>{t.remove()}),s&&s.addEventListener("click",()=>{t.remove()}),n&&n.addEventListener("click",()=>{new Notice(`📖 使用说明：

• 忽略按钮：点击后，该组更新内容将被忽略（需谨慎选择）
• 更新按钮：点击后，更新内容将保存到你仓库
• 注意养成定期备份的习惯`,8e3)});let r=e=>{e.target===t&&(t.remove(),document.removeEventListener("click",r),document.removeEventListener("keydown",o))},o=e=>{"Escape"===e.key&&(t.remove(),document.removeEventListener("click",r),document.removeEventListener("keydown",o))};return setTimeout(()=>{document.addEventListener("click",r),document.addEventListener("keydown",o)},100),this.currentUpdateWindow={customWindow:t,listContainer:a,tableConfig:e},this.currentUpdateWindow}populateUpdateWindow(e,t,s){if(e&&e.customWindow&&e.listContainer){let l=e.listContainer,c=(l.innerHTML="",0);t.forEach((e,t)=>{if(!(20<=c)){c++;var i=document.createElement("div"),s=(i.className="vika-updateid-item",document.createElement("div")),t=(s.className="vika-updateid-header",s.innerHTML=`
                        <div class="vika-header-left">
                            <span class="vika-updateid-id">更新ID：${t}</span>
                            <span class="vika-updateid-count">(${e.records.length} 条记录)</span>
                        </div>
                        <div class="vika-header-buttons">
                            <button class="vika-ignore-btn" data-update-id="${t}">忽略</button>
                            <button class="vika-sync-btn" data-update-id="${t}">更新</button>
                        </div>
                    `,i.appendChild(s),e.records.slice(0,5)),s=5<e.records.length,n=document.createElement("div"),r=(n.className="vika-records-table-container",document.createElement("table")),o=(r.className="vika-records-table",document.createElement("thead"));let a=document.createElement("tr");["文件名","保存路径","更新描述","更新日期"].forEach(e=>{var t=document.createElement("th");t.textContent=e,a.appendChild(t)}),o.appendChild(a),r.appendChild(o);let d=document.createElement("tbody");t.forEach(t=>{var e=document.createElement("tr"),a=document.createElement("td"),a=(a.textContent=t.fields?.Title||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.SubFolder||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.Description||"",e.appendChild(a),document.createElement("td")),t=t.fields?.UpdateTime||"";if(t)try{var i,s,n,r,o,l=new Date(t);isNaN(l.getTime())?a.textContent=t:(i=l.getFullYear(),s=String(l.getMonth()+1).padStart(2,"0"),n=String(l.getDate()).padStart(2,"0"),r=String(l.getHours()).padStart(2,"0"),o=String(l.getMinutes()).padStart(2,"0"),a.textContent=i+`-${s}-${n} ${r}:`+o)}catch(e){a.textContent=t}else a.textContent="";e.appendChild(a),d.appendChild(e)}),s&&(o=document.createElement("tr"),(t=document.createElement("td")).className="vika-more-records",t.colSpan=4,t.textContent=`... 还有 ${e.records.length-5} 条记录（不显示）`,o.appendChild(t),d.appendChild(o)),r.appendChild(d),n.appendChild(r),i.appendChild(n),l.appendChild(i)}});l.addEventListener("click",async e=>{e=e.target;if(e instanceof HTMLElement)if(e.classList.contains("vika-sync-btn")){var i=e.dataset.updateId,i=t.get(i);if(i)if(await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("确认更新");var a=t.contentEl,a=(a.createEl("p",{text:'⚠️ 注意：更新会覆盖原有的仓库文档，必要时请备份"保存路径"对应的文档。',attr:{style:"color: var(--text-error); font-weight: bold; margin-bottom: 1em;"}}),a.createEl("p",{text:"请确认是否继续更新？",attr:{style:"margin-bottom: 1em;"}}),a.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));a.createEl("button",{text:"取消"}).addEventListener("click",()=>{t.close(),e(!1)}),a.createEl("button",{text:"确认更新",cls:"mod-warning"}).addEventListener("click",()=>{t.close(),e(!0)}),t.open()})){let t=e,a=t.textContent;t.disabled=!0,t.textContent="更新中...",t.style.opacity="0.6";try{await this.vikaSyncer.processUpdateIdGroup(i,s.targetPath),t.textContent="✅ 已更新",t.style.background="var(--color-green)",t.style.color="white"}catch(e){t.textContent="❌ 更新失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3)}}}else if(e.classList.contains("vika-ignore-btn")){i=e.dataset.updateId;if(i){let t=e,a=t.textContent;t.disabled=!0,t.textContent="忽略中...",t.style.opacity="0.6";try{await this.vikaSyncer.recordIgnoredUpdateId(i),t.textContent="✅ 已忽略",t.style.background="var(--color-orange)",t.style.color="white"}catch(e){t.textContent="❌ 忽略失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3),new Notice("❌ 忽略失败: "+e.message)}}}})}}groupRecordsByUpdateId(e){var t,a;Date.now();let i=new Map,s=0,n=0,r=this.plugin.settings.vikaSync||{};try{!(r.updateIds&&r.updateIds.length||r.updateTimes&&Object.keys(r.updateTimes).length||r.ignoredUpdateIds&&r.ignoredUpdateIds.length)&&"undefined"!=typeof window&&window.localStorage&&(t=window.localStorage.getItem("obsidian-content-protection-vikaSync"))&&(a=JSON.parse(t),r={updateIds:a.updateIds||[],updateTimes:a.updateTimes||{},ignoredUpdateIds:a.ignoredUpdateIds||[]},this.plugin.settings.vikaSync=r)}catch(e){}r.updateIds;let o=r.updateTimes||{},l=r.ignoredUpdateIds||[];e.forEach((e,t)=>{var a=e.fields?.UpdateId;if(a){if(n++,l.includes(a))return;this.shouldUpdateRecord(a,e.fields?.UpdateTime,o)&&(i.has(a)||i.set(a,{updateId:a,description:e.fields?.Description||"无描述",records:[]}),i.get(a).records.push(e))}++s});Date.now();return i}shouldUpdateRecord(e,t,a){if(!a[e])return!0;if(!t)return!1;try{var i=new Date(t).getTime();return new Date(a[e]).getTime()<i}catch(e){return!0}}async showTableSelector(e){return new Promise(a=>{let i=new Modal(this.app),s=(i.titleEl.setText("选择要同步的数据表"),i.contentEl.createDiv());s.addClass("vika-sync-modal"),e.forEach((e,t)=>{s.createEl("button",{text:e.label,cls:"mod-cta"}).addEventListener("click",()=>{i.close(),a(e.value)})}),s.createEl("button",{text:"取消",cls:"mod-warning"}).addEventListener("click",()=>{i.close(),a(null)}),i.open()})}async showUpdateIdSelector(s,n){return new Promise(e=>{let t=document.createElement("div"),l=(t.className="vika-custom-window",t.innerHTML=`
                <div class="vika-window-header">
                    <h3>模块化OB仓库更新</h3>
                    <p>‼️注意：此窗口仅更新模板、模块等文档(不包含插件)</p>
                    <div class="vika-window-controls">
                        <button class="vika-help-btn" title="使用说明">
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-badge-info-icon lucide-badge-info">
                                <path d="M3.85 8.62a4 4 0 0 1 4.78-4.77 4 4 0 0 1 6.74 0 4 4 0 0 1 4.78 4.78 4 4 0 0 1 0 6.74 4 4 0 0 1-4.77 4.78 4 4 0 0 1-6.75 0 4 4 0 0 1-4.78-4.77 4 4 0 0 1 0-6.76Z"/>
                                <line x1="12" x2="12" y1="16" y2="12"/>
                                <line x1="12" x2="12.01" y1="8" y2="8"/>
                            </svg>
                        </button>
                        <button class="vika-window-close" onclick="this.closest('.vika-custom-window').remove()">×</button>
                    </div>
                </div>
                <div class="vika-window-content">
                    <div class="vika-updateid-list"></div>
                    <div class="vika-window-footer">
                        <button class="vika-cancel-btn">取消</button>
                    </div>
                </div>
            `,document.body.appendChild(t),t.querySelector(".vika-updateid-list"));var a=t.querySelector(".vika-cancel-btn");let c=0;s.forEach((e,t)=>{if(!(20<=c)){c++;var i=document.createElement("div"),s=(i.className="vika-updateid-item",document.createElement("div")),t=(s.className="vika-updateid-header",s.innerHTML=`
                        <div class="vika-header-left">
                            <span class="vika-updateid-id">更新ID：${t}</span>
                            <span class="vika-updateid-count">(${e.records.length} 条记录)</span>
                        </div>
                        <div class="vika-header-buttons">
                            <button class="vika-ignore-btn" data-update-id="${t}">忽略</button>
                            <button class="vika-sync-btn" data-update-id="${t}">更新</button>
                        </div>
                    `,i.appendChild(s),e.records.slice(0,5)),s=5<e.records.length,n=document.createElement("div"),r=(n.className="vika-records-table-container",document.createElement("table")),o=(r.className="vika-records-table",document.createElement("thead"));let a=document.createElement("tr");["文件名","保存路径","更新描述","更新日期"].forEach(e=>{var t=document.createElement("th");t.textContent=e,a.appendChild(t)}),o.appendChild(a),r.appendChild(o);let d=document.createElement("tbody");t.forEach(t=>{var e=document.createElement("tr"),a=document.createElement("td"),a=(a.textContent=t.fields?.Title||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.SubFolder||"",e.appendChild(a),document.createElement("td")),a=(a.textContent=t.fields?.Description||"",e.appendChild(a),document.createElement("td")),t=t.fields?.UpdateTime||"";if(t)try{var i,s,n,r,o,l=new Date(t);isNaN(l.getTime())?a.textContent=t:(i=l.getFullYear(),s=String(l.getMonth()+1).padStart(2,"0"),n=String(l.getDate()).padStart(2,"0"),r=String(l.getHours()).padStart(2,"0"),o=String(l.getMinutes()).padStart(2,"0"),a.textContent=i+`-${s}-${n} ${r}:`+o)}catch(e){a.textContent=t}else a.textContent="";e.appendChild(a),d.appendChild(e)}),s&&(o=document.createElement("tr"),(t=document.createElement("td")).className="vika-more-records",t.colSpan=4,t.textContent=`... 还有 ${e.records.length-5} 条记录（不显示）`,o.appendChild(t),d.appendChild(o)),r.appendChild(d),n.appendChild(r),i.appendChild(n),l.appendChild(i)}});l.addEventListener("click",async e=>{if(e.target.classList.contains("vika-sync-btn")){var i=e.target.dataset.updateId,i=s.get(i);if(i)if(await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("确认更新");var a=t.contentEl,a=(a.createEl("p",{text:'⚠️ 注意：更新会覆盖原有的仓库文档，必要时请备份"保存路径"对应的文档。',attr:{style:"color: var(--text-error); font-weight: bold; margin-bottom: 1em;"}}),a.createEl("p",{text:"请确认是否继续更新？",attr:{style:"margin-bottom: 1em;"}}),a.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));a.createEl("button",{text:"取消"}).addEventListener("click",()=>{t.close(),e(!1)}),a.createEl("button",{text:"确认更新",cls:"mod-warning"}).addEventListener("click",()=>{t.close(),e(!0)}),t.open()})){let t=e.target,a=t.textContent;t.disabled=!0,t.textContent="更新中...",t.style.opacity="0.6";try{await this.vikaSyncer.processUpdateIdGroup(i,n.targetPath),t.textContent="✅ 已更新",t.style.background="var(--color-green)",t.style.color="white"}catch(e){t.textContent="❌ 更新失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3)}}}else if(e.target.classList.contains("vika-ignore-btn")){i=e.target.dataset.updateId;if(i){let t=e.target,a=t.textContent;t.disabled=!0,t.textContent="忽略中...",t.style.opacity="0.6";try{await this.vikaSyncer.recordIgnoredUpdateId(i),t.textContent="✅ 已忽略",t.style.background="var(--color-orange)",t.style.color="white"}catch(e){t.textContent="❌ 忽略失败",t.style.background="var(--color-red)",t.style.color="white",setTimeout(()=>{t.disabled=!1,t.textContent=a,t.style.opacity="1",t.style.background="",t.style.color=""},2e3),new Notice("❌ 忽略失败: "+e.message)}}}}),a.addEventListener("click",()=>{t.remove()}),t.querySelector(".vika-help-btn").addEventListener("click",()=>{new Notice(`📖 使用说明：

• 忽略按钮：点击后，该组更新内容将被忽略（需谨慎选择）
• 更新按钮：点击后，更新内容将保存到你仓库
• 注意养成定期备份的习惯`,8e3)}),t.querySelector(".vika-window-close").addEventListener("click",()=>{t.remove()}),20<s.size&&((a=document.createElement("div")).className="vika-performance-warning",a.innerHTML="<p>⚠️ 数据量较大，仅显示前 20 个更新组</p>",t.querySelector(".vika-window-content").insertBefore(a,l))})}}class AreaCreator{constructor(e){this.plugin=e,this.app=e.app}log(e,t=0){}async createArea(t){if(t){this.log(`正在创建${t}相关配置，请稍候...`);try{await this.createAreaFolders(t),await this.createMoveTemplates(t),await this.updateQuickAddConfig(t),await this.updateTemplaterConfig(t);var e=await this.updateMetaBindConfig(t);await this.updateNoteHeaderModule(e),await this.updateCanvasThemeCardScript(t),await this.updateSelectCanvasThemeCardScript(t),this.log(t+"创建成功！")}catch(e){this.log(`创建${t}时出错: `+e.message)}}else this.log("未输入领域名称，操作已取消")}async createAreaFolders(e){var t;for(t of["Documents/I.P.A.R.A/"+e,`Documents/I.P.A.R.A/${e}/归档`,`Documents/I.P.A.R.A/${e}/收集`,`Documents/I.P.A.R.A/${e}/项目`,`Documents/I.P.A.R.A/${e}/资源`])try{await this.app.vault.createFolder(t)}catch(e){if(!e.message.includes("already exists"))throw e}}async createMoveTemplates(e){var t;for(t of[{name:`移动至-${e}-归档.md`,content:`<% await tp.file.move("Documents/I.P.A.R.A/${e}/归档/" + tp.file.title) %>`},{name:`移动至-${e}-收集.md`,content:`<% await tp.file.move("Documents/I.P.A.R.A/${e}/收集/" + tp.file.title) %>`},{name:`移动至-${e}-项目.md`,content:`<% await tp.file.move("Documents/I.P.A.R.A/${e}/项目/" + tp.file.title) %>`},{name:`移动至-${e}-资源.md`,content:`<% await tp.file.move("Documents/I.P.A.R.A/${e}/资源/" + tp.file.title) %>`}])try{var a=t.content.replace(/\${areaName}/g,e);await this.app.vault.adapter.write("Assistants/Templater/移动/"+t.name,a)}catch(e){throw e}}async updateQuickAddConfig(e){var a,t=".obsidian/plugins/quickadd/data.json",i=await this.app.vault.adapter.read(t),i=JSON.parse(i),s=[{id:"87f09f63-b2d4-41e9-802c-fb7844189ee5",folder:`Documents/I.P.A.R.A/${e}/项目`},{id:"762e745f-c470-46a9-8419-35a1518bcf20",folder:`Documents/I.P.A.R.A/${e}/资源`},{id:"270fac2d-c9aa-4aa0-97b4-0bd95827588e",folder:`Documents/I.P.A.R.A/${e}/归档`},{id:"e823d54a-f542-401d-bebe-d4d44b432266",folder:`Documents/I.P.A.R.A/${e}/收集`}];for(let t of i.choices)t.id&&(a=s.find(e=>e.id===t.id))&&t.folder&&t.folder.folders&&(t.folder.folders.includes(a.folder)||t.folder.folders.push(a.folder));await this.app.vault.adapter.write(t,JSON.stringify(i,null,2))}async updateTemplaterConfig(e){var t,a=".obsidian/plugins/templater-obsidian/data.json",i=await this.app.vault.adapter.read(a),s=JSON.parse(i),i=[`Assistants/Templater/移动/移动至-${e}-归档.md`,`Assistants/Templater/移动/移动至-${e}-收集.md`,`Assistants/Templater/移动/移动至-${e}-项目.md`,`Assistants/Templater/移动/移动至-${e}-资源.md`];s.enabled_templates_hotkeys||(s.enabled_templates_hotkeys=[]);for(t of i)s.enabled_templates_hotkeys.includes(t)||s.enabled_templates_hotkeys.push(t);await this.app.vault.adapter.write(a,JSON.stringify(s,null,2))}async updateMetaBindConfig(e){var t=".obsidian/plugins/obsidian-meta-bind-plugin/data.json",a=await this.app.vault.adapter.read(t),a=JSON.parse(a),i=[this.generateRandomId(),this.generateRandomId(),this.generateRandomId(),this.generateRandomId()],e=[{label:e+"(归档)",icon:"folder-input",hidden:!1,class:"",tooltip:`将当前文档移动至"Documents/I.P.A.R.A/${e}/归档"文件夹`,id:i[0],style:"plain",actions:[{type:"command",command:`templater-obsidian:Assistants/Templater/移动/移动至-${e}-归档.md`},{type:"sleep",ms:50},{type:"command",command:"dataview:dataview-rebuild-current-view"}]},{label:e+"(收集)",icon:"folder-input",hidden:!1,class:"",tooltip:`将当前文档移动至"Documents/I.P.A.R.A/${e}/收集"文件夹`,id:i[1],style:"plain",actions:[{type:"command",command:`templater-obsidian:Assistants/Templater/移动/移动至-${e}-收集.md`},{type:"sleep",ms:50},{type:"command",command:"dataview:dataview-rebuild-current-view"}]},{label:e+"(项目)",icon:"folder-input",hidden:!1,class:"",tooltip:`将当前文档移动至"Documents/I.P.A.R.A/${e}/项目"文件夹`,id:i[2],style:"plain",actions:[{type:"command",command:`templater-obsidian:Assistants/Templater/移动/移动至-${e}-项目.md`},{type:"sleep",ms:50},{type:"command",command:"dataview:dataview-rebuild-current-view"}]},{label:e+"(资源)",icon:"folder-input",hidden:!1,class:"",tooltip:`将当前文档移动至"Documents/I.P.A.R.A/${e}/资源"文件夹`,id:i[3],style:"plain",actions:[{type:"command",command:`templater-obsidian:Assistants/Templater/移动/移动至-${e}-资源.md`},{type:"sleep",ms:50},{type:"command",command:"dataview:dataview-rebuild-current-view"}]}];return a.buttonTemplates||(a.buttonTemplates=[]),a.buttonTemplates=[...a.buttonTemplates,...e],await this.app.vault.adapter.write(t,JSON.stringify(a,null,2)),i}async updateNoteHeaderModule(e){var t="Assistants/Modules/笔记模块/笔记抬头模块.md";let a=await this.app.vault.adapter.read(t);var i=a.match(/```ad-info[\s\S]*?```/);if(!i)throw new Error("未找到ad-info代码块");e=`\`BUTTON[${e.join(",")}]\``,e=i[0].replace(/```$/,e+"\n```");a=a.replace(i[0],e),await this.app.vault.adapter.write(t,a)}async updateCanvasThemeCardScript(e){var t="Assistants/Templater/辅助/JS辅助脚本/create-canvas-theme-card.js";let a=await this.app.vault.adapter.read(t);var i=a.match(/const\s+targetPaths\s*=\s*\[(\s*"[^"]*"\s*,?\s*)*\]/);if(!i)throw new Error("未找到targetPaths数组");var s=i[0].replace(/\]$/,`, ${`"Documents/I.P.A.R.A/${e}/归档/卡片盒笔记主题索引卡"`}]`),n=/const\s+pathChoice\s*=\s*await\s+quickAdd\.quickAddApi\.suggester\(\s*\[(\s*"[^"]*"\s*,?\s*)*\]/,i=(a=a.replace(i[0],s)).match(n);i&&(s=i[0].replace(/\]$/,`, ${`"🔰${e}"`}]`),a=a.replace(i[0],s)),await this.app.vault.adapter.write(t,a)}async updateSelectCanvasThemeCardScript(e){var t="Assistants/Templater/辅助/JS辅助脚本/select-canvas-theme-card.js";let a=await this.app.vault.adapter.read(t);var i,s=a.match(/const\s+pathsToSearch\s*=\s*\[(\s*"[^"]*"\s*,?\s*)*\]/),s=(s&&(i=s[0].replace(/\]$/,`, ${`"Documents/I.P.A.R.A/${e}/归档/卡片盒笔记主题索引卡"`}]`),a=a.replace(s[0],i)),a.match(/(const\s+tags\s*=\s*\{[\s\S]*?)(\s*\};)/));s&&(i=s[1]+`,
      "${e}": "🔰"`+s[2],a=a.replace(s[0],i)),await this.app.vault.adapter.write(t,a)}generateRandomId(){var t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";let a="";for(let e=0;e<4;e++)a+=t.charAt(Math.floor(Math.random()*t.length));return a}}module.exports=ContentProtectionPlugin;