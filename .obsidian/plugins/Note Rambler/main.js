let{Plugin,PluginSettingTab,Setting,Notice}=require("obsidian"),DEFAULT_EXCLUDED_PREFIXES=["使用指南","Assistants","Books","Connections","Extras","Documents/Dailynote"],DEFAULT_SETTINGS={customExcludedPrefixes:[],diceItems:[],randomWeightMode:"off",randomMaxEnabled:!1,randomMaxCount:0,noteTypeWeightEnabled:!1,noteTypeWeights:{empty:3,flash:2,project:1,permanent:0}};class NoteRamblerPlugin extends Plugin{async onload(){this.settings=Object.assign({},DEFAULT_SETTINGS),await this.loadSettings(),this.addCommand({id:"note-rambler-open-random-note",name:"打开随机笔记",callback:()=>{this.openRandomNote()}}),this.addSettingTab(new NoteRamblerSettingTab(this.app,this))}onunload(){}async loadSettings(){var e=await this.loadData();e&&"object"==typeof e&&(Array.isArray(e.customExcludedPrefixes)&&(this.settings.customExcludedPrefixes=e.customExcludedPrefixes),Array.isArray(e.diceItems)&&(this.settings.diceItems=e.diceItems),"string"==typeof e.randomWeightMode&&(this.settings.randomWeightMode=e.randomWeightMode),"boolean"==typeof e.randomMaxEnabled&&(this.settings.randomMaxEnabled=e.randomMaxEnabled),"number"==typeof e.randomMaxCount&&(this.settings.randomMaxCount=e.randomMaxCount),"boolean"==typeof e.noteTypeWeightEnabled&&(this.settings.noteTypeWeightEnabled=e.noteTypeWeightEnabled),e.noteTypeWeights)&&"object"==typeof e.noteTypeWeights&&(e=e.noteTypeWeights,this.settings.noteTypeWeights={empty:("number"==typeof e.empty?e:DEFAULT_SETTINGS.noteTypeWeights).empty,flash:("number"==typeof e.flash?e:DEFAULT_SETTINGS.noteTypeWeights).flash,project:("number"==typeof e.project?e:DEFAULT_SETTINGS.noteTypeWeights).project,permanent:("number"==typeof e.permanent?e:DEFAULT_SETTINGS.noteTypeWeights).permanent})}async saveSettings(){await this.saveData(this.settings)}getAllExcludePrefixes(){var e=(Array.isArray(this.settings.customExcludedPrefixes)?this.settings.customExcludedPrefixes:[]).map(e=>"string"==typeof e?e.trim():"").filter(e=>0<e.length);return DEFAULT_EXCLUDED_PREFIXES.concat(e)}getEligibleFiles(){var n=this.app.vault.getMarkdownFiles(),a=this.getAllExcludePrefixes();if(!n||0===n.length)return[];var s=[];for(let e=0;e<n.length;e++){var i=n[e],o=i.path||"";let t=!1;for(let e=0;e<a.length;e++){var r=a[e];if(r){if(o.startsWith(r+"/")){t=!0;break}if(o===r){t=!0;break}if(o.startsWith(r+".")){t=!0;break}}}t||s.push(i)}return s}async openRandomNote(){var e=this.getEligibleFiles();if(e&&0!==e.length){e=this.pickRandomFileWithWeights(e);if(e){try{await this.incrementRandomFrontmatter(e)}catch(e){}await this.app.workspace.getLeaf(!1).openFile(e),await this.openLocalGraphForFile(e)}else new Notice("没有可用的随机笔记")}else new Notice("没有可用的随机笔记")}pickRandomFileWithWeights(t){var e=this.app,s=e&&e.metadataCache,i=this.settings||{},o=!!i.randomMaxEnabled,r="number"==typeof i.randomMaxCount?i.randomMaxCount:0,l="string"==typeof i.randomWeightMode?i.randomWeightMode:"off",g=[],p=[];for(let e=0;e<t.length;e++){var h,d=t[e];if(d){let n=0,a="";if(s&&"function"==typeof s.getFileCache&&(h=s.getFileCache(d))&&h.frontmatter&&((h=h.frontmatter).hasOwnProperty("random")&&("number"==typeof(m=h.random)?n=m:"string"==typeof m&&(m=parseInt(m,10),isNaN(m)||(n=m))),"string"==typeof h["笔记类型"])&&(a=h["笔记类型"].trim()),!(o&&0<r&&n>=r)){let e=1,t=("preferLow"===l?e=1/(1+n):"preferHigh"===l&&(e=1+n),(!isFinite(e)||e<=0)&&(e=1),1);if(i.noteTypeWeightEnabled&&i.noteTypeWeights){let e="empty";var m=i.noteTypeWeights[e=a?"闪念笔记"===a?"flash":"项目笔记"===a?"project":"永久笔记"===a?"permanent":"empty":"empty"];"number"==typeof m&&(t=m)}!isFinite(t)||t<=0||(e*=t,g.push(d),p.push(e))}}}if(0===g.length)return null;if(1===g.length)return g[0];let n=0;for(let e=0;e<p.length;e++)n+=p[e];if(!(0<n))return g[Math.floor(Math.random()*g.length)];let a=Math.random()*n;for(let e=0;e<g.length;e++)if((a-=p[e])<=0)return g[e];return g[g.length-1]}async incrementRandomFrontmatter(e){var t=this.app.fileManager;if(t&&"function"==typeof t.processFrontMatter)try{await t.processFrontMatter(e,e=>{var t;e&&"object"==typeof e&&("number"==typeof(t=e.random)?e.random=t+1:"string"!=typeof t||(t=parseInt(t,10),isNaN(t))?e.random=1:e.random=t+1)})}catch(e){}}async openLocalGraphForFile(e){var t=this.app.workspace,n="function"==typeof t.getLeavesOfType?t.getLeavesOfType("localgraph"):[];let a=void 0;(a=n&&0<n.length?n[n.length-1]:(a="function"==typeof t.getRightLeaf?t.getRightLeaf(!1):a)||t.getLeaf(!0))&&(await a.setViewState({type:"localgraph",state:{file:e.path}}),"function"==typeof t.revealLeaf)&&t.revealLeaf(a)}}class NoteRamblerSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var e=this.containerEl;e.empty(),e.createEl("h3",{text:"路径过滤"}).style.marginTop="0";e.createEl("p").setText("通过路径排除不希望参与随机抽取的文件夹。默认已经排除：使用指南、Assistants、Books、Connections、Extras、Documents/Dailynote。");new Setting(e).setName("自定义排除路径前缀").setDesc("每行一个路径。例如：Documents/Douban(注：排除豆瓣影视）").addTextArea(e=>{var t=Array.isArray(this.plugin.settings.customExcludedPrefixes)?this.plugin.settings.customExcludedPrefixes.join("\n"):"";e.setPlaceholder("例如:\n使用指南\nAssistants\nBooks"),e.setValue(t),e.onChange(async e=>{e=e.split("\n").map(e=>e.trim()).filter(e=>0<e.length);this.plugin.settings.customExcludedPrefixes=e,await this.plugin.saveSettings()})}),e.createEl("h3",{text:"笔记类型权重"}),e.createEl("p").setText("根据 frontmatter 中的“笔记类型”字段（空值/闪念笔记/项目笔记/永久笔记）调整不同类型被随机抽取的概率。");let t,n=(new Setting(e).setName("启用笔记类型权重").setDesc("开启后，将应用下方各类型的权重设置。").addToggle(e=>{e.setValue(!!this.plugin.settings.noteTypeWeightEnabled).onChange(async e=>{this.plugin.settings.noteTypeWeightEnabled=e,await this.plugin.saveSettings(),t&&(t.style.display=e?"":"none")})}),t=e.createDiv(),this.plugin.settings.noteTypeWeights||{});new Setting(t).setName("类型权重：空值").setDesc("frontmatter 中没有“笔记类型”字段或为空时使用的权重。数值越大，被抽到的概率越高。").addText(e=>{var t=n.empty;e.setPlaceholder("例如：3").setValue("number"==typeof t&&isFinite(t)?String(t):String(DEFAULT_SETTINGS.noteTypeWeights.empty)).onChange(async e=>{e=parseFloat(e);isNaN(e)||(this.plugin.settings.noteTypeWeights.empty=e),await this.plugin.saveSettings()})}),new Setting(t).setName("类型权重：闪念笔记").setDesc("当“笔记类型”为“闪念笔记”时使用的权重。").addText(e=>{var t=n.flash;e.setPlaceholder("例如：2").setValue("number"==typeof t&&isFinite(t)?String(t):String(DEFAULT_SETTINGS.noteTypeWeights.flash)).onChange(async e=>{e=parseFloat(e);isNaN(e)||(this.plugin.settings.noteTypeWeights.flash=e),await this.plugin.saveSettings()})}),new Setting(t).setName("类型权重：项目笔记").setDesc("当“笔记类型”为“项目笔记”时使用的权重。").addText(e=>{var t=n.project;e.setPlaceholder("例如：1").setValue("number"==typeof t&&isFinite(t)?String(t):String(DEFAULT_SETTINGS.noteTypeWeights.project)).onChange(async e=>{e=parseFloat(e);isNaN(e)||(this.plugin.settings.noteTypeWeights.project=e),await this.plugin.saveSettings()})}),new Setting(t).setName("类型权重：永久笔记").setDesc("当“笔记类型”为“永久笔记”时使用的权重。默认 0 表示永不被随机抽取。").addText(e=>{var t=n.permanent;e.setPlaceholder("例如：0").setValue("number"==typeof t&&isFinite(t)?String(t):String(DEFAULT_SETTINGS.noteTypeWeights.permanent)).onChange(async e=>{e=parseFloat(e);isNaN(e)||(this.plugin.settings.noteTypeWeights.permanent=e),await this.plugin.saveSettings()})});var a=t.createEl("p");a.setText("权重计算说明：总权重 = random 权重 × 类型权重。首先根据“随机优先级（基于 random）”得到 random 权重，然后再乘以上面的“笔记类型权重”，最终作为每篇笔记被抽到的相对概率；同时，如果启用了“抽取次数上限过滤”，则 random 超过上限的笔记会被直接排除，类型权重为 0（例如默认的“永久笔记”）的笔记也不会被随机抽取。"),a.style.color="var(--color-accent)",t&&(t.style.display=this.plugin.settings.noteTypeWeightEnabled?"":"none"),e.createEl("h3",{text:"随机策略与上限"}),e.createEl("p").setText("控制是否优先抽取少读/多读的笔记，并为随机抽取设置一个最大次数上限。超出上限的笔记将暂时退出随机池。"),new Setting(e).setName("随机优先级（基于 random）").setDesc("关闭：完全随机；优先少读：更偏向 random 次数少的笔记；优先多读：更偏向 random 次数多的笔记。").addDropdown(e=>{var t=this.plugin.settings.randomWeightMode||"off";e.addOption("off","关闭（完全随机）").addOption("preferLow","优先少读（random 较小）").addOption("preferHigh","优先多读（random 较大）").setValue(t).onChange(async e=>{this.plugin.settings.randomWeightMode=e,await this.plugin.saveSettings()})}),new Setting(e).setName("启用抽取次数上限过滤").setDesc("开启后，当某篇笔记的 random 达到下方设置的上限值时，将不再参与随机抽取。").addToggle(e=>{e.setValue(!!this.plugin.settings.randomMaxEnabled).onChange(async e=>{this.plugin.settings.randomMaxEnabled=e,await this.plugin.saveSettings(),s.style.display=e?"":"none"})});let s=e.createDiv();new Setting(s).setName("抽取次数上限（random 最大值）").setDesc("仅在上方过滤开关开启时生效。超过该 random 次数的笔记将被排除。建议设置为一个相对较大的正整数，例如 10 或 20。").addText(e=>{var t=this.plugin.settings.randomMaxCount;e.setPlaceholder("例如：10").setValue("number"==typeof t&&0<t?String(t):"").onChange(async e=>{e=parseInt(e,10);!isNaN(e)&&0<e?this.plugin.settings.randomMaxCount=e:this.plugin.settings.randomMaxCount=0,await this.plugin.saveSettings()})}),s.style.display=this.plugin.settings.randomMaxEnabled?"":"none"}}module.exports=NoteRamblerPlugin;