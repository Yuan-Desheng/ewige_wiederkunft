let{Plugin,Notice,TFile,PluginSettingTab,Setting,Modal,MarkdownView}=require("obsidian"),HIGHLIGHT_LAYER_CLASS="pdf-highlights-layer",_0x4d2f=(()=>{let t=["Y29udGVudC1wcm90ZWN0aW9u","aXNBY3RpdmF0ZWQ=","ZGV2aWNlSWQ=","aGFzQmVlbkFjdGl2YXRlZA==","b2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u","ZW5hYmxlZFBsdWdpbnM=","cGx1Z2lucw==","c2V0dGluZ3M=","ZGF0YS5qc29u","dmFsaWRhdGlvbg==","aW50ZWdyaXR5","c2VjdXJpdHk=","YWN0aXZhdGVk","ZGVidWdNb2Rl","YnlwYXNzVmFsaWRhdGlvbg==","Y3JhY2tNb2Rl","Y29uc29sZQ==","bG9n","YXBw","dmF1bHQ=","YWRhcHRlcg==","cmVhZA==","cGFyc2U=","SlNPTg=="];return function(e){try{return atob(t[e]||"")}catch(e){return""}}})(),_0x9e4c=(()=>{let t=["bm9pdGNldG9ycC10bmV0bm9j","ZGV0YXZpdGNhc2k=","ZGllaXZlZA==","ZGV0YXZpdGNhbmVlYnNhaA=="];return function(e){try{return atob(t[e]||"").split("").reverse().join("")}catch(e){return""}}})(),_0x7f9e=(()=>{try{var e=(new Date).toDateString()+(navigator.userAgent||"").slice(-5),t="undefined"!=typeof screen&&screen.width?screen.width:1024,a="undefined"!=typeof window&&window.location?window.location.protocol:"https:";return btoa(e+a+t).slice(0,16)}catch(e){return btoa("fallback_key_ipad_compatible").slice(0,16)}})(),_0x6a8b=function(e){return e.split("").map(e=>String.fromCharCode(90^e.charCodeAt(0))).join("")},_obf={cp:_0x4d2f(0),ia:_0x4d2f(1),di:_0x4d2f(2),hba:_0x4d2f(3),ocp:_0x4d2f(4),ep:_0x4d2f(5),p:_0x4d2f(6),s:_0x4d2f(7),dj:_0x4d2f(8),v:_0x4d2f(9),i:_0x4d2f(10),sec:_0x4d2f(11),act:_0x4d2f(12),dm:_0x4d2f(13),bv:_0x4d2f(14),cm:_0x4d2f(15),con:_0x4d2f(16),l:_0x4d2f(17),a:_0x4d2f(18),vt:_0x4d2f(19),ad:_0x4d2f(20),r:_0x4d2f(21),pa:_0x4d2f(22),js:_0x4d2f(23),cp2:_0x9e4c(0),ia2:_0x9e4c(1),di2:_0x9e4c(2),hba2:_0x9e4c(3)},_0xStr={get:function(e){return{plugin_id:""+_obf.ocp,activation_key:""+_obf.ia,device_key:""+_obf.di,activation_status:""+_obf.hba,plugin_manager:""+_obf.ep,config_file:`.obsidian/plugins/${_obf.ocp}/`+_obf.dj,security_check:_obf.sec+"_"+_obf.v,integrity_hash:_obf.i+"_hash",full_plugin_id:""+_obf.ocp,settings_key:""+_obf.s,app_key:""+_obf.a,vault_key:""+_obf.vt,adapter_key:""+_obf.ad,read_key:""+_obf.r,parse_key:""+_obf.pa,json_key:""+_obf.js}[e]||e},verify:function(e){return!(!e||"string"!=typeof e)&&0<e.length&&!e.includes("undefined")},decode:function(encoded){try{return encoded.includes("_0x")?eval(encoded):atob(encoded)}catch(e){return encoded}}},_0xSec={checkDebug:function(){return![_obf.dm,_obf.bv,_obf.cm].some(e=>window[e])},checkConsole:function(){let t=0,a=window[_obf.con][_obf.l];return window[_obf.con][_obf.l]=function(...e){return t++,a.apply(this,e)},t<10},generateHash:function(){var e=_0x7f9e+Date.now()+Math.random();return btoa(e).slice(0,32)}},DEFAULT_SETTINGS=((()=>{if(!(()=>{try{var e=navigator.userAgent||"",t=navigator.platform||"";return/iPad|iPhone|iPod|Android|Mobile|Tablet/i.test(e)||/iPad|iPhone|iPod/i.test(t)||0<navigator.maxTouchPoints&&/Mac/i.test(t)||"undefined"!=typeof window&&"ontouchstart"in window&&/Mac/i.test(t)||navigator.vendor&&-1<navigator.vendor.indexOf("Apple")&&0<navigator.maxTouchPoints&&!window.MSStream}catch(e){return!1}})()){let t=0,a=Date.now();setInterval(()=>{(160<window.outerHeight-window.innerHeight||160<window.outerWidth-window.innerWidth)&&3<++t&&(window[_obf.dm]=!0);var e=Date.now();5e3<e-a&&t++,a=e,50<t&&(t=0)},1e3);try{Object.defineProperty(console,"clear",{value:function(){t+=5},writable:!1,configurable:!1})}catch(e){}}})(),{enableObjectStorage:!1,storageProvider:"tencent",storagePath:"screenshot/",tencent:{endpoint:"",region:"",bucket:"",accessKeyId:"",secretAccessKey:""},aliyun:{endpoint:"",region:"",bucket:"",accessKeyId:"",secretAccessKey:""}});module.exports=class PdfFlowPlugin extends Plugin{constructor(e,t){super(e,t),this.isPluginActivated=!1,this.statusCheckInterval=null,this._bindingIntegrity=_0xSec.generateHash(),this._lastValidation=Date.now(),this._validationCounter=0,this._maxValidations=1e3+Math.floor(500*Math.random()),this._securityKeys={pluginId:_0xStr.get("plugin_id"),activationKey:_0xStr.get("activation_key"),deviceKey:_0xStr.get("device_key"),activationStatus:_0xStr.get("activation_status")}}async onload(){if(this.isMobileDevice())this.isPluginActivated=!0,await this.initializePluginFeatures();else try{await this._performInitialSecurityChecks()?await this._enhancedContentProtectionCheck()?(this.isPluginActivated=!0,this._startContinuousValidation(),this._setupPluginStateMonitor(),await this.initializePluginFeatures()):(this.isPluginActivated=!1,this._setupPluginStateMonitor(),this.showActivationRequired()):this._triggerSecurityFailure()}catch(e){this.isPluginActivated=!0,await this.initializePluginFeatures()}}async initializePluginFeatures(){await this.loadSettings(),this.addSettingTab(new PdfFlowSettingTab(this.app,this)),this.dragDataStorage=new Map,this.isDraggingPdf=!1,this.isSelectingRect=!1,this.rectSelectionData=null,this.rectModeTimer=null,this.escKeyHandler=null,this.lastDragData=null,this.isCreatingCanvasNode=!1,this.pdfContainerStates=new Map,this.containerIdCounter=0,this.eventListeners=[],this.timerManager={timeouts:new Set,intervals:new Set,addTimeout:(e,t,...a)=>{let i=setTimeout(()=>{this.timerManager.timeouts.delete(i),e(...a)},t);return this.timerManager.timeouts.add(i),i},addInterval:(e,t,...a)=>{e=setInterval(e,t,...a);return this.timerManager.intervals.add(e),e},clearTimeout:e=>{e&&this.timerManager.timeouts.has(e)&&(clearTimeout(e),this.timerManager.timeouts.delete(e))},clearInterval:e=>{e&&this.timerManager.intervals.has(e)&&(clearInterval(e),this.timerManager.intervals.delete(e))},clearAll:()=>{this.timerManager.timeouts.forEach(e=>{clearTimeout(e)}),this.timerManager.timeouts.clear(),this.timerManager.intervals.forEach(e=>{clearInterval(e)}),this.timerManager.intervals.clear()}},this.domManager={dragPreviews:new Set,highlightElements:new Set,tempElements:new Set,addDragPreview:e=>(this.domManager.dragPreviews.add(e),e),addHighlightElement:e=>(this.domManager.highlightElements.add(e),e),addTempElement:e=>(this.domManager.tempElements.add(e),e),removeDragPreview:e=>{e&&this.domManager.dragPreviews.has(e)&&(this.domManager.dragPreviews.delete(e),e.parentNode)&&e.parentNode.removeChild(e)},removeHighlightElement:e=>{e&&this.domManager.highlightElements.has(e)&&(this.domManager.highlightElements.delete(e),e.parentNode)&&e.parentNode.removeChild(e)},removeTempElement:e=>{e&&this.domManager.tempElements.has(e)&&"true"!==e.getAttribute("data-pdfflow-persistent")&&(this.domManager.tempElements.delete(e),e.parentNode)&&e.parentNode.removeChild(e)},clearAll:()=>{this.domManager.dragPreviews.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.domManager.dragPreviews.clear(),this.domManager.highlightElements.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.domManager.highlightElements.clear(),this.domManager.tempElements.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.domManager.tempElements.clear()}},this.activeTimers=new Set,this.originalSetTimeout=window.setTimeout,this.originalSetInterval=window.setInterval,this.initDragAndDrop(),this.pdfViewObservers=new Map,this.highlightIndex=new Map,this.fileModificationTimes=new Map,this.docTypeCache=new Map,this.docTypeCacheTimeout=3e5,this.docTypeCalculationTimeout=null,this.pendingDocTypeCalculations=new Set,this.excalidrawFileCache=new Map,this.canvasFileCache=new Map,this.markdownFileCache=new Map,this.fileSearchCacheTimeout=12e4,this.canvasCache=new Map,this.isIndexing=!1,this.indexingQueue=[],await this.loadHighlights(),await this.buildHighlightIndex(),this.app.workspace.onLayoutReady(async()=>{await this.scanAllMarkdownFiles(),this.updateHighlights()});let t;this.registerEvent(this.app.vault.on("modify",e=>{e instanceof TFile&&"md"===e.extension&&(t&&clearTimeout(t),t=setTimeout(()=>{this.updateIndexForFile(e),this.clearDocTypeCacheForFile(e.path)},100)),e instanceof TFile&&"canvas"===e.extension&&(this.handleCanvasFileModification(e),this.clearDocTypeCacheForFile(e.path)),e instanceof TFile&&e.name.endsWith(".excalidraw.md")&&this.clearDocTypeCacheForFile(e.path)})),this.registerEvent(this.app.vault.on("delete",e=>{e instanceof TFile&&"md"===e.extension&&(this.removeFileFromIndex(e.path),this.clearDocTypeCacheForFile(e.path)),e instanceof TFile&&("canvas"===e.extension||e.name.endsWith(".excalidraw.md"))&&this.clearDocTypeCacheForFile(e.path)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{this.addPdfToolbarButton()})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.addPdfToolbarButton()}));let a;this.registerEvent(this.app.workspace.on("file-open",e=>{e&&"pdf"===e.extension&&(a&&clearTimeout(a),a=setTimeout(()=>{let t=this.app.workspace.getLeaf();t&&t.view&&t.view.file&&t.view.file.path===e.path&&this.waitForPdfReady(t.view).then(()=>{this.drawHighlightsForPdfView(t.view)}).catch(e=>{setTimeout(()=>{this.drawHighlightsForPdfView(t.view)},2e3)})},1e3))})),this.addHighlightStyle(),this.addCommand({id:"toggle-rect-selection",name:"ÂàáÊç¢ÊãÜÂàáÊ®°Âºè",callback:()=>{this.checkPluginActivation()&&this.toggleRectSelectionMode()}}),this.addCommand({id:"rebuild-highlight-index",name:"ÈáçÂª∫È´ò‰∫ÆÁ¥¢Âºï",callback:async()=>{this.checkPluginActivation()&&(await this.buildHighlightIndex(),this.updateHighlights())}}),this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},3e5),this.addCommand({id:"show-index-stats",name:"ÊòæÁ§∫Á¥¢ÂºïÁªüËÆ°",callback:()=>{var e;this.checkPluginActivation()&&(e=this.getIndexStats(),new Notice(`Á¥¢ÂºïÁªüËÆ°:
`+`PDFÊñá‰ª∂: ${e.totalPdfs}
`+`È´ò‰∫ÆÊÄªÊï∞: ${e.totalHighlights}
`+`Â∑≤Á¥¢ÂºïÊñá‰ª∂: ${e.indexedFiles}
`+"Ê≠£Âú®Á¥¢Âºï: "+(e.isIndexing?"ÊòØ":"Âê¶")))}}),this.addCommand({id:"force-refresh-highlights",name:"Âº∫Âà∂Âà∑Êñ∞ÊâÄÊúâÈ´ò‰∫ÆÔºàËß£ÂÜ≥È´ò‰∫ÆÊ∂àÂ§±ÈóÆÈ¢òÔºâ",callback:()=>{this.checkPluginActivation()&&this.app.workspace.getLeavesOfType("pdf").forEach(e=>{e.view&&e.view.containerEl&&(this.clearHighlightsFromView(e.view.containerEl),setTimeout(()=>{this.drawHighlightsForPdfView(e.view)},100))})}}),this.lastClickInfo={time:0,id:null},this.highlightRegistry=new Map,this.highlightPointerEventsEnabled=!1,this.registerHighlightInteractionKeys(),this.setupCanvasPdfLinkListeners()}onunload(){this._clearSecurityState(),this.pdfContainerStates&&(Object.keys(this.pdfContainerStates).forEach(e=>{e=this.pdfContainerStates[e];e&&e.element&&this.cleanupContainerEventListeners(e.element)}),this.clearAllContainerStates()),this.removeDragListeners(),document.querySelectorAll(".pdfflow-custom-drag-preview, .pdfflow-drag-preview").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.dragDataStorage&&this.dragDataStorage.clear(),this.highlightIndex&&this.highlightIndex.clear(),this.fileModificationTimes&&this.fileModificationTimes.clear(),this.docTypeCache&&this.docTypeCache.clear(),this.excalidrawFileCache&&this.excalidrawFileCache.clear(),this.canvasFileCache&&this.canvasFileCache.clear(),this.markdownFileCache&&this.markdownFileCache.clear(),this.canvasCache&&this.canvasCache.clear(),this.captureCache&&this.captureCache.clear(),this.rectDebounceMap&&this.rectDebounceMap.clear(),this.cleanupRectSelection(),this.timerManager&&this.timerManager.clearAll(),this.domManager&&this.domManager.clearAll(),this.cleanupCanvasDeleteListeners();this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),["rectModeTimer","buttonCreateTimeout","setupTextDragTimeout","saveTimeout","_diagnosticUpdateTimeout","modifyTimeout"].forEach(e=>{this[e]&&(clearTimeout(this[e]),this[e]=null)}),this.escKeyHandler&&(document.removeEventListener("keydown",this.escKeyHandler,!0),this.escKeyHandler=null),this.selectionChangeHandler&&(document.removeEventListener("selectionchange",this.selectionChangeHandler),this.selectionChangeHandler=null),this.pdfViewObservers&&(this.pdfViewObservers.forEach(e=>{try{if(e.disconnect&&e.disconnect(),e.pageRenderedHandler&&e.eventBus)try{e.eventBus.off("pagerendered",e.pageRenderedHandler)}catch(e){}}catch(e){}}),this.pdfViewObservers.clear()),this.cleanupDropdownEventListeners(),this.cleanupCanvasPdfLinkListeners(),document.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS).forEach(e=>{this.domManager.removeHighlightElement(e)}),document.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS+"-container").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),document.querySelectorAll(".pdfflow-floating-button").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-drag-assist-button").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-highlight-dropdown").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-doc-type-dropdown").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-color-selector").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-last-highlight-btn").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-new-doc-btn").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-highlight-selector-container").forEach(e=>e.remove()),document.querySelectorAll(".pdfflow-context-menu").forEach(e=>e.remove()),this.hideContextMenu(),this.removeHighlightStyle()}toggleRectSelectionMode(){this.rectModeTimer&&(this.timerManager.clearTimeout(this.rectModeTimer),this.rectModeTimer=null),this.isSelectingRect=!this.isSelectingRect,this.isSelectingRect?(document.body.classList.add("pdfflow-rect-selection-mode"),this.escKeyHandler=e=>{"Escape"===e.key&&this.isSelectingRect&&(e.preventDefault(),e.stopPropagation(),this.cancelRectSelection())},document.addEventListener("keydown",this.escKeyHandler,!0),this.startRectangleSelection(),this.settings&&this.settings.enableObjectStorage?this.rectModeTimer=this.timerManager.addTimeout(()=>{this.isSelectingRect&&this.cancelRectSelection(),this.rectModeTimer=null},3e4):this.rectModeTimer=this.timerManager.addTimeout(()=>{this.isSelectingRect&&this.cancelRectSelection(),this.rectModeTimer=null},5e3)):(document.body.classList.remove("pdfflow-rect-selection-mode"),this.stopRectangleSelection(),this.cleanupRectSelection()),this.updateAllFloatingButtons()}updateAllFloatingButtons(){document.querySelectorAll(".pdfflow-floating-button").forEach(e=>{this.updateFloatingButtonState(e)})}cancelRectSelection(){var e;this.isSelectingRect&&(this.rectModeTimer&&(this.timerManager.clearTimeout(this.rectModeTimer),this.rectModeTimer=null),this.isSelectingRect=!1,document.body.classList.remove("pdfflow-rect-selection-mode"),document.querySelectorAll('.workspace-leaf-content[data-type="pdf"], .pdf-container, .pdf-viewer').forEach(e=>{e.style.cursor="default",e.classList.remove("pdfflow-rect-selection-mode"),e.querySelectorAll(".page, .textLayer, .annotationLayer").forEach(e=>{e.style.cursor="default"})}),document.querySelectorAll(".pdfflow-rect-selection-mode").forEach(e=>{e.classList.remove("pdfflow-rect-selection-mode"),e.style.cursor="default"}),document.body.style.cursor="default",(e=document.querySelector(".pdfflow-rect-selector-overlay"))&&e.remove(),this.stopRectangleSelection(),this.cleanupRectSelection(),this.updateAllFloatingButtons())}cleanupRectSelection(){document.querySelectorAll(".pdfflow-rect-overlay").forEach(e=>{e._cleanup&&"function"==typeof e._cleanup&&e._cleanup(),e.parentNode&&e.parentNode.removeChild(e)}),document.querySelectorAll(".pdfflow-rect-assist-button").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)}),this.rectSelectionData=null,this.escKeyHandler&&(document.removeEventListener("keydown",this.escKeyHandler,!0),this.escKeyHandler=null)}startRectangleSelection(){var e,t=this.findActivePDFContainer();!t||(e=t.getBoundingClientRect()).width<100||e.height<100||t.hasAttribute("data-pdfflow-rect-selector-active")||("static"===getComputedStyle(t).position&&(t.style.position="relative"),this.setupPDFRectSelector(t),t.setAttribute("data-pdfflow-rect-selector-active","true"))}stopRectangleSelection(){var e=this.findActivePDFContainer();e&&e.hasAttribute("data-pdfflow-rect-selector-active")&&this.removePDFRectSelector(e)}findActivePDFContainer(){var e;for(e of document.querySelectorAll('.pdf-viewer, .pdf-container, [data-type="pdf"]'))if(!e.className.includes("workspace-tab-header")&&null!==e.offsetParent&&0<e.getBoundingClientRect().width)return e;var t,a;for(t of['.workspace-leaf-content[data-type="pdf"]',".pdf-container",".pdf-viewer",'iframe[src*=".pdf"]','embed[src*=".pdf"]'])for(a of document.querySelectorAll(t)){var i=a.getBoundingClientRect();if(100<i.width&&100<i.height)return a}return null}setupPDFRectSelector(d){let h=!1,p=0,u=0,g=null,f=null,n=null,m=null,v=null,w=document.createElement("div"),a=(w.className="pdfflow-rect-selector-overlay",w.id="pdfflow-rect-selector-overlay-"+Date.now(),w.style.cssText=`
            position: fixed;
            z-index: 9999;
            pointer-events: auto;
            cursor: crosshair;
            background-color: transparent;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        `,null),t=()=>{a&&window.cancelAnimationFrame(a),a=window.requestAnimationFrame(()=>{var e=d.getBoundingClientRect(),t=w.style;t.left=e.left+"px",t.top=e.top+"px",t.width=e.width+"px",t.height=e.height+"px",n=w.getBoundingClientRect(),a=null})},i=(document.body.appendChild(w),t(),0);var e=()=>{var e=performance.now();16<e-i&&(i=e,t())};window.addEventListener("resize",e,{passive:!0}),window.addEventListener("scroll",e,{passive:!0});let r=()=>{var e,t,a,i,r;h&&g&&v&&(m=null,a=v.clientX,i=v.clientY,e=Math.abs(a-p),t=Math.abs(i-u),a=Math.min(p,a),i=Math.min(u,i),a=a-n.left,i=i-n.top,(r=g.style).transform=`translate(${a}px, ${i}px)`,r.width=e+"px",r.height=t+"px",f)&&(5<e||5<t)&&(f.style.transform=`translate(${10+a}px, ${i-30}px)`,f.textContent=`${0|e} x `+(0|t))},o=e=>{var t;0===e.button&&(e.preventDefault(),e.stopPropagation(),h=!0,p=e.clientX,u=e.clientY,n=w.getBoundingClientRect(),(g=document.createElement("div")).className="pdfflow-rect-selector-selection",(e=g.style).position="absolute",e.border="2px dashed #007acc",e.backgroundColor="rgba(0, 122, 204, 0.1)",e.pointerEvents="none",e.zIndex="10000",e.top="0",e.left="0",e.transformOrigin="top left",(f=document.createElement("div")).className="pdfflow-rect-selector-info",(e=f.style).position="absolute",e.backgroundColor="#333",e.color="white",e.padding="4px 8px",e.borderRadius="4px",e.fontSize="12px",e.pointerEvents="none",e.whiteSpace="nowrap",e.zIndex="10001",e.top="0",e.left="0",e.transformOrigin="top left",f.textContent="0 x 0",w.appendChild(g),w.appendChild(f),e=p-n.left,t=u-n.top,g.style.transform=`translate(${e}px, ${t}px)`,f.style.transform=`translate(${10+e}px, ${t-30}px)`)},s=0,l=e=>{var t;h&&g&&((t=performance.now())-s<33||(s=t,e.preventDefault(),v=e,m=m||requestAnimationFrame(r)))},c=t=>{if(h){if(t.preventDefault(),h=!1,m&&(cancelAnimationFrame(m),m=null),g){var a,i=d.getBoundingClientRect(),r=p-i.left,n=u-i.top,o=t.clientX-i.left,s=t.clientY-i.top,l=Math.min(r,o),c=Math.min(n,s),o=Math.abs(o-r),r=Math.abs(s-n);if(10<o&&10<r){let e=null;for(a of this.app.workspace.getLeavesOfType("pdf"))if(a.view&&a.view.containerEl===d){e=a.view;break}e&&((s=document.createElement("div")).className="pdfflow-rect-overlay pdfflow-rect-overlay-fixed",(n=s.style).position="fixed",n.border="2px dashed #007acc",n.backgroundColor="rgba(0, 122, 204, 0.1)",n.zIndex="1000",n.transition="transform 0.1s ease",n.pointerEvents="auto",n.cursor="grab",n.width=o+"px",n.height=r+"px",n.left=i.left+l+"px",n.top=i.top+c+"px",n.boxSizing="border-box",document.body.appendChild(s),this.domManager.addTempElement(s),s.draggable=!0,s.classList.add("draggable"),this.handleRectSelectionEnd(t,p,u,s,d,e))}}g&&(g.remove(),g=null),f&&(f.remove(),f=null),v&&(o=Math.abs(v.clientX-p),r=Math.abs(v.clientY-u),10<o)&&10<r&&(w.style.cursor="default",setTimeout(()=>{this.stopRectangleSelection()},100)),v=null}},y=(w.addEventListener("mousedown",o),w.addEventListener("mousemove",l),w.addEventListener("mouseup",c),!1);var x=e=>{var t;1===e.touches.length&&(t=e.touches[0],y=!0,t={button:0,clientX:t.clientX,clientY:t.clientY,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()},o(t),e.preventDefault())},b=e=>{var t;y&&1===e.touches.length&&(t={clientX:(t=e.touches[0]).clientX,clientY:t.clientY,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()},l(t),e.preventDefault())},C=e=>{var t;y&&(y=!1,t=e.changedTouches&&e.changedTouches[0]||e.touches&&e.touches[0])&&(t={clientX:t.clientX,clientY:t.clientY,preventDefault:()=>e.preventDefault(),stopPropagation:()=>e.stopPropagation()},c(t),e.preventDefault())};w.addEventListener("touchstart",x,{passive:!1}),w.addEventListener("touchmove",b,{passive:!1}),w.addEventListener("touchend",C,{passive:!1}),w.addEventListener("selectstart",e=>e.preventDefault()),w.addEventListener("dragstart",e=>e.preventDefault()),w.addEventListener("contextmenu",e=>e.preventDefault()),w.addEventListener("dblclick",e=>e.preventDefault()),w.addEventListener("wheel",e=>{},{passive:!0}),d._pdfflowRectSelectorOverlay=w,d._pdfflowRectSelectorHandleResize=e,d._pdfflowRectSelectorEvents={mousedown:o,mousemove:l,mouseup:c,touchstart:x,touchmove:b,touchend:C}}removePDFRectSelector(e){var t,a;e._pdfflowRectSelectorOverlay&&((t=e._pdfflowRectSelectorOverlay)._animationFrameId&&(cancelAnimationFrame(t._animationFrameId),t._animationFrameId=null),t._resizeTimeout&&(cancelAnimationFrame(t._resizeTimeout),t._resizeTimeout=null),e._pdfflowRectSelectorEvents&&(a=e._pdfflowRectSelectorEvents,t.removeEventListener("mousedown",a.mousedown),t.removeEventListener("mousemove",a.mousemove),t.removeEventListener("mouseup",a.mouseup),t.removeEventListener("touchstart",a.touchstart),t.removeEventListener("touchmove",a.touchmove),t.removeEventListener("touchend",a.touchend),e._pdfflowRectSelectorEvents=null),t.remove(),e._pdfflowRectSelectorOverlay=null,e._pdfflowRectSelectorHandleResize&&(window.removeEventListener("resize",e._pdfflowRectSelectorHandleResize),window.removeEventListener("scroll",e._pdfflowRectSelectorHandleResize),e._pdfflowRectSelectorHandleResize=null),e.removeAttribute("data-pdfflow-rect-selector-active"))}initDragAndDrop(){this.registerEvent(this.app.workspace.on("file-open",t=>{t&&"pdf"===t.extension&&(this.addPdfDragListeners(),this.timerManager.addTimeout(async()=>{var e=this.app.workspace.getLeaf();if(e&&e.view&&e.view.file&&e.view.file.path===t.path)try{await this.waitForPdfReady(e.view),this.addPdfDragListeners()}catch(e){this.timerManager.addTimeout(()=>{this.addPdfDragListeners()},300)}else this.addPdfDragListeners()},500))})),this.addPdfDragListeners()}addPdfDragListeners(){this.app.workspace.getLeavesOfType("pdf").forEach(e=>{e=e.view;e&&e.containerEl&&this.setupPdfDragListener(e)}),this.addPdfToolbarButton()}setupPdfDragListener(e){var t=e.containerEl,a=(this.hasActiveListeners(t),this.getContainerState(t)),i=Date.now();a.lastSetupTime&&i-a.lastSetupTime<1e3||(this.cleanupContainerEventListeners(t),this.updateContainerState(t,{hasListeners:!0,lastSetupTime:i,setupCount:a.setupCount+1,listenerTypes:new Set(["mousedown","mousemove","mouseup","touchstart","touchmove","touchend","dragstart","contextmenu","selectionchange"])}),this.setupPdfDragListenerInternal(e,t),this.addFloatingButton(t,e))}setupPdfDragListenerInternal(r,n){var e=n.querySelector(".pdf-viewer")||n.querySelector('[data-type="pdf"]')||n;n.setAttribute("pdfflow-listener","true");let d=null,h=!1;var t=e=>{},a=e=>{},i=e=>{},o=e=>{},s=t=>{if(button._touchDragTimeout&&(clearTimeout(button._touchDragTimeout),button._touchDragTimeout=null),!h){let e=t.changedTouches[0];if(Math.sqrt(Math.pow(e.clientX-dragStartPos.x,2)+Math.pow(e.clientY-dragStartPos.y,2))<=10&&isClick)return void(isClick=!1)}if(h){t.preventDefault(),t.stopPropagation(),h=!1;let e=t.changedTouches[0];var t=e.clientX,a=e.clientY,i=(dragPreview&&(this.domManager.removeDragPreview(dragPreview),dragPreview=null),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),this.cleanupDragPreviews(),document.elementFromPoint(t,a));if(i){var r,n=i.closest("[data-pdfflow-drop-listener]"),o=i.closest("[data-pdfflow-excalidraw-listener]"),i=n||o;if(document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),i){if(o)for(r of this.app.workspace.getLeavesOfType("excalidraw"))if(r.view&&r.view.containerEl===o){this.app.workspace.setActiveLeaf(r,!0,!0);break}var n=new CustomEvent("drop",{bubbles:!0,cancelable:!0}),s=(n.dataTransfer={getData:e=>selectedText,types:["text/plain"],files:[]},i.getBoundingClientRect()),l=t-s.left,s=a-s.top;n.clientX=t,n.clientY=a,n.preciseClientX=t,n.preciseClientY=a,n.offsetX=l,n.offsetY=s,n._isTextDrag=!0,i.dispatchEvent(n)}}}};let l=(o,s,l,c)=>{c=c.file;if(c&&s&&0!==s.rangeCount){s=s.getRangeAt(0);if(s&&o){var e=(s.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?s.commonAncestorContainer:s.commonAncestorContainer.parentElement)?.closest(".page, .pdf-page, [data-page-number]");if(e){let n=this.filterValidTextRange(s,e);if(n){let r=n.toString().trim();if(r){o=r,h=h&&!1,l._currentDragStartHandler&&(l.removeEventListener("dragstart",l._currentDragStartHandler),l._currentDragStartHandler=null),l._currentTextTouchStartHandler&&(l.removeEventListener("touchstart",l._currentTextTouchStartHandler),l._currentTextTouchStartHandler=null),l._currentTextTouchMoveHandler&&(l.removeEventListener("touchmove",l._currentTextTouchMoveHandler),l._currentTextTouchMoveHandler=null),l._currentTextTouchEndHandler&&(l.removeEventListener("touchend",l._currentTextTouchEndHandler),l._currentTextTouchEndHandler=null);s=this.getPageInfoFromSelection({getRangeAt:()=>n,rangeCount:1,toString:()=>r},l);d={text:o,file:c,pageInfo:s,type:"text"};let e=t=>{if(d){h=!0,t.dataTransfer.setData("text/plain",o),t.dataTransfer.effectAllowed="copy";var a=window.getSelection();if(a&&0<a.rangeCount){let e=a.getRangeAt(0);var i=(e.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?e.commonAncestorContainer:e.commonAncestorContainer.parentElement)?.closest(".page, .pdf-page, [data-page-number]");let t=(e=i&&(i=this.filterValidTextRange(e,i))?i:e).startContainer;for(;t&&t!==l&&(!t.classList||!t.classList.contains("page"));)t=t.parentElement;t&&(i=t.querySelector(".textLayer"))&&(r=Array.from(i.querySelectorAll("span")),r=this.getSpanIndexFromRange(e,r))&&(d.stableSpanInfo=r,d.pageElement=t,d.textLayer=i);var r={startContainer:e.startContainer,startOffset:e.startOffset,endContainer:e.endContainer,endOffset:e.endOffset,commonAncestorContainer:e.commonAncestorContainer};d.stableRange=r,d.selectionText=a.toString()}i=o.substring(0,100),a=(this.dragDataStorage.set(i,d),100<o.length&&(r=o,this.dragDataStorage.set(r,d)),Date.now()+"_"+o.substring(0,50));this.dragDataStorage.set(a,d),this.lastDragData=d;let e=this.createDragPreview(o);document.body.appendChild(e),t.dataTransfer.setDragImage(e,0,0),setTimeout(()=>{document.body.removeChild(e)},0)}},t=e=>{e.preventDefault(),e.stopPropagation()},a=e=>{e.preventDefault()},i=e=>{e.preventDefault()};l._currentDragStartHandler=e,l._currentTextTouchStartHandler=t,l._currentTextTouchMoveHandler=a,l._currentTextTouchEndHandler=i,l.addEventListener("dragstart",e,{once:!0}),l.draggable=!0,setTimeout(()=>{l._currentDragStartHandler===e&&(l.draggable=!1,l.removeEventListener("dragstart",e),l.removeEventListener("touchstart",t),l.removeEventListener("touchmove",a),l.removeEventListener("touchend",i),l._currentDragStartHandler=null,l._currentTextTouchStartHandler=null,l._currentTextTouchMoveHandler=null,l._currentTextTouchEndHandler=null,h=!1)},3e3)}}}}}};var c=e=>{};n._pdfflowMouseDownHandler=t,n._pdfflowMouseMoveHandler=a,n._pdfflowMouseUpHandler=c,n._pdfflowTouchStartHandler=i,n._pdfflowTouchMoveHandler=o,n._pdfflowTouchEndHandler=s,n.addEventListener("mousedown",t),n.addEventListener("mousemove",a),n.addEventListener("mouseup",c),n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("touchmove",o,{passive:!1}),n.addEventListener("touchend",s,{passive:!1});let p=()=>{let i=window.getSelection();if(i&&i.toString().trim()&&!h&&!this.isSelectingRect){let a=i.toString().trim();this.setupTextDragTimeout&&this.timerManager.clearTimeout(this.setupTextDragTimeout);var e=this.isMacOS()?300:120;this.setupTextDragTimeout=this.timerManager.addTimeout(()=>{l(a,i,n,r)},e),this.isTouchDevice()&&(this.buttonCreateTimeout&&this.timerManager.clearTimeout(this.buttonCreateTimeout),this.buttonCreateTimeout=this.timerManager.addTimeout(()=>{var e,t=window.getSelection();t&&0<t.rangeCount&&(t=t.getRangeAt(0),(e=n.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(t=this.filterValidTextRange(t,e))?((e=window.getSelection()).removeAllRanges(),e.addRange(t),(t=e.toString().trim())&&this.createDragAssistButton(t,e,n,r)):this.createDragAssistButton(a,i,n,r))},150))}else{this.buttonCreateTimeout&&this.timerManager.clearTimeout(this.buttonCreateTimeout),this.setupTextDragTimeout&&this.timerManager.clearTimeout(this.setupTextDragTimeout);e=this.isTouchDevice()?300:100;setTimeout(()=>{document.querySelectorAll(".pdfflow-drag-assist-button").forEach(e=>{e.matches(":active")||e.matches(":focus")||(e._autoRemoveTimer&&clearTimeout(e._autoRemoveTimer),e.remove())})},e),this.hideContextMenu()}},u=e=>{var t,a=window.getSelection();a&&a.toString().trim()&&!h&&!this.isSelectingRect&&(e.preventDefault(),e.stopPropagation(),t=a.toString().trim(),this.showPdfContextMenu(e,t,a,n,r))};n._pdfflowContextMenuHandler=u,n.addEventListener("contextmenu",u),e!==n&&(n._pdfflowPdfViewerContextMenuHandler=u,e.addEventListener("contextmenu",u));t=e=>{n.contains(e.target)&&(setTimeout(()=>{var e,t,a=document.querySelector(".menu-scroll");a&&!a.hasAttribute("pdfflow-processed")&&(e=window.getSelection())&&e.toString().trim()&&(t=e.toString().trim(),this.addOptionsToPdfPlusMenu(a,t,e,n,r),a.setAttribute("pdfflow-processed","true"))},100),u(e))},document._pdfflowDocumentContextMenuHandler=t,document.addEventListener("contextmenu",t,!0),n._pdfflowSelectionChangeHandler||(n._pdfflowSelectionChangeHandler=e=>{var t=this.app.workspace.activeLeaf;t&&t.view&&t.view.containerEl&&t.view.containerEl===n&&p()},document.addEventListener("selectionchange",n._pdfflowSelectionChangeHandler)),a=setInterval(()=>{document.querySelector(".menu-scroll")||document.querySelectorAll("[pdfflow-processed]").forEach(e=>{e.removeAttribute("pdfflow-processed")})},500);n._pdfflowMenuCheckInterval=a;this.addCanvasDropListeners(),this.addExcalidrawDropListeners(),this.defaultCanvasCoords={x:100,y:100},this.defaultExcalidrawCoords={x:100,y:100},this.isUserInitiatedDelete=!1}addFloatingButton(e,t){if(!e.querySelector(".pdfflow-floating-button")){let t=document.createElement("div"),i=(t.className="pdfflow-floating-button",t.innerHTML=`
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="20" height="20" x="2" y="2" rx="2"/>
                <circle cx="8" cy="8" r="2"/>
                <path d="M9.414 9.414 12 12"/>
                <path d="M14.8 14.8 18 18"/>
                <circle cx="8" cy="16" r="2"/>
                <path d="m18 6-8.586 8.586"/>
            </svg>
        `,t.className="pdfflow-floating-button",this.updateFloatingButtonState(t),e=>{e.preventDefault(),e.stopPropagation(),this.isSelectingRect?this.cancelRectSelection():(this.toggleRectSelectionMode(),this.updateFloatingButtonState(t),t.style.transform="scale(0.95)",setTimeout(()=>{t.style.transform="scale(1)"},150))}),r=(t.addEventListener("click",i),0),n=0,o=0;t.addEventListener("touchstart",e=>{e.preventDefault(),e.stopPropagation();e=e.touches[0];r=Date.now(),n=e.clientX,o=e.clientY},{passive:!1}),t.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation();var t=e.changedTouches[0],a=Date.now()-r,t=Math.sqrt(Math.pow(t.clientX-n,2)+Math.pow(t.clientY-o,2));a<300&&t<10&&i(e)},{passive:!1}),t.title=this.isSelectingRect?"ÂÖ≥Èó≠ÊãÜÂàáÊ®°Âºè":"ÂºÄÂêØË£ÅÂàáÊ®°ÂºèÔºàÊåâEscÂèØÂèñÊ∂àÔºâ","static"===getComputedStyle(e).position&&e.classList.add("pdfflow-container-relative"),e.appendChild(t)}}updateFloatingButtonState(e){var t;e&&(t=this.isSelectingRect,e.classList.remove("pdfflow-countdown-animation"),t?(e.classList.add("active"),e.innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18"/>
                    <path d="M6 6l12 12"/>
                </svg>
            `,e.classList.add("pdfflow-countdown-animation")):(e.classList.remove("active"),e.innerHTML=`
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="20" height="20" x="2" y="2" rx="2"/>
                    <circle cx="8" cy="8" r="2"/>
                    <path d="M9.414 9.414 12 12"/>
                    <path d="M14.8 14.8 18 18"/>
                    <circle cx="8" cy="16" r="2"/>
                    <path d="m18 6-8.586 8.586"/>
                </svg>
            `),e.title=t?"ÁÇπÂáªÂèñÊ∂àË£ÅÂàáÊ®°Âºè":"ÂºÄÂêØË£ÅÂàáÊ®°Âºè")}createRectOverlay(e){var t=document.createElement("div");return t.className="pdfflow-rect-overlay pdfflow-rect-overlay-fixed",t.style.cssText=`
            position: fixed;
            border: 2px dashed #007acc;
            background-color: rgba(0, 122, 204, 0.1);
            z-index: 1000;
            transition: all 0.1s ease;
            pointer-events: none;
        `,document.body.appendChild(t),this.domManager.addTempElement(t),t}updateRectSelection(e,t,a,i){var r,n,o;i&&(o=e.clientX,e=e.clientY,r=Math.min(t,o),n=Math.min(a,e),o=Math.abs(o-t),t=Math.abs(e-a),i.style.left=r+"px",i.style.top=n+"px",i.style.width=o+"px",i.style.height=t+"px",i.style.display="none",i.style.display="block")}async handleRectSelectionEnd(i,r,n,o,s,l){if(o&&this.checkPluginActivation()){var c=s.getBoundingClientRect(),d=s.offsetWidth/c.width,h=s.offsetHeight/c.height,p=window.devicePixelRatio||1,r=(r-c.left)*d,n=(n-c.top)*h,u=(i.clientX-c.left)*d,i=(i.clientY-c.top)*h,c=Math.min(r,u),g=Math.min(n,i),u=Math.abs(u-r),r=Math.abs(i-n);if(u<10||r<10)this.domManager.removeTempElement(o);else{i=l.file;if(i){var n=this.getPageInfoFromRect(c,g,u,r,s),t=i.path+`_${c}_${g}_${u}_`+r;let e=performance.now();if(this.rectDebounceMap&&this.rectDebounceMap.has(t)){var a=this.rectDebounceMap.get(t);if(e-a<150)return void this.domManager.removeTempElement(o)}if(this.rectDebounceMap||(this.rectDebounceMap=new Map),this.rectDebounceMap.set(t,e),20<this.rectDebounceMap.size){var f=Array.from(this.rectDebounceMap.entries());f.sort((e,t)=>e[1]-t[1]);for(let e=0;e<5;e++)this.rectDebounceMap.delete(f[e][0])}try{var m=await this.captureRectArea(s,c,g,u,r,d,h,p);if(!m||!m.dataUrl)throw new Error("Êà™ÂõæÂ§±Ë¥•");var v=m.dataUrl,w=m.actualWidth||u,y=m.actualHeight||r;let e=new Date;var x=e.getFullYear().toString()+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0")+e.getHours().toString().padStart(2,"0")+e.getMinutes().toString().padStart(2,"0")+e.getSeconds().toString().padStart(2,"0"),b={type:"rect",file:i,pageInfo:n,noteTitle:x,displayText:i.basename+", p."+n.page,screenshotWidth:w,screenshotHeight:y,pdfView:l,rectDimensions:{left:c,top:g,width:u,height:r}},C=(o.style.cursor="grab",o.style.pointerEvents="auto",o.style.border="2px dashed #007acc",o.style.backgroundColor="rgba(0, 122, 204, 0.1)",o.style.position="absolute",o.style.zIndex="1001",o.classList.add("draggable"),o.setAttribute("data-pdfflow-persistent","true"),o.setAttribute("data-pdfflow-rect-selection","true"),this.createRectAssistButton(b,o,s,l));o.appendChild(C),o.getBoundingClientRect(),o.offsetWidth;Object.assign(C.style,{display:"flex",opacity:"1",visibility:"visible",position:"absolute",top:"-45px",right:"-5px",zIndex:"1003",transform:"scale(1)"});[s,s?.closest('.workspace-leaf-content[data-type="pdf"]'),document.body,...document.querySelectorAll(".pdfflow-rect-selection-mode"),...s?.querySelectorAll(".page, .textLayer, .annotationLayer")||[]].filter(Boolean).forEach(e=>{e.style.cursor="default",e.classList.remove("pdfflow-rect-selection-mode")});var E=document.querySelector(".pdfflow-rect-selection-mode::before"),k=(E&&E.remove(),document.querySelector(".pdfflow-rect-selector-overlay"));k&&k.remove(),b.screenshotData=v,b.file=i,b.pageNum=n.page,b.noteTitle=x,b.pageInfo=n;let t=e=>{o.contains(e.target)||e.target.closest(".pdfflow-rect-overlay")||e.target.closest(".pdfflow-rect-assist-button")||(o&&o.parentNode&&o.remove(),document.removeEventListener("click",t,!0))},a=(setTimeout(()=>{document.addEventListener("click",t,!0)},100),setTimeout(()=>{o&&o.parentNode&&o.remove(),document.removeEventListener("click",t,!0)},3e4));o._cleanup=()=>{clearTimeout(a),document.removeEventListener("click",t,!0)},this.isSelectingRect&&(this.rectModeTimer&&(clearTimeout(this.rectModeTimer),this.rectModeTimer=null),this.settings&&this.settings.enableObjectStorage,this.rectModeTimer=setTimeout(()=>{this.isSelectingRect&&this.cancelRectSelection(),this.rectModeTimer=null},3e3),this.updateAllFloatingButtons())}catch(e){o&&"true"!==o.getAttribute("data-pdfflow-persistent")&&(o.remove?o.remove():o.parentNode&&o.parentNode.removeChild(o)),this.isSelectingRect&&this.cancelRectSelection()}}else this.domManager.removeTempElement(o)}}}async captureRectArea(e,t,a,i,r,n=1,o=1,s=1){return this.captureAreaWithCanvas(e,t,a,i,r,n,o,s)}async captureAreaWithCanvas(e,a,i,r,n,o=1,s=1,l=1){try{var c=`capture_${a}_${i}_${r}_${n}_${o}_${s}_`+l,d=performance.now(),t=this.captureCache?.get(c);if(t&&d-t.timestamp<1e4)return t.result;if(this.captureCache||(this.captureCache=new Map),this.captureQueue||(this.captureQueue=new Set),this.captureQueue.has(c))return null;this.captureQueue.add(c);try{var h=document.createElement("canvas"),H=r*o*l,R=n*s*l,p=(h.width=H,h.height=R,h.style.width=r+"px",h.style.height=n+"px",h.getContext("2d",{alpha:!1,desynchronized:!0})),u=(p.imageSmoothingEnabled=!1,p.setTransform(o*l,0,0,s*l,0,0),p.fillStyle="#ffffff",p.fillRect(0,0,r,n),e.getBoundingClientRect()),$=e.scrollLeft||0,O=e.scrollTop||0,g=e.querySelectorAll("canvas");let t=!1;var f,m=a+r,v=i+n,w=[],B=Math.min(g.length,10),y=[];for(let e=0;e<B;e++){var x=g[e],b=x.getBoundingClientRect();y.push({canvas:x,rect:b,left:(b.left-u.left+$)*o,top:(b.top-u.top+O)*s})}for(f of y){var C=f.left+f.rect.width*o,E=f.top+f.rect.height*s,k=Math.max(0,Math.min(m,C)-Math.max(a,f.left)),q=Math.max(0,Math.min(v,E)-Math.max(i,f.top));12<k&&12<q&&w.push({...f,right:C,bottom:E,overlapArea:k*q})}w.sort((e,t)=>t.overlapArea-e.overlapArea);var T,W=Math.min(w.length,8),Y=[];for(let e=0;e<W;e++){var V,z,S,L,X,j,{canvas:A,rect:P,left:M,top:_}=w[e],D=Math.max(a,M),F=Math.max(i,_),U=Math.min(m,M+P.width*o),G=Math.min(v,_+P.height*s),N=U-D,I=G-F;0<N&&0<I&&(V=P.width,z=P.height,S=A.width,L=A.height,0<S)&&0<L&&Y.push({canvas:A,sourceX:(D-M)*(X=S/(V*o)),sourceY:(F-_)*(j=L/(z*s)),sourceWidth:N*X,sourceHeight:I*j,destX:D-a,destY:F-i,destWidth:N,destHeight:I})}for(T of Y)try{p.drawImage(T.canvas,T.sourceX,T.sourceY,T.sourceWidth,T.sourceHeight,T.destX,T.destY,T.destWidth,T.destHeight),t=!0}catch(e){try{p.drawImage(T.canvas,T.destX,T.destY,T.destWidth,T.destHeight),t=!0}catch(e){}}t||(p.fillStyle="#f8f9fa",p.fillRect(0,0,r,n),p.strokeStyle="#dee2e6",p.setLineDash([5,5]),p.strokeRect(2,2,r-4,n-4),p.fillStyle="#6c757d",p.font='14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',p.textAlign="center",p.fillText("PDFÊà™ÂõæÂå∫Âüü",r/2,n/2-10),p.fillText(r+" √ó "+n,r/2,n/2+10));var K={dataUrl:h.toDataURL("image/png"),actualWidth:h.width,actualHeight:h.height};if(this.captureCache.set(c,{result:K,timestamp:d}),15<this.captureCache.size){var Z=Array.from(this.captureCache.entries()).sort((e,t)=>e[1].timestamp-t[1].timestamp);for(let e=0;e<3;e++)this.captureCache.delete(Z[e][0])}return K}finally{this.captureQueue?.delete(c)}}catch(e){throw new Error("CanvasÊà™ÂõæÂ§±Ë¥•: "+e.message)}}async saveScreenshot(d,h,p){try{var e=new Date,t=e.getFullYear().toString()+(e.getMonth()+1).toString().padStart(2,"0")+e.getDate().toString().padStart(2,"0")+e.getHours().toString().padStart(2,"0")+e.getMinutes().toString().padStart(2,"0")+e.getSeconds().toString().padStart(2,"0");let l=h.basename,c=this.cleanFileName(l)+`_p${p}_${t}.png`;if(this.settings&&this.settings.enableObjectStorage){let s={path:null,isObjectStorage:!0,fileName:c,isProcessing:!0};return setTimeout(async()=>{try{var e=this.cleanFileNameForStorage(c.replace(".png",""))+".png",t=await this.uploadToObjectStorage(d,e);if(!t)throw new Error("‰∏ä‰º†Â§±Ë¥•");s.path=t,s.isProcessing=!1,this.notifyUploadComplete(s,h,p)}catch(e){try{var a="Books/ËØª‰π¶Á¨îËÆ∞/"+l,i=a+"/"+c,r=(await this.ensureFolderExists(a),d.split(",")[1]),n=window.atob(r),o=new Uint8Array(n.length);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);await this.app.vault.createBinary(i,o.buffer),s.path=i,s.isObjectStorage=!1,s.isProcessing=!1,this.notifyUploadComplete(s,h,p),new Notice("ÂØπË±°Â≠òÂÇ®‰∏ä‰º†Â§±Ë¥•ÔºåÂ∑≤‰øùÂ≠òÂà∞Êú¨Âú∞")}catch(e){s.error=e.message,s.isProcessing=!1,this.notifyUploadComplete(s,h,p)}}},0),s}var a="Books/ËØª‰π¶Á¨îËÆ∞/"+l,i=a+"/"+c,r=(await this.ensureFolderExists(a),d.split(",")[1]),n=window.atob(r),o=new Uint8Array(n.length);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);return await this.app.vault.createBinary(i,o.buffer),{path:i,isObjectStorage:!1,fileName:c}}catch(e){throw new Error("‰øùÂ≠òÊà™ÂõæÂ§±Ë¥•: "+e.message)}}getPageInfoFromRect(e,t,a,i,r){let n=1;try{var o,s=r.getBoundingClientRect(),l=e+a/2,c=t+i/2,d=s.left+l,h=s.top+c;for(o of r.querySelectorAll(".page, .pdf-page, .canvasWrapper")){var p=o.getBoundingClientRect();if(d>=p.left&&d<=p.right&&h>=p.top&&h<=p.bottom){var u,g=o.getAttribute("data-page-number")||o.getAttribute("data-page")||o.getAttribute("data-page-index");g&&(u=parseInt(g),!isNaN(u))&&0<u&&(n=u);break}}}catch(e){}l=`${Math.round(e)},${Math.round(t)},${Math.round(a)},`+Math.round(i);return{page:n,rect:l}}createRectDragPreview(e){var t=document.createElement("div");return t.style.cssText=`
            position: absolute;
            top: -1000px;
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10000;
        `,t.textContent="PDFÂå∫Âüü: "+e.displayText,this.domManager.addDragPreview(t),t}createRectAssistButton(n,o,e,t){let a=document.createElement("div");a.className="pdfflow-rect-assist-button";a.style.cssText=`
            position: absolute;
            top: -45px;
            right: -5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            cursor: grab;
            user-select: none;
            z-index: 1003;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: scale(1);
            min-width: 100px;
            max-width: 150px;
        `;var i=document.createElement("span"),i=(i.innerHTML="üìã",i.style.fontSize="14px",a.appendChild(i),document.createElement("span"));i.textContent="ÊãñÊãΩÊ≠§ÊåâÈíÆ",a.appendChild(i),a.addEventListener("mouseenter",()=>{a.style.transform="scale(1.05)",a.style.boxShadow="0 4px 12px rgba(0, 0, 0, 0.4)"}),a.addEventListener("mouseleave",()=>{a.style.transform="scale(1)",a.style.boxShadow="0 2px 8px rgba(0, 0, 0, 0.3)"}),a.addEventListener("mousedown",()=>{a.style.cursor="grabbing",a.style.transform="scale(0.95)"}),a.addEventListener("mouseup",()=>{a.style.cursor="grab",a.style.transform="scale(1.05)"}),a.addEventListener("dragstart",e=>{this.cleanupDragPreviews();e.dataTransfer.setData("text/plain","pdfflow-rect-data"),e.dataTransfer.effectAllowed="copy",this.rectSelectionData=n;let t=this.createRectDragPreview(n);document.body.appendChild(t),e.dataTransfer.setDragImage(t,0,0),this.timerManager.addTimeout(()=>{this.domManager.removeDragPreview(t)},100)}),a.addEventListener("dragend",e=>{e=e.dataTransfer.dropEffect;"copy"!==e&&"move"!==e||setTimeout(()=>{o&&o.parentNode&&o.remove()},100)});let s=null,l=null;return a.addEventListener("touchstart",e=>{e.touches&&0!==e.touches.length&&(s={startX:e.touches[0].clientX,startY:e.touches[0].clientY,data:n,isDragging:!1},this.rectSelectionData=n,e.preventDefault())}),a.addEventListener("touchmove",e=>{var t,a,i,r;s&&e.touches&&0<e.touches.length&&(t=e.touches[0],a=Math.abs(t.clientX-s.startX),r=Math.abs(t.clientY-s.startY),i=this.isMacOS()?15:10,!s.isDragging&&(i<a||i<r)&&(s.isDragging=!0,this.cleanupDragPreviews(),(l=document.createElement("div")).className="pdfflow-rect-drag-preview",l.style.cssText=`
                        position: fixed;
                        top: ${t.clientY-50}px;
                        left: ${t.clientX}px;
                        transform: translate(-50%, -50%);
                        background: rgba(0, 0, 0, 0.8);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 6px;
                        font-size: 14px;
                        white-space: nowrap;
                        pointer-events: none;
                        z-index: 10000;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
                    `,l.textContent="PDFÂå∫Âüü: "+n.displayText,document.body.appendChild(l),this.domManager.addDragPreview(l)),s.isDragging&&l&&(l.style.left=t.clientX+"px",l.style.top=t.clientY-50+"px"),i=(a=document.elementFromPoint(t.clientX,t.clientY))?.closest("[data-pdfflow-drop-listener]"),r=a?.closest("[data-pdfflow-excalidraw-listener]"),document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),r?r.classList.add("pdfflow-excalidraw-drag-over"):i&&i.classList.add("pdfflow-drag-over"),e.preventDefault())}),a.addEventListener("touchend",e=>{if(s&&e.changedTouches&&0<e.changedTouches.length){var t=e.changedTouches[0];if(l&&(this.domManager.removeDragPreview(l),l=null),this.cleanupDragPreviews(),this.timerManager.addTimeout(()=>{this.cleanupDragPreviews()},100),document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),s.isDragging){var a,i=document.elementFromPoint(t.clientX,t.clientY),r=i?.closest("[data-pdfflow-drop-listener]"),n=i?.closest("[data-pdfflow-excalidraw-listener]"),i=r||n;if(i){if(n)for(a of this.app.workspace.getLeavesOfType("excalidraw"))if(a.view&&a.view.containerEl===n){this.app.workspace.setActiveLeaf(a,!0,!0);break}o&&o.parentNode&&o.remove();r=new CustomEvent("drop",{bubbles:!0,cancelable:!0});r.dataTransfer={getData:()=>"pdfflow-rect-data"},r.clientX=t.clientX,r.clientY=t.clientY,r.preciseClientX=t.clientX,r.preciseClientY=t.clientY,i.dispatchEvent(r),this.isSelectingRect&&this.cancelRectSelection()}}s=null,e.preventDefault()}}),a.draggable=!0,a}addCanvasDropListeners(){this.registerEvent(this.app.workspace.on("layout-change",()=>{this.setupCanvasDropListeners()})),this.setupCanvasDropListeners()}setupCanvasDropListeners(){this.app.workspace.getLeavesOfType("canvas").forEach(e=>{e=e.view;e&&e.canvas&&e.canvas.wrapperEl&&this.setupCanvasDropListener(e)})}setupCanvasDropListener(n){let o=n.canvas.wrapperEl;o.hasAttribute("pdfflow-drop-listener")||(o.setAttribute("pdfflow-drop-listener","true"),o.setAttribute("data-pdfflow-drop-listener","true"),this.setupCanvasDeleteListeners(n,o),o.addEventListener("dragenter",e=>{e.preventDefault(),o.classList.add("pdfflow-drag-over")}),o.addEventListener("dragover",e=>{e.preventDefault(),e.dataTransfer.dropEffect="copy",o.setAttribute("data-last-drag-x",e.clientX.toString()),o.setAttribute("data-last-drag-y",e.clientY.toString())}),o.addEventListener("dragleave",e=>{o.contains(e.relatedTarget)||o.classList.remove("pdfflow-drag-over")}),o.addEventListener("drop",async t=>{if(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),o.classList.remove("pdfflow-drag-over"),t.dataTransfer.files&&0<t.dataTransfer.files.length){var a=t.dataTransfer.files[0];if(!a.name.endsWith(".webarchive")||!t._isTextDrag)return}a=t.dataTransfer.getData("text/plain");if(a){var e=o.getAttribute("data-last-drag-x"),i=o.getAttribute("data-last-drag-y");e&&i&&(t.preciseClientX=parseInt(e),t.preciseClientY=parseInt(i));try{let e;var r;if("pdfflow-rect-data"===a&&this.rectSelectionData)e=await this.createRectExcerptNote(this.rectSelectionData),this.rectSelectionData=null;else{if(!(r=this.getCurrentDragData(a)))return;e=await this.createExcerptNote(r)}await this.createCanvasCard(n,e,t)}catch(e){}}}))}setupCanvasDeleteListeners(t,e){var a=e=>{const t=e.target.closest('button.clickable-icon[aria-label="ÁßªÈô§"]')||e.target.closest('button.clickable-icon[aria-label="Âà†Èô§"]')||e.target.closest('button.clickable-icon[aria-label="Delete"]')||e.target.closest('button.clickable-icon[aria-label="Remove"]')||e.target.closest('button[aria-label*="Âà†Èô§"]')||e.target.closest('button[aria-label*="ÁßªÈô§"]')||e.target.closest('button[aria-label*="delete"]')||e.target.closest('button[aria-label*="remove"]');if(!t){var a=e.target.closest("button.clickable-icon");if(a){var i,e=a.querySelector("svg");if(e)for(i of e.querySelectorAll("path")){var r=i.getAttribute("d");if(r&&(r.includes("M3 6h18")||r.includes("m9 1 1-1h4l1 1")||r.includes("M18 6L6 18")||r.includes("m6 6 12 12"))){t=a;break}}}}t&&(this.isUserInitiatedDelete=!0)},i=e=>{"Delete"!==e.key&&"Backspace"!==e.key||(e=t.canvas.selection)&&0<e.size&&(this.isUserInitiatedDelete=!0)},r=e=>{setTimeout(()=>{this.setupContextMenuDeleteListener()},100)},n=e=>{var e=e.target.closest(".menu-item");e&&((e=e.textContent?.trim()||"").includes("ÁßªÈô§")||e.includes("Âà†Èô§")||e.includes("Delete")||e.includes("Remove")||e.toLowerCase().includes("delete")||e.toLowerCase().includes("remove"))&&(this.isUserInitiatedDelete=!0)};e.addEventListener("click",a,!0),e.addEventListener("keydown",i,!0),e.addEventListener("contextmenu",r,!0),document.addEventListener("click",n,!0),this.canvasDeleteListeners||(this.canvasDeleteListeners=new Map),this.canvasDeleteListeners.set(e,{deleteButtonHandler:a,keydownHandler:i,contextMenuHandler:r,globalMenuClickHandler:n})}cleanupCanvasDeleteListeners(){this.canvasDeleteListeners&&(this.canvasDeleteListeners.forEach((e,t)=>{t&&e&&(t.removeEventListener("click",e.deleteButtonHandler,!0),t.removeEventListener("keydown",e.keydownHandler,!0),e.contextMenuHandler&&t.removeEventListener("contextmenu",e.contextMenuHandler,!0),e.globalMenuClickHandler)&&document.removeEventListener("click",e.globalMenuClickHandler,!0)}),this.canvasDeleteListeners.clear())}setupContextMenuDeleteListener(){var e=document.querySelector(".menu");e&&e.querySelectorAll(".menu-item").forEach(e=>{var t=e.textContent?.trim()||"";(t.includes("ÁßªÈô§")||t.includes("Âà†Èô§")||t.includes("Delete")||t.includes("Remove")||t.toLowerCase().includes("delete")||t.toLowerCase().includes("remove"))&&e.addEventListener("click",()=>{this.isUserInitiatedDelete=!0},{once:!0})})}addExcalidrawDropListeners(){this.registerEvent(this.app.workspace.on("layout-change",()=>{this.setupExcalidrawDropListeners()})),this.setupExcalidrawDropListeners()}setupExcalidrawDropListeners(){this.app.workspace.getLeavesOfType("excalidraw").forEach(e=>{e=e.view;e&&e.containerEl&&(e.excalidrawAPI||e.getExcalidrawAPI)&&this.setupExcalidrawDropListener(e)})}setupExcalidrawDropListener(n){let t=n.containerEl;t&&!t.hasAttribute("pdfflow-excalidraw-listener")&&(t.setAttribute("pdfflow-excalidraw-listener","true"),t.setAttribute("data-pdfflow-excalidraw-listener","true"),t.addEventListener("dragenter",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),t.classList.add("pdfflow-excalidraw-drag-over")},!0),t.addEventListener("dragover",e=>{e.preventDefault(),e.stopPropagation(),e.stopImmediatePropagation(),e.dataTransfer.dropEffect="copy",t.setAttribute("data-last-excalidraw-drag-x",e.clientX.toString()),t.setAttribute("data-last-excalidraw-drag-y",e.clientY.toString())},!0),t.addEventListener("dragleave",e=>{e.preventDefault(),e.stopPropagation(),t.contains(e.relatedTarget)||t.classList.remove("pdfflow-excalidraw-drag-over")},!0),t.addEventListener("drop",async a=>{var i=a.dataTransfer.getData("text/plain");if(a.dataTransfer.files&&0<a.dataTransfer.files.length){var e=a.dataTransfer.files[0];if(!e.name.endsWith(".webarchive")||!a._isTextDrag)return}if(i){t.classList.remove("pdfflow-excalidraw-drag-over");try{let t;var r;if("pdfflow-rect-data"===i&&this.rectSelectionData)a.preventDefault(),a.stopPropagation(),t=await this.createRectExcerptNote(this.rectSelectionData),this.rectSelectionData=null,await this.createExcalidrawElement(n,t,a)&&this.isSelectingRect&&this.cancelRectSelection();else{if(!(r=this.getCurrentDragData(i)))return;let e={...a};t=await this.createExcerptNote(r),setTimeout(async()=>{await this.replaceExcalidrawTextWithEmbeddedElement(n,t,e)},100)}t&&t.noteFile&&await this.updateIndexForFile(t.noteFile)}catch(e){}}},!0))}formatPathWithWikiLinks(e,t){return`[[${e.path.replace(/\.md$/,"")}#Note${t}]]`}async replaceExcalidrawTextWithEmbeddedElement(e,t,a){try{var i,r,n,o,s,l,c,d,h,p,u=await this.getExcalidrawAutomateAPI(e);return u?({excalidrawX:i,excalidrawY:r}=this.getLastCreatedTextElementPosition(u),null===i||null===r?({excalidrawX:n,excalidrawY:o}=this.getExcalidrawCoordinates(u,a),(s=await this.createInteractiveExcalidrawElement(u,n,o,this.formatPathWithWikiLinks(t.noteFile,t.noteTitle),t.type))&&(this.app.workspace.setActiveLeaf(e.leaf,!0,!0),await new Promise(e=>setTimeout(e,50)),await this.executeExcalidrawSaveCommand()),s):({noteFile:l,noteTitle:c,type:d}=t,h=this.formatPathWithWikiLinks(l,c),await this.deleteLastCreatedTextElement(u),(p=await this.createInteractiveExcalidrawElement(u,i,r,h,d))&&(this.app.workspace.setActiveLeaf(e.leaf,!0,!0),await new Promise(e=>setTimeout(e,50)),await this.executeExcalidrawSaveCommand()),p)):!1}catch(e){return!1}}async createExcalidrawElement(e,t,a){try{var i,r,n,o,s,l,c,d=await this.getExcalidrawAutomateAPI(e);return d?({excalidrawX:i,excalidrawY:r}=this.getExcalidrawCoordinates(d,a),{noteFile:n,noteTitle:o,type:s}=t,l=this.formatPathWithWikiLinks(n,o),(c=await this.createInteractiveExcalidrawElement(d,i,r,l,s))&&(this.app.workspace.setActiveLeaf(e.leaf,!0,!0),await new Promise(e=>setTimeout(e,50)),await this.executeExcalidrawSaveCommand()),c):!1}catch(e){return!1}}async getExcalidrawAutomateAPI(e){try{var t;return e.excalidrawAPI?((t=e.excalidrawAPI).targetView||(t.targetView=e),!t.getViewElements&&t.getSceneElements&&(t.getViewElements=t.getSceneElements.bind(t)),!t.addEmbeddable&&t.updateScene&&(t.addEmbeddable=this.createMockAddEmbeddable(t)),t):null}catch(e){return null}}createMockAddEmbeddable(e){return(e,t,a,i,r)=>{try{return{id:this.generateExcalidrawElementId(),type:"embeddable",x:e,y:t,width:a,height:i,angle:0,strokeColor:"#000000",backgroundColor:"transparent",fillStyle:"solid",strokeWidth:1,strokeStyle:"solid",roughness:0,opacity:100,groupIds:[],frameId:null,roundness:null,seed:Math.floor(1e6*Math.random()),versionNonce:Math.floor(1e6*Math.random()),isDeleted:!1,boundElements:null,updated:Date.now(),link:r,locked:!1,containerId:r,scale:[1,1],validated:!0}}catch(e){return null}}}async createInteractiveExcalidrawElement(e,t,a,i,r){try{var n="rect"===r?400:500,o="rect"===r?300:200;if("function"==typeof e.addEmbeddable){var s,l=e.addEmbeddable(t,a,n,o,i);if(l){if(this.applyElementStyling(l,.78),"embeddable"===l.type&&e.updateScene)return s=[...e.getSceneElements?e.getSceneElements():e.getViewElements(),l],await e.updateScene({elements:s,commitToHistory:!0}),!0;if("function"==typeof e.addElementsToView)return await e.addElementsToView(!1,!0),!0;if("function"==typeof e.refresh)return await e.refresh(),!0}}return!1}catch(e){return!1}}applyElementStyling(e,t){try{e.scale=[t,t],e.backgroundColor="transparent",e.strokeWidth=0,e.roughness=0,e.opacity=100,e.customData&&(e.customData.borderRadius="0px",e.customData.hideFilename=!0,e.customData.transparent=!0)}catch(e){}}generateExcalidrawElementId(){return`element_${Date.now()}_`+Math.random().toString(36).substr(2,9)}async executeExcalidrawSaveCommand(){try{var e,t=this.app.workspace.getLeavesOfType("excalidraw");return 0===t.length?!1:(e=t[0],this.app.workspace.setActiveLeaf(e,!0,!0),await new Promise(e=>setTimeout(e,200)),await this.app.commands.executeCommandById("obsidian-excalidraw-plugin:save"),!0)}catch(e){return!1}}getLastCreatedTextElementPosition(e){try{var t,a,i=e.getViewElements?e.getViewElements():e.getSceneElements?e.getSceneElements():[];return i&&0!==i.length?0===(t=i.filter(e=>"text"===e.type)).length?{excalidrawX:null,excalidrawY:null}:{excalidrawX:(a=t[t.length-1]).x,excalidrawY:a.y}:{excalidrawX:null,excalidrawY:null}}catch(e){return{excalidrawX:null,excalidrawY:null}}}async deleteLastCreatedTextElement(e){try{var a=e.getViewElements?e.getViewElements():e.getSceneElements?e.getSceneElements():[];if(!a||0===a.length)return!1;var i,r=a.filter(e=>"text"===e.type);if(0===r.length)return!1;let t=r[r.length-1];return e.deleteElements&&"function"==typeof e.deleteElements?(e.deleteElements([t.id]),!0):!(!e.updateScene||"function"!=typeof e.updateScene||(i=a.filter(e=>e.id!==t.id),e.updateScene({elements:i}),0))}catch(e){return!1}}getExcalidrawCoordinates(t,a){try{var r=a.preciseClientX||a.clientX,n=a.preciseClientY||a.clientY;if(t.viewportCoordsToSceneCoords&&"function"==typeof t.viewportCoordsToSceneCoords)try{var i=t.viewportCoordsToSceneCoords(r,n);if(i&&"number"==typeof i.x&&"number"==typeof i.y)return{excalidrawX:i.x,excalidrawY:i.y}}catch(e){}var o,s=this.app.workspace.getLeavesOfType("excalidraw");let e=null;for(o of s)if(o.view&&(o.view.excalidrawAPI===t||o.view===t.targetView)){e=o.view;break}if(e&&e.containerEl){var l=e.containerEl,c=l.querySelector(".excalidraw-wrapper")||l.querySelector(".excalidraw")||l.querySelector("canvas")||l,d=c.getBoundingClientRect(),h=r-d.left,p=n-d.top;let t=1,a=0,i=0;if(e.excalidrawAPI)try{var u=e.excalidrawAPI.getAppState();u&&(t=u.zoom?.value||1,a=u.scrollX||0,i=u.scrollY||0)}catch(e){var g,f,m,v=c.querySelector("svg");v&&(f=(g=v.style.transform||"").match(/scale\(([^)]+)\)/),m=g.match(/translate\(([^,]+),\s*([^)]+)\)/),f&&(t=parseFloat(f[1])||1),m)&&(a=parseFloat(m[1])||0,i=parseFloat(m[2])||0)}return{excalidrawX:h/t-a,excalidrawY:p/t-i}}return{excalidrawX:100,excalidrawY:100}}catch(e){return{excalidrawX:100,excalidrawY:100}}}async saveScreenshotAsync(e,t,a,i,r=null){try{var n=await this.saveScreenshot(e,t,a);n.isProcessing||await this.createOrUpdateRectNote(t,a,i,n,null,r)}catch(e){await this.createOrUpdateRectNote(t,a,i,null,e.message,r)}}async notifyUploadComplete(t,e,a){try{var i=e.basename,r="Books/ËØª‰π¶Á¨îËÆ∞/"+i+"/"+(i+".md"),n=this.app.vault.getAbstractFileByPath(r);if(n){var o=await this.app.vault.read(n),s=/<!-- ÂõæÁâáÂ§ÑÁêÜ‰∏≠\.\.\. -->/g;if(s.test(o)){let e;e=t.error?`<!-- ÂõæÁâá‰∏ä‰º†Â§±Ë¥•: ${t.error} -->`:t.isObjectStorage?`![](${t.path})`:`![[${t.fileName}]]`;var l=o.replace(s,e);await this.app.vault.modify(n,l)}}}catch(e){}}async createOrUpdateRectNote(e,t,a,i,r=null,n=null){var o=e.basename;let s,l=(s=r?`<!-- ÂõæÁâá‰øùÂ≠òÂ§±Ë¥•: ${r} -->`:i?i.isObjectStorage?`![${i.fileName.replace(".png","")}](${i.path})`:`![[${i.path}]]`:"\x3c!-- ÂõæÁâáÂ§ÑÁêÜ‰∏≠... --\x3e","");n&&n.rect&&(l=`üîó[[${e.name}#page=${n.page}&square=${n.rect}&color=yellow| p.${n.page}]]

`);var c,r=`
### Note${a}
${s}
${l}‚úèÔ∏èËØÑËÆ∫Ôºö\`INPUT[inlineList(class(pdfflow)):Note${a}]\`

`,i="Books/ËØª‰π¶Á¨îËÆ∞/"+o,e=i+"/"+(o+".md"),n=(await this.ensureFolderExists(i),this.app.vault.getAbstractFileByPath(e));n instanceof TFile?(i=await this.app.vault.read(n),(c=new RegExp(`### Note${a}[\\s\\S]*?(?=### Note|$)`)).test(i)?(c=i.replace(c,r.trim()+"\n\n"),await this.app.vault.modify(n,c)):await this.app.vault.modify(n,i+r)):(c=await this.createNoteWithTemplate(o,a,r),await this.app.vault.create(e,c))}async createRectExcerptNote(e){let{file:t,pageInfo:a,noteTitle:i,displayText:r,screenshotWidth:n,screenshotHeight:o,screenshotData:s,pageNum:l}=e;var e=t.basename,c="Books/ËØª‰π¶Á¨îËÆ∞/"+e,d=c+"/"+(e+".md");await this.ensureFolderExists(c);let h=this.app.vault.getAbstractFileByPath(d),p="";a&&a.rect&&(p=`üîó[[${t.name}#page=${a.page}&square=${a.rect}&color=yellow| p.${a.page}]]

`);var u,c=`### Note${i}
<!-- ÂõæÁâáÂ§ÑÁêÜ‰∏≠... -->
${p}‚úèÔ∏èËØÑËÆ∫Ôºö\`INPUT[inlineList(class(pdfflow)):Note${i}]\`

`;h?(f=await this.app.vault.read(h),(u=new RegExp(`### Note${i}[\\s\\S]*?(?=### Note|$)`)).test(f)?(u=f.replace(u,c.trim()+"\n\n"),await this.app.vault.modify(h,u)):await this.app.vault.modify(h,f+c)):(u=await this.createNoteWithTemplate(e,i,c),h=await this.app.vault.create(d,u));try{var g={page:a.page,selection:a.selection,color:"yellow",text:r||"Áü©ÂΩ¢ÈÄâÊã©Âå∫Âüü",timestamp:i,type:"rect",screenshotWidth:n,screenshotHeight:o};await this.setLastHighlightCache(t.path,g)}catch(e){}var f={noteFile:h,noteTitle:i,excerptContent:c,pdfLink:`![[${h.path.replace(/\.md$/,"")}#Note${i}]]`,type:"rect",imagePath:"",screenshotWidth:n,screenshotHeight:o};return s&&void 0!==l&&setTimeout(async()=>{try{await this.saveScreenshotAsync(s,t,l,i,a)}catch(e){try{await this.createOrUpdateRectNote(t,l,i,null,e.message,a)}catch(e){}}},0),f}getCurrentDragData(a){var e,t,i=a.substring(0,100),r=this.dragDataStorage.get(i);if(r)return r;if(r=this.dragDataStorage.get(a))return r;if(this.lastDragData&&this.lastDragData.text===a)return this.lastDragData;for([e,t]of this.dragDataStorage)if(t&&t.text&&t.text.includes(a.trim()))return t;r=this.app.workspace.getLeavesOfType("pdf").find(e=>e.view.containerEl.contains(document.activeElement)||e===this.app.workspace.activeLeaf);if(r&&r.view.file){var n,o=window.getSelection();let t={page:1,select:"0,0,0,0"};if(o&&o.toString().trim()===a)t=0<o.rangeCount&&(h=o.getRangeAt(0),n=r.view.containerEl.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(h=this.filterValidTextRange(h,n))?((n=window.getSelection()).removeAllRanges(),n.addRange(h),this.getPageInfoFromSelection(n,r.view.containerEl)):this.getPageInfoFromSelection(o,r.view.containerEl);else try{var s=r.view.containerEl.querySelectorAll(".textLayer");for(let e=0;e<s.length;e++){var l=s[e];if((l.textContent||"").includes(a.trim())){var c=l.closest(".page, .pdf-page, [data-page-number]");if(c){var d=this.getPageNumberFromElement(c);t={page:d,select:"0,0,0,0"};break}}}}catch(e){}var h={text:a,file:r.view.file,pageInfo:t,pdfView:r.view,selection:o,isFallback:!0};return this.dragDataStorage.set(i,h),h}return null}getSpanIndexFromRange(n,o){try{var s=n.startContainer,l=n.endContainer;let t=-1,a=n.startOffset,i=-1,r=n.endOffset;for(let e=0;e<o.length;e++){var c,d=o[e];if(d.contains(s)||d===s){t=e,s.nodeType===Node.TEXT_NODE&&d.contains(s)&&(c=this.getFirstTextNode(d),a=c===s?n.startOffset:Math.min(n.startOffset,d.textContent.length));break}}for(let e=0;e<o.length;e++){var h,p=o[e];if(p.contains(l)||p===l){i=e,l.nodeType===Node.TEXT_NODE&&p.contains(l)&&(h=this.getFirstTextNode(p),r=h===l?n.endOffset:Math.min(n.endOffset,p.textContent.length));break}}if(-1===t||-1===i){var e=this.handleFallbackRange(n,o);if(e)return e}return 0<=t&&0<=i?{beginIndex:t,beginOffset:a,endIndex:i,endOffset:r}:null}catch(e){return null}}handleFallbackRange(e,t){try{var a=e.startContainer,i=e.endContainer,r=e.toString();for(let e=0;e<t.length;e++){var n,o,s=t[e].textContent||"";if(s.includes(r))return o=(n=s.indexOf(r))+r.length,{beginIndex:e,beginOffset:n,endIndex:e,endOffset:o}}for(let e=0;e<t.length;e++){var l=t[e],c=l.textContent||"";if(l.contains(a)||l.contains(i))return{beginIndex:e,beginOffset:0,endIndex:e,endOffset:c.length}}return null}catch(e){return null}}getPageNumberFromElement(a){try{if(a){let e=a.getAttribute("data-page-number")||a.getAttribute("data-page")||a.getAttribute("data-page-index");if(e){var i=parseInt(e);if(!isNaN(i)&&0<i)return i}var r=a.querySelector('.pageNumber, .page-number, [class*="page"]');if(r&&(e=r.textContent||r.getAttribute("data-page"))){var n=parseInt(e);if(!isNaN(n)&&0<n)return n}let t=a.parentElement;for(;t;){if(e=t.getAttribute("data-page-number")||t.getAttribute("data-page")||t.getAttribute("data-page-index")){var o=parseInt(e);if(!isNaN(o)&&0<o)return o}t=t.parentElement}var s=document.querySelectorAll(".page, .pdf-page, [data-page-number]");for(let e=0;e<s.length;e++)if(s[e]===a)return e+1}return 1}catch(e){return 1}}clearTempHighlight(e){if(e)try{document.querySelectorAll(`[data-highlight-id="${e}"]`).forEach(e=>{e.classList.contains(HIGHLIGHT_LAYER_CLASS)?this.domManager.removeHighlightElement(e):e.classList.contains(HIGHLIGHT_LAYER_CLASS+"-container")&&e.remove()}),this.tempHighlights.delete(e)}catch(e){}}clearAllTempHighlights(){try{document.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS).forEach(e=>{this.domManager.removeHighlightElement(e)}),document.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS+"-container").forEach(e=>{e.remove()}),this.tempHighlights.clear()}catch(e){}}async createExcerptNote(t){if(this.checkPluginActivation()){var{text:t,file:a,pageInfo:i}=t,r=a.basename,n=new Date,n=n.getFullYear().toString()+(n.getMonth()+1).toString().padStart(2,"0")+n.getDate().toString().padStart(2,"0")+n.getHours().toString().padStart(2,"0")+n.getMinutes().toString().padStart(2,"0")+n.getSeconds().toString().padStart(2,"0"),o=n,t=this.cleanPdfText(t),s=`
### Note${o}
${t}üîó[[${a.name}#page=${i.page}&select=${i.select}&color=yellow| p.${i.page}]]

‚úèÔ∏èËØÑËÆ∫Ôºö\`INPUT[inlineList(class(pdfflow)):Note${o}]\`

`,l="Books/ËØª‰π¶Á¨îËÆ∞/"+r,c=l+"/"+(r+".md");await this.ensureFolderExists(l);let e=this.app.vault.getAbstractFileByPath(c);if(e instanceof TFile){var l=await this.app.vault.read(e),d=`[[${a.name}#page=${i.page}&select=${i.select}&color=yellow| p.${i.page}]]`;if(l.includes("### Note"+o)&&l.includes(d))return{noteFile:e,noteTitle:o,excerptContent:s};await this.app.vault.modify(e,l+s)}else{d=await this.createNoteWithTemplate(r,o,s);e=await this.app.vault.create(c,d)}try{var h={page:i.page,select:i.select,color:"yellow",text:t,timestamp:n};await this.setLastHighlightCache(a.path,h)}catch(e){}return{noteFile:e,noteTitle:o,excerptContent:s}}}async createCanvasCard(r,n,o){if(this.checkPluginActivation()){this.isCreatingCanvasNode=!0;let t=r.canvas;var{noteFile:s,noteTitle:l,excerptContent:c,type:d}=n;if(s&&s instanceof TFile)try{await new Promise(e=>setTimeout(e,100));var h=await this.app.vault.read(s),p="### Note"+l;h.includes(p)||await new Promise(e=>setTimeout(e,500))}catch(e){await new Promise(e=>setTimeout(e,300))}var{canvasX:h,canvasY:p}=this.getCanvasCoordinates(t,o);let e;var o=s.path.replace(/\.md$/,""),s=(e=`![[${o}#Note${l}]]

`,this.generateNodeId());let a,i=(a="rect"===d&&n.screenshotWidth&&n.screenshotHeight?this.calculateHeightFromAspectRatio(n.screenshotWidth,n.screenshotHeight,500):"rect"===d?300:(o=c||e,this.calculateNodeHeight(o,500)),{id:s,type:"text",text:e,x:h-150,y:p-Math.floor(a/2),width:500,height:a,color:"1"});try{let e=!1;if(!e)try{var u,g,f=r.file;f&&(u=await this.app.vault.read(f),(g=JSON.parse(u)).nodes||(g.nodes=[]),g.nodes.push(i),await this.app.vault.modify(f,JSON.stringify(g,null,2)),e=!0)}catch(e){}if(!e)throw new Error("ÊâÄÊúâÂàõÂª∫CanvasÂç°ÁâáÁöÑÊñπÊ≥ïÈÉΩÂ§±Ë¥•‰∫Ü");try{t.requestSave&&"function"==typeof t.requestSave?t.requestSave():r.requestSave&&"function"==typeof r.requestSave&&r.requestSave(),this.timerManager.addTimeout(()=>{try{t.requestFrame?t.requestFrame():t.render?t.render():t.update&&t.update(),this.isSelectingRect||this.autoResizeCanvasNodeHeight(i.id,r),this.isSelectingRect&&this.cancelRectSelection(),this.isCreatingCanvasNode=!1;try{var e=r?.file;e&&e.path?this.updateHighlightsForAffectedPdfs(e.path):this.updateHighlights()}catch(e){this.updateHighlights()}}catch(e){this.isCreatingCanvasNode=!1}},300)}catch(e){}}catch(e){throw new Error("ÂàõÂª∫CanvasÂç°ÁâáÂ§±Ë¥•")}}}getCanvasCoordinates(t,a){try{var i=a.preciseClientX||a.clientX,r=a.preciseClientY||a.clientY;if(t.posFromEvt&&"function"==typeof t.posFromEvt)try{var n={...a,clientX:i,clientY:r},o=t.posFromEvt(n);return{canvasX:o.x,canvasY:o.y}}catch(e){}if(t.clientToCanvasCoords&&"function"==typeof t.clientToCanvasCoords)try{var s=t.clientToCanvasCoords({x:i,y:r});return{canvasX:s.x,canvasY:s.y}}catch(e){}if(t.viewport&&t.viewport.transformClientToCanvas)try{var l=t.viewport.transformClientToCanvas(i,r);return{canvasX:l.x,canvasY:l.y}}catch(e){}var c=t.wrapperEl.getBoundingClientRect();let e=t.viewport;var d=(e=!(e=!e&&t.view&&t.view.viewport?t.view.viewport:e)&&t.renderer&&t.renderer.viewport?t.renderer.viewport:e)?.x??0,h=e?.y??0,p=e?.zoom??1;return{canvasX:(i-c.left)/p+d,canvasY:(r-c.top)/p+h}}catch(e){n=t.wrapperEl.getBoundingClientRect();return{canvasX:(a.preciseClientX||a.clientX)-n.left,canvasY:(a.preciseClientY||a.clientY)-n.top}}}generateNodeId(){return Math.random().toString(36).substr(2,16)}getObsidianFontSettings(){try{var r,n=document.documentElement,o=getComputedStyle(n);let e=16;try{this.app&&this.app.vault&&this.app.vault.config&&(r=this.app.vault.config,e=r.baseFontSize||r.fontSize||16)}catch(e){}let t=o.getPropertyValue("--font-text-size")||o.getPropertyValue("--editor-font-size")||o.getPropertyValue("--canvas-text-size")||o.getPropertyValue("--font-ui-medium")||e+"px",a=(t=t.trim(),parseFloat(t));(isNaN(a)||a<=0)&&(a=e);var s=o.getPropertyValue("--line-height-normal")||o.getPropertyValue("--line-height")||o.getPropertyValue("--canvas-line-height")||"1.6";let i=parseFloat(s);(isNaN(i)||i<=0)&&(i=1.6);var l=o.getPropertyValue("--font-text")||o.getPropertyValue("--default-font")||o.getPropertyValue("--font-family-editor")||"Inter, system-ui, sans-serif";return{fontSize:a,lineHeight:i,fontFamily:l.trim()}}catch(e){return{fontSize:16,lineHeight:1.6,fontFamily:"Inter, system-ui, sans-serif"}}}calculateTextLines(i,r,n,o){try{let t=document.createElement("canvas").getContext("2d");t.font=n+"px "+o;var e=i.split("\n");let a=0;return e.forEach(e=>{""===e.trim()?a+=1:(e=t.measureText(e).width,e=Math.ceil(e/(r-40)),a+=Math.max(1,e))}),a}catch(e){let t=Math.floor((r-40)/(.6*n));o=i.split("\n");let a=0;return o.forEach(e=>{""===e.trim()?a+=1:a+=Math.ceil(e.length/t)}),Math.max(1,a)}}calculateNodeHeight(t,a){try{var{fontSize:e,lineHeight:i,fontFamily:r}=this.getObsidianFontSettings(),n=this.calculateTextLines(t,a,e,r),o=n*(e*i)+15+8+5,s=Math.max(80,o);return Math.round(s)}catch(e){a=t.length;return a<=50?80:a<=100?120:a<=200?160:a<=300?200:240}}async calculateImageNodeHeight(t,a){try{var i=await this.getImageDimensions(t);if(!i)return 200;var r=a-20;let e=1;i.width>r&&(e=r/i.width);var n=i.height*e,o=30+n,s=Math.max(80,Math.min(600,o));return Math.round(s)}catch(e){return 200}}calculateHeightFromAspectRatio(a,i,r){try{var n=r-20;let e=1,t=i*(e=n<a?n/a:e);a/i<1&&(t*=1.5);var o=t+30,s=Math.max(300,o);return Math.round(s)}catch(e){return 500}}async getImageDimensions(e){try{var t=this.app.vault.getAbstractFileByPath(e);if(!t)return null;var i=await this.app.vault.readBinary(t),r=new Blob([i]);let a=URL.createObjectURL(r);return new Promise(e=>{let t=new Image;t.onload=()=>{URL.revokeObjectURL(a),e({width:t.naturalWidth,height:t.naturalHeight})},t.onerror=()=>{URL.revokeObjectURL(a),e(null)},t.src=a})}catch(e){return null}}async ensureFolderExists(e){this.app.vault.getAbstractFileByPath(e)||await this.app.vault.createFolder(e)}cleanPdfText(e){if(!e||"string"!=typeof e)return"";let t=e.trim();return t=(t=(t=(t=(t=(t=(t=(t=(t=this.escapeSpecialChars(t)).replace(/[ \t]+$/gm,"")).replace(/\n(?!\n)/g," ")).replace(/\n{2,}/g,"\n\n")).replace(/[ \t]{2,}/g," ")).replace(/([„ÄÇÔºÅÔºüÔºõÔºö])[ ]+\n/g,"$1\n\n")).replace(/([.!?;:])[ ]+(?=[A-Z\u4e00-\u9fa5])/g,"$1\n\n")).replace(/\n{3,}/g,"\n\n")).replace(/^[ \t]+|[ \t]+$/gm,"")}escapeSpecialChars(e){return e&&"string"==typeof e?e.replace(/(https?:\/\/[a-zA-Z0-9\-._~:/?#[\]@!$&'()*+,;=%]+)/g,"  $1  ").replace(/#/g,"\\#").replace(/\[/g,"\\[").replace(/\]/g,"\\]").replace(/\{/g,"\\{").replace(/\}/g,"\\}").replace(/\\/g,"\\\\").replace(/\*/g,"\\*").replace(/([^\w])_([^\w])/g,"$1\\_$2").replace(/\|/g,"\\|"):""}cleanFileName(e){return e?e.replace(/[^\w\u4e00-\u9fa5\-\.]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,""):""}cleanFileNameForStorage(e){return e?e.replace(/[^\w\-\.]/g,"_").replace(/_+/g,"_").replace(/^_|_$/g,""):""}getPageInfoFromSelection(e,i){let r=1,n="0,0,0,0";try{var o=e.getRangeAt(0);if(o.collapsed||""===o.toString().trim())return{page:r,select:n};var s=this.filterValidTextRange(o,i);if(!s)return{page:r,select:n};var l=s.startContainer;let a=l.nodeType===Node.TEXT_NODE?l.parentElement:l;var c,d,h=["page","pdf-page","canvasWrapper","textLayer"];let t=!1;for(;a&&a!==i&&!t;){for(var p of h)if(a.classList&&a.classList.contains(p)){t=!0;break}t||(a=a.parentElement)}if(!t){let e=l.nodeType===Node.TEXT_NODE?l.parentElement:l;for(;e&&e!==i;){if(e.hasAttribute&&(e.hasAttribute("data-page-number")||e.hasAttribute("data-page")||e.hasAttribute("data-page-index")||e.classList.contains("page"))){a=e,t=!0;break}e=e.parentElement}}if(a){let t=a.getAttribute("data-page-number")||a.getAttribute("data-page")||a.getAttribute("data-page-index");if(t||(c=a.querySelector('.pageNumber, .page-number, [class*="page"]'))&&(t=c.textContent||c.getAttribute("data-page")),!t){let e=a.parentElement;for(;e&&e!==i&&!(t=e.getAttribute("data-page-number")||e.getAttribute("data-page"));)e=e.parentElement}t&&(d=parseInt(t),!isNaN(d))&&0<d&&(r=d),n=this.calculatePreciseSelectionCoords(s,a)}}catch(e){}return{page:r,select:n}}filterValidTextRange(t,e){try{var a,i,r,n,o,s=t.toString().trim();return s?!(s.length<50&&0<s.length)&&(a=t.startContainer,i=t.endContainer,r=this.findValidTextPosition(a,t.startOffset,e,!0),n=this.findValidTextPosition(i,t.endOffset,e,!1),r&&n||!s)&&((o=document.createRange()).setStart(r.container,r.offset),o.setEnd(n.container,n.offset),o.toString().trim())?o:t:null}catch(e){return t}}findValidTextPosition(t,a,i,r){try{if(t.nodeType===Node.TEXT_NODE){var n,o,s=t.textContent;if(s&&s.trim()){if(!r)return 0<=(o=(n=s.substring(0,a)).search(/\s*$/))&&o<n.length?{container:t,offset:o}:{container:t,offset:a};var l=s.substring(a).search(/\S/);if(0<=l)return{container:t,offset:a+l}}}if(t.nodeType===Node.ELEMENT_NODE){var c,d,h,p,u,g=this.getValidTextNodesInElement(t,i);if(0<g.length)return r?(d=(c=g[0]).textContent.search(/\S/),{container:c,offset:Math.max(0,d)}):{container:h=g[g.length-1],offset:0<=(u=(p=h.textContent).search(/\s*$/))?u:p.length}}let e=t.parentElement;for(;e&&e!==i;){var f,m,v,w,y,x=this.getValidTextNodesInElement(e,i);if(0<x.length)return r?(m=(f=x[0]).textContent.search(/\S/),{container:f,offset:Math.max(0,m)}):{container:v=x[x.length-1],offset:0<=(y=(w=v.textContent).search(/\s*$/))?y:w.length};e=e.parentElement}return null}catch(e){return null}}getValidTextNodesInElement(t,a){var i,r=[];try{for(var e,n=document.createTreeWalker(t,NodeFilter.SHOW_TEXT,{acceptNode:e=>{var t;return a.contains(e)&&(t=e.textContent)&&t.trim()&&(t=e.parentElement)&&"none"!==(e=window.getComputedStyle(t)).display&&"hidden"!==e.visibility&&"0"!==e.opacity&&(e=t.closest(".textLayer"),t=t.style.left||t.style.top||"absolute"===t.style.position,e||t)?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT}},!1);e=n.nextNode();)r.push(e)}catch(e){for(i of this.getTextNodesInElement(t))a.contains(i)&&i.textContent&&i.textContent.trim()&&r.push(i)}return r}calculatePreciseSelectionCoords(t,a){try{var e,i,r,n=a.querySelector(".textLayer")||a;return n?(e=this.getTextContentItems(n),i=this.getTextContentItemInfo(t.startContainer,t.startOffset,e),r=this.getTextContentItemInfo(t.endContainer,t.endOffset,e),0<=i.index&&0<=r.index?`${i.index},${i.offset},${r.index},`+r.offset:this.fallbackToCoordinateCalculation(t,a)):"0,0,0,0"}catch(e){return this.fallbackToCoordinateCalculation(t,a)}}getTextContentItems(n){let o=[];var e=n.querySelectorAll("*");let s=0;return e.forEach(e=>{var t=e.style,t=t.left||t.top||"absolute"===t.position||"relative"===t.position,a=e.textContent&&e.textContent.trim(),i=e.closest(".textLayer")===n,r=this.isListItem(e);(t&&a&&i||r&&a)&&(t=this.getTextNodesInElement(e))&&0<t.length&&o.push({index:s++,element:e,textNode:t[0],text:e.textContent||(t[0]?t[0].textContent:""),tagName:e.tagName,className:e.className,isListItem:r})}),o}isListItem(t){if(t){var a=t.tagName.toLowerCase(),i=t.className||"",r=t.textContent||"";if("li"===a||"ul"===a||"ol"===a)return!0;if(i.includes("list")||i.includes("item"))return!0;a=r.trim();if(a.startsWith("‚Ä¢")||a.startsWith("-")||a.startsWith("*")||/^\d+\./.test(a))return!0;let e=t.parentElement;for(;e&&e!==t.closest(".textLayer");){if("li"===e.tagName.toLowerCase()||"ul"===e.tagName.toLowerCase()||"ol"===e.tagName.toLowerCase())return!0;e=e.parentElement}}return!1}getTextNodesInElement(e){for(var t,a=[],i=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1);t=i.nextNode();)t.textContent.trim()&&a.push(t);return a}getTextContentItemInfo(t,a,i){for(let e=0;e<i.length;e++){var r=i[e];if(t===r.textNode)return{index:r.index,offset:a};if(t===r.element)return{index:r.index,offset:a};if(t.contains&&t.contains(r.textNode))return{index:r.index,offset:a};if(this.isElementContainedIn(t,r.element))return{index:r.index,offset:this.calculateOffsetInElement(t,a,r)}}return{index:-1,offset:0}}isElementContainedIn(e,t){if(!e||!t)return!1;let a=e;for(;a&&a!==t;)a=a.parentElement;return a===t}calculateOffsetInElement(e,t,a){try{var i,r,n,o;return e.nodeType===Node.TEXT_NODE?Math.min(t,e.textContent.length):(i=a.element,r=e.textContent||"",0<=(o=(n=i.textContent||"").indexOf(r))?o+t:Math.min(t,n.length))}catch(e){return t}}fallbackToCoordinateCalculation(e,t){try{var a,i,r,n,o=e.getBoundingClientRect(),s=t.getBoundingClientRect();if(0<s.width&&0<s.height)return a=Math.max(0,o.left-s.left),i=Math.max(0,o.top-s.top),r=Math.min(s.width,o.right-s.left),n=Math.min(s.height,o.bottom-s.top),Math.round(a)+`,${Math.round(s.height-n)},${Math.round(r)},`+Math.round(s.height-i)}catch(e){}return"0,0,0,0"}createDragPreview(e){var t=document.createElement("div");return t.style.cssText=`
            position: absolute;
            top: -1000px;
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10000;
        `,t.textContent=50<e.length?e.substring(0,50)+"...":e,this.domManager.addDragPreview(t),t}createDragAssistButton(d,h,p,u){if(!this.checkPluginActivation())return;if(!this.isTouchDevice())return;if(document.querySelectorAll(".pdfflow-drag-assist-button").forEach(e=>{e._autoRemoveTimer&&clearTimeout(e._autoRemoveTimer),e.remove()}),!h||0===h.rangeCount)return;let e=h.getRangeAt(0);var t=e.getClientRects();if(0===t.length)return;t=t[t.length-1];let g=document.createElement("div"),a=(g.className="pdfflow-drag-assist-button",g.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-hand-icon lucide-hand"><path d="M18 11V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2"/><path d="M14 10V4a2 2 0 0 0-2-2a2 2 0 0 0-2 2v2"/><path d="M10 10.5V6a2 2 0 0 0-2-2a2 2 0 0 0-2 2v8"/><path d="M18 8a2 2 0 1 1 4 0v6a8 8 0 0 1-8 8h-2c-2.8 0-4.5-.86-5.99-2.34l-3.6-3.6a2 2 0 0 1 2.83-2.82L7 15"/></svg>
        `,g.style.cssText=`
            left: ${t.right+8}px;
            top: ${t.top-2}px;
            user-select: none;
            -webkit-user-select: none;
            -webkit-touch-callout: none;
            draggable: true;
        `,g.title="ÁÇπÂáªËèúÂçïÊàñÊãñÊãΩÂà∞Canvas/Excalidraw",g.addEventListener("mouseenter",()=>{g.style.transform="scale(1.1)",g.style.background="rgba(0, 100, 180, 0.95)"}),g.addEventListener("mouseleave",()=>{g.style.transform="scale(1)",g.style.background="rgba(0, 122, 204, 0.9)"}),e=>{e.preventDefault(),e.stopPropagation(),this.hideContextMenu();let t=window.getSelection();if(t&&t.toString().trim()){let e={range:t.getRangeAt(0).cloneRange(),text:t.toString().trim()};g._restoreSelection=()=>{try{t.removeAllRanges(),t.addRange(e.range)}catch(e){}}}let i=document.createElement("div");i.className="pdfflow-button-context-menu",i.style.cssText=`
                position: fixed;
                background: var(--background-primary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                z-index: 100001;
                padding: 4px 0;
                min-width: 180px;
                animation: contextMenuSlideIn 0.15s ease-out;
            `;var e=[{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="7" height="9" x="3" y="3" rx="1"/>
                        <rect width="7" height="5" x="14" y="3" rx="1"/>
                        <rect width="7" height="9" x="14" y="12" rx="1"/>
                        <rect width="7" height="5" x="3" y="16" rx="1"/>
                    </svg>`,text:"Ê∑ªÂä†Âà∞CanvasÊñáÊ°£",action:()=>this.addToCanvasFromContextSilent(d,h,p,u)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>`,text:"Ê∑ªÂä†Âà∞ExcalidrawÊñáÊ°£(ÁõÆÂâç‰∏çÊîØÊåÅÔºâ",action:()=>this.addToExcalidrawFromContextSilent(d,h,p,u)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>`,text:"Ê∑ªÂä†Âà∞MarkdownÊñáÊ°£",action:()=>this.addToMarkdownFromContextSilent(d,h,p,u)}],a=(e.forEach((t,e)=>{let a=document.createElement("div");a.className="pdfflow-context-menu-item",a.style.cssText=`
                    padding: 8px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    color: var(--text-normal);
                    font-size: 14px;
                    transition: background-color 0.2s ease;
                `,a.innerHTML=t.icon+`<span>${t.text}</span>`,a.addEventListener("mouseenter",()=>{a.style.backgroundColor="var(--background-modifier-hover)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="transparent"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.hideContextMenu(),g._restoreSelection&&setTimeout(()=>{g._restoreSelection()},50),t.action()}),a.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),this.hideContextMenu(),g._restoreSelection&&setTimeout(()=>{g._restoreSelection()},50),t.action()}),i.appendChild(a)}),g.getBoundingClientRect()),e=40*e.length+8,r=window.innerWidth||document.documentElement.clientWidth,n=window.innerHeight||document.documentElement.clientHeight;let o=a.right+8,s=a.top,l=(o+180>r-10&&(o=a.left-180-8),s+e>n-10&&(s=a.bottom-e),o=Math.max(10,Math.min(o,r-180-10)),s=Math.max(10,Math.min(s,n-e-10)),(o<10||s<10||o+180>r||s+e>n)&&(o=Math.max(10,(r-180)/2),s=Math.max(10,(n-e)/2)),i.style.left=o+"px",i.style.top=s+"px",document.body.appendChild(i),this.isTouchDevice()&&(i.offsetHeight,(a=i.getBoundingClientRect()).left<10||a.top<10||a.right>r||a.bottom>n)&&(i.style.left=Math.max(10,(r-180)/2)+"px",i.style.top=Math.max(10,(n-e)/2)+"px"),this.currentContextMenu=i,e=>{i.contains(e.target)||g.contains(e.target)||(this.hideContextMenu(),document.removeEventListener("click",l),document.removeEventListener("contextmenu",l))}),c=(setTimeout(()=>{document.addEventListener("click",l),document.addEventListener("contextmenu",l)},100),e=>{"Escape"===e.key&&(this.hideContextMenu(),document.removeEventListener("keydown",c))});document.addEventListener("keydown",c),i._closeHandler=l,i._escHandler=c}),i=(g.addEventListener("click",a),null),r,n=!1;g.addEventListener("touchstart",e=>{g.style.transform="scale(0.95)",g.style.background="rgba(0, 100, 180, 0.95)";e=e.touches[0];i={x:e.clientX,y:e.clientY},r=Date.now(),n=!1},{passive:!1}),g.addEventListener("touchmove",e=>{var t;i&&(t=e.touches[0],t=Math.sqrt(Math.pow(t.clientX-i.x,2)+Math.pow(t.clientY-i.y,2)),(this.isMacOS()?25:10)<t)&&!n&&(n=!0,k(e))},{passive:!1}),g.addEventListener("touchend",e=>{g.style.transform="scale(1)",g.style.background="rgba(0, 122, 204, 0.9)",n?T(e):(e.preventDefault(),e.stopPropagation(),setTimeout(()=>{a(e)},50)),i=null,n=!1},{passive:!1});t=u.file;if(!t)return;let o;if(h&&0<h.rangeCount){let e=h.getRangeAt(0);var s=p.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]");o=s&&(s=this.filterValidTextRange(e,s))?((l=window.getSelection()).removeAllRanges(),l.addRange(s),this.getPageInfoFromSelection(l,p)):this.getPageInfoFromSelection(h,p)}else o=this.getPageInfoFromSelection(h,p);var s={text:d,file:t,pageInfo:o,type:"text"},l=d.substring(0,100),t=(this.dragDataStorage.set(l,s),100<d.length&&this.dragDataStorage.set(d,s),Date.now()+"_"+d.substring(0,50));this.dragDataStorage.set(t,s),this.lastDragData=s;let c=e=>{e.preventDefault(),e.stopPropagation(),window.getSelection&&window.getSelection().removeAllRanges(),e.dataTransfer.setData("text/plain",d),e.dataTransfer.effectAllowed="copy";let t=this.createDragPreview(d);document.body.appendChild(t),e.dataTransfer.setDragImage(t,0,0),this.timerManager.addTimeout(()=>{this.domManager.removeDragPreview(t)},0),g.parentNode&&g.remove()},f=(g.addEventListener("dragstart",c),!1),m=null,v=0,w={x:0,y:0},y=!1,x=t=>{t.preventDefault(),t.stopPropagation(),v=Date.now(),w={x:t.clientX,y:t.clientY},y=!0;var e=this.isTouchDevice()?200:150,e=setTimeout(()=>{var e;y&&(e={x:t.clientX,y:t.clientY},e=Math.sqrt(Math.pow(e.x-w.x,2)+Math.pow(e.y-w.y,2)),(this.isMacOS()?20:10)<e)&&(f=!0,y=!1,window.getSelection&&window.getSelection().removeAllRanges(),(m=document.createElement("div")).className="pdfflow-custom-drag-preview",m.style.cssText=`
                            position: fixed;
                            background: #2d3748;
                            color: white;
                            padding: 8px 12px;
                            border-radius: 4px;
                            font-size: 12px;
                            max-width: 200px;
                            word-wrap: break-word;
                            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                            z-index: 10000;
                            pointer-events: none;
                            transform: translate(-50%, -50%);
                        `,e=30<d.length?d.substring(0,30)+"...":d,m.textContent="ÊñáÂ≠óÁâáÊÆµ: "+e,document.body.appendChild(m),this.domManager.addDragPreview(m),m.style.left=t.clientX+"px",m.style.top=t.clientY-50+"px",g.parentNode)&&g.remove()},e);g._dragTimeout=e},b=e=>{var t,a;f?(e.preventDefault(),e.stopPropagation(),m&&(m.style.left=e.clientX+"px",m.style.top=e.clientY+"px"),t=(a=document.elementFromPoint(e.clientX,e.clientY))?.closest("[data-pdfflow-drop-listener]"),a=a?.closest("[data-pdfflow-excalidraw-listener]"),document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),a?a.classList.add("pdfflow-excalidraw-drag-over"):t&&t.classList.add("pdfflow-drag-over")):(a=Math.sqrt(Math.pow(e.clientX-w.x,2)+Math.pow(e.clientY-w.y,2)),(this.isMacOS()?20:10)<a&&y&&(y=!1,f=!0,window.getSelection&&window.getSelection().removeAllRanges(),(m=document.createElement("div")).className="pdfflow-custom-drag-preview",m.style.cssText=`
                        position: fixed;
                        background: #2d3748;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        max-width: 200px;
                        word-wrap: break-word;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        z-index: 10000;
                        pointer-events: none;
                        transform: translate(-50%, -50%);
                    `,t=30<d.length?d.substring(0,30)+"...":d,m.textContent="ÊñáÂ≠óÁâáÊÆµ: "+t,document.body.appendChild(m),this.domManager.addDragPreview(m),m.style.left=e.clientX+"px",m.style.top=e.clientY+"px",g.parentNode)&&g.remove())},C=e=>{if(g._dragTimeout&&(clearTimeout(g._dragTimeout),g._dragTimeout=null),!f){if(!w||void 0===w.x||void 0===w.y)return void(y=!1);if(Math.sqrt(Math.pow(e.clientX-w.x,2)+Math.pow(e.clientY-w.y,2))<=10&&y)return void(y=!1)}if(f){e.preventDefault(),e.stopPropagation(),f=!1;var t=e.clientX,e=e.clientY,a=(m&&(this.domManager.removeDragPreview(m),m=null),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),this.cleanupDragPreviews(),document.elementFromPoint(t,e));if(a){var i,r=a.closest("[data-pdfflow-drop-listener]"),n=a.closest("[data-pdfflow-excalidraw-listener]"),a=r||n;if(document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),a){if(n)for(i of this.app.workspace.getLeavesOfType("excalidraw"))if(i.view&&i.view.containerEl===n){this.app.workspace.setActiveLeaf(i,!0,!0);break}var r=new CustomEvent("drop",{bubbles:!0,cancelable:!0}),o=(r.dataTransfer={getData:e=>d,types:["text/plain"],files:[]},a.getBoundingClientRect()),s=t-o.left,o=e-o.top;r.clientX=t,r.clientY=e,r.preciseClientX=t,r.preciseClientY=e,r.offsetX=s,r.offsetY=o,r._isTextDrag=!0,a.dispatchEvent(r)}}}},E=a=>{a.preventDefault(),a.stopPropagation();var e=a.touches[0],e=(w={x:e.clientX,y:e.clientY},y=!0,setTimeout(()=>{var e=this.isMacOS()?20:10,t=a.touches[0];e<Math.sqrt(Math.pow(t.clientX-w.x,2)+Math.pow(t.clientY-w.y,2))&&y&&(f=!0,y=!1,window.getSelection&&window.getSelection().removeAllRanges(),(m=document.createElement("div")).className="pdfflow-custom-drag-preview",m.style.cssText=`
                        position: fixed;
                        background: #2d3748;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        max-width: 200px;
                        word-wrap: break-word;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        z-index: 10000;
                        pointer-events: none;
                        transform: translate(-50%, -50%);
                    `,e=30<d.length?d.substring(0,30)+"...":d,m.textContent="ÊñáÂ≠óÁâáÊÆµ: "+e,document.body.appendChild(m),this.domManager.addDragPreview(m),m.style.left=t.clientX+"px",m.style.top=t.clientY+"px",g.parentNode)&&g.remove()},250));g._touchDragTimeout=e},k=t=>{if(f){if(t.preventDefault(),t.stopPropagation(),m){let e=t.touches[0];m.style.left=e.clientX+"px",m.style.top=e.clientY+"px"}let e=t.touches[0];var a=document.elementFromPoint(e.clientX,e.clientY),i=a?.closest("[data-pdfflow-drop-listener]"),a=a?.closest("[data-pdfflow-excalidraw-listener]");document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),a?a.classList.add("pdfflow-excalidraw-drag-over"):i&&i.classList.add("pdfflow-drag-over")}else{let e=t.touches[0];a=Math.sqrt(Math.pow(e.clientX-w.x,2)+Math.pow(e.clientY-w.y,2));void((this.isMacOS()?20:10)<a&&y&&(y=!1,f=!0,window.getSelection&&window.getSelection().removeAllRanges(),(m=document.createElement("div")).className="pdfflow-custom-drag-preview",m.style.cssText=`
                        position: fixed;
                        background: #2d3748;
                        color: white;
                        padding: 8px 12px;
                        border-radius: 4px;
                        font-size: 12px;
                        max-width: 200px;
                        word-wrap: break-word;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.3);
                        z-index: 10000;
                        pointer-events: none;
                        transform: translate(-50%, -50%);
                    `,i=30<d.length?d.substring(0,30)+"...":d,m.textContent="ÊñáÂ≠óÁâáÊÆµ: "+i,document.body.appendChild(m),this.domManager.addDragPreview(m),m.style.left=e.clientX+"px",m.style.top=e.clientY+"px",g.parentNode)&&g.remove())}},T=t=>{if(g._touchDragTimeout&&(clearTimeout(g._touchDragTimeout),g._touchDragTimeout=null),!f){let e=t.changedTouches[0];if(Math.sqrt(Math.pow(e.clientX-w.x,2)+Math.pow(e.clientY-w.y,2))<=10&&y)return void(y=!1)}if(f){t.preventDefault(),t.stopPropagation(),f=!1;let e=t.changedTouches[0];var a,t=e.clientX,i=e.clientY,r=(m&&(this.domManager.removeDragPreview(m),m=null),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),this.cleanupDragPreviews(),document.elementFromPoint(t,i)),n=r?.closest("[data-pdfflow-drop-listener]"),o=r?.closest("[data-pdfflow-excalidraw-listener]"),r=n||o;if(document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over","pdfflow-excalidraw-drag-over")}),r){if(o)for(a of this.app.workspace.getLeavesOfType("excalidraw"))if(a.view&&a.view.containerEl===o){this.app.workspace.setActiveLeaf(a,!0,!0);break}n=new CustomEvent("drop",{bubbles:!0,cancelable:!0});n.dataTransfer={getData:e=>d,types:["text/plain"],files:[]},n.clientX=t,n.clientY=i,n.preciseClientX=t,n.preciseClientY=i,n._isTextDrag=!0,r.dispatchEvent(n)}}};g.addEventListener("mousedown",x),document.addEventListener("mousemove",b),document.addEventListener("mouseup",C),g.addEventListener("touchstart",e=>{g.style.transform="scale(0.95)",g.style.background="rgba(0, 100, 180, 0.95)",E(e)},{passive:!1}),g.addEventListener("touchmove",k,{passive:!1}),g.addEventListener("touchend",e=>{g.style.transform="scale(1)",g.style.background="rgba(0, 122, 204, 0.9)",T(e)},{passive:!1}),document.body.appendChild(g);l=this.timerManager.addTimeout(()=>{g.parentNode&&(g.removeEventListener("dragstart",c),g.removeEventListener("mousedown",x),document.removeEventListener("mousemove",b),document.removeEventListener("mouseup",C),g.removeEventListener("touchstart",E),g.removeEventListener("touchmove",k),g.removeEventListener("touchend",T),g._dragTimeout&&clearTimeout(g._dragTimeout),g._touchDragTimeout&&clearTimeout(g._touchDragTimeout),g.remove())},5e3);g._autoRemoveTimer=l}isTouchDevice(){var e="ontouchstart"in window||0<navigator.maxTouchPoints||0<navigator.msMaxTouchPoints||/iPad|iPhone|iPod|Android/i.test(navigator.userAgent),t=/Windows/i.test(navigator.userAgent),a=/Mac/i.test(navigator.userAgent);return e||t||a}isMobileDevice(){try{var e=navigator.userAgent||"",t=navigator.platform||"";return/iPad|iPhone|iPod|Android|Mobile|Tablet/i.test(e)||/iPad|iPhone|iPod/i.test(t)||0<navigator.maxTouchPoints&&/Mac/i.test(t)||"undefined"!=typeof window&&"ontouchstart"in window&&/Mac/i.test(t)||navigator.vendor&&-1<navigator.vendor.indexOf("Apple")&&0<navigator.maxTouchPoints&&!window.MSStream}catch(e){return!1}}isMacOS(){return/Mac|macOS|darwin/i.test(navigator.platform||navigator.userAgent)}cleanupDragPreviews(){[".pdfflow-custom-drag-preview",".pdfflow-drag-preview",'[class*="drag-preview"]'].forEach(e=>{document.querySelectorAll(e).forEach(e=>{this.domManager.removeDragPreview(e)})}),document.querySelectorAll("div").forEach(e=>{!e.style||"fixed"!==e.style.position||"10000"!==e.style.zIndex&&"10001"!==e.style.zIndex||!e.textContent.includes("ÊñáÂ≠óÁâáÊÆµ")&&!e.textContent.includes("PDFÂå∫Âüü")||this.domManager.removeDragPreview(e)}),this.isTouchDevice()&&document.querySelectorAll("div").forEach(e=>{e.style&&"fixed"===e.style.position&&e.style.zIndex&&1e4<=parseInt(e.style.zIndex)&&(e.textContent.includes("PDFÂå∫Âüü")||e.textContent.includes("ÊñáÂ≠óÁâáÊÆµ")||e.className.includes("drag")||e.className.includes("preview"))&&e.parentNode&&e.parentNode.removeChild(e)})}getFileViewType(e){if(!e)return null;var t=e.extension;switch(t){case"md":return"markdown";case"canvas":return"canvas";case"excalidraw":return"excalidraw";case"pdf":return"pdf";default:return e.name.endsWith(".excalidraw.md")?"excalidraw":t}}async getDocTypeFromLinkPath(e){try{var t=this.docTypeCache.get(e);return t&&Date.now()-t.timestamp<this.docTypeCacheTimeout?{type:t.type,color:t.color}:(this.pendingDocTypeCalculations.has(e)||(this.pendingDocTypeCalculations.add(e),this.docTypeCalculationTimeout&&clearTimeout(this.docTypeCalculationTimeout),this.docTypeCalculationTimeout=setTimeout(async()=>{await this.processPendingDocTypeCalculations()},100)),{type:"MD",color:"#4CAF50"})}catch(e){return{type:"MD",color:"#4CAF50"}}}async getDocTypeFromLinkPathSync(t){try{var a=this.docTypeCache.get(t);if(a&&Date.now()-a.timestamp<this.docTypeCacheTimeout)return{type:a.type,color:a.color};let e={type:"MD",color:"#4CAF50"};var i=await this.detectDocTypeDirectly(t);return"MD"!==i.type?e=i:await this.findAndOpenCanvasWithLink(t,!0)?e={type:"CA",color:"#2196F3"}:await this.findAndOpenExcalidrawWithLinkEnhanced(t,!0)&&(e={type:"EX",color:"#FF9800"}),this.docTypeCache.set(t,{type:e.type,color:e.color,timestamp:Date.now()}),e}catch(e){return{type:"MD",color:"#4CAF50"}}}async detectDocTypeDirectly(t){try{if(t.endsWith(".canvas"))return{type:"CA",color:"#2196F3"};if(t.endsWith(".excalidraw")||t.endsWith(".excalidraw.md"))return{type:"EX",color:"#FF9800"};if(!t.endsWith(".md")){var e=t.match(/^(.+?)#(.+)$/);if(e){var[,a]=e,i=this.highlightIndex.get(a);if(i){var r=i.find(e=>e.linkPath===t);if(r&&r.source){if(r.source.endsWith(".canvas"))return{type:"CA",color:"#2196F3"};if(r.source.endsWith(".excalidraw.md"))return{type:"EX",color:"#FF9800"};if(r.source.endsWith(".excalidraw"))return{type:"EX",color:"#FF9800"};if(r.source.endsWith(".md"));}}}}return{type:"MD",color:"#4CAF50"}}catch(e){return{type:"MD",color:"#4CAF50"}}}async processPendingDocTypeCalculations(){try{var t=Array.from(this.pendingDocTypeCalculations);this.pendingDocTypeCalculations.clear();for(let e=0;e<t.length;e+=5){var a=t.slice(e,e+5).map(async e=>{var t=this.docTypeCache.get(e);if(t&&Date.now()-t.timestamp<this.docTypeCacheTimeout)return{linkPath:e,result:{type:t.type,color:t.color}};let a={type:"MD",color:"#4CAF50"};t=await this.detectDocTypeDirectly(e);return"MD"!==t.type?a=t:await this.findAndOpenCanvasWithLink(e,!0)?a={type:"CA",color:"#2196F3"}:await this.findAndOpenExcalidrawWithLinkEnhanced(e,!0)&&(a={type:"EX",color:"#FF9800"}),this.docTypeCache.set(e,{type:a.type,color:a.color,timestamp:Date.now()}),{linkPath:e,result:a}});await Promise.all(a),e+5<t.length&&await new Promise(e=>setTimeout(e,10))}this.updateHighlights()}catch(e){}}clearDocTypeCacheForFile(e){e&&(e.path,"md"!==(e=e.extension)&&"canvas"!==e&&"excalidraw"!==e||(this.docTypeCache&&this.docTypeCache.clear(),this.excalidrawFileCache&&this.excalidrawFileCache.clear(),this.canvasFileCache&&this.canvasFileCache.clear(),this.markdownFileCache&&this.markdownFileCache.clear()))}async batchCalculateDocTypes(){try{var e,t=new Set;for(e of this.highlightIndex.values())for(var a of e)a.linkPath&&t.add(a.linkPath);var i,r,n=new Map,o=Array.from(t);for(let e=0;e<o.length;e+=10){var s,l,c=o.slice(e,e+10).map(async e=>({linkPath:e,docType:await this.getDocTypeFromLinkPath(e)}));for({linkPath:s,docType:l}of await Promise.all(c))n.set(s,l);e+10<o.length&&await new Promise(e=>setTimeout(e,5))}for(i of this.highlightIndex.values())for(var d of i)d.linkPath&&n.has(d.linkPath)?(r=n.get(d.linkPath),d.docType=r.type,d.docTypeColor=r.color):(d.docType="MD",d.docTypeColor="#4CAF50")}catch(e){for(var h of this.highlightIndex.values())for(var p of h)p.docType="MD",p.docTypeColor="#4CAF50"}}async openFileInNewWindow(i){try{let t=null,a=this.isTouchDevice();var e,r=this.getFileViewType(i);for(e of r?this.app.workspace.getLeavesOfType(r):[])if(e.view&&e.view.file&&e.view.file.path===i.path)return e;var n=a?[()=>{try{return this.app.workspace.getLeaf("split","vertical")}catch(e){return null}},()=>{try{var e=this.app.workspace.activeLeaf;if(e&&e.parent)return e.parent.split("vertical",e)}catch(e){}return null},()=>{try{return this.app.workspace.getLeaf("split","horizontal")}catch(e){return null}},()=>{try{var e=this.app.workspace.rootSplit;if(e&&e.children&&0<e.children.length){var t=e.children[0];if(t&&t.split)return t.split("vertical")}}catch(e){}return null},()=>this.app.workspace.getLeaf("tab")]:[()=>this.app.workspace.getLeaf("split","vertical"),()=>this.app.workspace.getLeaf("split","horizontal"),()=>this.app.workspace.getLeaf("tab")],o=[()=>{try{var e=this.app.workspace,t=e.rootSplit;if(t&&t.children&&0<t.children.length){var a=t.children[0];if(a&&a.split)return a.split("vertical")}if(e.createLeafInParent)return e.createLeafInParent(t,0)}catch(e){}return null},()=>this.app.workspace.getLeaf(!1)],s=[...n,...o];for(let e=0;e<s.length;e++)try{if((t=s[e]())&&(await t.openFile(i),t.view&&t.view.file&&t.view.file.path===i.path))return a&&(this.app.workspace.setActiveLeaf(t,!0,!0),await new Promise(e=>setTimeout(e,100))),t}catch(e){continue}if(await(t=this.app.workspace.getLeaf(!1)).openFile(i),t.view&&t.view.file&&t.view.file.path===i.path)return a&&this.app.workspace.setActiveLeaf(t,!0,!0),t;throw new Error("ÊúÄÁªàÂ§áÁî®ÊñπÊ°à‰πüÂ§±Ë¥•‰∫Ü")}catch(e){r=this.app.workspace.activeLeaf||this.app.workspace.getLeaf(!1);try{return await r.openFile(i),isTouchDevice&&this.app.workspace.setActiveLeaf(r,!0,!0),r}catch(e){throw e}}}startCustomDrag(l,i,c,d,h){if(this.checkPluginActivation()){window.getSelection&&window.getSelection().removeAllRanges();document.querySelectorAll(".pdfflow-drag-assist-button").forEach(e=>{e._autoRemoveTimer&&clearTimeout(e._autoRemoveTimer),e.remove()});d=d.file;if(d){let e;e=i&&0<i.rangeCount&&(p=i.getRangeAt(0),u=c.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(p=this.filterValidTextRange(p,u))?((u=window.getSelection()).removeAllRanges(),u.addRange(p),this.getPageInfoFromSelection(u,c)):this.getPageInfoFromSelection(i,c);var p={text:l,file:d,pageInfo:e,type:"text"},u=l.substring(0,100);this.dragDataStorage.set(u,p);let r=document.createElement("div");r.className="pdfflow-custom-drag-preview",r.style.cssText=`
            position: fixed;
            background: #2d3748;
            color: white;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 12px;
            max-width: 200px;
            word-wrap: break-word;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            z-index: 10000;
            pointer-events: none;
            transform: translate(-50%, -50%);
        `;i=30<l.length?l.substring(0,30)+"...":l,c=(r.textContent="ÊñáÂ≠óÁâáÊÆµ: "+i,document.body.appendChild(r),this.domManager.addDragPreview(r),h.clientX||h.touches&&h.touches[0].clientX),d=h.clientY||h.touches&&h.touches[0].clientY;r.style.left=c+"px",r.style.top=d-50+"px";let n=!0,o=e=>{var t,a;n&&(t=e.clientX||e.touches&&e.touches[0].clientX,a=e.clientY||e.touches&&e.touches[0].clientY,r.style.left=t+"px",r.style.top=a-50+"px",e.preventDefault())},s=e=>{var t,a,i;n&&(n=!1,t=e.clientX||e.changedTouches&&e.changedTouches[0].clientX,e=e.clientY||e.changedTouches&&e.changedTouches[0].clientY,r&&this.domManager.removeDragPreview(r),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),this.cleanupDragPreviews(),a=(i=document.elementFromPoint(t,e))?.closest("[data-pdfflow-drop-listener]"),i=i?.closest("[data-pdfflow-excalidraw-listener]"),(a=a||i)&&((i=new CustomEvent("drop",{bubbles:!0,cancelable:!0})).dataTransfer={getData:e=>l,types:["text/plain"],files:[]},i.clientX=t,i.clientY=e,i.preciseClientX=t,i.preciseClientY=e,i._isTextDrag=!0,a.dispatchEvent(i)),document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",o),document.removeEventListener("touchend",s))},t=(document.addEventListener("mousemove",o,{passive:!1}),document.addEventListener("mouseup",s),document.addEventListener("touchmove",o,{passive:!1}),document.addEventListener("touchend",s),this.timerManager.addTimeout(()=>{r&&this.domManager.removeDragPreview(r),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),n=!1,document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",o),document.removeEventListener("touchend",s)},5e3)),a=s;u=e=>{this.timerManager.clearTimeout(t),a(e)};document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",s),document.removeEventListener("touchmove",o),document.removeEventListener("touchend",s),document.addEventListener("mousemove",o,{passive:!1}),document.addEventListener("mouseup",u),document.addEventListener("touchmove",o,{passive:!1}),document.addEventListener("touchend",u)}}}cleanupContainerEventListeners(i){if(i){var e=this.getContainerState(i);let a=0;[{type:"mousedown",handler:"_pdfflowMouseDownHandler"},{type:"mousemove",handler:"_pdfflowMouseMoveHandler"},{type:"mouseup",handler:"_pdfflowMouseUpHandler"},{type:"touchstart",handler:"_pdfflowTouchStartHandler"},{type:"touchmove",handler:"_pdfflowTouchMoveHandler"},{type:"touchend",handler:"_pdfflowTouchEndHandler"}].forEach(({type:e,handler:t})=>{if(i[t])try{i.removeEventListener(e,i[t]),i[t]=null,a++}catch(e){}});if([{type:"dragstart",handler:"_currentDragStartHandler"},{type:"touchstart",handler:"_currentTextTouchStartHandler"},{type:"touchmove",handler:"_currentTextTouchMoveHandler"},{type:"touchend",handler:"_currentTextTouchEndHandler"}].forEach(({type:e,handler:t})=>{if(i[t])try{i.removeEventListener(e,i[t]),i[t]=null,a++}catch(e){}}),i._pdfflowContextMenuHandler)try{i.removeEventListener("contextmenu",i._pdfflowContextMenuHandler),i._pdfflowContextMenuHandler=null,a++}catch(e){}if(i._pdfflowPdfViewerContextMenuHandler)try{var t=i.querySelector(".pdf-viewer")||i.querySelector('[data-type="pdf"]')||i;t&&t!==i&&t.removeEventListener("contextmenu",i._pdfflowPdfViewerContextMenuHandler),i._pdfflowPdfViewerContextMenuHandler=null,a++}catch(e){}if(i._pdfflowMenuCheckInterval)try{clearInterval(i._pdfflowMenuCheckInterval),i._pdfflowMenuCheckInterval=null,a++}catch(e){}if(this.selectionChangeHandler)if(Array.from(this.pdfContainerStates.values()).filter(e=>e.hasListeners).length<=1)try{document.removeEventListener("selectionchange",this.selectionChangeHandler),this.selectionChangeHandler=null,a++}catch(e){}if(i._pdfflowSelectionChangeHandler)try{document.removeEventListener("selectionchange",i._pdfflowSelectionChangeHandler),i._pdfflowSelectionChangeHandler=null,a++}catch(e){}i._pdfflowTimers&&(i._pdfflowTimers.forEach(e=>{try{clearTimeout(e)}catch(e){}}),i._pdfflowTimers=[]),i.removeAttribute("pdfflow-listener"),i.removeAttribute("draggable");["_dragPreview","_floatingButton","_dragHelper"].forEach(e=>{if(i[e])try{i[e].remove&&i[e].remove(),i[e]=null}catch(e){}}),this.updateContainerState(i,{hasListeners:!1,listenerTypes:new Set,cleanupCount:(e.cleanupCount||0)+1,lastCleanupTime:Date.now(),cleanedListenerCount:a})}}generateContainerId(e){return e._pdfflowContainerId||(e._pdfflowContainerId=`pdfflow-container-${++this.containerIdCounter}-`+Date.now()),e._pdfflowContainerId}getContainerState(e){e=this.generateContainerId(e);return this.pdfContainerStates.has(e)||this.pdfContainerStates.set(e,{id:e,hasListeners:!1,listenerTypes:new Set,lastSetupTime:null,cleanupCount:0,setupCount:0}),this.pdfContainerStates.get(e)}updateContainerState(e,t){e=this.getContainerState(e);Object.assign(e,t)}hasActiveListeners(e){return this.getContainerState(e).hasListeners&&e.hasAttribute("pdfflow-listener")}clearAllContainerStates(){this.pdfContainerStates&&this.pdfContainerStates.clear()}removeDragListeners(){document.querySelectorAll("[pdfflow-listener], [pdfflow-drop-listener], [pdfflow-excalidraw-listener]").forEach(e=>{this.cleanupContainerEventListeners(e),e.removeAttribute("pdfflow-listener"),e.removeAttribute("pdfflow-drop-listener"),e.removeAttribute("pdfflow-excalidraw-listener"),e.removeAttribute("data-pdfflow-drop-listener"),e.removeAttribute("data-pdfflow-excalidraw-listener")}),document.querySelectorAll(".pdfflow-floating-button").forEach(e=>{e.classList.remove("pdfflow-countdown-animation"),e.remove()}),document.querySelectorAll(".pdfflow-drag-assist-button").forEach(e=>{e._autoRemoveTimer&&this.timerManager.clearTimeout(e._autoRemoveTimer),e.removeEventListener("dragstart",()=>{}),e.removeEventListener("touchstart",()=>{}),e.removeEventListener("touchmove",()=>{}),e.removeEventListener("touchend",()=>{}),e.remove()}),document.querySelectorAll(".pdfflow-custom-drag-preview").forEach(e=>{this.domManager.removeDragPreview(e)}),document.querySelectorAll(".pdfflow-drag-over, .pdfflow-excalidraw-drag-over").forEach(e=>{e.classList.remove("pdfflow-drag-over"),e.classList.remove("pdfflow-excalidraw-drag-over")}),document.removeEventListener("selectionchange",this.selectionChangeHandler)}addHighlightStyle(){var e=document.createElement("style");e.id="pdf-highlights-page-style",e.innerHTML=`
            div[data-type="pdf"] .page {
                position: relative !important;
            }
            
            .pdfflow-backlink {
                border: 1px solid transparent;
                transition: opacity 0.2s ease, box-shadow 0.2s ease, transform 0.2s ease;
                transform-origin: center;
                box-sizing: border-box;
                transform: translateZ(0);
                vertical-align: baseline;
                line-height: inherit;
            }
            
            .pdfflow-backlink:hover {
                border-color: rgba(0, 0, 0, 0.2);
            }

            .pdfflow-backlink[data-highlight-color="yellow"] {
                background-color: rgba(255, 208, 0, 0.4) !important;
            }
            
            .pdfflow-backlink[data-highlight-color="red"] {
                background-color: rgba(234, 82, 82, 0.4) !important;
            }
            
            .pdfflow-backlink[data-highlight-color="blue"] {
                background-color: rgba(8, 109, 221, 0.4) !important;
            }
            
            .pdfflow-backlink[data-highlight-color="green"] {
                background-color: rgba(77, 203, 92, 0.4) !important;
            }
            
            .pdfflow-backlink[data-highlight-color="purple"] {
                background-color: rgba(156, 39, 176, 0.4) !important;
            }

            .pdf-highlights-layer-container {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 1;
            }
            
            /* Ë£ÅÂâ™Ê®°ÂºèÊ†∑Âºè */
            .pdfflow-rect-selection-mode {
                cursor: crosshair;
            }
            
            .pdfflow-rect-selection-mode * {
                cursor: crosshair;
            }
            
            .pdfflow-rect-overlay {
                border: 2px dashed #007acc !important;
                background-color: rgba(0, 122, 204, 0.1) !important;
                pointer-events: none;
                z-index: 1000;
                position: fixed;
            }
            
            .pdfflow-rect-overlay.draggable {
                border: 2px solid #007acc !important;
                background-color: rgba(0, 122, 204, 0.2) !important;
                pointer-events: auto;
                cursor: grab;
            }
            
            .pdfflow-rect-overlay.draggable:hover {
                border: 2px solid #0066cc !important;
                background-color: rgba(0, 122, 204, 0.3) !important;
            }
            
            .pdfflow-rect-overlay.draggable:active {
                cursor: grabbing;
            }
            
            /* Excalidraw ÊãñÊãΩÊÇ¨ÂÅúÊ†∑Âºè */
            .pdfflow-excalidraw-drag-over {
                border: 2px dashed #007acc !important;
                background-color: rgba(0, 122, 204, 0.1) !important;
                opacity: 0.9 !important;
            }
            
            .pdfflow-excalidraw-drag-over::after {
                content: "ÊãñÊãΩÂà∞ Excalidraw ÁîªÂ∏É";
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: rgba(0, 122, 204, 0.9);
                color: white;
                padding: 8px 16px;
                border-radius: 4px;
                font-size: 14px;
                font-weight: bold;
                z-index: 1001;
                pointer-events: none;
            }

            /* È´ò‰∫ÆÈÄâÊã©Âô®‰∏ãÊãâÂàóË°®Ê†∑Âºè */
            .pdfflow-highlight-dropdown {
                scrollbar-width: thin;
                scrollbar-color: var(--scrollbar-thumb-bg) var(--scrollbar-bg);
                position: fixed !important;
                z-index: 100000 !important;
            }
            
            .pdfflow-highlight-dropdown::-webkit-scrollbar {
                width: 6px;
            }
            
            .pdfflow-highlight-dropdown::-webkit-scrollbar-track {
                background: var(--scrollbar-bg);
                border-radius: 3px;
            }
            
            .pdfflow-highlight-dropdown::-webkit-scrollbar-thumb {
                background: var(--scrollbar-thumb-bg);
                border-radius: 3px;
            }
            
            .pdfflow-highlight-dropdown::-webkit-scrollbar-thumb:hover {
                background: var(--scrollbar-thumb-bg-hover);
            }

            .pdfflow-highlight-item:last-child {
                border-bottom: none;
            }

            .pdfflow-highlight-item:hover {
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            }

            /* È´ò‰∫ÆÈÄâÊã©Âô®Âä®Áîª */
            .pdfflow-highlight-dropdown {
                animation: slideDown 0.2s ease-out;
                transform-origin: top;
            }

            @keyframes slideDown {
                from {
                    opacity: 0;
                    transform: translateY(-10px) scaleY(0.8);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scaleY(1);
                }
            }

            /* ÂìçÂ∫îÂºèËÆæËÆ° */
            @media (max-width: 600px) {
                .pdfflow-highlight-dropdown {
                    min-width: 280px;
                    max-width: 90vw;
                    right: -20px;
                }
            }

            /* È¢úËâ≤ÈÄâÊã©Âô®Ê†∑Âºè */
            .pdfflow-color-selector {
                animation: colorSelectorSlideDown 0.2s ease-out;
                transform-origin: top;
            }

            @keyframes colorSelectorSlideDown {
                from {
                    opacity: 0;
                    transform: translateY(-5px) scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: translateY(0) scale(1);
                }
            }

            .pdfflow-color-option {
                position: relative;
                transition: all 0.2s ease;
            }

            .pdfflow-color-option:hover {
                transform: scale(1.1);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            }

            /* È¢úËâ≤ÂúÜÁÇπÊ†∑Âºè */
            .pdfflow-color-dot {
                transition: all 0.2s ease;
            }

            .pdfflow-color-dot:hover {
                transform: scale(1.2);
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3) !important;
            }
        `,document.head.appendChild(e)}removeHighlightStyle(){var e=document.head.querySelector("#pdf-highlights-page-style");e&&e.remove()}async loadHighlights(){}async buildHighlightIndex(){if(this.isIndexing)return new Promise(e=>{this.indexingQueue.push(e)});this.isIndexing=!0;try{Date.now();this.highlightIndex.clear(),this.fileModificationTimes.clear();var a=this.app.vault.getMarkdownFiles();let t=0;var i;for(let e=0;e<a.length;e+=20){for(i of a.slice(e,e+20))await this.indexFile(i),t++;e+20<a.length&&await new Promise(e=>setTimeout(e,10)),t}for(Date.now();0<this.indexingQueue.length;)this.indexingQueue.shift()()}catch(e){}finally{this.isIndexing=!1}}async indexFile(e){try{var t=await this.app.vault.cachedRead(e),a=e.path,i=e.stat.mtime,r=this.fileModificationTimes.get(a);if(!(r&&i<=r)){this.fileModificationTimes.set(a,i);for(var n,o=/\[\[([^#|\]]+\.pdf)#([^|\]]+)(?:\|[^\]]*)?\]\]/g;null!==(n=o.exec(t));)try{var s=n[1],l=new URLSearchParams(n[2]),c=parseInt(l.get("page"),10),d=l.get("select"),h=l.get("square"),p=l.get("color")||"yellow";if(c){let t=null;if(d&&4===(t=d.split(",").map(e=>parseFloat(e))).length){var u=this.app.metadataCache.getFirstLinkpathDest(s,a);if(u){var g=u.path;this.highlightIndex.has(g)||this.highlightIndex.set(g,[]);let e;e=h?g+`#page=${c}&square=`+h:g+`#page=${c}&select=`+d,p&&(e+="&color="+p);var f={page:c,select:t,color:p,source:a,linkPath:e};this.highlightIndex.get(g).push(f)}}}}catch(e){}}}catch(e){}}async updateIndexForFile(e){Date.now();var t=this.getTotalHighlightCount();this.removeFileFromIndex(e.path),await this.indexFile(e),await this.calculateDocTypesForNewHighlights(e.path,t),this.isCreatingCanvasNode||this.updateHighlightsForAffectedPdfs(e.path),Date.now()}getTotalHighlightCount(){let e=0;for(var t of this.highlightIndex.values())e+=t.length;return e}async calculateMissingDocTypes(t){Date.now();try{var e=t.filter(e=>!e.docType&&e.linkPath);if(0!==e.length){var a,i=new Set;for(a of e)a.linkPath&&i.add(a.linkPath);var r,n,o=new Map,s=Array.from(i);for(let e=0;e<s.length;e+=5){var l,c,d=s.slice(e,e+5).map(async e=>({linkPath:e,docType:await this.getDocTypeFromLinkPath(e)}));for({linkPath:l,docType:c}of await Promise.all(d))o.set(l,c);e+5<s.length&&await new Promise(e=>setTimeout(e,1))}for(r of e)r.linkPath&&o.has(r.linkPath)?(n=o.get(r.linkPath),r.docType=n.type,r.docTypeColor=n.color):(r.docType="MD",r.docTypeColor="#4CAF50");Date.now()}}catch(e){for(var h of t)h.docType||(h.docType="MD",h.docTypeColor="#4CAF50")}}async calculateDocTypesForNewHighlights(t,e){try{var a=this.getTotalHighlightCount();if(!(a<=e)){var i,r,n=[];for([i,r]of this.highlightIndex.entries())for(var o of r)o.source===t&&o.linkPath&&n.push(o);if(0!==n.length){var s,l=new Set;for(s of n)s.linkPath&&l.add(s.linkPath);var c,d,h=new Map,p=Array.from(l);for(let e=0;e<p.length;e+=10){var u,g,f=p.slice(e,e+10).map(async e=>({linkPath:e,docType:await this.getDocTypeFromLinkPath(e)}));for({linkPath:u,docType:g}of await Promise.all(f))h.set(u,g);e+10<p.length&&await new Promise(e=>setTimeout(e,1))}for(c of n)c.linkPath&&h.has(c.linkPath)?(d=h.get(c.linkPath),c.docType=d.type,c.docTypeColor=d.color):(c.docType="MD",c.docTypeColor="#4CAF50")}}}catch(e){for(var[m,v]of this.highlightIndex.entries())for(var w of v)w.source!==t||w.docType||(w.docType="MD",w.docTypeColor="#4CAF50")}}removeFileFromIndex(t){for(var[e,a]of this.highlightIndex.entries()){var i=a.filter(e=>e.source!==t);i.length!==a.length&&this.highlightIndex.set(e,i)}this.fileModificationTimes.delete(t)}async getHighlightsFromMarkdownFiles(e){e=this.highlightIndex.get(e)||[];return this.settings,e}getIndexStats(){return{totalPdfs:this.highlightIndex.size,totalHighlights:Array.from(this.highlightIndex.values()).reduce((e,t)=>e+t.length,0),indexedFiles:this.fileModificationTimes.size,isIndexing:this.isIndexing}}async saveHighlights(){}async scanAllMarkdownFiles(){await this.buildHighlightIndex(),this.updateHighlights()}updateHighlights(){this.app.workspace.getLeavesOfType("pdf").forEach(e=>{this.drawHighlightsForPdfView(e.view)})}updateHighlightsForAffectedPdfs(t){let a=new Set;for(var[e,i]of this.highlightIndex.entries())i.some(e=>e.source===t)&&a.add(e);this.app.workspace.getLeavesOfType("pdf").forEach(e=>{e.view&&e.view.file&&a.has(e.view.file.path)&&this.drawHighlightsForPdfView(e.view)})}async waitForPdfReady(n,o=500){if(!n||!n.containerEl)throw new Error("PDF viewÊàñÂÆπÂô®‰∏çÂ≠òÂú®");let s=Date.now();return new Promise((a,i)=>{let r=()=>{try{var e,t;Date.now()-s>o?a():!n.containerEl||0===(e=n.containerEl.querySelectorAll("div.page")).length||0===(t=e[0].getBoundingClientRect()).width||0===t.height?setTimeout(r,30):a()}catch(e){i(e)}};r()})}async drawHighlightsForPdfView(e){if(e&&e.file&&this.isPluginActivated){var t=e.file.path;let n=await this.getHighlightsFromMarkdownFiles(t);if(n&&0!==n.length){await this.calculateMissingDocTypes(n),await this.waitForPdfReady(e,500).catch(()=>{}),this.clearHighlightsFromView(e.containerEl);t=e.containerEl.querySelectorAll("div.page");if(0!==t.length){let i=[],r=[];t.forEach((e,t)=>{var a=e.getBoundingClientRect();(a.top<window.innerHeight&&0<a.bottom?i:r).push({pageEl:e,pageIndex:t})}),i.forEach(({pageEl:e,pageIndex:t})=>{let a=t+1;t=n.filter(e=>e.page===a);0<t.length&&this.drawHighlightsOnPage(e,t)}),0<r.length&&requestAnimationFrame(()=>{r.forEach(({pageEl:e,pageIndex:t})=>{let a=t+1;t=n.filter(e=>e.page===a);0<t.length&&this.drawHighlightsOnPage(e,t)})}),this.setupPdfContainerObserver(e,n)}}else this.clearHighlightsFromView(e.containerEl)}}setupPdfContainerObserver(t,i){if(t&&t.containerEl){let e=t.viewer?.child;if(e&&e.pdfViewer,this.pdfViewObservers.has(t)){var a=this.pdfViewObservers.get(t);if(a.disconnect&&a.disconnect(),a.pageRenderedHandler&&a.eventBus)try{a.eventBus.off("pagerendered",a.pageRenderedHandler)}catch(e){}}a=new MutationObserver(e=>{e.some(e=>"childList"===e.type&&e.target.classList.contains("page"))&&t.containerEl.querySelectorAll("div.page").forEach((e,t)=>{let a=t+1;t=i.filter(e=>e.page===a);!e.querySelector("."+HIGHLIGHT_LAYER_CLASS+"-container")&&0<t.length&&this.drawHighlightsOnPage(e,t)})});a.observe(t.containerEl,{childList:!0,subtree:!0});try{let e=t.viewer?.child;var r,n=(e?.pdfViewer)?.eventBus;n&&(r=e=>{let t=e.pageNumber,a=e.source?.div;if(a){let e=i.filter(e=>e.page===t);0!==e.length&&(a.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS+"-container").forEach(e=>e.remove()),setTimeout(()=>{this.drawHighlightsOnPage(a,e)},50))}},n.on("pagerendered",r),a.pageRenderedHandler=r,a.eventBus=n)}catch(e){}this.pdfViewObservers.set(t,a)}}clearHighlightsFromView(t){t.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS).forEach(e=>{this.domManager.removeHighlightElement(e)}),t.querySelectorAll("."+HIGHLIGHT_LAYER_CLASS+"-container").forEach(e=>{if(e.querySelectorAll(".pdfflow-backlink").forEach(e=>{this.domManager.removeHighlightElement(e)}),e._pdfflowClickHandler){try{e.removeEventListener("click",e._pdfflowClickHandler)}catch(e){}e._pdfflowClickHandler=null}e.remove()}),t.querySelectorAll(".pdfflow-highlight-overlay").forEach(e=>{for(;e.firstChild;)this.domManager.removeHighlightElement(e.firstChild);e._cleanup&&e._cleanup(),e.remove()}),document.querySelectorAll(".pdfflow-highlight-overlay").forEach(e=>{if(e._pdfView&&e._pdfView.containerEl===t){for(;e.firstChild;)this.domManager.removeHighlightElement(e.firstChild);e._cleanup&&e._cleanup(),e.remove()}})}drawHighlightsOnPage(h,p){let u=h.getBoundingClientRect();var e=u.width,i=u.height;if(0!==e&&0!==i){let d=h.querySelector("."+HIGHLIGHT_LAYER_CLASS+"-container");if(d)for(;d.firstChild;)this.domManager.removeHighlightElement(d.firstChild);else{(d=document.createElement("div")).className=HIGHLIGHT_LAYER_CLASS+"-container",d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.pointerEvents="none",d.style.zIndex="1",h.appendChild(d);e=e=>{if(e.ctrlKey||e.metaKey){var t=e.target.closest(".pdfflow-backlink");if(t){var a=t.dataset.linkPath,i=t.dataset.source,r=t.dataset.page?parseInt(t.dataset.page,10):void 0,t=t.dataset.color;if(a||i){e.preventDefault(),e.stopPropagation();e={linkPath:a,source:i,page:r,color:t};try{this.openBacklinkFromHighlight(e)}catch(e){}}}}};d.addEventListener("click",e),d._pdfflowClickHandler=e}if(0<p.length){i=h.querySelector(".textLayer");let l=[],t=(i&&(l=Array.from(i.querySelectorAll("span")).filter(e=>e.textContent&&e.textContent.trim())),50),c=0,a=()=>{for(var e=c;c<p.length&&c-e<t;){var r=p[c];try{let e,t,a,i;if(Array.isArray(r.select))[e,t,a,i]=r.select;else{if("string"!=typeof r.select){c++;continue}var n=r.select.split(",").map(Number);if(!(4<=n.length)){c++;continue}[e,t,a,i]=n}var o=`highlight_${r.page}_${c}_`+Date.now(),s={...r,highlightId:o};this.createPreciseHighlight(h,l,e,t,a,i,r.color,u,s,d)}catch(e){}c++}c<p.length&&window.requestAnimationFrame(a)};a()}h._canvasNoteDblClickHandler&&h.removeEventListener("dblclick",h._canvasNoteDblClickHandler);e=e=>{var a,t=Array.from(h.querySelectorAll(".pdfflow-backlink")),i=e.clientX,r=e.clientY;for(a of t){var n=a.getBoundingClientRect();if(i>=n.left&&i<=n.right&&r>=n.top&&r<=n.bottom){var o=a.getAttribute("data-highlight-id");let t=null;for(let e=0;e<p.length;e++){var s=p[e],l=`highlight_${s.page}_${e}_`;if(o&&o.includes(l)){t=s;break}}if(t)return e.preventDefault(),e.stopPropagation(),void this.openBacklinkFromHighlight(t)}}};h.addEventListener("dblclick",e),h._canvasNoteDblClickHandler=e}}createPreciseHighlight(t,e,a,i,r,n,o,s,l=null,c=null){var d;if(e&&0!==e.length&&!(a>=e.length||r>=e.length))try{var h=c||((d=document.createElement("div")).className=HIGHLIGHT_LAYER_CLASS+"-container",d.style.position="absolute",d.style.top="0",d.style.left="0",d.style.width="100%",d.style.height="100%",d.style.pointerEvents="none",d.style.zIndex="1",d);if(window.pdfjsLib&&window.pdfjsLib.setLayerDimensions)try{var p,u,g,f=parseInt(t.getAttribute("data-page-number"));if(f){let e=null;t._viewport?e=t._viewport:(p=t.closest('.pdf-viewer, [data-type="pdf"]'))&&p._pdfViewer&&(u=p._pdfViewer).getPageView&&(g=u.getPageView(f-1))&&g.viewport&&(e=g.viewport),e&&window.pdfjsLib.setLayerDimensions(h,e)}}catch(e){}a===r?this.highlightWithinSingleSpan(e[a],i,n,o,s,h,l):this.highlightAcrossMultipleSpans(e,a,i,r,n,o,s,h,l),c||t.appendChild(h)}catch(e){}}highlightWithinSingleSpan(t,e,a,i,r,n,o=null){if(t&&t.textContent){var s=t.textContent;t.getBoundingClientRect();try{var l=document.createRange(),c=this.getFirstTextNode(t);if(c){var d=Math.max(0,Math.min(e,s.length)),h=Math.max(d,Math.min(a,s.length)),p=(l.setStart(c,d),l.setEnd(c,h),l.getClientRects()),u=this.mergeOverlappingRects(Array.from(p));for(let e=0;e<u.length;e++){var g,f=u[e];0<f.width&&0<f.height&&(g=this.optimizeHighlightRect(f,t,r),this.createHighlightElement(g,i,r,n,o))}l.detach()}}catch(e){this.createFallbackHighlight(t,i,r,n,o)}}}highlightAcrossMultipleSpans(e,i,r,n,o,t,a,s,l=null){try{var c=[];for(let a=i;a<=n;a++){var d=e[a];if(d){let e=0,t=d.textContent?d.textContent.length:0;if(a===i&&(e=r),a===n&&(t=o),e<t)try{var h,p,u,g=document.createRange(),f=this.getFirstTextNode(d);f&&(h=Math.max(0,Math.min(e,d.textContent.length)),p=Math.max(h,Math.min(t,d.textContent.length)),g.setStart(f,h),g.setEnd(f,p),u=g.getClientRects(),c.push(...Array.from(u)),g.detach())}catch(e){}}}var m=this.mergeOverlappingRects(c);for(let e=0;e<m.length;e++){var v,w,y=m[e];0<y.width&&0<y.height&&(v=e===m.length-1,w=l?{...l,source:v?l.source:null}:null,this.createHighlightElement(y,t,a,s,w))}}catch(e){}}mergeOverlappingRects(i){if(!i||0===i.length)return[];if(1===i.length)return i;try{var r=[...i].sort((e,t)=>e.top-t.top),e=i.map(e=>e.height).sort((e,t)=>e-t);let t=e[Math.floor(e.length/2)];var n=i.filter(e=>e.height>=.3*t&&e.height<=3*t),o=0<n.length?n.reduce((e,t)=>e+t.height,0)/n.length:t,s=[];let a=[r[0]];for(let e=1;e<r.length;e++){var l=r[e],c=Math.min(...a.map(e=>e.top)),d=Math.max(...a.map(e=>e.top+e.height)),h=l.top+l.height,p=Math.max(c,l.top),u=Math.min(d,h);.4<Math.max(0,u-p)/o?a.push(l):(s.push(this.mergeRectsInSameLine(a,o)),a=[l])}return 0<a.length&&s.push(this.mergeRectsInSameLine(a,o)),s}catch(e){return i}}mergeRectsInSameLine(e,t=null){if(1===e.length)return e[0];var e=[...e].sort((e,t)=>e.left-t.left),i=e.map(e=>e.height).sort((e,t)=>e-t);let a=i[Math.floor(i.length/2)];i=e.filter(e=>e.height>=.5*a);let r,n,o,s,l;if(0<i.length){r=Math.min(...e.map(e=>e.left)),n=Math.max(...e.map(e=>e.left+e.width)),o=Math.min(...i.map(e=>e.top)),s=Math.max(...i.map(e=>e.top+e.height));let a=i.reduce((e,t)=>e+t.width,0);i=i.reduce((e,t)=>e+t.height*(t.width/a),0);l=i,t&&(l=Math.max(.8*t,Math.min(l,1.2*t)))}else r=Math.min(...e.map(e=>e.left)),n=Math.max(...e.map(e=>e.left+e.width)),o=Math.min(...e.map(e=>e.top)),s=Math.max(...e.map(e=>e.top+e.height)),l=a;return{left:r,top:o,width:n-r,height:l}}createHighlightElement(e,t,a,i,r=null){var n=document.createElement("div"),o=(n.className="pdfflow-backlink "+HIGHLIGHT_LAYER_CLASS,r&&r.color&&n.setAttribute("data-highlight-color",r.color),r&&r.highlightId&&n.setAttribute("data-highlight-id",r.highlightId),r&&(r.linkPath&&(n.dataset.linkPath=r.linkPath),r.source&&(n.dataset.source=r.source),void 0!==r.page&&(n.dataset.page=String(r.page)),r.color)&&(n.dataset.color=String(r.color)),(e.left-a.left)/a.width*100),s=(e.top-a.top)/a.height*100,l=e.width/a.width*100,e=e.height/a.height*100,o=(n.style.position="absolute",n.style.left=o+"%",n.style.top=s+"%",n.style.width=l+"%",n.style.height=e+"%",this.getHighlightColor(t));return n.style.backgroundColor=o,n.style.opacity="0.4",n.style.borderRadius="3px",n.style.pointerEvents=this.highlightPointerEventsEnabled?"auto":"none",n.style.mixBlendMode="multiply",n.style.boxSizing="border-box",n.style.transform="translateZ(0)",r&&(n.style.cursor="pointer",n.style.transition="opacity 0.2s ease, box-shadow 0.2s ease",n.style.zIndex="10"),i.appendChild(n),this.domManager.addHighlightElement(n),r&&r.source&&this.addCommentButton(n,r,a),n}async addCommentButton(e,i,t){try{let t=await this.getCommentsForHighlight(i),a=document.createElement("div");a.className="pdfflow-comment-button",a.innerHTML=`
                <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-more">
                    <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
                    <path d="M8 12h.01"/>
                    <path d="M12 12h.01"/>
                    <path d="M16 12h.01"/>
                </svg>
            `,t&&0<t.length?(a.title=`Êü•ÁúãËØÑËÆ∫ (${t.length}Êù°)`,a.style.background="rgba(239, 2, 2, 0.5)"):(a.title="Ê∑ªÂä†ËØÑËÆ∫",a.style.background="rgba(147, 138, 138, 0.1)"),a.style.opacity="1",a.style.transform="translateZ(0)";var r=()=>{a.style.transform="scale(1.1)",t&&0<t.length?a.style.background="rgba(239, 2, 2, 1)":a.style.background="rgba(239, 2, 2, 0.6)"},n=()=>{a.style.transform="scale(1)",t&&0<t.length?a.style.background="rgba(239, 2, 2, 0.5)":a.style.background="rgba(147, 138, 138, 0.1)"};e.addEventListener("mouseenter",r),e.addEventListener("mouseleave",n),a.addEventListener("mouseenter",r),a.addEventListener("mouseleave",n),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showCommentPopup(a,t,i)}),e.appendChild(a)}catch(e){}}async getCommentsForHighlight(e){try{var t,a,i;return e.source?(t=this.app.vault.getAbstractFileByPath(e.source))&&(a=await this.app.vault.cachedRead(t),i=this.extractNoteTitleFromContent(a,e.linkPath))?this.extractCommentsFromYAML(a,i):null:null}catch(e){return null}}extractCommentsFromYAML(r,n){try{var o=r.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(!o)return null;var s=o[1],l=[new RegExp(`^Note${n}:\\s*$`,"m"),new RegExp(`^Note${n}:\\s*\\[\\s*$`,"m"),new RegExp(`^Note${n}:\\s*\\{\\s*$`,"m")];let e=null;var c;let t=0;for(c of l)if(e=s.match(c)){var d=e.index,h=s.substring(0,d).split("\n").pop();t=h?h.match(/^\s*/)[0].length:0;break}if(!e)return null;var p=s.split("\n"),u=[];let a=!1,i=t;for(let e=0;e<p.length;e++){var g=p[e],f=g.trim(),m=g.match(/^\s*/)[0].length;if(g.match(new RegExp(`^Note${n}:\\s*$`))||g.match(new RegExp(`^Note${n}:\\s*\\[\\s*$`))||g.match(new RegExp(`^Note${n}:\\s*\\{\\s*$`)))a=!0,i=m;else if(a){if(!(!(m<=i&&""!==f)||g.startsWith(" ")||f.startsWith("-")||f.startsWith("*")||f.startsWith("[")||f.startsWith("]")||f.startsWith("{")||f.startsWith("}")))break;if(f.startsWith("-")||f.startsWith("*")){let e=f.substring(1).trim();(e=(e=e.replace(/^["']|["']$/g,"")).replace(/,\s*$/,""))&&u.push(e)}if("]"===f||"}"===f)break}}return 0<u.length?u:null}catch(e){return null}}async addCommentToYAML(e,t){try{if(!e.source)throw new Error("Êó†Ê≥ïÊâæÂà∞Ê∫êÊñá‰ª∂");var a=this.app.vault.getAbstractFileByPath(e.source);if(!a)throw new Error("Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®");var i=await this.app.vault.cachedRead(a),r=this.extractNoteTitleFromContent(i,e.linkPath);if(!r)throw new Error("Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÁ¨îËÆ∞Ê†áÈ¢ò");var n=this.updateYAMLWithComment(i,r,t);await this.app.vault.modify(a,n)}catch(e){throw e}}async deleteCommentFromYAML(e,t,a){try{if(!e.source)throw new Error("Êó†Ê≥ïÊâæÂà∞Ê∫êÊñá‰ª∂");var i=this.app.vault.getAbstractFileByPath(e.source);if(!i)throw new Error("Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®");var r=await this.app.vault.cachedRead(i),n=this.extractNoteTitleFromContent(r,e.linkPath);if(!n)throw new Error("Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÁ¨îËÆ∞Ê†áÈ¢ò");var o=this.removeCommentFromYAML(r,n,t,a);await this.app.vault.modify(i,o)}catch(e){throw e}}showTagInput(t,a,i){var e=document.querySelector(".pdfflow-tag-input-popup");if(e)return void e.remove();let r=document.createElement("div");r.className="pdfflow-tag-input-popup";e=document.createElement("div");e.className="pdfflow-tag-input-row";let n=document.createElement("input"),o=(n.type="text",n.className="pdfflow-tag-input",n.placeholder="ÊîØÊåÅÂ§ö‰∏™Ê†áÁ≠æÔºåÁî®Á©∫Ê†ºÂàÜÈöî",document.createElement("div")),s=(o.className="pdfflow-tag-suggestions",o.style.display="none",document.createElement("button"));s.className="pdfflow-tag-submit-btn",s.textContent="Ê∑ªÂä†",e.appendChild(n),e.appendChild(o),e.appendChild(s),r.appendChild(e);e=t.getBoundingClientRect(),r.style.position="fixed",r.style.left=e.left-55+"px",r.style.top=e.bottom+5+"px",r.style.zIndex="10001",document.body.appendChild(r),e=t.closest(".pdfflow-comment-popup");let l=e&&e._originItem?e._originItem:null,c=()=>{try{var e=this.app.metadataCache.getTags();return Object.keys(e).map(e=>e.startsWith("#")?e:"#"+e)}catch(e){return[]}},d=-1,h=[],p=e=>{o.innerHTML="",h=e,d=-1,0===e.length?o.style.display="none":(e.forEach((e,t)=>{var a=document.createElement("div");a.className="pdfflow-tag-suggestion-item",a.textContent=e,a.addEventListener("click",()=>{g(e)}),o.appendChild(a)}),o.style.display="block")},u=()=>{o.style.display="none",d=-1,h=[]},g=e=>{var t=n.value,a=n.selectionStart,i=t.substring(0,a),t=t.substring(a),a=i.lastIndexOf(" "),a=-1===a?0:a+1,i=i.substring(0,a)+e+" "+t,t=(n.value=i,a+e.length+1);n.setSelectionRange(t,t),u(),n.focus()},f=()=>{o.querySelectorAll(".pdfflow-tag-suggestion-item").forEach((e,t)=>{t===d?e.classList.add("selected"):e.classList.remove("selected")})},m=()=>{var e=n.value,t=n.selectionStart,e=e.substring(0,t),t=e.lastIndexOf(" ");let a=e.substring(t+1);0===a.length?u():(e=c().filter(e=>{var e=e.startsWith("#")?e.substring(1):e,t=a.startsWith("#")?a.substring(1):a;return e.toLowerCase().includes(t.toLowerCase())}).slice(0,10),p(e))},v=e=>{if("none"===o.style.display)"Enter"===e.key&&(e.preventDefault(),w());else switch(e.key){case"ArrowDown":e.preventDefault(),d=Math.min(d+1,h.length-1),f();break;case"ArrowUp":e.preventDefault(),d=Math.max(d-1,-1),f();break;case"Enter":e.preventDefault(),0<=d&&d<h.length?g(h[d]):w();break;case"Escape":e.preventDefault(),u()}},w=(n.addEventListener("input",m),n.addEventListener("keydown",v),async()=>{var e,t=n.value.trim();if(t)try{await this.addTagsToNote(a,t),this.updateTagsDisplay(i,t),l&&(e=l.querySelector(".pdfflow-tags-container"))&&await this.loadExistingTags(a,e),n.removeEventListener("input",m),n.removeEventListener("keydown",v),s.removeEventListener("click",w),r.remove()}catch(e){}}),y=(s.addEventListener("click",w),e=>{r.contains(e.target)||t.contains(e.target)||(n.removeEventListener("input",m),n.removeEventListener("keydown",v),s.removeEventListener("click",w),document.removeEventListener("click",y),r.remove())});setTimeout(()=>{document.addEventListener("click",y),n.focus()},100)}async addTagsToNote(e,t){try{if(!e.source)throw new Error("Êó†Ê≥ïÊâæÂà∞Ê∫êÊñá‰ª∂");var a=this.app.vault.getAbstractFileByPath(e.source);if(!a)throw new Error("Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®");var i=await this.app.vault.cachedRead(a),r=this.extractNoteTitleFromContent(i,e.linkPath);if(!r)throw new Error("Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÁ¨îËÆ∞Ê†áÈ¢ò");var n=this.formatTags(t),o=this.insertTagsIntoNote(i,r,n);await this.app.vault.modify(a,o)}catch(e){throw e}}formatTags(e){return" "+e.split(/\s+/).filter(e=>e.trim()).map(e=>e=e.startsWith("#")?e:"#"+e).join(" ")+" "}insertTagsIntoNote(e,i,r){try{var n=e.split("\n"),o=[];let t=!1,a=!1;for(let e=0;e<n.length;e++){var s,l=n[e],c=[l.match(/^### Note(\d+)/),l.match(/^## Note(\d+)/),l.match(/^# Note(\d+)/)].find(e=>e);c&&c[1]===i?(t=!0,o.push(l)):(t=t&&l.match(/^#{1,3}\s+/)&&!l.includes("Note"+i)?!1:t)&&l.includes("üîó[[")&&!a?(s=l.replace("üîó[[",r+"üîó[["),o.push(s),a=!0):o.push(l)}return o.join("\n")}catch(e){throw e}}updateTagsDisplay(a,e){e.split(/\s+/).filter(e=>e.trim()).forEach(e=>{e.startsWith("#")||(e="#"+e);var t=document.createElement("span");t.className="pdfflow-tag",t.textContent=e,a.appendChild(t)})}async loadExistingTags(e,a){try{if(e.source){var t=this.app.vault.getAbstractFileByPath(e.source);if(t){var i=await this.app.vault.read(t),r=this.extractNoteTitleFromContent(i,e.linkPath);if(r){var n=i.split("\n");let t=!1;for(let e=0;e<n.length;e++){var o=n[e],s=[o.match(/^### Note(\d+)/),o.match(/^## Note(\d+)/),o.match(/^# Note(\d+)/)].find(e=>e);if(s&&s[1]===r)t=!0;else{if(t&&o.match(/^#{1,3}\s+/)&&!o.includes("Note"+r))break;if(t&&o.includes("üîó[[")){var l=o.substring(0,o.indexOf("üîó[[")),c=/#[\w\/\u4e00-\u9fa5]+/g,d=l.match(c);d&&0<d.length&&(a.innerHTML="",d.forEach(e=>{var t=document.createElement("span");t.className="pdfflow-tag",t.textContent=e,a.appendChild(t)}));break}}}}}}}catch(e){}}getTagColor(e){var t=e.startsWith("#")?e.substring(1):e;let a=0;for(let e=0;e<t.length;e++){var i=t.charCodeAt(e);a=(a<<5)-a+i,a&=a}var e=Math.abs(a)%360,r=45+Math.abs(a)%25,n=75+Math.abs(a)%15;return{backgroundColor:`hsl(${e}, ${r}%, ${n}%)`,borderColor:`hsl(${e}, ${10+r}%, ${Math.max(n-15,0)}%)`,hoverColor:`hsl(${e}, ${5+r}%, ${Math.max(n-8,0)}%)`}}async deleteEntireHighlight(t){try{if(!t.source)throw new Error("Êó†Ê≥ïÊâæÂà∞Ê∫êÊñá‰ª∂");var a=this.app.vault.getAbstractFileByPath(t.source);if(!a)throw new Error("Ê∫êÊñá‰ª∂‰∏çÂ≠òÂú®");var i=await this.app.vault.cachedRead(a);let e=t.noteTitle;if(!(e=e||this.extractNoteTitleFromContent(i,t.linkPath)))throw new Error("Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑÁ¨îËÆ∞Ê†áÈ¢ò");var r=this.removeEntireNoteSection(i,e);await this.app.vault.modify(a,r);try{await this.deleteCanvasNodesForNote(t.source,e)}catch(e){}}catch(e){throw e}}async deleteCanvasNodesForNote(t,a){try{var i,r=`![[${t.replace(/\.md$/,"")}#Note${a}]]`,n=this.app.vault.getFiles().filter(e=>"canvas"===e.extension);let e=0;for(i of n)try{var o,s,l=await this.app.vault.cachedRead(i),c=JSON.parse(l);c.nodes&&Array.isArray(c.nodes)&&(o=this.deleteNodesRecursively(c,r),e+=o,0<o)&&(s=JSON.stringify(c,null,2),await this.app.vault.modify(i,s))}catch(e){}}catch(e){throw e}}deleteNodesRecursively(e,t){let a=0;return e&&e.nodes&&Array.isArray(e.nodes)&&(e.nodes.length,e.nodes=e.nodes.filter(e=>"text"===e.type&&e.text&&e.text.includes(t)?(a++,!1):("group"===e.type&&e.collapsed&&e.collapsedData&&e.collapsedData.nodes&&(e=this.deleteNodesRecursively(e.collapsedData,t),a+=e),!0))),a}extractAllCanvasNodes(e){let i=[];if(e&&e.nodes&&Array.isArray(e.nodes)){let a=e=>{for(var t of e)i.push(t),"group"===t.type&&t.collapsed&&t.collapsedData&&t.collapsedData.nodes&&a(t.collapsedData.nodes)};a(e.nodes)}return i}async handleCanvasFileModification(i){try{var e,t;if(this.isUserInitiatedDelete){var r=await this.app.vault.read(i);let a;try{a=JSON.parse(r)}catch(e){return}var n="canvas_"+i.path,o=this.canvasCache?.get(n);if(o){let e;try{e=JSON.parse(o)}catch(e){return void this.canvasCache.set(n,r)}var s,l=this.extractAllCanvasNodes(a),c=this.extractAllCanvasNodes(e);let t=new Set(l.map(e=>e.id));for(s of c.filter(e=>!t.has(e.id)))await this.processDeletedCanvasNode(s,i.path);this.canvasCache.set(n,r),this.isUserInitiatedDelete=!1}else this.canvasCache||(this.canvasCache=new Map),this.canvasCache.set(n,r)}else e=await this.app.vault.read(i),t="canvas_"+i.path,this.canvasCache||(this.canvasCache=new Map),this.canvasCache.set(t,e)}catch(e){}}async processDeletedCanvasNode(e,t){try{if("text"===e.type)for(var a,i=e.text||"",r=/!\[\[([^#]+)#Note([^\]]+)\]\]/g;null!==(a=r.exec(i));){var n=a[1].trim(),o=a[2].trim();await this.performReverseDelete(n,o,t)}}catch(e){}}async performReverseDelete(t,a,i){try{let e=t;var r;e.endsWith(".md")||(e+=".md"),this.app.vault.getAbstractFileByPath(e)&&(r={source:e,linkPath:e,noteTitle:a,triggerSource:"canvas_reverse_delete",canvasPath:i},await this.deleteEntireHighlight(r))}catch(e){}}removeEntireNoteSection(e,t){try{var a=this.removeNoteFieldFromYAML(e,t);return this.removeNoteTitleFromContent(a,t)}catch(e){throw e}}removeNoteFieldFromYAML(e,i){try{var r=e.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(!r)return e;var n=r[1],o=e.substring(0,r.index),s=e.substring(r.index+r[0].length),l=n.split("\n"),c=[];let t=!1,a=-1;for(let e=0;e<l.length;e++){var d=l[e],h=d.trim();if(d.match(new RegExp(`^Note${i}:\\s*$`))||d.match(new RegExp(`^Note${i}:\\s*\\[\\s*$`))||d.match(new RegExp(`^Note${i}:\\s*\\{\\s*$`))){t=!0;var p=d.match(/^\s*/)[0].length;a=p}else{if(t){var u=d.match(/^\s*/)[0].length;if(""===h||""!==h&&u>a||h.startsWith("-")||h.startsWith("*"))continue;t=!1,a=-1}t||c.push(d)}}var g=c.join("\n");return""===g.trim()?s:o+"---\n"+g+"\n---\n"+s}catch(e){throw e}}removeNoteTitleFromContent(e,i){try{var r=e.split("\n"),n=[];let a=!1;for(let t=0;t<r.length;t++){var o,s=r[t],l=s.trim(),c=[s.match(/^### Note(\d+)/),s.match(/^## Note(\d+)/),s.match(/^# Note(\d+)/),s.match(/^###\s*Note(\d+)/),s.match(/Note(\d{14})/)];let e=!1;for(o of c)if(o&&o[1]===i){e=!0;break}e?a=!0:a?!l.match(/^#{1,6}\s+/)&&t!==r.length-1||(a=!1,t===r.length-1)||n.push(s):a||n.push(s)}return n.join("\n")}catch(e){throw e}}formatCommentForYAML(e){return e.includes("[")||e.includes("]")||e.includes("{")||e.includes("}")||e.includes(":")||e.includes('"')||e.includes("'")||e.includes("\\")?'"'+e.replace(/"/g,'\\"')+'"':e}updateYAMLWithComment(o,s,l){try{var c,d=o.match(/^---\s*\n([\s\S]*?)\n---\s*\n/),h=l.includes("[")||l.includes("]")||l.includes("{")||l.includes("}")||l.includes(":")||l.includes('"')||l.includes("'")||l.includes("\\");let e;if(e=h?this.formatCommentForYAML(l):l+" "+("üìå"+(c=new Date).getFullYear()+String(c.getMonth()+1).padStart(2,"0")+String(c.getDate()).padStart(2,"0")),!d)return`---
Note${s}:
  - ${e}
---

`+o;var p=d[1],u=o.substring(0,d.index),g=o.substring(d.index+d[0].length),f=[new RegExp(`^Note${s}:\\s*$`,"m"),new RegExp(`^Note${s}:\\s*\\[\\s*$`,"m"),new RegExp(`^Note${s}:\\s*\\{\\s*$`,"m")];let t=null,a=-1;var m;for(m of f)if(t=p.match(m)){a=t.index;var v=p.substring(0,a).split("\n").pop();v&&v.match(/^\s*/)[0].length;break}if(!t)return u+"---\n"+(p+`
Note${s}:
  - ${e}
`)+"---\n"+g;var w=p.split("\n");let i=-1,r=0;for(let e=0;e<w.length;e++){var y=w[e];if("---"===y.trim())break;if(y.match(new RegExp(`^Note${s}:\\s*$`))||y.match(new RegExp(`^Note${s}:\\s*\\[\\s*$`))||y.match(new RegExp(`^Note${s}:\\s*\\{\\s*$`))){var x=y.match(/^\s*/)[0].length;r=Math.floor(x/2)+1;break}}let n=-1;for(let a=w.length-1;0<=a;a--){var b=w[a].trim();if("---"===b)break;if(b.startsWith("-")||b.startsWith("*")){let t=!1;for(let e=a-1;0<=e;e--){var C=w[e],E=C.trim();if("---"===E)break;if(C.match(new RegExp(`^Note${s}:\\s*$`))||C.match(new RegExp(`^Note${s}:\\s*\\[\\s*$`))||C.match(new RegExp(`^Note${s}:\\s*\\{\\s*$`))){t=!0;break}if(!(""===E||C.startsWith(" ")||C.match(/^\s*-\s+/)||C.match(/^\s*\[\s*$/)||C.match(/^\s*\{\s*$/)||C.match(/^\s*\]\s*$/)||C.match(/^\s*\}\s*$/)))break}if(t){n=a;break}}}i=-1!==n?n+1:a+1;var k=[...w],T="  ".repeat(r),S=(k.splice(i,0,T+"- "+e),k.join("\n"));return u+"---\n"+(S.endsWith("\n")?S:S+"\n")+"---\n"+g}catch(e){throw e}}removeCommentFromYAML(a,n,o,s){try{var l=a.match(/^---\s*\n([\s\S]*?)\n---\s*\n/);if(!l)throw new Error("Êú™ÊâæÂà∞YAML frontmatter");var c=l[1],d=a.substring(0,l.index),h=a.substring(l.index+l[0].length),p=[new RegExp(`^Note${n}:\\s*$`,"m"),new RegExp(`^Note${n}:\\s*\\[\\s*$`,"m"),new RegExp(`^Note${n}:\\s*\\{\\s*$`,"m")];let e=null;var u;for(u of p)if(e=c.match(u)){e.index;break}if(!e)throw new Error("Êú™ÊâæÂà∞ÂØπÂ∫îÁöÑËØÑËÆ∫Â≠óÊÆµ");var g=c.split("\n"),f=[...g];let i=0;var m=[];let r=-1;for(let e=0;e<g.length;e++){var v=g[e];if(v.match(new RegExp(`^Note${n}:\\s*$`))||v.match(new RegExp(`^Note${n}:\\s*\\[\\s*$`))||v.match(new RegExp(`^Note${n}:\\s*\\{\\s*$`))){r=e;break}}if(-1===r)throw new Error("Êú™ÊâæÂà∞ËØÑËÆ∫Â≠óÊÆµ");for(let a=r+1;a<g.length;a++){var w=g[a],y=w.trim();if("---"===y||""!==y&&!w.startsWith(" ")&&!y.startsWith("-")&&!y.startsWith("*"))break;if(y.startsWith("-")||y.startsWith("*")){let e=y.replace(/^\s*[-*]\s*/,""),t=(((e=e.replace(/\s*üìå\d{8}$/,"")).startsWith('"')&&e.endsWith('"')||e.startsWith("'")&&e.endsWith("'"))&&(e=e.slice(1,-1)),o.replace(/\s*üìå\d{8}$/,""));if((t.startsWith('"')&&t.endsWith('"')||t.startsWith("'")&&t.endsWith("'"))&&(t=t.slice(1,-1)),e===t&&i===s){m.push(a);break}i++}}if(!(0<m.length))throw new Error("Êú™ÊâæÂà∞ÊåáÂÆöÁöÑËØÑËÆ∫");for(let e=m.length-1;0<=e;e--)f.splice(m[e],1);let t=!0;for(let e=r+1;e<f.length;e++){var x=f[e],b=x.trim();if("---"===b||""!==b&&!x.startsWith(" ")&&!b.startsWith("-")&&!b.startsWith("*"))break;if(b.startsWith("-")||b.startsWith("*")){t=!1;break}}if(t){let t=r;for(let e=r+1;e<f.length;e++){var C=f[e],E=C.trim();if("---"===E||""!==E&&!C.startsWith(" ")&&!E.startsWith("-")&&!E.startsWith("*")){t=e-1;break}}f.splice(r,t-r+1)}var k=f.join("\n");return d+"---\n"+(k.endsWith("\n")?k:k+"\n")+"---\n"+h}catch(e){throw e}}showCommentPopup(r,e,n){var t=document.querySelector(".pdfflow-comment-popup");t&&t.remove();let o=document.createElement("div"),a=(o.className="pdfflow-comment-popup",r&&r.closest?r.closest(".pdfflow-highlight-item"):null);o._originItem=a||null,o.style.position="fixed",o.style.zIndex="100000";t=document.createElement("div");t.style.display="flex",t.style.alignItems="center",t.style.gap="6px",t.style.paddingBottom="2px",t.style.borderBottom="1px solid var(--background-modifier-border)";let i=document.createElement("div");i.className="pdfflow-color-dot",i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.cursor="pointer",i.style.border="2px solid rgba(255, 255, 255, 0.8)",i.style.flexShrink="0",i.style.backgroundColor=this.getHighlightColor(n.color||"yellow"),i.title="Ë∞ÉÊï¥È´ò‰∫ÆÈ¢úËâ≤",i.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();e=this.getPdfViewFromHighlightData(n);e?await this.showColorSelector(i,n,e,null,a):new Notice("Êó†Ê≥ïÊâæÂà∞ÂØπÂ∫îÁöÑPDFËßÜÂõæ")});var s=document.createElement("button");s.className="pdfflow-delete-highlight-btn",s.title="Âà†Èô§Ê≠§È´ò‰∫Æ",s.setAttribute("aria-label","Âà†Èô§Êï¥‰∏™È´ò‰∫Æ"),s.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="m9 11-6 6v3h9l3-3"/>
            <path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/>
            <line x1="3" y1="3" x2="21" y2="21" stroke="currentColor" stroke-width="2"/>
        </svg>`,s.addEventListener("click",async e=>{if(e.stopPropagation(),confirm("Á°ÆÂÆöË¶ÅÂà†Èô§È´ò‰∫ÆÂêóÔºü"))try{await this.deleteEntireHighlight(n);var t=r&&r.closest?r.closest(".pdfflow-highlight-item"):null;t&&t.remove(),o.remove(),this.updateHighlights()}catch(e){}});let l=document.createElement("button"),c=(l.className="pdfflow-add-tag-btn",l.title="Ê∑ªÂä†Ê†áÁ≠æ",l.setAttribute("aria-label","Ê∑ªÂä†Ê†áÁ≠æ"),l.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"/>
            <line x1="7" y1="7" x2="7.01" y2="7"/>
        </svg>`,document.createElement("div")),d=(c.className="pdfflow-tags-container",l.addEventListener("click",e=>{e.stopPropagation(),this.showTagInput(l,n,c)}),t.appendChild(i),t.appendChild(s),t.appendChild(l),t.appendChild(c),o.appendChild(t),this.loadExistingTags(n,c),document.createElement("ul"));d.className="pdfflow-comment-list",e&&0<e.length?e.forEach((t,a)=>{var e=document.createElement("li"),i=(e.className="pdfflow-comment-item",e.textContent=t,document.createElement("div"));i.className="pdfflow-comment-delete-btn",i.title="Âà†Èô§Ê≠§ËØÑËÆ∫",i.addEventListener("click",async e=>{e.stopPropagation();try{await this.deleteCommentFromYAML(n,t,a),o.remove(),this.updateHighlights()}catch(e){}}),e.appendChild(i),d.appendChild(e)}):((s=document.createElement("div")).className="pdfflow-comment-empty",s.textContent="ÊöÇÊó†ËØÑËÆ∫ÔºåËØ∑Âú®‰∏ãÊñπËæìÂÖ•Ê°Ü‰∏≠Ê∑ªÂä†ËØÑËÆ∫",s.style.textAlign="center",s.style.color="var(--text-muted)",s.style.padding="20px",s.style.fontStyle="italic",s.style.fontSize="12px",d.appendChild(s)),o.appendChild(d);t=document.createElement("div");t.className="pdfflow-comment-input-container";let h=document.createElement("input");h.type="text",h.className="pdfflow-comment-input",h.placeholder="ËæìÂÖ•Êñ∞ËØÑËÆ∫...";e=document.createElement("button");e.className="pdfflow-comment-add-btn",e.textContent="+";let p=async()=>{var e=h.value.trim();if(e)try{await this.addCommentToYAML(n,e),h.value="",o.remove(),this.updateHighlights()}catch(e){}};e.addEventListener("click",p),h.addEventListener("keypress",e=>{"Enter"===e.key&&p()}),t.appendChild(h),t.appendChild(e),o.appendChild(t);s=document.createElement("div"),s.className="pdfflow-comment-close",s.innerHTML="√ó",s.addEventListener("click",()=>o.remove()),o.appendChild(s),document.body.appendChild(o),e=r.getBoundingClientRect(),o.style.left=e.right+10+"px",o.style.top=e.top-10+"px",t=o.getBoundingClientRect();t.right>window.innerWidth&&(o.style.left=e.left-t.width-10+"px"),window.innerHeight<t.bottom&&(o.style.top=window.innerHeight-t.height-10+"px");let u=e=>{var t=o.contains(e.target)||r.contains(e.target),a=e.target.closest(".pdfflow-tag-input-popup"),i=e.target.closest(".pdfflow-tag-suggestions"),e=e.target.closest(".pdfflow-color-selector");t||a||i||e||(o.remove(),document.removeEventListener("click",u))},g=(setTimeout(()=>{document.addEventListener("click",u)},100),e=>{"Escape"===e.key&&(o.remove(),document.removeEventListener("keydown",g))});document.addEventListener("keydown",g),setTimeout(()=>{h.focus()},100)}optimizeHighlightRect(t,a,i){try{let e=a._pdfflowMetrics;e||(r=window.getComputedStyle(a),n=parseFloat(r.fontSize),o=parseFloat(r.lineHeight)||1.2*n,s=a.scrollHeight||a.offsetHeight||o,e={fontSize:n,lineHeight:o,textContentHeight:s},a._pdfflowMetrics=e);var r,n,o,s,l=.15*e.fontSize,c={left:t.left,top:t.top-l,width:t.width,height:Math.max(t.height,.7*e.textContentHeight)},d=i.left,h=i.top,p=i.right,u=i.bottom;return c.left=Math.max(c.left,d),c.top=Math.max(c.top,h),c.width=Math.min(c.width,p-c.left),c.height=Math.min(c.height,u-c.top),c.height<=0&&(c.height=Math.max(t.height,.8*e.fontSize)),c}catch(e){return t}}getFirstTextNode(e){return document.createTreeWalker(e,NodeFilter.SHOW_TEXT,null,!1).nextNode()}createFallbackHighlight(e,t,a,i,r=null){var n=e.getBoundingClientRect(),n=this.optimizeHighlightRect(n,e,a);this.createHighlightElement(n,t,a,i,r)}highlightGroupHover(e,t){e&&document.querySelectorAll(`[data-highlight-id="${e}"]`).forEach(e=>{t?(e.style.opacity="0.7",e.style.boxShadow="0 0 5px rgba(0,0,0,0.3)",e.style.transform="scale(1.02)"):(e.style.opacity="0.4",e.style.boxShadow="none",e.style.transform="scale(1)")})}async findAndOpenMarkdownWithNoteTitle(a,i){try{var r,n=a.split("#")[0].split("/").pop().replace(/\.pdf$/i,""),o=this.getMarkdownFilesInBooks();let e=null;for(r of o)if(!r.name.endsWith(".excalidraw.md"))if(r.name.replace(/\.md$/,"")===n){e=r;break}if(!e)return!1;let t=await this.openFileInNewWindow(e);return this.app.workspace.setActiveLeaf(t,!0,!0),setTimeout(async()=>{await this.scrollToNoteTitleInFile(e,i,t)},100),!0}catch(e){return!1}}async scrollToNoteTitleInFile(e,a,t){try{var i=t.view;if(i&&i.editor){var r=i.editor;try{var n=this.app.metadataCache.getFileCache(e);let t="Note"+a;if(n&&n.headings&&Array.isArray(n.headings)){var o,s=n.headings.find(e=>"string"==typeof e.heading&&e.heading.trim()===t);if(s&&s.position&&s.position.start&&"number"==typeof s.position.start.line)return o=s.position.start.line,void this.scrollToLineCenter(r,o)}}catch(e){}var l=(await this.app.vault.cachedRead(e)).split("\n");for(let e=0;e<l.length;e++){var c,d=l[e];for(c of[d.match(/^### Note(\d+)/),d.match(/^## Note(\d+)/),d.match(/^# Note(\d+)/),d.match(/^###\s*Note(\d+)/),d.match(/Note(\d{14})/)])if(c&&c[1]===a)return void this.scrollToLineCenter(r,e)}this.scrollToLineCenter(r,0)}}catch(e){}}scrollToLineCenter(a,i){try{let e=Math.max(0,Math.min(i,a.lineCount()-1)),t=a.getLine(e)||"";a.setSelection({line:e,ch:0},{line:e,ch:t.length});var r=()=>{a.scrollIntoView({from:{line:e,ch:0},to:{line:e,ch:t.length}},!0)};r(),setTimeout(r,60),a.setCursor({line:e,ch:0})}catch(e){}}async openBacklinkFromHighlight(t){try{var a=this.app.workspace.getLeavesOfType("pdf").find(e=>e.view&&e.view.file);if(a&&a.view.file){var i=a.view.file.path,{page:r,select:n,color:o,square:s}=t;let e;if(s){var l=Array.isArray(s)?s.join(","):s;e=i+`#page=${r}&square=`+l}else{if(!n)throw new Error("Êó†ÊïàÁöÑÈ´ò‰∫ÆÊï∞ÊçÆÊ†ºÂºè");var c=Array.isArray(n)?n.join(","):n;e=i+`#page=${r}&select=`+c}o&&(e+="&color="+o);try{var d=t.docType?{type:t.docType}:await this.getDocTypeFromLinkPathSync(e);if("EX"===d.type){if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0;if(await this.findAndOpenCanvasWithLink(e,!1))return!0}else if("CA"===d.type){if(await this.findAndOpenCanvasWithLink(e,!1))return!0;if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0}else{var h=await this.detectDocTypeDirectly(e);if("CA"===h.type){if(await this.findAndOpenCanvasWithLink(e,!1))return!0;if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0;var p=await this.findMarkdownFileWithPdfLinkAndNote(e);if(p){var u=p.noteTitle;if(await this.findAndOpenMarkdownWithNoteTitle(e,u))return!0}}else if("EX"===h.type){if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0;if(await this.findAndOpenCanvasWithLink(e,!1))return!0;var g=await this.findMarkdownFileWithPdfLinkAndNote(e);if(g){var f=g.noteTitle;if(await this.findAndOpenMarkdownWithNoteTitle(e,f))return!0}}else if("MD"===h.type){if(await this.findAndOpenCanvasWithLink(e,!1))return!0;if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0;var m=await this.findMarkdownFileWithPdfLinkAndNote(e);if(m){var v=m.noteTitle;if(await this.findAndOpenMarkdownWithNoteTitle(e,v))return!0}}else{if(await this.findAndOpenCanvasWithLink(e,!1))return!0;if(await this.findAndOpenExcalidrawWithLinkEnhanced(e,!1))return!0;var w=await this.findMarkdownFileWithPdfLinkAndNote(e);if(w){var y=w.noteTitle;if(await this.findAndOpenMarkdownWithNoteTitle(e,y))return!0}}}return!1}catch(e){return new Notice("Êü•ÊâæÊñáÊ°£Êó∂Âá∫ÈîôÔºö"+e.message),!1}}else new Notice("Êó†Ê≥ïÊâæÂà∞ÂΩìÂâçPDFÊñá‰ª∂")}catch(e){return new Notice("Â§ÑÁêÜÈ´ò‰∫ÆÊï∞ÊçÆÊó∂Âá∫ÈîôÔºö"+e.message),!1}}getBooksFolderPath(){try{return(this.settings&&"string"==typeof this.settings.booksFolder?this.settings.booksFolder.trim():"Books").replace(/\\/g,"/")}catch(e){return"Books"}}getFilesUnderFolder(e,a){try{var i=(e||"").replace(/\\/g,"/").replace(/^\/+/,""),r=this.app.vault.getAbstractFileByPath(i);let t=[];var n=e=>{try{!e||"string"!=typeof e.path||a&&!a(e)||t.push(e)}catch(e){}};if(r&&r.children&&Array.isArray(r.children))for(var o=[r];o.length;){var s,l=o.pop();for(s of l&&l.children?l.children:[])s&&s.children&&Array.isArray(s.children)?o.push(s):n(s)}else{var c,d=i.endsWith("/")?i:i+"/";for(c of this.app.vault.getFiles())"string"==typeof c.path&&c.path.startsWith(d)&&n(c)}return t}catch(e){return[]}}getMarkdownFilesInBooks(){var e=this.getBooksFolderPath();return this.getFilesUnderFolder(e,e=>"md"===e.extension)}getCanvasFilesInBooks(){var e=this.getBooksFolderPath();return this.getFilesUnderFolder(e,e=>"canvas"===e.extension)}getExcalidrawFilesInBooks(){var e=this.getBooksFolderPath();return this.getFilesUnderFolder(e,e=>"excalidraw"===e.extension||e.name.endsWith(".excalidraw.md")||e.name.endsWith(".excalidraw"))}async findAndOpenExcalidrawWithLinkEnhanced(a,i=!1){try{var r=a+"_enhanced::scope="+this.getBooksFolderPath(),e=this.excalidrawFileCache.get(r),n=Date.now();if(e&&n-e.timestamp<this.fileSearchCacheTimeout){if(!e.found)return!1;if(i)return e.found;if(e.fileInfo)return await this.openExcalidrawFromCache(e.fileInfo)}var o=await this.findMarkdownFileWithPdfLinkAndNote(a);if(!o){var s,l=this.getExcalidrawFilesInBooks(),c=(a.match(/^(.+?)#/i)||[])[1]||"";for(s of l)try{var d,h=await this.app.vault.read(s),p=this.findExcalidrawElementByPdfLink(h,a,c);if(p)return d={file:s,targetElementId:p,exactReference:a},this.excalidrawFileCache.set(r,{found:!0,fileInfo:d,timestamp:n}),!!i||await this.openExcalidrawFromCache(d)}catch(e){}return this.excalidrawFileCache.set(r,{found:!1,fileInfo:null,timestamp:n}),!1}var{file:u,noteTitle:g}=o,f=`[[${u.path.replace(/\.md$/,"")}#Note${g}]]`,m=this.getExcalidrawFilesInBooks();let t=!1;var v,w,y=[f];for(w of m)try{var x,b=await this.app.vault.read(w);let e=null;for(x of y){if(e=this.findExcalidrawElementWithReferenceEnhanced(b,x))break;if(!e&&(e=this.findExcalidrawElementByPdfLink(b,a,(a.match(/^(.+?)#/i)||[])[1]||"")))break}if(e)return t=!0,v={file:w,targetElementId:e,exactReference:f},this.excalidrawFileCache.set(r,{found:!0,fileInfo:v,timestamp:n}),!!i||await this.openExcalidrawFromCache(v)}catch(e){continue}return this.excalidrawFileCache.set(r,{found:!1,fileInfo:null,timestamp:n}),t}catch(e){return!1}}findExcalidrawElementWithReferenceEnhanced(e,a){try{var i=e.split("\n");let t=!1;var r=[];for(let e=0;e<i.length;e++){var n=i[e];if("## Element Links"===n.trim()||"# Element Links"===n.trim())t=!0;else{if(t&&(""===n.trim()||n.trim().startsWith("#")))break;if(t&&n.includes(":")){var o=n.indexOf(":");if(0<o){var s=n.substring(0,o).trim(),l=n.substring(o+1).trim();if(l===a||l.includes(a)||a.includes(l))return s;r.push({elementId:s,linkContent:l})}}}}for(let t=0;t<i.length;t++)if(i[t].includes(a))for(let e=Math.max(0,t-5);e<t;e++){var c=i[e].match(/^([a-zA-Z0-9_-]+):/);if(c)return c[1]}var d=a.match(/Note(\d+)/);if(d){var h=d[1];for(let e=0;e<i.length;e++){var p=i[e];if(p.includes(h)&&p.includes(":")){var u=p.indexOf(":");if(0<u)return p.substring(0,u).trim()}}}return null}catch(e){return null}}findExcalidrawElementByPdfLink(e,a,i){try{var r=e.split("\n");let t=!1;for(let e=0;e<r.length;e++){var n=r[e];if("## Element Links"===n.trim()||"# Element Links"===n.trim())t=!0;else{if(t&&(""===n.trim()||n.trim().startsWith("#")))break;if(t&&n.includes(":")){var o=n.indexOf(":");if(0<o){var s=n.substring(0,o).trim(),l=n.substring(o+1).trim(),c=i&&l.includes(i),d=this.contentContainsPdfLink(l,a);if((c||/\[\[.*?\.pdf#.*?\]\]/i.test(l))&&d)return s}}}}for(let t=0;t<r.length;t++){var h=r[t],p=i&&h.includes(i),u=this.contentContainsPdfLink(h,a);if((p||/\[\[.*?\.pdf#.*?\]\]/i.test(h))&&u)for(let e=Math.max(0,t-5);e<t;e++){var g=r[e].match(/^([a-zA-Z0-9_-]+):/);if(g)return g[1]}}}catch(e){}return null}async findAndOpenExcalidrawWithLink(t,a=!1){try{var i=t+"::scope="+this.getBooksFolderPath(),r=this.excalidrawFileCache.get(i),n=Date.now();if(r&&n-r.timestamp<this.fileSearchCacheTimeout){if(!r.found)return!1;if(a)return r.found;if(r.fileInfo)return await this.openExcalidrawFromCache(r.fileInfo)}var o=await this.findMarkdownFileWithPdfLinkAndNote(t);if(!o)return this.excalidrawFileCache.set(i,{found:!1,fileInfo:null,timestamp:n}),!1;var{file:s,noteTitle:l}=o,c=`[[${s.path.replace(/\.md$/,"")}#Note${l}]]`,d=this.getExcalidrawFilesInBooks();let e=!1;var h,p;for(p of d)try{var u=await this.app.vault.read(p),g=this.findExcalidrawElementWithReference(u,c);if(g)return e=!0,h={file:p,targetElementId:g,exactReference:c},this.excalidrawFileCache.set(i,{found:!0,fileInfo:h,timestamp:n}),!!a||await this.openExcalidrawFromCache(h)}catch(e){continue}return this.excalidrawFileCache.set(i,{found:!1,fileInfo:null,timestamp:n}),e}catch(e){return!1}}async openExcalidrawFromCache(t){let{file:a,targetElementId:i}=t;t=this.app.workspace.getLeavesOfType("excalidraw");let r=null;for(let e of t)if(e.view&&e.view.file&&e.view.file.path===a.path){r=e;break}if(r)this.app.workspace.setActiveLeaf(r,!0,!0),setTimeout(()=>{this.focusToExcalidrawElement(r,i)},300);else{let e=await this.openFileInNewWindow(a);this.app.workspace.setActiveLeaf(e,!0,!0);t=this.isTouchDevice()?800:500;setTimeout(()=>{this.focusToExcalidrawElement(e,i)},t)}return!0}findExcalidrawElementWithReference(e,i){try{var r=e.split("\n");let t=!1,a=0;var n=[];for(let e=0;e<r.length;e++){var o=r[e];if("## Element Links"===o.trim()||"# Element Links"===o.trim())t=!0;else{if(t&&(""===o.trim()||o.trim().startsWith("#")))break;if(t&&o.includes(":")){a++;var s=o.indexOf(":");if(0<s){var l=o.substring(0,s).trim(),c=o.substring(s+1).trim();if(c===i)return l;n.push({elementId:l,linkContent:c})}}}}for(let t=0;t<r.length;t++)if(r[t].includes(i))for(let e=Math.max(0,t-5);e<t;e++){var d=r[e].match(/^([a-zA-Z0-9_-]+):/);if(d)return d[1]}var h=i.match(/Note(\d+)/);if(h){var p,u=h[1];for(p of n)if(p.linkContent.includes("Note"+u))return p.elementId}return null}catch(e){return null}}focusToExcalidrawElement(e,i){try{let a=e.view;if(a){let t=async()=>{var e;a.excalidrawAPI?(e=a.excalidrawAPI,await this.performExcalidrawFocus(e,i,a)):(e=this.isTouchDevice()?200:100,setTimeout(t,e))};t()}}catch(e){new Notice("Êó†Ê≥ïÂÆö‰ΩçÂà∞ExcalidrawÂÖÉÁ¥†")}}async performExcalidrawFocus(w,t,e){try{let e=null;if(w.getSceneElements&&"function"==typeof w.getSceneElements)try{var a=w.getSceneElements();e=a.find(e=>e.id===t)}catch(e){}var i;e&&(await(async({left:t,top:a,nextZoom:i},r=30)=>{var n=Date.now();let e=!1,o=0;for(var s=this.isTouchDevice()?10:15;e&&o++<s;)await new Promise(e=>setTimeout(e,100));if(!(e&&o>=s)){e=!0;try{w.updateScene({appState:{shouldCacheIgnoreZoom:!0}});var{scrollX:l,scrollY:c,zoom:d}=w.getAppState(),h=d?.value||1,p=(h-i)/r,u=(t+l)/r,g=(a+c)/r,f=this.isTouchDevice()?Math.min(r,20):r;let e=1;for(;e<=f;){w.updateScene({appState:{scrollX:l-u*e,scrollY:c-g*e,zoom:{value:h-p*e}}});var m,v=Date.now()-n;300<v?e=e<f?f:f+1:(m=v/500,e=Math.min(Math.round(f*m),f),await new Promise(e=>setTimeout(e,1)))}w.updateScene({appState:{shouldCacheIgnoreZoom:!1}})}catch(e){}finally{e=!1}}})((({x1:e,y1:t,x2:a,y2:i})=>{var{width:r,height:n}=w.getAppState()||{width:800,height:600},o=r/Math.abs(e-a),s=n/Math.abs(t-i);let l=Math.min(Math.max(o,s),30);o=Math.abs(e-a)*l,s=Math.abs(t-i)*l,(r<o||n<s)&&(l=Math.min(r/Math.abs(e-a),n/Math.abs(t-i))),o=this.isTouchDevice(),s=(r/(l*=o?.4:.5)-Math.abs(e-a))/2,r=(n/l-Math.abs(t-i))/2;return{left:(e<a?e:a)-s,top:(t<i?t:i)-r,right:(e<a?a:e)+s,bottom:(t<i?i:t)+r,nextZoom:l}})({x1:e.x,y1:e.y,x2:e.x+(e.width||100),y2:e.y+(e.height||100)})),i=this.isTouchDevice()?300:100,setTimeout(()=>{try{w.clearSelection&&"function"==typeof w.clearSelection&&w.clearSelection(),w.selectElements&&"function"==typeof w.selectElements&&w.selectElements([t])}catch(e){}},i))}catch(e){}}async findAndOpenCanvasWithLink(a,i=!1){try{var r=`canvas_${a}_${i}::scope=`+this.getBooksFolderPath(),n=Date.now(),e=this.canvasFileCache.get(r);if(e&&n-e.timestamp<this.fileSearchCacheTimeout)return!!e.found&&(!!i||await this.openCanvasFromCache(e.fileInfo));var o=await this.findMarkdownFileWithPdfLinkAndNote(a);if(!o){var s,l=this.getCanvasFilesInBooks(),c=(a.match(/^(.+?)#/i)||[])[1]||"";for(s of l)try{var d=await this.app.vault.read(s),h=JSON.parse(d);if(h.nodes&&0<h.nodes.length){var p,u=this.findCanvasNodeWithPdfLink(h.nodes,a,c);if(u)return p={file:s,targetNode:u,exactReference:a},this.canvasFileCache.set(r,{found:!0,fileInfo:p,timestamp:n}),!!i||await this.openCanvasFromCache(p)}}catch(e){}return this.canvasFileCache.set(r,{found:!1,fileInfo:null,timestamp:n}),!1}var{file:g,noteTitle:f}=o,m=`![[${g.path.replace(/\.md$/,"")}#Note${f}]]`,v=this.getCanvasFilesInBooks();let t=!1;var w,y;for(y of v)try{var x,b=await this.app.vault.read(y),C=JSON.parse(b);if(C.nodes&&0<C.nodes.length){let e=this.findNodeWithExactReference(C.nodes,m);if(e||(x=(a.match(/^(.+?)#/i)||[])[1]||"",e=this.findCanvasNodeWithPdfLink(C.nodes,a,x)),e)return t=!0,w={file:y,targetNode:e,exactReference:m},this.canvasFileCache.set(r,{found:!0,fileInfo:w,timestamp:n}),!!i||await this.openCanvasFromCache(w)}}catch(e){continue}return this.canvasFileCache.set(r,{found:!1,fileInfo:null,timestamp:n}),t}catch(e){return!1}}findCanvasNodeWithPdfLink(e,t,a){try{for(var i of e)if("text"===i.type&&i.text){var r=String(i.text),n=a&&r.includes(a),o=this.contentContainsPdfLink(r,t),s=/\[\[.*?\.pdf#.*?\]\]/i.test(r)||/!\[\[.*?\.pdf#.*?\]\]/i.test(r);if((n||s)&&o)return i}}catch(e){}return null}async openCanvasFromCache(t){let{file:a,targetNode:i}=t;t=this.app.workspace.getLeavesOfType("canvas");let r=null;for(let e of t)if(e.view&&e.view.file&&e.view.file.path===a.path){r=e;break}if(r)this.app.workspace.setActiveLeaf(r,!0,!0),setTimeout(()=>{this.focusToCanvasNode(r,i)},300);else{let e=await this.openFileInNewWindow(a);this.app.workspace.setActiveLeaf(e,!0,!0),setTimeout(()=>{this.focusToCanvasNode(e,i)},500)}return!0}async findMarkdownFileWithPdfLinkAndNote(e){try{var t,a=`markdown_${e}::scope=`+this.getBooksFolderPath(),i=Date.now(),r=this.markdownFileCache.get(a);if(r&&i-r.timestamp<this.fileSearchCacheTimeout)return r.result;for(t of this.app.vault.getMarkdownFiles())try{var n,o=await this.app.vault.cachedRead(t),s=this.extractNoteTitleFromContent(o,e);if(s)return n={file:t,noteTitle:s},this.markdownFileCache.set(a,{result:n,timestamp:i}),n}catch(e){continue}return this.markdownFileCache.set(a,{result:null,timestamp:i}),null}catch(e){return null}}async findMarkdownFileWithPdfLink(e){var t;for(t of this.app.vault.getMarkdownFiles())try{var a=await this.app.vault.cachedRead(t);if(this.contentContainsPdfLink(a,e))return t}catch(e){}return null}extractNoteTitleFromContent(e,t){var a=t.match(/page=(\d+)/),i=t.match(/select=([^&]+)/),r=t.match(/square=([^&]+)/);if(a){var n,o,s=a[1],l=e.split("\n");for(let a=0;a<l.length;a++){let t=l[a],e=!1;if(r?(n=r[1],n=[new RegExp(`page=${s}&square=`+n.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`page\\s*=\\s*${s}.*?square\\s*=\\s*`+n.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`square\\s*=\\s*${n.replace(/,/g,"\\s*,\\s*")}.*?page\\s*=\\s*`+s,"i")],e=n.some(e=>e.test(t))):i&&(n=i[1],o=[new RegExp(`page=${s}&select=`+n.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`page\\s*=\\s*${s}.*?select\\s*=\\s*`+n.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`select\\s*=\\s*${n.replace(/,/g,"\\s*,\\s*")}.*?page\\s*=\\s*`+s,"i")],e=o.some(e=>e.test(t))),e)for(let e=a;0<=e;e--){var c,d=l[e];for(c of[d.match(/^### Note(\d+)/),d.match(/^## Note(\d+)/),d.match(/^# Note(\d+)/),d.match(/^###\s*Note(\d+)/),d.match(/Note(\d{14})/)])if(c)return c[1]}}}return null}findNodeWithExactReference(e,t){for(var a of e)if("text"===a.type&&a.text){var i=a.text;if(i.includes(t))return a;var r=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");if(new RegExp(r+"\\|[^\\]]+\\]\\]","i").test(i))return a;r=t.match(/!\[\[([^#]+)#(.+)\]\]/);if(r){var n,[,r,o]=r;for(n of[`![[${r}#${o}]]`,`[[${r}#${o}]]`,new RegExp(`!\\[\\[${r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}#`+o.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"i")])if("string"==typeof n){if(i.includes(n))return a}else if(n.test(i))return a}}return null}focusToCanvasNode(e,r){try{var n=e.view;if(n&&n.canvas){let e=n.canvas;var o=r.x,s=r.y,l=r.width||400,c=r.height||200;let t=o+l/2,a=s+c/2,i=!1;if(e.viewport&&e.viewport.zoomToSelection)try{e.selection&&(e.selection.clear(),e.selection.add(r.id)),e.viewport.zoomToSelection([{x:o,y:s,width:l,height:c}],!0),i=!0}catch(e){}if(!i&&e.viewport)try{e.selection&&(e.selection.clear(),e.selection.add(r.id)),e.viewport.animateTo?e.viewport.animateTo({x:-t+e.viewport.width/2,y:-a+e.viewport.height/2,zoom:.1}):setTimeout(()=>{e.viewport.tx=-t+e.viewport.width/2,e.viewport.ty=-a+e.viewport.height/2,e.viewport.tZoom=.1,e.requestFrame&&e.requestFrame()},100),i=!0}catch(e){}if(!i&&e.setViewport)try{e.setViewport(t,a,.1),i=!0}catch(e){}if(!i&&e.panTo)try{e.panTo(t,a),i=!0}catch(e){}if(e.selection)try{e.selection.clear()}catch(e){}e.wrapperEl&&(e.wrapperEl.classList.add("pdfflow-smooth-transition"),setTimeout(()=>{e.wrapperEl&&e.wrapperEl.classList.remove("pdfflow-smooth-transition")},800)),e.requestFrame?e.requestFrame():e.render?e.render():e.draw&&e.draw()}}catch(e){}}contentContainsPdfLink(t,e){var a=e.match(/page=(\d+)/),i=e.match(/select=([^&]+)/),e=e.match(/square=([^&]+)/);return!!a&&(a=a[1],e?(e=e[1],[new RegExp(`page=${a}&square=`+e.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`page\\s*=\\s*${a}.*?square\\s*=\\s*`+e.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`square\\s*=\\s*${e.replace(/,/g,"\\s*,\\s*")}.*?page\\s*=\\s*`+a,"i")].some(e=>e.test(t))):!!i&&(e=i[1],[new RegExp(`page=${a}&select=`+e.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`page\\s*=\\s*${a}.*?select\\s*=\\s*`+e.replace(/,/g,"\\s*,\\s*"),"i"),new RegExp(`select\\s*=\\s*${e.replace(/,/g,"\\s*,\\s*")}.*?page\\s*=\\s*`+a,"i")].some(e=>e.test(t))))}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}getLastHighlightCache(e){return this.settings.lastHighlightCache||(this.settings.lastHighlightCache={}),this.settings.lastHighlightCache[e]||null}async setLastHighlightCache(e,t){this.settings.lastHighlightCache||(this.settings.lastHighlightCache={}),this.settings.lastHighlightCache[e]=t,await this.saveSettings()}async clearLastHighlightCache(e){this.settings.lastHighlightCache&&this.settings.lastHighlightCache[e]&&(delete this.settings.lastHighlightCache[e],await this.saveSettings())}async _enhancedContentProtectionCheck(){try{if(this.isMobileDevice())try{var e=this[_obf.a]||this.app,t=e&&e[_obf.p],a=t&&t[_obf.ep],i=this._securityKeys?.pluginId||"PDF Flow";return!1!==(a&&a.has&&a.has(i))}catch(e){return!0}return await this._checkPluginManagerBinding()?2<=(await Promise.all([this._checkFileSystemBinding(),this._checkMemoryBinding(),this._checkEnvironmentBinding()])).filter(Boolean).length:!1}catch(e){return this.isMobileDevice()?!0:!1}}async _checkPluginManagerBinding(){try{if(!this[_obf.a][_obf.p][_obf.ep].has(this._securityKeys.pluginId))return this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂Êú™ÂêØÁî®"),!1;var e=this[_obf.a][_obf.p][_obf.p][this._securityKeys.pluginId];if(!e)return this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂ÂÆû‰æã‰∏çÂ≠òÂú®"),!1;if(!e.onload||"function"!=typeof e.onload)return this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂onloadÊñπÊ≥ï‰∏çÂ≠òÂú®"),!1;let t=e[_obf.s];return t?[_obf.ia,_obf.di,_obf.hba].every(e=>this._validateProperty(t,e))?!!await this._validateContentProtectionManifest()||(this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂ manifest È™åËØÅÂ§±Ë¥•"),!1):(this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂Â±ûÊÄßÈ™åËØÅÂ§±Ë¥•"),!1):(this._logSecurityEvent("ÂÜÖÂÆπ‰øùÊä§Êèí‰ª∂ËÆæÁΩÆ‰∏çÂ≠òÂú®"),!1)}catch(e){return this._logSecurityEvent("Êèí‰ª∂ÁÆ°ÁêÜÂô®Ê£ÄÊü•ÂºÇÂ∏∏: "+e.message),!1}}async _validateContentProtectionManifest(){try{var e=this._securityKeys?.pluginId||_0xStr.get("plugin_id"),t=`.obsidian/plugins/${e}/manifest.json`,a=await this[_obf.a][_obf.vt][_obf.ad][_obf.r](t),i=window[_obf.js][_obf.pa](a);return i&&"object"==typeof i?i.id===e&&"ytmaps"===i.author&&"string"==typeof i.version&&this._versionGte(i.version,"1.3.0"):!1}catch(e){return!1}}_versionGte(e,t){try{var a=String(e).split(".").map(e=>parseInt(e,10)||0),i=String(t).split(".").map(e=>parseInt(e,10)||0),r=Math.max(a.length,i.length);for(let e=0;e<r;e++){var n=a[e]||0,o=i[e]||0;if(o<n)return!0;if(n<o)return!1}return!0}catch(e){return!1}}async _checkFileSystemBinding(){try{var e=_0xStr.get("config_file"),a=await this[_obf.a][_obf.vt][_obf.ad][_obf.r](e);let t=window[_obf.js][_obf.pa](a);return[_obf.ia,_obf.di,_obf.hba].every(e=>e in t)&&!0===t[_obf.ia]&&t[_obf.di]&&0<t[_obf.di].trim().length&&!0===t[_obf.hba]}catch{return!1}}async _checkMemoryBinding(){try{return[_obf.dm,_obf.bv,_obf.cm].some(e=>window[e])?!1:!(10<this._detectConsoleUsage())&&_0xSec.checkDebug()}catch{return!1}}async _checkEnvironmentBinding(){try{return[void 0!==this[_obf.a],void 0!==this[_obf.a][_obf.p],void 0!==this[_obf.a][_obf.vt],null!==this[_obf.a][_obf.vt][_obf.ad]].every(Boolean)}catch{return!1}}async checkContentProtectionStatus(){return this._enhancedContentProtectionCheck()}async checkContentProtectionFile(){try{var e,t,a;return this[_obf.a][_obf.p][_obf.ep].has(this._securityKeys.pluginId)?(e=_0xStr.get("config_file"),t=await this[_obf.a][_obf.vt][_obf.ad][_obf.r](e),!0===(a=window[_obf.js][_obf.pa](t))[_obf.ia]&&a[_obf.di]&&0<a[_obf.di].trim().length&&!0===a[_obf.hba]):!1}catch(e){return!1}}async checkAndUpdateStatus(){var e;this._validationCounter++,this._validationCounter%50!=0||await this._performPeriodicIntegrityCheck()?this._validationCounter>this._maxValidations?this._triggerSecurityFailure("È™åËØÅÊ¨°Êï∞Ë∂ÖÈôê"):(!(e=await this._enhancedContentProtectionCheck())&&this.isPluginActivated?(this.isPluginActivated=!1,this._triggerGracefulShutdown()):e&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures()),this._lastValidation=Date.now()):this._triggerSecurityFailure()}disablePluginFeatures(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null)}checkPluginActivation(){if(this.isMobileDevice())try{return this[_obf.a]&&this[_obf.a][_obf.p]&&this[_obf.a][_obf.p][_obf.ep]&&this[_obf.a][_obf.p][_obf.ep].has(this._securityKeys?.pluginId)?!0:!1}catch(e){return!0}return this._quickIntegrityCheck()?this.isPluginActivated?!(3e5<Date.now()-this._lastValidation&&(this._triggerSecurityFailure("È™åËØÅË∂ÖÊó∂"),1)):(this[_obf.a][_obf.p][_obf.ep].has(this._securityKeys.pluginId)?this._logSecurityEvent("Êèí‰ª∂Â∑≤ÂêØÁî®‰ΩÜÊú™ÊøÄÊ¥ª"):this._logSecurityEvent("Êèí‰ª∂Êú™ÂêØÁî®"),!1):(this._triggerSecurityFailure("ÂÆåÊï¥ÊÄßÊ£ÄÊü•Â§±Ë¥•"),!1)}showActivationRequired(){var e;this[_obf.a][_obf.p][_obf.ep].has(this._securityKeys.pluginId)?((e=document.createElement("div")).className="plugin-activation-notice",e.innerHTML=`
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>PDF Flow</h3>
                    <p>Content Protection is activated?</p>
                </div>
            `):((e=document.createElement("div")).className="plugin-activation-notice",e.innerHTML=`
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>PDF Flow</h3>
                    <p>Content Protection is activated?</p>
                    <p style="font-size: 12px; margin-top: 10px;">
                        Êèí‰ª∂Ë∑ØÂæÑ: ${_0xStr.decode("b2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u")}
                    </p>
                    <p style="font-size: 11px; margin-top: 8px; color: #999;">
                        ËÆæÁΩÆ ‚Üí Á§æÂå∫Êèí‰ª∂ ‚Üí ÊâæÂà∞"${this._securityKeys.pluginId}"Âπ∂ÂêØÁî®
                    </p>
                </div>
            `)}getCurrentProviderConfig(){var e=this.settings.storageProvider;return this.settings[e]||{endpoint:"",region:"",bucket:"",accessKeyId:"",secretAccessKey:""}}async uploadToObjectStorage(i,r,n=3,o=2e3){if(this.checkPluginActivation())if(await this._performRuntimeValidation()){if(this.settings.enableObjectStorage){var s=this.getCurrentProviderConfig();let t=null;for(let a=1;a<=n;a++)try{let e;switch(this.settings.storageProvider){case"tencent":e=await this.uploadToTencentCOS(i,r,s);break;case"aliyun":e=await this.uploadToAliyunOSS(i,r,s);break;default:throw new Error("‰∏çÊîØÊåÅÁöÑÂØπË±°Â≠òÂÇ®Êèê‰æõÂïÜ: "+this.settings.storageProvider)}if(e)return e;throw new Error("‰∏ä‰º†ËøîÂõûÁ©∫ÁªìÊûú")}catch(e){if(t=e,!this.isRetryableUploadError(e))break;if(a<n){let t=o*a;await new Promise(e=>setTimeout(e,t))}}let e=t.message;e=t.message.includes("Á≠æÂêçÈîôËØØ")||t.message.includes("SignatureDoesNotMatch")?"ÂØπË±°Â≠òÂÇ®Á≠æÂêçÈ™åËØÅÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•APIÂØÜÈí•ÈÖçÁΩÆ„ÄÇÂ∞Ü‰øùÂ≠òÂà∞Êú¨Âú∞„ÄÇ":t.message.includes("Â§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂")?"Â§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂ÈÄÇÈÖçÈóÆÈ¢òÔºåËØ∑ËÅîÁ≥ªÂºÄÂèëËÄÖ„ÄÇÂ∞Ü‰øùÂ≠òÂà∞Êú¨Âú∞„ÄÇ":t.message.includes("ÊùÉÈôêÈîôËØØ")||t.message.includes("403")?"ÂØπË±°Â≠òÂÇ®ÊùÉÈôê‰∏çË∂≥ÔºåËØ∑Ê£ÄÊü•APIÂØÜÈí•ÊùÉÈôê„ÄÇÂ∞Ü‰øùÂ≠òÂà∞Êú¨Âú∞„ÄÇ":`ÂØπË±°Â≠òÂÇ®‰∏ä‰º†Â§±Ë¥• (ÈáçËØï${n}Ê¨°): ${t.message.split("\n")[0]}ÔºåÂ∞Ü‰øùÂ≠òÂà∞Êú¨Âú∞`,new Notice(e)}}else this._logSecurityEvent("error_cp");else this._logSecurityEvent("error_cp");return null}isRetryableUploadError(e){let t=e.message.toLowerCase();return!["signatureDoesNotMatch".toLowerCase(),"invalidaccesskeyid","accessdenied","Á≠æÂêçÈîôËØØ","403","forbidden","unauthorized","401","404","not found","‰∏çÊîØÊåÅÁöÑÂØπË±°Â≠òÂÇ®Êèê‰æõÂïÜ","ÈÖçÁΩÆ‰ø°ÊÅØ‰∏çÂÆåÊï¥","ÊùÉÈôêÈîôËØØ","Â≠òÂÇ®Ê°∂‰∏çÂ≠òÂú®","bucket‰∏çÂ≠òÂú®","accesskey","secretkey","ÂØÜÈí•","ÊùÉÈôê‰∏çË∂≥","ÊùÉÈôêË¢´ÊãíÁªù"].some(e=>t.includes(e))&&!!["timeout","network","connection","fetch","econnreset","enotfound","etimeout","500","502","503","504","internal server error","bad gateway","service unavailable","gateway timeout","ÁΩëÁªúËøûÊé•","ËøûÊé•Â§±Ë¥•","cors"].some(e=>t.includes(e))}async uploadToTencentCOS(t,e,a){var{endpoint:i,region:r,bucket:n,accessKeyId:o,secretAccessKey:s}=a,l=this.settings.storagePath;if(!(i&&n&&o&&s))throw new Error("ËÖæËÆØ‰∫ëCOSÈÖçÁΩÆ‰ø°ÊÅØ‰∏çÂÆåÊï¥");var o=t.split(",")[1],c=window.atob(o),d=new Uint8Array(c.length);for(let e=0;e<c.length;e++)d[e]=c.charCodeAt(e);s=encodeURIComponent(l+e);let h=i.trim();(h=(h=h.includes(n+".")?h.replace(n+".",""):h).startsWith("cos.")?h:h.startsWith("ap-")||h.startsWith("eu-")||h.startsWith("na-")?`cos.${h}.myqcloud.com`:`cos.${r||"ap-guangzhou"}.myqcloud.com`).includes(".myqcloud.com")||new Notice("Ë≠¶ÂëäÔºöËÖæËÆØ‰∫ëCOS Ê†ºÂºèÂèØËÉΩ‰∏çÊ≠£Á°ÆÔºåËØ∑Ê£ÄÊü•ÈÖçÁΩÆ");t=`https://${n}.${h}/`+s,o=await this.generateTencentCOSAuth(s,"PUT",h,a);try{await this.uploadToTencentCOSWithNodejs(t,o,d);return t}catch(e){}try{await this.fetchWithXHR(t,{method:"PUT",headers:{Authorization:o,"Content-Type":"image/png"},body:d});return`https://${n}.${h}/`+s}catch(e){try{var p,u=await fetch(t,{method:"PUT",headers:{Authorization:o,"Content-Type":"image/png"},body:d,mode:"cors"});if(u.ok)return`https://${n}.${h}/`+s;throw p=await u.text(),new Error(`ËÖæËÆØ‰∫ëCOS‰∏ä‰º†Â§±Ë¥•: ${u.status} ${u.statusText} - `+p)}catch(e){let t;throw t=e.message.includes("SignatureDoesNotMatch")?new Error(`ËÖæËÆØ‰∫ëCOSÁ≠æÂêçÈîôËØØ„ÄÇ

ÂèØËÉΩÁöÑÂéüÂõ†Ôºö
1. APIÂØÜÈí•ÈîôËØØÔºöËØ∑Ê£ÄÊü•AccessKeyIdÂíåSecretAccessKey
2. ÊúçÂä°Á´ØÁÇπÈÖçÁΩÆÈîôËØØÔºöËØ∑Á°ÆËÆ§endpointÂíåregionËÆæÁΩÆÊ≠£Á°Æ
3. Êó∂Èó¥ÂêåÊ≠•ÈóÆÈ¢òÔºöËØ∑Á°ÆËÆ§Á≥ªÁªüÊó∂Èó¥ÂáÜÁ°Æ

ËØ∑ÈáçÊñ∞Ê£ÄÊü•ÈÖçÁΩÆ‰ø°ÊÅØ„ÄÇ`):e.message.includes("SAZOperationNotSupportOnMAZBucket")?new Error(`Â§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂ÂÖºÂÆπÊÄßÈóÆÈ¢ò„ÄÇ

Ê£ÄÊµãÂà∞ÊÇ®ÁöÑÂ≠òÂÇ®Ê°∂ÊòØÂ§öÂèØÁî®Âå∫(MAZ)Á±ªÂûãÔºå‰ª£Á†ÅÂ∑≤Ëá™Âä®Ë∞ÉÊï¥„ÄÇÂ¶ÇÊûú‰ªçÊúâÈóÆÈ¢òÔºåËØ∑Ôºö
1. Ê£ÄÊü•Â≠òÂÇ®Ê°∂Á±ªÂûãËÆæÁΩÆ
2. Á°ÆËÆ§APIÂØÜÈí•ÊùÉÈôê
3. ÊàñÂ∞ùËØïÂàõÂª∫ÂçïÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂ËøõË°åÊµãËØï`):e.message.includes("403")||e.message.includes("Forbidden")?new Error(`ËÖæËÆØ‰∫ëCOSÊùÉÈôêÈîôËØØ„ÄÇ

ÂèØËÉΩÁöÑÂéüÂõ†Ôºö
1. APIÂØÜÈí•Ê≤°ÊúâÂØπÂ∫îÂ≠òÂÇ®Ê°∂ÁöÑÂÜôÂÖ•ÊùÉÈôê
2. Â≠òÂÇ®Ê°∂ËÆøÈóÆÁ≠ñÁï•ÈôêÂà∂
3. ËØ∑Âú®ËÖæËÆØ‰∫ëÊéßÂà∂Âè∞Ê£ÄÊü•Ôºö
   - CAMÁî®Êà∑ÊùÉÈôê
   - Â≠òÂÇ®Ê°∂Á≠ñÁï•`):new Error("ËÖæËÆØ‰∫ëCOS‰∏ä‰º†Â§±Ë¥•: "+e.message)}}}async uploadToTencentCOSWithNodejs(e,n,o){try{if(this.isMobileDevice())throw new Error("ÁßªÂä®Á´Ø‰∏çÊîØÊåÅNode.js‰∏ä‰º†ÊñπÂºèÔºåËØ∑‰ΩøÁî®fetchÊñπÂºè");if("function"!=typeof window.require)throw new Error("Node.jsÊ®°Âùó‰∏çÂèØÁî®ÔºåËØ∑‰ΩøÁî®fetchÊñπÂºè");let a=window.require("https");var t=window.require("url").URL;let r=new t(e);return new Promise((e,i)=>{var t={hostname:r.hostname,port:443,path:r.pathname,method:"PUT",headers:{Authorization:n,"Content-Type":"image/png","Content-Length":o.length}},t=a.request(t,t=>{let a="";t.on("data",e=>{a+=e}),t.on("end",()=>{if(200<=t.statusCode&&t.statusCode<300)e(a);else{let e=`HTTP ${t.statusCode}: `+a;a.includes("SignatureDoesNotMatch")?e="Á≠æÂêçÈîôËØØ: "+a:a.includes("SAZOperationNotSupportOnMAZBucket")?e="Â§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂ÈîôËØØ: "+a:a.includes("AccessDenied")&&(e="ÊùÉÈôêÊãíÁªù: "+a),i(new Error(e))}})});t.on("error",e=>{i(e)}),t.write(o),t.end()})}catch(e){throw new Error("Node.js‰∏ä‰º†Â§±Ë¥•: "+e.message)}}async uploadToAliyunOSS(e,t,a){var{endpoint:i,bucket:r,accessKeyId:n,secretAccessKey:o}=a,s=this.settings.storagePath;if(!(i&&r&&n&&o))throw new Error("ÈòøÈáå‰∫ëOSSÈÖçÁΩÆ‰ø°ÊÅØ‰∏çÂÆåÊï¥");var n=e.split(",")[1],l=window.atob(n),c=new Uint8Array(l.length);for(let e=0;e<l.length;e++)c[e]=l.charCodeAt(e);o=s+t,e=encodeURIComponent(o);try{var d,h=await this.generateAliyunOSSPostPolicy(o,a),p=new Blob([c],{type:"image/png"}),u=(h.append("file",p),await fetch(`https://${r}.`+i,{method:"POST",body:h}));if(u.ok)return`https://${r}.${i}/`+e;throw d=await u.text(),new Error(`ÈòøÈáå‰∫ëOSS‰∏ä‰º†Â§±Ë¥•: ${u.status} ${u.statusText} - `+d)}catch(e){throw e}}async generateTencentCOSAuth(e,t,a,i){var{accessKeyId:i,secretAccessKey:r,bucket:n}=i;try{var o=Math.floor(Date.now()/1e3),s=o+";"+(o+3600),l=await this.hmacSha1(r,s),c=decodeURIComponent(e),d=[t.toLowerCase(),"/"+c,"",`host=${n}.`+a,""].join("\n"),h=["sha1",s,await this.sha1(d),""].join("\n");return["q-sign-algorithm=sha1","q-ak="+i,"q-sign-time="+s,"q-key-time="+s,"q-header-list=host","q-url-param-list=","q-signature="+await this.hmacSha1(l,h)].join("&")}catch(e){throw new Error("ÁîüÊàêËÖæËÆØ‰∫ëCOSËÆ§ËØÅÂ§±Ë¥•: "+e.message)}}async generateAliyunOSSAuth(e,t,a,i){var{accessKeyId:i,secretAccessKey:r,bucket:n}=i;try{var o=[t,"","image/png",a,`/${n}/`+e].join("\n");return`OSS ${i}:`+await this.hmacSha1Base64(r,o)}catch(e){throw new Error("ÁîüÊàêÈòøÈáå‰∫ëOSSËÆ§ËØÅÂ§±Ë¥•: "+e.message)}}async generateAliyunOSSPostPolicy(e,t){var{accessKeyId:t,secretAccessKey:a,bucket:i}=t;try{var r={expiration:new Date(Date.now()+36e5).toISOString(),conditions:[{bucket:i},{key:e},["content-length-range",0,10485760]]},n=JSON.stringify(r),o=this.utf8ToBase64(n),s=await this.hmacSha1Base64(a,o),l=new FormData;return l.append("OSSAccessKeyId",t),l.append("policy",o),l.append("signature",s),l.append("key",e),l.append("success_action_status","200"),l}catch(e){throw new Error("ÁîüÊàêÈòøÈáå‰∫ëOSS POST PolicyÂ§±Ë¥•: "+e.message)}}async hmacSha1(e,t){var a=new TextEncoder,e=a.encode(e),a=a.encode(t),t=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),e=await crypto.subtle.sign("HMAC",t,a);return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")}async hmacSha1Base64(e,t){var a=new TextEncoder,e=a.encode(e),a=a.encode(t),t=await crypto.subtle.importKey("raw",e,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),e=await crypto.subtle.sign("HMAC",t,a);return btoa(String.fromCharCode(...new Uint8Array(e)))}async sha1(e){e=(new TextEncoder).encode(e),e=await crypto.subtle.digest("SHA-1",e);return Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")}utf8ToBase64(t){try{return btoa(t)}catch(e){t=(new TextEncoder).encode(t),t=Array.from(t,e=>String.fromCharCode(e)).join("");return btoa(t)}}async fetchWithXHR(e,r){return new Promise((t,a)=>{let i=new XMLHttpRequest;i.open(r.method||"GET",e,!0),r.headers&&Object.entries(r.headers).forEach(([e,t])=>{i.setRequestHeader(e,t)}),i.onload=function(){var e;200<=i.status&&i.status<300?t({ok:!0,status:i.status,statusText:i.statusText,text:()=>Promise.resolve(i.responseText),json:()=>Promise.resolve(JSON.parse(i.responseText))}):(e=i.responseText||"",a(new Error(`HTTP ${i.status}: ${i.statusText} - `+e)))},i.onerror=function(){a(new Error("ÁΩëÁªúËØ∑Ê±ÇÂ§±Ë¥•"))},i.ontimeout=function(){a(new Error("ËØ∑Ê±ÇË∂ÖÊó∂"))},i.timeout=3e4,i.send(r.body||null)})}registerHighlightInteractionKeys(){this.highlightPointerEventsEnabled=!1,this.setHighlightElementsPointerEvents("none")}setHighlightElementsPointerEvents(t){[".pdfflow-backlink",".pdfflow-rect-highlight","."+HIGHLIGHT_LAYER_CLASS+"-container"].forEach(e=>{document.querySelectorAll(e).forEach(e=>{e.style.pointerEvents=t})})}async loadTemplateContent(){return""}async createNoteWithTemplate(e,t,a){return`# ${e} ËØª‰π¶Á¨îËÆ∞

## Á¨îËÆ∞ÂÜÖÂÆπ

`+a}async findLastHighlightAndOpenCanvas(){if(this.checkPluginActivation()){var t=new Notice("Ê≠£Âú®Êü•ÊâæÈ´ò‰∫ÆÂ±Ç...",0);try{var a=this.app.workspace.getLeavesOfType("pdf").find(e=>e.view&&e.view.file);if(a&&a.view.file){var i=a.view.file.path,e=this.getLastHighlightCache(i);if(e)if(e.select&&!e.square)try{return t.hide(),this.jumpToHighlight(a.view,e),void this.openBacklinkFromHighlight(e)}catch(e){await this.clearLastHighlightCache(i)}else await this.clearLastHighlightCache(i);try{var r=await this.getHighlightsFromMarkdownFiles(i);if(r&&0!==r.length){let e=r.sort((a,i)=>{if(a.page!==i.page)return i.page-a.page;if(a.select&&i.select){let e,t;return e=Array.isArray(a.select)?a.select:"string"==typeof a.select?a.select.split(",").map(Number):[0,0,0,0],((t=Array.isArray(i.select)?i.select:"string"==typeof i.select?i.select.split(",").map(Number):[0,0,0,0])[1]||0)-(e[1]||0)}return 0})[0];e?(await this.setLastHighlightCache(i,e),t.hide(),this.jumpToHighlight(a.view,e),setTimeout(async()=>{await this.openBacklinkFromHighlight(e)},200)):t.hide()}else t.hide(),new Notice("ÂΩìÂâçPDFÊñáÊ°£Ê≤°ÊúâÈ´ò‰∫ÆÂ±Ç")}catch(e){t.hide()}}else t.hide(),new Notice("Êó†Ê≥ïÊâæÂà∞ÂΩìÂâçPDFÊñá‰ª∂")}catch(e){t.hide()}}}jumpToHighlight(i,r){if(this.checkPluginActivation())try{var n=i.containerEl;if(n){let{page:e,select:t}=r;let a=n.querySelectorAll(".page")[e-1];a?(this.jumpToPage(i,e),setTimeout(()=>{t&&this.jumpToTextHighlight(a,t)},100)):this.jumpToPage(i,e)}}catch(e){this.jumpToPage(i,r.page)}}jumpToPage(e,t){try{var a,i=e.containerEl;i&&(a=i.querySelectorAll(".page")[t-1])&&a.scrollIntoView({behavior:"auto",block:"start"})}catch(e){}}jumpToTextHighlight(r,n){try{let e,t,a,i;if(Array.isArray(n))[e,t,a,i]=n;else{if("string"!=typeof n)return;var o=n.split(",").map(Number);if(!(4<=o.length))return;[e,t,a,i]=o}var s;for(s of r.querySelectorAll(".pdfflow-backlink")){var l=s.getAttribute("data-highlight-id");if(l&&l.includes(`highlight_${e}_${t}_${a}_`+i))return void s.scrollIntoView({behavior:"auto",block:"center",inline:"center"})}var c,d=r.querySelector(".textLayer");d&&(c=Array.from(d.querySelectorAll("*")))[e]&&c[e].scrollIntoView({behavior:"auto",block:"center",inline:"center"})}catch(e){}}addPdfToolbarButton(){this.isPluginActivated&&this.app.workspace.getLeavesOfType("pdf").forEach(e=>{e=e.view;e&&e.containerEl&&this.setupPdfToolbarButton(e)})}setupPdfToolbarButton(r){var n=r.containerEl.querySelector(".pdf-toolbar");if(n){n=n.querySelector(".pdf-toolbar-left");if(n&&!n.querySelector(".pdfflow-highlight-selector-container")){let t=document.createElement("div"),a=(t.className="pdfflow-highlight-selector-container",t.style.cssText=`
            display: flex;
            align-items: center;
            gap: 4px;
        `,document.createElement("button")),i=(a.className="pdfflow-last-highlight-btn",a.innerHTML=`
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-icon lucide-list"><path d="M3 5h.01"/><path d="M3 12h.01"/><path d="M3 19h.01"/><path d="M8 5h13"/><path d="M8 12h13"/><path d="M8 19h13"/></svg>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 2px;">
                <polyline points="6,9 12,15 18,9"></polyline>
                        </svg>
                    `,a.style.cssText=`
            background: none;
            border: none;
            color: var(--text-normal);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        `,a.title="È´ò‰∫ÆÂàóË°®",a.addEventListener("mouseenter",()=>{a.disabled||(a.style.backgroundColor="var(--background-modifier-hover)")}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="transparent"}),!1),e=(a.disabled=!0,a.style.opacity="0.5",a.style.cursor="not-allowed",a.title="Âä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂêé...",setTimeout(()=>{a.disabled=!1,a.style.opacity="1",a.style.cursor="pointer",a.title="ÈÄâÊã©È´ò‰∫ÆÂ±ÇÂπ∂Âú®Âè≥‰æßËÅöÁÑ¶ÁîªÂ∏ÉËäÇÁÇπ"},1e4),a.addEventListener("click",async e=>{if(e.preventDefault(),e.stopPropagation(),this.checkPluginActivation())if(a.disabled)new Notice("Âä†ËΩΩ‰∏≠ÔºåËØ∑Á®çÂêé");else if(!i){i=!0;try{await this.showHighlightSelector(t,r)}catch(e){new Notice("Ëé∑ÂèñÈ´ò‰∫ÆÂàóË°®Â§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï")}finally{i=!1}}}),t.appendChild(a),document.createElement("button"));e.className="pdfflow-new-doc-btn",e.innerHTML=`
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M8 3H5a2 2 0 0 0-2 2v14c0 1.1.9 2 2 2h3"/>
                <path d="M16 3h3a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-3"/>
                <path d="M12 20v2"/>
                <path d="M12 14v2"/>
                <path d="M12 8v2"/>
                <path d="M12 2v2"/>
            </svg>
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="margin-left: 2px;">
                <polyline points="6,9 12,15 18,9"></polyline>
            </svg>
        `,e.style.cssText=`
            background: none;
            border: none;
            color: var(--text-normal);
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        `,e.title="Âè≥‰æßÁ™óÂè£ÂàõÂª∫/ÊâìÂºÄÁ¨îËÆ∞ÊñáÊ°£",e.addEventListener("mouseenter",()=>{e.style.backgroundColor="var(--background-modifier-hover)"}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="transparent"}),e.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),this.checkPluginActivation()&&await this.showDocTypeSelector(t,r)}),t.appendChild(e),n.appendChild(t),this.addZoomLevelInputElForView(r)}}}addZoomLevelInputElForView(c){try{if(!this.settings||!1!==this.settings.zoomLevelInputBoxInToolbar){var e=c?.containerEl;if(e){let l=e.querySelector(".pdf-toolbar")?.querySelector(".pdf-toolbar-left");if(l&&!l.querySelector(".pdfflow-zoom-level-container")){var d=(c.viewer?.child)?.pdfViewer;let e=d?.eventBus,r=d?.pdfViewer||c.pdfViewer||c.viewer?.pdfViewer,t=document.createElement("div"),a=(t.className="pdf-toolbar-divider",document.createElement("div")),n=(a.className="pdfflow-zoom-level-container",a.style.cssText="display:flex;align-items:center;gap:4px;",document.createElement("input"));n.className="pdf-zoom-level-input",n.type="number",n.style.cssText="width:58px;padding:2px 6px;border:1px solid var(--background-modifier-border);border-radius:4px;background:var(--background-primary);color:var(--text-normal);text-align: right;",n.addEventListener("click",()=>{try{n.select()}catch(e){}});var h=document.createElement("span");h.className="pdf-zoom-level-percent",h.textContent="%",h.style.cssText="color:var(--text-muted);font-size:12px;";try{var p=r&&"number"==typeof r.currentScale?r.currentScale:null;p&&(n.value=String(Math.round(100*p)))}catch(e){}n.addEventListener("change",()=>{try{var e=n.valueAsNumber/100,t=window&&window.pdfjsViewer&&"number"==typeof window.pdfjsViewer.MIN_SCALE?window.pdfjsViewer.MIN_SCALE:.1,a=window&&window.pdfjsViewer&&"number"==typeof window.pdfjsViewer.MAX_SCALE?window.pdfjsViewer.MAX_SCALE:4,i=Math.min(Math.max(e||1,t),a);r&&(r.currentScale=i),n.value=String(Math.round(100*i))}catch(e){}});let i=e=>{try{var t=e&&(e.scale??e.newScale);"number"==typeof t&&(n.value=String(Math.round(100*t)))}catch(e){}};if(e&&"function"==typeof e.on)try{e.on("scalechanging",i),e.on("scalechanged",i)}catch(e){}l.appendChild(t),a.appendChild(n),a.appendChild(h),l.appendChild(a),this._pdfZoomCleanups||(this._pdfZoomCleanups=new Set);let o=()=>{try{e&&"function"==typeof e.off&&(e.off("scalechanging",i),e.off("scalechanged",i))}catch(e){}try{a.remove()}catch(e){}try{t.remove()}catch(e){}this._pdfZoomCleanups.delete(o)},s=(this._pdfZoomCleanups.add(o),()=>{try{document.body.contains(l)||(o(),this.app.workspace.off("layout-change",s))}catch(e){}});this.registerEvent(this.app.workspace.on("layout-change",s))}}}}catch(e){}}async showHighlightSelector(s,r){try{var e=document.querySelector(".pdfflow-highlight-dropdown");if(e)e.remove(),this.cleanupDropdownEventListeners();else{var t=r.file.path,l=await this.getHighlightsFromMarkdownFiles(t);if(l&&0!==l.length){let h=l.sort((a,i)=>{if(a.page!==i.page)return i.page-a.page;if(a.select&&i.select){let e,t;return e=Array.isArray(a.select)?a.select:"string"==typeof a.select?a.select.split(",").map(Number):[0,0,0,0],((t=Array.isArray(i.select)?i.select:"string"==typeof i.select?i.select.split(",").map(Number):[0,0,0,0])[1]||0)-(e[1]||0)}return 0}),o=document.createElement("div");o.className="pdfflow-highlight-dropdown";var c,d=s.getBoundingClientRect();o.style.cssText=`
                position: fixed;
                top: ${d.bottom+4}px;
                left: ${d.right-320}px;
                background: var(--background-primary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 6px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                z-index: 999 !important;
                min-width: 320px;
                max-width: 480px;
                max-height: 400px;
                overflow-y: auto;
            `;let a=new Set;for(c of h)if(c.source){var v=this.app.vault.getAbstractFileByPath(c.source);if(v){var w=await this.app.vault.read(v),y=this.extractNoteTitleFromContent(w,c.linkPath);if(y){var x=w.split("\n");let t=!1;for(let e=0;e<x.length;e++){var b=x[e],C=[b.match(/^### Note(\d+)/),b.match(/^## Note(\d+)/),b.match(/^# Note(\d+)/)].find(e=>e);if(C&&C[1]===y)t=!0;else{if(t&&b.match(/^#{1,3}\s+/)&&!b.includes("Note"+y))break;if(t&&b.includes("üîó[[")){var E=b.substring(0,b.indexOf("üîó[[")),k=/#[\w\/\u4e00-\u9fa5]+/g,T=E.match(k);T&&T.forEach(e=>a.add(e));break}}}}}}var S=Array.from(a);let n=50,p=0,u=null,g=h;Math.ceil(g.length/n);let f=async()=>{o.querySelectorAll(".pdfflow-highlight-item").forEach(e=>e.remove());var t=g.slice(p*n,(p+1)*n);for(let e=0;e<t.length;e++){var a=t[e],i=p*n+e,a=await this.createHighlightItem(a,i+1,r,o,g.length),i=o.querySelector(".pdfflow-pagination-container");i?o.insertBefore(a,i):o.appendChild(a)}},m=()=>{var e=o.querySelector(".pdfflow-pagination-button:first-child"),t=o.querySelector(".pdfflow-pagination-button:last-child"),a=o.querySelector(".pdfflow-page-info"),i=Math.ceil(g.length/n);e&&(e.disabled=0===p,e.style.opacity=0===p?"0.5":"1"),t&&(t.disabled=p===i-1,t.style.opacity=p===i-1?"0.5":"1"),a&&(e=p*n,t=Math.min((p+1)*n,g.length),e=g.length-e,t=g.length-t+1,a.textContent=`Á¨¨ ${p+1} È°µÔºö${e}-${t}ÔºåÂÖ± ${i} È°µ`)};var L=document.createElement("div"),A=(L.style.cssText=`
                padding: 12px 16px 8px;
                border-bottom: 1px solid var(--background-modifier-border-focus);
                font-weight: 600;
                color: var(--text-normal);
                font-size: 14px;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background: var(--background-secondary);
            `,document.createElement("span"));if(A.textContent=`È´ò‰∫ÆÂàóË°® (${h.length}‰∏™)`,A.style.cssText=`
                font-size: 14px;
                font-weight: 600;
                color: var(--text-normal);
                letter-spacing: 0.3px;
            `,L.appendChild(A),50<h.length){var P=document.createElement("div"),M=(P.style.cssText=`
                    display: flex;
                    gap: 4px;
                    align-items: center;
                    flex-wrap: wrap;
                `,h.length),_=Math.ceil(M/n);for(let t=1;t<=_;t++){let r=(t-1)*n;var D=Math.min(t*n,M),F=M-r,N=M-D+1;let e=document.createElement("button");e.style.cssText=`
                        background: var(--background-secondary);
                        border: 1px solid var(--background-modifier-border);
                        border-radius: 10px;
                        padding: 1px 8px;
                        font-size: 9px;
                        font-weight: 500;
                        color: var(--text-muted);
                        cursor: pointer;
                        transition: all 0.2s ease;
                        white-space: nowrap;
                        line-height: 1.2;
                        letter-spacing: 0.2px;
                        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                    `,e.textContent=F+"-"+N,e.addEventListener("mouseenter",()=>{e.style.backgroundColor="var(--background-modifier-hover)",e.style.borderColor="var(--interactive-accent)",e.style.color="var(--text-normal)",e.style.transform="scale(1.05)",e.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)"}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="var(--background-secondary)",e.style.borderColor="var(--background-modifier-border)",e.style.color="var(--text-muted)",e.style.transform="scale(1)",e.style.boxShadow="0 1px 2px rgba(0, 0, 0, 0.05)"}),e.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();var e=r,t=Math.floor(e/n);t!==p&&(p=t,await f(),m()),await new Promise(e=>setTimeout(e,100));let a=e%n,i=o.querySelectorAll(".pdfflow-highlight-item");i[a]&&(i[a].scrollIntoView({behavior:"smooth",block:"start"}),i[a].style.backgroundColor="var(--background-modifier-hover)",setTimeout(()=>{i[a].style.backgroundColor="var(--background-primary)"},1e3))}),P.appendChild(e)}L.appendChild(P)}if(o.appendChild(L),0<S.length){let d=document.createElement("div");d.className="pdfflow-tags-filter-container",d.style.cssText=`
                    padding: 8px 16px;
                    border-bottom: 1px solid var(--background-modifier-border-focus);
                    display: flex;
                    flex-wrap: wrap;
                    gap: 6px;
                    align-items: center;
                    background: var(--background-secondary);
                `;var I=document.createElement("button");I.className="pdfflow-tag-filter-btn",I.textContent="ÂÖ®ÈÉ®",I.dataset.tag="ALL",I.style.cssText=`
                    padding: 4px 10px;
                    border-radius: 12px;
                    font-size: 11px;
                    font-weight: 500;
                    cursor: pointer;
                    transition: all 0.2s ease;
                    border: 1px solid var(--interactive-accent);
                    background: var(--interactive-accent);
                    color: #5c5555;
                    height: 24px;
                `,I.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),u=null,g=h,p=0,d.querySelectorAll(".pdfflow-tag-filter-btn").forEach(e=>{var t;e.dataset&&"ALL"===e.dataset.tag?(e.style.background="var(--interactive-accent)",e.style.color="white",e.style.border="1px solid var(--interactive-accent)"):(t=e.dataset&&e.dataset.bg?e.dataset.bg:"var(--background-primary)",e.style.background=t,e.style.color="var(--text-normal)",e.style.border="none"),e.style.transform="scale(1)"}),await f(),m()}),d.appendChild(I);for(let c of S){let e=document.createElement("button"),{backgroundColor:t,borderColor:a,hoverColor:i}=(e.className="pdfflow-tag-filter-btn",e.textContent=c.replace(/^#/,""),this.getTagColor(c));e.dataset.tag=c,e.dataset.bg=t,e.dataset.border=a,e.dataset.hover=i,e.style.cssText=`
                        padding: 4px 10px;
                        border-radius: 12px;
                        font-size: 11px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: all 0.2s ease;
                        border: none;
                        background: ${t};
                        color: #5c5555;
                        position: relative;
                        height: 24px;
                    `;var H=document.createElement("span");H.style.cssText=`
                        display: inline-block;
                        width: 8px;
                        height: 8px;
                        border-radius: 50%;
                        background: ${a};
                        margin-right: 4px;
                        vertical-align: middle;
                    `,e.insertBefore(H,e.firstChild),e.addEventListener("mouseenter",()=>{u!==c&&(e.style.background=i,e.style.transform="scale(1.05)")}),e.addEventListener("mouseleave",()=>{u!==c&&(e.style.background=t,e.style.transform="scale(1)")}),e.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),u=c,g=[];for(var i of h)if(i.source){var r=this.app.vault.getAbstractFileByPath(i.source);if(r){var r=await this.app.vault.read(r),n=this.extractNoteTitleFromContent(r,i.linkPath);if(n){var o=r.split("\n");let t=!1,a=!1;for(let e=0;e<o.length;e++){var s=o[e],l=[s.match(/^### Note(\d+)/),s.match(/^## Note(\d+)/),s.match(/^# Note(\d+)/)].find(e=>e);if(l&&l[1]===n)t=!0;else{if(t&&s.match(/^#{1,3}\s+/)&&!s.includes("Note"+n))break;if(t&&s.includes("üîó[[")){s.substring(0,s.indexOf("üîó[[")).includes(c)&&(a=!0);break}}}a&&g.push(i)}}}p=0,d.querySelectorAll(".pdfflow-tag-filter-btn").forEach(e=>{var t,a=e.dataset&&"ALL"===e.dataset.tag;e.dataset&&e.dataset.tag===c?(t=e.dataset.hover||e.dataset.bg||"var(--interactive-accent)",e.style.background=t,e.style.color="white",e.style.border="none"):a?(e.style.background="var(--interactive-accent)",e.style.color="#5c5555",e.style.border="1px solid var(--background-modifier-border)"):(t=e.dataset&&e.dataset.bg?e.dataset.bg:"var(--background-primary)",e.style.background=t,e.style.color="#5c5555",e.style.border="none"),e.style.transform="scale(1)"}),await f(),m()}),d.appendChild(e)}o.appendChild(d)}var R=g.slice(p*n,(p+1)*n);for(let e=0;e<R.length;e++){var $=R[e],O=p*n+e,B=await this.createHighlightItem($,O+1,r,o,g.length);o.appendChild(B)}var q=Math.ceil(g.length/n);if(1<q){var W=document.createElement("div"),Y=(W.className="pdfflow-pagination-container",document.createElement("span")),V=(Y.className="pdfflow-page-info",p*n),X=Math.min((p+1)*n,g.length),j=g.length-V,U=g.length-X+1;Y.textContent=`Á¨¨ ${p+1} È°µÔºö${j}-${U}ÔºåÂÖ± ${q} È°µ`,Y.style.cssText=`
                    font-size: 11px;
                    font-weight: 500;
                    color: var(--text-muted);
                    letter-spacing: 0.2px;
                `;let e=document.createElement("div"),t=(e.style.cssText=`
                    display: flex;
                    gap: 4px;
                `,document.createElement("button")),a=(t.className="pdfflow-pagination-button",t.textContent="‰∏ä‰∏ÄÈ°µ",t.disabled=0===p,t.style.cssText=`
                    background: var(--background-secondary);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 6px;
                    padding: 4px 10px;
                    font-size: 11px;
                    font-weight: 500;
                    color: var(--text-muted);
                    cursor: pointer;
                    transition: all 0.2s ease;
                    letter-spacing: 0.2px;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                `,document.createElement("button"));a.className="pdfflow-pagination-button",a.textContent="‰∏ã‰∏ÄÈ°µ",a.disabled=p===q-1,a.style.cssText=`
                    background: var(--background-secondary);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 6px;
                    padding: 4px 10px;
                    font-size: 11px;
                    font-weight: 500;
                    color: var(--text-muted);
                    cursor: pointer;
                    transition: all 0.2s ease;
                    letter-spacing: 0.2px;
                    box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
                `,t.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),0<p&&(p--,await f(),m())}),a.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation();e=Math.ceil(g.length/n);p<e-1&&(p++,await f(),m())}),t.addEventListener("mouseenter",()=>{t.disabled||(t.style.backgroundColor="var(--background-modifier-hover)",t.style.borderColor="var(--interactive-accent)",t.style.color="var(--text-normal)",t.style.transform="scale(1.02)",t.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)")}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor="var(--background-secondary)",t.style.borderColor="var(--background-modifier-border)",t.style.color="var(--text-muted)",t.style.transform="scale(1)",t.style.boxShadow="0 1px 2px rgba(0, 0, 0, 0.05)"}),a.addEventListener("mouseenter",()=>{a.disabled||(a.style.backgroundColor="var(--background-modifier-hover)",a.style.borderColor="var(--interactive-accent)",a.style.color="var(--text-normal)",a.style.transform="scale(1.02)",a.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.1)")}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="var(--background-secondary)",a.style.borderColor="var(--background-modifier-border)",a.style.color="var(--text-muted)",a.style.transform="scale(1)",a.style.boxShadow="0 1px 2px rgba(0, 0, 0, 0.05)"}),e.appendChild(t),e.appendChild(a),W.appendChild(Y),W.appendChild(e),o.appendChild(W)}document.body.appendChild(o);let i=e=>{var e=e.target,t=e&&e.closest&&e.closest(".pdfflow-comment-popup"),a=e&&e.closest&&e.closest(".pdfflow-tag-input-popup");s.contains(e)||o.contains(e)||t||a||(o.remove(),document.removeEventListener("click",i))};setTimeout(()=>{document.addEventListener("click",i)},100);var z=e=>{"Escape"===e.key&&(o.remove(),this.cleanupDropdownEventListeners())};document.addEventListener("keydown",z),this.currentDropdownHandlers={keydown:z,click:e=>{var e=e.target,t=e&&e.closest&&e.closest(".pdfflow-comment-popup"),a=e&&e.closest&&e.closest(".pdfflow-tag-input-popup");s.contains(e)||o.contains(e)||t||a||(o.remove(),this.cleanupDropdownEventListeners())}},document.addEventListener("click",this.currentDropdownHandlers.click),setTimeout(()=>{o.getBoundingClientRect();var e=window.innerHeight,t=window.innerWidth,a=s.getBoundingClientRect(),i=e-a.bottom,r=a.top,n=Math.min(400,80*h.length+60),i=(i<n&&n<r&&(o.style.top="auto",o.style.bottom=e-a.top+4+"px"),o.getBoundingClientRect());i.bottom>e&&(n=i.bottom-e+20,"auto"!==o.style.top?o.style.top=parseInt(o.style.top)-n+"px":o.style.bottom=parseInt(o.style.bottom)+n+"px"),t<i.right&&(r=i.right-t+20,o.style.left=parseInt(o.style.left)-r+"px"),i.left<0&&(o.style.left="20px")},50)}else new Notice("ÂΩìÂâçPDFÊñáÊ°£Ê≤°ÊúâÈ´ò‰∫ÆÂ±Ç")}}catch(e){throw new Error("ÊòæÁ§∫È´ò‰∫ÆÈÄâÊã©Âô®Â§±Ë¥•: "+e.message)}}async showDocTypeSelector(r,n){try{var o=document.querySelector(".pdfflow-doc-type-dropdown");o&&o.remove();let t=document.createElement("div");t.className="pdfflow-doc-type-dropdown";var s=r.getBoundingClientRect();let e=s.bottom+4,a=s.left;e+180>window.innerHeight&&(e=s.top-180-4);(a=a+200>window.innerWidth?window.innerWidth-200-10:a)<10&&(a=10),t.style.cssText=`
                position: fixed;
                top: ${e}px;
                left: ${a}px;
                background: var(--background-primary);
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
                z-index: 100000;
                min-width: 200px;
                padding: 8px 0;
                opacity: 0;
                transform: translateY(-10px) scale(0.95);
                transition: all 0.2s ease-out;
            `;var l=document.createElement("div"),c=(l.className="pdfflow-doc-option",l.style.cssText=`
                padding: 12px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-normal);
                font-size: 14px;
                transition: background-color 0.2s ease;
            `,l.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="7" height="9" x="3" y="3" rx="1"/>
                    <rect width="7" height="5" x="14" y="3" rx="1"/>
                    <rect width="7" height="9" x="14" y="12" rx="1"/>
                    <rect width="7" height="5" x="3" y="16" rx="1"/>
                </svg>
                <span>CanvasÊñáÊ°£</span>
            `,document.createElement("div")),d=(c.className="pdfflow-doc-option",c.style.cssText=`
                padding: 12px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-normal);
                font-size: 14px;
                transition: background-color 0.2s ease;
            `,c.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>
                <span>ExcalidrawÊñáÊ°£</span>
            `,document.createElement("div"));d.className="pdfflow-doc-option",d.style.cssText=`
                padding: 12px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-normal);
                font-size: 14px;
                transition: background-color 0.2s ease;
            `,d.innerHTML=`
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>
                <span>MarkdownÊñáÊ°£</span>
            `,[l,c,d].forEach(e=>{e.addEventListener("mouseenter",()=>{e.style.backgroundColor="var(--background-modifier-hover)"}),e.addEventListener("mouseleave",()=>{e.style.backgroundColor="transparent"})}),l.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),t.remove(),await this.createAndOpenCanvasDoc(n)}),c.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),t.remove(),await this.createAndOpenExcalidrawDoc(n)}),d.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),t.remove(),await this.createAndOpenMarkdownDoc(n)}),t.appendChild(l),t.appendChild(c),t.appendChild(d),document.body.appendChild(t),requestAnimationFrame(()=>{t.style.opacity="1",t.style.transform="translateY(0) scale(1)"});let i=e=>{t.contains(e.target)||r.contains(e.target)||(t.remove(),document.removeEventListener("click",i))};setTimeout(()=>{document.addEventListener("click",i)},100)}catch(e){throw new Error("ÊòæÁ§∫ÊñáÊ°£Á±ªÂûãÈÄâÊã©Âô®Â§±Ë¥•: "+e.message)}}async createAndOpenCanvasDoc(e){if(this.checkPluginActivation())try{var a=e.file;if(a){var i=a.basename,r="Books/ÁôΩÊùøÁ¨îËÆ∞",n=r+"/"+(i+".canvas");await this.ensureFolderExists(r);let t=this.app.vault.getAbstractFileByPath(n),e=!1;if(!t){e=!0;var o={nodes:[],edges:[]};t=await this.app.vault.create(n,JSON.stringify(o,null,2)),await new Promise(e=>setTimeout(e,200));try{var s=await this.app.vault.cachedRead(t),l=JSON.parse(s);l.nodes&&l.edges||(await this.app.vault.modify(t,JSON.stringify(o,null,2)),await new Promise(e=>setTimeout(e,100)))}catch(e){await this.app.vault.modify(t,JSON.stringify(o,null,2)),await new Promise(e=>setTimeout(e,100))}}var c=await this.openFileInNewWindow(t);this.app.workspace.setActiveLeaf(c,!0,!0),e&&await new Promise(e=>setTimeout(e,300))}}catch(e){}}async createAndOpenExcalidrawDoc(e){if(this.checkPluginActivation())try{var a=e.file;if(a){var i=a.basename,r="Books/ÁôΩÊùøÁ¨îËÆ∞",n=r+"/"+(i+".excalidraw.md");await this.ensureFolderExists(r);let t=this.app.vault.getAbstractFileByPath(n),e=!1;if(!t){e=!0;var o=`---
excalidraw-plugin: parsed
tags: [excalidraw]

---
==‚ö†  Switch to EXCALIDRAW VIEW in the MORE OPTIONS menu of this document. ‚ö†== You can decompress Drawing data with the command palette: 'Decompress current Excalidraw file'. For more info check in plugin settings under 'Saving'


## Drawing
\`\`\`compressed-json
N4IgLgngDgpiBcIYA8DGBDANgSwCYCd0B3EAGhADcZ8BnbAewDsEAmcm+gV31TkQAswYKDXgB6MQHNsYfpwBGAOlT0AtmIBeNCtlQbs6RmPry6uA4wC0KDDgLFLUTJ2lH8MTDHQ0YNMWHRJMRZFEIB2MiRPVRhGMBoEAG0AXXJ0KCgAZQCwPlBJfDxM7A0+Rk5MTHIdGCIAIXRUAGsCrkZcAGF6THp8BBAAYgAzEdGQAF9xoA===
\`\`\`
%%`;t=await this.app.vault.create(n,o),await new Promise(e=>setTimeout(e,200));try{(await this.app.vault.cachedRead(t)).includes("excalidraw-plugin: parsed")||(await this.app.vault.modify(t,o),await new Promise(e=>setTimeout(e,100)))}catch(e){await this.app.vault.modify(t,o),await new Promise(e=>setTimeout(e,100))}}var s=await this.openFileInNewWindow(t);this.app.workspace.setActiveLeaf(s,!0,!0),e&&await new Promise(e=>setTimeout(e,500)),this.setupExcalidrawDropListeners()}}catch(e){}}async createAndOpenMarkdownDoc(e){if(this.checkPluginActivation())try{var t=e.file;if(t){var a=t.basename,i="Books/ËØª‰π¶Á¨îËÆ∞/"+a,r=i+"/"+(a+".md");await this.ensureFolderExists(i);let e=this.app.vault.getAbstractFileByPath(r);e||(n=await this.createNoteWithTemplate(a,"",""),e=await this.app.vault.create(r,n),await new Promise(e=>setTimeout(e,200)));var n,o=await this.openFileInNewWindow(e);this.app.workspace.setActiveLeaf(o,!0,!0)}}catch(e){}}async createHighlightItem(i,e,t,a,r){let n=document.createElement("div");n.className="pdfflow-highlight-item",n.style.cssText=`
            padding: 12px 16px;
            border-bottom: 1px solid var(--background-modifier-border-focus);
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--background-primary);
        `;var o=document.createElement("div"),s=(o.style.cssText=`
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        `,document.createElement("div")),l=(s.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `,document.createElement("span"));l.style.cssText=`
            background: var(--interactive-accent);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
        `,l.textContent=`Á¨¨${i.page}È°µ`;let c=document.createElement("div"),d=i.docType||"MD";i.linkPath&&(h=await this.getDocTypeFromLinkPathSync(i.linkPath),d=h.type,i.docType=d);if(c.innerHTML=(e=>{switch(e){case"CA":return`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect width="7" height="9" x="3" y="3" rx="1"/>
                        <rect width="7" height="5" x="14" y="3" rx="1"/>
                        <rect width="7" height="9" x="14" y="12" rx="1"/>
                        <rect width="7" height="5" x="3" y="16" rx="1"/>
                    </svg>`;case"EX":return`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                        <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                        <path d="M2 2l7.586 7.586"/>
                        <circle cx="11" cy="11" r="2"/>
                    </svg>`;default:return`<svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14,2 14,8 20,8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10,9 9,9 8,9"/>
                    </svg>`}})(d),c.style.cssText=`
            display: flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            color: var(--text-muted);
            border: 1px solid var(--background-modifier-border);
            cursor: pointer;
            transition: all 0.2s ease;
        `,c.title=(e=>{switch(e){case"CA":return"CanvasÁôΩÊùø";case"EX":return"ExcalidrawÁîªÂ∏É";case"MD":return"Markdown ÊñáÊ°£";default:return"Êú™Áü•Á±ªÂûã"}})(d),c.addEventListener("mouseenter",()=>{c.style.transform="scale(1.1)",c.style.borderColor="var(--text-accent)",c.style.color="var(--text-accent)"}),c.addEventListener("mouseleave",()=>{c.style.transform="scale(1)",c.style.borderColor="var(--background-modifier-border)",c.style.color="var(--text-muted)"}),s.appendChild(l),s.appendChild(c),i&&i.source)try{let t=document.createElement("div"),a=(t.className="pdfflow-inline-comment-btn",t.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle-more">
                        <path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
                        <path d="M8 12h.01"/>
                        <path d="M12 12h.01"/>
                        <path d="M16 12h.01"/>
                    </svg>
                `,await this.getCommentsForHighlight(i));a&&0<a.length?(t.title=`Êü•ÁúãËØÑËÆ∫ (${a.length}Êù°)`,t.style.background="rgba(239, 2, 2, 0.5)"):(t.title="Ê∑ªÂä†ËØÑËÆ∫",t.style.background="rgba(147, 138, 138, 0.1)"),t.addEventListener("mouseenter",()=>{t.style.transform="scale(1.1)",t.style.background=a&&0<a.length?"rgba(239, 2, 2, 1)":"rgba(239, 2, 2, 0.6)"}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)",t.style.background=a&&0<a.length?"rgba(239, 2, 2, 0.5)":"rgba(147, 138, 138, 0.1)"}),t.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.showCommentPopup(t,a||[],i)}),s.appendChild(t)}catch(e){}var h=document.createElement("div");h.style.cssText=`
            display: flex;
            align-items: center;
            gap: 8px;
        `;let p=document.createElement("span"),u=(p.textContent="#"+(r-e+1),p.style.cssText=`
            font-size: 10px;
            font-weight: 600;
            color: var(--text-muted);
            background: var(--background-secondary);
            padding: 3px 8px;
            border-radius: 10px;
            border: 1px solid var(--background-modifier-border);
            letter-spacing: 0.3px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
        `,document.createElement("div"));u.className="pdfflow-color-dot";l=i.color||"yellow",u.style.cssText=`
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: ${this.getHighlightColor(l)};
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        `,u.addEventListener("mouseenter",()=>{u.style.transform="scale(1.2)",u.style.boxShadow="0 2px 6px rgba(0, 0, 0, 0.3)"}),u.addEventListener("mouseleave",()=>{u.style.transform="scale(1)",u.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)"}),u.addEventListener("click",async e=>{e.preventDefault(),e.stopPropagation(),await this.showColorSelector(u,i,t,a)}),p.addEventListener("mouseenter",()=>{p.style.backgroundColor="var(--background-modifier-hover)",p.style.borderColor="var(--interactive-accent)",p.style.color="var(--text-normal)",p.style.transform="scale(1.05)"}),p.addEventListener("mouseleave",()=>{p.style.backgroundColor="var(--background-secondary)",p.style.borderColor="var(--background-modifier-border)",p.style.color="var(--text-muted)",p.style.transform="scale(1)"}),h.appendChild(p),h.appendChild(u),o.appendChild(s),o.appendChild(h),r=await this.getHighlightPreviewText(i,t),e=document.createElement("div"),e.style.cssText=`
            font-size: 13px;
            color: var(--text-normal);
            line-height: 1.4;
            background: var(--background-secondary);
            padding: 8px 10px;
            border-radius: 4px;
            border-left: 3px solid ${this.getHighlightColor(i.color)};
            max-height: 60px;
            overflow: hidden;
            word-break: break-word;

        `,e.textContent=r,l=document.createElement("div");return l.className="pdfflow-tags-container",l.style.cssText=`
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 6px;
            padding: 0 10px;
        `,n.appendChild(o),n.appendChild(e),n.appendChild(l),await this.loadExistingTags(i,l),n.addEventListener("click",async e=>{if(!e.target.closest(".pdfflow-color-dot")){e.preventDefault(),e.stopPropagation();try{a&&(a.remove(),this.cleanupDropdownEventListeners()),n.style.opacity="0.5",n.style.pointerEvents="none";let e=new Notice("Ê≠£Âú®ÊâìÂºÄÂØπÂ∫îÊñáÊ°£...",0);this.jumpToHighlight(t,i),setTimeout(async()=>{await this.openBacklinkFromHighlight(i),e.hide()},200)}catch(e){}}}),n}async showColorSelector(d,h,p,u,g=null){var e=document.querySelector(".pdfflow-color-selector");if(e)e.remove();else{let c=document.createElement("div");c.className="pdfflow-color-selector";e=d.getBoundingClientRect();c.style.cssText=`
            position: fixed;
            top: ${e.bottom+4}px;
            left: ${e.left-60}px;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
            z-index: 100000;
            padding: 8px;
            display: flex;
            gap: 6px;
            animation: colorSelectorSlideDown 0.2s ease-out;
        `;[{name:"yellow",hex:"#ffd000",label:"ÈªÑËâ≤"},{name:"red",hex:"#ff5252",label:"Á∫¢Ëâ≤"},{name:"blue",hex:"#2196f3",label:"ËìùËâ≤"},{name:"green",hex:"#4caf50",label:"ÁªøËâ≤"},{name:"purple",hex:"#9c27b0",label:"Á¥´Ëâ≤"}].forEach(l=>{let e=document.createElement("div"),t=(e.className="pdfflow-color-option",(h.color||"yellow")===l.name);var a;e.style.cssText=`
                width: 20px;
                height: 20px;
                border-radius: 50%;
                background-color: ${l.hex};
                border: 2px solid ${t?"var(--interactive-accent)":"rgba(255, 255, 255, 0.8)"};
                cursor: pointer;
                transition: all 0.2s ease;
                position: relative;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
            `,t&&((a=document.createElement("div")).innerHTML="‚úì",a.style.cssText=`
                    position: absolute;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    color: white;
                    font-size: 10px;
                    font-weight: bold;
                    text-shadow: 0 0 2px rgba(0, 0, 0, 0.5);
                `,e.appendChild(a)),e.title=l.label,e.addEventListener("mouseenter",()=>{t||(e.style.transform="scale(1.1)",e.style.boxShadow="0 2px 6px rgba(0, 0, 0, 0.3)")}),e.addEventListener("mouseleave",()=>{t||(e.style.transform="scale(1)",e.style.boxShadow="0 1px 3px rgba(0, 0, 0, 0.2)")}),e.addEventListener("click",async t=>{if(t.preventDefault(),t.stopPropagation(),c.remove(),(h.color||"yellow")!==l.name){t=new Notice("Ê≠£Âú®Êõ¥Êñ∞È´ò‰∫ÆÈ¢úËâ≤...",0);try{await this.updateHighlightColor(h,l.name,p),d.style.backgroundColor=l.hex,u&&(e=d.closest(".pdfflow-highlight-item")?.querySelector('div[style*="border-left"]'))&&(a=e.style.cssText,e.style.cssText=a.replace(/border-left: 3px solid [^;]+/,"border-left: 3px solid "+l.hex)),g&&((i=g.querySelector(".pdfflow-color-dot"))&&(i.style.backgroundColor=l.hex),r=g.querySelector('div[style*="border-left"]'))&&(n=r.style.cssText,r.style.cssText=n.replace(/border-left: 3px solid [^;]+/,"border-left: 3px solid "+l.hex));var e,a,i,r,n,o,s=d.closest(".pdfflow-comment-popup");s&&(o=s.querySelector(".pdfflow-color-dot"))&&(o.style.backgroundColor=l.hex),t.hide()}catch(e){t.hide()}}}),c.appendChild(e)}),document.body.appendChild(c);let t=e=>{c.contains(e.target)||d.contains(e.target)||(c.remove(),document.removeEventListener("click",t))};setTimeout(()=>{document.addEventListener("click",t)},100)}}async updateHighlightColor(i,r,n){if(this.checkPluginActivation())try{if(i.source){var o=this.app.vault.getAbstractFileByPath(i.source);if(o){var s,l,c,d,h,p,u,g=await this.app.vault.cachedRead(o),f=[];let e="",t=(i.select?(s=Array.isArray(i.select)?i.select.join(","):i.select,e=`page=${i.page}&select=`+s,f.push(e+"&color="+(i.color||"yellow")),f.push(e+"&color=yellow")):i.square&&(l=Array.isArray(i.square)?i.square.join(","):i.square,e=`page=${i.page}&square=`+l,f.push(e+"&color="+(i.color||"yellow")),f.push(e+"&color=yellow")),g),a=!1;for(c of f){var m=c.replace(/&color=[^&|]+/,"&color="+r);if(t.includes(c)&&c!==m){t=t.replace(new RegExp(c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),m),a=!0;break}}if(!a&&e&&(d=new RegExp(`(${e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")})(&color=[^&|]+)?`,"g"),(h=t.replace(d,(e,t,a)=>t+"&color="+r))!==t)&&(t=h,a=!0),a)return await this.app.vault.modify(o,t),i.color=r,p=n.file.path,this.highlightIndex&&this.highlightIndex.has(p)&&(u=this.highlightIndex.get(p).find(e=>e.page===i.page&&e.source===i.source&&JSON.stringify(e.select)===JSON.stringify(i.select)))&&(u.color=r),setTimeout(()=>{this.updateHighlights()},500),!0;throw new Error("Êú™ÊâæÂà∞ÂåπÈÖçÁöÑÈ´ò‰∫ÆÈìæÊé•ËøõË°åÊõ¥Êñ∞")}}throw new Error("Êó†Ê≥ïÊâæÂà∞È´ò‰∫ÆÁöÑÊ∫êÊñá‰ª∂")}catch(e){throw e}}async getHighlightPreviewText(t,e){try{if(t.source){var a=this.app.vault.getAbstractFileByPath(t.source);if(a){var i,r,n=await this.app.vault.cachedRead(a),o=[],s=(t.select&&(i=Array.isArray(t.select)?t.select.join(","):t.select,o.push(`page=${t.page}&select=`+i),o.push(`page=${t.page}.*select=`+i.replace(/,/g,"\\s*,\\s*"))),t.square&&(r=Array.isArray(t.square)?t.square.join(","):t.square,o.push(`page=${t.page}&square=`+r),o.push(`page=${t.page}.*square=`+r.replace(/,/g,"\\s*,\\s*"))),n.split("\n"));for(let t=0;t<s.length;t++){let a=s[t];if(o.some(t=>{try{return new RegExp(t,"i").test(a)}catch(e){return a.includes(t.replace(/\\.*/g,""))}})){var l=this.extractTextBeforeLink(a);if(l&&10<l.length)return this.truncateText(l,120);for(let e=t-1;0<=e;e--){var c=s[e].trim();if(c&&this.isValidTextContent(c))return this.truncateText(c,120)}for(let e=t+1;e<s.length&&e<t+3;e++){var d=s[e].trim();if(d&&this.isValidTextContent(d))return this.truncateText(d,120)}}}}}return this.generateHighlightDescription(t)}catch(e){return this.generateHighlightDescription(t)}}extractTextBeforeLink(t){try{let e=t;return 10<(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/üîó\[\[.*?\]\]/g,"")).replace(/!\[\[.*?\]\]/g,"")).replace(/\[\[.*?\]\]/g,"")).replace(/‚úèÔ∏èËØÑËÆ∫Ôºö.*$/g,"")).replace(/`INPUT\[.*?\]`/g,"")).replace(/^#+\s*/,"")).replace(/\*\*(.*?)\*\*/g,"$1")).replace(/\*(.*?)\*/g,"$1")).replace(/`(.*?)`/g,"$1")).trim()).length?e:null}catch(e){return null}}isValidTextContent(t){return!(!t||t.length<5||[/^#+\s*/,/^\[\[/,/^!\[\[/,/üîó/,/‚úèÔ∏è/,/^<!--/,/^```/,/^\|/,/^[-*+]\s/,/^\d+\.\s/,/^>\s/,/INPUT\[.*?\]/,/^---+$/,/^===+$/].some(e=>e.test(t)))}generateHighlightDescription(e){var t=`Á¨¨${e.page}È°µ`;if(e.select){var a=Array.isArray(e.select)?e.select.join(","):e.select;try{var i,r,n,o,s=a.split(",").map(Number);if(4<=s.length)return[i,r,n,o]=s,i===n?t+`ÁöÑÊñáÂ≠óÈÄâÊã© (Á¨¨${i+1}‰∏™ÊñáÊú¨ÂÖÉÁ¥†ÔºåÂ≠óÁ¨¶${r}-${o})`:t+`ÁöÑÊñáÂ≠óÈÄâÊã© (Ë∑®Ë∂ä${n-i+1}‰∏™ÊñáÊú¨ÂÖÉÁ¥†)`}catch(e){}return t+"ÁöÑÊñáÂ≠óÈ´ò‰∫ÆÈÄâÊã©"}return e.square?t+"ÁöÑÁü©ÂΩ¢Âå∫ÂüüÊà™Âõæ":t+"ÁöÑÈ´ò‰∫ÆÂÜÖÂÆπ"}truncateText(e,t){return e.length<=t?e:e.substring(0,t-3)+"..."}getHighlightColor(e){return{yellow:"#ffd000",red:"#ff5252",blue:"#2196f3",green:"#4caf50",orange:"#ff9800",purple:"#9c27b0",pink:"#e91e63"}[e]||"#ffd000"}getPdfViewFromHighlightData(e){try{if(!e||!e.linkPath)return null;var t,a=e.linkPath.split("#")[0];for(t of this.app.workspace.getLeavesOfType("pdf")){var i=t.view;if(i&&i.file&&i.file.path===a)return i}var r=this.app.workspace.activeLeaf;return r&&r.view&&r.view.file&&r.view.file.path===a?r.view:null}catch(e){return null}}cleanupDropdownEventListeners(){this.currentDropdownHandlers&&(this.currentDropdownHandlers.click&&document.removeEventListener("click",this.currentDropdownHandlers.click),this.currentDropdownHandlers.keydown&&document.removeEventListener("keydown",this.currentDropdownHandlers.keydown),this.currentDropdownHandlers=null)}showPdfContextMenu(n,o,s,l,c){if(this.checkPluginActivation()){this.hideContextMenu();var d=document.querySelector(".menu-scroll");if(d)this.addOptionsToPdfPlusMenu(d,o,s,l,c);else{let i=document.createElement("div");i.className="pdfflow-context-menu",i.style.cssText=`
            position: fixed;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
            z-index: 100001;
            padding: 4px 0;
            min-width: 180px;
            animation: contextMenuSlideIn 0.15s ease-out;
        `;d=[{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="7" height="9" x="3" y="3" rx="1"/>
                    <rect width="7" height="5" x="14" y="3" rx="1"/>
                    <rect width="7" height="9" x="14" y="12" rx="1"/>
                    <rect width="7" height="5" x="3" y="16" rx="1"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞CanvasÊñáÊ°£",action:()=>this.addToCanvasFromContextSilent(o,s,l,c)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞ExcalidrawÊñáÊ°£ÔºàÁõÆÂâç‰∏çÊîØÊåÅÔºâ",action:()=>this.addToExcalidrawFromContextSilent(o,s,l,c)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞MarkdownÊñáÊ°£",action:()=>this.addToMarkdownFromContextSilent(o,s,l,c)}];d.forEach((t,e)=>{let a=document.createElement("div");a.className="pdfflow-context-menu-item",a.style.cssText=`
                padding: 8px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-normal);
                font-size: 14px;
                transition: background-color 0.2s ease;
            `,a.innerHTML=t.icon+`<span>${t.text}</span>`,a.addEventListener("mouseenter",()=>{a.style.backgroundColor="var(--background-modifier-hover)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="transparent"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.hideContextMenu(),t.action()}),a.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),this.hideContextMenu(),t.action()}),i.appendChild(a)});let e=n.clientX,t=n.clientY;n=40*d.length+8;e+180>window.innerWidth&&(e=window.innerWidth-180-10),t+n>window.innerHeight&&(t=window.innerHeight-n-10),i.style.left=e+"px",i.style.top=t+"px",document.body.appendChild(i),this.currentContextMenu=i;let a=e=>{i.contains(e.target)||(this.hideContextMenu(),document.removeEventListener("click",a),document.removeEventListener("contextmenu",a))},r=(setTimeout(()=>{document.addEventListener("click",a),document.addEventListener("contextmenu",a)},100),e=>{"Escape"===e.key&&(this.hideContextMenu(),document.removeEventListener("keydown",r))});document.addEventListener("keydown",r),i._closeHandler=a,i._escHandler=r}}}hideContextMenu(){this.currentContextMenu&&(this.currentContextMenu._closeHandler&&(document.removeEventListener("click",this.currentContextMenu._closeHandler),document.removeEventListener("contextmenu",this.currentContextMenu._closeHandler)),this.currentContextMenu._escHandler&&document.removeEventListener("keydown",this.currentContextMenu._escHandler),this.currentContextMenu.remove(),this.currentContextMenu=null)}addOptionsToPdfPlusMenu(i,e,t,a,r){var n=document.createElement("div");n.className="pdfflow-menu-separator",n.style.cssText=`
            height: 1px;
            background: var(--background-modifier-border);
            margin: 4px 0;
        `,i.appendChild(n),[{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect width="7" height="9" x="3" y="3" rx="1"/>
                    <rect width="7" height="5" x="14" y="3" rx="1"/>
                    <rect width="7" height="9" x="14" y="12" rx="1"/>
                    <rect width="7" height="5" x="3" y="16" rx="1"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞CanvasÊñáÊ°£",action:()=>this.addToCanvasFromContextSilent(e,t,a,r)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 19l7-7 3 3-7 7-3-3z"/>
                    <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"/>
                    <path d="M2 2l7.586 7.586"/>
                    <circle cx="11" cy="11" r="2"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞ExcalidrawÊñáÊ°£ÔºàÁõÆÂâç‰∏çÊîØÊåÅÔºâ",action:()=>this.addToExcalidrawFromContextSilent(e,t,a,r)},{icon:`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                    <polyline points="14,2 14,8 20,8"/>
                    <line x1="16" y1="13" x2="8" y2="13"/>
                    <line x1="16" y1="17" x2="8" y2="17"/>
                    <polyline points="10,9 9,9 8,9"/>
                </svg>`,text:"Ê∑ªÂä†Âà∞MarkdownÊñáÊ°£",action:()=>this.addToMarkdownFromContextSilent(e,t,a,r)}].forEach((t,e)=>{let a=document.createElement("div");a.className="pdfflow-context-menu-item",a.style.cssText=`
                padding: 8px 16px;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 12px;
                color: var(--text-normal);
                font-size: 14px;
                transition: background-color 0.2s ease;
            `,a.innerHTML=t.icon+`<span>${t.text}</span>`,a.addEventListener("mouseenter",()=>{a.style.backgroundColor="var(--background-modifier-hover)"}),a.addEventListener("mouseleave",()=>{a.style.backgroundColor="transparent"}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),t.action()}),a.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),t.action()}),i.appendChild(a)})}async addToCanvasFromContextSilent(i,r,n,e){if(this.checkPluginActivation())try{var o=e.file;if(o){var s,l,c,d,h,p=o.basename,u="Books/ÁôΩÊùøÁ¨îËÆ∞",g=u+"/"+(p+".canvas");await this.ensureFolderExists(u);let e=this.app.vault.getAbstractFileByPath(g);e||(s={nodes:[],edges:[]},e=await this.app.vault.create(g,JSON.stringify(s,null,2)),await new Promise(e=>setTimeout(e,200)));let t;var f,m={text:i,file:o,pageInfo:t=r&&0<r.rangeCount&&(l=r.getRangeAt(0),c=n.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(d=this.filterValidTextRange(l,c))?((h=window.getSelection()).removeAllRanges(),h.addRange(d),this.getPageInfoFromSelection(h,n)):this.getPageInfoFromSelection(r,n),type:"text"},v=await this.createExcerptNote(m),w={clientX:this.defaultCanvasCoords.x,clientY:this.defaultCanvasCoords.y,preciseClientX:this.defaultCanvasCoords.x,preciseClientY:this.defaultCanvasCoords.y},y=this.app.workspace.getLeavesOfType("canvas");let a=null;for(f of y)if(f.view&&f.view.file&&f.view.file.path===g){a=f.view;break}a?await this.createCanvasCard(a,v,w):await this.createCanvasCardSilent(e,v,w),this.updateHighlights(),this.defaultCanvasCoords.x+=100,this.defaultCanvasCoords.y+=50,800<this.defaultCanvasCoords.x&&(this.defaultCanvasCoords.x=100,this.defaultCanvasCoords.y+=100)}}catch(e){}}async createCanvasCardSilent(e,t,a){try{var i=await this.app.vault.read(e),r=JSON.parse(i),n=this.generateNodeId(),o=`![[${t.noteFile.path.replace(/\.md$/,"")}#Note${t.noteTitle}]]

`,s={id:n,type:"text",text:o,x:a.clientX-150,y:a.clientY-Math.floor(200),width:500,height:400,color:"1"};r.nodes.push(s),await this.app.vault.modify(e,JSON.stringify(r,null,2))}catch(e){throw e}}async addToCanvasFromContext(i,r,n,e){try{var o=e.file;if(o){var s,l,c,d,h,p=o.basename,u="Books/ÁôΩÊùøÁ¨îËÆ∞",g=u+"/"+(p+".canvas");await this.ensureFolderExists(u);let t=this.app.vault.getAbstractFileByPath(g);t||(s={nodes:[],edges:[]},t=await this.app.vault.create(g,JSON.stringify(s,null,2)),await new Promise(e=>setTimeout(e,200)));let e;var f={text:i,file:o,pageInfo:e=r&&0<r.rangeCount&&(l=r.getRangeAt(0),c=n.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(d=this.filterValidTextRange(l,c))?((h=window.getSelection()).removeAllRanges(),h.addRange(d),this.getPageInfoFromSelection(h,n)):this.getPageInfoFromSelection(r,n),type:"text"},m=await this.createExcerptNote(f),v={clientX:this.defaultCanvasCoords.x,clientY:this.defaultCanvasCoords.y,preciseClientX:this.defaultCanvasCoords.x,preciseClientY:this.defaultCanvasCoords.y};let a=null;var w,y=this.app.workspace.getLeavesOfType("canvas").find(e=>e.view.file===t);y?(a=y.view,this.app.workspace.setActiveLeaf(y,!0,!0)):(await(w=this.app.workspace.getLeaf(!1)).openFile(t),a=w.view,this.app.workspace.setActiveLeaf(w,!0,!0)),await new Promise(e=>setTimeout(e,300)),await this.createCanvasCard(a,m,v),this.defaultCanvasCoords.x+=100,this.defaultCanvasCoords.y+=50,800<this.defaultCanvasCoords.x&&(this.defaultCanvasCoords.x=100,this.defaultCanvasCoords.y+=200),this.updateHighlights()}}catch(e){}}async addToExcalidrawFromContextSilent(e,t,a,i){this.checkPluginActivation()&&new Notice("ExcalidrawÂäüËÉΩÊöÇ‰∏çÊîØÊåÅ")}async addToExcalidrawFromContext(i,r,n,e){try{var o=e.file;if(o){var s,l,c,d,h=o.basename,p="Books/ÁôΩÊùøÁ¨îËÆ∞",u=p+"/"+(h+".excalidraw.md");await this.ensureFolderExists(p);let t=this.app.vault.getAbstractFileByPath(u);t||(t=await this.app.vault.create(u,`---

excalidraw-plugin: parsed
tags: [excalidraw]

---
==‚ö†  Switch to EXCALIDRAW VIEW in the MORE OPTIONS menu of this document. ‚ö†== You can decompress Drawing data with the command palette: 'Decompress current Excalidraw file'. For more info check in plugin settings under 'Saving'


## Drawing
\`\`\`compressed-json
N4IgLgngDgpiBcIYA8DGBDANgSwCYCd0B3EAGhADcZ8BnbAewDsEAmcm+gV31TkQAswYKDXgB6MQHNsYfpwBGAOlT0AtmIBeNCtlQbs6RmPry6uA4wC0KDDgLFLUTJ2lH8MTDHQ0YNMWHRJMRZFEIB2MiRPVRhGMBoEAG0AXXJ0KCgAZQCwPlBJfDxM7A0+Rk5MTHIdGCIAIXRUAGsCrkZcAGF6THp8BBAAYgAzEdGQAF9xoA===
\`\`\`
%%`),await new Promise(e=>setTimeout(e,200)));let e;var g={text:i,file:o,pageInfo:e=r&&0<r.rangeCount&&(s=r.getRangeAt(0),l=n.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(c=this.filterValidTextRange(s,l))?((d=window.getSelection()).removeAllRanges(),d.addRange(c),this.getPageInfoFromSelection(d,n)):this.getPageInfoFromSelection(r,n),type:"text"},f=await this.createExcerptNote(g);let a=null;var m,v=this.app.workspace.getLeavesOfType("excalidraw").find(e=>e.view.file===t),w=(v?(a=v.view,this.app.workspace.setActiveLeaf(v,!0,!0)):(await(m=this.app.workspace.getLeaf(!1)).openFile(t),a=m.view,this.app.workspace.setActiveLeaf(m,!0,!0)),await new Promise(e=>setTimeout(e,500)),{clientX:this.defaultExcalidrawCoords.x,clientY:this.defaultExcalidrawCoords.y,preciseClientX:this.defaultExcalidrawCoords.x,preciseClientY:this.defaultExcalidrawCoords.y});await this.createExcalidrawElement(a,f,w),this.defaultExcalidrawCoords.x+=100,this.defaultExcalidrawCoords.y+=50,800<this.defaultExcalidrawCoords.x&&(this.defaultExcalidrawCoords.x=100,this.defaultExcalidrawCoords.y+=200),this.updateHighlights()}}catch(e){}}async addToMarkdownFromContextSilent(a,i,r,e){if(this.checkPluginActivation())try{var n=e.file;if(n){var o,s,l,c,d,h=n.basename,p="Books/ËØª‰π¶Á¨îËÆ∞/"+h,u=p+"/"+(h+".md");await this.ensureFolderExists(p);let e=this.app.vault.getAbstractFileByPath(u);e||(o=await this.createNoteWithTemplate(h,"",""),e=await this.app.vault.create(u,o),await new Promise(e=>setTimeout(e,200)));let t;var g,f={text:a,file:n,pageInfo:t=i&&0<i.rangeCount&&(s=i.getRangeAt(0),l=r.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(c=this.filterValidTextRange(s,l))?((d=window.getSelection()).removeAllRanges(),d.addRange(c),this.getPageInfoFromSelection(d,r)):this.getPageInfoFromSelection(i,r),type:"text"},m=await this.createExcerptNote(f),v=await this.app.vault.read(e),{noteTitle:w,excerptContent:y}=m,x=`

`+y,b="### Note"+w,C=`[[${n.name}#page=${t.page}&select=${t.select}&color=yellow| p.${t.page}]]`;v.includes(b)&&v.includes(C)||(g=v+x,await this.app.vault.modify(e,g),setTimeout(()=>{this.updateHighlights()},100))}}catch(e){}}async addToMarkdownFromContext(a,i,r,e){try{var n=e.file;if(n){var o,s,l,c,d,h=n.basename,p="Books/ËØª‰π¶Á¨îËÆ∞/"+h,u=p+"/"+(h+".md");await this.ensureFolderExists(p);let t=this.app.vault.getAbstractFileByPath(u);t||(o=await this.createNoteWithTemplate(h,"",""),t=await this.app.vault.create(u,o),await new Promise(e=>setTimeout(e,200)));let e;var g={text:a,file:n,pageInfo:e=i&&0<i.rangeCount&&(s=i.getRangeAt(0),l=r.querySelector(".pdf-viewer, .pdfViewer, [data-page-number]"))&&(c=this.filterValidTextRange(s,l))?((d=window.getSelection()).removeAllRanges(),d.addRange(c),this.getPageInfoFromSelection(d,r)):this.getPageInfoFromSelection(i,r),type:"text"},f=await this.createExcerptNote(g),m=await this.app.vault.read(t),{noteTitle:v,excerptContent:w}=f,y=`

`+w,x="### Note"+v,b=`[[${n.name}#page=${e.page}&select=${e.select}&color=yellow| p.${e.page}]]`;if(!m.includes(x)||!m.includes(b)){var C=m+y;await this.app.vault.modify(t,C);let e=null;var E,k,T,S=this.app.workspace.getLeavesOfType("markdown").find(e=>e.view.file===t);S?(e=S.view,this.app.workspace.setActiveLeaf(S,!0,!0)):(await(E=this.app.workspace.getLeaf(!1)).openFile(t),e=E.view,this.app.workspace.setActiveLeaf(E,!0,!0)),await new Promise(e=>setTimeout(e,300)),e&&e.editor&&(T=(k=e.editor).lineCount(),k.scrollIntoView({line:T-1,ch:0},!0),k.setCursor({line:T-1,ch:k.getLine(T-1).length})),setTimeout(()=>{this.updateHighlights()},100)}}}catch(e){}}setupCanvasPdfLinkListeners(){this.registerEvent(this.app.workspace.on("layout-change",()=>{this.addCanvasPdfLinkListeners()})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{this.addCanvasPdfLinkListeners()})),this.addCanvasPdfLinkListeners()}addCanvasPdfLinkListeners(){this.app.workspace.getLeavesOfType("canvas").forEach(e=>{e=e.view;e&&e.canvas&&e.canvas.wrapperEl&&this.setupCanvasPdfLinkListener(e)})}setupCanvasPdfLinkListener(t){var e,a=t.canvas.wrapperEl;a.hasAttribute("pdfflow-pdf-link-listener")||(a.setAttribute("pdfflow-pdf-link-listener","true"),a.addEventListener("click",e=async e=>{await this.handleCanvasClick(e,t)},!0),a._pdfflowPdfLinkClickHandler=e)}async handleCanvasClick(t,e){var a=t.target;if(a.matches("a.internal-link")||a.closest("a.internal-link")){var i=a.matches("a.internal-link")?a:a.closest("a.internal-link"),r=i.getAttribute("href")||i.getAttribute("data-href");if(r){var n=r.match(/^([^#]+\.pdf)#(.+)$/);if(n){var[,,,]=n;let e=this.parsePdfLink(r);if(e)return t.preventDefault(),t.stopPropagation(),void await this.handlePdfLinkClick(e)}n=r.match(/^([^#]+)#(.+)$/);if(n&&!n[1].endsWith(".pdf")){var[,r,n]=n;let e=await this.parseInternalLink(r+"#"+n);if(e)return t.preventDefault(),t.stopPropagation(),void await this.handlePdfLinkClick(e)}}r=i.textContent||i.innerText||"";if(r){let e=await this.extractPdfLinkFromText(r);if(e)return t.preventDefault(),t.stopPropagation(),void await this.handlePdfLinkClick(e)}}let o=a,s=null;for(let e=0;e<5&&o;e++){var l=o.textContent||"";if(s=await this.extractPdfLinkFromText(l))break;o=o.parentElement}s&&(t.preventDefault(),t.stopPropagation(),await this.handlePdfLinkClick(s))}async extractPdfLinkFromText(e){var t=/\[\[([^\|\]]+\.pdf#[^\]]+)\|[^\]]+\]\]/g.exec(e);return t?this.parsePdfLink(t[1]):(t=/!?\[\[([^\]]+#[^\]]+)\]\]/g.exec(e))?this.parseInternalLink(t[1]):null}parsePdfLink(e){try{var t,a,i,r,[n,o]=e.split("#");return n&&o?(t=new URLSearchParams(o),a=parseInt(t.get("page")),i=t.get("select"),r=t.get("color"),!a||isNaN(a)?null:{filePath:n,page:a,select:i?i.split(",").map(Number):null,color:r||"yellow"}):null}catch(e){return null}}async parseInternalLink(r){try{var[n,o]=r.split("#");if(!n||!o)return null;var s,l=[n+".md",n,decodeURIComponent(n)+".md",decodeURIComponent(n)];let e=null,a="";for(s of l)if(e=this.app.vault.getAbstractFileByPath(s)){a=s;break}if(!e){let t=n.split("/").pop();var c=this.app.vault.getMarkdownFiles();(e=c.find(e=>e.name===t+".md"||e.name===t||e.basename===t))&&(a=e.path)}if(!e)return null;var d,h=await this.app.vault.read(e),p=decodeURIComponent(o),u=[new RegExp(`### ${o}[\\s\\S]*?(?=### |$)`,"i"),new RegExp(`### ${p}[\\s\\S]*?(?=### |$)`,"i"),new RegExp(`## ${o}[\\s\\S]*?(?=## |$)`,"i"),new RegExp(`## ${p}[\\s\\S]*?(?=## |$)`,"i"),new RegExp(`# ${o}[\\s\\S]*?(?=# |$)`,"i"),new RegExp(`# ${p}[\\s\\S]*?(?=# |$)`,"i")];let t=null;for(d of u)if(t=d.exec(h))break;if(!t)return null;var g,f,m,v,w,y,x,b=t[0];let i=null;for(g of[/üîó\[\[([^\]]+\.pdf#[^\]]+)\|[^\]]+\]\]/,/\[\[([^\]]+\.pdf#[^\]]+)\|[^\]]+\]\]/,/üîó\[\[([^\]]+\.pdf#[^\]]+)\]\]/,/\[\[([^\]]+\.pdf#[^\]]+)\]\]/])if(i=g.exec(b))break;return i?([f,m]=i[1].split("#"),!f||!m||(v=new URLSearchParams(m),w=parseInt(v.get("page")),y=v.get("select")||v.get("square"),x=v.get("color"),!w)||isNaN(w)?null:{filePath:f,page:w,select:y?y.split(",").map(Number):null,color:x||"yellow",isInternalLink:!0,sourceFile:a,noteTitle:o}):null}catch(e){return null}}async handlePdfLinkClick(e){try{var{filePath:a,page:i,select:r}=e,t=this.app.vault.getAbstractFileByPath(a);if(!t){let t=a.split("/").pop();var n=this.app.vault.getFiles().find(e=>"pdf"===e.extension&&e.name===t);return n?void await this.openPdfAndJumpToPage(n,i,r):void new Notice("Êâæ‰∏çÂà∞PDFÊñá‰ª∂: "+a)}await this.openPdfAndJumpToPage(t,i,r)}catch(e){}}async openPdfAndJumpToPage(t,a,i){try{var r,n=this.app.workspace.getLeavesOfType("pdf");let e=null;for(r of n)if(r.view&&r.view.file&&r.view.file.path===t.path){e=r;break}if(e)this.app.workspace.setActiveLeaf(e,!0,!0),setTimeout(()=>{this.jumpToPageInPdfView(e.view,a,i)},200);else{let e=await this.openPdfInLeftSplit(t);e&&e.view&&setTimeout(()=>{this.jumpToPageInPdfView(e.view,a,i)},1e3)}}catch(e){}}async openPdfInLeftSplit(e){try{var t=this.app.workspace,a=t.activeLeaf;if(a){var i=a.view.file;try{var r=t.getLeaf("split","vertical");return i&&await r.openFile(i),await a.openFile(e),a}catch(e){}return await a.openFile(e),a}var n=t.getLeaf(!1);return await n.openFile(e),n}catch(e){throw e}}jumpToPageInPdfView(t,a,i){try{var r=t.containerEl;if(r){let e=r.querySelectorAll(".page")[a-1];e?(e.scrollIntoView({behavior:"smooth",block:"start"}),i&&4===i.length&&setTimeout(()=>{this.jumpToTextHighlightInPage(e,i)},500)):this.tryPdfInternalJump(t,a)}}catch(e){}}tryPdfInternalJump(e,t){try{e.viewer&&void 0!==e.viewer.currentPageNumber?e.viewer.currentPageNumber=t:e.pdfViewer&&void 0!==e.pdfViewer.currentPageNumber&&(e.pdfViewer.currentPageNumber=t)}catch(e){}}jumpToTextHighlightInPage(e,t){try{var a,[i,,,,]=t,r=e.querySelector(".textLayer");r&&(a=r.querySelectorAll("span, div"))[i]&&a[i].scrollIntoView({behavior:"smooth",block:"center",inline:"center"})}catch(e){}}cleanupCanvasPdfLinkListeners(){document.querySelectorAll('[pdfflow-pdf-link-listener="true"]').forEach(e=>{e._pdfflowPdfLinkClickHandler&&(e.removeEventListener("click",e._pdfflowPdfLinkClickHandler,!0),e._pdfflowPdfLinkClickHandler=null),e.removeAttribute("pdfflow-pdf-link-listener")})}async _performInitialSecurityChecks(){try{var e;return this.isMobileDevice()?!0:(e=[this._checkRuntimeEnvironment(),this._checkFileIntegrity(),_0xSec.checkDebug(),_0xSec.checkConsole()],3<=(await Promise.all(e)).filter(Boolean).length)}catch(e){return this.isMobileDevice()?!0:!1}}_triggerSecurityFailure(e="Êú™Áü•ÂéüÂõ†"){this.isPluginActivated=!1,this._clearSecurityState(),this._logSecurityEvent("ÂÆâÂÖ®Ê£ÄÊü•Â§±Ë¥•: "+e),setTimeout(()=>{this.onunload&&this.onunload()},1e3*Math.random())}_generateIntegrityHash(){return _0xSec.generateHash()}_startContinuousValidation(){this._continuousValidationTimer&&clearInterval(this._continuousValidationTimer),this._continuousValidationTimer=setInterval(async()=>{await this.checkAndUpdateStatus()},3e4),this._integrityCheckTimer=setInterval(()=>{this._quickIntegrityCheck()||this._triggerSecurityFailure("È™åËØÅÂ§±Ë¥•")},6e5)}_setupPluginStateMonitor(){this._pluginStateMonitorTimer&&clearInterval(this._pluginStateMonitorTimer),this._pluginStateMonitorTimer=setInterval(async()=>{try{var e=await this._enhancedContentProtectionCheck();e!==this.isPluginActivated&&(e?(this.isPluginActivated=!0,this._startContinuousValidation(),await this.initializePluginFeatures()):(this.isPluginActivated=!1,this._triggerGracefulShutdown()))}catch(e){}},5e3)}_clearSecurityState(){this._bindingIntegrity=null,this._lastValidation=0,this._validationCounter=0,this._securityKeys=null,this._continuousValidationTimer&&(clearInterval(this._continuousValidationTimer),this._continuousValidationTimer=null),this._integrityCheckTimer&&(clearInterval(this._integrityCheckTimer),this._integrityCheckTimer=null),this._pluginStateMonitorTimer&&(clearInterval(this._pluginStateMonitorTimer),this._pluginStateMonitorTimer=null)}async _performPeriodicIntegrityCheck(){try{return[void 0!==this[_obf.a],void 0!==_obf.cp,"function"==typeof _0x4d2f,_0xStr.verify(this._securityKeys?.pluginId)].every(Boolean)}catch(e){return!1}}_validateProperty(e,t){try{return e&&t?t===_obf.ia?!0===e[t]:t===_obf.di?e[t]&&"string"==typeof e[t]&&0<e[t].trim().length:t===_obf.hba?!0===e[t]:t in e:!1}catch(e){return!1}}_detectConsoleUsage(){try{let t=0;return["log","warn","error","debug"].forEach(e=>{e=window[_obf.con][e];e.toString().length!==e.toString.length&&t++}),t}catch(e){return 0}}_quickIntegrityCheck(){try{return this.isMobileDevice()?this._securityKeys&&void 0!==this[_obf.a]&&Date.now()-this._lastValidation<12e5:this._bindingIntegrity&&this._securityKeys&&void 0!==this[_obf.a]&&Date.now()-this._lastValidation<6e5}catch(e){return this.isMobileDevice()}}_logSecurityEvent(e){(new Date).toISOString()}_triggerGracefulShutdown(){this.isPluginActivated=!1,this._clearSecurityState(),setTimeout(()=>{this.disablePluginFeatures()},1e3)}_checkRuntimeEnvironment(){try{return"undefined"!=typeof require&&"undefined"!=typeof module&&"undefined"!=typeof exports&&"app:"===window.location.protocol}catch(e){return!1}}_checkFileIntegrity(){try{return["initializePluginFeatures","onload","onunload","checkPluginActivation"].every(e=>"function"==typeof this[e])}catch(e){return!1}}async _performRuntimeValidation(){try{return[void 0!==_obf,"function"==typeof _0x4d2f,void 0!==_0xStr,void 0!==_0xSec,null!==this._securityKeys,null!==this._bindingIntegrity].every(Boolean)?!![_0xStr.verify(_obf.cp),_0xStr.verify(_obf.ia),_0xStr.verify(_obf.ocp)].every(Boolean)&&await this._checkPluginManagerBinding():!1}catch(e){return!1}}async autoResizeCanvasNodeHeight(e,t){try{if(!this.isSelectingRect&&(await new Promise(e=>setTimeout(e,500)),t.canvas&&t.canvas.nodes)){var a=t.canvas.nodes.get(e);if(a){var i=a.nodeEl||a.element;if(i){var r=i.querySelector(".canvas-node-text")||i.querySelector(".canvas-node-content-wrap")||i.querySelector(".view-content")||i.querySelector(".node-insert-event");if(r){r.style.height="auto",await new Promise(e=>setTimeout(e,100));var n=r.scrollHeight;if(0<n){var o=Math.max(n+30,80);a.height=o,i.style.height=o+"px",r!==i&&(r.style.height=o-30+"px"),r.querySelectorAll(".markdown-preview-view, .markdown-rendered, .canvas-node-content").forEach(e=>{e.style.height="auto"}),t.canvas.requestSave&&t.canvas.requestSave(),t.canvas.requestFrame&&t.canvas.requestFrame(),t.canvas.refreshNode&&t.canvas.refreshNode(e),t.canvas.update&&t.canvas.update();try{t.canvas.selection&&(t.canvas.selection.clear(),t.canvas.selection.add(e),await new Promise(e=>setTimeout(e,50)),t.canvas.selection.clear())}catch(e){}}}else{i.style.height="auto",await new Promise(e=>setTimeout(e,100));var s=i.scrollHeight;if(0<s){var l=Math.max(s+20,80);a.height=l,i.style.height=l+"px",t.canvas.requestSave&&t.canvas.requestSave(),t.canvas.refreshNode&&t.canvas.refreshNode(e),t.canvas.update&&t.canvas.update();try{t.canvas.selection&&(t.canvas.selection.clear(),t.canvas.selection.add(e),await new Promise(e=>setTimeout(e,50)),t.canvas.selection.clear())}catch(e){}}}}}}}catch(e){}}};class PdfFlowSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t,this.saveTimeout=null}debouncedSave(e=!1){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),e?this.plugin.saveSettings():this.saveTimeout=setTimeout(async()=>{await this.plugin.saveSettings(),this.saveTimeout=null},500)}cleanup(){this.saveTimeout&&(clearTimeout(this.saveTimeout),this.saveTimeout=null),this._diagnosticUpdateTimeout&&(clearTimeout(this._diagnosticUpdateTimeout),this._diagnosticUpdateTimeout=null)}hide(){this.cleanup(),super.hide?.()}display(){var e,t,a=this.containerEl;a.empty(),a.createEl("h2",{text:"PDF Flow ËÆæÁΩÆÔºàÂÖ∑‰ΩìÊïôÁ®ãËØ¶ËßÅ„Äå‰∏ìÂ±ûÊèí‰ª∂Â∏ÇÂú∫„ÄçÁöÑÊèí‰ª∂ËØ¥ÊòéÊñáÊ°£Ôºâ"}),new Setting(a).setName("ÂêØÁî®ÂØπË±°Â≠òÂÇ®").setDesc("ÈªòËÆ§‰øùÂ≠òÂú®Êú¨Âú∞‰ªìÂ∫ìÔºåÂºÄÂêØÂêéÂõæÁâáÂ∞Ü‰∏ä‰º†Âà∞ÂØπË±°Â≠òÂÇ®ÊúçÂä°ÔºåËøô‰ºöÂ¢ûÂä†ÁΩëÁªúÊµÅÈáèÊàñÂ≠òÂÇ®Ë¥πÁî®Ôºå‰ΩÜÂèØ‰ª•ÊúâÊïàÂáèÂ∞ë‰ªìÂ∫ìÁöÑ‰ΩìÁßØÔºàÂ¢ûÂä†ÊµÅÁïÖÂ∫¶ÔºâÔºå‰∏î‰ΩøÂæó‰∏çÂêåËÆæÂ§áÈó¥Êü•ÁúãÂõæÁâáÂèòÂæóÁÆÄÂçï").addToggle(e=>e.setValue(this.plugin.settings.enableObjectStorage).onChange(async e=>{this.plugin.settings.enableObjectStorage=e,this.debouncedSave(!0),this.display()})),this.plugin.settings.enableObjectStorage&&(new Setting(a).setName("ÂØπË±°Â≠òÂÇ®Êèê‰æõÂïÜ").setDesc("ÈÄâÊã©ÊÇ®‰ΩøÁî®ÁöÑÂØπË±°Â≠òÂÇ®ÊúçÂä°").addDropdown(e=>e.addOption("tencent","ËÖæËÆØ‰∫ë COS").addOption("aliyun","ÈòøÈáå‰∫ë OSS").setValue(this.plugin.settings.storageProvider).onChange(async e=>{this.plugin.settings.storageProvider=e,this.debouncedSave(!0),this.display()})),a.createEl("div",{cls:"setting-item-description"}).innerHTML=this.getProviderInstructions(),new Setting(a).setName("ÊúçÂä°Á´ØÁÇπ").setDesc(this.getEndpointDesc()).addText(e=>e.setPlaceholder(this.getEndpointPlaceholder()).setValue(this.getCurrentProviderSettings().endpoint).onChange(e=>{this.getCurrentProviderSettings().endpoint=e,this.debouncedSave(),clearTimeout(this._diagnosticUpdateTimeout),this._diagnosticUpdateTimeout=setTimeout(()=>{this.display()},800)})),"aliyun"===this.plugin.settings.storageProvider&&new Setting(a).setName("Âå∫Âüü").setDesc(this.getRegionDesc()).addText(e=>e.setPlaceholder(this.getRegionPlaceholder()).setValue(this.getCurrentProviderSettings().region||"").onChange(e=>{this.getCurrentProviderSettings().region=e,this.debouncedSave(),clearTimeout(this._diagnosticUpdateTimeout),this._diagnosticUpdateTimeout=setTimeout(()=>{this.display()},800)})),new Setting(a).setName("Â≠òÂÇ®Ê°∂").setDesc(this.getBucketDesc()).addText(e=>e.setPlaceholder(this.getBucketPlaceholder()).setValue(this.getCurrentProviderSettings().bucket).onChange(e=>{this.getCurrentProviderSettings().bucket=e,this.debouncedSave(),clearTimeout(this._diagnosticUpdateTimeout),this._diagnosticUpdateTimeout=setTimeout(()=>{this.display()},800)})),new Setting(a).setName("Access Key ID").setDesc(this.getAccessKeyDesc()).addText(e=>e.setPlaceholder(this.getAccessKeyPlaceholder()).setValue(this.getCurrentProviderSettings().accessKeyId).onChange(e=>{this.getCurrentProviderSettings().accessKeyId=e,this.debouncedSave()})),new Setting(a).setName("Secret Access Key").setDesc(this.getSecretKeyDesc()).addText(e=>e.setPlaceholder(this.getSecretKeyPlaceholder()).setValue(this.getCurrentProviderSettings().secretAccessKey).onChange(e=>{this.getCurrentProviderSettings().secretAccessKey=e,this.debouncedSave()})),e=a.createEl("div",{cls:"setting-item-description",text:"ÈÖçÁΩÆËØäÊñ≠Ôºö"}),t=this.getCurrentProviderSettings(),this.hasRequiredConfiguration(t)?(t=this.getExpectedStorageUrl(),e.createEl("br"),e.createEl("span",{text:"È¢ÑÊúüËÆøÈóÆÂú∞ÂùÄÔºö"+t,cls:"setting-item-description"}),(t=this.getProviderSpecificTip())&&(e.createEl("br"),e.createEl("br"),e.createEl("span",{text:t,cls:"setting-item-description"}).style.color="#4CAF50")):(e.createEl("br"),e.createEl("span",{text:"ËØ∑Â°´ÂÜôÂøÖË¶ÅÁöÑÈÖçÁΩÆ‰ø°ÊÅØ‰ª•Êü•ÁúãÈ¢ÑÊúüËÆøÈóÆÂú∞ÂùÄ",cls:"setting-item-description"})),new Setting(a).setName("ÂØπË±°Â≠òÂÇ®Ë∑ØÂæÑ").setDesc("ÂõæÁâáÂú®ÂØπË±°Â≠òÂÇ®‰∏≠ÁöÑ‰øùÂ≠òË∑ØÂæÑ").addText(e=>e.setPlaceholder("‰æãÂ¶Ç: screenshot/").setValue(this.plugin.settings.storagePath).onChange(e=>{this.plugin.settings.storagePath=e,this.debouncedSave()})),new Setting(a).setName("ÊµãËØïËøûÊé•").setDesc("ÊµãËØïÂØπË±°Â≠òÂÇ®ÈÖçÁΩÆÊòØÂê¶Ê≠£Á°Æ").addButton(e=>e.setButtonText("ÊµãËØïËøûÊé•").setCta().onClick(async()=>{e.setButtonText("ÊµãËØï‰∏≠..."),e.setDisabled(!0);try{await this.testObjectStorageConnection(),new Notice("ÂØπË±°Â≠òÂÇ®ËøûÊé•ÊµãËØïÊàêÂäüÔºÅ")}catch(e){"aliyun"===this.plugin.settings.storageProvider&&e.message.includes("403")?this.showAliyunOSSPermissionGuide(e.message):new Notice("ÂØπË±°Â≠òÂÇ®ËøûÊé•ÊµãËØïÂ§±Ë¥•: "+e.message)}finally{e.setButtonText("ÊµãËØïËøûÊé•"),e.setDisabled(!1)}})))}getEndpointDesc(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëCOSÊúçÂä°Á´ØÁÇπ";case"aliyun":return"ÈòøÈáå‰∫ëOSSÊúçÂä°Á´ØÁÇπ";default:return"ÊúçÂä°Á´ØÁÇπ"}}getEndpointPlaceholder(){switch(this.plugin.settings.storageProvider){case"tencent":return"‰æãÂ¶Ç: cos.ap-guangzhou.myqcloud.comÔºà‰∏çË¶ÅÂåÖÂê´Â≠òÂÇ®Ê°∂ÂêçÔºâ";case"aliyun":return"‰æãÂ¶Ç: oss-cn-guangzhou.aliyuncs.com";default:return""}}getRegionDesc(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëÂå∫ÂüüÊ†áËØÜ";case"aliyun":return"ÈòøÈáå‰∫ëÂå∫ÂüüÊ†áËØÜ";default:return"Âå∫Âüü"}}getRegionPlaceholder(){switch(this.plugin.settings.storageProvider){case"tencent":return"‰æãÂ¶Ç: ap-guangzhou";case"aliyun":return"‰æãÂ¶Ç: oss-cn-guangzhou";default:return""}}getExpectedStorageUrl(){var e=this.getCurrentProviderSettings(),t=this.plugin.settings.storagePath,{endpoint:a,bucket:i,region:r}=e;if(!i)return"ÈÖçÁΩÆ‰∏çÂÆåÊï¥";switch(this.plugin.settings.storageProvider){case"tencent":if(!a)return"ÈÖçÁΩÆ‰∏çÂÆåÊï¥";let e=a.trim();return`https://${i}.${e=(e=e.includes(i+".")?e.replace(i+".",""):e).startsWith("cos.")?e:e.startsWith("ap-")||e.startsWith("eu-")||e.startsWith("na-")?`cos.${e}.myqcloud.com`:`cos.${r||"ap-guangzhou"}.myqcloud.com`}/${t||""}example.png`;case"aliyun":return a?`https://${i}.${a}/${t||""}example.png`:"ÈÖçÁΩÆ‰∏çÂÆåÊï¥";default:return"ËØ∑ÈÄâÊã©Â≠òÂÇ®Êèê‰æõÂïÜ"}}getProviderSpecificTip(){switch(this.plugin.settings.storageProvider){case"tencent":return'üí° Â¶ÇÊûú‰∏ä‰º†Êó∂ÈÅáÂà∞"Â§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂"Áõ∏ÂÖ≥ÈîôËØØÔºåËøôÊòØÊ≠£Â∏∏ÁöÑ„ÄÇ‰ª£Á†ÅÂ∑≤Ëá™Âä®ÈÄÇÈÖçÂ§öÂèØÁî®Âå∫Â≠òÂÇ®Ê°∂„ÄÇ';case"aliyun":return'üí° Á°Æ‰øùÂ≠òÂÇ®Á©∫Èó¥ÁöÑËØªÂÜôÊùÉÈôêËÆæÁΩÆÊ≠£Á°Æ„ÄÇÂª∫ËÆÆËÆæÁΩÆ‰∏∫"ÂÖ¨ÂÖ±ËØªÔºåÁßÅÊúâÂÜô"‰ª•‰æøÂõæÁâáËÉΩÊ≠£Â∏∏ËÆøÈóÆ„ÄÇ';default:return null}}getCurrentProviderSettings(){var e=this.plugin.settings.storageProvider;return this.plugin.settings[e]||(this.plugin.settings[e]={endpoint:"",region:"",bucket:"",accessKeyId:"",secretAccessKey:""}),this.plugin.settings[e]}hasRequiredConfiguration(e){switch(this.plugin.settings.storageProvider){case"tencent":case"aliyun":return e.endpoint&&e.bucket;default:return!1}}getBucketDesc(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëCOSÂ≠òÂÇ®Ê°∂ÂêçÁß∞ÔºàÂåÖÂê´APPIDÔºâ";case"aliyun":return"ÈòøÈáå‰∫ëOSSÂ≠òÂÇ®Á©∫Èó¥ÂêçÁß∞";default:return"Â≠òÂÇ®Ê°∂/Á©∫Èó¥ÂêçÁß∞"}}getBucketPlaceholder(){switch(this.plugin.settings.storageProvider){case"tencent":return"‰æãÂ¶Ç: ten-13*******5";case"aliyun":return"‰æãÂ¶Ç: my-oss-bucket";default:return""}}getAccessKeyDesc(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëAPIÂØÜÈí•‰∏≠ÁöÑSecretId";case"aliyun":return"ÈòøÈáå‰∫ëAccessKey ID";default:return"ËÆøÈóÆÂØÜÈí•ID"}}getAccessKeyPlaceholder(){switch(this.plugin.settings.storageProvider){case"tencent":return"‰æãÂ¶Ç: AKI*******tAG8mFVX*****IrCLH0VmqhKkx";case"aliyun":return"‰æãÂ¶Ç: LTA****zBCqM5t****FQ8Xxx";default:return""}}getSecretKeyDesc(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëAPIÂØÜÈí•‰∏≠ÁöÑSecretKey";case"aliyun":return"ÈòøÈáå‰∫ëAccessKey Secret";default:return"ÁßòÂØÜËÆøÈóÆÂØÜÈí•"}}getSecretKeyPlaceholder(){switch(this.plugin.settings.storageProvider){case"tencent":return"‰æãÂ¶Ç: 67****TP6btx****F3e2D***WeaJo68";case"aliyun":return"‰æãÂ¶Ç: abc****234567890****ef1234567890";default:return""}}getProviderInstructions(){switch(this.plugin.settings.storageProvider){case"tencent":return`
                    <strong>ËÖæËÆØ‰∫ëCOSÈÖçÁΩÆËØ¥ÊòéÔºö</strong><br>
                    1. ÁôªÂΩï <a href="https://console.cloud.tencent.com/cos" target="_blank">ËÖæËÆØ‰∫ëCOSÊéßÂà∂Âè∞</a><br>
                    2. ÂàõÂª∫Â≠òÂÇ®Ê°∂ÊàñÊü•ÁúãÁé∞ÊúâÂ≠òÂÇ®Ê°∂<br>
                    3. Â≠òÂÇ®Ê°∂ÂêçÊ†ºÂºèÔºöÈÄöÂ∏∏ÊòØ "ÂêçÁß∞-APPID"ÔºåÂ¶Ç "ten-13*******5"<br>
                    4. Âú® <a href="https://console.cloud.tencent.com/cam/capi" target="_blank">APIÂØÜÈí•ÁÆ°ÁêÜ</a> Ëé∑ÂèñÂØÜÈí•<br>
                    5. Á°Æ‰øùÂ≠òÂÇ®Ê°∂ËÆæÁΩÆ‰∏∫ÂÖ¨ÊúâËØªÁßÅÊúâÂÜôÔºåÊàñÈÖçÁΩÆÁõ∏Â∫îÁöÑËÆøÈóÆÁ≠ñÁï•<br>
                    6. Á°Æ‰øùÂ∑≤ÂºÄÂêØCORSË∑®ÂüüËÆøÈóÆÔºå‰∏îËÆæÁΩÆ‰∏≠ÔºåOriginÂåÖÂê´‰∏ÄË°åÈÄöÈÖçÁ¨¶Ôºà*ÔºâÔºåHeadersÂåÖÂê´ETag„ÄÅContent-Length„ÄÅx-cos-request-id
                `;case"aliyun":return`
                    <strong>ÈòøÈáå‰∫ëOSSÈÖçÁΩÆËØ¥ÊòéÔºö</strong><br>
                    1. ÁôªÂΩï <a href="https://oss.console.aliyun.com/" target="_blank">ÈòøÈáå‰∫ëOSSÊéßÂà∂Âè∞</a><br>
                    2. ÂàõÂª∫Â≠òÂÇ®Á©∫Èó¥(Bucket)ÊàñÈÄâÊã©Áé∞ÊúâÂ≠òÂÇ®Á©∫Èó¥<br>
                    3. ËÆ∞ÂΩïÂ≠òÂÇ®Á©∫Èó¥ÂêçÁß∞ÂíåÊâÄÂú®Âú∞Âüü<br>
                    4. Âú® <a href="https://usercenter.console.aliyun.com/#/manage/ak" target="_blank">AccessKeyÁÆ°ÁêÜ</a> ÂàõÂª∫ÊàñÊü•ÁúãÂØÜÈí•<br>
                    5. ËÆæÁΩÆÂ≠òÂÇ®Á©∫Èó¥ËØªÂÜôÊùÉÈôêÔºàÂª∫ËÆÆÔºöÂÖ¨ÂÖ±ËØªÔºâ<br>
                    6. Á°Æ‰øùÂ∑≤ÂºÄÂêØOSSË∑®ÂüüËÆøÈóÆÔºå‰∏îËÆæÁΩÆ‰∏≠ÔºåOriginÂåÖÂê´‰∏ÄË°åÈÄöÈÖçÁ¨¶Ôºà*ÔºâÔºåHeadersÂåÖÂê´ETag„ÄÅContent-Length„ÄÅx-cos-request-id<br>
                    7. ÊúçÂä°Á´ØÁÇπÊ†ºÂºèÔºöoss-Âú∞Âüü.aliyuncs.comÔºåÂ¶Ç oss-cn-guangzhou.aliyuncs.com
                `;default:return"<strong>ËØ∑ÈÄâÊã©ÂØπË±°Â≠òÂÇ®Êèê‰æõÂïÜ‰ª•Êü•ÁúãÈÖçÁΩÆËØ¥Êòé</strong>"}}async testObjectStorageConnection(){if(this.plugin.checkPluginActivation(),!this.plugin.settings.enableObjectStorage)throw new Error("ÂØπË±°Â≠òÂÇ®Êú™ÂêØÁî®");var t=this.getCurrentProviderSettings(),e=this.plugin.settings.storageProvider,{endpoint:a,bucket:t}=t;if(!t)throw new Error("Â≠òÂÇ®Ê°∂/Á©∫Èó¥ÂêçÁß∞Êú™ÈÖçÁΩÆ");switch(e){case"tencent":if(a)break;throw new Error("ËÖæËÆØ‰∫ëCOSÊúçÂä°Á´ØÁÇπÊú™ÈÖçÁΩÆ");case"aliyun":if(a)break;throw new Error("ÈòøÈáå‰∫ëOSSÊúçÂä°Á´ØÁÇπÊú™ÈÖçÁΩÆ");default:throw new Error("‰∏çÊîØÊåÅÁöÑÂ≠òÂÇ®Êèê‰æõÂïÜ")}await this.performNetworkTest();try{var i=`test_${Date.now()}.png`,r=await this.plugin.uploadToObjectStorage("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==",i);if(r)return r;throw new Error("‰∏ä‰º†ÊµãËØïÊñá‰ª∂Â§±Ë¥•ÔºöËøîÂõûÁ©∫ÁªìÊûú")}catch(e){t=this.getProviderSpecificErrorMessage(e.message);throw new Error(t)}}getProviderName(){switch(this.plugin.settings.storageProvider){case"tencent":return"ËÖæËÆØ‰∫ëCOS";case"aliyun":return"ÈòøÈáå‰∫ëOSS";default:return"ÂØπË±°Â≠òÂÇ®"}}async performNetworkTest(){var e=this.getCurrentProviderSettings(),t=this.plugin.settings.storageProvider,{}=e;switch(t){case"tencent":await this.testTencentCOSConnection(e);break;case"aliyun":await this.testAliyunOSSConnection(e)}}async testTencentCOSConnection(e){var{endpoint:e,bucket:t,region:a}=e;let i=e.trim();e=`https://${t}.${i=(i=i.includes(t+".")?i.replace(t+".",""):i).startsWith("cos.")?i:i.startsWith("ap-")||i.startsWith("eu-")||i.startsWith("na-")?`cos.${i}.myqcloud.com`:`cos.${a||"ap-guangzhou"}.myqcloud.com`}/`;try{await fetch(e,{method:"HEAD",mode:"no-cors"})}catch(e){}}async testAliyunOSSConnection(e){var{endpoint:e,bucket:t,accessKeyId:a,secretAccessKey:i}=e,t=`https://${t}.${e}/`;try{var r=await fetch(t,{method:"GET",mode:"cors"});if(403!==r.status&&404===r.status)throw new Error("Â≠òÂÇ®Ê°∂‰∏çÂ≠òÂú®ÊàñÁ´ØÁÇπÈÖçÁΩÆÈîôËØØ")}catch(e){if(e.message.includes("Failed to fetch"))throw new Error("Êó†Ê≥ïËøûÊé•Âà∞ÈòøÈáå‰∫ëOSSÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•ÂíåÁ´ØÁÇπÈÖçÁΩÆ");if(e.message.includes("404")||e.message.includes("‰∏çÂ≠òÂú®"))throw new Error("Â≠òÂÇ®Ê°∂‰∏çÂ≠òÂú®ÊàñÁ´ØÁÇπÈÖçÁΩÆÈîôËØØÔºåËØ∑Ê£ÄÊü•bucketÂêçÁß∞Âíåendpoint")}if(!a||!i)throw new Error("AccessKeyÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïËøõË°åÊùÉÈôêÊµãËØï")}getProviderSpecificErrorMessage(e){this.getProviderName();let t=e;if(t.includes("Failed to fetch")||t.includes("ERR_CONNECTION_CLOSED"))switch(this.plugin.settings.storageProvider){case"tencent":t+=`

ÂèØËÉΩÁöÑËß£ÂÜ≥ÊñπÊ°àÔºö
1. Ê£ÄÊü•ÁΩëÁªúËøûÊé•
2. Á°ÆËÆ§ËÖæËÆØ‰∫ëCOSÈÖçÁΩÆÊ≠£Á°Æ
3. Ê£ÄÊü•Èò≤ÁÅ´Â¢ôÊàñ‰ª£ÁêÜËÆæÁΩÆ
4. Á°ÆËÆ§Â≠òÂÇ®Ê°∂ÂÖ∑ÊúâÊ≠£Á°ÆÁöÑËÆøÈóÆÊùÉÈôê
5. È™åËØÅAPIÂØÜÈí•ÊòØÂê¶ÊúâÊïà`;break;case"aliyun":t+=`

ÂèØËÉΩÁöÑËß£ÂÜ≥ÊñπÊ°àÔºö
1. Ê£ÄÊü•ÁΩëÁªúËøûÊé•
2. Á°ÆËÆ§ÈòøÈáå‰∫ëOSSÈÖçÁΩÆÊ≠£Á°Æ
3. Ê£ÄÊü•AccessKeyÊùÉÈôê
4. Á°ÆËÆ§Â≠òÂÇ®Á©∫Èó¥ËÆøÈóÆÊùÉÈôêËÆæÁΩÆ
5. È™åËØÅÊúçÂä°Á´ØÁÇπÊ†ºÂºèÊòØÂê¶Ê≠£Á°Æ`}return t}}