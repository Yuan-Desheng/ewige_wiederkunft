let{Plugin,PluginSettingTab,Setting,Notice,TFolder,TFile,normalizePath,setIcon}=require("obsidian"),fs=require("fs"),path=require("path"),DEFAULT_SETTINGS={targetFolder:"Documents/I.P.A.R.A/导入文档",attachmentFolder:"Extras/导入",insertHeaderBlock:!0};class NoteImporterPlugin extends Plugin{constructor(t,e){super(t,e),this.isPluginActivated=!1,this.statusCheckInterval=null}async onload(){await this.loadSettings(),await this.checkContentProtectionStatus()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.showActivationRequired())}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}async initializePluginFeatures(){this.statusCheckInterval||(this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},3e5),this.addRibbonIcon("import","导入笔记",()=>{this.isPluginActivated?this.showImportModal():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}),this.addCommand({id:"import-note-from-vault",name:"从其他 Vault 导入笔记",callback:()=>{this.isPluginActivated?this.showImportModal():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addSettingTab(new NoteImporterSettingTab(this.app,this)))}showImportModal(){new VaultSelectorModal(this.app,this).open()}async checkContentProtectionStatus(){try{var t=this.app.plugins.plugins["obsidian-content-protection"];if(t){if(!this.app.plugins.enabledPlugins.has("obsidian-content-protection"))return!1;if(t.settings)return!0===t.settings.isActivated&&t.settings.deviceId&&0<t.settings.deviceId.trim().length&&!0===t.settings.hasBeenActivated}return await this.checkContentProtectionFile()}catch(t){return!1}}async checkContentProtectionFile(){try{var t,e;return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?(t=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/data.json"),!0===(e=JSON.parse(t)).isActivated&&e.deviceId&&0<e.deviceId.trim().length&&!0===e.hasBeenActivated):!1}catch(t){return!1}}async checkAndUpdateStatus(){var t=await this.checkContentProtectionStatus();!t&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):t&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())}disablePluginFeatures(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null)}showActivationRequired(){this.app.plugins.enabledPlugins.has("obsidian-content-protection")}async importNote(e,a){try{var s=path.join(e,a);if(fs.existsSync(s)){var i,n,r=fs.readFileSync(s,"utf-8"),l=path.basename(a,".md"),o=this.insertHeaderBlock(r,l),c=this.settings.targetFolder,h=path.dirname(a),p=h&&"."!==h?normalizePath(path.join(c,h)):normalizePath(c),d=(await this.ensureFolderExists(p),path.basename(a));let t=normalizePath(path.join(p,d));await this.app.vault.adapter.exists(t)&&(i=(new Date).getTime(),n=d.replace(/\.md$/,""),t=normalizePath(path.join(p,n+`_${i}.md`)));var{updatedContent:g,attachments:u}=await this.extractAndProcessAttachments(o,e,path.dirname(a));return await this.app.vault.create(t,g),{success:!0,attachments:u.length}}new Notice("源笔记文件不存在")}catch(t){return console.error("导入笔记失败:",t),new Notice("导入笔记失败: "+t.message),{success:!1,attachments:0}}}async extractAndProcessAttachments(t,e,a){var s=[];let i=t;var n,r,l,o=new Set;for(n of[/!\[\[([^\]]+?\.(?:png|jpg|jpeg|gif|bmp|svg|webp|pdf|mp4|mp3|wav|ogg|webm|mov|base|canvas|avif|flac|m4a|3gp|mkv|ogv|doc|docx|xls|xlsx|zip|rar|7z|txt|ppt|pptx))(?:\|[^\]]+)?\]\]/gi,/\[\[([^\]]+?\.(?:png|jpg|jpeg|gif|bmp|svg|webp|pdf|mp4|mp3|wav|ogg|webm|mov|base|canvas|avif|flac|m4a|3gp|mkv|ogv|doc|docx|xls|xlsx|zip|rar|7z|txt|ppt|pptx))(?:\|[^\]]+)?\]\]/gi,/!\[[^\]]*\]\(([^)]+?\.(?:png|jpg|jpeg|gif|bmp|svg|webp|pdf|mp4|mp3|wav|ogg|webm|mov|base|canvas|avif|flac|m4a|3gp|mkv|ogv|doc|docx|xls|xlsx|zip|rar|7z|txt|ppt|pptx))\)/gi,/\[[^\]]*\]\(([^)]+?\.(?:png|jpg|jpeg|gif|bmp|svg|webp|pdf|mp4|mp3|wav|ogg|webm|mov|base|canvas|avif|flac|m4a|3gp|mkv|ogv|doc|docx|xls|xlsx|zip|rar|7z|txt|ppt|pptx))\)/gi])for(;null!==(r=n.exec(t));){let t=r[1];t=t.split("|")[0].trim(),o.add(t)}for(l of o)try{var c,h,p=await this.copyAttachment(l,e,a);p&&(s.push(p.fileName),c=l,h=normalizePath(path.join(this.settings.attachmentFolder,p.fileName)),i=i.replace(new RegExp(this.escapeRegExp(c),"g"),h))}catch(t){console.error(`处理附件失败 ${l}:`,t)}return{updatedContent:i,attachments:s}}async copyAttachment(t,e,a){var s;let i=null;for(s of[path.join(e,t),path.join(e,a,t),t])if(fs.existsSync(s)){i=s;break}if(!i){a=path.basename(t);if(!(i=a===t?await this.searchAttachmentByFileName(e,a):i))return console.warn("找不到附件: "+t),null}await this.ensureFolderExists(this.settings.attachmentFolder);e=path.basename(t);let n=normalizePath(path.join(this.settings.attachmentFolder,e));await this.app.vault.adapter.exists(n)&&(a=path.extname(e),t=e.replace(a,"")+"_"+(new Date).getTime()+a,n=normalizePath(path.join(this.settings.attachmentFolder,t)));e=fs.readFileSync(i);return await this.app.vault.adapter.writeBinary(n,e),{fileName:path.basename(n)}}insertHeaderBlock(t,a){a=(a?`## ${a}
`:"")+'```meta-bind-embed\n[[笔记抬头模块]]\n```\n<progress value="10" max="100" style="width: 100%;"></progress>\n\n';if(!this.settings||!1===this.settings.insertHeaderBlock)return t;if(!t||""===t.trim())return a;var s,i=t.split(/\r?\n/);if("---"===i[0].trim()){let e=-1;for(let t=1;t<i.length;t++)if("---"===i[t].trim()){e=t;break}if(-1!==e)return i.slice(0,e+1).join("\n")+`

`+a+((s=i.slice(e+1).join("\n"))?"\n"+s:"")}return a+t}async searchAttachmentByFileName(t,e){var a=[{dir:t,depth:0}];let s=0;for(;0<a.length;){var i=a.pop();if(i&&!(6<i.depth)){let t;try{t=fs.readdirSync(i.dir,{withFileTypes:!0})}catch(t){continue}for(var n of t){if(8e3<s)return null;if(s++,!n.name.startsWith(".")){var r=path.join(i.dir,n.name);if(n.isDirectory())a.push({dir:r,depth:i.depth+1});else if(n.isFile()&&n.name===e)return r}}}}return null}async ensureFolderExists(t){t=normalizePath(t);await this.app.vault.adapter.exists(t)||await this.app.vault.createFolder(t)}escapeRegExp(t){return t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}onunload(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null)}}class VaultSelectorModal extends require("obsidian").Modal{constructor(t,e){super(t),this.plugin=e}onOpen(){var t=this.contentEl,e=(t.empty(),t.addClass("note-importer-modal"),t.createEl("h3",{text:'导入仓库笔记（含附件）：请选择"源仓库"'}),t.createDiv({cls:"vault-path-container"}));let a=e.createEl("input",{type:"text",placeholder:"请输入或选择源仓库（Vault）路径",cls:"vault-path-input"});e.createEl("button",{text:"浏览...",cls:"vault-browse-btn"}).addEventListener("click",async()=>{var t=(require("electron").remote||require("@electron/remote")).dialog,t=await t.showOpenDialog({properties:["openDirectory"],title:"选择 Vault 文件夹"});!t.canceled&&0<t.filePaths.length&&(a.value=t.filePaths[0])});e=t.createDiv({cls:"modal-button-container"});e.createEl("button",{text:"下一步",cls:"mod-cta"}).addEventListener("click",()=>{var t=a.value.trim();t?fs.existsSync(t)?(this.close(),new NoteSelectorModal(this.app,this.plugin,t).open()):new Notice("Vault 路径不存在"):new Notice("请输入 Vault 路径")}),e.createEl("button",{text:"取消"}).addEventListener("click",()=>{this.close()})}onClose(){var t=this.contentEl;t.empty()}}class NoteSelectorModal extends require("obsidian").Modal{constructor(t,e,a){super(t),this.plugin=e,this.vaultPath=a,this.selectedFolders=new Set,this.expandedFolders=new Set}onOpen(){var t=this.contentEl;t.empty(),t.addClass("note-importer-modal"),t.createEl("h2",{text:"选择要导入的笔记"}),t.createEl("p",{text:"源 Vault: "+this.vaultPath,cls:"vault-path-display"});let e=t.createDiv({cls:"note-list-container"}),a=this.getAllFolders(this.vaultPath);var s=a.filter(t=>0===(t?t.split(path.sep).length:0)),s=(this.expandedFolders=new Set(s),0===a.length?e.createEl("p",{text:"未找到任何文件夹",cls:"no-notes-message"}):this.renderFolderList(e,a),t.createDiv({cls:"modal-button-container"}));s.createEl("button",{text:"全选"}).addEventListener("click",()=>{this.selectedFolders=new Set(a),e.empty(),this.renderFolderList(e,a)}),s.createEl("button",{text:"导入",cls:"mod-cta"}).addEventListener("click",async()=>{if(0!==this.selectedFolders.size){this.close();let t=0,e=0,a=new Set;for(var s of this.selectedFolders)this.getAllNotes(this.vaultPath,s).forEach(t=>a.add(t));for(var i of a){i=await this.plugin.importNote(this.vaultPath,i);i&&i.success&&(t++,e+=i.attachments||0)}new Notice(`导入完成！成功导入 ${t} 个笔记，导入 ${e} 个附件`)}}),s.createEl("button",{text:"取消"}).addEventListener("click",()=>{this.close()})}renderFolderList(r,l){let o=(e,a)=>{l.forEach(t=>{t!==e&&!t.startsWith(e+path.sep)||(a?this.selectedFolders.add(t):this.selectedFolders.delete(t))})},c=t=>{let e=t||"";l.filter(t=>{t=path.dirname(t);return"."===t&&""===e||t===e}).sort().forEach(e=>{var t=e?e.split(path.sep).length:0;let a=l.some(t=>path.dirname(t)===e);var s=r.createDiv({cls:"note-item folder-item"}),t=(s.style.setProperty("--depth",t),1===t&&s.addClass("root-folder"),0<t&&(s.style.paddingLeft=24*t+"px"),s.createSpan({cls:"folder-toggle"}));a&&setIcon(t,this.expandedFolders.has(e)?"chevron-down":"chevron-right");let i=s.createEl("input",{type:"checkbox",cls:"note-checkbox"});i.checked=this.selectedFolders.has(e),i.addEventListener("change",t=>{t=t.target.checked;o(e,t),r.empty(),c("")});s=s.createEl("label",{text:e||"/",cls:"note-label"});let n=()=>{a&&(this.expandedFolders.has(e)?this.expandedFolders.delete(e):this.expandedFolders.add(e),r.empty(),c(""))};t.addEventListener("click",t=>{t.stopPropagation(),n()}),s.addEventListener("click",()=>{i.checked=!i.checked,i.dispatchEvent(new Event("change"))}),a&&this.expandedFolders.has(e)&&c(e)})};c("")}getAllNotes(t,e=""){var a,s,i,n,r=[],l=path.join(t,e);try{for(a of fs.readdirSync(l))a.startsWith(".")||(s=path.join(l,a),i=e?path.join(e,a):a,(n=fs.statSync(s)).isDirectory()?r.push(...this.getAllNotes(t,i)):n.isFile()&&a.endsWith(".md")&&r.push(i))}catch(t){console.error("读取目录失败:",t)}return r}getAllFolders(t,e=""){var a,s,i,n=[],r=path.join(t,e);try{for(a of fs.readdirSync(r))a.startsWith(".")||(s=path.join(r,a),fs.statSync(s).isDirectory()&&(i=e?path.join(e,a):a,n.push(i),n.push(...this.getAllFolders(t,i))))}catch(t){console.error("读取目录失败:",t)}return n}onClose(){var t=this.contentEl;t.empty()}}class NoteImporterSettingTab extends PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){var t=this.containerEl;t.empty(),t.createEl("h2",{text:"Note Importer 设置"}),new Setting(t).setName("目标笔记文件夹").setDesc("导入的笔记将保存到此文件夹").addText(t=>t.setPlaceholder("Documents/I.P.A.R.A/导入文档").setValue(this.plugin.settings.targetFolder).onChange(async t=>{this.plugin.settings.targetFolder=t,await this.plugin.saveSettings()})),new Setting(t).setName("附件文件夹").setDesc("导入的附件将保存到此文件夹").addText(t=>t.setPlaceholder("Extras/导入").setValue(this.plugin.settings.attachmentFolder).onChange(async t=>{this.plugin.settings.attachmentFolder=t,await this.plugin.saveSettings()})),new Setting(t).setName("笔记开头插入卡片盒模块").setDesc("开启后，在导入的笔记开头自动插入预设的卡片盒笔记模块（含标题、笔记抬头模块、进度条）").addToggle(t=>t.setValue(this.plugin.settings.insertHeaderBlock).onChange(async t=>{this.plugin.settings.insertHeaderBlock=t,await this.plugin.saveSettings()})),new Setting(t).setName("支持的附件格式").setDesc("当前会自动识别并导入以下附件后缀：png, jpg, jpeg, gif, bmp, svg, webp, pdf, mp4, mp3, wav, ogg, webm, mov, base, canvas, avif, flac, m4a, 3gp, mkv, ogv, doc, docx, xls, xlsx, zip, rar, 7z, txt, ppt, pptx")}}module.exports=NoteImporterPlugin;