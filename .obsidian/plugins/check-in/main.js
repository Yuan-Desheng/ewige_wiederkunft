let{Plugin,Modal,Notice,PluginSettingTab,Setting}=require("obsidian"),crypto=null;try{crypto=require("crypto")}catch(e){crypto=null}function compareVersions(e,t){if(!e||!t)return 0;try{for(var n=e.split(".").map(e=>parseInt(e,10)||0),a=t.split(".").map(e=>parseInt(e,10)||0);n.length<3;)n.push(0);for(;a.length<3;)a.push(0);for(let e=0;e<3;e++){if(n[e]<a[e])return-1;if(n[e]>a[e])return 1}return 0}catch(e){return 0}}function generateSecureHash(e,t=null){e=(t=t||`cp_salt_${Math.floor(Date.now()/864e5)}_security`)+e+t;if(crypto&&crypto.createHash)try{var n=crypto.createHash("sha256");return n.update(e),n.digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(e=>Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")).catch(()=>null)}catch(e){}return generateSimpleHash(e)}function generateSimpleHash(t){let n=0;if(0===t.length)return n.toString(16);for(let e=0;e<t.length;e++){var a=t.charCodeAt(e);n=(n<<5)-n+a,n&=n}return(Math.abs(n).toString(16)+t.length.toString(16)+Date.now().toString(16).slice(-8)).padStart(64,"0").slice(0,64)}async function generatePluginFingerprint(e,t){try{var n={id:e.id||"obsidian-content-protection",version:e.version,author:e.author,name:e.name,path:t.replace(/\\/g,"/"),minAppVersion:e.minAppVersion},a=generateSecureHash(JSON.stringify(n,Object.keys(n).sort()));return a&&"function"==typeof a.then?await a:a}catch(e){return null}}async function validatePluginIntegrity(e,t){try{var n,a,i,s,r;return await generatePluginFingerprint(e,t)?(n="obsidian-content-protection",a="ytmaps",e.id===n&&e.author===a&&0<=compareVersions(e.version,"1.3.0")&&(i=generateSecureHash(JSON.stringify({id:n,author:a})),s=generateSecureHash(JSON.stringify({id:e.id,author:e.author})),r=i&&"function"==typeof i.then?await i:i,(s&&"function"==typeof s.then?await s:s)===r)):!1}catch(e){return!1}}let DEFAULT_CHECK_IN_ITEMS=[{label:"ËøêÂä®Êó∂Èïø",icon:"üèÉ",type:"number",unit:"ÂàÜÈíü",enabled:!0},{label:"‰ΩìÈáç",icon:"‚öñ",type:"number",unit:"kg",enabled:!0},{label:"‰ªäÊó•ÂñùÊ∞¥Èáè",icon:"üíß",type:"number",unit:"ml",enabled:!0},{label:"ËØª‰π¶Êó∂Èïø",icon:"üìö",type:"number",unit:"ÂàÜÈíü",enabled:!0}],DEFAULT_SETTINGS={checkInItems:DEFAULT_CHECK_IN_ITEMS,weeklyDisplayMode:"dots",itemsPerPage:4};class CheckInPlugin extends Plugin{constructor(e,t){super(e,t),this.isPluginActivated=!1,this.statusCheckInterval=null,this.activationNoticeEl=null,this.featuresInitialized=!1,this.currentItemsPage=1}async onload(){await this.loadSettings(),await this.validateDependencyPlugin()?await this.checkContentProtectionStatus()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.showActivationRequired()):this.isPluginActivated=!1}onunload(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.activationNoticeEl&&this.activationNoticeEl.parentElement&&(this.activationNoticeEl.parentElement.removeChild(this.activationNoticeEl),this.activationNoticeEl=null),this.calendarObserver&&this.calendarObserver.disconnect()}async initializePluginFeatures(){this.featuresInitialized?this.statusCheckInterval||(this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},3e5)):(this.featuresInitialized=!0,this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},3e5),this.addSettingTab(new CheckInSettingTab(this.app,this)),this.addCommand({id:"open-check-in-for-today",name:"ÊâìÂºÄ‰ªäÊó•ÊâìÂç°",callback:()=>{this.isPluginActivated?this.openCheckInForDate(window.moment()):this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addCommand({id:"open-check-in-settings",name:"ÊâìÂºÄÊâìÂç°ËÆæÁΩÆ",callback:()=>{this.isPluginActivated?new CheckInItemsModal(this.app,this).open():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.registerDomEvent(document,"click",t=>{t=t.target;if(t.closest(".day.svelte-q3wqg9")){let e=t.closest(".day.svelte-q3wqg9");setTimeout(()=>{this.updateCheckInPanelFromDayElement(e)},150)}}),this.registerEvent(this.app.workspace.on("file-open",e=>{e&&this.handleFileOpen(e)})),this.registerEvent(this.app.workspace.on("layout-change",()=>{setTimeout(()=>{this.reinitializeCalendarObserver()},100)})),this.app.workspace.onLayoutReady(()=>{this.initializeCalendarObserver()}))}async validateDependencyPlugin(){try{var e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/manifest.json"),t=JSON.parse(e),n=t.version;if(!n)return!1;if(compareVersions(n,"1.3.0")<0)return!1;if("ytmaps"!==t.author)return!1;try{if(!await validatePluginIntegrity(t,".obsidian/plugins/obsidian-content-protection"))return!1;var a=generateSecureHash(`${t.id}:${t.author}:`+t.version);if(!(a&&"function"==typeof a.then?await a:a))return!1}catch(e){}return!0}catch(e){return!1}}async checkContentProtectionStatus(){try{var e=this.app.plugins.plugins["obsidian-content-protection"];if(e){if(!this.app.plugins.enabledPlugins.has("obsidian-content-protection"))return!1;if(e.settings)return!0===e.settings.isActivated&&e.settings.deviceId&&0<e.settings.deviceId.trim().length&&!0===e.settings.hasBeenActivated}return await this.checkContentProtectionFile()}catch(e){return!1}}async checkContentProtectionFile(){try{var e,t;return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?(e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/data.json"),!0===(t=JSON.parse(e)).isActivated&&t.deviceId&&0<t.deviceId.trim().length&&!0===t.hasBeenActivated):!1}catch(e){return!1}}async checkAndUpdateStatus(){var e=await this.checkContentProtectionStatus();!e&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):e&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())}disablePluginFeatures(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.activationNoticeEl&&this.activationNoticeEl.parentElement&&(this.activationNoticeEl.parentElement.removeChild(this.activationNoticeEl),this.activationNoticeEl=null)}async loadSettings(){var e=await this.loadData();this.settings=Object.assign({},DEFAULT_SETTINGS,e),this.settings.checkInItems&&0!==this.settings.checkInItems.length?this.settings.checkInItems=this.settings.checkInItems.map(n=>{if(n.id){let{id:e,...t}=n;return t}return n}):this.settings.checkInItems=DEFAULT_CHECK_IN_ITEMS}async saveSettings(){await this.saveData(this.settings)}initializeCalendarObserver(){var e=document.querySelector("#calendar-container.container.svelte-pcimu8");e&&(this.calendarObserver=new MutationObserver(e=>{for(var t of e)"childList"===t.type&&this.updateCheckInPanelIfNeeded()}),this.calendarObserver.observe(e,{childList:!0,subtree:!0}),this.updateCheckInPanelIfNeeded())}reinitializeCalendarObserver(){this.calendarObserver&&(this.calendarObserver.disconnect(),this.calendarObserver=null),this.initializeCalendarObserver()}updateCheckInPanelIfNeeded(){var e,t=document.querySelector("#calendar-container.container.svelte-pcimu8");t&&!t.querySelector(".check-in-panel")&&(e=this.createCheckInPanel(),t.appendChild(e),setTimeout(()=>{this.updateCheckInItems(window.moment())},100))}createCheckInPanel(){var e=document.createElement("div"),t=(e.className="check-in-panel",document.createElement("div")),n=(t.className="check-in-header",document.createElement("div")),a=document.createElement("div"),i=(a.className="check-in-title",a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-icon lucide-calendar-check"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>  ÊâìÂç°ËÆ∞ÂΩï',document.createElement("div"));i.className="check-in-date",i.id="check-in-current-date",i.textContent="ËØ∑ÈÄâÊã©Êó•Êúü",i.style.fontSize="11px",i.style.color="var(--text-muted)",i.style.marginTop="2px",n.appendChild(a),n.appendChild(i);let s=document.createElement("button"),r=(s.className="check-in-mode-toggle-btn",s.title="ÂàáÊç¢ÊúÄËøë‰∏ÄÂë®ÊòæÁ§∫Ê®°Âºè",e=>{switch(e){case"dots":return"‚óè‚óã";case"bars":return"‚ñå‚ñå";case"numbers":return"‚úì‚úó";case"icons":return"‚úÖ‚¨ú";default:return"‚óè‚óã"}});s.textContent=r(this.settings.weeklyDisplayMode||"dots"),s.addEventListener("click",async()=>{var e=["dots","bars","numbers","icons"],t=this.settings.weeklyDisplayMode||"dots",t=e.indexOf(t),t=e[(t+1)%e.length],e=(this.settings.weeklyDisplayMode=t,await this.saveSettings(),s.textContent=r(t),document.getElementById("check-in-current-date"));e&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(t=e.textContent.split(" ")[0],(e=window.moment(t)).isValid())&&await this.updateCheckInItems(e)});var a=document.createElement("div"),i=(a.className="check-in-pagination",a.id="check-in-pagination",document.createElement("button")),l=(i.className="check-in-settings-btn",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-icon lucide-list"><path d="M3 5h.01"/><path d="M3 12h.01"/><path d="M3 19h.01"/><path d="M8 5h13"/><path d="M8 12h13"/><path d="M8 19h13"/></svg>',i.addEventListener("click",()=>{new CheckInItemsModal(this.app,this).open()}),document.createElement("div")),a=(l.className="check-in-header-right",l.appendChild(s),l.appendChild(a),l.appendChild(i),t.appendChild(n),t.appendChild(l),e.appendChild(t),document.createElement("div"));return a.className="check-in-items",a.id="check-in-items-container",e.appendChild(a),e}async updateCheckInPanelFromDayElement(t){var n=t.getAttribute("data-date");if(n)n=window.moment(n),await this.updateCheckInItems(n);else{n=t.textContent.trim().split("\n")[0];if(n){var a=document.querySelector("#calendar-container.container.svelte-pcimu8");if(a){a=a.querySelector(".title");if(a){a=a.textContent.trim(),a=window.moment(a,["MMMM YYYY","YYYYÂπ¥MÊúà"]);if(a.isValid()){t=t.classList.contains("adjacent-month");let e;n=parseInt(n);(e=(t?15<n?a.clone().subtract(1,"month"):a.clone().add(1,"month"):a.clone()).date(n))&&e.isValid()&&await this.updateCheckInItems(e)}}}}}}async updateCheckInItems(a){let u=document.getElementById("check-in-items-container");if(u){var e=document.getElementById("check-in-current-date");e&&(e.textContent=a.format("YYYY-MM-DD dddd"));let h=await this.getDailyNoteForDate(a),n={};h&&(n=this.readCheckInData(h));e=this.settings.checkInItems.filter(e=>e.enabled);if(0===e.length)(i=document.createElement("div")).style.padding="10px",i.style.textAlign="center",i.style.color="var(--text-muted)",i.style.fontSize="12px",i.textContent="ËØ∑Âú®ËÆæÁΩÆ‰∏≠ÂêØÁî®ÊâìÂç°È°π",u.appendChild(i);else{let t=await this.preloadWeeklyData(a);var i=e.map(e=>this.createCheckInItemElement(e,n[e.label],a,h,t));let l=await Promise.all(i),c=this.settings&&"number"==typeof this.settings.itemsPerPage&&0<this.settings.itemsPerPage?Math.floor(this.settings.itemsPerPage):4,o=Math.max(1,Math.ceil(l.length/c)),d=((!this.currentItemsPage||this.currentItemsPage<1)&&(this.currentItemsPage=1),this.currentItemsPage>o&&(this.currentItemsPage=o),e=>{if(!(e<1||e>o)){this.currentItemsPage=e,u.innerHTML="";var t=(e-1)*c,n=Math.min(t+c,l.length),a=document.createDocumentFragment();for(let e=t;e<n;e++)a.appendChild(l[e]);u.appendChild(a),h||((t=document.createElement("div")).style.marginTop="8px",t.style.textAlign="center",t.style.color="var(--text-muted)",t.style.fontSize="11px",t.style.fontStyle="italic",t.textContent="üí° ÁÇπÂáªÊó•ÂéÜÊó•ÊúüÂèØÂàõÂª∫Êó•ËÆ∞Âπ∂‰øùÂ≠òÊâìÂç°Êï∞ÊçÆ",u.appendChild(t));var i,s,r,t=document.getElementById("check-in-pagination");t&&(t.innerHTML="",1<o)&&((i=document.createElement("button")).className="check-in-page-btn-prev",i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-left"><path d="m15 18-6-6 6-6"/></svg>',i.disabled=1===e,i.addEventListener("click",()=>{1<this.currentItemsPage&&d(this.currentItemsPage-1)}),(s=document.createElement("span")).className="check-in-page-info",s.textContent=e+"/"+o,(r=document.createElement("button")).className="check-in-page-btn-next",r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right"><path d="m9 18 6-6-6-6"/></svg>',r.disabled=e===o,r.addEventListener("click",()=>{this.currentItemsPage<o&&d(this.currentItemsPage+1)}),t.appendChild(i),t.appendChild(s),t.appendChild(r))}});d(this.currentItemsPage)}}}async preloadWeeklyData(t){let s=new Map,r=this.app.metadataCache;var n=[];for(let e=6;1<=e;e--){let i=t.clone().subtract(e,"days");n.push(this.getDailyNoteForDate(i).then(e=>{if(e){var t=r.getFileCache(e),n={};if(t&&t.frontmatter)for(var a of this.settings.checkInItems)void 0!==t.frontmatter[a.label]&&(n[a.label]=t.frontmatter[a.label]);s.set(i.format("YYYY-MM-DD"),n)}return{date:i,dailyNote:e}}))}return await Promise.all(n),s}async createCheckInItemElement(c,e,n,a,i=null){let o=document.createElement("div");o.className="check-in-item",o.setAttribute("draggable","false"),o.dataset.label=c.label,function(i){let n=!1,a=null,s=null,t=e=>!(e.closest(".check-in-item-value")||e.closest(".check-in-input")||e.closest(".check-in-checkbox")),r=()=>{s&&(s.classList.remove("drag-over-before"),s.classList.remove("drag-over-after"),s=null)},l=(e,t)=>{e=document.elementFromPoint(e,t),e=e?e.closest(".check-in-item"):null;if(!e||e===o)return r(),null;s&&s!==e&&(s.classList.remove("drag-over-before"),s.classList.remove("drag-over-after"));var n=e.getBoundingClientRect(),t=t-n.top<n.height/2;return e.classList.toggle("drag-over-before",t),e.classList.toggle("drag-over-after",!t),{targetItem:s=e,isBefore:t}};if(window.PointerEvent){o.addEventListener("pointerdown",e=>{if("mouse"!==e.pointerType&&t(e.target)){n=!0,a=e.pointerId;try{o.setPointerCapture&&o.setPointerCapture(a)}catch(e){}o.classList.add("dragging")}}),o.addEventListener("pointermove",e=>{n&&(e.preventDefault(),l(e.clientX,e.clientY))});var e=e=>{if(n){n=!1;try{o.releasePointerCapture&&o.releasePointerCapture(a)}catch(e){}o.classList.remove("dragging");var e=l(e.clientX,e.clientY),t=e&&e.targetItem?e.targetItem:null,t=t?t.dataset.label:null;t&&t!==c.label&&(e=e.isBefore?"before":"after",i.reorderCheckInItems(c.label,t,e)),r()}};o.addEventListener("pointerup",e),o.addEventListener("pointercancel",e)}else{let n=!1,a=e=>e&&e.length?e[0]:null;o.addEventListener("touchstart",e=>{a(e.touches)&&t(e.target)&&(n=!0,o.classList.add("dragging"))},{passive:!0}),o.addEventListener("touchmove",e=>{var t;n&&(t=a(e.touches))&&(e.preventDefault(),l(t.clientX,t.clientY))},{passive:!1});e=e=>{var t;n&&(n=!1,o.classList.remove("dragging"),(e=a(e.changedTouches))&&(t=(t=(e=l(e.clientX,e.clientY))&&e.targetItem?e.targetItem:null)?t.dataset.label:null)&&t!==c.label&&(e=e.isBefore?"before":"after",i.reorderCheckInItems(c.label,t,e)),r())};o.addEventListener("touchend",e),o.addEventListener("touchcancel",e)}}.call(this,this),o.addEventListener("dragstart",e=>{try{e.dataTransfer.setData("text/plain",c.label),e.dataTransfer.effectAllowed="move"}catch(e){}o.classList.add("dragging")}),o.addEventListener("dragend",()=>{o.classList.remove("dragging"),o.classList.remove("drag-over-before"),o.classList.remove("drag-over-after")}),o.addEventListener("dragover",e=>{if((e.dataTransfer&&e.dataTransfer.types?Array.from(e.dataTransfer.types):[]).includes("text/checkin-label")){e.preventDefault();try{e.dataTransfer.dropEffect="move"}catch(e){}var t=o.getBoundingClientRect(),e=e.clientY-t.top<t.height/2;o.classList.toggle("drag-over-before",e),o.classList.toggle("drag-over-after",!e)}}),o.addEventListener("dragleave",()=>{o.classList.remove("drag-over-before"),o.classList.remove("drag-over-after")}),o.addEventListener("drop",e=>{var t,n,a=e.dataTransfer?e.dataTransfer.getData("text/checkin-label"):null;a&&(e.preventDefault(),a!==(t=o.dataset.label)&&(n=o.getBoundingClientRect(),e=e.clientY-n.top<n.height/2?"before":"after",this.reorderCheckInItems(a,t,e)),o.classList.remove("drag-over-before"),o.classList.remove("drag-over-after"))});var t=document.createElement("div"),s=(t.className="check-in-item-left",t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{try{e.dataTransfer.setData("text/checkin-label",c.label),e.dataTransfer.setData("text/plain",c.label),e.dataTransfer.effectAllowed="move"}catch(e){}o.classList.add("dragging")}),t.addEventListener("dragend",()=>{o.classList.remove("dragging"),o.classList.remove("drag-over-before"),o.classList.remove("drag-over-after")}),document.createElement("span")),r=(s.className="check-in-item-grip",s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-grip-vertical"><circle cx="9" cy="5" r="1"/><circle cx="9" cy="12" r="1"/><circle cx="9" cy="19" r="1"/><circle cx="15" cy="5" r="1"/><circle cx="15" cy="12" r="1"/><circle cx="15" cy="19" r="1"/></svg>',document.createElement("span")),l=(r.className="check-in-item-icon",r.textContent=c.icon,document.createElement("span")),s=(l.className="check-in-item-label",l.textContent=c.label,t.appendChild(s),t.appendChild(r),t.appendChild(l),i?this.getWeeklyDataFromCache(c.label,n,i):await this.getWeeklyData(c.label,n)),r=this.createWeeklyDisplay(s,c.type),l=(o.appendChild(t),o.appendChild(r),document.createElement("div"));if(l.className="check-in-item-value","boolean"===c.type){let t=document.createElement("input");t.type="checkbox",t.className="check-in-checkbox",t.checked=1===e||"1"===e||!0===e||"true"===e,t.addEventListener("change",async()=>{var e=t.checked?1:0;await this.saveCheckInValue(n,c.label,e,a)}),l.appendChild(t)}else{let t=document.createElement("input");t.type="number",t.className="check-in-input",t.value=e||"",t.placeholder="0",t.min="0",t.step="0.1",t.addEventListener("change",async()=>{var e=t.value.trim(),e=""===e?"":parseFloat(e);await this.saveCheckInValue(n,c.label,e,a)});i=document.createElement("span");i.className="check-in-unit",i.textContent=c.unit,l.appendChild(t),l.appendChild(i)}return o.appendChild(l),o}reorderCheckInItems(t,n,e){var a,i=Array.isArray(this.settings.checkInItems)?[...this.settings.checkInItems]:[],s=i.findIndex(e=>e.label===t),r=i.findIndex(e=>e.label===n);-1!==s&&-1!==r&&([r]=i.splice(s,1),s=i.findIndex(e=>e.label===n),i.splice("after"===e?s+1:s,0,r),this.settings.checkInItems=i,this.saveSettings(),e=document.getElementById("check-in-current-date"))&&e.textContent&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(s=e.textContent.split(" ")[0],(a=window.moment(s)).isValid())&&this.updateCheckInItems(a)}getWeeklyDataFromCache(t,n,a){var i=[];for(let e=6;1<=e;e--){var s=n.clone().subtract(e,"days"),r=s.format("YYYY-MM-DD"),r=a.get(r)||{};i.push({date:s,value:r[t]||null})}return i}async getWeeklyData(t,n){var a=[];for(let e=6;1<=e;e--){var i=n.clone().subtract(e,"days"),s=await this.getDailyNoteForDate(i);s?(s=this.readCheckInData(s),a.push({date:i,value:s[t]})):a.push({date:i,value:null})}return a}createWeeklyDisplay(e,a){let i=document.createElement("div"),s=(i.className="check-in-weekly",this.settings.weeklyDisplayMode||"dots");return e.forEach((e,t)=>{var n=document.createElement("span");n.className="check-in-weekly-day",n.title=e.date.format("MM-DD"),"dots"===s?"boolean"===a?(n.textContent=e.value?"‚óè":"‚óã",n.style.color=e.value?"var(--text-accent)":"var(--text-faint)"):null!=e.value&&0<e.value?(n.textContent="‚óè",n.style.color="var(--text-accent)"):(n.textContent="‚óã",n.style.color="var(--text-faint)"):"bars"===s?(n.textContent="‚ñå","boolean"===a?n.style.color=e.value?"var(--text-accent)":"var(--text-faint)":null!=e.value&&0<e.value?(n.style.color="var(--text-accent)",n.style.opacity=Math.min(e.value/10,1)):n.style.color="var(--text-faint)"):"numbers"===s?"boolean"===a?(n.textContent=e.value?"‚úì":"‚úó",n.style.color=e.value?"var(--text-accent)":"var(--text-faint)"):null!=e.value?(n.textContent=0<e.value?Math.round(e.value):"-",n.style.color=0<e.value?"var(--text-normal)":"var(--text-faint)"):(n.textContent="-",n.style.color="var(--text-faint)"):"icons"===s&&("boolean"===a?n.textContent=e.value?"‚úÖ":"‚¨ú":null!=e.value&&0<e.value?n.textContent="‚úÖ":n.textContent="‚¨ú"),i.appendChild(n)}),i}async saveCheckInValue(e,t,n,a){try{(a=a||await this.createDailyNoteForDate(e))&&(await this.updateCheckInData(a,t,n),new Notice("ÊâìÂç°Êï∞ÊçÆÂ∑≤‰øùÂ≠ò"))}catch(e){new Notice("‰øùÂ≠òÂ§±Ë¥•: "+e.message)}}async getDailyNoteForDate(e){var t=this.app.vault,n=this.app.internalPlugins.getPluginById("daily-notes");if(!n||!n.enabled)return null;var a=n.instance.options.format||"YYYY-MM-DD",n=n.instance.options.folder||"",i=e.format(a)+".md",e=t.getAbstractFileByPath(n?n+"/"+i:i);if(e&&e instanceof require("obsidian").TFile)return e;var s,{TFile:r,TFolder:l}=require("obsidian");let c=null;if(n){a=t.getAbstractFileByPath(n);if(a&&a instanceof l)for(var o,d=[a];0<d.length&&!c;)for(o of d.pop().children)if(o instanceof r){if(o.name===i){c=o;break}}else o instanceof l&&d.push(o)}else for(s of t.getFiles())if(s.name===i){c=s;break}return c&&c instanceof r?c:null}async createDailyNoteForDate(e){var n=this.app.internalPlugins.getPluginById("daily-notes");if(!n||!n.enabled)return new Notice("ËØ∑ÂÖàÂêØÁî®Êó•ËÆ∞Ê†∏ÂøÉÊèí‰ª∂"),null;try{var a=this.app.vault,i=n.instance.options.format||"YYYY-MM-DD",s=n.instance.options.folder||"",r=n.instance.options.template||"",l=e.format(i)+".md",c=s?s+"/"+l:l;if(s){var o,d=s.split("/").filter(e=>e);let e="";for(o of d)e=e?e+"/"+o:o,a.getAbstractFileByPath(e)||await a.createFolder(e)}let t="";if(r){let e=r;e.endsWith(".md")||(e=r+".md");var h=a.getAbstractFileByPath(e);h instanceof require("obsidian").TFile&&(t=await a.read(h))}return t=t.replace(/{{date}}/g,e.format(i)).replace(/{{time}}/g,window.moment().format("HH:mm")).replace(/{{title}}/g,e.format(i)),await a.create(c,t)}catch(e){return null}}readCheckInData(e){var t=this.app.metadataCache,n=t.getFileCache(e),a={};if(n&&n.frontmatter)for(var i of this.settings.checkInItems)void 0!==n.frontmatter[i.label]&&(a[i.label]=n.frontmatter[i.label]);return a}async updateCheckInData(e,t,i){var{vault:n,metadataCache:a}=this.app,s=await n.read(e),a=a.getFileCache(e),r=t;let l=s;if(a&&a.frontmatter){var c=s.split("\n");let t=!1,n=-1,a=!1;for(let e=0;e<c.length;e++){var o=c[e].trim();if(0===e&&"---"===o)t=!0;else{if(t&&"---"===o){n=e;break}t&&o.startsWith(r+":")&&(""===i||null==i?(c.splice(e,1),e--):c[e]=r+": "+i,a=!0)}}!a&&0<n&&""!==i&&null!=i&&c.splice(n,0,r+": "+i),l=c.join("\n")}else""!==i&&null!=i&&(l=`---
${r}: ${i}
---

`+s);await n.modify(e,l)}async handleFileOpen(t){var n=this.app.internalPlugins.getPluginById("daily-notes");if(n&&n.enabled){n=n.instance.options.format||"YYYY-MM-DD";let e=window.moment(t.basename,n,!0);e.isValid()&&setTimeout(()=>{this.updateCheckInItems(e),this.highlightDateInCalendar(e)},200)}}highlightDateInCalendar(e){var t,n=e.format("YYYY-MM-DD");for(t of document.querySelectorAll(".day.svelte-q3wqg9"))if(t.getAttribute("data-date")===n){t.scrollIntoView({behavior:"smooth",block:"nearest"});break}}async openCheckInForDate(e){let t=await this.getDailyNoteForDate(e);(t=t||await this.createDailyNoteForDate(e))&&await this.app.workspace.getUnpinnedLeaf().openFile(t)}}class CheckInItemsModal extends Modal{constructor(e,t){super(e),this.plugin=t}onOpen(){var e=this.contentEl,t=(e.empty(),e.addClass("check-in-modal"),e.createEl("h2",{text:"ÊâìÂç°È°πËÆæÁΩÆ"}),e.createEl("p",{text:"‚ö†Ô∏èÊ≥®ÊÑèÔºöÊâìÂç°È°πÁõÆÊ∑ªÂä†ÂêéÔºå‰∏çÂÖÅËÆ∏‰øÆÊîπÔºà‰ºöÂΩ±ÂìçÂà∞Â∑≤ÊúâÁöÑÊï∞ÊçÆÔºâ"}),e.createDiv("check-in-modal-content")),t=(this.itemsListContainer=t.createDiv("check-in-items-list"),this.renderItemsList(),t.createDiv("check-in-add-item-section")),t=(t.createEl("h3",{text:"Ê∑ªÂä†Êñ∞ÊâìÂç°È°π"}),t.createDiv("check-in-add-form"));let n=new Setting(t).setName("Emoji ÂõæÊ†á").setDesc("ÂøÖÂ°´È°π,ÁÇπÂáªÂè≥‰æßüòÉÂõæÊ†áÈÄâÊã©ÔºåÊàñÈÄöËøáÁîµËÑëÁ≥ªÁªüËá™Â∏¶ÁöÑ emoji Ë°®ÊÉÖÈÄâÊã©").addText(e=>{(this.newItemEmoji=e).setPlaceholder("ËæìÂÖ•emoji").inputEl.style.width="100px"});var a=n.controlEl.createEl("button",{cls:"check-in-emoji-picker-btn",text:"üòÄ"});let i=e.createDiv("check-in-emoji-picker");i.style.display="none";"üèÉ, üö∂, üèä, üö¥, üèãÔ∏è, ü§∏, üßò,üíß, ‚òï, üçé, üçä, ü•ó, üç±, üç∫, üç∑,üìö, üìñ, üìù, üß†, üéß, üíª, üì±,üõè, üí§, ‚è∞,‚ù§Ô∏è, üí™, üî•, ‚úÖ, üìÖ, üìå, üßπ, üß∫,üí©,üëå,üéì,üå±,‚òòÔ∏è,üåô,ü•Ç,üßã,üç©,üé®,‚öΩÔ∏è,üèÄ,üèà,‚öæÔ∏è,ü•é,üéæ,üèê,üèâ,ü•è,üé±,üèì,üè∏,üé£,ü•ä,üßò‚Äç‚ôÄÔ∏è,üéº,üéÆ,üö¨,üíä,üñãÔ∏è".split(",").forEach(e=>{var t=i.createSpan("check-in-emoji-option");t.textContent=e,t.addEventListener("click",()=>{this.newItemEmoji&&this.newItemEmoji.setValue(e),i.style.display="none"})}),a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation();var t,e=n&&n.settingEl?n.settingEl:null;e?"none"===i.style.display||!i.style.display?((t=e.parentElement)&&t.insertBefore(i,e.nextSibling),i.style.display="flex"):i.style.display="none":i.style.display="none"!==i.style.display&&i.style.display?"none":"flex"}),new Setting(t).setName("Ê†áÁ≠æÂêçÁß∞").setDesc("ÂøÖÂ°´È°π,‰æãÂ¶Ç: Ë∑ëÊ≠•„ÄÅÂñùÊ∞¥„ÄÅËØª‰π¶").addText(e=>{(this.newItemLabel=e).setPlaceholder("ËæìÂÖ•Ê†áÁ≠æÂêçÁß∞")}),new Setting(t).setName("Âçï‰Ωç").setDesc("ÂøÖÂ°´È°π,‰æãÂ¶Ç: ÂÖ¨Èáå„ÄÅÊùØ„ÄÅÂàÜÈíü(Â∏ÉÂ∞îÂÄºÁ±ªÂûãÂèØÁïôÁ©∫)").addText(e=>{(this.newItemUnit=e).setPlaceholder("ËæìÂÖ•Âçï‰Ωç")}),new Setting(t).setName("Êï∞ÊçÆÁ±ªÂûã").setDesc("ÂøÖÂ°´È°π,ÈÄâÊã©ÊòØÂ∏ÉÂ∞îÂÄº(ÊòØ/Âê¶)ËøòÊòØÊï∞Â≠óÁ±ªÂûã").addDropdown(e=>{(this.newItemType=e).addOption("number","Êï∞Â≠ó").addOption("boolean","Â∏ÉÂ∞îÂÄº").setValue("number").onChange(e=>{this.newItemUnit.inputEl.placeholder="boolean"===e?"Â∏ÉÂ∞îÂÄºÁ±ªÂûãÊó†ÈúÄÂçï‰Ωç":"ËæìÂÖ•Âçï‰Ωç"})}),new Setting(t).addButton(e=>{e.setButtonText("Ê∑ªÂä†ÊâìÂç°È°π").setCta().onClick(async()=>{await this.addNewItem()})});a=e.createDiv("check-in-modal-buttons");a.createEl("button",{text:"‰øùÂ≠ò",cls:"check-in-modal-btn check-in-modal-btn-primary"}).addEventListener("click",async()=>{await this.plugin.saveSettings(),new Notice("ËÆæÁΩÆÂ∑≤‰øùÂ≠ò");var e=document.getElementById("check-in-current-date");e&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(e=e.textContent.split(" ")[0],(e=window.moment(e)).isValid())&&await this.plugin.updateCheckInItems(e),this.close()}),a.createEl("button",{text:"ÂèñÊ∂à",cls:"check-in-modal-btn check-in-modal-btn-secondary"}).addEventListener("click",()=>{this.close()})}renderItemsList(){var e;if(this.itemsListContainer.empty(),0===this.plugin.settings.checkInItems.length)(e=this.itemsListContainer.createDiv()).style.padding="20px",e.style.textAlign="center",e.style.color="var(--text-muted)",e.textContent="ÊöÇÊó†ÊâìÂç°È°π,ËØ∑Ê∑ªÂä†Êñ∞È°πÁõÆ";else for(var t of this.plugin.settings.checkInItems)this.createItemSetting(this.itemsListContainer,t)}createItemSetting(e,t){var e=e.createDiv("check-in-modal-item"),e=new Setting(e).setName(t.icon+" "+t.label).setDesc(`Á±ªÂûã: ${"boolean"===t.type?"Â∏ÉÂ∞îÂÄº":"Êï∞Â≠ó"} | Âçï‰Ωç: `+(t.unit||"Êó†")).addToggle(e=>{e.setValue(t.enabled).onChange(e=>{t.enabled=e})}).addButton(e=>{e.setButtonText("Âà†Èô§").setWarning().onClick(async()=>{await this.deleteItem(t)})}),n=e&&e.settingEl?e.settingEl.querySelector(".setting-item-info"):null,a=e&&e.settingEl?e.settingEl.querySelector(".setting-item-name"):null,i=e&&e.settingEl?e.settingEl.querySelector(".setting-item-description"):null;n&&a&&i&&(n.style.display="flex",n.style.flexDirection="row",n.style.alignItems="center",a.style.marginRight="8px",i.style.marginTop="0");let s=e.settingEl;s&&(s.dataset.label=t.label,s.setAttribute("draggable","true"),s.addEventListener("dragstart",e=>{try{e.dataTransfer.setData("text/checkin-setting-label",t.label),e.dataTransfer.effectAllowed="move"}catch(e){}}),s.addEventListener("dragover",e=>{if((e.dataTransfer&&e.dataTransfer.types?Array.from(e.dataTransfer.types):[]).includes("text/checkin-setting-label")){e.preventDefault();try{e.dataTransfer.dropEffect="move"}catch(e){}var t=s.getBoundingClientRect(),e=e.clientY-t.top<t.height/2;s.classList.toggle("drag-over-before",e),s.classList.toggle("drag-over-after",!e)}}),s.addEventListener("drop",e=>{var t,n=e.dataTransfer?e.dataTransfer.getData("text/checkin-setting-label"):null,a=s.dataset.label;n&&a&&n!==a?(e.preventDefault(),t=s.getBoundingClientRect(),e=e.clientY-t.top<t.height/2?"before":"after",this.plugin.reorderCheckInItems(n,a,e),this.renderItemsList()):(s.classList.remove("drag-over-before"),s.classList.remove("drag-over-after"))}),s.addEventListener("dragleave",()=>{s.classList.remove("drag-over-before"),s.classList.remove("drag-over-after")}))}async addNewItem(){var e=this.newItemEmoji.getValue().trim();let t=this.newItemLabel.getValue().trim();var n=this.newItemUnit.getValue().trim(),a=this.newItemType.getValue(),i=[];e||i.push("Emoji ÂõæÊ†á"),t||i.push("Ê†áÁ≠æÂêçÁß∞"),"number"!==a||n||i.push("Âçï‰Ωç(Êï∞Â≠óÁ±ªÂûãÂøÖÂ°´)"),0<i.length?new Notice("ËæìÂÖ•ÁöÑÊï∞ÊçÆ‰∏çÂÆåÊï¥,Êó†Ê≥ïÊ∑ªÂä†ÊâìÂç°È°πÁõÆ\nÁº∫Â∞ë: "+i.join("„ÄÅ")):this.plugin.settings.checkInItems.find(e=>e.label===t)?new Notice("Â∑≤Â≠òÂú®Áõ∏ÂêåÊ†áÁ≠æÁöÑÊâìÂç°È°π: "+t):(i={label:t,icon:e,type:a,unit:n,enabled:!0},this.plugin.settings.checkInItems.push(i),await this.plugin.saveSettings(),this.newItemEmoji.setValue(""),this.newItemLabel.setValue(""),this.newItemUnit.setValue(""),this.newItemType.setValue("number"),this.renderItemsList(),setTimeout(async()=>{var e=document.getElementById("check-in-current-date");let t=window.moment();e&&e.textContent&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(e=e.textContent.split(" ")[0],(e=window.moment(e)).isValid())&&(t=e),await this.plugin.updateCheckInItems(t)},0))}async deleteItem(e){e=this.plugin.settings.checkInItems.indexOf(e);-1<e&&(this.plugin.settings.checkInItems.splice(e,1),await this.plugin.saveSettings(),this.renderItemsList())}onClose(){var e=this.contentEl;e.empty()}}class CheckInSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var e=this.containerEl;e.empty(),e.createEl("h2",{text:"Check-in Êèí‰ª∂ËÆæÁΩÆ"}),new Setting(e).setName("ÊúÄËøë‰∏ÄÂë®ÊòæÁ§∫Ê®°Âºè").setDesc("ÈÄâÊã©ÊâìÂç°È°π‰∏≠ÊúÄËøë‰∏ÄÂë®Êï∞ÊçÆÁöÑÊòæÁ§∫ÊñπÂºè").addDropdown(e=>e.addOption("dots","ÂúÜÁÇπÊ®°Âºè (‚óè‚óã)").addOption("bars","Êù°ÂΩ¢ÂõæÊ®°Âºè (‚ñå)").addOption("numbers","Êï∞Â≠óÊ®°Âºè (‚úì‚úó)").addOption("icons","ÂõæÊ†áÊ®°Âºè (‚úÖ‚¨ú)").setValue(this.plugin.settings.weeklyDisplayMode||"dots").onChange(async e=>{this.plugin.settings.weeklyDisplayMode=e,await this.plugin.saveSettings();var e=document.getElementById("check-in-current-date");e&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(e=e.textContent.split(" ")[0],(e=window.moment(e)).isValid())&&await this.plugin.updateCheckInItems(e)})),new Setting(e).setName("ÊØèÈ°µÊòæÁ§∫Ë°åÊï∞").setDesc("ÊâìÂç°Èù¢Êùø‰∏≠ÊØè‰∏ÄÈ°µÊòæÁ§∫ÁöÑÊâìÂç°È°πÊï∞ÈáèÔºåÈªòËÆ§ 4 Ë°å").addText(e=>{e.inputEl.type="number",e.inputEl.min="1",e.inputEl.max="20",e.setValue(String(this.plugin.settings.itemsPerPage||4)),e.onChange(async e=>{var e=parseInt(e,10);!isNaN(e)&&0<e&&(this.plugin.settings.itemsPerPage=e,await this.plugin.saveSettings(),e=document.getElementById("check-in-current-date"))&&"ËØ∑ÈÄâÊã©Êó•Êúü"!==e.textContent&&(e=e.textContent.split(" ")[0],(e=window.moment(e)).isValid())&&await this.plugin.updateCheckInItems(e)})}),e.createEl("h3",{text:"ÊâìÂç°È°πÁÆ°ÁêÜ"}),e.createEl("p",{cls:"setting-item-description"}).textContent="ÁÇπÂáª‰∏ãÈù¢ÁöÑÊåâÈíÆÊù•ÁÆ°ÁêÜÊâìÂç°È°π",new Setting(e).setName("ÁÆ°ÁêÜÊâìÂç°È°π").setDesc("Ê∑ªÂä†„ÄÅÂà†Èô§Êàñ‰øÆÊîπÊâìÂç°È°π").addButton(e=>e.setButtonText("ÊâìÂºÄËÆæÁΩÆ").onClick(()=>{new CheckInItemsModal(this.app,this.plugin).open()}))}}module.exports=CheckInPlugin;