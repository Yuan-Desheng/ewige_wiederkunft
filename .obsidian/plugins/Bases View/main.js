let{Plugin,BasesView,Notice}=require("obsidian"),crypto=null;try{crypto=require("crypto")}catch(t){crypto=null}let LINE_CHART_VIEW_TYPE="line-chart-view",BAR_CHART_VIEW_TYPE="bar-chart-view",PIE_CHART_VIEW_TYPE="pie-chart-view",HEAT_MAP_VIEW_TYPE="heat-map-view";function compareVersions(t,e){if(!t||!e)return 0;try{for(var r=t.split(".").map(t=>parseInt(t,10)||0),i=e.split(".").map(t=>parseInt(t,10)||0);r.length<3;)r.push(0);for(;i.length<3;)i.push(0);for(let t=0;t<3;t++){if(r[t]<i[t])return-1;if(r[t]>i[t])return 1}return 0}catch(t){return 0}}function generateSecureHash(t,e=null){t=(e=e||`cp_salt_${Math.floor(Date.now()/864e5)}_security`)+t+e;if(crypto&&crypto.createHash)try{var r=crypto.createHash("sha256");return r.update(t),r.digest("hex")}catch(t){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(t)).then(t=>Array.from(new Uint8Array(t)).map(t=>t.toString(16).padStart(2,"0")).join("")).catch(()=>null)}catch(t){}return generateSimpleHash(t)}function generateSimpleHash(e){let r=0;if(0===e.length)return r.toString(16);for(let t=0;t<e.length;t++){var i=e.charCodeAt(t);r=(r<<5)-r+i,r&=r}return(Math.abs(r).toString(16)+e.length.toString(16)+Date.now().toString(16).slice(-8)).padStart(64,"0").slice(0,64)}async function generatePluginFingerprint(t,e){try{var r={id:t.id||"obsidian-content-protection",version:t.version,author:t.author,name:t.name,path:e.replace(/\\/g,"/"),minAppVersion:t.minAppVersion},i=generateSecureHash(JSON.stringify(r,Object.keys(r).sort()));return i&&"function"==typeof i.then?await i:i}catch(t){return null}}async function validatePluginIntegrity(t,e){try{var r,i,a,s,n;return await generatePluginFingerprint(t,e)?(r="obsidian-content-protection",i="ytmaps",t.id===r&&t.author===i&&0<=compareVersions(t.version,"1.3.0")&&(a=generateSecureHash(JSON.stringify({id:r,author:i})),s=generateSecureHash(JSON.stringify({id:t.id,author:t.author})),n=a&&"function"==typeof a.then?await a:a,(s&&"function"==typeof s.then?await s:s)===n)):!1}catch(t){return!1}}module.exports=class extends Plugin{constructor(t,e){super(t,e)}async onload(){await this.validateContentProtectionManifest()&&(await this.loadPluginData(),this.registerBasesView("line-chart",{name:"Line Chart",icon:"trending-up",factory:(t,e)=>new LineChartView(t,e),options:()=>[{type:"toggle",displayName:"显示数据圆点",key:"showDataPoints",default:!0},{type:"toggle",displayName:"直接显示数据",key:"showDataLabels",default:!1},{type:"toggle",displayName:"启用数据聚合",key:"enableAggregation",default:!1},{type:"property",displayName:"聚合字段",key:"aggregateBy",placeholder:"选择聚合字段",default:null,condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"聚合函数",key:"aggregateFunction",options:{count:"计数",sum:"求和",avg:"平均值",max:"最大值",min:"最小值"},default:"count",condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"多图表模式",key:"multiChartMode",options:{property:"按属性多图表",group:"按分组多图表"},default:"property"},{type:"dropdown",displayName:"分组布局方向",key:"groupLayout",options:{vertical:"竖向排列",horizontal:"横向排列"},default:"vertical"},{type:"property",displayName:"X轴属性",key:"x",filter:t=>!t.startsWith("file."),placeholder:"选择属性",default:"date"},{type:"text",displayName:"图表高度",key:"height",default:"300",placeholder:"输入图表高度"}]}),this.registerBasesView("bar-chart",{name:"Bar Chart",icon:"bar-chart-2",factory:(t,e)=>new BarChartView(t,e),options:()=>[{type:"toggle",displayName:"直接显示数据",key:"showDataLabels",default:!1},{type:"toggle",displayName:"启用数据聚合",key:"enableAggregation",default:!1},{type:"property",displayName:"聚合字段",key:"aggregateBy",placeholder:"选择聚合字段",default:null,condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"聚合函数",key:"aggregateFunction",options:{count:"计数",sum:"求和",avg:"平均值",max:"最大值",min:"最小值"},default:"count",condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"多图表模式",key:"multiChartMode",options:{property:"按属性多图表",group:"按分组多图标"},default:"property"},{type:"dropdown",displayName:"分组布局方向",key:"groupLayout",options:{vertical:"竖向排列",horizontal:"横向排列"},default:"vertical"},{type:"property",displayName:"X轴属性",key:"x",filter:t=>!t.startsWith("file."),placeholder:"选择属性",default:"category"},{type:"text",displayName:"图表高度",key:"height",default:"300",placeholder:"输入图表高度"}]}),this.registerBasesView("pie-chart",{name:"Pie Chart",icon:"pie-chart",factory:(t,e)=>new PieChartView(t,e),options:()=>[{type:"toggle",displayName:"启用数据聚合",key:"enableAggregation",default:!1},{type:"property",displayName:"聚合字段",key:"aggregateBy",placeholder:"选择聚合字段",default:null,condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"聚合函数",key:"aggregateFunction",options:{count:"计数",sum:"求和",avg:"平均值",max:"最大值",min:"最小值"},default:"count",condition:t=>t.get("enableAggregation")},{type:"property",displayName:"标签属性",key:"label",filter:t=>!t.startsWith("file."),placeholder:"选择标签属性",default:"label"},{type:"property",displayName:"数值属性",key:"value",filter:t=>!t.startsWith("file."),placeholder:"选择数值属性",default:"value"},{type:"text",displayName:"图表大小",key:"size",default:"300",placeholder:"输入图表大小 (200-800)"},{type:"toggle",displayName:"显示图例",key:"showLegend",default:!0}]}),this.registerBasesView("heat-map",{name:"Heat Map",icon:"calendar",factory:(t,e)=>new HeatMapView(t,e),options:()=>[{type:"dropdown",displayName:"视图模式",key:"viewMode",options:{year:"年视图",month:"月视图",week:"周视图"},default:"year"},{type:"toggle",displayName:"启用数据聚合",key:"enableAggregation",default:!0},{type:"property",displayName:"聚合字段",key:"aggregateBy",placeholder:"选择聚合字段（如日期）",default:null,condition:t=>t.get("enableAggregation")},{type:"dropdown",displayName:"聚合函数",key:"aggregateFunction",options:{count:"计数",sum:"求和",avg:"平均值",max:"最大值",min:"最小值"},default:"count",condition:t=>t.get("enableAggregation")},{type:"property",displayName:"日期属性",key:"dateProperty",filter:t=>!t.startsWith("file."),placeholder:"选择日期属性",default:"file.ctime"},{type:"dropdown",displayName:"颜色方案",key:"colorScheme",options:{green:"绿色系",blue:"蓝色系",purple:"紫色系",red:"红色系",orange:"橙色系"},default:"green"},{type:"text",displayName:"单元格大小",key:"cellSize",default:"12",placeholder:"输入单元格大小 (8-20)"},{type:"toggle",displayName:"显示月份标签",key:"showMonthLabels",default:!0,condition:t=>"year"===t.get("viewMode")},{type:"toggle",displayName:"显示星期标签",key:"showWeekLabels",default:!0}]}))}async validateContentProtectionManifest(){try{var t=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/manifest.json"),e=JSON.parse(t),r=e.version;if(!r)return!1;if(compareVersions(r,"1.3.0")<0)return!1;if("ytmaps"!==e.author)return!1;try{if(!await validatePluginIntegrity(e,".obsidian/plugins/obsidian-content-protection"))return!1;var i=generateSecureHash(`${e.id}:${e.author}:`+e.version);if(!(i&&"function"==typeof i.then?await i:i))return!1}catch(t){}return!0}catch(t){return!1}}onunload(){this.removeColorPicker()}async loadPluginData(){this.pluginData=await this.loadData()||{},this.pluginData.chartColors||(this.pluginData.chartColors=["#4f46e5","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316"]),this.pluginData.propertyColors||(this.pluginData.propertyColors={}),void 0===this.pluginData.showDataPoints&&(this.pluginData.showDataPoints=!0),await this.saveData(this.pluginData)}getChartColors(){return this.pluginData?.chartColors||["#4f46e5","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316"]}async updatePropertyColor(t,e){this.pluginData.propertyColors||(this.pluginData.propertyColors={}),this.pluginData.propertyColors[t]=e,await this.saveData(this.pluginData),this.refreshAllViews()}getPropertyColor(t,e){return this.pluginData.propertyColors&&this.pluginData.propertyColors[t]?this.pluginData.propertyColors[t]:(t=this.getChartColors())[e%t.length]}refreshAllViews(){this.app.workspace.iterateAllLeaves(t=>{t.view&&(t.view instanceof LineChartView||t.view instanceof BarChartView||t.view instanceof PieChartView)&&t.view.render()})}createColorPicker(r,i){let a=document.createElement("div");a.className="bases-color-picker",a.style.cssText=`
            position: fixed;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            width: 160px;
        `;["#4f46e5","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316","#ec4899","#6366f1","#14b8a6","#f97316","#64748b","#374151","#1f2937","#111827"].forEach(e=>{let t=document.createElement("div");t.style.cssText=`
                width: 24px;
                height: 24px;
                background-color: ${e};
                border-radius: 4px;
                cursor: pointer;
                border: 2px solid ${e===r?"#000":"transparent"};
                transition: all 0.2s ease;
            `,t.addEventListener("mouseenter",()=>{e!==r&&(t.style.transform="scale(1.1)")}),t.addEventListener("mouseleave",()=>{t.style.transform="scale(1)"}),t.addEventListener("click",t=>{t.stopPropagation(),i(e),this.removeColorPicker()}),a.appendChild(t)});var t=document.createElement("div"),e=(t.style.cssText=`
            grid-column: 1 / -1;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid #e5e7eb;
        `,document.createElement("input"));return e.type="color",e.value=r,e.style.cssText=`
            width: 100%;
            height: 32px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            cursor: pointer;
        `,e.addEventListener("change",t=>{i(t.target.value),this.removeColorPicker()}),t.appendChild(e),a.appendChild(t),a}showColorPicker(e,t,r){this.removeColorPicker();let i=this.createColorPicker(t,async t=>{await this.updatePropertyColor(r,t),e.style.backgroundColor=t});t=e.getBoundingClientRect();i.style.left=t.left+"px",i.style.top=t.bottom+5+"px",document.body.appendChild(i);let a=t=>{i.contains(t.target)||(this.removeColorPicker(),document.removeEventListener("click",a))};setTimeout(()=>{document.addEventListener("click",a)},0),this.currentColorPicker=i}removeColorPicker(){this.currentColorPicker&&(this.currentColorPicker.remove(),this.currentColorPicker=null)}aggregateData(t,i,r,a=null){if(!t||0===t.length)return[];let s={},n=(t.forEach(t=>{var e=this.getEntryPropertyValue(t,i),r=String(e||"未分类");s[r]||(s[r]={key:r,entries:[],originalKey:e}),s[r].entries.push(t)}),[]);return Object.values(s).forEach(t=>{var e=this.calculateAggregatedValue(t.entries,r,a);n.push({key:t.key,originalKey:t.originalKey,value:e,count:t.entries.length,entries:t.entries})}),n}calculateAggregatedValue(t,e,i){switch(e){case"count":return t.length;case"sum":return i?t.reduce((t,e)=>{e=this.getEntryPropertyValue(e,i),e=this.parseNumericValue(e);return t+(isNaN(e)?0:e)},0):0;case"avg":var a;return i?(a=t.reduce((t,e)=>{e=this.getEntryPropertyValue(e,i),e=this.parseNumericValue(e);return t+(isNaN(e)?0:e)},0),0<t.length?a/t.length:0):0;case"max":if(!i)return 0;let e=-1/0;return t.forEach(t=>{t=this.getEntryPropertyValue(t,i),t=this.parseNumericValue(t);!isNaN(t)&&t>e&&(e=t)}),e===-1/0?0:e;case"min":if(!i)return 0;let r=1/0;return t.forEach(t=>{t=this.getEntryPropertyValue(t,i),t=this.parseNumericValue(t);!isNaN(t)&&t<r&&(r=t)}),r===1/0?0:r;default:return t.length}}getEntryPropertyValue(t,e){if(!t||!e)return null;try{return t.getValue(e)}catch(t){return null}}parseNumericValue(e){if(null==e)return NaN;if("number"==typeof e)return e;if("object"==typeof e){let t=null;if(e.valueOf&&"function"==typeof e.valueOf&&"object"==typeof(t=e.valueOf())&&t!==e)return this.parseNumericValue(t);var r;if(null!==t&&"object"!=typeof t||e.toString&&"function"==typeof e.toString&&(t=e.toString()),null!==t&&"object"!=typeof t||void 0!==e.value&&(t=e.value),null===t||"object"==typeof t)for(r of["val","data","number","num","_value","rawValue"])if(void 0!==e[r]){t=e[r];break}if(null!==(t=null!==t&&"object"!=typeof t?t:String(e))&&t!==e&&"object"!=typeof t)return this.parseNumericValue(t)}var t,i;return"string"==typeof e?(t=parseFloat(e),isNaN(t)?(i=e.replace(/[^\d.-]/g,""),i=parseFloat(i),isNaN(i)?NaN:i):t):NaN}};class LineChartView extends BasesView{constructor(t,e){super(t),this.controller=t,this.type=LINE_CHART_VIEW_TYPE,this.containerEl=e.createDiv("bases-line-chart-container"),this.svgEl=null}onDataUpdated(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},100)}onConfigChanged(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},50)}onConfigChanged(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},50)}onConfigChanged(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},50)}onConfigChanged(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},50)}onConfigChanged(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},50)}render(){var t,e,r;this.data&&this.data.groupedData?(t=this.config.getAsPropertyId("x")||"date",e=this.config.getOrder(),this.containerEl.empty(),(r=this.containerEl.querySelector(".bases-line-legend"))&&r.remove(),this.renderChart(this.data.groupedData,{xProperty:t,propertyOrder:e,title:this.config.name||"折线图"})):this.containerEl.innerHTML='<div class="chart-error">No data available</div>'}renderChart(t,e){var r=e.xProperty||"date",e=e.propertyOrder||["value"],i=parseInt(this.config?.get("height"))||300,a=this.containerEl.clientWidth||600,s=this.config?.get("multiChartMode")||"property",t=this.processLineData(t,r,e,s);0===t.length?this.containerEl.createDiv({text:"无有效数据",cls:"bases-chart-no-data"}):"property"===s||"group"===s?this.renderMultipleCharts(t,a,i,r,e[0]):(this.svgEl=this.createSVG(a,i),this.containerEl.appendChild(this.svgEl),this.drawLineChart(t,a,i,r,e[0]))}onunload(){this.renderTimeout&&clearTimeout(this.renderTimeout),this.hideTooltip(),this.svgEl&&this.svgEl.remove()}processLineData(e,r,a,s="property",t=!1){if(!t&&(this.config?.get("enableAggregation")||!1))return this.processAggregatedLineData(e,r,a,s);var n=[],i=e.map(t=>t.key?.toString()).filter(t=>null!=t);for(let t=0;t<e.length;t++){var o,l=e[t],p=l.key?.toString(),h=null!=p?i.indexOf(p):0;for(o of l.entries)try{var u=o.getValue(r);if(u){var c=this.extractActualValue(u);if(null!==c)for(let i=0;i<a.length;i++){var d=a[i],g=o.getValue(d);if(g){var f=this.extractActualValue(g),y=parseFloat(f);if(!isNaN(y)){let t,e,r;r="group"===s?(t=d,e=h,i):(t=d,e=i,h),n.push({x:c.toString(),y:y,property:t,chartIndex:e,groupIndex:r,file:o.file?.path||"unknown"})}}}}}catch(t){}}return n}processAggregatedLineData(t,r,e,i="property"){let s=this.config?.get("aggregateBy"),n=this.config?.get("aggregateFunction")||"count",o=this.config?.get("aggregateValueProperty");if(o||"count"===n||(o=s),!s)return this.processLineData(t,r,e,i,!0);let l=[],a=[],p=(t.forEach(t=>{t.entries.forEach(t=>a.push(t))}),this.app.plugins.plugins["bases-view"]);if(!p||"function"!=typeof p.aggregateData)return this.processLineData(t,r,e,i,!0);let h={};return a.forEach(t=>{var e=p.getEntryPropertyValue(t,r),e=String(e||"未分类");h[e]||(h[e]=[]),h[e].push(t)}),Object.keys(h).forEach((t,e)=>{var r,i,a=h[t],a=p.aggregateData(a,s,n,o);0<a.length&&(r=a.reduce((t,e)=>t+e.value,0),i=a.reduce((t,e)=>t+e.count,0),a=a.flatMap(t=>t.entries),l.push({x:t,y:r,property:`${n}(${o||s})`,chartIndex:0,groupIndex:e,file:`聚合数据 (${i}个笔记)`,aggregatedEntries:a}))}),l}extractActualValue(t){if(t){if("string"==typeof t||"number"==typeof t)return t;if("object"==typeof t){if(t.date)return e=t.date instanceof Date?t.date:new Date(t.date),isNaN(e.getTime())?null:e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0");if("number"==typeof t.number)return t.number;if(t.text)return t.text;if("boolean"==typeof t.boolean)return t.boolean;if(t.option)return t.option;if(t.options&&Array.isArray(t.options))return t.options.join(", ");if(t.link)return t.link.display||t.link.path;if("function"==typeof t.toString){var e=t.toString();if("[object Object]"!==e)return e}for(var r in t)if(t.hasOwnProperty(r)&&"function"!=typeof t[r]&&"icon"!==r){var i=t[r];if(null!=i)return i}}}return null}renderMultipleCharts(t,l,p,h=null,u=null){let c={},d=(t.forEach(t=>{c[t.chartIndex]||(c[t.chartIndex]=[]),c[t.chartIndex].push(t)}),this.config?.get("groupLayout")||"vertical"),g=Object.keys(c).length;"horizontal"===d?(this.containerEl.style.display="flex",this.containerEl.style.flexWrap="wrap",this.containerEl.style.gap="20px",this.containerEl.style.justifyContent="flex-start"):this.containerEl.style.display="block",Object.keys(c).forEach((t,e)=>{var t=c[t],r=(t[0]?.property,this.containerEl.createDiv("bases-chart-group"));"horizontal"===d?(r.style.flex="1",r.style.minWidth="300px",r.style.maxWidth=Math.floor(100/Math.min(g,3))+"%",r.style.marginBottom="10px"):r.style.marginBottom="20px";let i=l,a=p;"horizontal"===d&&(i=Math.max(300,Math.floor(l/Math.min(g,3))-20),a=Math.min(p,400));var s=this.createSVG(i,a),n=(r.appendChild(s),this.svgEl),o=this.containerEl;this.svgEl=s,this.containerEl=r,this.drawLineChart(t,i,a,h,u),this.svgEl=n,this.containerEl=o})}drawLineChart(t,s,n,o=null,e){let c={top:20,right:30,bottom:40,left:50},d=s-c.left-c.right,g=n-c.top-c.bottom;if(t&&0!==t.length){let u={};t.forEach(t=>{u[t.property]||(u[t.property]=[]),u[t.property].push(t)}),Object.keys(u).forEach(t=>{u[t].sort((t,e)=>{var r=new Date(t.x),i=new Date(e.x);return isNaN(r)||isNaN(i)?t.x.localeCompare(e.x):r-i})});var f=t.map(t=>t.y).filter(t=>!isNaN(t));if(0!==f.length){let e=Math.min(...f);f=Math.max(...f);let i=f-e||1,a=[...new Set(t.map(t=>t.x))].filter(t=>null!=t&&""!==t).sort((t,e)=>{var r=new Date(t),i=new Date(e);return isNaN(r)||isNaN(i)?t.localeCompare(e):r-i});if(0!==a.length){let l=t=>{t=a.indexOf(t);return-1===t?c.left:1===a.length?c.left+d/2:c.left+t/(a.length-1)*d},p=t=>isNaN(t)?c.top+g:c.top+g-(t-e)/i*g;var t=a.map(t=>({x:t})),y=Object.keys(u);this.drawAxes(c,d,g,t,e,f,o,y);let r=["#6366f1","#ec4899","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316"],h=this.app.plugins.plugins["bases-view"];t=Object.keys(u);t.forEach((a,t)=>{var e=u[a];let s=h?h.getPropertyColor(a,t):r[t%r.length],i="",n=(e.forEach((t,e)=>{var r=l(t.x),t=p(t.y);isNaN(r)||isNaN(t)||(i+=(0===e?"M":"L")+r+","+t)}),i&&((t=document.createElementNS("http://www.w3.org/2000/svg","path")).setAttribute("d",i),t.setAttribute("stroke",s),t.setAttribute("stroke-width","2"),t.setAttribute("fill","none"),this.svgEl.appendChild(t)),!1!==this.config.get("showDataPoints")),o=!0===this.config.get("showDataLabels");e.forEach(e=>{var t,r=l(e.x),i=p(e.y);isNaN(r)||isNaN(i)||(n?((t=document.createElementNS("http://www.w3.org/2000/svg","circle")).setAttribute("cx",r),t.setAttribute("cy",i),t.setAttribute("r","3"),t.setAttribute("fill",s),t.setAttribute("stroke","white"),t.setAttribute("stroke-width","1.5"),o?this.showDataLabel(r,i,e.y,a):(t.addEventListener("mouseenter",t=>{this.showTooltip(t,{...e,property:a})}),t.addEventListener("mouseleave",()=>{this.hideTooltip()})),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();t=t.ctrlKey||t.metaKey;this.openNote(e.file,t)}),this.svgEl.appendChild(t)):((t=document.createElementNS("http://www.w3.org/2000/svg","circle")).setAttribute("cx",r),t.setAttribute("cy",i),t.setAttribute("r","6"),t.setAttribute("fill","transparent"),t.setAttribute("stroke","none"),t.style.cursor="pointer",o?this.showDataLabel(r,i,e.y,a):(t.addEventListener("mouseenter",t=>{this.showTooltip(t,{...e,property:a})}),t.addEventListener("mouseleave",()=>{this.hideTooltip()})),t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();t=t.ctrlKey||t.metaKey;this.openNote(e.file,t)}),this.svgEl.appendChild(t)))})}),this.createLegend(t,r,s,n)}}}}getPropertyValue(e,r){if(e&&"function"==typeof e.getValue)try{let t=e.getValue(r);if(t&&"function"==typeof t.isEmpty&&!t.isEmpty())return t.toString()}catch(t){}let t=null;return e?.file?.frontmatter&&void 0!==e.file.frontmatter[r]?t=e.file.frontmatter[r]:e&&void 0!==e[r]?t=e[r]:e?.data&&void 0!==e.data[r]?t=e.data[r]:e?.fields&&void 0!==e.fields[r]?t=e.fields[r]:e?.properties&&void 0!==e.properties[r]?t=e.properties[r]:e?.values&&void 0!==e.values[r]&&(t=e.values[r]),t}createLegend(l,p,t,e){let h=document.createElement("div");h.className="bases-line-legend",h.style.position="absolute",h.style.top="40px",h.style.right="70px",h.style.backgroundColor="var(--background-primary)",h.style.fontSize="12px",l.forEach((e,t)=>{var r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px",r.style.marginBottom=t<l.length-1?"4px":"0";let i=document.createElement("div"),a=(i.style.width="12px",i.style.height="2px",this.app.plugins.plugins["bases-view"]),s=a?a.getPropertyColor(e,t):p[t%p.length];i.style.backgroundColor=s,i.style.borderRadius="1px",i.style.cursor="pointer",i.style.transition="all 0.2s ease",i.addEventListener("click",t=>{t.stopPropagation(),a&&a.showColorPicker(i,s,e)}),i.addEventListener("mouseenter",()=>{i.style.transform="scale(1.2)",i.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.2)"}),i.addEventListener("mouseleave",()=>{i.style.transform="scale(1)",i.style.boxShadow="none"});var n,t=document.createElement("span");let o;o=e.includes("(")&&e.includes(")")?(n=e.match(/\(([^)]+)\)$/))?(n=n[1]).includes(".")?n.split(".").pop():n:e:e.includes(".")?e.split(".").pop():e,t.textContent=o,t.style.color="#6b7280",t.style.fontWeight="500",r.appendChild(i),r.appendChild(t),h.appendChild(r)}),this.containerEl.style.position="relative",this.containerEl.appendChild(h)}createSVG(t,e){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");return r.setAttribute("width",t),r.setAttribute("height",e),r.setAttribute("class","bases-chart-svg"),r.setAttribute("overflow","visible"),r}drawAxes(s,r,n,o,e,i,t,a){var l=document.createElementNS("http://www.w3.org/2000/svg","line"),l=(l.setAttribute("x1",s.left),l.setAttribute("y1",s.top+n),l.setAttribute("x2",s.left+r),l.setAttribute("y2",s.top+n),l.setAttribute("stroke","#e5e7eb"),this.svgEl.appendChild(l),document.createElementNS("http://www.w3.org/2000/svg","polygon")),p=s.left+r,h=s.top+n,h=(l.setAttribute("points",p+`,${h} ${p-8},${h-4} ${p-8},`+(h+4)),l.setAttribute("fill","#6b7280"),this.svgEl.appendChild(l),t&&((l=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",p),l.setAttribute("y",h+40),l.setAttribute("font-size","12"),l.setAttribute("fill","#6b7280"),l.setAttribute("font-weight","bold"),l.setAttribute("text-anchor","end"),p=t.replace(/^(note\.|file\.|formula\.)/,""),l.textContent=p,this.svgEl.appendChild(l)),document.createElementNS("http://www.w3.org/2000/svg","line")),t=(h.setAttribute("x1",s.left),h.setAttribute("y1",s.top),h.setAttribute("x2",s.left),h.setAttribute("y2",s.top+n),h.setAttribute("stroke","#e5e7eb"),this.svgEl.appendChild(h),document.createElementNS("http://www.w3.org/2000/svg","polygon")),p=s.left,l=s.top;if(t.setAttribute("points",p+`,${l} ${p-4},${l+8} ${p+4},`+(l+8)),t.setAttribute("fill","#6b7280"),this.svgEl.appendChild(t),a){h=document.createElementNS("http://www.w3.org/2000/svg","text");h.setAttribute("x",p+20),h.setAttribute("y",l+5),h.setAttribute("font-size","12"),h.setAttribute("fill","#6b7280"),h.setAttribute("font-weight","bold"),h.setAttribute("text-anchor","start");let t="";t=Array.isArray(a)?1===a.length?a[0].replace(/^(note\.|file\.|formula\.)/,""):"数值":a.replace(/^(note\.|file\.|formula\.)/,""),h.textContent=t,this.svgEl.appendChild(h)}let u=1;50<o.length?(t=Math.max(6,Math.min(8,Math.floor(r/80))),u=Math.ceil(o.length/t)):10<o.length&&(u=Math.ceil(o.length/10)),20<o.length&&(p=o.length/Math.min(10,Math.floor(r/60)),u=Math.max(u,Math.ceil(p)));var c=new Set;for(let t=0;t<o.length;t+=u)c.add(t);if(c.add(0),o.length<=5)for(let t=0;t<o.length;t++)c.add(t);Array.from(c).sort((t,e)=>t-e).forEach(t=>{let i=s.left+t/(o.length-1)*r;var e=document.createElementNS("http://www.w3.org/2000/svg","line"),e=(e.setAttribute("x1",i),e.setAttribute("y1",s.top+n),e.setAttribute("x2",i),e.setAttribute("y2",s.top+n+5),e.setAttribute("stroke","#9ca3af"),this.svgEl.appendChild(e),o[t].x.toString()),t=this.wrapText(e,8);let a=document.createElementNS("http://www.w3.org/2000/svg","g");t.forEach((t,e)=>{var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",i),r.setAttribute("y",s.top+n+20+12*e),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","10"),r.setAttribute("fill","#6b7280"),r.textContent=t,a.appendChild(r)}),this.svgEl.appendChild(a)});for(let t=0;t<5;t++){var d=e+(i-e)*(t/5),g=s.top+n-t/5*n,f=document.createElementNS("http://www.w3.org/2000/svg","line"),f=(f.setAttribute("x1",s.left-5),f.setAttribute("y1",g),f.setAttribute("x2",s.left),f.setAttribute("y2",g),f.setAttribute("stroke","#9ca3af"),this.svgEl.appendChild(f),document.createElementNS("http://www.w3.org/2000/svg","text"));f.setAttribute("x",s.left-10),f.setAttribute("y",4+g),f.setAttribute("text-anchor","end"),f.setAttribute("font-size","12"),f.setAttribute("fill","#6b7280"),f.textContent=d.toFixed(1),this.svgEl.appendChild(f)}}showTooltip(n,o){this.tooltipTimeout&&clearTimeout(this.tooltipTimeout),this.tooltipTimeout=setTimeout(()=>{if(this.hideTooltip(),this.containerEl){var r=this.containerEl.createDiv("bases-chart-tooltip"),i=(r.textContent=o.x+": "+o.y,r.style.position="absolute",this.containerEl.getBoundingClientRect()),a=n.clientX-i.left,s=n.clientY-i.top;let t=10+a,e=s-10;t+100>i.width&&(t=a-110),e<0&&(e=20+s),r.style.left=t+"px",r.style.top=e+"px",r.style.background="rgba(0,0,0,0.8)",r.style.color="white",r.style.padding="4px 8px",r.style.borderRadius="4px",r.style.fontSize="12px",r.style.pointerEvents="none",r.style.zIndex="1000"}},50)}hideTooltip(){this.tooltipTimeout&&(clearTimeout(this.tooltipTimeout),this.tooltipTimeout=null);var t=this.containerEl.querySelector(".bases-chart-tooltip");t&&t.remove()}showDataLabel(t,e,r,i){var a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",t),a.setAttribute("y",e-8),a.setAttribute("text-anchor","middle"),a.setAttribute("class","bases-chart-data-label"),a.style.fontSize="10px",a.style.fill="var(--text-normal)",a.style.fontWeight="bold",a.style.pointerEvents="none";let s=r;"number"==typeof r&&(s=r%1==0?r.toString():r.toFixed(2)),a.textContent=s,this.svgEl.appendChild(a)}wrapText(t,e){if(t.length<=e)return[t];var r,i=[];let a="";for(r of t.split(/[\s\-_]/))a.length+r.length+1<=e?a+=(a?" ":"")+r:a=a?(i.push(a),r):(i.push(r.substring(0,e)),r.substring(e));return a&&i.push(a),i}async openNote(e,r=!1){if(e&&"unknown"!==e)try{let t=null;var i,a;this.controller?.app?t=this.controller.app:window.app?t=window.app:this.app&&(t=this.app),t&&t.vault&&t.workspace&&(i=t.vault.getFileByPath(e))&&(a=t.workspace.getLeaf(!!r&&"tab"))&&await a.openFile(i,{state:{mode:"source"}})}catch(t){}}}class BarChartView extends BasesView{constructor(t,e){super(t),this.controller=t,this.type=BAR_CHART_VIEW_TYPE,this.containerEl=e.createDiv("bases-bar-chart-container"),this.svgEl=null}onDataUpdated(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},100)}render(){var t,e;this.data&&this.data.groupedData?(t=this.config.getAsPropertyId("x")||"date",e=this.config.getOrder(),this.containerEl.empty(),this.renderChart(this.data.groupedData,{xProperty:t,propertyOrder:e,title:this.config.name||"柱状图"})):this.containerEl.innerHTML='<div class="chart-error">No data available</div>'}renderChart(t,e){var r=e.xProperty||"category",e=e.propertyOrder||["value"],i=parseInt(this.config?.get("height"))||300,a=this.containerEl.clientWidth||600,s=this.config?.get("multiChartMode")||"property",t=this.processBarData(t,r,e,s);0===t.length?this.containerEl.createDiv({text:"无有效数据",cls:"bases-chart-no-data"}):(this.svgEl&&(this.svgEl.remove(),this.svgEl=null),"property"===s||"group"===s?this.renderMultipleBarCharts(t,a,i,r,e[0]):(this.svgEl=this.createSVG(a,i),this.containerEl.appendChild(this.svgEl),this.drawBarChart(t,a,i,r,e[0])))}onunload(){this.renderTimeout&&clearTimeout(this.renderTimeout),this.hideTooltip(),this.svgEl&&this.svgEl.remove()}renderMultipleBarCharts(t,l,p,h=null,u=null){let c={},d=(t.forEach(t=>{c[t.chartIndex]||(c[t.chartIndex]=[]),c[t.chartIndex].push(t)}),this.config?.get("groupLayout")||"vertical"),g=Object.keys(c).length;"horizontal"===d?(this.containerEl.style.display="flex",this.containerEl.style.flexWrap="wrap",this.containerEl.style.gap="20px",this.containerEl.style.justifyContent="flex-start"):this.containerEl.style.display="block",Object.keys(c).forEach((t,e)=>{var t=c[t],r=(t[0]?.property,this.containerEl.createDiv("bases-chart-group"));"horizontal"===d?(r.style.flex="1",r.style.minWidth="300px",r.style.maxWidth=Math.floor(100/Math.min(g,3))+"%",r.style.marginBottom="10px"):r.style.marginBottom="20px";let i=l,a=p;"horizontal"===d&&(i=Math.max(300,Math.floor(l/Math.min(g,3))-20),a=Math.min(p,400));var s=this.createSVG(i,a),n=(r.appendChild(s),this.svgEl),o=this.containerEl;this.svgEl=s,this.containerEl=r,this.drawBarChart(t,i,a,h,u),this.svgEl=n,this.containerEl=o})}processBarData(e,r,a,s="property"){if(this.config?.get("enableAggregation")||!1)return this.processAggregatedBarData(e,r,a,s);var n=[],i=e.map(t=>t.key?.toString()).filter(t=>null!=t);for(let t=0;t<e.length;t++){var o,l=e[t],p=l.key?.toString(),h=null!=p?i.indexOf(p):0;for(o of l.entries)try{var u=o.getValue(r);if(u){var c=this.extractActualValue(u);if(null!==c)for(let i=0;i<a.length;i++){var d=a[i],g=o.getValue(d);if(g){var f=this.extractActualValue(g),y=parseFloat(f);if(!isNaN(y)){let t,e,r;r="group"===s?(t=d,e=h,i):(t=d,e=i,h),n.push({x:c,y:y,property:t,chartIndex:e,groupIndex:r,file:o.file?.path||"unknown"})}}}}}catch(t){}}return n}processAggregatedBarData(t,r,e,i="property"){let o=this.config?.get("aggregateBy"),l=this.config?.get("aggregateFunction")||"count",p=this.config?.get("aggregateValueProperty");if(p||"count"===l||(p=o),!o)return this.processBarData(t,r,e,i);let a=[],h=(t.forEach(t=>{t.entries.forEach(t=>a.push(t))}),this.app.plugins.plugins["bases-view"]);if(!h||"function"!=typeof h.aggregateData)return this.processBarData(t,r,e,i);let u={},c=(a.forEach(t=>{var e=h.getEntryPropertyValue(t,r),e=String(e||"未分类");u[e]||(u[e]=[]),u[e].push(t)}),[]);return Object.keys(u).forEach((s,n)=>{var t=u[s],t=h.aggregateData(t,o,l,p);if(0<t.length){let r=t.reduce((t,e)=>t+e.value,0),i=t.reduce((t,e)=>t+e.count,0),a=t.flatMap(t=>t.entries);e.forEach((t,e)=>{c.push({x:s,y:r,property:`${l}(${p||o})`,chartIndex:e,groupIndex:n,count:i,aggregatedEntries:a})})}}),c}extractActualValue(t){if(t){if("string"==typeof t||"number"==typeof t)return t;if("object"==typeof t){if(t.date)return e=t.date instanceof Date?t.date:new Date(t.date),isNaN(e.getTime())?null:e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0");if("number"==typeof t.number)return t.number;if(t.text)return t.text;if("boolean"==typeof t.boolean)return t.boolean;if(t.option)return t.option;if(t.options&&Array.isArray(t.options))return t.options.join(", ");if(t.link)return t.link.display||t.link.path;if("function"==typeof t.toString){var e=t.toString();if("[object Object]"!==e)return e}for(var r in t)if(t.hasOwnProperty(r)&&"function"!=typeof t[r]&&"icon"!==r){var i=t[r];if(null!=i)return i}}}return null}drawBarChart(r,t,e,i=null,a=null){this.svgEl&&(this.svgEl.innerHTML="");let h={top:40,right:30,bottom:60,left:50},n=t-h.left-h.right,u=e-h.top-h.bottom,s={};r.forEach(t=>{s[t.property]||(s[t.property]=[]),s[t.property].push(t)});var o=r.map(t=>t.y);let c=Math.max(...o,0);o=Math.min(...o,0);this.drawBarAxes(h,n,u,r,o,c,i,a);let d=["#4f46e5","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316"],g=Object.keys(s);o=r.length;let f=n/o,y=.8*f,b=.2*f,m=this.app.plugins.plugins["bases-view"];r.forEach((i,t)=>{var e=g.indexOf(i.property);let r=m?m.getPropertyColor(i.property,e):d[e%d.length],a=this.darkenColor(r,.2);var e=h.left+t*f+b/2,t=Math.abs(i.y/c)*u,s=0<=i.y?h.top+u-t:h.top+u,n=document.createElementNS("http://www.w3.org/2000/svg","g");n.setAttribute("class","bar-group");let o=document.createElementNS("http://www.w3.org/2000/svg","rect"),l=(o.setAttribute("x",e),o.setAttribute("y",s),o.setAttribute("width",y),o.setAttribute("height",t),o.setAttribute("fill",r),o.setAttribute("stroke","white"),o.setAttribute("stroke-width","1"),t),p=s;!0===this.config.get("showDataLabels")?this.showBarDataLabel(e+y/2,p-5,i.y,i.property):(o.addEventListener("mouseenter",t=>{var e=.1*l,r=l+e,e=p-e;o.setAttribute("height",r),o.setAttribute("y",e),o.setAttribute("fill",a),this.showTooltip(t,{...i,property:i.property})}),o.addEventListener("mouseleave",()=>{o.setAttribute("height",l),o.setAttribute("y",p),o.setAttribute("fill",r),this.hideTooltip()})),o.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation();t=t.ctrlKey||t.metaKey;this.openNote(i.file,t)}),n.appendChild(o),this.svgEl.appendChild(n)}),this.createLegend(g,d,t,e);let l=1;if(50<r.length?(i=Math.max(5,Math.min(7,Math.floor(n/100))),l=Math.ceil(r.length/i)):8<r.length&&(l=Math.ceil(r.length/8)),15<r.length){let t=n/r.length*.8;a=Math.ceil(70/(10+t));l=Math.max(l,a)}var p=new Set;for(let t=0;t<r.length;t+=l)p.add(t);if(p.add(0),1<r.length&&p.add(r.length-1),r.length<=6)for(let t=0;t<r.length;t++)p.add(t);Array.from(p).sort((t,e)=>t-e).forEach(t=>{var e=r[t];let i=h.left+t*(n/r.length)+b/2,a=n/r.length*.8;t=e.x.toString(),e=this.wrapText(t,8);let s=document.createElementNS("http://www.w3.org/2000/svg","g");e.forEach((t,e)=>{var r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",i+a/2),r.setAttribute("y",h.top+u+20+12*e),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","10"),r.setAttribute("fill","#6b7280"),r.textContent=t,s.appendChild(r)}),this.svgEl.appendChild(s)})}drawBarAxes(r,i,a,s,t,e,n,o){var l=document.createElementNS("http://www.w3.org/2000/svg","line"),l=(l.setAttribute("x1",r.left-2),l.setAttribute("y1",r.top+a+2),l.setAttribute("x2",r.left+i),l.setAttribute("y2",r.top+a+2),l.setAttribute("stroke","#374151"),l.setAttribute("stroke-width","1"),this.svgEl.appendChild(l),document.createElementNS("http://www.w3.org/2000/svg","line"));l.setAttribute("x1",r.left-2),l.setAttribute("y1",r.top),l.setAttribute("x2",r.left-2),l.setAttribute("y2",r.top+a+2),l.setAttribute("stroke","#374151"),l.setAttribute("stroke-width","1"),this.svgEl.appendChild(l);let p=1;10<s.length&&(p=Math.ceil(s.length/10));var h=new Set;for(let t=0;t<s.length;t+=p)h.add(t);1<s.length&&h.add(s.length-1),Array.from(h).sort((t,e)=>t-e).forEach(t=>{var e=i/s.length,t=r.left+(t+.5)*e,e=document.createElementNS("http://www.w3.org/2000/svg","line");e.setAttribute("x1",t),e.setAttribute("y1",r.top+a+2),e.setAttribute("x2",t),e.setAttribute("y2",r.top+a+7),e.setAttribute("stroke","#9ca3af"),this.svgEl.appendChild(e)});for(let t=0;t<5;t++){var u=e/5*t,c=r.top+a-t/5*a,d=document.createElementNS("http://www.w3.org/2000/svg","line"),d=(d.setAttribute("x1",r.left-5),d.setAttribute("y1",c),d.setAttribute("x2",r.left),d.setAttribute("y2",c),d.setAttribute("stroke","#9ca3af"),this.svgEl.appendChild(d),document.createElementNS("http://www.w3.org/2000/svg","text"));d.setAttribute("x",r.left-10),d.setAttribute("y",4+c),d.setAttribute("text-anchor","end"),d.setAttribute("font-size","12"),d.setAttribute("fill","#6b7280"),d.textContent=u.toFixed(0),this.svgEl.appendChild(d)}n&&((l=document.createElementNS("http://www.w3.org/2000/svg","polygon")).setAttribute("points",r.left+i+0+`,${r.top+a+2-3} ${r.left+i+10},${r.top+a+2} ${r.left+i+0},`+(r.top+a+2+3)),l.setAttribute("fill","#374151"),this.svgEl.appendChild(l),(l=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",r.left+i),l.setAttribute("y",r.top+a+40),l.setAttribute("font-size","12"),l.setAttribute("fill","#374151"),l.setAttribute("font-weight","bold"),l.setAttribute("text-anchor","end"),n=n.replace(/^(note\.|file\.|formula\.)/,""),l.textContent=n,this.svgEl.appendChild(l)),o&&((n=document.createElementNS("http://www.w3.org/2000/svg","polygon")).setAttribute("points",r.left-2-3+`,${+r.top} ${r.left-2},${r.top-10} ${r.left-2+3},`+ +r.top),n.setAttribute("fill","#374151"),this.svgEl.appendChild(n),(l=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",r.left+20),l.setAttribute("y",r.top+5),l.setAttribute("font-size","12"),l.setAttribute("fill","#374151"),l.setAttribute("font-weight","bold"),l.setAttribute("text-anchor","start"),n=o.replace(/^(note\.|file\.|formula\.)/,""),l.textContent=n,this.svgEl.appendChild(l))}darkenColor(t,e){let r,i,a;if(t.startsWith("#")){var s=t.slice(1);r=parseInt(s.substr(0,2),16),i=parseInt(s.substr(2,2),16),a=parseInt(s.substr(4,2),16)}else{if(!t.startsWith("rgb"))return t;s=t.match(/\d+/g);r=parseInt(s[0]),i=parseInt(s[1]),a=parseInt(s[2])}return r=Math.max(0,Math.floor(r*(1-e))),i=Math.max(0,Math.floor(i*(1-e))),a=Math.max(0,Math.floor(a*(1-e))),`rgb(${r}, ${i}, ${a})`}createLegend(l,p,t,e){let h=document.createElement("div");h.className="bases-bar-legend",h.style.position="absolute",h.style.top="40px",h.style.right="70px",h.style.backgroundColor="var(--background-primary)",h.style.fontSize="12px",l.forEach((e,t)=>{var r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="6px",r.style.marginBottom=t<l.length-1?"4px":"0";let i=document.createElement("div"),a=(i.style.width="12px",i.style.height="12px",this.app.plugins.plugins["bases-view"]),s=a?a.getPropertyColor(e,t):p[t%p.length];i.style.backgroundColor=s,i.style.borderRadius="2px",i.style.cursor="pointer",i.style.transition="all 0.2s ease",i.addEventListener("click",t=>{t.stopPropagation(),a&&a.showColorPicker(i,s,e)}),i.addEventListener("mouseenter",()=>{i.style.transform="scale(1.1)",i.style.boxShadow="0 2px 4px rgba(0, 0, 0, 0.2)"}),i.addEventListener("mouseleave",()=>{i.style.transform="scale(1)",i.style.boxShadow="none"});var n,t=document.createElement("span");let o;o=e.includes("(")&&e.includes(")")?(n=e.match(/\(([^)]+)\)$/))?(n=n[1]).includes(".")?n.split(".").pop():n:e:e.includes(".")?e.split(".").pop():e,t.textContent=o,t.style.color="#6b7280",t.style.fontWeight="500",r.appendChild(i),r.appendChild(t),h.appendChild(r)}),this.containerEl.style.position="relative",this.containerEl.appendChild(h)}getPropertyValue(t,e){return t&&e?t.file&&t.file.frontmatter&&void 0!==t.file.frontmatter[e]?t.file.frontmatter[e]:void 0!==t[e]?t[e]:null:null}createSVG(t,e){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");return r.setAttribute("width",t),r.setAttribute("height",e),r.setAttribute("class","bases-chart-svg"),r}showTooltip(r,i){if(this.containerEl){var a=this.containerEl.createDiv("bases-chart-tooltip"),i=(a.textContent=i.x+": "+i.y,a.style.position="absolute",this.containerEl.getBoundingClientRect()),s=r.clientX-i.left,r=r.clientY-i.top;let t=10+s,e=r-10;t+100>i.width&&(t=s-110),e<0&&(e=20+r),a.style.left=t+"px",a.style.top=e+"px",a.style.background="rgba(0,0,0,0.8)",a.style.color="white",a.style.padding="4px 8px",a.style.borderRadius="4px",a.style.fontSize="12px",a.style.pointerEvents="none",a.style.zIndex="1000"}}hideTooltip(){var t=this.containerEl.querySelector(".bases-chart-tooltip");t&&t.remove()}showBarDataLabel(t,e,r,i){var a=document.createElementNS("http://www.w3.org/2000/svg","text");a.setAttribute("x",t),a.setAttribute("y",e),a.setAttribute("text-anchor","middle"),a.setAttribute("class","bases-chart-data-label"),a.style.fontSize="10px",a.style.fill="var(--text-normal)",a.style.fontWeight="bold",a.style.pointerEvents="none";let s=r;"number"==typeof r&&(s=r%1==0?r.toString():r.toFixed(2)),a.textContent=s,this.svgEl.appendChild(a)}wrapText(t,e){if(!t||t.length<=e)return[t||""];var r,i=[];let a="";for(r of t.split(/[\s\-_]+/))r.length>e?(a&&(i.push(a),a=""),i.push(r.substring(0,e)),r.length>e&&(a=r.substring(e))):(a+(a?" ":"")+r).length<=e?a+=(a?" ":"")+r:(a&&i.push(a),a=r);return a&&i.push(a),0<i.length?i:[""]}async openNote(e,r=!1){if(e&&"unknown"!==e)try{let t=null;var i,a;this.controller?.app?t=this.controller.app:window.app?t=window.app:this.app&&(t=this.app),t&&t.vault&&t.workspace&&(i=t.vault.getFileByPath(e))&&(a=t.workspace.getLeaf(!!r&&"tab"))&&await a.openFile(i,{state:{mode:"source"}})}catch(t){}}}class PieChartView extends BasesView{constructor(t,e){super(t),this.controller=t,this.type=PIE_CHART_VIEW_TYPE,this.containerEl=e.createDiv("bases-pie-chart-container"),this.svgEl=null}onDataUpdated(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},100)}render(){var t,e,r;this.data&&this.data.groupedData?(t=this.config.getAsPropertyId("label")||"label",e=this.config.getAsPropertyId("value")||"value",r=parseInt(this.config.get("size"))||300,0===(t=this.processPieData(this.data.groupedData,t,e)).length?this.containerEl.innerHTML='<div class="chart-error">No valid data points found</div>':(this.containerEl.empty(),(e=this.containerEl.createDiv("bases-pie-chart-wrapper")).style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.gap="20px",this.svgEl=this.createSVG(r,r),e.appendChild(this.svgEl),this.drawPieChart(t,r),!1!==this.config?.get("showLegend")&&(r=this.createLegend(t),e.appendChild(r)))):this.containerEl.innerHTML='<div class="chart-error">No data available</div>'}processPieData(t,e,r){if(this.config?.get("enableAggregation")||!1)return this.processAggregatedPieData(t,e,r);var i,a=new Map;for(i of t)for(var s of i.entries)try{var n,o,l,p,h,u=s.getValue(e),c=s.getValue(r);u&&c&&(n=this.extractActualValue(u),o=this.extractActualValue(c),l=parseFloat(o),null===n||isNaN(l)||(p=n.toString(),a.has(p)?(h=a.get(p),a.set(p,h+l)):a.set(p,l)))}catch(t){}return Array.from(a.entries()).map(([t,e])=>({label:t,value:e}))}processAggregatedPieData(t,r,e){let a=this.config?.get("aggregateBy"),s=this.config?.get("aggregateFunction")||"count",n=this.config?.get("aggregateValueProperty");if(n||"count"===s||(n=a),!a)return this.processPieData(t,r,e);let i=[],o=(t.forEach(t=>{t.entries.forEach(t=>i.push(t))}),this.app.plugins.plugins["bases-view"]);if(!o||"function"!=typeof o.aggregateData)return this.processPieData(t,r,e);let l={},p=(i.forEach(t=>{var e=o.getEntryPropertyValue(t,r),e=String(e||"未分类");l[e]||(l[e]=[]),l[e].push(t)}),[]);return Object.keys(l).forEach(t=>{var e,r,i=l[t],i=o.aggregateData(i,a,s,n);0<i.length&&(e=i.reduce((t,e)=>t+e.value,0),r=i.reduce((t,e)=>t+e.count,0),i=i.flatMap(t=>t.entries),p.push({label:t,value:e,count:r,aggregatedEntries:i}))}),p}extractActualValue(t){if(t){if("string"==typeof t||"number"==typeof t)return t;if("object"==typeof t){if(t.date)return t.date.toISOString().split("T")[0];if("number"==typeof t.number)return t.number;if(t.text)return t.text;if("boolean"==typeof t.boolean)return t.boolean;if(t.option)return t.option;if(t.options&&Array.isArray(t.options))return t.options.join(", ");if(t.link)return t.link.display||t.link.path;if("function"==typeof t.toString){var e=t.toString();if("[object Object]"!==e)return e}for(var r in t)if(t.hasOwnProperty(r)&&"function"!=typeof t[r]&&"icon"!==r){r=t[r];if(null!=r)return r}}}return null}onunload(){this.renderTimeout&&clearTimeout(this.renderTimeout),this.hideTooltip(),this.svgEl&&this.svgEl.remove()}drawPieChart(t,g){let f=g/2-20,y=g/2,b=g/2,m=t.reduce((t,e)=>t+e.value,0),v=this.generateColors(t.length),w=-Math.PI/2;t.forEach((e,t)=>{var r=e.value/m*2*Math.PI,i=w+r,a=w+r/2;let s=document.createElementNS("http://www.w3.org/2000/svg","g");s.setAttribute("class","pie-slice");var n=y+f*Math.cos(w),o=b+f*Math.sin(w),l=y+f*Math.cos(i),p=b+f*Math.sin(i),h=r>Math.PI?1:0,n=[`M ${y} `+b,`L ${n} `+o,`A ${f} ${f} 0 ${h} 1 ${l} `+p,"Z"].join(" ");let u=document.createElementNS("http://www.w3.org/2000/svg","path"),c=(u.setAttribute("d",n),u.setAttribute("fill",v[t]),u.setAttribute("stroke","white"),u.setAttribute("stroke-width","2"),u.setAttribute("class","pie-slice-path"),10*Math.cos(a)),d=10*Math.sin(a);u.addEventListener("mouseenter",t=>{s.style.transform=`translate(${c}px, ${d}px)`,u.setAttribute("opacity","0.8"),this.showTooltip(t,e)}),u.addEventListener("mouseleave",()=>{s.style.transform="translate(0px, 0px)",u.setAttribute("opacity","1"),this.hideTooltip()}),s.appendChild(u),.1<r&&(o=w+r/2,h=.7*f,l=y+h*Math.cos(o),p=b+h*Math.sin(o),n=(e.value/m*100).toFixed(1),(t=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",l),t.setAttribute("y",p),t.setAttribute("text-anchor","middle"),t.setAttribute("dominant-baseline","middle"),t.setAttribute("font-size",g<150?"8":g<300?"10":"12"),t.setAttribute("font-weight","bold"),t.setAttribute("fill","white"),t.setAttribute("class","pie-slice-label"),t.textContent=n+"%",s.appendChild(t)),this.svgEl.appendChild(s),w=i})}createLegend(t){let a=document.createElement("div"),s=(a.className="bases-pie-legend",a.style.display="flex",a.style.flexDirection="column",a.style.gap="8px",this.generateColors(t.length));return t.forEach((t,e)=>{var r=document.createElement("div"),i=(r.style.display="flex",r.style.alignItems="center",r.style.gap="8px",document.createElement("div")),e=(i.style.width="16px",i.style.height="16px",i.style.borderRadius="50%",i.style.backgroundColor=s[e],document.createElement("span"));e.textContent=t.label+` (${t.value})`,e.style.fontSize="14px",r.appendChild(i),r.appendChild(e),a.appendChild(r)}),a}generateColors(r){var i=this.app?.plugins?.plugins?.["bases-view"];if(i){let e=[];for(let t=0;t<r;t++)e.push(i.getPropertyColor("property_"+t,t));return e}var e=["#3b82f6","#ef4444","#10b981","#f59e0b","#8b5cf6","#06b6d4","#84cc16","#f97316","#ec4899","#6366f1"];let a=[];for(let t=0;t<r;t++)a.push(e[t%e.length]);return a}getPropertyValue(t,e){return t&&e?t.file&&t.file.frontmatter&&void 0!==t.file.frontmatter[e]?t.file.frontmatter[e]:void 0!==t[e]?t[e]:null:null}createSVG(t,e){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");return r.setAttribute("width",t),r.setAttribute("height",e),r.setAttribute("class","bases-chart-svg"),r}showTooltip(r,i){if(this.containerEl){var a=this.containerEl.createDiv("bases-chart-tooltip"),i=(a.textContent=i.label+": "+i.value,a.style.position="absolute",this.containerEl.getBoundingClientRect()),s=r.clientX-i.left,r=r.clientY-i.top;let t=10+s,e=r-10;t+100>i.width&&(t=s-110),e<0&&(e=20+r),a.style.left=t+"px",a.style.top=e+"px",a.style.background="rgba(0,0,0,0.8)",a.style.color="white",a.style.padding="4px 8px",a.style.borderRadius="4px",a.style.fontSize="12px",a.style.pointerEvents="none",a.style.zIndex="1000"}}hideTooltip(){var t=this.containerEl.querySelector(".bases-chart-tooltip");t&&t.remove()}}class HeatMapView extends BasesView{constructor(t,e){super(t),this.controller=t,this.type=HEAT_MAP_VIEW_TYPE,this.containerEl=e.createDiv("bases-heat-map-container"),this.svgEl=null,this.currentOffset=0}onDataUpdated(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.updateTimeout=setTimeout(()=>{this.render()},100)}render(){if(this.data&&this.data.groupedData){var t=this.config.get("viewMode")||"year",e=this.config.getAsPropertyId("dateProperty")||"file.ctime",r="function"==typeof this.config.getOrder?this.config.getOrder():[],r=r&&0<r.length?r[0]:null,i=parseInt(this.config.get("cellSize"))||12,a=this.config.get("colorScheme")||"green",s=!1!==this.config.get("showMonthLabels"),n=!1!==this.config.get("showWeekLabels"),o=this.processHeatMapData(this.data.groupedData,e,r);if(o&&0!==Object.keys(o).length){this.containerEl.empty();var l=this.containerEl.createDiv("heat-map-nav-container"),p=(l.style.display="flex",l.style.justifyContent="left",l.style.alignItems="center",l.style.marginBottom="5px",this.containerEl.createDiv("heat-map-chart-container"));switch(t){case"month":this.drawMonthView(o,i,a,n,p,l);break;case"week":this.drawWeekView(o,i,a,p,l);break;default:this.drawYearView(o,i,a,s,n,p,l)}}else this.containerEl.innerHTML='<div class="chart-error">无有效日期数据</div>'}else this.containerEl.innerHTML='<div class="chart-error">无可用数据</div>'}processHeatMapData(t,e,r=null,i=!1){if(!i&&!1!==this.config?.get("enableAggregation"))return this.processAggregatedHeatMapData(t,e,r);var a,s={};for(a of t)for(var n of a.entries)try{var o=n.getValue(e);if(o){var l=this.extractDateString(o);if(l)if(r){let t=0;try{var p,h,u=this.app?.plugins?.plugins?.["bases-view"];u&&"function"==typeof u.getEntryPropertyValue&&"function"==typeof u.parseNumericValue&&(p=u.getEntryPropertyValue(n,r),h=u.parseNumericValue(p),isNaN(h)||(t=h))}catch(t){}s[l]=(s[l]||0)+t}else l in s||(s[l]=0)}}catch(t){}return s}processAggregatedHeatMapData(t,r,e=null){let i=this.config?.get("aggregateBy")||e,a=this.config?.get("aggregateFunction")||"count",s=this.config?.get("aggregateValueProperty");if(s||"count"===a||(s=i),!i)return this.processHeatMapData(t,r,e,!0);let n=[],o=(t.forEach(t=>{t.entries.forEach(t=>n.push(t))}),this.app.plugins.plugins["bases-view"]);if(!o||"function"!=typeof o.aggregateData)return this.processHeatMapData(t,r,e);let l={},p=(n.forEach(t=>{var e=t.getValue(r),e=this.extractDateString(e);e&&(l[e]||(l[e]=[]),l[e].push(t))}),{});return Object.keys(l).forEach(t=>{var e=l[t],e=o.aggregateData(e,i,a,s);0<e.length&&(e=e.reduce((t,e)=>t+e.value,0),p[t]=e)}),p}createNavigationControls(t,e,r,i,a=!0,s=!0){var n=require("obsidian").setIcon,o=t.createEl("button",{cls:"heat-map-nav-button"}),a=(o.style.padding="4px 8px",o.style.cursor=a?"pointer":"not-allowed",o.style.borderRadius="4px",o.style.background=a?"transparent":"#f3f4f6",o.style.opacity=a?"1":"0.5",o.style.boxShadow="none",o.disabled=!a,n(o,"chevron-left"),a&&o.addEventListener("click",()=>{this.currentOffset--,r()}),t.createEl("span",{text:e,cls:"heat-map-nav-title"})),o=(a.style.fontWeight="bold",a.style.fontSize="12px",a.style.minWidth="40px",a.style.textAlign="center",t.createEl("button",{cls:"heat-map-nav-button"}));o.style.padding="4px 8px",o.style.cursor=s?"pointer":"not-allowed",o.style.borderRadius="4px",o.style.background="transparent",o.style.opacity=s?"1":"0.5",o.style.boxShadow="none",o.disabled=!s,n(o,"chevron-right"),s&&o.addEventListener("click",()=>{this.currentOffset++,i()}),0!==this.currentOffset&&((e=t.createEl("button",{text:"今天",cls:"heat-map-nav-today"})).style.padding="4px 12px",e.style.cursor="pointer",e.style.borderRadius="4px",e.style.background="transparent",e.style.boxShadow="none",e.style.marginLeft="10px",e.style.fontSize="12px",e.addEventListener("click",()=>{this.currentOffset=0,this.render()}))}formatLocalDate(t){return t.getFullYear()+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}extractDateString(t){if(t){if("string"==typeof t)return e=new Date(t),isNaN(e.getTime())?null:this.formatLocalDate(e);if("number"==typeof t)return e=new Date(t),isNaN(e.getTime())?null:this.formatLocalDate(e);if(t instanceof Date)return this.formatLocalDate(t);if("object"==typeof t){if(t.date)return this.formatLocalDate(t.date);if(t.number){var e=new Date(t.number);if(!isNaN(e.getTime()))return this.formatLocalDate(e)}if(t.text){e=new Date(t.text);if(!isNaN(e.getTime()))return this.formatLocalDate(e)}}}return null}drawYearView(t,a,s,e,r,i,n){var o=new Date,l=new Date(o),p=(l.setFullYear(o.getFullYear()+this.currentOffset),new Date(l)),h=(p.setFullYear(l.getFullYear()-1),new Date(p)),p=h.getDay(),p=0===p?-6:1-p,p=(h.setDate(h.getDate()+p),l.getFullYear()),l=this.currentOffset<0,u=(this.createNavigationControls(n,p+"年",()=>this.render(),()=>this.render(),!0,l),Math.max(...Object.values(t),1));let c=r?30:0,d=e?20:0;var n=new Date(h.getFullYear(),h.getMonth(),h.getDate()),p=new Date(o.getFullYear(),o.getMonth(),o.getDate()),l=Math.floor((p-n)/864e5)+1,g=Math.min(Math.ceil(l/7)+1,60),f=Math.max(g-53,0),y=Math.min(g,53),p=c+(a+2)*y,n=d+7*(a+2)+2;if(this.svgEl=this.createSVG(p,n),i.appendChild(this.svgEl),r){let i=[0,2,4,6];["一","三","五","日"].forEach((t,e)=>{var e=i[e],e=d+e*(a+2)+a/2,r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",c-13),r.setAttribute("y",e),r.setAttribute("text-anchor","end"),r.setAttribute("dominant-baseline","middle"),r.setAttribute("font-size","10"),r.setAttribute("fill","#6b7280"),r.textContent=t,this.svgEl.appendChild(r)})}let b=-1,m=0,v=-1;var w=["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"];for(let t=0;t<g;t++){var x,A,E=new Date(h),E=(E.setDate(E.getDate()+7*t),E.getMonth());E!==b&&e&&(-1!==b&&m>=f&&(A=m-f,x=t-f,0<=A)&&A<y&&(x=(A=c+A*(a+2))+(c+Math.min(x,y)*(a+2)-A-2)/2,(A=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",x),A.setAttribute("y",12),A.setAttribute("font-size","10"),A.setAttribute("fill","#6b7280"),A.setAttribute("font-weight","bold"),A.setAttribute("text-anchor","middle"),A.textContent=w[b],this.svgEl.appendChild(A)),b=E,m=t)}for(var C=new Date(h);C<=o;C.setDate(C.getDate()+1)){let r=this.formatLocalDate(C),i=t[r]||0;var D=(C.getDay()+6)%7,N=C.getTime()-h.getTime(),N=Math.floor(N/864e5),N=Math.floor(N/7);if(!(N<f||g<=N)){N=N-f;if(!(N<0||y<=N)){v=Math.max(v,N);N=c+N*(a+2),D=d+D*(a+2);let e=document.createElementNS("http://www.w3.org/2000/svg","rect");e.setAttribute("x",N),e.setAttribute("y",D),e.setAttribute("width",a),e.setAttribute("height",a),e.setAttribute("rx","2"),e.setAttribute("fill",this.getHeatMapColor(i,u,s)),e.setAttribute("stroke","#e5e7eb"),e.setAttribute("stroke-width","0"),e.addEventListener("mouseenter",t=>{e.setAttribute("stroke","#2a69cdff"),e.setAttribute("stroke-width","1"),this.showTooltip(t,{date:r,count:i})}),e.addEventListener("mouseleave",()=>{e.setAttribute("stroke","#e5e7eb"),e.setAttribute("stroke-width","0"),this.hideTooltip()}),this.svgEl.appendChild(e)}}}e&&-1!==b&&0<=(l=m-f)&&l<=v&&(n=(p=c+l*(a+2))+(c+(v+1)*(a+2)-p-2)/2,(i=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",n),i.setAttribute("y",12),i.setAttribute("font-size","10"),i.setAttribute("fill","#6b7280"),i.setAttribute("font-weight","bold"),i.setAttribute("text-anchor","middle"),i.textContent=w[b],this.svgEl.appendChild(i))}getHeatMapColor(t,e,r){return 0===t?"var(--background-modifier-hover)":(Math.min(t/e,1),r=(e={green:["#c6e48b","#7bc96f","#239a3b","#196127da"],blue:["#9be9ff","#40c4ff","#0091ea","#01579bda"],purple:["#d4c5f9","#b39ddb","#7e57c2","#512da8da"],red:["#ffcdd2","#ef5350","#d32f2f","#b71c1cda"],orange:["#ffe0b2","#ff9800","#f57c00","#e65100"]})[r]||e.green,t<3?r[0]:t<8?r[1]:t<15?r[2]:r[3])}drawMonthView(a,t,s,e,r,i){var n=new Date,o=new Date(n),l=(o.setMonth(n.getMonth()+this.currentOffset),o.getFullYear()),p=o.getMonth(),n=new Date(l,p,1),o=new Date(l,p+1,0),h=this.currentOffset<0;this.createNavigationControls(i,l+"年 "+["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"][p],()=>this.render(),()=>this.render(),!0,h);let u=Math.max(...Object.values(a),1);var c=o.getDate(),i=n.getDay(),d=0===i?6:i-1,h=Math.ceil((d+c)/7),o=r.clientWidth||800;let g=e?30:5;n=o-g-5-5;let f=Math.min((n-18)/7,((r.clientHeight||600)-25-5-3*(h-1))/h,3*t);var i=25+(f+3)*h+5,y=(this.svgEl=this.createSVG(o,i),r.appendChild(this.svgEl),["一","二","三","四","五","六","日"].forEach((t,e)=>{var e=g+e*(f+3)+f/2,r=document.createElementNS("http://www.w3.org/2000/svg","text");r.setAttribute("x",e),r.setAttribute("y",15),r.setAttribute("text-anchor","middle"),r.setAttribute("font-size","12"),r.setAttribute("fill","#6b7280"),r.textContent=t,this.svgEl.appendChild(r)}),[]);for(let t=1;t<=c;t++){var b=new Date(l,p,t);let e=this.formatLocalDate(b),r=a[e]||0;var b=b.getDay(),b=0===b?6:b-1,m=Math.floor((d+t-1)/7),b=g+b*(f+3)+f/2,m=25+m*(f+3)+f/2,v=f/2-2;0<r&&y.push({cx:b,cy:m,count:r,dateStr:e,day:t});let i=document.createElementNS("http://www.w3.org/2000/svg","circle");i.setAttribute("cx",b),i.setAttribute("cy",m),i.setAttribute("r",v),i.setAttribute("fill",0<r?this.getHeatMapColor(r,u,s):"var(--background-modifier-hover)"),i.setAttribute("stroke",0<r?this.getHeatMapColor(r,u,s):"transparent"),i.setAttribute("stroke-width","0");v=document.createElementNS("http://www.w3.org/2000/svg","text");v.setAttribute("x",b),v.setAttribute("y",m),v.setAttribute("text-anchor","middle"),v.setAttribute("dominant-baseline","middle"),v.setAttribute("font-size",Math.min(.35*f,14)),v.setAttribute("fill",0<r?"#5b2828bf":"#7d8083ff"),v.setAttribute("font-weight",0<r?"bold":"normal"),v.setAttribute("pointer-events","none"),v.textContent=t,0<r&&(i.addEventListener("mouseenter",t=>{i.setAttribute("stroke","#2a69cdff"),i.setAttribute("stroke-width","2"),this.showTooltip(t,{date:e,count:r})}),i.addEventListener("mouseleave",()=>{i.setAttribute("stroke",this.getHeatMapColor(r,u,s)),i.setAttribute("stroke-width","0"),this.hideTooltip()}),i.style.cursor="pointer"),this.svgEl.appendChild(i),this.svgEl.appendChild(v)}}drawWeekView(a,t,s,e,r){var i=new Date,n=new Date(i),i=(n.setDate(i.getDate()+7*this.currentOffset),n.getDay()),i=0===i?-6:1-i,o=new Date(n),n=(o.setDate(n.getDate()+i),new Date(o),new Date(o)),i=(n.setDate(n.getDate()+6),Math.ceil((o-new Date(o.getFullYear(),0,1))/6048e5)+1),n=this.currentOffset<0,l=(this.createNavigationControls(r,o.getFullYear()+`年第${i}周`,()=>this.render(),()=>this.render(),!0,n),Math.max(...Object.values(a),1)),r=e.clientWidth||800,i=parseInt(t)||12,p=Math.min((r-20-48)/7,5*i),n=r,t=p+20+20,h=(e.style.width="100%",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",this.svgEl=this.createSVG(n,t),e.appendChild(this.svgEl),["周一","周二","周三","周四","周五","周六","周日"]);for(let t=0;t<7;t++){var u=new Date(o);u.setDate(o.getDate()+t);let e=this.formatLocalDate(u),r=a[e]||0;var c=10+t*(p+8),d=document.createElementNS("http://www.w3.org/2000/svg","text");d.setAttribute("x",c+p/2),d.setAttribute("y",20),d.setAttribute("text-anchor","middle"),d.setAttribute("font-size",Math.min(.3*p,12)),d.setAttribute("fill","#6b7280"),d.setAttribute("font-weight","bold"),d.setAttribute("pointer-events","none"),d.textContent=h[t];let i=document.createElementNS("http://www.w3.org/2000/svg","rect");i.setAttribute("x",c),i.setAttribute("y",30),i.setAttribute("width",p),i.setAttribute("height",p),i.setAttribute("rx","8"),i.setAttribute("fill",this.getHeatMapColor(r,l,s)),i.setAttribute("stroke","#e5e7eb"),i.setAttribute("stroke-width","0");var g=document.createElementNS("http://www.w3.org/2000/svg","text");g.setAttribute("x",c+p/2),g.setAttribute("y",30+p/2),g.setAttribute("text-anchor","middle"),g.setAttribute("dominant-baseline","middle"),g.setAttribute("font-size",Math.min(.4*p,24)),g.setAttribute("fill",0<r?"#ffffff":"#9ca3af"),g.setAttribute("font-weight","bold"),g.setAttribute("pointer-events","none"),g.textContent=u.getDate(),0<r&&((u=document.createElementNS("http://www.w3.org/2000/svg","text")).setAttribute("x",c+p/2),u.setAttribute("y",30+.8*p),u.setAttribute("text-anchor","middle"),u.setAttribute("font-size",Math.min(.15*p,12)),u.setAttribute("fill",0<r?"#ffffff":"#9ca3af"),u.setAttribute("pointer-events","none"),u.textContent=r+" 条",this.svgEl.appendChild(u)),i.addEventListener("mouseenter",t=>{i.setAttribute("stroke","#2a69cdff"),i.setAttribute("stroke-width","2"),this.showTooltip(t,{date:e,count:r})}),i.addEventListener("mouseleave",()=>{i.setAttribute("stroke","#e5e7eb"),i.setAttribute("stroke-width","0"),this.hideTooltip()}),this.svgEl.appendChild(d),this.svgEl.appendChild(i),this.svgEl.appendChild(g)}}createSVG(t,e){var r=document.createElementNS("http://www.w3.org/2000/svg","svg");return r.setAttribute("width",t),r.setAttribute("height",e),r.setAttribute("class","bases-heat-map-svg"),r}showTooltip(r,i){if(this.containerEl){var a=this.containerEl.createDiv("bases-chart-tooltip"),i=(a.textContent=i.date+`: ${i.count} 条`,a.style.position="absolute",this.containerEl.getBoundingClientRect()),s=r.clientX-i.left,r=r.clientY-i.top;let t=10+s,e=r-10;t+100>i.width&&(t=s-110),e<0&&(e=20+r),a.style.left=t+"px",a.style.top=e+"px",a.style.background="rgba(0,0,0,0.8)",a.style.color="white",a.style.padding="4px 8px",a.style.borderRadius="4px",a.style.fontSize="12px",a.style.pointerEvents="none",a.style.zIndex="1000"}}hideTooltip(){var t=this.containerEl.querySelector(".bases-chart-tooltip");t&&t.remove()}onunload(){this.updateTimeout&&clearTimeout(this.updateTimeout),this.hideTooltip(),this.svgEl&&this.svgEl.remove()}}