let{Plugin,TFile,Notice,MarkdownRenderer,Component,PluginSettingTab,Setting}=require("obsidian"),fs=require("fs"),path=require("path"),crypto=null;try{crypto=require("crypto")}catch(e){crypto=null}function compareVersions(e,t){if(!e||!t)return 0;try{for(var a=e.split(".").map(e=>parseInt(e,10)||0),i=t.split(".").map(e=>parseInt(e,10)||0);a.length<3;)a.push(0);for(;i.length<3;)i.push(0);for(let e=0;e<3;e++){if(a[e]<i[e])return-1;if(a[e]>i[e])return 1}return 0}catch(e){return 0}}function generateSecureHash(e,t=null){e=(t=t||`cp_salt_${Math.floor(Date.now()/864e5)}_security`)+e+t;if(crypto&&crypto.createHash)try{var a=crypto.createHash("sha256");return a.update(e),a.digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(e=>Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")).catch(()=>null)}catch(e){}return generateSimpleHash(e)}function generateSimpleHash(t){let a=0;if(0===t.length)return a.toString(16);for(let e=0;e<t.length;e++){var i=t.charCodeAt(e);a=(a<<5)-a+i,a&=a}return(Math.abs(a).toString(16)+t.length.toString(16)+Date.now().toString(16).slice(-8)).padStart(64,"0").slice(0,64)}async function generatePluginFingerprint(e,t){try{var a={id:e.id||"obsidian-content-protection",version:e.version,author:e.author,name:e.name,path:t.replace(/\\/g,"/"),minAppVersion:e.minAppVersion},i=generateSecureHash(JSON.stringify(a,Object.keys(a).sort()));return i&&"function"==typeof i.then?await i:i}catch(e){return null}}async function validatePluginIntegrity(e,t){try{var a,i,r,s,o;return await generatePluginFingerprint(e,t)?(a="obsidian-content-protection",i="ytmaps",e.id===a&&e.author===i&&0<=compareVersions(e.version,"1.3.0")&&(r=generateSecureHash(JSON.stringify({id:a,author:i})),s=generateSecureHash(JSON.stringify({id:e.id,author:e.author})),o=r&&"function"==typeof r.then?await r:r,(s&&"function"==typeof s.then?await s:s)===o)):!1}catch(e){return!1}}let DEFAULT_SETTINGS={imageQuality:"high",cacheEnabled:!0,maxCacheSize:100,pageCountCache:{},fileInfoCache:{},authorCache:{},categoryCache:{},categoryOrderCache:{},ratingsCache:{},customTagsCache:{},viewModeCache:"card"};class PDFEbookshelfPlugin extends Plugin{constructor(e,t){super(e,t),this.coverCache=new Map,this.pageCountCache=new Map,this.fileInfoCache=new Map,this.authorCache=new Map,this.categoryCache=new Map,this.categoryOrderCache=new Map,this.ratingsCache=new Map,this.customTagsCache=new Map,this.viewModeCache="card",this.isPluginActivated=!1,this.statusCheckInterval=null,this.settings=DEFAULT_SETTINGS,this.securityCheckInterval=null,this.coverExtractionQueue=[],this.activeCoverExtractions=0,this.isMobile=this.detectMobileDevice(),this.maxConcurrentExtractions=this.isMobile?1:2,this.coverExtractionTimeout=null,this.cacheDirty=!1,this.cacheAutoSaveInterval=null}getImageQualityConfig(){var e={low:{scale:.5,format:"jpeg",quality:.1,cacheVersion:"v3-low"},medium:{scale:.7,format:"jpeg",quality:.4,cacheVersion:"v3-medium"},high:{scale:.8,format:"jpeg",quality:.5,cacheVersion:"v3-high"},ultra:{scale:1,format:"jpeg",quality:.6,cacheVersion:"v3-ultra"}};return e[this.settings.imageQuality]||e.medium}getCacheKey(){return"pdf-ebookshelf-covers-"+this.getImageQualityConfig().cacheVersion}getMaxCacheSize(){return 1024*this.settings.maxCacheSize*1024}async onload(){await this.loadSettings(),this.addSettingTab(new PDFEbookshelfSettingTab(this.app,this)),await this.checkContentProtectionStatus()&&await this.validateContentProtectionManifest()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.showActivationRequired())}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings),this.cleanupCachesOnSettingsChange()}async checkContentProtectionStatus(){try{var e=this.app.plugins.plugins["obsidian-content-protection"];if(e){if(!this.app.plugins.enabledPlugins.has("obsidian-content-protection"))return!1;if(e.settings)return!0===e.settings.isActivated&&e.settings.deviceId&&0<e.settings.deviceId.trim().length&&!0===e.settings.hasBeenActivated}return await this.checkContentProtectionFile()}catch(e){return!1}}async checkContentProtectionFile(){try{var e,t;return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?(e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/data.json"),!0===(t=JSON.parse(e)).isActivated&&t.deviceId&&0<t.deviceId.trim().length&&!0===t.hasBeenActivated):!1}catch(e){return!1}}async initializePluginFeatures(){this.startAutoSaveTimer(),this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},18e5),this.securityCheckInterval=window.setInterval(()=>{this.performSecurityCheck()||(this.isPluginActivated=!1,this.disablePluginFeatures())},3e5),await this.loadPDFJS(),this.loadAllCaches(),this.registerMarkdownCodeBlockProcessor("ebookshelf",async(e,t,a)=>{if(this.isPluginActivated)await this.renderEbookshelf(e,t,a);else{this.app.plugins.enabledPlugins.has("obsidian-content-protection");let e="";e="è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»",void t.createEl("div",{text:e,cls:"pdf-ebookshelf-error"})}}),this.addCommand({id:"clear-ebookshelf-cache",name:"æ¸…ç†PDFç¼“å­˜",callback:async()=>{this.isPluginActivated?await this.clearAllCaches():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addCommand({id:"show-ebookshelf-cache-status",name:"æŸ¥çœ‹PDFç¼“å­˜çŠ¶æ€",callback:()=>{this.isPluginActivated?this.getCacheStatus():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}})}async checkAndUpdateStatus(){var e=await this.checkContentProtectionStatus();!e&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):e&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())}disablePluginFeatures(){try{if(this.isPluginActivated=!1,this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.coverCache.clear(),this.pageCountCache.clear(),this.fileInfoCache.clear(),this.authorCache.clear(),this.categoryCache.clear(),this.ratingsCache.clear(),"function"==typeof this.onunload&&this.onunload(),this.app&&this.app.commands&&this.app.commands.commands){var e,t,a=[];for([e,t]of Object.entries(this.app.commands.commands))t.callback&&t.callback.toString().includes("PDFEbookshelfPlugin")&&a.push(e);a.forEach(e=>{delete this.app.commands.commands[e]})}try{let e=this.app.plugins;e&&e.disablePlugin&&setTimeout(()=>{e.disablePlugin("obsidian-ebookshelf")},100)}catch(e){}}catch(e){}}detectMobileDevice(){try{var e;return void 0!==this.app.isMobile?this.app.isMobile:(e=navigator.userAgent||navigator.vendor||window.opera,/android|webos|iphone|ipad|ipod|blackberry|iemobile|opera mini/i.test(e.toLowerCase()))}catch(e){return!1}}showActivationRequired(){var e;this.app.plugins.enabledPlugins.has("obsidian-content-protection")?((e=document.createElement("div")).className="pdf-ebookshelf-activation-notice",e.innerHTML=`
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>PDFç”µå­ä¹¦æ¶æ’ä»¶</h3>
                    <p>è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»</p>
                </div>
            `):((e=document.createElement("div")).className="pdf-ebookshelf-activation-notice",e.innerHTML=`
                <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>PDFç”µå­ä¹¦æ¶æ’ä»¶</h3>
                    <p>è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»</p>
                    <p style="font-size: 12px; margin-top: 10px;">
                        æ’ä»¶è·¯å¾„: obsidian-content-protection
                    </p>
                    <p style="font-size: 11px; margin-top: 8px; color: #999;">
                        è®¾ç½® â†’ ç¤¾åŒºæ’ä»¶ â†’ æ‰¾åˆ°"obsidian-content-protection"å¹¶å¯ç”¨
                    </p>
                </div>
            `)}performSecurityCheck(){try{var e;return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?!(!(e=this.app.plugins.plugins["obsidian-content-protection"])||!e.settings||!(!0===e.settings.isActivated&&e.settings.deviceId&&0<e.settings.deviceId.trim().length&&!0===e.settings.hasBeenActivated)||(this.validateContentProtectionManifest().then(e=>{e||(this.isPluginActivated=!1,this.disablePluginFeatures())}).catch(()=>{}),0)):!1}catch(e){return!1}}async validateContentProtectionManifest(){try{var e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/manifest.json"),t=JSON.parse(e),a=t.version;if(!a)return!1;if(compareVersions(a,"1.3.0")<0)return!1;if("ytmaps"!==t.author)return!1;try{if(!await validatePluginIntegrity(t,".obsidian/plugins/obsidian-content-protection"))return!1;var i=generateSecureHash(`${t.id}:${t.author}:`+t.version);if(!(i&&"function"==typeof i.then?await i:i))return!1}catch(e){}return!0}catch(e){return!1}}loadAllCaches(){this.migrateFromLocalStorage(),this.loadCoverCache(),this.loadDataCaches()}loadDataCaches(){try{this.pageCountCache=this.loadCacheMap(this.settings.pageCountCache),this.fileInfoCache=this.loadCacheMap(this.settings.fileInfoCache),this.authorCache=this.loadCacheMap(this.settings.authorCache),this.categoryCache=this.loadCacheMap(this.settings.categoryCache),this.categoryOrderCache=this.loadCacheMap(this.settings.categoryOrderCache),this.ratingsCache=this.loadCacheMap(this.settings.ratingsCache),this.customTagsCache=this.loadCacheMap(this.settings.customTagsCache),this.viewModeCache=this.settings.viewModeCache||"card"}catch(e){this.pageCountCache=new Map,this.fileInfoCache=new Map,this.authorCache=new Map,this.categoryCache=new Map,this.categoryOrderCache=new Map,this.ratingsCache=new Map,this.customTagsCache=new Map,this.viewModeCache="card"}}loadCacheMap(e){if(!e)return new Map;try{return Array.isArray(e)?new Map(e):"object"==typeof e?new Map(Object.entries(e)):new Map}catch(e){return new Map}}async saveDataCaches(){try{this.settings.pageCountCache=Object.fromEntries(this.pageCountCache.entries()),this.settings.fileInfoCache=Object.fromEntries(this.fileInfoCache.entries()),this.settings.authorCache=Object.fromEntries(this.authorCache.entries()),this.settings.categoryCache=Object.fromEntries(this.categoryCache.entries()),this.settings.categoryOrderCache=Object.fromEntries(this.categoryOrderCache.entries()),this.settings.ratingsCache=Object.fromEntries(this.ratingsCache.entries()),this.settings.customTagsCache=Object.fromEntries(this.customTagsCache.entries()),this.settings.viewModeCache=this.viewModeCache,await this.saveSettings()}catch(e){}}migrateFromLocalStorage(){try{let i=!1;[{key:"pdf-ebookshelf-pages",target:"pageCountCache"},{key:"pdf-ebookshelf-info",target:"fileInfoCache"},{key:"pdf-ebookshelf-authors",target:"authorCache"},{key:"pdf-ebookshelf-categories",target:"categoryCache"},{key:"pdf-ebookshelf-category-order",target:"categoryOrderCache"},{key:"pdf-ebookshelf-ratings",target:"ratingsCache"},{key:"pdf-ebookshelf-custom-tags",target:"customTagsCache"},{key:"pdf-ebookshelf-view-mode",target:"viewModeCache"}].forEach(e=>{var t,a=localStorage.getItem(e.key);if(a)try{(!this.settings[e.target]||"object"==typeof this.settings[e.target]&&0===Object.keys(this.settings[e.target]).length)&&("viewModeCache"===e.target?this.settings[e.target]=a:(t=JSON.parse(a),Array.isArray(t)?this.settings[e.target]=Object.fromEntries(t):this.settings[e.target]=t),i=!0),localStorage.removeItem(e.key)}catch(e){}}),i&&this.saveSettings().then(()=>{}),this.cleanupOldCaches()}catch(e){}}cleanupOldCaches(){try{var e=["pdf-ebookshelf-covers","pdf-ebookshelf-covers-v1","pdf-ebookshelf-covers-v2","pdf-ebookshelf-covers-v3-low","pdf-ebookshelf-covers-v3-medium","pdf-ebookshelf-covers-v3-high","pdf-ebookshelf-covers-v3-ultra"];let t=this.getCacheKey();e.forEach(e=>{e!==t&&localStorage.getItem(e)&&localStorage.removeItem(e)})}catch(e){}}cleanupCachesOnSettingsChange(){try{this.coverCache.clear(),this.cleanupOldCaches()}catch(e){}}loadCoverCache(){try{var e,t=this.getCacheKey(),a=localStorage.getItem(t);a&&(e=JSON.parse(a),this.coverCache=new Map(e))}catch(e){this.coverCache=new Map}}loadPageCountCache(){}loadFileInfoCache(){}loadAuthorCache(){}loadCategoryCache(){}loadRatingsCache(){}loadCategoryOrderCache(){}loadViewModeCache(){}async saveCoverCache(){if(this.settings.cacheEnabled)try{var e,t=JSON.stringify(Array.from(this.coverCache.entries())),a=new Blob([t]).size;this.getMaxCacheSize()<a?await this.cleanupCache():(e=this.getCacheKey(),localStorage.setItem(e,t))}catch(e){await this.cleanupCache()}}async savePageCountCache(){await this.saveDataCaches()}async saveFileInfoCache(){await this.saveDataCaches()}async saveAuthorCache(){this.markCacheDirty()}async saveCategoryCache(){this.markCacheDirty()}async saveRatingsCache(){await this.saveDataCaches()}async saveCategoryOrderCache(){await this.saveDataCaches()}async saveViewModeCache(){await this.saveDataCaches()}async saveCustomTagsCache(){await this.saveDataCaches()}markCacheDirty(){this.cacheDirty=!0}startAutoSaveTimer(){this.cacheAutoSaveInterval&&clearInterval(this.cacheAutoSaveInterval),this.cacheAutoSaveInterval=setInterval(async()=>{if(this.cacheDirty)try{await this.saveDataCaches(),this.cacheDirty=!1}catch(e){}},5e3)}stopAutoSaveTimer(){this.cacheAutoSaveInterval&&(clearInterval(this.cacheAutoSaveInterval),this.cacheAutoSaveInterval=null)}VirtualScrollManager=class{constructor(e,t,a,i,r){this.container=e,this.items=t,this.itemHeight=a,this.renderItem=i,this.onVisibleRangeChange=r,this.visibleStart=0,this.visibleEnd=0,this.bufferSize=10,this.scrollTop=0,this.containerHeight=0,this.scrollHeight=t.length*a,this.setupVirtualScroll()}setupVirtualScroll(){this.scrollContainer=this.container.createEl("div",{cls:"pdf-virtual-scroll-container",style:`height: ${this.scrollHeight}px; position: relative;`}),this.contentContainer=this.scrollContainer.createEl("div",{cls:"pdf-virtual-scroll-content",style:"position: absolute; top: 0; left: 0; right: 0;"}),this.container.addEventListener("scroll",this.handleScroll.bind(this)),this.updateContainerHeight(),this.updateVisibleRange()}handleScroll(){this.scrollTop=this.container.scrollTop,this.updateVisibleRange()}updateContainerHeight(){this.containerHeight=this.container.clientHeight}updateVisibleRange(){var e=Math.floor(this.scrollTop/this.itemHeight),t=Math.ceil((this.scrollTop+this.containerHeight)/this.itemHeight),e=Math.max(0,e-this.bufferSize),t=Math.min(this.items.length,t+this.bufferSize);e===this.visibleStart&&t===this.visibleEnd||(this.visibleStart=e,this.visibleEnd=t,this.renderVisibleItems(),this.onVisibleRangeChange&&this.onVisibleRangeChange(this.visibleStart,this.visibleEnd))}renderVisibleItems(){this.contentContainer.empty();var t,e=this.visibleStart*this.itemHeight;this.contentContainer.style.transform=`translateY(${e}px)`;for(let e=this.visibleStart;e<this.visibleEnd;e++)e<this.items.length&&(t=this.contentContainer.createEl("div",{cls:"pdf-virtual-scroll-item",style:`height: ${this.itemHeight}px;`}),this.renderItem(t,this.items[e],e))}updateItems(e){this.items=e,this.scrollHeight=e.length*this.itemHeight,this.scrollContainer.style.height=this.scrollHeight+"px",this.updateVisibleRange()}destroy(){this.container.removeEventListener("scroll",this.handleScroll.bind(this)),this.scrollContainer.remove()}};async saveAllCaches(){await this.saveCoverCache(),await this.saveDataCaches(),this.saveRatingsCache()}async cleanupCache(){try{var e,t=Array.from(this.coverCache.entries());500<t.length&&(e=t.sort((e,t)=>{e=this.app.vault.getAbstractFileByPath(e[0]),t=this.app.vault.getAbstractFileByPath(t[0]);return e&&t?(t.stat?.mtime||0)-(e.stat?.mtime||0):0}).slice(0,500),this.coverCache=new Map(e),this.syncCleanupOtherCaches(),await this.saveAllCaches())}catch(e){await this.clearAllCaches()}}syncCleanupOtherCaches(){var e=Array.from(this.coverCache.keys());if(0!==e.length){let t=this.app.vault.getFiles().filter(e=>"pdf"===e.extension).map(e=>e.path);e=Array.from(this.pageCountCache.entries()).filter(([e])=>t.includes(e));this.pageCountCache=new Map(e);e=Array.from(this.fileInfoCache.entries()).filter(([e])=>t.includes(e));this.fileInfoCache=new Map(e);e=Array.from(this.authorCache.entries()).filter(([e])=>t.includes(e));this.authorCache=new Map(e);e=Array.from(this.categoryCache.entries()).filter(([e])=>t.includes(e));this.categoryCache=new Map(e)}}clearCoverCache(){this.coverCache.clear(),localStorage.removeItem(this.cacheKey)}async clearAllCaches(){this.coverCache.clear(),this.pageCountCache.clear(),this.fileInfoCache.clear(),this.authorCache.clear(),this.categoryCache.clear(),this.categoryOrderCache.clear(),this.ratingsCache.clear(),this.customTagsCache.clear(),this.viewModeCache="card";var e=this.getCacheKey();localStorage.removeItem(e),this.settings.pageCountCache={},this.settings.fileInfoCache={},this.settings.authorCache={},this.settings.categoryCache={},this.settings.categoryOrderCache={},this.settings.ratingsCache={},this.settings.customTagsCache={},this.settings.viewModeCache="card",await this.saveSettings();["pdf-ebookshelf-pages","pdf-ebookshelf-info","pdf-ebookshelf-authors","pdf-ebookshelf-categories","pdf-ebookshelf-category-order","pdf-ebookshelf-ratings","pdf-ebookshelf-custom-tags","pdf-ebookshelf-view-mode"].forEach(e=>localStorage.removeItem(e))}getCacheStatus(){try{let e=0,t=0;var a,i,r=this.getCacheKey(),s=localStorage.getItem(r);s&&(a=new Blob([s]).size,i=JSON.parse(s),e+=a,t+=i.length);return{count:t,size:this.formatFileSize(e),coverCount:this.coverCache.size,pageCount:this.pageCountCache.size,infoCount:this.fileInfoCache.size,authorCount:this.authorCache.size,categoryCount:this.categoryCache.size,ratingsCount:this.ratingsCache.size}}catch(e){return{count:0,size:"0 B",coverCount:0,pageCount:0,infoCount:0,authorCount:0}}}async loadPDFJS(){try{var e;window["pdfjs-dist/build/pdf"]||((e=document.createElement("script")).src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js",e.onload=()=>{window["pdfjs-dist/build/pdf"].GlobalWorkerOptions.workerSrc="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js"},e.onerror=()=>{},document.head.appendChild(e))}catch(e){}}async onunload(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.stopAutoSaveTimer(),this.authorCacheSaveTimeout&&(clearTimeout(this.authorCacheSaveTimeout),this.authorCacheSaveTimeout=null),this.fileInfoCacheSaveTimeout&&(clearTimeout(this.fileInfoCacheSaveTimeout),this.fileInfoCacheSaveTimeout=null),this.pageCountCacheSaveTimeout&&(clearTimeout(this.pageCountCacheSaveTimeout),this.pageCountCacheSaveTimeout=null),this.coverExtractionTimeout&&(clearTimeout(this.coverExtractionTimeout),this.coverExtractionTimeout=null),this.coverExtractionQueue=[],this.activeCoverExtractions=0,this.virtualScrollInstances&&(this.virtualScrollInstances.forEach(e=>{e&&"function"==typeof e.destroy&&e.destroy()}),this.virtualScrollInstances=[]);try{document.querySelectorAll(".pdf-ebookshelf-container").forEach(e=>{e.querySelectorAll("[data-file-path], .pdf-book-title, .pdf-cover-image, .pdf-category-btn").forEach(e=>{var t=e.cloneNode(!0);e.parentNode&&e.parentNode.replaceChild(t,e)})})}catch(e){}try{await this.saveAllCaches()}catch(e){}if(this.coverCache.clear(),this.pageCountCache.clear(),this.fileInfoCache.clear(),this.authorCache.clear(),this.categoryCache.clear(),this.ratingsCache.clear(),this.customTagsCache.clear(),this.isMobile&&"undefined"!=typeof window&&window.gc)try{window.gc()}catch(e){}}async renderEbookshelf(e,t,a){try{if(this.isPluginActivated){var s=this.parseParameters(e),i=(t.empty(),t.addClass("pdf-ebookshelf-container"),t.setAttribute("data-original-params",JSON.stringify(s)),t.createEl("div",{text:"æ­£åœ¨åŠ è½½PDFä¹¦ç±...",cls:"pdf-ebookshelf-loading"}));try{var o=await this.getPDFFilesAsync(s.path||"Books/pdfä¹¦ç±");if(i.remove(),0===o.length)t.createEl("div",{text:"æœªæ‰¾åˆ°PDFæ–‡ä»¶",cls:"pdf-ebookshelf-empty"});else{var n,l=await this.categorizeFilesAsync(o),c=t.createEl("div",{cls:"pdf-view-mode-container"}),h=(c.createEl("button",{text:"å¡ç‰‡è§†å›¾",cls:"pdf-view-mode-btn"+("card"===this.viewModeCache?" pdf-view-mode-active":""),attr:{"data-view-mode":"card"}}),c.createEl("button",{text:"è¡¨æ ¼è§†å›¾",cls:"pdf-view-mode-btn"+("table"===this.viewModeCache?" pdf-view-mode-active":""),attr:{"data-view-mode":"table"}}),t.createEl("div",{cls:"pdf-category-filters"}));h.createEl("button",{text:"å…¨éƒ¨åˆ†ç±»",cls:"pdf-category-filter-btn pdf-category-filter-active"});for([n]of l){var d=h.createEl("button",{text:n,cls:"pdf-category-filter-btn"}),p=(d.setAttribute("data-category",n),this.generateCategoryColor(n));d.style.backgroundColor=p,d.style.color=this.getContrastColor(p)}let r=t.createEl("div",{cls:"pdf-ebookshelf-main-content"});for(let[i,e]of l){let t=r.createEl("div",{cls:"pdf-category-container",attr:{"data-category":i}});var u=t.createEl("div",{cls:"pdf-category-title-container"}),g=u.createEl("div",{cls:"pdf-category-move-buttons"}),v=g.createEl("button",{cls:"pdf-category-move-btn pdf-category-move-up",title:"å‘ä¸Šç§»åŠ¨åˆ†ç±»"}),f=(v.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>',g.createEl("button",{cls:"pdf-category-move-btn pdf-category-move-down",title:"å‘ä¸‹ç§»åŠ¨åˆ†ç±»"})),y=(f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',u.createEl("h6",{cls:"pdf-category-title"})),m=(v.addEventListener("click",e=>{e.stopPropagation(),this.moveCategoryUp(t,r)}),f.addEventListener("click",e=>{e.stopPropagation(),this.moveCategoryDown(t,r)}),await this.calculateCategoryStats(e));let a=y.createEl("span",{text:i,cls:"pdf-category-title-text"});a.style.cursor="pointer",a.title="ç‚¹å‡»ç¼–è¾‘åˆ†ç±»åç§°",a.addEventListener("click",e=>{e.stopPropagation(),this.editCategoryName(i,a,t)});var C,b=y.createEl("span",{text:`ï¼ˆå…¨éƒ¨${e.length}æœ¬`,cls:"pdf-category-stats"}),w=(0<m.totalProgress&&(b.textContent+=`ï¼Œé˜…è¯»è¿›åº¦${m.averageProgress}%`),b.textContent+="ï¼‰",t.createEl("div",{cls:"pdf-ebookshelf-grid"}));s.column&&(C=parseInt(s.column),!isNaN(C))&&0<C&&(w.style.gridTemplateColumns=`repeat(${C}, 1fr)`,w.style.gap=C<=2?"30px":C<=3?"25px":C<=4?"20px":C<=5?"18px":C<=6?"15px":C<=7?"12px":"10px",4<C)&&w.addClass("pdf-ebookshelf-columns-"+C),await this.renderBookCardsInBatches(w,e,s)}this.setupViewModeToggle(c,r),setTimeout(()=>{this.applyViewMode(r)},100),this.setupCategoryFilters(h,r),this.setupDynamicCategoryTitleHover(r)}}catch(e){i.remove(),t.createEl("div",{text:"åŠ è½½å¤±è´¥: "+e.message,cls:"pdf-ebookshelf-error"})}}else{t.empty(),t.addClass("pdf-ebookshelf-container");var r=this.app.plugins.enabledPlugins.has("obsidian-content-protection");let e="";e=r?"æ’ä»¶æœªæ¿€æ´»ï¼Œè¯·å…ˆæ¿€æ´»å†…å®¹ä¿æŠ¤æ’ä»¶æ‰èƒ½ä½¿ç”¨PDFç”µå­ä¹¦æ¶åŠŸèƒ½":"æ’ä»¶æœªå¯ç”¨ï¼Œè¯·å…ˆåœ¨è®¾ç½®ä¸­å¯ç”¨å†…å®¹ä¿æŠ¤æ’ä»¶æ‰èƒ½ä½¿ç”¨PDFç”µå­ä¹¦æ¶åŠŸèƒ½",void t.createEl("div",{text:e,cls:"pdf-ebookshelf-error"})}}catch(e){t.createEl("div",{text:"æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°é”™è¯¯ä¿¡æ¯",cls:"pdf-ebookshelf-error"})}}categorizeFiles(e){var t,a=new Map;for(t of e){var i=this.categoryCache.get(t.path)||"é»˜è®¤åˆ†ç±»";a.has(i)||a.set(i,[]),a.get(i).push(t)}var r,s=new Map;for(r of Array.from(a.keys()).sort((e,t)=>{var a=this.getCategoryOrder(e),i=this.getCategoryOrder(t);return 999===a&&999===i?"é»˜è®¤åˆ†ç±»"===e?1:"é»˜è®¤åˆ†ç±»"===t?-1:e.localeCompare(t,"zh-CN"):a-i}))s.set(r,a.get(r));return s}async categorizeFilesAsync(a){return new Promise(t=>{setTimeout(()=>{var e=this.categorizeFiles(a);t(e)},0)})}async calculateCategoryStats(e){let t=0,a=0;for(var i of e)try{var r=await this.getSimplePDFProgress(i);r&&0<r.percentage&&(t+=r.percentage,a++)}catch(e){continue}var s=0<a?Math.round(t/a):0;return{totalBooks:e.length,totalProgress:t,validProgressCount:a,averageProgress:s}}parseParameters(e){var t,a,i,r={};for(t of e.trim().split("\n"))t.includes(":")&&([a,i]=t.split(":").map(e=>e.trim()),r[a]=i);return r}async getPDFFiles(t){var e=this.app.vault.getAbstractFileByPath(t);if(!e||void 0===e.children)try{return await this.app.vault.createFolder(t),[]}catch(e){throw new Error(`æ–‡ä»¶å¤¹ "${t}" ä¸å­˜åœ¨ä¸”æ— æ³•åˆ›å»º`)}let a=[],i=e=>{for(var t of e.children)t instanceof TFile&&"pdf"===t.extension?a.push(t):t.children&&i(t)};return i(e),a}async getPDFFilesAsync(a){return new Promise(t=>{setTimeout(async()=>{var e=await this.getPDFFiles(a);t(e)},0)})}async processFilesInBatches(t,a=10,i){var r=[];for(let e=0;e<t.length;e+=a){var s=t.slice(e,e+a),s=await Promise.all(s.map(i));r.push(...s),await new Promise(e=>setTimeout(e,0))}return r}async renderBookCardsInBatches(i,r,s,o=null){null===o&&(o=this.isMobile?3:5);let n=i.createEl("div",{cls:"pdf-render-status",text:`æ­£åœ¨æ¸²æŸ“ ${r.length} æœ¬ä¹¦ç±...`});try{if(500<r.length)await this.renderWithVirtualScroll(i,r,s);else{let a=0;for(let e=0;e<r.length;e+=o){var l=r.slice(e,e+o);await Promise.all(l.map(async e=>{try{await this.createBookCard(i,e,s),++a%5!=0&&a!==r.length||(n.textContent=`å·²æ¸²æŸ“ ${a}/${r.length} æœ¬ä¹¦ç±...`)}catch(e){}}));let t=this.isMobile?10:0;await new Promise(e=>setTimeout(e,t))}}n.remove()}catch(e){n.textContent="æ¸²æŸ“å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•",n.style.color="red"}}async renderWithVirtualScroll(e,t,i){e.style.height="600px",e.style.overflowY="auto",e.style.position="relative";e=new this.VirtualScrollManager(e,t,200,async(t,e,a)=>{try{await this.createBookCard(t,e,i)}catch(e){t.createEl("div",{text:"æ¸²æŸ“å¤±è´¥",cls:"pdf-book-error"})}},(e,t)=>{});this.virtualScrollInstances||(this.virtualScrollInstances=[]),this.virtualScrollInstances.push(e)}async createBookCard(e,t,a){let i=e.createEl("div",{cls:"pdf-book-card"}),r=(i.setAttribute("data-file-path",t.path),i.createEl("button",{cls:"pdf-category-btn"}));r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>';var e=this.categoryCache.get(t.path)||"é»˜è®¤åˆ†ç±»",e=(r.setAttribute("title","å½“å‰åˆ†ç±»: "+e),r.addEventListener("click",e=>{e.stopPropagation();e=i.closest(".pdf-ebookshelf-container");this.editCategory(t,r,e)}),i.createEl("div",{cls:"pdf-book-cover"})),s=e.createEl("div",{cls:"pdf-cover-placeholder",text:"ğŸ“„"}),e=(this.queueCoverExtraction(t,e,s),i.createEl("div",{cls:"pdf-book-info"}));e.createEl("div",{cls:"pdf-book-title",text:t.basename}).addEventListener("click",()=>{this.app.workspace.openLinkText(t.path,"")}),this.loadAuthorInfoAsync(t,e),"false"===a.showPages&&"true"!==a.showSize||(s=e.createEl("div",{cls:"pdf-book-meta"}),this.loadMetaInfoAsync(t,s,a)),"true"===a.showProgress&&this.loadProgressInfoAsync(t,e)}async extractPDFCover(e){let t=null,a=null,i=null;try{var r,s,o,n,l,c,h,d,p,u;return this.coverCache.has(e.path)?this.coverCache.get(e.path):(r=await this.app.vault.adapter.readBinary(e.path),(s=window["pdfjs-dist/build/pdf"])?(o=s.getDocument({data:r,disableFontFace:this.isMobile,disableAutoFetch:this.isMobile,disableStream:this.isMobile}),t=await o.promise,a=await t.getPage(1),n=this.getImageQualityConfig(),l=this.isMobile?Math.min(n.scale,.5):n.scale,c=a.getViewport({scale:l}),h=(i=document.createElement("canvas")).getContext("2d",{alpha:!1,willReadFrequently:!1}),i.width=c.width,i.height=c.height,h.imageSmoothingEnabled=!0,h.imageSmoothingQuality=this.isMobile?"medium":"high",d={canvasContext:h,viewport:c,intent:"display",renderInteractiveForms:!1,optionalContentConfigPromise:null},await a.render(d).promise,p=this.isMobile?Math.min(n.quality,.3):n.quality,u=i.toDataURL("image/"+n.format,p),this.settings.cacheEnabled&&(this.coverCache.set(e.path,u),await this.saveCoverCache()),u):null)}catch(e){return null}finally{try{a&&a.cleanup(),t&&(await t.cleanup(),await t.destroy()),i&&(i.width=0,i.height=0,i=null)}catch(e){}}}async getPDFPageCount(e){let t=null;try{var a,i,r,s;return this.pageCountCache.has(e.path)?this.pageCountCache.get(e.path):(a=await this.app.vault.adapter.readBinary(e.path),(i=window["pdfjs-dist/build/pdf"])?(r=i.getDocument({data:a,disableFontFace:this.isMobile,disableAutoFetch:this.isMobile,disableStream:this.isMobile}),s=(t=await r.promise).numPages,this.pageCountCache.set(e.path,s.toString()),this.pageCountSaveTimeout||(this.pageCountSaveTimeout=setTimeout(async()=>{await this.savePageCountCache(),this.pageCountSaveTimeout=null},2e3)),s.toString()):"æœªçŸ¥")}catch(e){return"æœªçŸ¥"}finally{if(t)try{await t.cleanup(),await t.destroy()}catch(e){}}}async getFileInfo(e){try{var t,a;return this.fileInfoCache.has(e.path)?this.fileInfoCache.get(e.path):(t=await this.app.vault.adapter.stat(e.path))?(a={size:this.formatFileSize(t.size),mtime:t.mtime,ctime:t.ctime,name:e.basename,path:e.path},this.fileInfoCache.set(e.path,a),this.fileInfoSaveTimeout||(this.fileInfoSaveTimeout=setTimeout(async()=>{await this.saveFileInfoCache(),this.fileInfoSaveTimeout=null},2e3)),a):null}catch(e){return null}}async getSimplePDFProgress(t){try{var a=await this.getPDFPageCount(t),i=parseInt(a);if(isNaN(i)||i<=0)return null;let e=await this.getSimpleCurrentPage(t);(e=null===e||e<1?1:e)>i&&(e=i);var r=Math.round(e/i*100);return{currentPage:e,totalPages:i,percentage:r}}catch(e){return null}}async getSimpleCurrentPage(e){try{var t=await this.getPageFromPDFFlow(e.path);return null!==t?t:1}catch(e){return 1}}async getPageFromPDFFlow(e){try{var t=await this.app.vault.adapter.read(".obsidian/plugins/PDF Flow/data.json"),a=JSON.parse(t);if(a.lastHighlightCache){if(a.lastHighlightCache[e]){var i=a.lastHighlightCache[e];if(i.page&&"number"==typeof i.page)return i.page}var r,s,o=e.split("/").pop().trim().toLowerCase();for([r,s]of Object.entries(a.lastHighlightCache))if(r.split("/").pop().trim().toLowerCase()===o&&s.page&&"number"==typeof s.page)return s.page}return null}catch(e){return null}}async updateReadingProgress(e,t,a,i){try{var r,s=await this.getSimplePDFProgress(e),o=s?s.currentPage:1,n=prompt(`è¯·è¾“å…¥å½“å‰é˜…è¯»é¡µæ•° (1-${i}):`,o.toString());null!==n&&1<=(r=parseInt(n))&&r<=i&&(t.setAttribute("value",r.toString()),t.setAttribute("max",i.toString()),t.setAttribute("title",`é˜…è¯»è¿›åº¦: ${r}/${i} (${Math.round(r/i*100)}%)`),a.textContent=r+"/"+i)}catch(e){}}async getAuthorInfo(e){try{return this.authorCache.get(e.path)||null}catch(e){return null}}queueCoverExtraction(e,t,a){this.coverExtractionQueue.push({file:e,coverEl:t,placeholderEl:a}),this.processNextCoverExtraction()}async processNextCoverExtraction(){if(!(this.activeCoverExtractions>=this.maxConcurrentExtractions||0===this.coverExtractionQueue.length)){let t=this.coverExtractionQueue.shift();if(t){this.activeCoverExtractions++;try{var e=await this.extractPDFCover(t.file);e?(t.placeholderEl.remove(),t.coverEl.createEl("img",{cls:"pdf-cover-image",attr:{src:e,alt:t.file.basename}}).addEventListener("click",()=>{this.app.workspace.openLinkText(t.file.path,"")})):t.placeholderEl.className="pdf-default-cover"}catch(e){t.placeholderEl.className="pdf-default-cover"}finally{this.activeCoverExtractions--,this.processNextCoverExtraction()}}}}async loadAuthorInfoAsync(a,i){setTimeout(async()=>{try{var t=await this.getAuthorInfo(a);if(t){let e=i.createEl("div",{cls:"pdf-book-author",text:"ä½œè€…: "+t});e.addEventListener("click",()=>{this.editAuthorInfo(a,e)})}else{let e=i.createEl("div",{cls:"pdf-book-author-placeholder",text:"ç‚¹å‡»æ·»åŠ "});e.addEventListener("click",()=>{this.editAuthorInfo(a,e)})}}catch(e){}},0)}async loadMetaInfoAsync(a,i,r){setTimeout(async()=>{try{if("false"!==r.showPages)try{var e=await this.getPDFPageCount(a);i.createEl("span",{cls:"pdf-book-pages",text:e+" é¡µ"})}catch(e){}var t;"false"!==r.showPages&&"true"===r.showSize&&i.createEl("span",{cls:"pdf-book-separator",text:" â€¢ "}),"true"===r.showSize&&(t=await this.getFileInfo(a))&&t.size&&i.createEl("span",{cls:"pdf-book-size",text:t.size})}catch(e){}},0)}async loadProgressInfoAsync(r,s){setTimeout(async()=>{try{let a=await this.getSimplePDFProgress(r);if(a){var i=s.createEl("div",{cls:"pdf-book-progress-container",attr:{style:"display: flex; align-items: center;"}});let e=i.createEl("progress",{cls:"pdf-book-progress",attr:{value:a.currentPage,max:a.totalPages,title:`é˜…è¯»è¿›åº¦: ${a.currentPage}/${a.totalPages} (${a.percentage}%)`,style:"width: 90%; margin-right: 8px;"}}),t=i.createEl("span",{cls:"pdf-book-progress-text",text:a.percentage+"%"});i.addEventListener("click",async()=>{await this.updateReadingProgress(r,e,t,a.totalPages)})}}catch(e){}},0)}fixEncoding(e){if(!e)return null;try{let a=e;var t;(a=a.replace(/[\uFEFF\u0000-\u0008\u000B\u000C\u000E-\u001F\u007F]/g,"")).includes("\0")&&(a=a.replace(/\u0000/g,""));for(t of[{pattern:/^\uFEFF/,replacement:""},{pattern:/\u0000\s+/g,replacement:" "},{pattern:/\s*/g,replacement:""},{pattern:/\s+/g,replacement:" "},{pattern:/[\t\n\r]/g,replacement:" "}])a=a.replace(t.pattern,t.replacement);if(0<a.length&&255<a.charCodeAt(0))try{let t="";for(let e=0;e<a.length;e++){var i=a.charCodeAt(e);t+=255<i?String.fromCharCode(255&i):a.charAt(e)}0<t.trim().length&&(a=t)}catch(e){}return 0===(a=a.trim()).length?null:.3<(a.match(/[^\x20-\x7E\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]/g)||[]).length/a.length?null:a}catch(e){return null}}cleanAuthorInfo(e){if(!e)return null;var t=e.trim();if(0===t.length||t.length<2)return null;if(/[^\x20-\x7E\u4e00-\u9fff\u3040-\u309f\u30a0-\u30ff]{3,}/.test(t))return null;var a,e=(t.match(/[\x00-\x1F\x7F-\x9F]/g)||[]).length,i=t.length;if(0<e&&.1<e/i)return null;for(a of["Adobe PDF Library","Adobe Acrobat","Microsoft Word","LibreOffice","OpenOffice","PDF Creator","PDF24","Unknown","N/A","NA","None","Anonymous","ä½šå","æœªçŸ¥","æ— ","æœªæŒ‡å®š","PDF-XChange","Foxit","Nitro","PDFsam","PDFtk","Ghostscript","Prince","WeasyPrint","wkhtmltopdf","Chromium","Chrome","Safari","Firefox","Edge","Internet Explorer","Skia/PDF","Webkit","LaTeX","XeLaTeX","pdfTeX","Microsoft Print to PDF","CutePDF","PDFCreator","doPDF","Bullzip PDF Printer"])if(t.toLowerCase()===a.toLowerCase())return null;var r;for(r of[/^Skia\/PDF/i,/^Microsoft.*Print/i,/^Adobe.*PDF/i,/PDF.*Writer/i,/PDF.*Creator/i,/PDF.*Printer/i,/^[A-Z]+PDF/i,/PDF[A-Z]+$/i,/^\d+\.\d+/i,/^v\d+/i])if(r.test(t))return null;return 50<t.length||t.includes("\\")||t.includes("\\\\")||/^[\d\W]+$/.test(t)||t.includes("http")||t.includes("www.")||t.includes("://")||t.includes("\\")||t.includes("/")||/^(.)\1{3,}$/.test(t)?null:t}getAuthorExtractionMethods(){return{method1_5:"getMetadata()",method9:"Filename inference"}}extractAuthorFromFilename(e){try{var t;for(t of[/^([^-_]+)[-_]/,/^([^ï¼š:]+)[ï¼š:]/,/^([^\s]+)\s/,/[-_]([^-_]+)$/,/[ï¼š:]([^ï¼š:]+)$/]){var a=e.match(t);if(a&&a[1]){var i=a[1].trim();if(1<i.length&&i.length<20&&!i.match(/^\d+$/)&&!i.match(/^[A-Z]{2,}$/)&&!i.match(/^(ç¬¬|ç¬¬\d+ç« |Chapter|Part|Section)/)&&!i.match(/^(PDF|DOC|TXT|EPUB|MOBI)$/i))return i}}return null}catch(e){return null}}async editAuthorInfo(t,e){var a=this.authorCache.get(t.path)||"";new AuthorEditModal(this.app,a,async e=>{null!==e&&(this.authorCache.set(t.path,e),await this.saveAuthorCache(),this.updateAllAuthorDisplays(t.path,e),e.trim())}).open()}async editAuthorInfoInTable(t,a){var e;t&&(e=this.authorCache.get(t)||"",new AuthorEditModal(this.app,e,async e=>{null!==e&&(e&&e.trim()?this.authorCache.set(t,e.trim()):this.authorCache.set(t,""),await this.saveAuthorCache(),this.updateAuthorDisplay(a,e),this.updateAllAuthorDisplays(t,e))}).open())}async editCategoryName(s,o,n){new CategoryNameEditModal(this.app,s,async e=>{if(null!==e&&e.trim()!==s){var t,a,i=e.trim()||"é»˜è®¤åˆ†ç±»",r=[];for([t,a]of this.categoryCache.entries())a===s&&(this.categoryCache.set(t,i),r.push(t));await this.saveCategoryCache(),this.updateCategoryOrderCache(s,i),o.textContent=i,n.setAttribute("data-category",i),this.updateCategoryFilterButtons(s,i)}}).open()}updateCategoryOrderCache(a,i){try{var e,t=localStorage.getItem(this.categoryOrderCacheKey);t&&(e=JSON.parse(t).map(([e,t])=>e===a?[i,t]:[e,t]),this.categoryOrderCache=new Map(e),localStorage.setItem(this.categoryOrderCacheKey,JSON.stringify(e)))}catch(e){}}updateCategoryFilterButtons(t,a){document.querySelectorAll(".pdf-category-filter-btn").forEach(e=>{e.getAttribute("data-category")===t&&(e.textContent=a,e.setAttribute("data-category",a))})}updateAllAuthorDisplays(a,i){var e=document.querySelector(".pdf-ebookshelf-container");e&&(e.querySelectorAll(".pdf-book-author, .pdf-book-author-placeholder").forEach(e=>{var t=e.closest(".pdf-book-card");t&&((t=this.getFilePathFromCard(t))===a||this.isSameFile(t,a))&&this.updateAuthorDisplay(e,i)}),e.querySelectorAll(".pdf-table-row").forEach(e=>{var t=e.querySelector(".pdf-table-title");t&&(t=t.textContent.trim(),(t=this.findFilePathByTitle(t))===a||this.isSameFile(t,a))&&(t=e.querySelector(".pdf-table-author"))&&this.updateAuthorDisplay(t,i)}))}updateAuthorDisplay(e,t){var a;t&&t.trim()?(a=null!==e.closest(".pdf-books-table"),e.textContent=a?t.trim():"ä½œè€…: "+t.trim(),e.className="pdf-book-author",e.style.color="",e.style.fontStyle=""):(e.textContent="ç‚¹å‡»æ·»åŠ ",e.className="pdf-book-author-placeholder",e.style.color="#999",e.style.fontStyle="italic")}async editCategory(t,e,a){var i=this.categoryCache.get(t.path)||"é»˜è®¤åˆ†ç±»",r=Array.from(new Set(Array.from(this.categoryCache.values()))).filter(e=>e&&e.trim());new CategoryEditModal(this.app,i,r,async e=>{null!==e&&(e=e.trim()||"é»˜è®¤åˆ†ç±»",this.categoryCache.set(t.path,e),await this.saveCategoryCache(),await this.refreshEbookshelf(a))}).open()}setupViewModeToggle(e,a){let i=e.querySelectorAll(".pdf-view-mode-btn");i.forEach(t=>{t.addEventListener("click",async()=>{i.forEach(e=>e.classList.remove("pdf-view-mode-active")),t.classList.add("pdf-view-mode-active");var e=t.getAttribute("data-view-mode");this.viewModeCache=e,await this.saveViewModeCache(),"card"===e?this.switchToCardView(a):"table"===e&&this.switchToTableView(a)})})}applyViewMode(e){"table"===this.viewModeCache?this.switchToTableView(e):this.switchToCardView(e)}switchToCardView(e){e.classList.remove("pdf-table-view"),e.classList.add("pdf-card-view"),e.querySelectorAll(".pdf-ebookshelf-grid").forEach(e=>{e.style.display="grid"}),e.querySelectorAll(".pdf-table-container").forEach(e=>{e.style.display="none"})}async switchToTableView(e){e.classList.remove("pdf-card-view"),e.classList.add("pdf-table-view");e.querySelectorAll(".pdf-ebookshelf-grid").forEach(e=>{e.style.display="none"});var t,e=e.querySelectorAll(".pdf-category-container");for(t of e)await this.createOrUpdateTableView(t)}async createOrUpdateTableView(t){t.getAttribute("data-category");let a=t.querySelector(".pdf-table-container");if(!a){var r=(a=t.createEl("div",{cls:"pdf-table-container"})).createEl("table",{cls:"pdf-books-table"});let i=r.createEl("thead").createEl("tr");[{text:"  ä¹¦å",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tag-icon lucide-tag"><path d="M12.586 2.586A2 2 0 0 0 11.172 2H4a2 2 0 0 0-2 2v7.172a2 2 0 0 0 .586 1.414l8.704 8.704a2.426 2.426 0 0 0 3.42 0l6.58-6.58a2.426 2.426 0 0 0 0-3.42z"/><circle cx="7.5" cy="7.5" r=".5" fill="currentColor"/></svg>'},{text:"  ä½œè€…",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-users-round-icon lucide-users-round"><path d="M18 21a8 8 0 0 0-16 0"/><circle cx="10" cy="8" r="5"/><path d="M22 20c0-3.37-2-6.5-4-8a5 5 0 0 0-.45-8.3"/></svg>'},{text:"  è¯„ä»·",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-star-icon lucide-star"><path d="M11.525 2.295a.53.53 0 0 1 .95 0l2.31 4.679a2.123 2.123 0 0 0 1.595 1.16l5.166.756a.53.53 0 0 1 .294.904l-3.736 3.638a2.123 2.123 0 0 0-.611 1.878l.882 5.14a.53.53 0 0 1-.771.56l-4.618-2.428a2.122 2.122 0 0 0-1.973 0L6.396 21.01a.53.53 0 0 1-.77-.56l.881-5.139a2.122 2.122 0 0 0-.611-1.879L2.16 9.795a.53.53 0 0 1 .294-.906l5.165-.755a2.122 2.122 0 0 0 1.597-1.16z"/></svg>'},{text:"  è¿›åº¦",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-percent-icon lucide-percent"><line x1="19" x2="5" y1="5" y2="19"/><circle cx="6.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="17.5" r="2.5"/></svg>'},{text:"  é¡µæ•°",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-digit-icon lucide-file-digit"><path d="M4 22h14a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v4"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><rect width="4" height="6" x="2" y="12" rx="2"/><path d="M10 12h2v6"/><path d="M10 18h4"/></svg>'},{text:"  å¤§å°",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-save-icon lucide-save"><path d="M15.2 3a2 2 0 0 1 1.4.6l3.8 3.8a2 2 0 0 1 .6 1.4V19a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1-2-2z"/><path d="M17 21v-7a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v7"/><path d="M7 3v4a1 1 0 0 0 1 1h7"/></svg>'},{text:"  æ ‡ç­¾",icon:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tags-icon lucide-tags"><path d="M13.172 2a2 2 0 0 1 1.414.586l6.71 6.71a2.4 2.4 0 0 1 0 3.408l-4.592 4.592a2.4 2.4 0 0 1-3.408 0l-6.71-6.71A2 2 0 0 1 6 9.172V3a1 1 0 0 1 1-1z"/><path d="M2 7v6.172a2 2 0 0 0 .586 1.414l6.71 6.71a2.4 2.4 0 0 0 3.191.193"/><circle cx="10.5" cy="6.5" r=".5" fill="currentColor"/></svg>'}].forEach(e=>{var t=i.createEl("th"),a=e.icon.replace("<svg",'<svg style="vertical-align: baseline; transform: translateY(3px);"');t.innerHTML=`<span class="pdf-table-header-icon">${a}</span><span class="pdf-table-header-text">${e.text}</span>`});var s,o=r.createEl("tbody");let e=t.querySelector(".pdf-ebookshelf-grid");for(s of e?e.querySelectorAll(".pdf-book-card"):[])await this.createTableRow(o,s,t)}a.style.display="block";let e=t.querySelector(".pdf-ebookshelf-grid");e&&(e.style.display="none")}async createTableRow(e,a,t){let r=e.createEl("tr",{cls:"pdf-table-row"});var e=a.querySelector(".pdf-book-title"),i=(a.querySelector(".pdf-book-author, .pdf-book-author-placeholder"),a.querySelector(".pdf-book-progress")),s=a.querySelector(".pdf-book-progress-text"),o=a.querySelector(".pdf-book-meta"),e=e?e.textContent.trim():"æœªçŸ¥ä¹¦å";let n=this.getFilePathFromCard(a);var l=this.authorCache.get(n),l=l&&l.trim()?l.trim():"ç‚¹å‡»æ·»åŠ ";let c=this.getCustomTags(n);var h=0<c.length?c.join(", "):"æœªè®¾å®š";let d=this.ratingsCache.get(n)||0;var p,u=0<d?this.generateStarDisplay(d,!0):"ç‚¹å‡»è¯„ä»·";let g="æœªçŸ¥",v="æœªçŸ¥",f=(o&&(p=(o=o.textContent).match(/(\d+)\s*é¡µ/),o=o.match(/(\d+(?:\.\d+)?)\s*(B|KB|MB|GB)/),p&&(g=p[1]+" é¡µ"),o)&&(v=o[1]+" "+o[2]),"0%");s?f=s.textContent.trim():i&&(p=i.getAttribute("value")||"0",o=i.getAttribute("max")||"100",s=Math.round(parseFloat(p)/parseFloat(o)*100),f=s+"%"),[{text:e,cls:"pdf-table-title"},{text:l,cls:"pdf-table-author"},{text:u,cls:"pdf-table-rating",isRating:!0},{text:f,cls:"pdf-table-progress"},{text:g,cls:"pdf-table-pages"},{text:v,cls:"pdf-table-size"},{text:h,cls:"pdf-table-category"}].forEach((e,t)=>{let i=r.createEl("td",{cls:e.cls});e.isRating?0<d?i.innerHTML=e.text:(i.textContent=e.text,i.style.color="#999",i.style.fontStyle="italic"):i.textContent=e.text,0===t&&(i.style.cursor="pointer",i.style.color="var(--interactive-accent)",i.addEventListener("click",()=>{var e=a.querySelector(".pdf-book-title");e&&e.click()})),1===t&&(i.style.cursor="pointer","ç‚¹å‡»æ·»åŠ "===e.text&&(i.style.color="#999",i.style.fontStyle="italic"),i.addEventListener("click",()=>{this.editAuthorInfoInTable(n,i)})),2===t&&(i.style.cursor="pointer","ç‚¹å‡»è¯„ä»·"===e.text&&(i.style.color="#999",i.style.fontStyle="italic"),i.addEventListener("click",()=>{this.showRatingSelector(n,i)})),6===t&&(i.style.cursor="pointer",0<c.length?(i.innerHTML="",c.forEach((e,t)=>{var a=i.createEl("span",{text:e,cls:"pdf-custom-tag"}),e=this.generateTagColor(e);a.style.backgroundColor=e,a.style.color=this.getContrastColor(e),a.style.padding="3px 8px",a.style.borderRadius="10px",a.style.fontSize="10px",a.style.marginRight="4px",a.style.display="inline-block",a.style.marginBottom="2px"})):(i.style.color="#999",i.style.fontStyle="italic"),i.addEventListener("click",()=>{this.editCustomTags(n,i)}))}),r.addEventListener("mouseenter",()=>{r.style.backgroundColor="var(--background-modifier-hover)"}),r.addEventListener("mouseleave",()=>{r.style.backgroundColor=""})}setupCategoryFilters(e,t){let a=e.querySelectorAll(".pdf-category-filter-btn"),i=t.querySelectorAll(".pdf-category-container");a.forEach(e=>{e.addEventListener("click",()=>{a.forEach(e=>e.classList.remove("pdf-category-filter-active")),e.classList.add("pdf-category-filter-active");let t=e.getAttribute("data-category");t?i.forEach(e=>{e.getAttribute("data-category")===t?e.style.display="block":e.style.display="none"}):i.forEach(e=>{e.style.display="block"})})})}generateCategoryColor(t){let a=0;for(let e=0;e<t.length;e++){var i=t.charCodeAt(e);a=(a<<5)-a+i,a&=a}return`hsl(${Math.abs(a)%360}, ${65+Math.abs(a)%20}%, ${45+Math.abs(a)%15}%)`}getContrastColor(e){e=e.match(/hsl\((\d+),\s*(\d+)%,\s*(\d+)%\)/);if(!e)return"#ffffff";var t=parseInt(e[1])/360,a=parseInt(e[2])/100,e=parseInt(e[3])/100,i=(e,t,a)=>(a<0&&(a+=1),1<a&&--a,a<1/6?e+6*(t-e)*a:a<.5?t:a<2/3?e+(t-e)*(2/3-a)*6:e);let r,s,o;return 0==a?r=s=o=e:(a=2*e-(e=e<.5?e*(1+a):e+a-e*a),r=i(a,e,t+1/3),s=i(a,e,t),o=i(a,e,t-1/3)),.5<.299*r+.587*s+.114*o?"#000000":"#ffffff"}moveCategoryUp(e,t){var a=Array.from(t.querySelectorAll(".pdf-category-container")),i=a.indexOf(e);0<i&&(a=a[i-1],t.insertBefore(e,a),this.addMoveAnimation(e,"up"),this.saveCategoryOrder(t))}moveCategoryDown(e,t){var a=Array.from(t.querySelectorAll(".pdf-category-container")),i=a.indexOf(e);i<a.length-1&&((a=a[i+1]).nextSibling?t.insertBefore(e,a.nextSibling):t.appendChild(e),this.addMoveAnimation(e,"down"),this.saveCategoryOrder(t))}saveCategoryOrder(e){try{var a=Array.from(e.querySelectorAll(".pdf-category-container")).map((e,t)=>({category:e.getAttribute("data-category"),order:t}));let t=new Map;a.forEach(e=>{t.set(e.category,e.order)}),this.categoryOrderCache=t,this.saveCategoryOrderCache();localStorage.getItem(this.categoryOrderCacheKey)}catch(e){}}getCategoryOrder(e){e=this.categoryOrderCache.get(e);return void 0!==e?e:999}applyCategoryOrder(e){return e.sort((e,t)=>{var a=this.getCategoryOrder(e),i=this.getCategoryOrder(t);return 999===a&&999===i?"é»˜è®¤åˆ†ç±»"===e?1:"é»˜è®¤åˆ†ç±»"===t?-1:e.localeCompare(t,"zh-CN"):a-i})}addMoveAnimation(e,t){e.classList.add("pdf-category-moving"),"up"===t?e.classList.add("pdf-category-move-up-animation"):e.classList.add("pdf-category-move-down-animation"),setTimeout(()=>{e.classList.remove("pdf-category-moving","pdf-category-move-up-animation","pdf-category-move-down-animation")},300)}setupDynamicCategoryTitleHover(e){e.querySelectorAll(".pdf-category-title").forEach(a=>{let i=!1;a.addEventListener("mouseenter",()=>{i=!0}),a.addEventListener("mousemove",e=>{var t;i&&(t=a.getBoundingClientRect(),e=e.clientX-t.left,t=Math.min(.8*t.width,20+e),e=Math.max(30,t),a.style.setProperty("--dynamic-width",e+"px"))}),a.addEventListener("mouseleave",()=>{i=!1,a.style.setProperty("--dynamic-width","30px")})})}async refreshEbookshelf(t){try{var e=t.getAttribute("data-original-params");let s={};if(e)try{s=JSON.parse(e)}catch(e){s={}}else s={};var a=t.querySelector(".pdf-category-filter-active"),o=a?a.getAttribute("data-category"):null,i=t.createEl("div",{text:"æ­£åœ¨åˆ·æ–°...",cls:"pdf-ebookshelf-loading"}),n=(await new Promise(e=>setTimeout(e,100)),await this.getPDFFiles("Books/pdfä¹¦ç±"));if(i.remove(),0===n.length)t.empty(),t.addClass("pdf-ebookshelf-container"),t.createEl("div",{text:"æœªæ‰¾åˆ°PDFæ–‡ä»¶",cls:"pdf-ebookshelf-empty"});else{t.empty(),t.addClass("pdf-ebookshelf-container"),t.setAttribute("data-original-params",JSON.stringify(s));var l,c=this.categorizeFiles(n),h=t.createEl("div",{cls:"pdf-view-mode-container"}),d=(h.createEl("button",{text:"å¡ç‰‡è§†å›¾",cls:"pdf-view-mode-btn"+("card"===this.viewModeCache?" pdf-view-mode-active":""),attr:{"data-view-mode":"card"}}),h.createEl("button",{text:"è¡¨æ ¼è§†å›¾",cls:"pdf-view-mode-btn"+("table"===this.viewModeCache?" pdf-view-mode-active":""),attr:{"data-view-mode":"table"}}),t.createEl("div",{cls:"pdf-category-filters"}));d.createEl("button",{text:"å…¨éƒ¨åˆ†ç±»",cls:"pdf-category-filter-btn"+(o?"":" pdf-category-filter-active")});for([l]of c){var p=d.createEl("button",{text:l,cls:"pdf-category-filter-btn"+(o===l?" pdf-category-filter-active":"")}),u=(p.setAttribute("data-category",l),this.generateCategoryColor(l));p.style.backgroundColor=u,p.style.color=this.getContrastColor(u)}let r=t.createEl("div",{cls:"pdf-ebookshelf-main-content"});for(let[i,e]of c){let t=r.createEl("div",{cls:"pdf-category-container",attr:{"data-category":i}});o&&o!==i&&(t.style.display="none");var g=t.createEl("div",{cls:"pdf-category-title-container"}),v=g.createEl("div",{cls:"pdf-category-move-buttons"}),f=v.createEl("button",{cls:"pdf-category-move-btn pdf-category-move-up",title:"å‘ä¸Šç§»åŠ¨åˆ†ç±»"}),y=(f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 15-6-6-6 6"/></svg>',v.createEl("button",{cls:"pdf-category-move-btn pdf-category-move-down",title:"å‘ä¸‹ç§»åŠ¨åˆ†ç±»"})),m=(y.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>',g.createEl("h6",{cls:"pdf-category-title"})),C=(f.addEventListener("click",e=>{e.stopPropagation(),this.moveCategoryUp(t,r)}),y.addEventListener("click",e=>{e.stopPropagation(),this.moveCategoryDown(t,r)}),await this.calculateCategoryStats(e));let a=m.createEl("span",{text:i,cls:"pdf-category-title-text"});a.style.cursor="pointer",a.title="ç‚¹å‡»ç¼–è¾‘åˆ†ç±»åç§°",a.addEventListener("click",e=>{e.stopPropagation(),this.editCategoryName(i,a,t)});var b,w,x=m.createEl("span",{text:`ï¼ˆå…¨éƒ¨${e.length}æœ¬`,cls:"pdf-category-stats"}),k=(0<C.totalProgress&&(x.textContent+=`ï¼Œé˜…è¯»è¿›åº¦${C.averageProgress}%`),x.textContent+="ï¼‰",t.createEl("div",{cls:"pdf-ebookshelf-grid"}));s.column&&(b=parseInt(s.column),!isNaN(b))&&0<b&&(k.style.gridTemplateColumns=`repeat(${b}, 1fr)`,k.style.gap=b<=2?"30px":b<=3?"25px":b<=4?"20px":b<=5?"18px":b<=6?"15px":b<=7?"12px":"10px",4<b)&&k.addClass("pdf-ebookshelf-columns-"+b);for(w of e)await this.createBookCard(k,w,s)}this.setupViewModeToggle(h,r),this.setupCategoryFilters(d,r),this.setupDynamicCategoryTitleHover(r),setTimeout(()=>{this.applyViewMode(r)},100)}}catch(e){t.empty(),t.addClass("pdf-ebookshelf-container"),t.createEl("div",{text:"åˆ·æ–°å¤±è´¥: "+e.message,cls:"pdf-ebookshelf-error"})}}async collectPDFInfo(e){var t={title:e.basename,path:e.path,category:this.categoryCache.get(e.path)||"é»˜è®¤åˆ†ç±»",author:null,pages:null,size:null,progress:null,coverDataUrl:null};try{t.author=await this.getAuthorInfo(e);var a=await this.getPDFPageCount(e),i=(t.pages=a,await this.getFileInfo(e)),r=(t.size=i?i.size:null,await this.getSimplePDFProgress(e));t.progress=r,t.coverDataUrl=await this.extractPDFCover(e)}catch(e){}return t}formatFileSize(e){var t;return 0===e?"0 B":(t=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["B","KB","MB","GB"][t])}performSecurityCheck(){try{var e=this.app.plugins.plugins["obsidian-content-protection"];return e?!!this.app.plugins.enabledPlugins.has("obsidian-content-protection")&&!!e.settings&&!0===e.settings.isActivated&&e.settings.deviceId&&0<e.settings.deviceId.trim().length&&!0===e.settings.hasBeenActivated:!1}catch(e){return!1}}getFilePathFromCard(e){var t=e.getAttribute("data-file-path");return t||((t=e.querySelector(".pdf-book-title"))?(e=t.textContent.trim(),this.findFilePathByTitle(e)):null)}findFilePathByTitle(e){for(var[t,a]of this.fileInfoCache.entries())if(a&&a.name===e)return t;for(var i of this.authorCache.keys())if(i.split("/").pop().replace(".pdf","")===e)return i;for(var r of this.categoryCache.keys())if(r.split("/").pop().replace(".pdf","")===e)return r;for(var s of this.ratingsCache.keys())if(s.split("/").pop().replace(".pdf","")===e)return s;return`Books/pdfä¹¦ç±/${e}.pdf`}isSameFile(e,t){var a;return!(!e||!t||e!==t&&(a=e=>e.split("/").pop().replace(".pdf",""))(e)!==a(t))}updateAllRatingDisplays(a,i){var e=document.querySelector(".pdf-ebookshelf-container");e&&(e.querySelectorAll(".pdf-book-card").forEach(e=>{e=this.getFilePathFromCard(e);e!==a&&this.isSameFile(e,a)}),e.querySelectorAll(".pdf-table-row").forEach(e=>{var t=e.querySelector(".pdf-table-title");t&&(t=t.textContent.trim(),(t=this.findFilePathByTitle(t))===a||this.isSameFile(t,a))&&(t=e.querySelector(".pdf-table-rating"))&&(0<i?(t.innerHTML=this.generateStarDisplay(i,!0),t.style.color="",t.style.fontStyle=""):(t.textContent="ç‚¹å‡»è¯„ä»·",t.style.color="#999",t.style.fontStyle="italic"))}))}getCustomTags(e){if(!e)return[];try{return this.customTagsCache.get(e)||[]}catch(e){return[]}}async setCustomTags(e,t){if(e)try{t&&0<t.length?this.customTagsCache.set(e,t):this.customTagsCache.delete(e),await this.saveCustomTagsCache()}catch(e){}}generateTagColor(t){let a=0;for(let e=0;e<t.length;e++){var i=t.charCodeAt(e);a=(a<<5)-a+i,a&=a}return`hsl(${Math.abs(a)%360}, ${55+Math.abs(a)%25}%, ${40+Math.abs(a)%20}%)`}async editCustomTags(t,a){var e;t&&(e=this.getCustomTags(t).join(", "),new CustomTagsEditModal(this.app,e,async e=>{null!==e&&(e=e.split(/[,ï¼Œ]/).map(e=>e.trim()).filter(e=>0<e.length),await this.setCustomTags(t,e),this.updateTagsDisplay(a,e))}).open())}updateTagsDisplay(i,e){i.innerHTML="",0<e.length?(e.forEach((e,t)=>{var a=i.createEl("span",{text:e,cls:"pdf-custom-tag"}),e=this.generateTagColor(e);a.style.backgroundColor=e,a.style.color=this.getContrastColor(e),a.style.padding="3px 8px",a.style.borderRadius="10px",a.style.fontSize="10px",a.style.marginRight="4px",a.style.display="inline-block",a.style.marginBottom="2px"}),i.style.color="",i.style.fontStyle=""):(i.textContent="æœªè®¾å®š",i.style.color="#999",i.style.fontStyle="italic")}generateStarDisplay(e,t=!1){var a=Math.floor(e),i=10-a;let r="";if(t){r+='<div class="star-row">';for(let e=0;e<5;e++)e<a?r+='<span class="star filled">â˜…</span>':r+='<span class="star empty">â˜†</span>';r=r+"</div>"+'<div class="star-row">';for(let e=5;e<10;e++)e<a?r+='<span class="star filled">â˜…</span>':r+='<span class="star empty">â˜†</span>';r+="</div>"}else{for(let e=0;e<a;e++)r+='<span class="star filled">â˜…</span>';for(let e=0;e<i;e++)r+='<span class="star empty">â˜†</span>'}return r}showRatingSelector(o,n){if(o){let a=document.createElement("div");a.className="pdf-rating-selector-container",a.style.cssText=`
            position: absolute;
            z-index: 1000;
            background: var(--background-primary);
            border: 1px solid var(--background-modifier-border);
            border-radius: 6px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 4px;
            min-width: 200px;
        `,a.createEl("div",{text:"é€‰æ‹©è¯„ä»·æ˜Ÿçº§ï¼š",cls:"pdf-rating-selector-title"}).style.cssText=`
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 4px;
            font-weight: 500;
        `;let i=a.createEl("div",{cls:"pdf-rating-buttons-container"});i.style.cssText=`
            display: flex;
            flex-direction: column;
            gap: 2px;
        `;let r=this.ratingsCache.get(o)||0,e=([{value:1,text:"â˜…â˜†â˜†â˜†â˜†â˜†â˜†â˜†â˜†â˜†",label:"1æ˜Ÿ"},{value:2,text:"â˜…â˜…â˜†â˜†â˜†â˜†â˜†â˜†â˜†â˜†",label:"2æ˜Ÿ"},{value:3,text:"â˜…â˜…â˜…â˜†â˜†â˜†â˜†â˜†â˜†â˜†",label:"3æ˜Ÿ"},{value:4,text:"â˜…â˜…â˜…â˜…â˜†â˜†â˜†â˜†â˜†â˜†",label:"4æ˜Ÿ"},{value:5,text:"â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜†â˜†â˜†",label:"5æ˜Ÿ"},{value:6,text:"â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜†â˜†",label:"6æ˜Ÿ"},{value:7,text:"â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†â˜†",label:"7æ˜Ÿ"},{value:8,text:"â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†â˜†",label:"8æ˜Ÿ"},{value:9,text:"â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜†",label:"9æ˜Ÿ"},{value:10,text:"â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…",label:"10æ˜Ÿ"}].forEach(e=>{let t=i.createEl("button",{cls:"pdf-rating-option-btn"});t.innerHTML=`
                <span class="star-display">${e.text}</span>
                <span class="star-label">(${e.label})</span>
            `,t.style.cssText=`
                display: flex;
                align-items: center;
                justify-content: space-between;
                padding: 6px 8px;
                border: none;
                background: ${r===e.value?"var(--interactive-accent)":"transparent"};
                color: ${r===e.value?"var(--text-on-accent)":"var(--text-normal)"};
                cursor: pointer;
                border-radius: 3px;
                font-size: 12px;
                transition: background-color 0.2s;
            `,t.addEventListener("mouseenter",()=>{r!==e.value&&(t.style.background="var(--background-modifier-hover)")}),t.addEventListener("mouseleave",()=>{r!==e.value&&(t.style.background="transparent")}),t.addEventListener("click",()=>{this.handleRatingSelection(o,n,e.value,a)})}),i.createEl("button",{text:"æ— è¯„ä»·",cls:"pdf-rating-option-btn pdf-no-rating-btn"}));e.style.cssText=`
            padding: 6px 8px;
            border: none;
            background: ${0===r?"var(--interactive-accent)":"transparent"};
            color: ${0===r?"var(--text-on-accent)":"var(--text-muted)"};
            cursor: pointer;
            border-radius: 3px;
            font-size: 12px;
            margin-top: 4px;
            border-top: 1px solid var(--background-modifier-border);
            transition: background-color 0.2s;
        `,e.addEventListener("mouseenter",()=>{0!==r&&(e.style.background="var(--background-modifier-hover)")}),e.addEventListener("mouseleave",()=>{0!==r&&(e.style.background="transparent")}),e.addEventListener("click",()=>{this.handleRatingSelection(o,n,0,a)});var l=n.getBoundingClientRect();a.style.left=l.left+"px",a.style.top=l.bottom+2+"px",document.body.appendChild(a);let t=e=>{a.contains(e.target)||(a.parentNode&&document.body.removeChild(a),document.removeEventListener("click",t))},s=(setTimeout(()=>{document.addEventListener("click",t)},100),e=>{"Escape"===e.key&&(a.parentNode&&document.body.removeChild(a),document.removeEventListener("keydown",s),document.removeEventListener("click",t))});document.addEventListener("keydown",s)}}handleRatingSelection(e,t,a,i){0<a?this.ratingsCache.set(e,a):this.ratingsCache.delete(e),this.saveRatingsCache();var r=null!==t.closest(".pdf-books-table");0<a?(t.innerHTML=this.generateStarDisplay(a,r),t.style.color="",t.style.fontStyle=""):(t.textContent="ç‚¹å‡»è¯„ä»·",t.style.color="#999",t.style.fontStyle="italic"),this.updateAllRatingDisplays(e,a),i.parentNode&&document.body.removeChild(i)}}class AuthorEditModal extends require("obsidian").Modal{constructor(e,t,a){super(e),this.currentAuthor=t,this.onSave=a}onOpen(){var e=this.contentEl;e.createEl("h2",{text:"ç¼–è¾‘ä½œè€…ä¿¡æ¯"});let t=e.createEl("input",{type:"text",value:this.currentAuthor,placeholder:"è¯·è¾“å…¥ä½œè€…å§“å"});t.focus(),t.select();var e=e.createEl("div",{cls:"modal-button-container"}),a=e.createEl("button",{text:"ä¿å­˜"}),e=e.createEl("button",{text:"å–æ¶ˆ"});a.addEventListener("click",()=>{this.onSave(t.value),this.close()}),e.addEventListener("click",()=>{this.onSave(null),this.close()}),t.addEventListener("keydown",e=>{"Enter"===e.key?(this.onSave(t.value),this.close()):"Escape"===e.key&&(this.onSave(null),this.close())})}onClose(){var e=this.contentEl;e.empty()}}class CategoryEditModal extends require("obsidian").Modal{constructor(e,t,a,i){super(e),this.currentCategory=t,this.existingCategories=a||[],this.onSave=i}onOpen(){var e=this.contentEl;e.createEl("h2",{text:"è®¾ç½®PDFåˆ†ç±»"});let a=e.createEl("input",{type:"text",value:"é»˜è®¤åˆ†ç±»"===this.currentCategory?"":this.currentCategory,placeholder:"è¯·è¾“å…¥åˆ†ç±»åç§°ï¼ˆç•™ç©ºä¸ºé»˜è®¤åˆ†ç±»ï¼‰"});if(a.focus(),"é»˜è®¤åˆ†ç±»"!==this.currentCategory&&a.select(),0<this.existingCategories.length){var i=e.createEl("div",{cls:"category-suggestions"});i.createEl("p",{text:"ç°æœ‰åˆ†ç±»ï¼š"});let t=i.createEl("div",{cls:"category-suggestions-list"});this.existingCategories.forEach(e=>{t.createEl("button",{text:e,cls:"category-suggestion-btn"}).addEventListener("click",()=>{a.value=e,a.focus()})})}i=e.createEl("div",{cls:"modal-button-container"}),e=i.createEl("button",{text:"ä¿å­˜"}),i=i.createEl("button",{text:"å–æ¶ˆ"});e.addEventListener("click",()=>{this.onSave(a.value),this.close()}),i.addEventListener("click",()=>{this.onSave(null),this.close()}),a.addEventListener("keydown",e=>{"Enter"===e.key?(this.onSave(a.value),this.close()):"Escape"===e.key&&(this.onSave(null),this.close())})}onClose(){var e=this.contentEl;e.empty()}}class CustomTagsEditModal extends require("obsidian").Modal{constructor(e,t,a){super(e),this.currentTags=t,this.onSave=a}onOpen(){var e=this.contentEl;e.createEl("h2",{text:"è®¾ç½®è‡ªå®šä¹‰æ ‡ç­¾"});let t=e.createEl("input",{type:"text",value:this.currentTags,placeholder:"è¯·è¾“å…¥æ ‡ç­¾ï¼Œç”¨é€—å·åˆ†éš”ï¼ˆå¦‚ï¼šæŠ€æœ¯,ç¼–ç¨‹,JavaScriptï¼‰"});t.style.width="400px",t.focus(),this.currentTags&&t.select();var a=e.createEl("p",{text:"æç¤ºï¼šå¤šä¸ªæ ‡ç­¾ç”¨é€—å·åˆ†éš”ï¼Œç•™ç©ºè¡¨ç¤ºæ— æ ‡ç­¾",cls:"custom-tags-desc"}),a=(a.style.fontSize="12px",a.style.color="#999",a.style.marginTop="8px",e.createEl("div",{cls:"modal-button-container"})),e=a.createEl("button",{text:"ä¿å­˜"}),a=a.createEl("button",{text:"å–æ¶ˆ"});e.addEventListener("click",()=>{this.onSave(t.value),this.close()}),a.addEventListener("click",()=>{this.onSave(null),this.close()}),t.addEventListener("keydown",e=>{"Enter"===e.key?(this.onSave(t.value),this.close()):"Escape"===e.key&&(this.onSave(null),this.close())})}onClose(){var e=this.contentEl;e.empty()}}class PDFEbookshelfSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var e=this.containerEl;e.empty(),new Setting(e).setName("PDFå°é¢å›¾ç‰‡è´¨é‡").setDesc("é€‰æ‹©PDFå°é¢çš„å›¾ç‰‡è´¨é‡ã€‚æ›´é«˜çš„è´¨é‡ä¼šå ç”¨æ›´å¤šç¼“å­˜ç©ºé—´ï¼Œä½†å›¾ç‰‡æ›´æ¸…æ™°ã€‚").addDropdown(e=>e.addOptions({low:"ä½è´¨é‡ (èŠ‚çœç©ºé—´)",medium:"ä¸­ç­‰è´¨é‡ (æ¨è)",high:"é«˜è´¨é‡ (æ¸…æ™°)",ultra:"è¶…é«˜è´¨é‡ (æœ€æ¸…æ™°)"}).setValue(this.plugin.settings.imageQuality).onChange(async e=>{this.plugin.settings.imageQuality=e,await this.plugin.saveSettings(),this.plugin.cleanupCachesOnSettingsChange()})),e.createEl("h3",{text:"ç¼“å­˜ç®¡ç†"}),new Setting(e).setName("æ¸…ç†æ‰€æœ‰ç¼“å­˜").setDesc("æ¸…ç†æ‰€æœ‰PDFå°é¢ç¼“å­˜ï¼Œä¸‹æ¬¡åŠ è½½æ—¶ä¼šé‡æ–°ç”Ÿæˆã€‚").addButton(e=>e.setButtonText("æ¸…ç†ç¼“å­˜").setCta().onClick(async()=>{try{this.plugin.coverCache.clear(),["pdf-ebookshelf-covers","pdf-ebookshelf-covers-v1","pdf-ebookshelf-covers-v2","pdf-ebookshelf-covers-v3-low","pdf-ebookshelf-covers-v3-medium","pdf-ebookshelf-covers-v3-high","pdf-ebookshelf-covers-v3-ultra"].forEach(e=>{localStorage.getItem(e)&&localStorage.removeItem(e)})}catch(e){}})),this.displayCacheInfo(e)}getQualityName(e){return{low:"ä½è´¨é‡",medium:"ä¸­ç­‰è´¨é‡",high:"é«˜è´¨é‡",ultra:"è¶…é«˜è´¨é‡"}[e]||"æœªçŸ¥"}displayCacheInfo(t){t=t.createEl("div",{cls:"setting-item-info"});t.createEl("div",{cls:"setting-item-name",text:"ç¼“å­˜ä¿¡æ¯"});try{let a=0,i=0;["pdf-ebookshelf-covers","pdf-ebookshelf-covers-v1","pdf-ebookshelf-covers-v2","pdf-ebookshelf-covers-v3-low","pdf-ebookshelf-covers-v3-medium","pdf-ebookshelf-covers-v3-high","pdf-ebookshelf-covers-v3-ultra"].forEach(e=>{e=localStorage.getItem(e);if(e){a+=e.length;try{var t=JSON.parse(e);i+=Object.keys(t).length}catch(e){}}});var e=(a/1048576).toFixed(2),r=this.getQualityName(this.plugin.settings.imageQuality);t.createEl("div",{cls:"setting-item-description",text:`å½“å‰è´¨é‡è®¾ç½®: ${r}
ç¼“å­˜å¤§å°: ${e} MB
ç¼“å­˜å›¾ç‰‡æ•°é‡: `+i})}catch(e){t.createEl("div",{cls:"setting-item-description",text:"æ— æ³•è·å–ç¼“å­˜ä¿¡æ¯"})}}}class CategoryNameEditModal extends require("obsidian").Modal{constructor(e,t,a){super(e),this.currentCategoryName=t,this.onSave=a}onOpen(){var e=this.contentEl;e.createEl("h2",{text:"ç¼–è¾‘åˆ†ç±»åç§°"});let a=e.createEl("input",{type:"text",value:"é»˜è®¤åˆ†ç±»"===this.currentCategoryName?"":this.currentCategoryName,placeholder:"è¯·è¾“å…¥æ–°çš„åˆ†ç±»åç§°ï¼ˆç•™ç©ºä¸ºé»˜è®¤åˆ†ç±»ï¼‰"});a.focus(),"é»˜è®¤åˆ†ç±»"!==this.currentCategoryName&&a.select();var t=e.createEl("p",{text:"æ³¨æ„ï¼šä¿®æ”¹åˆ†ç±»åç§°å°†å½±å“è¯¥åˆ†ç±»ä¸‹çš„æ‰€æœ‰PDFæ–‡ä»¶",cls:"category-name-edit-desc"}),t=(t.style.fontSize="12px",t.style.color="#999",t.style.marginTop="8px",e.createEl("div",{cls:"modal-button-container"})),e=t.createEl("button",{text:"ä¿å­˜"}),t=t.createEl("button",{text:"å–æ¶ˆ"});e.addEventListener("click",()=>{var e=a.value.trim()||"é»˜è®¤åˆ†ç±»";this.onSave(e),this.close()}),t.addEventListener("click",()=>{this.onSave(null),this.close()}),a.addEventListener("keydown",e=>{var t;"Enter"===e.key?(t=a.value.trim()||"é»˜è®¤åˆ†ç±»",this.onSave(t),this.close()):"Escape"===e.key&&(this.onSave(null),this.close())})}onClose(){var e=this.contentEl;e.empty()}}module.exports=PDFEbookshelfPlugin;