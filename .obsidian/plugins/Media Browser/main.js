let{Plugin,Notice,ItemView,PluginSettingTab}=require("obsidian"),fs=require("fs"),path=require("path"),nodeCrypto=null;try{nodeCrypto=require("crypto")}catch(e){nodeCrypto=null}function compareVersions(e,t){var i=String(e||"").split("."),r=String(t||"").split("."),a=Math.max(i.length,r.length);for(let e=0;e<a;e++){var n=parseInt(i[e]||"0",10),s=parseInt(r[e]||"0",10);if(s<n)return 1;if(n<s)return-1}return 0}function normalizePathSlashes(e){return"string"==typeof e?e.replace(/\\/g,"/"):""}function generateSimpleHash(t){let i=3735928559^(t.length||0),r=1103547991^(t.length||0);for(let e=0;e<t.length;e++){var a=t.charCodeAt(e);i=Math.imul(i^a,2654435761),r=Math.imul(r^a,1597334677)}return i=(i^i>>>16)>>>0,r=(r^r>>>13)>>>0,(("00000000"+i.toString(16)).slice(-8)+("00000000"+r.toString(16)).slice(-8)).repeat(4)}async function generateSecureHash(e,t=""){var e=String(e||""),i=(new Date).toISOString().slice(0,10),e=e+"|"+String(t||"")+"|"+i;if(nodeCrypto&&"function"==typeof nodeCrypto.createHash)try{return nodeCrypto.createHash("sha256").update(e).digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{var r=new TextEncoder,a=await window.crypto.subtle.digest("SHA-256",r.encode(e)),n=new DataView(a);let t="";for(let e=0;e<n.byteLength;e++){var s=n.getUint8(e).toString(16).padStart(2,"0");t+=s}return t}catch(e){}return generateSimpleHash(e)}async function generateStableHash(e,t=""){e=String(e||"")+"|"+String(t||"");if(nodeCrypto&&"function"==typeof nodeCrypto.createHash)try{return nodeCrypto.createHash("sha256").update(e).digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{var i=new TextEncoder,r=await window.crypto.subtle.digest("SHA-256",i.encode(e)),a=new DataView(r);let t="";for(let e=0;e<a.byteLength;e++){var n=a.getUint8(e).toString(16).padStart(2,"0");t+=n}return t}catch(e){}return generateSimpleHash(e)}async function generatePluginFingerprint(e,t){t={id:e&&e.id?String(e.id):"",version:e&&e.version?String(e.version):"0.0.0",author:e&&e.author?String(e.author):"",name:e&&e.name?String(e.name):"",path:normalizePathSlashes(t||""),minAppVersion:e&&e.minAppVersion?String(e.minAppVersion):""};return generateStableHash(JSON.stringify(t),"plugin-fingerprint")}async function validatePluginIntegrity(e,t){try{if(!e||"object"!=typeof e)return!1;if("obsidian-content-protection"!==e.id)return!1;if("ytmaps"!==String(e.author||""))return!1;if(compareVersions(String(e.version||"0.0.0"),"1.3.0")<0)return!1;var i=await generatePluginFingerprint(e,t);if(!i||i.length<32)return!1;var r="mb_cp_manifest_fingerprint";"undefined"!=typeof localStorage&&localStorage.getItem(r);if("undefined"!=typeof localStorage)try{localStorage.setItem(r,i)}catch(e){}return!0}catch(e){return!1}}let VIDEO_VIEW_TYPE="media-video-view";class MediaBrowserSettings{constructor(){this.bilibiliLoginStatus="not_logged_in",this.lastLoginCheck=0}}class MediaBrowserSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var e=this.containerEl,e=(e.empty(),e.createEl("h2",{text:"Meida Browserè®¾ç½®"}),e.createEl("div",{cls:"setting-item"})),e=(e.createEl("h3",{text:"Bç«™ç™»å½•çŠ¶æ€"}),e.createEl("div",{cls:"bilibili-login-status",attr:{style:"padding: 10px; border-radius: 5px; margin: 10px 0; display: flex; align-items: center; gap: 10px;"}}));let r=e.createEl("div",{cls:"status-indicator",attr:{style:"width: 12px; height: 12px; border-radius: 50%; background-color: #ccc;"}}),a=e.createEl("span",{text:"æ­£åœ¨æ£€æµ‹ç™»å½•çŠ¶æ€...",attr:{style:"font-weight: 500;"}});e=e.createEl("button",{text:"ç™»å½•Bç«™",attr:{style:"margin-left: auto; padding: 5px 10px; border: 1px solid var(--background-modifier-border); border-radius: 3px; background: #00a1d6; color: white; cursor: pointer;"}});let n=e=>{let t,i;switch(e){case"logged_in":t="#4CAF50",i="å·²ç™»å½•";break;case"not_logged_in":t="#FF9800",i="æœªç™»å½•";break;case"checking":t="#2196F3",i="æ£€æµ‹ä¸­...";break;default:t="#FF9800",i="æœªç™»å½•"}r.style.backgroundColor=t,a.setText(i)},d=async()=>{n("checking");let i=null,r=null,e=null;try{(i=document.createElement("webview")).style.cssText="width: 1px; height: 1px; position: absolute; left: -9999px; top: -9999px;",i.setAttribute("webpreferences","contextIsolation=no, nodeIntegration=yes, webSecurity=no"),i.setAttribute("src","https://www.bilibili.com"),document.body.appendChild(i);var t=await new Promise(t=>{r=setTimeout(()=>{t("not_logged_in")},8e3),e=async()=>{try{var e=await i.executeJavaScript(`
(() => {try { const checkLoginStatus = () => { try {const loginInfo = localStorage.getItem('bili_user_info') ||  localStorage.getItem('user_info') ||localStorage.getItem('login_info') ||localStorage.getItem('bili_user');if (loginInfo) {const parsed = JSON.parse(loginInfo);
if (parsed && (parsed.uname || parsed.name || parsed.username)) {return 'logged_in';} }} catch (e) {} if (document.cookie.includes('SESSDATA') ||  document.cookie.includes('bili_jct') ||  document.cookie.includes('DedeUserID')) { return 'logged_in';
 }return 'not_logged_in';};  return checkLoginStatus();} catch (error) { return 'not_logged_in';}})()`);r&&(clearTimeout(r),r=null),t(e)}catch(e){r&&(clearTimeout(r),r=null),t("not_logged_in")}},i.addEventListener("dom-ready",e,{once:!0})});this.plugin.settings.bilibiliLoginStatus=t,this.plugin.settings.lastLoginCheck=Date.now(),await this.plugin.saveData(this.plugin.settings),n(t)}catch(e){n("not_logged_in")}finally{r&&(clearTimeout(r),r=null),i&&i.parentNode&&(e&&i.removeEventListener("dom-ready",e),document.body.removeChild(i),i=null)}};e.addEventListener("click",()=>{const i=document.createElement("webview"),r=(i.style.cssText="width: 800px; height: 600px; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10000; border: 1px solid var(--background-modifier-border); border-radius: 8px; background: white;",i.setAttribute("webpreferences","contextIsolation=no, nodeIntegration=yes, webSecurity=no"),i.setAttribute("src","https://passport.bilibili.com/login"),document.createElement("button")),a=(r.textContent="Ã—",r.style.cssText="position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border: none; background: #ff4757; color: white; border-radius: 50%; cursor: pointer; font-size: 18px; z-index: 10001;",document.createElement("div")),n=(a.style.cssText="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 9999;",document.createElement("div"));n.style.cssText="position: relative; display: inline-block;",n.appendChild(i),n.appendChild(r);let s=()=>{r&&r.removeEventListener("click",s),a&&a.removeEventListener("click",o),i&&i.removeEventListener("dom-ready",l),a&&a.parentNode&&document.body.removeChild(a),a=null,i=null,r=null,n=null;let e=0,t=()=>{d(),++e<5&&setTimeout(t,1e3)};t()},o=e=>{e.target===a&&s()},l=()=>{i.executeJavaScript(`
(() => {try {if (window.location.href.includes('bilibili.com') &&  !window.location.href.includes('login') &&!window.location.href.includes('passport')) {
  return 'success'; }const hasLoginInfo = (() => { try {const loginInfo = localStorage.getItem('bili_user_info') || 
  localStorage.getItem('user_info') ||localStorage.getItem('login_info') || localStorage.getItem('bili_user');if (loginInfo) { const parsed = JSON.parse(loginInfo); if (parsed && (parsed.uname || parsed.name || parsed.username)) { return true; }
 }} catch (e) {}if (document.cookie.includes('SESSDATA') ||  document.cookie.includes('bili_jct') || document.cookie.includes('DedeUserID')) {
   return true;}return false; })(); if (hasLoginInfo) { return 'success'; }return 'checking';} catch (error) { return 'checking'; }
})()`).then(e=>{"success"===e&&(new Notice("ç™»å½•æˆåŠŸï¼"),s())}).catch(e=>{})};r.addEventListener("click",s),a.addEventListener("click",o),i.addEventListener("dom-ready",l),a.appendChild(n),document.body.appendChild(a)}),this.plugin.settings.lastLoginCheck&&Date.now()-this.plugin.settings.lastLoginCheck<3e5?n(this.plugin.settings.bilibiliLoginStatus):d()}}class MediaVideoView extends ItemView{constructor(e,t){super(e),this.plugin=t,this.filePath=null,this.bilibiliVideoId=null,this.bilibiliTimestamp=0,this.webview=null}getViewType(){return VIDEO_VIEW_TYPE}getDisplayText(){return this.bilibiliVideoId?"Bilibili: "+this.bilibiliVideoId:this.filePath?path.basename(this.filePath):"è§†é¢‘æ’­æ”¾å™¨"}getIcon(){return"lucide-tv-minimal-play"}async onOpen(){var e=this.containerEl.children[1];e.empty(),e.createEl("div",{text:"è¯·é€‰æ‹©è¦æ’­æ”¾çš„è§†é¢‘æ–‡ä»¶"});try{var t,i,r=this.containerEl.closest(".workspace-leaf")?.querySelector(".workspace-tab-header-inner");r&&((t=r.querySelector("svg, .workspace-tab-header-icon"))&&t.remove(),(i=document.createElement("span")).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-tv-minimal-play-icon lucide-tv-minimal-play"><path d="M10 7.75a.75.75 0 0 1 1.142-.638l3.664 2.249a.75.75 0 0 1 0 1.278l-3.664 2.25a.75.75 0 0 1-1.142-.64z"/><path d="M7 21h10"/><rect width="20" height="14" x="2" y="3" rx="2"/></svg>',i.className="workspace-tab-header-icon",r.prepend(i))}catch(e){}}async onClose(){var e=this.containerEl.querySelector("video");e&&e.src&&e.src.startsWith("blob:")&&URL.revokeObjectURL(e.src),this.webview&&(this.webview.remove(),this.webview=null)}setFilePath(e){this.filePath=e,this.bilibiliVideoId=null,this.bilibiliTimestamp=0,(this.plugin.lastActiveVideoView=this).loadVideo()}async setBilibiliVideo(e,t=0){this.bilibiliVideoId=e,this.bilibiliTimestamp=t,this.filePath=null,await(this.plugin.lastActiveVideoView=this).loadBilibiliVideo()}async loadBilibiliVideo(){if(this.bilibiliVideoId){var t=this.containerEl.children[1];t.empty();try{"undefined"!=typeof require&&require("electron")?await this.createBilibiliWebview(t):await this.createBilibiliIframe(t)}catch(e){t.createEl("div",{text:"åŠ è½½Bilibiliè§†é¢‘å¤±è´¥: "+e.message,attr:{style:"color: var(--text-error); text-align: center; padding: 20px;"}})}}}async createBilibiliWebview(t){try{if("undefined"==typeof require)throw new Error("å½“å‰ç¯å¢ƒä¸æ”¯æŒwebview");this.webview=document.createElement("webview"),this.webview.style.cssText="width: 100%; height: 100%; border: none; border-radius: 0; background: #000; overflow: hidden; position: relative;",this.webview.setAttribute("webpreferences","contextIsolation=no, nodeIntegration=yes, webSecurity=no"),this.webview.setAttribute("allowpopups","true"),this.webview.setAttribute("allowfullscreen","true");var e=this.buildBilibiliUrl();this.webview.setAttribute("src",e),t.appendChild(this.webview),this.webview.addEventListener("did-start-loading",()=>{this.injectInitialHideScript()}),this.webview.addEventListener("dom-ready",()=>{this.injectBilibiliScripts()}),this.webview.addEventListener("console-message",e=>{}),this.webview.addEventListener("did-fail-load",e=>{this.fallbackToIframe(t)}),setTimeout(()=>{this.webview&&!this.webview.src&&this.fallbackToIframe(t)},1e4)}catch(e){this.fallbackToIframe(t)}}fallbackToIframe(e){try{this.webview&&(this.webview.remove(),this.webview=null),this.createBilibiliIframe(e)}catch(e){}}async createBilibiliIframe(e){var t=document.createElement("iframe"),i=(t.style.cssText="width: 100%; height: 80vh; border: none; border-radius: 8px; background: #000;",this.buildBilibiliUrl());t.src=i,e.appendChild(t)}buildBilibiliUrl(){let e="https://www.bilibili.com/video/"+this.bilibiliVideoId;return 0<this.bilibiliTimestamp&&(this.bilibiliVideoId.includes("?")?e+="&t="+Math.floor(this.bilibiliTimestamp):e+="?t="+Math.floor(this.bilibiliTimestamp)),e}async injectInitialHideScript(){if(this.webview)try{await this.webview.executeJavaScript(`(() => {
try { if (document.body) { document.body.style.margin = '0';document.body.style.padding = '0';document.body.style.backgroundColor = '#000';document.body.style.overflow = 'hidden';
}if (document.documentElement) { document.documentElement.style.margin = '0'; document.documentElement.style.padding = '0';   document.documentElement.style.backgroundColor = '#000';document.documentElement.style.overflow = 'hidden';
 }const hideInterferenceElements = () => {  const headers = document.querySelectorAll('.bili-header, .bili-toolbar, .header, .toolbar, .nav, .navigation, .bili-header__bar, .bili-header__channel'); headers.forEach(el => el.style.display = 'none');
 const sidebars = document.querySelectorAll('.bili-sidebar, .sidebar, .side-bar, .side, .bili-sidebar__channel');
sidebars.forEach(el => el.style.display = 'none');const recommendLists = document.querySelectorAll('.recommend-list, .recommend, .related, .video-list, .list, .bili-video-card, .bili-video-card__info');
 recommendLists.forEach(el => el.style.display = 'none'); const commentAreas = document.querySelectorAll('.comment-container, .comment, .comments, .reply, .bili-comment');
 commentAreas.forEach(el => el.style.display = 'none'); const videoInfos = document.querySelectorAll('.video-info, .info, .title, .description, .desc, .bili-video-info, .bili-video-title');
  videoInfos.forEach(el => el.style.display = 'none');const footers = document.querySelectorAll('.bili-footer, .footer, .bottom, .bili-footer__bar');
 footers.forEach(el => el.style.display = 'none');const ads = document.querySelectorAll('[class*="ad"], [class*="banner"], [class*="promotion"], [class*="sponsor"], [class*="commercial"], .bili-ad');
ads.forEach(ad => ad.style.display = 'none');const otherElements = document.querySelectorAll('.notice, .popup, .modal, .dialog, .overlay, .mask, .bili-notice'); otherElements.forEach(el => el.style.display = 'none');
 const sendingBars = document.querySelectorAll('.bpx-player-sending-bar, .bpx-player-sending'); sendingBars.forEach(el => el.style.display = 'none');
 }; hideInterferenceElements();const observer = new MutationObserver((mutations) => {
let shouldHide = false; mutations.forEach((mutation) => { mutation.addedNodes.forEach((node) => {
 if (node.nodeType === Node.ELEMENT_NODE) {const element = node;const isInterferenceElement = element.classList.contains('bili-header') ||
element.classList.contains('bili-toolbar') ||element.classList.contains('bili-sidebar') || element.classList.contains('bili-footer') || element.classList.contains('recommend-list') ||
 element.classList.contains('comment-container') || element.classList.contains('video-info') ||
element.classList.contains('bili-ad') || element.classList.contains('bili-notice') ||element.classList.contains('bpx-player-sending-bar') || element.classList.contains('bili-video-card') || element.classList.contains('bili-comment') ||
 element.classList.contains('bili-video-info') || element.classList.contains('bili-video-title') ||element.classList.contains('bili-header__bar') ||
  element.classList.contains('bili-header__channel') || element.classList.contains('bili-sidebar__channel') ||element.classList.contains('bili-footer__bar') ||
 element.classList.contains('bili-video-card__info') ||element.classList.contains('bpx-player-sending');
if (isInterferenceElement) { element.style.display = 'none'; shouldHide = true;
 } } }); });if (shouldHide) {setTimeout(hideInterferenceElements, 100); }});if (document.body) {
 observer.observe(document.body, { childList: true,subtree: true});}const periodicHide = setInterval(() => {hideInterferenceElements(); }, 500); 
setTimeout(() => {  clearInterval(periodicHide); }, 10000); } catch (error) { }
})();`)}catch(e){}}async injectBilibiliScripts(){if(this.webview)try{var e=` (() => {  try {  localStorage.setItem('recommend_auto_play', 'close');localStorage.setItem('bpx_player_profile', JSON.stringify({ media: { autoplay: false } }));
const style = document.createElement('style');style.textContent = '.bpx-player-sending-bar { display: none !important; }'; document.head.appendChild(style);
const optimizePlayerContainer = () => {const playerContainer = document.querySelector('#bilibili-player');  if (playerContainer) {
 playerContainer.style.position = 'fixed';playerContainer.style.top = '0';playerContainer.style.left = '0';playerContainer.style.width = '100%'; playerContainer.style.height = '100%';playerContainer.style.zIndex = '9999';
playerContainer.style.backgroundColor = '#000';playerContainer.style.transform = 'none'; playerContainer.style.margin = '0'; playerContainer.style.padding = '0';
  }   };let retryCount = 0; const maxRetries = 10;const waitForPlayer = () => { const player = document.querySelector('#bilibili-player video');
if (player) {optimizePlayerContainer();if (${this.bilibiliTimestamp} > 0) {setTimeout(() => {player.currentTime = ${this.bilibiliTimestamp};
 }, 1000); } player.addEventListener('play', () => { }); player.addEventListener('pause', () => { }); player.addEventListener('seeked', () => {
}); return true;} else { retryCount++; if (retryCount < maxRetries) { if (retryCount === 1) {optimizePlayerContainer(); }
setTimeout(waitForPlayer, 1000); else { return false;} } };ptimizePlayerContainer();setTimeout(waitForPlayer, 1000);} catch (error) {}
})();
            `;await this.webview.executeJavaScript(e)}catch(e){}}async loadVideo(){if(this.filePath){var t=this.containerEl.children[1];t.empty();try{var i=this.filePath;if(!fs.existsSync(i))throw new Error("æ–‡ä»¶ä¸å­˜åœ¨: "+i);var r=fs.readFileSync(i),a=path.extname(this.filePath).toLowerCase();let e="video/mp4";switch(a){case".webm":e="video/webm";break;case".mov":e="video/quicktime";break;case".mkv":e="video/x-matroska";break;case".avi":e="video/x-msvideo";break;case".flv":e="video/x-flv";break;case".ogv":e="video/ogg"}var n=new Blob([r],{type:e}),s=URL.createObjectURL(n);t.createEl("video",{attr:{controls:"true",style:"width: 100%; height: auto; max-height: 80vh;"}}).src=s}catch(e){t.createEl("div",{text:"åŠ è½½è§†é¢‘å¤±è´¥: "+e.message,attr:{style:"color: var(--text-error); text-align: center; padding: 20px;"}})}}}}class MediaBrowserPlugin extends Plugin{constructor(){super(...arguments),this.clickHandlers=new Set,this.previewHandlers=new Map,this.globalHandlers=[],this.settings=new MediaBrowserSettings,this.lastBilibiliCall=null,this.isPluginActivated=!1,this.statusCheckInterval=null}async onload(){await this.checkContentProtectionStatus()&&await this.validateDependencyPlugin()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.showActivationRequired())}async checkContentProtectionStatus(){try{var e=this.app.plugins.plugins["obsidian-content-protection"];if(e){if(!this.app.plugins.enabledPlugins.has("obsidian-content-protection"))return!1;if(e.settings)return!0===e.settings.isActivated&&e.settings.deviceId&&0<e.settings.deviceId.trim().length&&!0===e.settings.hasBeenActivated}return await this.checkContentProtectionFile()}catch(e){return!1}}async checkContentProtectionFile(){try{var e,t;return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?(e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/data.json"),!0===(t=JSON.parse(e)).isActivated&&t.deviceId&&0<t.deviceId.trim().length&&!0===t.hasBeenActivated):!1}catch(e){return!1}}async validateDependencyPlugin(){try{var e,t="obsidian-content-protection";return this.app.plugins.enabledPlugins.has(t)?(e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/manifest.json"),await validatePluginIntegrity(JSON.parse(e),".obsidian/plugins/obsidian-content-protection")):!1}catch(e){return!1}}async checkAndUpdateStatus(){var e=await this.checkContentProtectionStatus();!e&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):e&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())}disablePluginFeatures(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null)}showActivationRequired(){var e;this.app.plugins.enabledPlugins.has("obsidian-content-protection")?((e=document.createElement("div")).className="plugin-activation-notice",e.innerHTML=`
                <div style="padding: 20px; text-align: center; color: #666;"><h3>Media Browser</h3><p>è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»</p> </div>
            `):((e=document.createElement("div")).className="plugin-activation-notice",e.innerHTML=` <div style="padding: 20px; text-align: center; color: #666;">
                    <h3>Media Browser</h3>
                    <p>è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»</p>
                    <p style="font-size: 12px; margin-top: 10px;">
                        æ’ä»¶è·¯å¾„: obsidian-content-protection
                    </p>
                    <p style="font-size: 11px; margin-top: 8px; color: #999;">
                        è®¾ç½® â†’ ç¤¾åŒºæ’ä»¶ â†’ æ‰¾åˆ°"obsidian-content-protection"å¹¶å¯ç”¨
                    </p>
                </div>
            `)}async initializePluginFeatures(){this.settings=Object.assign(new MediaBrowserSettings,await this.loadData()),this.lastActiveVideoView=null,this.registerView(VIDEO_VIEW_TYPE,e=>new MediaVideoView(e,this)),this.registerMarkdownCodeBlockProcessor("media-browser",async(e,t,i)=>{if(this.isPluginActivated)await this.processMediaBrowser(e,t,i);else{this.app.plugins.enabledPlugins.has("obsidian-content-protection");let e="";e="è¯·æ£€æŸ¥Content Protectionæ’ä»¶æ˜¯å¦å¼€å¯å¹¶æ¿€æ´»",void t.createEl("div",{text:e,cls:"plugin-error"})}}),this.addCommand({id:"add-video-timestamp",name:"æ·»åŠ è§†é¢‘æ—¶é—´æˆ³",callback:async()=>{var t,i,r;if(this.isPluginActivated){let e=this.lastActiveVideoView;e||((r=this.app.workspace.activeLeaf)&&"function"==typeof r.view.getViewType&&r.view.getViewType()===VIDEO_VIEW_TYPE?e=r.view:(r=this.app.workspace.getLeavesOfType(VIDEO_VIEW_TYPE)[0])&&"function"==typeof r.view.getViewType&&r.view.getViewType()===VIDEO_VIEW_TYPE&&(e=r.view)),e&&(e.bilibiliVideoId?await this.addBilibiliTimestamp(e):(r=e.containerEl.querySelector("video"))&&(e.filePath?require("path").basename(e.filePath):"")&&(r=r.currentTime,t=Math.floor(r/60),i=Math.floor(r%60),t=t.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0"),i=require("path").resolve(e.filePath),t=`
[${t}](file://${encodeURI(i)}#t=${r.toFixed(2)})ï¼š`,i=require("obsidian").MarkdownView,r=this.app.workspace.getActiveViewOfType(i))&&r.editor&&r.editor.replaceSelection(t))}else this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addCommand({id:"toggle-video-play-pause",name:"æ’­æ”¾/æš‚åœå½“å‰è§†é¢‘",callback:async()=>{if(this.isPluginActivated){let e=this.lastActiveVideoView;if(e||((t=this.app.workspace.activeLeaf)&&"function"==typeof t.view.getViewType&&t.view.getViewType()===VIDEO_VIEW_TYPE?e=t.view:(t=this.app.workspace.getLeavesOfType(VIDEO_VIEW_TYPE)[0])&&"function"==typeof t.view.getViewType&&t.view.getViewType()===VIDEO_VIEW_TYPE&&(e=t.view)),e)if(e.bilibiliVideoId&&e.webview)try{await e.webview.executeJavaScript(` (() => {
const player = document.querySelector('#bilibili-player video');if (player) { if (player.paused) { player.play();return 'play'; } else {  player.pause();return 'pause'; }} return null;})()
                        `)}catch(e){}else{var t=e.containerEl.querySelector("video");t&&(t.paused?t.play():t.pause())}}else this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addCommand({id:"insert-media-browser-block",name:"æ’å…¥Media Browserä»£ç å—",callback:async()=>{var e,t;this.isPluginActivated?(e=require("obsidian").MarkdownView,(e=this.app.workspace.getActiveViewOfType(e))&&e.editor&&(t=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),e.editor.replaceSelection(`\`\`\`media-browser
id: ${t}
path: /Users/Yourname/Documents/Default
subfolders: true
\`\`\`
`))):this.app.plugins.enabledPlugins.has("obsidian-content-protection")}}),this.addCommand({id:"toggle-audio-play-pause",name:"æ’­æ”¾/æš‚åœå½“å‰éŸ³é¢‘",callback:async()=>{var e=this.findActiveAudioPlayer();e&&(e=e.audio,e.paused?e.play():e.pause())}}),this.addCommand({id:"next-audio",name:"åˆ‡æ¢åˆ°ä¸‹ä¸€ä¸ªéŸ³é¢‘",callback:async()=>{var e,t,i=this.findActiveAudioPlayer();i&&({loadAudio:e,audio:t}=i,await e(this.getNextAudioIndex(i)),t.play())}}),this.addCommand({id:"previous-audio",name:"åˆ‡æ¢åˆ°ä¸Šä¸€ä¸ªéŸ³é¢‘",callback:async()=>{var e,t,i=this.findActiveAudioPlayer();i&&({loadAudio:e,audio:t}=i,await e(this.getPreviousAudioIndex(i)),t.play())}}),this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},3e5),this.setupGlobalEventHandlers(),this.registerEvent(this.app.workspace.on("layout-change",()=>{setTimeout(()=>this.setupPreviewHandlers(),100)})),this.registerEvent(this.app.workspace.on("active-leaf-change",()=>{setTimeout(()=>this.setupPreviewHandlers(),100)})),this.setupMutationObserver(),setTimeout(()=>this.setupPreviewHandlers(),500),this.addSettingTab(new MediaBrowserSettingTab(this.app,this))}setupGlobalEventHandlers(){var e=async e=>this.isInMarkdownDocument()&&("A"!==e.target.tagName||!this.isNonVideoFile(e.target))&&await this.isTimestampLink(e.target)?(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),!1):void 0,t=async e=>this.isInMarkdownDocument()&&("A"!==e.target.tagName||!this.isNonVideoFile(e.target))&&await this.isTimestampLink(e.target)?(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),await this.handleTimestampElement(e.target),!1):void 0;document.addEventListener("mousedown",e,!0),document.addEventListener("click",t,!0),this.globalHandlers.push({element:document,event:"mousedown",handler:e,capture:!0},{element:document,event:"click",handler:t,capture:!0}),this.registerDomEvent(document,"mousedown",e,!0),this.registerDomEvent(document,"click",t,!0)}async handleTimestampEvent(e,t){let i=e.target;return!!await this.isTimestampLink(i)&&("click"===t&&setTimeout(async()=>{await this.handleTimestampElement(i)},0),!0)}setupPreviewHandlers(){document.querySelectorAll(".markdown-preview-view, .markdown-rendered, .cm-editor, .markdown-source-view, .HyperMD-list-line").forEach((e,t)=>{var i,r;e.hasAttribute("data-timestamp-setup")||(e.setAttribute("data-timestamp-setup","true"),r=async e=>{!this.isInMarkdownDocument()||"A"===e.target.tagName&&this.isNonVideoFile(e.target)||await this.isTimestampLink(e.target)&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),await this.handleTimestampElement(e.target))},e.addEventListener("mousedown",i=async e=>{!this.isInMarkdownDocument()||"A"===e.target.tagName&&this.isNonVideoFile(e.target)||await this.isTimestampLink(e.target)&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation())},!0),e.addEventListener("click",r,!0),this.previewHandlers.set(e,{mousedown:i,click:r}))}),this.setupDirectLinkHandlers(),this.markBilibiliLinks()}markBilibiliLinks(){this.isInMarkdownDocument()&&document.querySelectorAll("a[href]").forEach(async t=>{var e;this.isNonVideoFile(t)||await this.isTimestampLink(t)&&(t.setAttribute("data-bilibili-link","true"),t.style.cursor="pointer",t.hasAttribute("data-bilibili-event-setup")||(t.setAttribute("data-bilibili-event-setup","true"),t.addEventListener("click",e=async e=>{this.isInMarkdownDocument()&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),await this.handleTimestampElement(t))},!0),this.bilibiliLinkHandlers||(this.bilibiliLinkHandlers=new Map),this.bilibiliLinkHandlers.set(t,e)))})}isInMarkdownDocument(){var e=this.app.workspace.activeLeaf?.view;if(e){e=e.getViewType();if("markdown"===e||"markdown-preview"===e)return!0;e=this.app.workspace.getActiveFile();if(e&&"md"===e.extension)return!0;e=this.app.workspace.activeLeaf;if(e){e=e.getViewState().type;if("markdown"===e||"markdown-preview"===e)return!0}}return!1}isNonVideoFile(e){if(e&&"A"===e.tagName){var t=/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|md|jpg|jpeg|png|gif|svg|webp|zip|rar|7z|mp3|wav|flac|ogg|aac)$/i;if(e.textContent){var i=e.textContent.trim();if(t.test(i))return!0}if(e.href&&t.test(e.href))return!0;if(e.classList.contains("internal-link")){i=e.getAttribute("href");if(i&&t.test(i))return!0}}return!1}setupMutationObserver(){this.mutationObserver&&this.mutationObserver.disconnect();let a=null;this.mutationObserver=new MutationObserver(t=>{if(this.isInMarkdownDocument()){let e=!1;var i;for(i of t.slice(0,10)){if("childList"===i.type)for(var r of i.addedNodes)if(r.nodeType===Node.ELEMENT_NODE){if(r.querySelectorAll)if(0<r.querySelectorAll("a[href]").length){e=!0;break}if("A"===r.tagName&&r.href){e=!0;break}}if(e)break}e&&(a&&clearTimeout(a),a=setTimeout(()=>{this.markBilibiliLinks(),a=null},200))}}),this.mutationObserver.observe(document.body,{childList:!0,subtree:!0})}setupDirectLinkHandlers(){var e=document.querySelectorAll("a[href]");let t=[];e.forEach(e=>{e.hasAttribute("data-timestamp-direct-setup")||t.push(e)}),0!==t.length&&(t.forEach(t=>{t.setAttribute("data-timestamp-direct-setup","true");var e=async e=>{this.isInMarkdownDocument()&&await this.isTimestampLink(t)&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation())},i=async e=>{this.isInMarkdownDocument()&&await this.isTimestampLink(t)&&(e.preventDefault(),e.stopImmediatePropagation(),e.stopPropagation(),await this.handleTimestampElement(t))};t.addEventListener("mousedown",e,!0),t.addEventListener("click",i,!0),this.directLinkHandlers||(this.directLinkHandlers=new Map),this.directLinkHandlers.set(t,{mousedown:e,click:i})}),t)}async isTimestampLink(t){if(t&&this.isInMarkdownDocument()&&("A"!==t.tagName||!this.isNonVideoFile(t))){if("A"===t.tagName&&t.textContent){var i=t.textContent.trim().toLowerCase();if(i.endsWith(".pdf")||i.includes(".pdf"))return!1}if("A"===t.tagName&&t.href&&this.isBilibiliUrl(t.href))return!0;if("A"===t.tagName&&t.href&&(t.href.startsWith("app://obsidian.md/")||"#"===t.href||t.href.includes("index.html#"))){i=t.textContent.trim();if(i.toLowerCase().endsWith(".pdf")||i.toLowerCase().match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|md|jpg|jpeg|png|gif|svg|zip|rar|7z)$/i))return!1;if(await this.isBilibiliLinkByText(t))return!0;i=t.closest("p, li, div");if(i){var r,a,i=i.querySelectorAll("a");for(r of i)if(r.href&&this.isBilibiliUrl(r.href))return!0;for(a of i)if(a.href&&(a.href.startsWith("app://obsidian.md/")||"#"===a.href||a.href.includes("index.html#"))){let t=a.textContent.trim();if([/bilibili\.com\/video\/(BV[a-zA-Z0-9]+|av\d+)/i,/^(BV[a-zA-Z0-9]{10})$/i,/^(av\d{1,12})$/i].some(e=>e.test(t)))return!0}}}if("A"===t.tagName&&t.href&&t.href.startsWith("file://")&&t.href.includes("#t="))return!0;if("A"===t.tagName&&t.classList.contains("internal-link")){i=t.getAttribute("href");if(i&&i.match(/^(.+\.(mp4|mov|webm|mkv|avi|flv|ogv))#t=([0-9.]+)$/i))return!0}if(t.textContent&&t.textContent.match(/^\[\[(.+\.(mp4|mov|webm|mkv|avi|flv|ogv))#t=([0-9.]+)\|([0-9:]+)\]\]$/i))return!0;if("A"===t.tagName&&t.textContent)if(/^\d+:\d{2}$/.test(t.textContent.trim())){if(t.href&&(t.href.startsWith("app://obsidian.md/")||"#"===t.href||t.href.includes("index.html#")))return!0;if(!t.href||!t.href.startsWith("file://")&&!t.href.startsWith("app://obsidian.md/")&&!this.isBilibiliUrl(t.href))return!0}let e=t.parentElement;for(;e;){if("A"===e.tagName&&(e.href&&e.href.startsWith("file://")&&e.href.includes("#t=")||e.classList.contains("internal-link")&&e.getAttribute("href")&&e.getAttribute("href").includes("#t=")||e.textContent&&/^\d+:\d{2}$/.test(e.textContent.trim())&&e.href&&(e.href.startsWith("app://obsidian.md/")||"#"===e.href||e.href.includes("index.html#"))||e.href&&this.isBilibiliUrl(e.href)||e.href&&(e.href.startsWith("app://obsidian.md/")||"#"===e.href||e.href.includes("index.html#"))&&await this.isBilibiliLinkByText(e)))return!0;e=e.parentElement}}return!1}async isBilibiliLinkByText(i){if(this.isInMarkdownDocument()){let t=i.textContent.trim();if(!t.toLowerCase().endsWith(".pdf")&&!t.toLowerCase().match(/\.(pdf|doc|docx|xls|xlsx|ppt|pptx|txt|md|jpg|jpeg|png|gif|svg|zip|rar|7z)$/i)){var r=[/bilibili\.com\/video\/(BV[a-zA-Z0-9]+|av\d+)/i,/^(BV[a-zA-Z0-9]{10})$/i,/^(av\d{1,12})$/i];if(r.some(e=>e.test(t)))return!0;var a,i=i.closest("p, li, div");if(i){var n,s,i=i.querySelectorAll("a");for(n of i)if(n.href&&this.isBilibiliUrl(n.href))return!0;for(s of i)if(s.href&&(s.href.startsWith("app://obsidian.md/")||"#"===s.href||s.href.includes("index.html#"))){let t=s.textContent.trim();if(r.some(e=>e.test(t)))return!0}}let e=this.app.workspace.getActiveFile();if(e||(i=this.app.workspace.activeLeaf?.view)&&i.file&&(e=i.file),!e)for(a of this.app.workspace.getLeavesOfType("markdown"))if(a.view&&a.view.file){e=a.view.file;break}if(e)try{var o=(await this.app.vault.read(e)).split("\n");for(let e=0;e<o.length;e++){var l=o[e];if(l.includes(t))if(/bilibili\.com\/video\/(BV[a-zA-Z0-9]+|av\d+)/i.test(l)||/(^|\s|\[)(BV[a-zA-Z0-9]{10})(\s|\]|$|\))/i.test(l)||/(^|\s|\[)(av\d{1,12})(\s|\]|$|\))/i.test(l))return!0}}catch(e){}}}return!1}isBilibiliUrl(e){if(!e||"string"!=typeof e)return!1;if(!this.isInMarkdownDocument())return!1;try{var t,i,r,a=new URL(e),n=a.hostname.toLowerCase(),s="bilibili.com"===n||"www.bilibili.com"===n||n.endsWith(".bilibili.com");return s?(i=(t=a.pathname.toLowerCase()).includes("/video/"),r=/\/(BV[a-zA-Z0-9]+|av\d+)/i.test(t),s&&i&&r):!1}catch(e){return!1}}isLikelyFileTimestampLink(e){var t,e=e.closest("p, li, div");return!!e&&(e=e.textContent||"",t=/\.(mp4|mov|webm|mkv|avi|flv|ogv)/i.test(e),e=/file:\/\//i.test(e),t||e)}async handleTimestampElement(e){try{let r=e;if(r="A"!==e.tagName?e.closest("a"):r)if(r.href&&this.isBilibiliUrl(r.href))this.handleBilibiliLink(r);else{if(r.href&&(r.href.startsWith("app://obsidian.md/")||"#"===r.href||r.href.includes("index.html#"))){if(await this.isBilibiliLinkByText(r))return void await this.handleConvertedBilibiliLink(r);var t=r.closest("p, li, div");if(t){var i,a,n=t.querySelectorAll("a");for(i of n)if(i.href&&this.isBilibiliUrl(i.href))return void this.handleBilibiliLink(i);for(a of n)if(a.href&&(a.href.startsWith("app://obsidian.md/")||"#"===a.href||a.href.includes("index.html#"))){let t=a.textContent.trim();if([/bilibili\.com\/video\/(BV[a-zA-Z0-9]+|av\d+)/i,/^(BV[a-zA-Z0-9]{10})$/i,/^(av\d{1,12})$/i].some(e=>e.test(t)))return void await this.handleConvertedBilibiliLink(a)}}}if(r.href&&r.href.startsWith("file://")&&r.href.includes("#t="))try{var s=new URL(r.href),o=require("path");let e=decodeURIComponent(s.pathname);"win32"===process.platform&&e.startsWith("/")&&(e=e.substring(1));var l=o.resolve(e),d=parseFloat(s.hash.replace("#t=",""))||0;return require("fs").existsSync(l)?void this.playVideoAtTime(l,d):void 0}catch(e){return}if(r.href&&(r.href.startsWith("app://obsidian.md/")||"#"===r.href||r.href.includes("index.html#"))&&r.textContent&&/^\d+:\d{2}$/.test(r.textContent.trim()))this.extractFilePathFromContextAsync(r).then(e=>{var t,i;e?([t,i]=r.textContent.trim().split(":").map(Number),this.playVideoAtTime(e,60*t+i)):this.handleSimpleTimestamp(r)}).catch(e=>{this.handleSimpleTimestamp(r)});else{if(r.classList.contains("internal-link")){var c,h,p=r.getAttribute("href"),u=p&&p.match(/^(.+\.(mp4|mov|webm|mkv|avi|flv|ogv))#t=([0-9.]+)$/i);if(u)return c=u[1],h=parseFloat(u[3])||0,void this.playVideoByFileName(c,h)}await this.handleSimpleTimestamp(r)}}}catch(e){}}async handleSimpleTimestamp(e){if(e.textContent&&/^\d+:\d{2}$/.test(e.textContent.trim())){var[t,i]=e.textContent.trim().split(":").map(Number),t=60*t+i,i=await this.findVideoFromContext(e);if(i){if("string"!=typeof i||!i.includes("bilibili.com"))return void this.playVideoAtTime(i,t);try{var r=new URL(i),a=this.extractBilibiliVideoId(r);if(a)return void this.createBilibiliWebviewPlayer(a,t)}catch(e){}}e=this.findVideoFileInCurrentNote();e&&this.playVideoAtTime(e,t)}}async extractFilePathFromContextAsync(e){try{var t=this.app.workspace.getActiveFile();if(t){var i,r=(await this.app.vault.read(t)).split("\n"),a=e.textContent.trim();for(i of r)if(i.includes(a)&&i.includes("file://")){var n=i.match(/file:\/\/([^)\]\s]+)/i);if(n){var s=decodeURIComponent(n[1]);require("path");let e=s;if(e=(e="win32"===process.platform&&e.startsWith("/")?e.substring(1):e).split("#")[0],require("fs").existsSync(e))return e}}}return null}catch(e){return null}}async findVideoFromContext(e){try{var t,i,r=e.closest("p, li, div");if(r){for(t of r.querySelectorAll('a[href*=".mp4"], a[href*=".mov"], a[href*=".webm"], a[href*=".mkv"], a[href*=".avi"], a[href*=".flv"], a[href*=".ogv"]'))if(t.href&&t.href.startsWith("file://"))try{var a=new URL(t.href);let e=decodeURIComponent(a.pathname);"win32"===process.platform&&e.startsWith("/")&&(e=e.substring(1));var n=require("path").resolve(e);if(require("fs").existsSync(n))return n}catch(e){}for(i of r.querySelectorAll("a"))if(this.isBilibiliLinkByText(i)){var s=this.extractBilibiliUrlFromText(i.textContent);if(s)return s}var o=this.app.workspace.getActiveFile();if(o)try{var l,d=(await this.app.vault.read(o)).split("\n"),c=e.textContent.trim();for(l of d)if(l.includes(c)){var h=this.extractBilibiliUrlFromText(l);if(h)return h}}catch(e){}}return null}catch(e){return null}}playVideoByFileName(t,e){var i,r,a=this.app.vault.getFiles().find(e=>e.name===t);a&&(r=require("path"),i=this.app.vault.adapter.basePath,r=r.join(i,a.path),this.playVideoAtTime(r,e))}findVideoFileInCurrentNote(){try{var e=this.app.workspace.getActiveFile();if(e){var t=this.app.metadataCache.getFileCache(e);if(t&&t.links){var i,r=[".mp4",".mov",".webm",".mkv",".avi",".flv",".ogv"];for(i of t.links){let t=i.link;if(r.some(e=>t.toLowerCase().endsWith(e)))if(t.startsWith("/")||t.match(/^[A-Za-z]:/)){if(require("fs").existsSync(t))return t}else{var a=require("path"),n=this.app.vault.adapter.basePath,s=a.join(n,t);if(require("fs").existsSync(s))return s}}try{var o=this.app.vault.read(e);if(o){var l=this.extractBilibiliUrlFromText(o);if(l)return l}}catch(e){}}}return null}catch(e){return null}}playVideoAtTime(t,i){if("string"==typeof t&&t.includes("bilibili.com"))try{var e=new URL(t),r=this.extractBilibiliVideoId(e);if(r)return void this.createBilibiliWebviewPlayer(r,i)}catch(e){}let a=this.app.workspace.getLeavesOfType(VIDEO_VIEW_TYPE)[0],n=(a||(a=this.app.workspace.getRightLeaf(!1)).setViewState({type:VIDEO_VIEW_TYPE,active:!0}),a.view);if(n instanceof MediaVideoView){e=require("path");if((n.filePath?e.resolve(n.filePath):"")===e.resolve(t)){r=n.containerEl.querySelector("video");r&&(r.currentTime=i,r.play())}else{n.setFilePath(t);let e=new MutationObserver(()=>{let t=n.containerEl.querySelector("video");t&&(e.disconnect(),t.addEventListener("loadedmetadata",function e(){t.removeEventListener("loadedmetadata",e),t.currentTime=i,t.play()}))});e.observe(n.containerEl,{childList:!0,subtree:!0})}this.app.workspace.revealLeaf(a)}}onunload(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.globalHandlers&&0<this.globalHandlers.length&&(this.globalHandlers.forEach(({element:e,event:t,handler:i,capture:r})=>{e&&e.removeEventListener&&e.removeEventListener(t,i,r)}),this.globalHandlers=[]),this.previewHandlers&&0<this.previewHandlers.size&&(this.previewHandlers.forEach((e,t)=>{t&&t.removeEventListener&&(t.removeEventListener("mousedown",e.mousedown,!0),t.removeEventListener("click",e.click,!0),t.removeAttribute("data-timestamp-setup"))}),this.previewHandlers.clear()),this.directLinkHandlers&&0<this.directLinkHandlers.size&&(this.directLinkHandlers.forEach((e,t)=>{t&&t.removeEventListener&&(t.removeEventListener("mousedown",e.mousedown,!0),t.removeEventListener("click",e.click,!0),t.removeAttribute("data-timestamp-direct-setup"))}),this.directLinkHandlers.clear()),this.bilibiliLinkHandlers&&0<this.bilibiliLinkHandlers.size&&(this.bilibiliLinkHandlers.forEach((e,t)=>{t&&t.removeEventListener&&t.removeEventListener("click",e,!0)}),this.bilibiliLinkHandlers.clear()),this.mutationObserver&&(this.mutationObserver.disconnect(),this.mutationObserver=null);try{document.querySelectorAll("[data-timestamp-setup]").forEach(e=>{e.removeAttribute("data-timestamp-setup")}),document.querySelectorAll("[data-timestamp-direct-setup]").forEach(e=>{e.removeAttribute("data-timestamp-direct-setup")})}catch(e){}try{document.querySelectorAll(".media-browser-audio-player audio").forEach(e=>{e.src&&e.src.startsWith("blob:")&&URL.revokeObjectURL(e.src)})}catch(e){}}async processMediaBrowser(t,i,e){try{var r,a=t.trim().split("\n"),n=this.parseConfig(a),s=require("os");"/Users/Yourname/Documents/Default"===n.path||"win32"===s.platform()&&n.path.includes("Users\\Yourname\\Documents\\Default")?this.renderFileList(i,[],n):(i.innerHTML='<div class="media-browser-loading">æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹å†…å®¹...</div>',r=await this.getFileList(n),this.renderFileList(i,r,n))}catch(e){"win32"===require("os").platform()&&e.message.includes("è·¯å¾„ä¸å­˜åœ¨")&&(e.message.includes("/Users/Yourname/Documents/Default")||e.message.includes("\\Users\\Yourname\\Documents\\Default"))?(a=t.trim().split("\n"),s=this.parseConfig(a),this.renderFileList(i,[],s)):i.innerHTML=`<div class="media-browser-error">âŒé”™è¯¯ï¼š${e.message}<br>è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®</div>`}}parseConfig(e){var t,i={id:"",path:"",includeSubfolders:!0,showSystem:!1};for(t of e){var r=t.trim();r.startsWith("id:")?i.id=r.substring(3).trim():r.startsWith("path:")?i.path=this.normalizePath(r.substring(5).trim()):r.startsWith("subfolders:")?i.includeSubfolders="true"===r.substring(11).trim().toLowerCase():r.startsWith("showSystem:")&&(i.showSystem="true"===r.substring(11).trim().toLowerCase())}return i}normalizePath(e){if(!e)return"";var t=require("path"),i=require("os");let r=e.replace(/^["']|["']$/g,"");return"win32"===i.platform()?(r.includes("\\")?r=t.normalize(r):r.includes("/")&&(r=r.replace(/\//g,"\\"),r=t.normalize(r)),/^[a-zA-Z]:/.test(r)||(e=process.cwd().split("\\")[0],r=t.join(e,r))):((r=r.startsWith("~")?r.replace("~",i.homedir()):r).startsWith("/")||(r=t.resolve(r)),r=t.normalize(r)),r}getPathHistory(){try{var e,t=window.localStorage.getItem("media-browser-path-history");return t?(e=JSON.parse(t),Array.isArray(e)?e:[]):[]}catch(e){return[]}}addPathHistoryRecord(e,i,r){try{var a=this.normalizePath(i||"");let t={id:String(e||""),path:a,subfolders:!!r,ts:Date.now()};var n=this.getPathHistory().filter(e=>!(e.id===t.id&&e.path===t.path&&e.subfolders===t.subfolders)),s=(n.unshift(t),n.slice(0,20));window.localStorage.setItem("media-browser-path-history",JSON.stringify(s))}catch(e){}}deletePathHistoryRecord(i){try{if(!i)return!1;var t,r=this.getPathHistory();let e=r;if((e="number"==typeof i.ts&&0<=(t=r.findIndex(e=>e.ts===i.ts))?r.slice(0,t).concat(r.slice(t+1)):e)===r){let t=this.normalizePath(i.path||"");e=r.filter(e=>!(e.id===i.id&&this.normalizePath(e.path||"")===t&&e.subfolders===!!i.subfolders))}return window.localStorage.setItem("media-browser-path-history",JSON.stringify(e)),!0}catch(e){return!1}}async updateMediaBrowserCodeBlockFields(s,e,o){try{var t=require("obsidian").MarkdownView,i=this.app.workspace.getActiveViewOfType(t);if(!i||!i.editor)return!1;var l=i.editor,d=l.getValue(),c=/```media-browser([\s\S]*?)```/g;let r="string"==typeof e?this.normalizePath(e):null,a=r&&0<r.length,n="boolean"==typeof o;var h=d.replace(c,e=>{var t=e.match(/id:\s*([^\r\n]+)/);if(!t||t[1].trim()!==String(s))return e;let i=e;return a&&(i=/path:.*/.test(i)?i.replace(/path:.*(?:\r?\n|$)/,`path: ${r}
`):i.replace(/```media-browser/,`media-browser
path: `+r)),i=n?/subfolders:.*/.test(i)?i.replace(/subfolders:.*(?:\r?\n|$)/,`subfolders: ${o}
`):i.replace(/```media-browser/,`media-browser
subfolders: `+o):i});return h!==d?(l.setValue(h),!0):!1}catch(e){return!1}}async getFileList(a){return new Promise((i,r)=>{setTimeout(()=>{try{var e,t=require("fs");require("path");t.existsSync(a.path)?t.statSync(a.path).isDirectory()?(e=this.getAllFilesAndFolders(a.path,[],0,a.includeSubfolders,a.showSystem),i(e)):r(new Error("è·¯å¾„ä¸æ˜¯ç›®å½•: "+a.path)):r(new Error("è·¯å¾„ä¸å­˜åœ¨: "+a.path))}catch(e){r(e)}},0)})}getAllFilesAndFolders(i,r,a=0,n=!0,s=!1){let o=require("fs"),l=require("path");if(r=r||[],!(20<a)){r.push({type:"folder",path:i,level:a});try{var e=o.readdirSync(i);if(1e3<r.length)return r;e.forEach(e=>{if(s||!e.startsWith("."))try{var t=l.join(i,e);o.statSync(t).isDirectory()?n&&this.getAllFilesAndFolders(t,r,a+1,n,s):r.push({type:"file",path:t,level:a+1})}catch(e){}})}catch(e){}}return r}processPath(e){e=e.replace(/\\/g,"/");return"file:///"+encodeURI(e)}createFolderLink(e){var t=require("path").basename(e);return`<a href="${this.processPath(e)}" class="media-browser-folder" data-file-path="${e}">ğŸ“ ${t}</a>`}createFileLink(e){var t=require("path").basename(e);return`<a href="${this.processPath(e)}" class="media-browser-file" data-file-path="${e}">ğŸ“„ ${t}</a>`}renderFileList(h,e,p){let u=document.createElement("div");u.className="media-browser-container";var t=document.createElement("div");t.className="media-browser-header";var i=document.createElement("div"),r=(i.className="media-browser-path-row",i.style.display="flex",i.style.flexDirection="column",i.style.width="100%",document.createElement("h4"));r.textContent=" "+(o=p.path,(s=o.split(/[\\\/]/).filter(Boolean)).length<=2?o:"â€¦/"+s.slice(-2).join("/")),r.style.cursor="pointer",r.title="ç‚¹å‡»ä¿®æ”¹è·¯å¾„";r.addEventListener("click",async()=>{let e;try{e=require("electron").dialog||require("electron").remote&&require("electron").remote.dialog}catch(e){return}if(e){var t=await e.showOpenDialog({title:"é€‰æ‹©æ–‡ä»¶å¤¹",properties:["openDirectory"]});if(!t.canceled&&t.filePaths&&0!==t.filePaths.length){t=t.filePaths[0];if(t&&t!==p.path){p.path=this.normalizePath(t);try{var i,r,a,n,s=require("obsidian").MarkdownView,o=this.app.workspace.getActiveViewOfType(s);o&&o.editor&&(r=(i=o.editor).getValue(),a=/```media-browser([\s\S]*?)```/g,(n=r.replace(a,e=>{var t=e.match(/id:\s*([^\r\n]+)/);return!t||t[1].trim()!==p.id||e.includes(p.path)?e:/path:.*/.test(e)?e.replace(/path:.*(?:\r?\n|$)/,`path: ${p.path}
`):e.replace(/```media-browser/,`media-browser
path: `+p.path)}))!==r)&&i.setValue(n)}catch(e){}this.addPathHistoryRecord(p.id,p.path,p.includeSubfolders),u.innerHTML='<div class="media-browser-loading">æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹å†…å®¹...</div>';try{var l=await this.getFileList(p);this.renderFileList(h,l,p)}catch(e){u.innerHTML=`<div class='media-browser-error'>âŒé”™è¯¯ï¼š${e.message}<br>è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®</div>`}}}}}),i.appendChild(r);let a=document.createElement("button"),m=(a.className="media-browser-refresh-btn",a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder-sync-icon lucide-folder-sync"><path d="M9 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v.5"/><path d="M12 10v4h4"/><path d="m12 14 1.535-1.605a5 5 0 0 1 8 1.5"/><path d="M22 22v-4h-4"/><path d="m22 18-1.535 1.605a5 5 0 0 1-8-1.5"/></svg>',a.title="æ‰‹åŠ¨åˆ·æ–°æ–‡ä»¶åˆ—è¡¨",a.addEventListener("click",async()=>{try{a.disabled=!0,a.innerHTML="â³";var e=u.querySelector(".media-browser-list"),t=(e&&(e.innerHTML='<div class="media-browser-loading">æ­£åœ¨åˆ·æ–°...</div>'),await this.getFileList(p));this.renderFileListContent(u,t,p)}catch(e){var i=u.querySelector(".media-browser-list");i&&(i.innerHTML=`<div class="media-browser-error">åˆ·æ–°å¤±è´¥: ${e.message}</div>`)}finally{a.disabled=!1,a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder-sync-icon lucide-folder-sync"><path d="M9 20H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h3.9a2 2 0 0 1 1.69.9l.81 1.2a2 2 0 0 0 1.67.9H20a2 2 0 0 1 2 2v.5"/><path d="M12 10v4h4"/><path d="m12 14 1.535-1.605a5 5 0 0 1 8 1.5"/><path d="M22 22v-4h-4"/><path d="m22 18-1.535 1.605a5 5 0 0 1-8-1.5"/></svg>'}}),document.createElement("button"));m.className="media-browser-history-btn",m.title="æœ€è¿‘è®¾ç½®çš„è·¯å¾„è®°å½•";try{var n=require("obsidian").setIcon;"function"==typeof n?n(m,"history"):m.innerHTML="ğŸ•˜"}catch(e){m.innerHTML="ğŸ•˜"}m.addEventListener("click",e=>{e.stopPropagation();e=document.querySelector(".media-browser-history-menu");if(e){if(e.__onDocClick)try{document.removeEventListener("mousedown",e.__onDocClick,!0)}catch(e){}e.remove()}let i=document.createElement("div");i.className="media-browser-history-menu";var a,e=m.getBoundingClientRect(),n=(i.style.position="fixed",i.style.top=Math.round(e.bottom+6)+"px",i.style.left=Math.round(e.left)+"px",i.style.zIndex="9999",i.style.maxWidth="380px",i.style.maxHeight="240px",i.style.overflowY="auto",i.style.background="var(--background-primary)",i.style.border="1px solid var(--background-modifier-border)",i.style.borderRadius="6px",i.style.boxShadow="0 6px 20px rgba(0,0,0,0.15)",i.style.padding="6px",this.getPathHistory());if(n&&0!==n.length)for(let e=0;e<Math.min(12,n.length);e++){let r=n[e],t=document.createElement("div");t.className="media-browser-history-item",t.style.display="flex",t.style.alignItems="center",t.style.justifyContent="space-between",t.style.gap="8px",t.style.padding="6px 8px",t.style.cursor="pointer",t.style.fontSize="12px",t.style.borderRadius="4px";var s=document.createElement("div"),o=(s.style.display="flex",s.style.flexDirection="column",s.style.gap="2px",document.createElement("div")),l=(o.textContent=(l=r.path,a=void 0,(a=String(l||"").split(/[\\\/]/).filter(Boolean)).length<=2?l:"â€¦/"+a.slice(-2).join("/")),o.style.color="var(--text-normal)",s.appendChild(o),document.createElement("button"));l.className="media-browser-history-delete-btn",l.title="åˆ é™¤è®°å½•";try{var d=require("obsidian").setIcon;"function"==typeof d?d(l,"x"):l.textContent="ğŸ—‘ï¸"}catch(e){l.textContent="ğŸ—‘ï¸"}l.addEventListener("click",e=>{e.stopPropagation(),this.deletePathHistoryRecord(r),t.remove(),i.querySelector(".media-browser-history-item")||((e=document.createElement("div")).textContent="æš‚æ— å†å²è®°å½•",e.style.color="var(--text-muted)",e.style.fontSize="12px",e.style.padding="6px 8px",i.appendChild(e))}),t.appendChild(s),t.appendChild(l),t.addEventListener("click",async e=>{e.stopPropagation();var e=this.normalizePath(r.path),t=!!r.subfolders;await this.updateMediaBrowserCodeBlockFields(p.id,e,t),p.path=e,p.includeSubfolders=t,this.addPathHistoryRecord(p.id,p.path,p.includeSubfolders),u.innerHTML='<div class="media-browser-loading">æ­£åœ¨åŠ è½½æ–‡ä»¶å¤¹å†…å®¹...</div>';try{var i=await this.getFileList(p);this.renderFileList(h,i,p)}catch(e){u.innerHTML=`<div class='media-browser-error'>âŒé”™è¯¯ï¼š${e.message}<br>è¯·æ£€æŸ¥è·¯å¾„æ˜¯å¦æ­£ç¡®</div>`}c()}),t.addEventListener("mouseenter",()=>{t.style.background="var(--background-modifier-hover)"}),t.addEventListener("mouseleave",()=>{t.style.background="transparent"}),i.appendChild(t)}else{e=document.createElement("div");e.textContent="æš‚æ— å†å²è®°å½•",e.style.color="var(--text-muted)",e.style.fontSize="12px",e.style.padding="6px 8px",i.appendChild(e)}let c=()=>{try{i.__onDocClick&&document.removeEventListener("mousedown",i.__onDocClick,!0)}catch(e){}i.remove()};e=e=>{i.contains(e.target)||e.target===m||c()};i.__onDocClick=e,document.addEventListener("mousedown",e,!0),document.body.appendChild(i)});let d=document.createElement("button");d.className="media-browser-subfolders-btn",d.innerHTML=p.includeSubfolders?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-down-up-icon lucide-chevrons-down-up"><path d="m7 20 5-5 5 5"/><path d="m7 4 5 5 5-5"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-down-icon lucide-chevrons-up-down"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>',d.title=p.includeSubfolders?"éšè—å­æ–‡ä»¶å¤¹":"æ˜¾ç¤ºå­æ–‡ä»¶å¤¹",d.addEventListener("click",async()=>{try{d.disabled=!0,d.innerHTML="â³",p.includeSubfolders=!p.includeSubfolders;try{var e,t,i,r,a=require("obsidian").MarkdownView,n=this.app.workspace.getActiveViewOfType(a);n&&n.editor&&(t=(e=n.editor).getValue(),i=/```media-browser([\s\S]*?)```/g,(r=t.replace(i,e=>{var t=e.match(/id:\s*([^\r\n]+)/);return t&&t[1].trim()===p.id?/subfolders:.*/.test(e)?e.replace(/subfolders:.*(?:\r?\n|$)/,`subfolders: ${p.includeSubfolders}
`):e.replace(/```media-browser/,`media-browser
subfolders: `+p.includeSubfolders):e}))!==t)&&e.setValue(r)}catch(e){}var s=u.querySelector(".media-browser-list"),o=(s&&(s.innerHTML='<div class="media-browser-loading">æ­£åœ¨åˆ‡æ¢å­æ–‡ä»¶å¤¹æ˜¾ç¤º...</div>'),await this.getFileList(p));this.renderFileListContent(u,o,p),d.innerHTML=p.includeSubfolders?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-down-up-icon lucide-chevrons-down-up"><path d="m7 20 5-5 5 5"/><path d="m7 4 5 5 5-5"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevrons-up-down-icon lucide-chevrons-up-down"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>',d.title=p.includeSubfolders?"éšè—å­æ–‡ä»¶å¤¹":"æ˜¾ç¤ºå­æ–‡ä»¶å¤¹"}catch(e){var l=u.querySelector(".media-browser-list");l&&(l.innerHTML=`<div class="media-browser-error">åˆ‡æ¢å¤±è´¥: ${e.message}</div>`)}finally{d.disabled=!1}}),t.appendChild(d),t.appendChild(a),t.appendChild(m),t.appendChild(i),u.appendChild(t);var s,o=require("os");"/Users/Yourname/Documents/Default"===p.path||"win32"===o.platform()&&p.path.includes("Users\\Yourname\\Documents\\Default")?((s=document.createElement("div")).className="media-browser-error",s.style.cssText="padding: 32px 0; text-align: center; color: var(--text-muted); font-size: 16px;",s.textContent="ç­‰å¾…è®¾ç½®è·¯å¾„ï¼ˆè¯·ç‚¹å‡»ä¸Šæ–¹Defaultè·¯å¾„ï¼‰",u.appendChild(s)):this.renderFileListContent(u,e,p),h.empty(),h.appendChild(u)}renderFileListContent(i,e,t){var{}=require("obsidian");let o=require("path"),l=[".mp4",".mov",".webm",".mkv",".avi",".flv",".ogv"],d=[".flac",".m4a",".mp3",".ogg",".wav",".webm",".3gp"];this.initAudioPlayer(i,e,d);var r=i.querySelector(".media-browser-list"),r=(r&&r.remove(),document.createElement("div"));r.className="media-browser-list";let a=[],n=[],c=(e.forEach(e=>{for(;n.length&&n[n.length-1].level>=e.level;)n.pop();e.children=[],(n.length?n[n.length-1].children:a).push(e),n.push(e)}),(e,s,t=0)=>{e.forEach(r=>{var a=document.createElement("div");if(a.className="media-browser-item",a.style.marginLeft=20*r.level+"px","folder"===r.type){let e=document.createElement("span"),t=(e.className="media-browser-toggle-btn",e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right-icon"><path d="m9 18 6-6-6-6"/></svg>',e.style.cursor="pointer",e.style.verticalAlign="middle",!(e.style.marginRight="4px")),i=null;0<r.children.length?e.addEventListener("click",()=>{(t=!t)?(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down-icon"><path d="m6 9 6 6 6-6"/></svg>',i.style.display=""):(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-right-icon"><path d="m9 18 6-6-6-6"/></svg>',i.style.display="none")}):e.style.visibility="hidden",a.appendChild(e);var n=document.createElement("span");n.innerHTML=this.createFolderLink(r.path),a.appendChild(n),s.appendChild(a),0<r.children.length&&((i=document.createElement("div")).style.display="none",c(r.children,i,r.path),s.appendChild(i))}else{var e,t,n=o.extname(r.path).toLowerCase();l.includes(n)?(e=o.basename(r.path),(t=document.createElement("a")).href="#",t.textContent="ğŸ¬ "+e,t.style.cssText=`
                            color: rgb(14 125 161);
                            text-decoration: none;
                            cursor: pointer;
                        `,t.title="ç‚¹å‡»æ’­æ”¾è§†é¢‘",t.setAttribute("data-file-path",r.path),t.setAttribute("data-file-type","video"),t.addEventListener("click",async e=>{e.preventDefault(),await this.playVideoWithPriority(r.path)}),a.appendChild(t)):d.includes(n)?(e=o.basename(r.path),(t=document.createElement("a")).href="#",t.textContent="ğŸµ "+e,t.style.cssText=`
                            color: rgb(214 102 0);
                            text-decoration: none;
                            cursor: pointer;
                        `,t.title="ç‚¹å‡»åœ¨æ’­æ”¾å™¨ä¸­æ’­æ”¾",t.setAttribute("data-file-path",r.path),t.setAttribute("data-file-type","audio"),t.addEventListener("click",async e=>{e.preventDefault(),await this.playAudioInPlayer(i,r.path)}),a.appendChild(t)):a.innerHTML=this.createFileLink(r.path),s.appendChild(a)}})}),s=(c(a,r),r.addEventListener("click",t=>{var e=t.target.closest("a");if(e&&(e.classList.contains("media-browser-folder")||e.classList.contains("media-browser-file"))){t.preventDefault();let i=e.getAttribute("data-file-path");if(i){var r,a,t=o.extname(i).toLowerCase(),e=l.includes(t);if(!e)try{"undefined"!=typeof require?(r=require("electron").shell,r.openPath(i).catch(e=>{var t=this.processPath(i);window.open(t,"_blank")})):(a=this.processPath(i),window.open(a,"_blank"))}catch(e){t=this.processPath(i);window.open(t,"_blank")}}}}),null),h=null;r.addEventListener("contextmenu",r=>{var a=r.target.closest("a");if(a&&(a.classList.contains("media-browser-folder")||a.classList.contains("media-browser-file")||a.href||"audio"===a.getAttribute("data-file-type")||"video"===a.getAttribute("data-file-type"))){r.preventDefault(),s&&s.remove(),h&&document.removeEventListener("click",h);var n=a.getAttribute("data-file-path");let e,t,i=(t=n?(e=(e=a.textContent.replace(/^\s*[\uD800-\uDBFF][\uDC00-\uDFFF]?\s*/,"")).replace(/^\s*[ğŸ“ğŸ“„ğŸµğŸ¬]\s*/,""),this.processPath(n)):(e=a.textContent,a.getAttribute("href")),`[${e}](${t})`);(s=document.createElement("div")).className="media-browser-contextmenu",s.style.position="fixed",s.style.zIndex=9999,s.style.left=r.clientX+"px",s.style.top=r.clientY+"px",s.style.background="#fff",s.style.border="1px solid #ccc",s.style.borderRadius="6px",s.style.boxShadow="0 2px 8px rgba(0,0,0,0.15)",s.style.padding="6px 16px",s.style.fontSize="14px",s.style.cursor="pointer",s.textContent="å¤åˆ¶ Obsidian é“¾æ¥åœ°å€",s.addEventListener("click",async()=>{try{await navigator.clipboard.writeText(i),s.textContent="å·²å¤åˆ¶ï¼",setTimeout(()=>{s&&s.remove()},800)}catch(e){s.textContent="å¤åˆ¶å¤±è´¥",setTimeout(()=>{s&&s.remove()},800)}}),document.body.appendChild(s),h=e=>{s&&!s.contains(e.target)&&(s.remove(),document.removeEventListener("click",h))},setTimeout(()=>{document.addEventListener("click",h)},0)}}),i.querySelector(".media-browser-header").after(r)}initAudioPlayer(u,m,t){let v=require("path");var f=u.querySelector(".media-browser-audio-player");f&&f.remove();let b=m.filter(e=>"file"===e.type&&t.includes(v.extname(e.path).toLowerCase()));if(0!==b.length){let o=document.createElement("div"),l=(o.className="media-browser-audio-player",document.createElement("audio")),d=(l.style.display="none",o.appendChild(l),0),e=!1,i=!1,c=[],t=()=>{if(c=Array.from({length:b.length},(e,t)=>t),i)for(let e=c.length-1;0<e;e--){var t=Math.floor(Math.random()*(e+1));[c[e],c[t]]=[c[t],c[e]]}},r=()=>{if(i){if(b.length<=1)return 0;let e;for(;(e=Math.floor(Math.random()*b.length))===d&&1<b.length;);return e}return d<b.length-1?d+1:0},a=(t(),async e=>{let t=b[c[e]],i=(d=e,o.querySelector(".media-browser-current-file"));i&&(i.textContent=v.basename(t.path),i.title=t.path);try{var r=require("fs").readFileSync(t.path),a=v.extname(t.path).toLowerCase();let e="audio/mpeg";switch(a){case".mp3":e="audio/mpeg";break;case".wav":e="audio/wav";break;case".ogg":e="audio/ogg";break;case".m4a":e="audio/mp4";break;case".flac":e="audio/flac";break;case".webm":e="audio/webm";break;case".3gp":e="audio/3gpp"}var n=new Blob([r],{type:e}),s=URL.createObjectURL(n);l.src&&l.src.startsWith("blob:")&&URL.revokeObjectURL(l.src),l.onerror&&(l.onerror=null),l.src=s,l.onerror=e=>{i.textContent="åŠ è½½å¤±è´¥: "+v.basename(t.path)}}catch(e){i.textContent="è¯»å–å¤±è´¥: "+v.basename(t.path)}}),n=document.createElement("button");n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play-icon lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>',n.style.cssText=`
            background: transparent;
            color: rgb(255 0 0 / 54%);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        `,n.title="æ’­æ”¾/æš‚åœ",n.addEventListener("click",async()=>{e?l.pause():(l.src||await a(0),l.play())});f=document.createElement("button"),m=(f.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-first-icon lucide-chevron-first"><path d="m17 18-6-6 6-6"/><path d="M7 6v12"/></svg>',f.style.cssText=`
            background: transparent;
            color: #6c757d;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        `,f.title="ä¸Šä¸€æ›²",f.addEventListener("click",async()=>{let e;if(i)if(b.length<=1)e=0;else for(;(e=Math.floor(Math.random()*b.length))===d&&1<b.length;);else e=0<d?d-1:b.length-1;await a(e),l.play()}),document.createElement("button"));m.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-last-icon lucide-chevron-last"><path d="m7 18 6-6-6-6"/><path d="M17 6v12"/></svg>',m.style.cssText=`
            background: transparent;
            color: #6c757d;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        `,m.title="ä¸‹ä¸€æ›²",m.addEventListener("click",async()=>{var e=r();await a(e),l.play()});let s=document.createElement("button");s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-shuffle-icon lucide-shuffle"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"/></svg>',s.style.cssText=`
            background: transparent;
            color: ${i?"#28a745":"#6c757d"};
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        `,s.title="éšæœºæ’­æ”¾",s.addEventListener("click",()=>{i=!i,s.style.color=i?"#28a745":"#6c757d",t(),u.audioPlayer&&(u.audioPlayer.isShuffle=i)});var g=document.createElement("div"),w=(g.className="media-browser-current-file",g.style.cssText=`
            padding-left: 10px;
            flex: 1;
            min-width: 120px;
            font-size: 12px;
            color: #495057;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        `,g.textContent=`å…± ${b.length} ä¸ªéŸ³é¢‘æ–‡ä»¶`,document.createElement("div"));w.style.cssText=`
            flex: 1;
            min-width: 150px;
            display: flex;
            align-items: center;
            gap: 8px;
        `;let h=document.createElement("input"),p=(h.type="range",h.min="0",h.max="100",h.value="0",h.style.cssText=`
            flex: 1;
            height: 2px !important;
            border-radius: 2px;
            outline: none;
            cursor: pointer;
        `,h.className="media-browser-progress",document.createElement("div"));p.style.cssText=`
            font-size: 11px;
            color: #6c757d;
            min-width: 80px;
            text-align: center;
        `,p.textContent="0:00 / 0:00",w.appendChild(h),w.appendChild(p),l.addEventListener("play",()=>{e=!0,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-pause-icon lucide-circle-pause"><circle cx="12" cy="12" r="10"/><line x1="10" x2="10" y1="15" y2="9"/><line x1="14" x2="14" y1="15" y2="9"/></svg>'}),l.addEventListener("pause",()=>{e=!1,n.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-play-icon lucide-circle-play"><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></svg>'}),l.addEventListener("ended",async()=>{var e=r();await a(e),l.play()}),l.addEventListener("timeupdate",()=>{var e,t,i;isNaN(l.duration)||(e=l.currentTime/l.duration*100,h.value=e,e=Math.floor(l.currentTime),t=Math.floor(l.duration),i=e=>Math.floor(e/60)+":"+(e%60).toString().padStart(2,"0"),p.textContent=i(e)+" / "+i(t))}),h.addEventListener("input",()=>{var e=h.value/100*l.duration;l.currentTime=e}),o.appendChild(f),o.appendChild(n),o.appendChild(m),o.appendChild(s),o.appendChild(g),o.appendChild(w),u.insertBefore(o,u.firstChild),u.audioPlayer={audio:l,loadAudio:a,audioFiles:b,playOrder:c,currentIndex:d,isPlaying:e,isShuffle:i}}}findActiveAudioPlayer(){var e,t,i=document.querySelectorAll(".media-browser-audio-player");for(e of i){var r=e.parentElement?.audioPlayer;if(r&&r.audio&&(!r.audio.paused||r.audio.src))return r}for(t of i){var a=t.parentElement?.audioPlayer;if(a&&a.audio)return a}return null}getNextAudioIndex(e){var{audioFiles:t,isShuffle:e,currentIndex:i}=e;if(e){if(t.length<=1)return 0;{let e;for(;(e=Math.floor(Math.random()*t.length))===i&&1<t.length;);return e}}return i<t.length-1?i+1:0}getPreviousAudioIndex(e){var{audioFiles:t,isShuffle:e,currentIndex:i}=e;if(e){if(t.length<=1)return 0;{let e;for(;(e=Math.floor(Math.random()*t.length))===i&&1<t.length;);return e}}return 0<i?i-1:t.length-1}async playAudioInPlayer(e,t){var i,r,a;e.audioPlayer&&(require("path"),{audioFiles:a,loadAudio:i,audio:r}=e.audioPlayer,-1!==(a=a.findIndex(e=>e.path===t)))&&-1!==(e=e.audioPlayer.playOrder.indexOf(a))&&(await i(e),r.play())}async playVideoWithPriority(e){try{require("fs").existsSync(e)&&await this.showVideoInTab(e)}catch(e){}}async showVideoInTab(t){try{let e=this.app.workspace.getLeavesOfType(VIDEO_VIEW_TYPE)[0];e||await(e=this.app.workspace.getRightLeaf(!1)).setViewState({type:VIDEO_VIEW_TYPE,active:!0});var i=e.view;return i instanceof MediaVideoView&&i.setFilePath(t),this.app.workspace.revealLeaf(e),!0}catch(e){return!1}}async showCustomVideoPlayer(n){try{var s=document.querySelector(".media-browser-video-modal"),o=(s&&s.remove(),require("path")),l=o.basename(n),d=require("fs").readFileSync(n);let e="video/mp4";var c=o.extname(n).toLowerCase(),h=(".webm"===c?e="video/webm":".mov"===c?e="video/quicktime":".mkv"===c?e="video/x-matroska":".avi"===c?e="video/x-msvideo":".flv"===c?e="video/x-flv":".ogv"===c&&(e="video/ogg"),new Blob([d],{type:e})),p=URL.createObjectURL(h);let t=document.createElement("div");t.className="media-browser-video-modal",t.style.cssText=`
                position: fixed; z-index: 9999; left: 0; top: 0; width: 100vw; height: 100vh;
                background: rgba(0,0,0,0.55); display: flex; align-items: center; justify-content: center; backdrop-filter: blur(2px);`;var u=document.createElement("div"),m=(u.style.cssText="background: #222; border-radius: 12px; box-shadow: 0 8px 32px #0008; padding: 18px 18px 12px 18px; min-width: 320px; min-height: 180px; max-width: 90vw; max-height: 90vh; display: flex; flex-direction: column; align-items: center;",document.createElement("div"));m.textContent=l,m.style.cssText="color: #fff; font-size: 16px; margin-bottom: 10px; text-align: center; word-break: break-all;";let i=document.createElement("button"),r=(i.textContent="Ã—",i.title="å…³é—­",i.style.cssText="position: absolute; right: 24px; top: 18px; font-size: 28px; color: #fff; background: none; border: none; cursor: pointer; z-index: 10001;",i.onclick=()=>{r.src&&r.src.startsWith("blob:")&&URL.revokeObjectURL(r.src),t.remove()},document.createElement("video")),a=(r.src=p,r.controls=!0,r.autoplay=!0,r.style.cssText="max-width: 80vw; max-height: 70vh; border-radius: 8px; background: #000;",e=>{"Escape"===e.key&&i.onclick()});return setTimeout(()=>document.addEventListener("keydown",a),0),t.addEventListener("remove",()=>document.removeEventListener("keydown",a)),u.appendChild(m),u.appendChild(r),t.appendChild(u),t.appendChild(i),document.body.appendChild(t),t.addEventListener("click",e=>{e.target===t&&i.onclick()}),!0}catch(e){return!1}}handleBilibiliLink(e){try{var t=new URL(e.href),i=this.extractBilibiliVideoId(t),r=this.extractBilibiliTimestamp(t);i&&this.createBilibiliWebviewPlayer(i,r)}catch(e){}}extractBilibiliVideoId(t){var e;for(e of[/\/video\/(BV[a-zA-Z0-9]+)/,/\/video\/(av\d+)/]){var i=t.pathname.match(e);if(i){let e=i[1];i=t.searchParams.get("p");return e=i&&"1"!==i?e+"?p="+i:e}}return null}extractBilibiliTimestamp(e){var t=e.searchParams.get("t");if(t)return parseFloat(t);if(e.hash){t=e.hash.match(/t=(\d+(?:\.\d+)?)/);if(t)return parseFloat(t[1])}return 0}async createBilibiliWebviewPlayer(t,i=0){var e=`bilibili_${t}_`+i,r=Date.now();if(!(this.lastBilibiliCall&&this.lastBilibiliCall.key===e&&r-this.lastBilibiliCall.time<1e3)){this.lastBilibiliCall={key:e,time:r};try{let e=this.app.workspace.getLeavesOfType(VIDEO_VIEW_TYPE)[0];e||await(e=this.app.workspace.getRightLeaf(!1)).setViewState({type:VIDEO_VIEW_TYPE,active:!0});var a=e.view;a instanceof MediaVideoView&&await a.setBilibiliVideo(t,i),this.app.workspace.revealLeaf(e)}catch(e){}}}async addBilibiliTimestamp(i){try{let e=0;if(i.webview)try{var r=await i.webview.executeJavaScript(`
                        (() => {
                            const player = document.querySelector('#bilibili-player video');
                            if (player && !isNaN(player.currentTime) && !isNaN(player.duration)) {
                                return {
                                    currentTime: player.currentTime,
                                    duration: player.duration,
                                    paused: player.paused,
                                    readyState: player.readyState
                                };
                            }
                            return null;
                        })()
                    `);r&&"number"==typeof r.currentTime&&0<=r.currentTime&&(e=r.currentTime)}catch(e){}if(0===e)try{var a=await i.webview.executeJavaScript(`
                        (() => {
                            // å°è¯•å¤šç§æ–¹å¼è·å–æ—¶é—´
                            const player = document.querySelector('#bilibili-player video');
                            if (player && player.currentTime > 0) {
                                return player.currentTime;
                            }
                            
                            // å°è¯•ä»æ’­æ”¾å™¨UIè·å–æ—¶é—´
                            const timeElements = document.querySelectorAll('.bpx-player-ctrl-time, .bpx-player-ctrl-time-current');
                            for (const el of timeElements) {
                                const timeText = el.textContent.trim();
                                const timeMatch = timeText.match(/(d+):(d+)/);
                                if (timeMatch) {
                                    const minutes = parseInt(timeMatch[1]);
                                    const seconds = parseInt(timeMatch[2]);
                                    return minutes * 60 + seconds;
                                }
                            }
                            
                            return 0;
                        })()
                    `);a&&0<a&&(e=a)}catch(e){}0===e&&(e=i.bilibiliTimestamp||0);var n=Math.floor(e/60),s=Math.floor(e%60);let t;var o=`
[${n.toString().padStart(2,"0")+":"+s.toString().padStart(2,"0")}](${t=i.bilibiliVideoId.includes("?")?`https://www.bilibili.com/video/${i.bilibiliVideoId}&t=`+Math.floor(e):`https://www.bilibili.com/video/${i.bilibiliVideoId}?t=`+Math.floor(e)})ï¼š`,l=require("obsidian").MarkdownView,d=this.app.workspace.getActiveViewOfType(l);d&&d.editor&&d.editor.replaceSelection(o)}catch(e){}}async handleConvertedBilibiliLink(t){try{var i,r,a,n=t.closest("p, li, div");if(n)for(i of n.querySelectorAll("a"))if(i.href&&this.isBilibiliUrl(i.href))return void this.handleBilibiliLink(i);let e=this.app.workspace.getActiveFile();if(e||(r=this.app.workspace.activeLeaf?.view)&&r.file&&(e=r.file),!e)for(a of this.app.workspace.getLeavesOfType("markdown"))if(a.view&&a.view.file){e=a.view.file;break}if(e)try{var s=(await this.app.vault.read(e)).split("\n"),o=t.textContent.trim();for(let e=0;e<s.length;e++){var l=s[e],d=/bilibili\.com\/video\/(BV[a-zA-Z0-9]+|av\d+)/i.test(l)||/(^|\s|\[)(BV[a-zA-Z0-9]{10})(\s|\]|$|\))/i.test(l)||/(^|\s|\[)(av\d{1,12})(\s|\]|$|\))/i.test(l);if(l.includes(o)&&d){var c,h,p,u=this.extractBilibiliUrlFromText(l);if(u)return c=new URL(u),h=this.extractBilibiliVideoId(c),p=this.extractBilibiliTimestamp(c),h?void this.createBilibiliWebviewPlayer(h,p):void 0}}for(let e=0;e<s.length;e++){var m=s[e];if(m.includes(o)){var v,f,b,g=this.extractBilibiliUrlFromText(m);if(g)return v=new URL(g),f=this.extractBilibiliVideoId(v),b=this.extractBilibiliTimestamp(v),f?void this.createBilibiliWebviewPlayer(f,b):void 0}}}catch(e){}}catch(e){}}extractBilibiliUrlFromText(e){if(e){var i=[/\[([^\]]*)\]\(([^)]*bilibili\.com\/video\/[^)]*)\)/gi,/https?:\/\/(?:www\.)?bilibili\.com\/video\/[^\s\)\]\]]+/gi,/bilibili\.com\/video\/[^\s\)\]\]]+/gi,/(BV[a-zA-Z0-9]+)/gi,/(av\d+)/gi];for(let t=0;t<i.length;t++){var r=i[t],r=new RegExp(r.source,r.flags.replace("g","")),r=e.match(r);if(r){let e=r[0];return 0===t&&r[2]&&(e=r[2]),e=(e=3!==t&&4!==t?e:"https://www.bilibili.com/video/"+e).startsWith("http")||e.startsWith("https://")?e:"https://"+e}}}return null}}module.exports=MediaBrowserPlugin;