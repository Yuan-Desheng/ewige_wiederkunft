let{Plugin,Setting,Modal,Notice,requestUrl,PluginSettingTab}=require("obsidian"),OBFUSCATED_MAPPINGS={"obsidian-content-protection":"eGY5bVAydlI4blE1d0U3dFkxdUkzb0E2c0Q0Zkc=",checkContentProtectionStatus:"bU43YlYzeEM5ekwyUVc4ZVI1dFk2dUkxb1A0YVM=",checkContentProtectionFile:"cEw4a0o0aEc3ZkQzc0E5cVcyZVI2dFk1dUkxb00=",isActivated:"elg1Y1Y4Yk4ybVE3d0UzclQ5eVU0aU82cEExc0Q=",deviceId:"cVcyZVI1dFk4dUkzb1A2YVM5ZEY3Z0g0aks1bFo=",hasBeenActivated:"YVM0ZEY3Z0gyaks1bFo4eEMxdkI2bk05cVczZVI=",contentProtectionPlugin:"ZVI2dFk5dUkyb1A1YVM4ZEYxZ0g0aks3bFozeEM=",enabledPlugins:"dFkzdUk2b1A5YVMyZEY1Z0g4aks1bFo0eEM3dkI=",checkAndUpdateStatus:"Y2hlY2tBbmRVcGRhdGVTdGF0dXM=",ytmaps:"cE05YVc4ZFI2dEYxZ0k1aks3bFo0eEg=","1.3.0":"dFk5dUkzb1A2YVM4ZEY3Z0g0aks1bFo=",".obsidian/plugins/obsidian-content-protection/manifest.json":"bU43YlYzeEM5ekwyUVc4ZVI1dFk2dUkxb1A0YVM4ZEY3Z0g0aks1bFo0eEMxdkI2bk05cVczZVI=",".obsidian/plugins/obsidian-content-protection":"cEw4a0o0aEc3ZkQzc0E5cVcyZVI2dFk1dUkxb00zeEMxdkI2bk05cVczZVI="},OBFUSCATION_KEYS={primary:"ft2024$ecure#ey",secondary:"pr0t3ct!0n@2024",tertiary:"c0nt3nt$af3ty#k3y"},DECODE_ALGORITHMS=[{name:"charReverse",order:1,func:e=>e.split("").reverse().join("")},{name:"xorDecode",order:2,func:(t,i)=>{let s="";for(let e=0;e<t.length;e++)s+=String.fromCharCode(t.charCodeAt(e)^i.charCodeAt(e%i.length));return s}},{name:"base64Decode",order:3,func:t=>{try{return atob(t)}catch(e){return t}}}],globalDeobfuscators=null;function deobfuscateString(e){if(globalDeobfuscators){var t=globalDeobfuscators.get(e);if(t)try{return t()}catch(e){}}return e}function initObfuscationSystem(){try{let t=new Map;return Object.entries(OBFUSCATED_MAPPINGS).forEach(([e,i])=>{t.set(i,()=>{let t=i;return DECODE_ALGORITHMS.sort((e,t)=>t.order-e.order).forEach(e=>{t="xorDecode"===e.name?e.func(t,OBFUSCATION_KEYS.primary):e.func(t)}),e})}),globalDeobfuscators=t}catch(e){return new Map}}let MODEL_CATEGORIES={THINKING:"thinking",VISION:"vision",MULTIMODAL:"multimodal",TEXT:"text",IMAGE:"image"},CATEGORY_NAMES={[MODEL_CATEGORIES.THINKING]:"æ·±åº¦æ€è€ƒ",[MODEL_CATEGORIES.VISION]:"è§†è§‰ç†è§£",[MODEL_CATEGORIES.MULTIMODAL]:"å¤šæ¨¡æ€æ¨¡å‹",[MODEL_CATEGORIES.TEXT]:"æ–‡æœ¬ç”Ÿæˆ",[MODEL_CATEGORIES.IMAGE]:"å›¾ç‰‡ç”Ÿæˆ"},CATEGORY_ICONS={[MODEL_CATEGORIES.THINKING]:"ğŸ§ ",[MODEL_CATEGORIES.VISION]:"ğŸ‘ï¸",[MODEL_CATEGORIES.MULTIMODAL]:"ğŸ”€",[MODEL_CATEGORIES.TEXT]:"ğŸ“",[MODEL_CATEGORIES.IMAGE]:"ğŸ¨"},DEFAULT_MODEL_IDS=["claude-3.7-sonnet","claude-sonnet-4","gpt-4.1","gpt-5","dall-e-3","deepseek-chat","deepseek-reasoner","gemini-2.5-pro","gemini-2.5-flash","imagen-3.0-generate","kimi-k2-0905-preview","kimi-k2-thinking","doubao-seed-1-6-250615","doubao-seedream-3-0-t2i-250415","qwen-plus","qwen-vl-plus"],DEFAULT_SETTINGS={apiKey:"",baseUrl:"",model:"",providers:{openai:{apiKey:"",baseUrl:"https://api.openai.com/v1",enabled:!0,apiKeyLink:"https://platform.openai.com/api-keys"},anthropic:{apiKey:"",baseUrl:"https://api.anthropic.com/v1",enabled:!0,apiKeyLink:"https://console.anthropic.com/"},gemini:{apiKey:"",baseUrl:"https://generativelanguage.googleapis.com/v1beta/openai",enabled:!0,apiKeyLink:"https://aistudio.google.com/app/apikey"},deepseek:{apiKey:"",baseUrl:"https://api.deepseek.com/v1",enabled:!0,apiKeyLink:"https://platform.deepseek.com/api_keys"},ollama:{apiKey:"ollama",baseUrl:"http://localhost:11434/v1",enabled:!0},kimi:{apiKey:"",baseUrl:"https://api.moonshot.cn/v1",enabled:!0,apiKeyLink:"https://platform.moonshot.cn/console/api-keys"},doubao:{apiKey:"",baseUrl:"https://ark.cn-beijing.volces.com/api/v3/",enabled:!0,apiKeyLink:"https://console.volcengine.com/ark/region"},qwen:{apiKey:"",baseUrl:"https://dashscope.aliyuncs.com/compatible-mode/v1",enabled:!0,apiKeyLink:"https://bailian.console.aliyun.com/?tab=model#/api-key"}},models:{"claude-3.7-sonnet":{id:"claude-3.7-sonnet",name:"Claude 3.7 Sonnet",provider:"anthropic",model:"claude-3-7-sonnet-latest",actualModel:"claude-3-7-sonnet-latest",category:MODEL_CATEGORIES.TEXT,enabled:!0},"claude-sonnet-4":{id:"claude-sonnet-4",name:"Claude Sonnet 4",provider:"anthropic",model:"claude-sonnet-4-20250514",actualModel:"claude-sonnet-4-20250514",category:MODEL_CATEGORIES.TEXT,enabled:!0},"gpt-4.1":{id:"gpt-4.1",name:"GPT-4.1",provider:"openai",model:"gpt-4.1",actualModel:"gpt-4.1",category:MODEL_CATEGORIES.TEXT,enabled:!0},"gpt-5":{id:"gpt-5",name:"GPT-5",provider:"openai",model:"gpt-5",actualModel:"gpt-5",category:MODEL_CATEGORIES.TEXT,enabled:!0},"dall-e-3":{id:"dall-e-3",name:"DALL-E 3",provider:"openai",model:"dall-e-3",actualModel:"dall-e-3",category:MODEL_CATEGORIES.IMAGE,enabled:!0},"deepseek-chat":{id:"deepseek-chat",name:"DeepSeek Chat",provider:"deepseek",model:"deepseek-chat",actualModel:"deepseek-chat",category:MODEL_CATEGORIES.TEXT,enabled:!0},"deepseek-reasoner":{id:"deepseek-reasoner",name:"DeepSeek Reasoner",provider:"deepseek",model:"deepseek-reasoner",actualModel:"deepseek-reasoner",category:MODEL_CATEGORIES.THINKING,enabled:!0},"gemini-2.5-pro":{id:"gemini-2.5-pro",name:"Gemini 2.5 Pro",provider:"gemini",model:"gemini-2.5-pro",actualModel:"gemini-2.5-pro",category:MODEL_CATEGORIES.MULTIMODAL,enabled:!0},"gemini-2.5-flash":{id:"gemini-2.5-flash",name:"Gemini 2.5 Flash",provider:"gemini",model:"gemini-2.5-flash",actualModel:"gemini-2.5-flash",category:MODEL_CATEGORIES.MULTIMODAL,enabled:!0},"imagen-3.0-generate":{id:"imagen-3.0-generate",name:"Imagen 3.0 Generate",provider:"gemini",model:"imagen-3.0-generate-002",actualModel:"imagen-3.0-generate-002",category:MODEL_CATEGORIES.IMAGE,enabled:!0},"kimi-k2-0905-preview":{id:"kimi-k2-0905-preview",name:"Kimi K2",provider:"kimi",model:"kimi-k2-0905-preview",actualModel:"kimi-k2-0905-preview",category:MODEL_CATEGORIES.TEXT,enabled:!0},"kimi-k2-thinking":{id:"kimi-k2-thinking",name:"kimi-k2-thinking",provider:"kimi",model:"kimi-k2-thinking",actualModel:"kimi-k2-thinking",category:MODEL_CATEGORIES.THINKING,enabled:!0},"doubao-seed-1-6-250615":{id:"doubao-seed-1-6-250615",name:"Doubao Seed 1.6",provider:"doubao",model:"doubao-seed-1-6-250615",actualModel:"doubao-seed-1-6-250615",category:MODEL_CATEGORIES.THINKING,enabled:!0},"doubao-seedream-3-0-t2i-250415":{id:"doubao-seedream-3-0-t2i-250415",name:"Doubao Seedream 3.0",provider:"doubao",model:"doubao-seedream-3-0-t2i-250415",actualModel:"doubao-seedream-3-0-t2i-250415",category:MODEL_CATEGORIES.IMAGE,enabled:!0},"qwen-plus":{id:"qwen-plus",name:"qwen-plus",provider:"Qwen",model:"qwen-plus",actualModel:"qwen-plus",category:MODEL_CATEGORIES.TEXT,enabled:!0},"qwen-vl-plus":{id:"qwen-vl-plus",name:"qwen-vl-plus",provider:"Qwen",model:"qwen-vl-plus",actualModel:"qwen-vl-plus",category:MODEL_CATEGORIES.VISION,enabled:!0}},currentModel:"deepseek-chat",timeout:3e4,enableRightClick:!0,enableAtTrigger:!0,continueMode:"balanced",maxTokens:5e3,geminiReasoningEffort:"low",shortcuts:{continueText:"Ctrl+Shift+C"},commonPrompts:[{id:"expand",name:"æ‰©å±•å†…å®¹",content:"è¯·æ‰©å±•è¿™æ®µå†…å®¹ï¼Œå¢åŠ æ›´å¤šç»†èŠ‚å’Œä¾‹å­"},{id:"summarize",name:"æ€»ç»“æ¦‚æ‹¬",content:"è¯·æ€»ç»“è¿™æ®µå†…å®¹çš„è¦ç‚¹"},{id:"improve",name:"æ”¹è¿›æ–‡æœ¬",content:"è¯·æ”¹è¿›è¿™æ®µæ–‡æœ¬çš„è¡¨è¾¾å’Œé€»è¾‘"},{id:"translate",name:"ç¿»è¯‘",content:"è¯·å°†è¿™æ®µå†…å®¹ç¿»è¯‘æˆè‹±æ–‡"},{id:"continue",name:"ç»§ç»­å†™ä½œ",content:"è¯·æ ¹æ®ä¸Šä¸‹æ–‡ç»§ç»­å†™ä½œï¼Œä¿æŒé£æ ¼ä¸€è‡´"},{id:"RealisticsScenes",name:"ğŸŒ… é€¼çœŸåœºæ™¯",content:"ä¸€å¼ ä»¥[ç¯å¢ƒ]ä¸ºèƒŒæ™¯çš„ï¼Œå…·æœ‰[ä¸»ä½“]ã€[åŠ¨ä½œæˆ–è¡¨æƒ…]çš„é€¼çœŸ[é•œå¤´ç±»å‹]ç…§ç‰‡ã€‚åœºæ™¯ç”±[ç¯å…‰æè¿°]ç…§äº®ï¼Œè¥é€ [æƒ…ç»ª]æ°›å›´ã€‚ä½¿ç”¨[ç›¸æœº/é•œå¤´ç»†èŠ‚]æ‹æ‘„ï¼Œçªå‡º[å…³é”®çº¹ç†å’Œç»†èŠ‚]ã€‚å›¾åƒåº”é‡‡ç”¨[å®½é«˜æ¯”]æ ¼å¼ã€‚"},{id:"IllustrationsAndStickers",name:"ğŸŒ… é£æ ¼åŒ–æ’ç”»å’Œè´´çº¸",content:"ä¸€ä¸ª[ä¸»é¢˜]çš„[é£æ ¼]è´´çº¸ï¼ŒåŒ…å«[ä¸»è¦ç‰¹å¾]å’Œ[é…è‰²æ–¹æ¡ˆ]ã€‚è®¾è®¡åº”åŒ…å«[çº¿æ¡æ ·å¼]å’Œ[é˜´å½±æ ·å¼]ã€‚èƒŒæ™¯å¿…é¡»é€æ˜ã€‚"},{id:"PicturesWithText",name:"ğŸŒ… æ–‡å­—å›¾ç‰‡",content:'ä¸º[å“ç‰Œ/æ¦‚å¿µ]åˆ›å»º[å›¾ç‰‡ç±»å‹]ï¼Œå¹¶åœ¨[å­—ä½“æ ·å¼]ä¸­æ·»åŠ æ–‡æœ¬"[å¾…æ¸²æŸ“æ–‡æœ¬]"ã€‚è®¾è®¡åº”ä¸º[æ ·å¼æè¿°]ï¼Œå¹¶é‡‡ç”¨[é…è‰²æ–¹æ¡ˆ]ã€‚'},{id:"CommercialPhotography",name:"ğŸŒ… äº§å“æ¨¡å‹å’Œå•†ä¸šæ‘„å½±",content:"ä¸€å¼ é«˜åˆ†è¾¨ç‡ã€å·¥ä½œå®¤ç¯å…‰ä¸‹çš„äº§å“ç…§ç‰‡ï¼Œä»¥[äº§å“æè¿°]ä¸ºèƒŒæ™¯ï¼Œå±•ç°[èƒŒæ™¯è¡¨é¢/æè¿°]ã€‚ç¯å…‰é‡‡ç”¨[ç…§æ˜è®¾ç½®ï¼Œä¾‹å¦‚ä¸‰ç‚¹å¼æŸ”å…‰ç®±]ï¼Œä»¥è¾¾åˆ°[ç…§æ˜ç›®çš„]ã€‚æ‹æ‘„è§’åº¦é‡‡ç”¨[è§’åº¦ç±»å‹]ï¼Œä»¥å±•ç°[ç‰¹å®šåŠŸèƒ½]ã€‚è¶…é€¼çœŸï¼Œæ¸…æ™°å¯¹ç„¦[å…³é”®ç»†èŠ‚]ã€‚[å®½é«˜æ¯”]ã€‚"}],globalRules:[{id:"rule_1755530387418_hqeo7cahl",name:"æ•°å­¦å…¬å¼æ ¼å¼",content:"å…¬å¼éœ€è¦éµå¾ªä»¥ä¸‹Latexæ ¼å¼ï¼Œå¹¶ä¸”åªè¾“å‡ºå…¬å¼æœ¬èº«ï¼ˆå‰å$ä»¥åŠåŒ…è£¹çš„å†…å®¹ï¼Œ$ç¬¦å·ä¸åŒ…è£¹çš„å†…å®¹ä¹‹é—´ä¸èƒ½æœ‰ç©ºæ ¼ï¼‰ï¼Œæœªæ˜ç¡®è¾“å…¥å…¬å¼ä¸ºå•è¡Œæˆ–å¤šè¡Œæ—¶ï¼Œé»˜è®¤ä½¿ç”¨å•è¡Œå…¬å¼\nå•è¡Œå…¬å¼ï¼š$å…¬å¼$\nå¤šè¡Œå…¬å¼ï¼š\n$$\nå…¬å¼\n$$",description:"é‡‡ç”¨Latexæ ¼å¼",category:"format",priority:9,enabled:!0,createdAt:1755530387418,updatedAt:1755533815951},{id:"rule_1755532985773_lk0ybaxay",name:"YAMLæ ¼å¼",content:"è‹¥ç¬”è®°ä¸­é¡¶éƒ¨ä½ç½®åŒ…å«YAMLåŒºåŸŸï¼ˆå‰å---ç¬¦å·åŒ…è£¹ï¼‰ï¼Œåœ¨è¾“å‡ºå†…å®¹æ—¶ï¼Œéœ€è¦ä¿æŒYAMLåŒºåŸŸå‰åçš„---ç¬¦å·ä¸å˜",description:"YAMLæ ¼å¼",category:"format",priority:9,enabled:!0,createdAt:1755532985773,updatedAt:1755532985773},{id:"rule_1755533236905_yik6ximru",name:"å±æ€§å­—æ®µæ ¼å¼",content:"YAMLåŒºåŸŸå†…çš„å­—æ®µï¼Œå¦‚æœåŒ…å«tagsã€aliasesã€cssclasseså­—æ®µï¼Œå…¶å­—æ®µå€¼å¿…é¡»é‡‡ç”¨æ— åºåˆ—è¡¨æ•°ç»„æ ¼å¼ï¼ˆå…¶ä¸­cssclasseså­—æ®µå€¼ä¸è¦ä¿®æ”¹ï¼‰ï¼Œä¾‹å¦‚ï¼š\ntags: \n - æ ‡ç­¾1\n - æ ‡ç­¾2\n\naliases:\n - åˆ«å1\n - åˆ«å2",description:"tagsã€aliasesã€cssclasseså±æ€§",category:"format",priority:9,enabled:!0,createdAt:1755533236905,updatedAt:1755533637754},{id:"rule_1755534125515_lbwla58f9",name:"ä»£ç å—å†…å®¹å¤„ç†",content:"é™¤éæç¤ºè¯æ˜ç¡®è¦æ±‚ä¿®æ”¹ä»£ç å†…å®¹ï¼Œå¦åˆ™å‰å```ç¬¦å·åŒ…è£¹çš„ä»£ç å—å†…å®¹ï¼ˆä¹Ÿå¯èƒ½æ˜¯å¤šä¸ªåå¼•å·ä»£ç å—åŒ…è£¹çš„å†…å®¹ï¼‰ï¼Œä¸å…è®¸ä¿®æ”¹",description:"",category:"custom",priority:9,enabled:!0,createdAt:1755534125515,updatedAt:1755534186528},{id:"rule_1755575228972_f3aunhozx",name:"è¯­è¨€è®¾ç½®",content:"è¯·ä½¿ç”¨ç®€ä½“ä¸­æ–‡å›å¤",description:"",category:"language",priority:9,enabled:!0,createdAt:1755575228972,updatedAt:1755575238871}],enableGlobalRules:!0,ruleTemplates:[{id:"writing-style-formal",name:"æ­£å¼å†™ä½œé£æ ¼",description:"ä½¿ç”¨æ­£å¼ã€ä¸“ä¸šçš„å†™ä½œé£æ ¼",content:"è¯·ä½¿ç”¨æ­£å¼ã€ä¸“ä¸šçš„è¯­è¨€é£æ ¼ï¼Œé¿å…å£è¯­åŒ–è¡¨è¾¾ï¼Œç¡®ä¿é€»è¾‘æ¸…æ™°ã€è¡¨è¾¾å‡†ç¡®ã€‚",category:"writing"},{id:"writing-style-casual",name:"è½»æ¾å†™ä½œé£æ ¼",description:"ä½¿ç”¨è½»æ¾ã€å‹å¥½çš„å†™ä½œé£æ ¼",content:"è¯·ä½¿ç”¨è½»æ¾ã€å‹å¥½çš„è¯­è¨€é£æ ¼ï¼Œå¯ä»¥é€‚å½“ä½¿ç”¨å£è¯­åŒ–è¡¨è¾¾ï¼Œè®©å†…å®¹æ›´åŠ äº²åˆ‡æ˜“æ‡‚ã€‚",category:"writing"},{id:"format-markdown",name:"Markdownæ ¼å¼",description:"ç¡®ä¿è¾“å‡ºç¬¦åˆMarkdownæ ¼å¼è§„èŒƒ",content:"è¯·ç¡®ä¿è¾“å‡ºå†…å®¹ç¬¦åˆMarkdownæ ¼å¼è§„èŒƒï¼Œæ­£ç¡®ä½¿ç”¨æ ‡é¢˜ã€åˆ—è¡¨ã€ä»£ç å—ç­‰æ ¼å¼ã€‚",category:"format"},{id:"content-detailed",name:"è¯¦ç»†è¯´æ˜",description:"æä¾›è¯¦ç»†çš„è¯´æ˜å’Œä¾‹å­",content:"è¯·æä¾›è¯¦ç»†çš„è¯´æ˜ï¼ŒåŒ…å«å…·ä½“çš„ä¾‹å­å’Œå®é™…åº”ç”¨åœºæ™¯ï¼Œå¸®åŠ©è¯»è€…æ›´å¥½åœ°ç†è§£ã€‚",category:"writing"},{id:"language-chinese",name:"ä¸­æ–‡è¾“å‡º",description:"ç¡®ä¿è¾“å‡ºä¸ºç®€ä½“ä¸­æ–‡",content:"è¯·ç¡®ä¿æ‰€æœ‰è¾“å‡ºå†…å®¹éƒ½ä½¿ç”¨ç®€ä½“ä¸­æ–‡ï¼Œè¡¨è¾¾è¦ç¬¦åˆä¸­æ–‡çš„è¯­è¨€ä¹ æƒ¯ã€‚",category:"language"}],imageSavePath:"Extras/é™„ä»¶",imageSize:300,imageGenerationSize:"1024x1024",guidanceScale:2.5,maxContextLines:20,maxContextChars:3e3},SYSTEM_PROMPTS={continue:"ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„å†™ä½œåŠ©æ‰‹ã€‚è¯·æ ¹æ®ç”¨æˆ·æä¾›çš„ä¸Šä¸‹æ–‡ï¼Œä»å…‰æ ‡ä½ç½®å¼€å§‹ç»­å†™åç»­å†…å®¹ã€‚é‡è¦ï¼šåªç”Ÿæˆæ–°çš„å†…å®¹ï¼Œä¸è¦é‡å¤æˆ–é‡å†™å·²æœ‰çš„å†…å®¹ã€‚"};class AIService{constructor(e,t){this.settings=e,this.app=t,this.requestQueue=[],this.isProcessing=!1}updateSettings(e){this.settings=e}getCurrentModelConfig(){if(this.settings.apiKey&&this.settings.baseUrl&&this.settings.model)return{apiKey:this.settings.apiKey,baseUrl:this.settings.baseUrl,model:this.settings.model};var e=this.settings.currentModel;if(!e)throw new Error("æœªé€‰æ‹©å½“å‰æ¨¡å‹");var t=this.settings.models[e];if(!t||!t.enabled)throw new Error(`æ¨¡å‹ ${e} æœªå¯ç”¨æˆ–ä¸å­˜åœ¨`);e=this.settings.providers[t.provider];if(e&&e.enabled)return{apiKey:e.apiKey,baseUrl:e.baseUrl,model:t.actualModel||t.model||t.id};throw new Error(`ä¾›åº”å•† ${t.provider} æœªå¯ç”¨æˆ–ä¸å­˜åœ¨`)}isVisionModel(e){var t=this.settings.currentModel,t=this.settings.models[t];if(!t)return!1;let i=t.category;return(i=!i&&t.type?"image"===t.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT:i)===MODEL_CATEGORIES.VISION}isOpenAI(){let t=this.getCurrentModelConfig();var e;return!!t.baseUrl&&!t.baseUrl.includes("generativelanguage.googleapis.com")&&(!(!t.baseUrl.includes("api.openai.com")&&!t.baseUrl.includes("openai.com"))||(e=this.settings.currentModel,!(!(e=this.settings.models[e])||"openai"!==e.provider))||["/v1","chat/completions","images/generations"].some(e=>t.baseUrl.includes(e))||t.baseUrl.endsWith("/v1"))}isGemini(){var e=this.getCurrentModelConfig();return e.baseUrl&&e.baseUrl.includes("generativelanguage.googleapis.com")}isThinkingModel(e=0){var t=this.settings.currentModel,t=this.settings.models[t];if(!t)return!1;let i=t.category;return(i=!i&&t.type?"image"===t.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT:i)===MODEL_CATEGORIES.THINKING}normalizeBaseUrl(e){return e?e.replace(/\/$/,""):""}buildApiUrl(t){var i=this.getCurrentModelConfig(),i=this.normalizeBaseUrl(i.baseUrl),s=i.includes("api.openai.com"),e=i.includes("generativelanguage.googleapis.com"),n=i.includes("volces.com"),l=this.settings.currentModel,l=this.settings.models[l],l=l?l.provider:null;if(n){let e;return e=i.endsWith("/api/v3")?""+i+t:i.endsWith("/api/v3/")?""+i.slice(0,-1)+t:i+"/api/v3"+t}if(this.isOpenAI()||"openai"===l){let e;return e=i.endsWith("/v1")?""+i+t:!s&&(i.includes("/chat/completions")||i.includes("/images/generations"))?""+i.split("/chat/completions")[0].split("/images/generations")[0]+t:i+"/v1"+t}if(this.isGemini()&&e)return""+i+t;if("gemini"!==l||e){let e;return e=i.endsWith("/v1")?""+i+t:i+"/v1"+t}{let e;return e=i.endsWith("/v1")?""+i+t:i+"/v1"+t}}async sendRequest(e,t,i="",s=[],n=[],l=null){var o=this.getCurrentModelConfig();if(!o.apiKey)throw new Error("è¯·å…ˆé…ç½®API Key");var a=this.settings.currentModel,a=this.settings.models[a];let r=a?.category;if(!r&&a&&(r="image"===a.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT,a.category=r,await this.saveSettings()),r===MODEL_CATEGORIES.IMAGE){if("continue"===e&&t.selectedText&&t.selectedText.trim())throw new Error("AIåŸæ–‡ä¿®æ”¹æ¨¡å¼ä¸æ”¯æŒå›¾ç‰‡ç”Ÿæˆæ¨¡å‹ï¼Œè¯·é€‰æ‹©æ–‡æœ¬ç”Ÿæˆæ¨¡å‹è¿›è¡Œæ–‡æœ¬ä¿®æ”¹ã€‚");return this.handleImageGeneration(i,o,t.cursorPosition)}r!==MODEL_CATEGORIES.THINKING&&this.isThinkingModel(o.model);var a=l&&"function"==typeof l,d=r===MODEL_CATEGORIES.MULTIMODAL,c=r===MODEL_CATEGORIES.VISION||this.isVisionModel(o.model);s&&0<s.length&&!(d||c)&&(new Notice(`å½“å‰æ¨¡å‹ ${o.model} ä¸æ”¯æŒå›¾ç‰‡å’Œé™„ä»¶ï¼Œè¯·åˆ‡æ¢åˆ°å¤šæ¨¡æ€æ¨¡å‹æˆ–è§†è§‰æ¨¡å‹`),s=[]);let p=SYSTEM_PROMPTS[e],h=(this.settings.enableGlobalRules&&this.settings.globalRules&&0<this.settings.globalRules.length&&0<(d=this.settings.globalRules.filter(e=>!1!==e.enabled).sort((e,t)=>(t.priority||0)-(e.priority||0))).length&&(c=d.map(e=>e.content).join("\n"),p+="\n\nå…¨å±€è§„åˆ™ï¼ˆè¯·ä¸¥æ ¼éµå¾ªä»¥ä¸‹è§„åˆ™ï¼‰ï¼š\n"+c),""),u=("continue"===e?h=t.selectedText&&t.selectedText.trim()?`éœ€è¦ä¿®æ”¹çš„å®Œæ•´å†…å®¹ï¼š${t.selectedText}

ä¿®æ”¹è¦æ±‚ï¼š`+i:`ä»¥ä¸‹æ˜¯å…‰æ ‡å‰çš„ä¸Šä¸‹æ–‡å†…å®¹ï¼š
${t.beforeText}

è¯·ä»å…‰æ ‡ä½ç½®å¼€å§‹ç»­å†™ï¼Œåªç”Ÿæˆæ–°å†…å®¹ï¼Œä¸è¦é‡å¤ä¸Šè¿°å†…å®¹ã€‚ç»­å†™è¦æ±‚ï¼š`+i:(h=`ä¸Šä¸‹æ–‡ï¼š${t.beforeText}

é€‰ä¸­æ–‡æœ¬ï¼š${t.selectedText}

åç»­å†…å®¹ï¼š`+t.afterText,i&&(h+=`

ç‰¹æ®Šè¦æ±‚ï¼š`+i)),t.additionalContext&&t.additionalContext.trim()&&(h+=`

ã€é‡è¦æç¤ºï¼šä»¥ä¸‹æ˜¯å¿…é¡»å‚è€ƒçš„æ–‡æ¡£å†…å®¹ï¼Œè¯·åŠ¡å¿…åŸºäºè¿™äº›å†…å®¹è¿›è¡Œå›å¤ï¼Œä¸å¾—å¿½ç•¥ã€‘

=== å¿…è¯»å‚è€ƒæ–‡æ¡£ ===
${t.additionalContext}
=== å‚è€ƒæ–‡æ¡£ç»“æŸ ===

ã€è¯·ç¡®ä¿ä½ çš„å›å¤å®Œå…¨åŸºäºä¸Šè¿°æ–‡æ¡£å†…å®¹ï¼Œå¿…é¡»å¼•ç”¨å’Œä½¿ç”¨æ–‡æ¡£ä¸­çš„ä¿¡æ¯ã€‘`),t.contextContent&&t.contextContent.trim()&&(h+=`

ã€é‡è¦æç¤ºï¼šä»¥ä¸‹æ˜¯å¿…é¡»å‚è€ƒçš„æ–‡æ¡£å†…å®¹ï¼Œè¯·åŠ¡å¿…åŸºäºè¿™äº›å†…å®¹è¿›è¡Œå›å¤ï¼Œä¸å¾—å¿½ç•¥ã€‘

=== å¿…è¯»å‚è€ƒæ–‡æ¡£ ===
${t.contextContent}
=== å‚è€ƒæ–‡æ¡£ç»“æŸ ===

ã€è¯·ç¡®ä¿ä½ çš„å›å¤å®Œå…¨åŸºäºä¸Šè¿°æ–‡æ¡£å†…å®¹ï¼Œå¿…é¡»å¼•ç”¨å’Œä½¿ç”¨æ–‡æ¡£ä¸­çš„ä¿¡æ¯ã€‘`),d=this.buildApiUrl("/chat/completions"),[{role:"system",content:p}]);if(n&&0<n.length&&n.forEach(e=>{"user"!==e.role&&"assistant"!==e.role||u.push({role:e.role,content:e.content})}),s&&0<s.length){let i=[{type:"text",text:h+=`

é™„åŠ å›¾ç‰‡ï¼šå…±${s.length}å¼ å›¾ç‰‡`}];s.forEach((e,t)=>{i.push({type:"image_url",image_url:{url:e.base64||e.url}})}),u.push({role:"user",content:i})}else u.push({role:"user",content:h});c={model:o.model,messages:u,temperature:.7,max_tokens:this.getMaxTokens(e)},this.isGemini()&&(i=this.settings.geminiReasoningEffort||"low")&&"none"!==i&&(c.reasoning_effort=i),a&&(c.stream=!0);try{var g={"Content-Type":"application/json"};if(g.Authorization="Bearer "+o.apiKey,a)return await this.handleStreamRequest(d,g,c,l);var m,v=await requestUrl({url:d,method:"POST",headers:g,body:JSON.stringify(c),throw:!1});if(200!==v.status){if(429===v.status)throw(m=v.text).includes("quota")||m.includes("insufficient_quota")?new Error("APIé…é¢å·²ç”¨å®Œï¼Œè¯·æ£€æŸ¥æ‚¨çš„è´¦æˆ·ä½™é¢å’Œè®¡è´¹è¯¦æƒ…ã€‚"):new Error("APIè¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•ã€‚");throw new Error(`APIè¯·æ±‚å¤±è´¥: ${v.status} `+v.text)}var x=v.json;if(!x.choices||0===x.choices.length)throw new Error("APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘choicesæ•°ç»„");var w=x.choices[0];if(!w.message)throw new Error("APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼šç¼ºå°‘messageå¯¹è±¡");let e="";if(w.message.content)e=w.message.content.trim();else if(w.text)e=w.text.trim();else{if(!w.message.text)throw new Error("APIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯ï¼šæ‰¾ä¸åˆ°å†…å®¹å­—æ®µ");e=w.message.text.trim()}return x.usage&&w.finish_reason,{content:e,usage:x.usage||{}}}catch(e){throw e}}getMaxTokens(e){return this.settings.maxTokens||DEFAULT_SETTINGS.maxTokens}async handleStreamRequest(n,l,o,a){try{var r=await fetch(n,{method:"POST",headers:l,body:JSON.stringify(o)});if(!r.ok){var d=await r.text();if(429===r.status)throw d.includes("quota")||d.includes("insufficient_quota")?new Error("APIé…é¢å·²ç”¨å®Œï¼Œè¯·æ£€æŸ¥æ‚¨çš„è´¦æˆ·ä½™é¢å’Œè®¡è´¹è¯¦æƒ…ã€‚"):new Error("APIè¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•ã€‚");throw new Error(`APIè¯·æ±‚å¤±è´¥: ${r.status} `+d)}var c=r.body.getReader(),p=new TextDecoder;let e="",t="",i="",s="";this.getCurrentModelConfig();var h=this.settings.currentModel;this.settings.models[h]?.provider;try{for(;;){var{done:u,value:g}=await c.read();if(u)break;var m,v=(e+=p.decode(g,{stream:!0})).split("\n");e=v.pop()||"";for(m of v)if(m.startsWith("data: ")){var x=m.slice(6);if("[DONE]"===x)break;try{var w,E,f,y=JSON.parse(x).choices?.[0]?.delta;y?.reasoning_content&&(w=y.reasoning_content,i+=w,t+=w,a({content:s,thinking:i,fullContent:t,isComplete:!1})),y?.content&&(E=y.content,s+=E,t+=E,a({content:s,thinking:i,fullContent:t,isComplete:!1})),y?.text&&(f=y.text,s+=f,t+=f,a({content:s,thinking:i,fullContent:t,isComplete:!1}))}catch(e){}}}return a({content:s,thinking:i,fullContent:t,isComplete:!0}),{content:s.trim(),thinking:i.trim(),usage:{}}}finally{c.releaseLock()}}catch(e){throw e}}async handleImageGeneration(s,e,n=null){if(!s||!s.trim())throw new Error("è¯·è¾“å…¥å›¾ç‰‡æè¿°");var t=this.buildApiUrl("/images/generations"),i=this.settings.currentModel,i=this.settings.models[i],l=e.baseUrl.includes("api.openai.com"),o=e.baseUrl.includes("generativelanguage.googleapis.com"),a=e.baseUrl.includes("volces.com"),l=!l&&!o&&!a;let r=e.model;a={model:r=l&&(o=this.getRecommendedImageModelForThirdParty(i))?o.model:r,prompt:s.trim(),response_format:"b64_json",n:1,watermark:!1,size:this.settings.imageGenerationSize||"1024x1024",guidance_scale:this.settings.guidanceScale||2.5};r.includes("dall-e")&&"dall-e-3"===r&&(a.quality="standard",a.style="vivid"),r.includes("doubao")||r.includes("seedream");try{e.apiKey.substring(0,10);var d=await requestUrl({url:t,method:"POST",headers:{"Content-Type":"application/json",Authorization:"Bearer "+e.apiKey},body:JSON.stringify(a),throw:!1});if(200!==d.status){var c,p,h,u=d.text;if(429===d.status)throw u.includes("quota")||u.includes("insufficient_quota")?new Error("APIé…é¢å·²ç”¨å®Œï¼Œè¯·æ£€æŸ¥æ‚¨çš„è´¦æˆ·ä½™é¢å’Œè®¡è´¹è¯¦æƒ…ã€‚"):new Error("APIè¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åå†è¯•ã€‚");if(503===d.status)throw u.includes("æ— å¯ç”¨æ¸ é“")||u.includes("ä»¤ç‰Œåˆ†ç»„")?(c=this.getAvailableImageModels().filter(e=>e!==r),p=l?`ç¬¬ä¸‰æ–¹APIæœåŠ¡å•†ä¸æ”¯æŒæ¨¡å‹${r}ï¼Œå»ºè®®åˆ‡æ¢åˆ°ï¼š`+c.join("ã€"):`å½“å‰æ¨¡å‹ ${r} æš‚æ—¶ä¸å¯ç”¨ï¼Œå»ºè®®å°è¯•å…¶ä»–å›¾ç‰‡ç”Ÿæˆæ¨¡å‹ï¼š`+c.join("ã€"),0<c.length?new Error(p):new Error(`å½“å‰æ¨¡å‹ ${r} æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚`)):new Error(l?"ç¬¬ä¸‰æ–¹APIå›¾ç‰‡ç”ŸæˆæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚":"å›¾ç‰‡ç”ŸæˆæœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•ã€‚");if(400===d.status)throw u.includes("prompt")?new Error("å›¾ç‰‡æè¿°ä¸ç¬¦åˆè¦æ±‚ï¼Œè¯·ä¿®æ”¹åé‡è¯•ã€‚"):l&&u.includes("model")?(h=this.getAvailableImageModels().filter(e=>e.includes("DALL-E")).join("ã€"),new Error("ç¬¬ä¸‰æ–¹APIä¸æ”¯æŒå½“å‰æ¨¡å‹ï¼Œå»ºè®®ä½¿ç”¨ï¼š"+h)):new Error("è¯·æ±‚å‚æ•°é”™è¯¯ï¼Œè¯·æ£€æŸ¥è¾“å…¥å†…å®¹ã€‚");if(401===d.status)throw new Error("APIå¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥é…ç½®ã€‚");if(404===d.status)throw new Error(l?"ç¬¬ä¸‰æ–¹APIç«¯ç‚¹ä¸å­˜åœ¨ï¼Œè¯·æ£€æŸ¥baseURLé…ç½®æ˜¯å¦æ­£ç¡®":"å›¾ç‰‡ç”Ÿæˆæ¨¡å‹ä¸å­˜åœ¨ï¼Œè¯·é€‰æ‹©å…¶ä»–æ¨¡å‹ã€‚");var g=`å›¾ç‰‡ç”ŸæˆAPIè¯·æ±‚å¤±è´¥: ${d.status} `+u;throw new Error(l?"ç¬¬ä¸‰æ–¹API"+g:g)}var m=d.json;if(!m.data||!Array.isArray(m.data)||0===m.data.length)throw new Error("å›¾ç‰‡ç”ŸæˆAPIè¿”å›æ•°æ®æ ¼å¼é”™è¯¯");var v=m.data[0],x=r.includes("doubao")||r.includes("seedream");let i=null;if(v.b64_json)i=v.b64_json;else{if(!v.url||!x)throw new Error("å›¾ç‰‡ç”ŸæˆAPIè¿”å›æ•°æ®ä¸­ç¼ºå°‘å›¾ç‰‡å†…å®¹");try{var w=await requestUrl({url:v.url,method:"GET",throw:!1});if(200!==w.status)throw new Error("ä¸‹è½½è±†åŒ…ç”Ÿæˆçš„å›¾ç‰‡å¤±è´¥: "+w.status);{var E=w.arrayBuffer,f=new Uint8Array(E);let t="";for(let e=0;e<f.length;e++)t+=String.fromCharCode(f[e]);i=btoa(t)}}catch(e){throw new Error("è±†åŒ…å›¾ç‰‡ä¸‹è½½å¤±è´¥: "+e.message)}}try{var y=`image_${Date.now()}.png`,b=this.settings.imageSavePath||"Extras/é™„ä»¶",k=b+"/"+y;try{this.app.vault.getAbstractFileByPath(b)||await this.app.vault.createFolder(b)}catch(e){try{await this.app.vault.adapter.mkdir(b)}catch(e){throw new Error(`æ— æ³•åˆ›å»ºç›®å½• ${b}: `+e.message)}}var S=atob(i),T=new Uint8Array(S.length);for(let e=0;e<S.length;e++)T[e]=S.charCodeAt(e);await this.app.vault.createBinary(k,T.buffer);var A=this.settings.imageSize||300;let e=!0;n&&0<n.ch&&(e=!1);let t;return{content:t=e?`![Generated Image|${A}](${k})`:`<span class="image-mask-rounded-R" style="width: 200px; height: 200px;"><img src="${k}" alt="" style="width: 100%; height: 100%; object-fit: cover;"></span>`,imageData:{filePath:k,format:"png",prompt:s},usage:m.usage||{}}}catch(e){throw new Error("å›¾ç‰‡ä¿å­˜å¤±è´¥: "+e.message)}}catch(e){throw e}}getAvailableImageModels(){var e,t,i=[];for([e,t]of Object.entries(this.settings.models))"image"===t.type&&t.enabled&&i.push(t.name||e);return i}getRecommendedImageModelForThirdParty(t=null){if(t&&t.provider){var i;let e=[];switch(t.provider){case"openai":e=["dall-e-3","dall-e-2"];break;case"gemini":case"google":e=["imagen-3.0-generate","imagen-2.0-generate","dall-e-3","dall-e-2"];break;case"doubao":case"volces":e=["doubao-seedream-3-0-t2i-250415","dall-e-3","dall-e-2"];break;default:e=["dall-e-3","dall-e-2"]}for(i of e){var s=this.settings.models[i];if(s&&s.enabled&&"image"===s.type)return{id:i,model:s.actualModel||s.model||i,name:s.name}}}var e,n,l;for(e of["dall-e-3","dall-e-2"]){var o=this.settings.models[e];if(o&&o.enabled&&"image"===o.type)return{id:e,model:o.actualModel||o.model||e,name:o.name}}for([n,l]of Object.entries(this.settings.models))if("image"===l.type&&l.enabled)return{id:n,model:l.actualModel||l.model||n,name:l.name};return null}async testConnection(){try{await this.sendRequest("continue",{selectedText:"æµ‹è¯•æ–‡æœ¬",beforeText:"",afterText:""},"",[],[]);return{success:!0,message:"APIè¿æ¥æˆåŠŸ"}}catch(e){return{success:!1,message:e.message}}}}class TextContextExtractor{static getContext(e,i=null,s=null){var n=e.getCursor(),l=e.getDoc(),o=l.lineCount();let t="",a="",r="";if(i){if(t=i,e.getSelection()){var d=e.getCursor("from"),i=e.getCursor("to");for(let e=Math.max(0,d.line-2);e<d.line;e++)a+=l.getLine(e)+"\n";a+=l.getLine(d.line).substring(0,d.ch),r=l.getLine(i.line).substring(i.ch);var c=Math.min(o,i.line+3);for(let e=i.line+1;e<c;e++)r+="\n"+l.getLine(e)}}else{i=(s&&s.maxContextLines?s:DEFAULT_SETTINGS).maxContextLines,s=(s&&s.maxContextChars?s:DEFAULT_SETTINGS).maxContextChars;let t="";for(let e=Math.max(0,n.line-i);e<n.line;e++)t+=l.getLine(e)+"\n";t+=l.getLine(n.line).substring(0,n.ch),a=t.length>s?"..."+t.substring(t.length-s):t,r=l.getLine(n.line).substring(n.ch);var p=Math.min(o,n.line+5);for(let e=n.line+1;e<p;e++)r+="\n"+l.getLine(e);1e3<r.length&&(r=r.substring(0,1e3)+"...")}return{selectedText:t.trim(),beforeText:a.trim(),afterText:r.trim(),cursorPosition:n,filePath:e.getDoc().getValue(),lineNumber:n.line}}}class ImageHandler{constructor(){this.images=[],this.maxFileSize=10485760,this.allowedTypes=["image/jpeg","image/png","image/gif","image/webp"]}handlePaste(t,i){var s=t.clipboardData?.items;if(s)for(let e=0;e<s.length;e++){var n=s[e];if(-1!==n.type.indexOf("image")){t.preventDefault();n=n.getAsFile();n&&this.processImageFile(n,i);break}}}handleFileSelect(e,t){for(var i of e)this.allowedTypes.includes(i.type)?this.processImageFile(i,t):new Notice("ä¸æ”¯æŒçš„æ–‡ä»¶ç±»å‹: "+i.type)}processImageFile(t,i){var e;t.size>this.maxFileSize?new Notice("å›¾ç‰‡æ–‡ä»¶è¿‡å¤§ï¼Œè¯·é€‰æ‹©å°äº10MBçš„å›¾ç‰‡"):((e=new FileReader).onload=e=>{e={id:Date.now()+Math.random(),name:t.name,size:t.size,type:t.type,base64:e.target.result,url:e.target.result};this.images.push(e),i&&i(e)},e.onerror=()=>{},e.readAsDataURL(t))}removeImage(t,e){this.images=this.images.filter(e=>e.id!==t),e&&e(t)}getImages(){return this.images}clearImages(){this.images=[]}createImagePreview(t,i){let s=document.createElement("div");return s.className="flowtext-image-preview",s.setAttribute("data-image-id",t.id),s.innerHTML=`
			<div class="flowtext-image-container">
				<img src="${t.url}" alt="${t.name}" class="flowtext-preview-img">
				<button class="flowtext-remove-image" title="åˆ é™¤å›¾ç‰‡">âœ•</button>
			</div>
			<div class="flowtext-image-info">
				<span class="flowtext-image-name">${t.name}</span>
				<span class="flowtext-image-size">${this.formatFileSize(t.size)}</span>
			</div>
		`,s.querySelector(".flowtext-remove-image").onclick=e=>{e.stopPropagation(),this.removeImage(t.id,i),s.remove()},s}formatFileSize(e){var t;return 0===e?"0 Bytes":(t=Math.floor(Math.log(e)/Math.log(1024)),parseFloat((e/Math.pow(1024,t)).toFixed(2))+" "+["Bytes","KB","MB","GB"][t])}}class InputContextSelector{constructor(e,t,i){this.app=e,this.inputEl=t,this.onSelect=i,this.suggestionEl=null,this.isOpen=!1,this.selectedIndex=0,this.items=[],this.searchQuery="",this.atPosition=0,this.selectedTags=[]}convertToContentEditable(){var e;"TEXTAREA"===this.inputEl.tagName&&((e=document.createElement("div")).className=this.inputEl.className+" flowtext-editable-input",e.contentEditable="true",e.setAttribute("data-placeholder",this.inputEl.placeholder),e.style.minHeight="80px",e.style.maxHeight="300px",e.style.overflowY="auto",e.textContent=this.inputEl.value,this.inputEl.parentNode.replaceChild(e,this.inputEl),this.inputEl=e,this.updatePlaceholder(),e.addEventListener("input",()=>this.updatePlaceholder()))}updatePlaceholder(){""===this.inputEl.textContent.trim()&&0===this.inputEl.querySelectorAll(".flowtext-inline-tag").length?this.inputEl.classList.add("empty"):this.inputEl.classList.remove("empty")}getTextContent(){let i="";return this.inputEl.childNodes.forEach(e=>{var t;e.nodeType===Node.TEXT_NODE?i+=e.textContent:e.classList&&e.classList.contains("flowtext-inline-tag")&&(t=e.getAttribute("data-type"),e=e.getAttribute("data-path"),i+=`@[${t}:${e}]`)}),i}getCursorPosition(){var e,t=window.getSelection();if(!t.rangeCount)return 0;let s=t.getRangeAt(0),n=0,l=e=>{if(e===s.endContainer)return n+=s.endOffset,!0;if(e.nodeType===Node.TEXT_NODE)n+=e.textContent.length;else if(e.nodeType===Node.ELEMENT_NODE)if(e.classList&&e.classList.contains("flowtext-inline-tag")){var t=`@[${e.getAttribute("data-type")}:${e.getAttribute("data-path")}]`;n+=t.length}else for(var i of e.childNodes)if(l(i))return!0;return!1};for(e of this.inputEl.childNodes)if(l(e))break;return n}setCursorPosition(s){var e=window.getSelection();let n=document.createRange(),l=0,o=!1,a=e=>{if(!o)if(e.nodeType===Node.TEXT_NODE){var t=e.textContent.length;l+t>=s?(n.setStart(e,s-l),n.collapse(!0),o=!0):l+=t}else if(e.nodeType===Node.ELEMENT_NODE)for(var i of e.childNodes)if(a(i),o)return};a(this.inputEl),!o&&this.inputEl.lastChild&&(n.setStartAfter(this.inputEl.lastChild),n.collapse(!0)),e.removeAllRanges(),e.addRange(n)}show(e,t=""){this.atPosition=e,this.searchQuery=t,this.isOpen=!0,this.items=this.getAllItems(t),0===this.items.length?this.close():(this.suggestionEl||(this.suggestionEl=document.createElement("div"),this.suggestionEl.className="flowtext-context-suggestions",this.suggestionEl.addEventListener("click",e=>{e.stopPropagation()}),this.suggestionEl.addEventListener("mousedown",e=>{e.stopPropagation()}),document.body.appendChild(this.suggestionEl)),this.render(),this.position(),this.bindKeyboardEvents())}getAllItems(n){let l=[],o=n.toLowerCase(),a=["png","jpg","jpeg","gif","bmp","svg","webp"],r=["txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"];return this.app.vault.getFiles().forEach(e=>{var t=e.extension.toLowerCase();let i="file",s="ğŸ“„";if("md"===t)i="file",s="ğŸ“„";else if(a.includes(t))i="image",s="ğŸ–¼ï¸";else{if(!r.includes(t))return;i="document",s="pdf"===t?"ğŸ“•":["xlsx","xls","csv"].includes(t)?"ğŸ“Š":["docx","doc","txt"].includes(t)?"ğŸ“":["epub","mobi"].includes(t)?"ğŸ“š":"json"===t?"ğŸ“‹":"ğŸ“„"}n&&!e.basename.toLowerCase().includes(o)&&!e.path.toLowerCase().includes(o)||l.push({type:i,name:e.basename,path:e.path,icon:s})}),this.app.vault.getAllLoadedFiles().filter(e=>e.children).forEach(e=>{n&&!e.name.toLowerCase().includes(o)&&!e.path.toLowerCase().includes(o)||l.push({type:"folder",name:e.name,path:e.path,icon:"ğŸ“"})}),l.slice(0,50)}render(){if(this.suggestionEl){this.suggestionEl.innerHTML="";var e=document.createElement("div");e.className="flowtext-suggestions-header",e.textContent=`é€‰æ‹©ä¸Šä¸‹æ–‡ (${this.items.length}é¡¹)`,this.suggestionEl.appendChild(e);let s=document.createElement("div");s.className="flowtext-suggestions-list",this.items.forEach((e,t)=>{var i=document.createElement("div");i.className="flowtext-suggestion-item",t===this.selectedIndex&&i.classList.add("selected"),i.innerHTML=`
				<span class="flowtext-suggestion-icon">${e.icon}</span>
				<div class="flowtext-suggestion-content">
					<div class="flowtext-suggestion-name">${e.name}</div>
					<div class="flowtext-suggestion-path">${e.path}</div>
				</div>
			`,i.onclick=e=>{e.stopPropagation(),e.preventDefault(),this.selectItem(t)},s.appendChild(i)}),this.suggestionEl.appendChild(s)}}position(){var e,t;this.suggestionEl&&this.inputEl&&(e=this.inputEl.getBoundingClientRect(),0<(t=window.getSelection()).rangeCount?(t=t.getRangeAt(0).getBoundingClientRect(),this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=t.left+"px",this.suggestionEl.style.top=t.bottom+5+"px"):(this.suggestionEl.style.position="fixed",this.suggestionEl.style.left=e.left+"px",this.suggestionEl.style.top=e.bottom+5+"px"),this.suggestionEl.style.maxHeight="300px",this.suggestionEl.style.overflowY="auto",this.suggestionEl.style.zIndex="10000")}bindKeyboardEvents(){this.keydownHandler&&this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=e=>{if(this.isOpen)switch(e.key){case"ArrowDown":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.min(this.selectedIndex+1,this.items.length-1),this.render(),this.scrollToSelected();break;case"ArrowUp":e.preventDefault(),e.stopPropagation(),this.selectedIndex=Math.max(this.selectedIndex-1,0),this.render(),this.scrollToSelected();break;case"Enter":e.preventDefault(),e.stopPropagation(),this.selectItem(this.selectedIndex);break;case"Escape":e.preventDefault(),e.stopPropagation(),this.close()}},this.inputEl.addEventListener("keydown",this.keydownHandler)}scrollToSelected(){var e;this.suggestionEl&&(e=this.suggestionEl.querySelector(".flowtext-suggestion-item.selected"))&&e.scrollIntoView({block:"nearest",behavior:"smooth"})}selectItem(e){if(!(e<0||e>=this.items.length)){var e=this.items[e],t=document.createElement("span"),i=(t.className="flowtext-inline-tag",t.contentEditable="false",t.setAttribute("data-type",e.type),t.setAttribute("data-path",e.path),t.innerHTML=`<span class="flowtext-inline-tag-icon">${e.icon}</span><span class="flowtext-inline-tag-name">${e.name}</span>`,window.getSelection());if(i.rangeCount){let r=i.getRangeAt(0);var s=this.getCursorPosition()-this.atPosition;let d=0,c=!1,p=(e,t,i)=>{if(!c)if(e.nodeType===Node.TEXT_NODE){var s,n,l=e.textContent.length;d+l>t?(s=t-d,n=Math.min(s+i,l),o=e.textContent,e.textContent=o.substring(0,s)+o.substring(n),r.setStart(e,s),r.collapse(!0),c=!0):d+=l}else if(e.nodeType===Node.ELEMENT_NODE)if(e.classList&&e.classList.contains("flowtext-inline-tag")){var o=`@[${e.getAttribute("data-type")}:${e.getAttribute("data-path")}]`;d+=o.length}else for(var a of e.childNodes)if(p(a,t,i),c)return};p(this.inputEl,this.atPosition,s),c||r.deleteContents(),r.insertNode(t);s=document.createTextNode(" ");r.setStartAfter(t),r.insertNode(s),r.setStartAfter(s),r.collapse(!0),i.removeAllRanges(),i.addRange(r),this.inputEl.focus(),this.updatePlaceholder(),this.selectedTags.push(e),this.onSelect&&this.onSelect(e),this.close()}}}updateSearch(e){this.searchQuery=e,this.items=this.getAllItems(e),(this.selectedIndex=0)===this.items.length?this.close():this.render()}close(){this.isOpen=!1,this.suggestionEl&&this.suggestionEl.parentNode&&this.suggestionEl.parentNode.removeChild(this.suggestionEl),this.suggestionEl=null,this.keydownHandler&&(this.inputEl.removeEventListener("keydown",this.keydownHandler),this.keydownHandler=null)}}class AtTriggerPopup{constructor(e,t,i,s){this.app=e,this.onSubmit=t,this.cursorPosition=i,this.plugin=s,this.popupEl=null,this.inputEl=null,this.modelSelectEl=null,this.isOpen=!1,this.imageHandler=new ImageHandler,this.eventListeners=[]}async submit(){var e=this.inputEl.value.trim(),t=this.imageHandler.getImages(),i=this.modelSelectEl.value,s=await this.getContextContent();e||0<t.length||s?(this.onSubmit(e,t,i,s),this.close()):new Notice("è¯·è¾“å…¥ç»­å†™è¦æ±‚æˆ–ä¸Šä¼ å›¾ç‰‡")}getModelOptions(){var e=this.plugin.getAvailableModels();let i=this.plugin.settings.currentModel;return e.map(e=>{var t=e.id===i?"selected":"";this.plugin.settings.providers[e.provider]?e.provider.toUpperCase():e.provider;return`<option value="${e.id}" ${t}>${e.name} </option>`}).join("")}addImagePreview(e,t){e=this.imageHandler.createImagePreview(e,e=>{});t.appendChild(e)}open(){if(!this.isOpen){this.isOpen=!0,this.popupEl=document.createElement("div"),this.popupEl.addClass("flowtext-at-popup"),this.popupEl.innerHTML=`
			<div class="flowtext-popup-header">
				<span class="flowtext-popup-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Aiæ™ºèƒ½ç»­å†™</span>
				<button class="flowtext-popup-close">âœ•</button>
			</div>
			<div class="flowtext-popup-content">
				<div class="flowtext-context-section">
					<div class="flowtext-selected-context" style="display: none;">
						<div class="flowtext-context-header">
							<span class="flowtext-context-title">å·²é€‰æ‹©ä¸Šä¸‹æ–‡:</span>
							<button class="flowtext-clear-context-btn" title="æ¸…é™¤ä¸Šä¸‹æ–‡">âœ•</button>
						</div>
						<div class="flowtext-context-list"></div>
					</div>
				</div>
				<textarea class="flowtext-continue-input" placeholder="è¯·è¾“å…¥ç»­å†™è¦æ±‚ï¼ˆ#è°ƒç”¨å¸¸ç”¨æç¤ºè¯ã€@é€‰æ‹©æ–‡ä»¶ï¼‰..." rows="3"></textarea>
				<div class="flowtext-upload-section">
					<div class="flowtext-left-section">
						<select class="flowtext-model-select" id="flowtext-model-select">
							${this.getModelOptions()}
						</select>
						<input type="file" class="flowtext-file-input" accept="image/*" multiple style="display: none;">
						<button class="flowtext-upload-btn" title="ä¸Šä¼ å›¾ç‰‡"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
						<div class="flowtext-context-buttons">
							<button class="flowtext-select-file-btn" title="é€‰æ‹©æ–‡æ¡£ä½œä¸ºä¸Šä¸‹æ–‡"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14,2 14,8 20,8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10,9 9,9 8,9"/></svg></button>
							<button class="flowtext-select-folder-btn" title="é€‰æ‹©æ–‡ä»¶å¤¹ä½œä¸ºä¸Šä¸‹æ–‡"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/></svg></button>
						</div>
					</div>
					<button class="flowtext-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>æäº¤</button>
				</div>
				<div class="flowtext-image-previews"></div>
			</div>
		`,this.inputEl=this.popupEl.querySelector(".flowtext-continue-input"),this.modelSelectEl=this.popupEl.querySelector(".flowtext-model-select");let t=this.popupEl.querySelector(".flowtext-submit-btn");var n=this.popupEl.querySelector(".flowtext-popup-close");let e=this.popupEl.querySelector(".flowtext-file-input");var l=this.popupEl.querySelector(".flowtext-upload-btn");let i=this.popupEl.querySelector(".flowtext-image-previews");var o=this.popupEl.querySelector(".flowtext-select-file-btn"),a=this.popupEl.querySelector(".flowtext-select-folder-btn"),r=(this.popupEl.querySelector(".flowtext-selected-context"),this.popupEl.querySelector(".flowtext-context-list"),this.popupEl.querySelector(".flowtext-clear-context-btn")),n=(this.selectedContext={files:[],folders:[]},this.contextSelector=new InputContextSelector(this.app,this.inputEl,e=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,n.onclick=()=>{this.close()},t.onclick=async()=>{var e=this.contextSelector.getTextContent().trim(),t=(await this.processInlineImages(),this.imageHandler.getImages()),i=this.modelSelectEl.value,s=await this.getContextContent();e||0<t.length||s?(this.close(),this.onSubmit(e,t,i,s)):new Notice("è¯·è¾“å…¥ç»­å†™è¦æ±‚æˆ–ä¸Šä¼ å›¾ç‰‡")},l.onclick=()=>e.click(),o.onclick=()=>{this.showFileSelector()},a.onclick=()=>{this.showFolderSelector()},r.onclick=()=>{this.clearContext()},e=>{this.plugin&&this.plugin.settings&&(this.plugin.settings.currentModel=e.target.value,this.plugin.saveSettings()),this.updateUIForModelType(e.target.value)}),l=(this.modelSelectEl.addEventListener("change",n),this.eventListeners.push({element:this.modelSelectEl,event:"change",handler:n}),this.updateUIForModelType(this.modelSelectEl.value),e=>{this.imageHandler.handleFileSelect(e.target.files,e=>{this.addImagePreview(e,i)}),e.target.value=""}),o=(e.addEventListener("change",l),this.eventListeners.push({element:e,event:"change",handler:l}),e=>{this.imageHandler.handlePaste(e,e=>{this.addImagePreview(e,i)})}),a=(this.inputEl.addEventListener("paste",o),this.eventListeners.push({element:this.inputEl,event:"paste",handler:o}),e=>{var t=this.contextSelector.getCursorPosition(),t=this.contextSelector.getTextContent().substring(0,t),i=t.lastIndexOf("@");-1===i||(t=t.substring(i+1)).includes(" ")||t.includes("\n")?this.contextSelector.close():this.contextSelector.show(i,t)}),r=(this.inputEl.addEventListener("input",a),this.eventListeners.push({element:this.inputEl,event:"input",handler:a}),e=>{this.contextSelector&&this.contextSelector.isOpen||("Enter"===e.key&&(e.ctrlKey||e.metaKey)?(e.preventDefault(),t.click()):"Escape"===e.key&&(e.preventDefault(),this.close()))});this.inputEl.addEventListener("keydown",r),this.eventListeners.push({element:this.inputEl,event:"keydown",handler:r});let s=e=>{this.popupEl.hasAttribute("data-prompt-selecting")||e.target.closest(".flowtext-prompt-selector-popup")||e.target.closest(".flowtext-context-suggestions")||this.contextSelector&&this.contextSelector.isOpen||e.target.closest(".flowtext-modal-content")||this.popupEl.contains(e.target)||this.close()};setTimeout(()=>{document.addEventListener("click",s)},100),this.outsideClickHandler=s,this.positionPopup(),document.body.appendChild(this.popupEl),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}}positionPopup(){var e,t,i,s;this.popupEl&&this.cursorPosition&&({left:t,top:e,height:i}=this.cursorPosition,this.popupEl.style.position="fixed",this.popupEl.style.left=t+"px",this.popupEl.style.top=e+i+5+"px",this.popupEl.style.zIndex="10000",t=this.popupEl.getBoundingClientRect(),i=window.innerWidth,s=window.innerHeight,t.right>i&&(this.popupEl.style.left=i-t.width-10+"px"),t.left<0&&(this.popupEl.style.left="10px"),s<t.bottom)&&(this.popupEl.style.top=e-t.height-5+"px")}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e.removeEventListener(t,i)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.imageHandler.clearImages(),this.popupEl&&this.popupEl.parentNode&&this.popupEl.parentNode.removeChild(this.popupEl),this.popupEl=null,this.inputEl=null)}updateUIForModelType(t){if(this.popupEl&&t){t=this.plugin.settings.models[t];if(t){let e=t.category;var t=(e=!e&&t.type?"image"===t.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT:e)===MODEL_CATEGORIES.IMAGE,i=this.popupEl.querySelector(".flowtext-popup-title"),i=(i&&(i.innerHTML=t?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-icon lucide-image" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>AIå›¾ç‰‡ç”Ÿæˆ':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>Aiæ™ºèƒ½ç»­å†™'),this.inputEl&&(this.inputEl.placeholder=t?"è¯·æè¿°æ‚¨æƒ³è¦ç”Ÿæˆçš„å›¾ç‰‡ï¼Œä¾‹å¦‚ï¼šä¸€åªå¯çˆ±çš„å°çŒ«åœ¨èŠ±å›­é‡Œç©è€":"è¯·è¾“å…¥ç»­å†™è¦æ±‚ï¼ˆ#è°ƒç”¨å¸¸ç”¨æç¤ºè¯ã€@é€‰æ‹©æ–‡ä»¶ï¼‰..."),this.popupEl.querySelector(".flowtext-submit-btn")),i=(i&&(i.innerHTML=t?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-plus-icon lucide-image-plus" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M16 5h6"/><path d="M19 2v6"/><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>ç”Ÿæˆå›¾ç‰‡':'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square-more-icon lucide-message-square-more" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"/><path d="M12 11h.01"/><path d="M16 11h.01"/><path d="M8 11h.01"/></svg>æäº¤'),this.popupEl.querySelector(".flowtext-upload-btn"));i&&(i.style.display=t?"none":"inline-flex")}}}showFileSelector(){let t=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"];var e=this.plugin.app.vault.getFiles().filter(e=>{e=e.extension.toLowerCase();return t.includes(e)}).map(e=>({name:e.basename,path:e.path,extension:e.extension.toLowerCase()})),i=this.popupEl.querySelector(".flowtext-popup-header");i&&(i=i.getBoundingClientRect(),new FileSelectionWindow(this.plugin.app,e,e=>{this.addFilesToContext(e)}).open(i))}showFolderSelector(){var e=this.plugin.app.vault.getAllLoadedFiles().filter(e=>e.children).map(e=>({name:e.name,path:e.path})),t=this.popupEl.querySelector(".flowtext-popup-header");t&&(t=t.getBoundingClientRect(),new FolderSelectionWindow(this.plugin.app,e,e=>{this.addFoldersToContext(e)}).open(t))}addFilesToContext(e){e.forEach(t=>{this.selectedContext.files.find(e=>e.path===t.path)||this.selectedContext.files.push(t)}),this.updateContextDisplay()}addFoldersToContext(e){e.forEach(t=>{this.selectedContext.folders.find(e=>e.path===t.path)||this.selectedContext.folders.push(t)}),this.updateContextDisplay()}updateContextDisplay(){var e=this.popupEl.querySelector(".flowtext-selected-context");let i=this.popupEl.querySelector(".flowtext-context-list");0===this.selectedContext.files.length&&0===this.selectedContext.folders.length?e.style.display="none":(e.style.display="block",i.innerHTML="",this.selectedContext.files.forEach(e=>{var t=document.createElement("div");t.className="flowtext-context-item",t.innerHTML=`
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text">
					<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
					<polyline points="14,2 14,8 20,8"/>
					<line x1="16" y1="13" x2="8" y2="13"/>
					<line x1="16" y1="17" x2="8" y2="17"/>
					<polyline points="10,9 9,9 8,9"/>
				</svg>
				<span class="flowtext-context-name">${e.name}</span>
				<button class="flowtext-remove-context" data-type="file" data-path="${e.path}">Ã—</button>
			`,i.appendChild(t)}),this.selectedContext.folders.forEach(e=>{var t=document.createElement("div");t.className="flowtext-context-item",t.innerHTML=`
				<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder">
					<path d="M20 20a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.9a2 2 0 0 1-1.69-.9L9.6 3.9A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13a2 2 0 0 0 2 2Z"/>
				</svg>
				<span class="flowtext-context-name">${e.name}</span>
				<button class="flowtext-remove-context" data-type="folder" data-path="${e.path}">Ã—</button>
			`,i.appendChild(t)}),i.querySelectorAll(".flowtext-remove-context").forEach(i=>{i.onclick=e=>{e.stopPropagation();var e=i.getAttribute("data-type"),t=i.getAttribute("data-path");this.removeFromContext(e,t)}}))}removeFromContext(e,t){"file"===e?this.selectedContext.files=this.selectedContext.files.filter(e=>e.path!==t):"folder"===e&&(this.selectedContext.folders=this.selectedContext.folders.filter(e=>e.path!==t)),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var e;if(this.contextSelector&&this.contextSelector.inputEl)for(e of this.contextSelector.inputEl.querySelectorAll(".flowtext-inline-tag")){var t=e.getAttribute("data-type"),i=e.getAttribute("data-path");if("image"===t)try{var s=this.plugin.app.vault.getAbstractFileByPath(i);if(s){var n=await this.plugin.app.vault.readBinary(s),l=new Uint8Array(n);let t="";for(let e=0;e<l.length;e++)t+=String.fromCharCode(l[e]);var o=btoa(t),a={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[s.extension?.toLowerCase()||"png"]||"image/png",r=`data:${a};base64,`+o;let i={id:Date.now()+Math.random(),name:s.name,size:n.byteLength,type:a,base64:r,url:r,fromInline:!0};this.imageHandler.images.some(e=>e.name===i.name&&e.size===i.size)||this.imageHandler.images.push(i)}}catch(e){console.error("æ— æ³•è¯»å–å›¾ç‰‡: "+i,e),new Notice("æ— æ³•è¯»å–å›¾ç‰‡: "+i)}}}async getContextContent(){let e="";for(var t of this.selectedContext.files)try{var i,s=this.plugin.app.vault.getAbstractFileByPath(t.path);s&&(i=await this.plugin.app.vault.read(s),e+=`

=== æ–‡æ¡£: ${t.name} ===
`+i)}catch(e){}let n=(e,t)=>{var i=[];if(e&&e.children)for(var s of e.children)"md"===s.extension?i.push({file:s,sourcePath:s.path,baseFolderName:t}):s.children&&(s=n(s,t),i.push(...s));return i};for(var l of this.selectedContext.folders)try{var o,a=this.plugin.app.vault.getAbstractFileByPath(l.path);if(a)for(o of n(a,l.name)){var r=await this.plugin.app.vault.read(o.file);e+=`

=== æ–‡æ¡£: ${o.file.basename} (æ¥è‡ªæ–‡ä»¶å¤¹: ${o.baseFolderName}, è·¯å¾„: ${o.sourcePath}) ===
`+r}}catch(e){}return e.trim()}}class FileSelectionWindow{constructor(e,t,i){this.app=e,this.files=t,this.onSelect=i,this.selectedFiles=[],this.windowEl=null,this.isOpen=!1,this.eventListeners=[],this.outsideClickHandler=null}open(s){if(!this.isOpen){if(this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="flowtext-file-selection-window",this.windowEl.innerHTML=`
			<div class="flowtext-window-content">
				<div class="flowtext-window-header">
					<h2>é€‰æ‹©æ–‡æ¡£</h2>
					<button class="flowtext-window-close">âœ•</button>
				</div>
				<div class="flowtext-window-body">
					<div class="flowtext-search-container">
						<input type="text" placeholder="æœç´¢æ–‡æ¡£..." class="flowtext-search-input">
					</div>
					<div class="flowtext-file-list"></div>
				</div>
				<div class="flowtext-window-buttons">
					<button class="flowtext-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check"><path d="M20 6 9 17l-5-5"/></svg></button>
					<button class="flowtext-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
				</div>
			</div>
		`,document.body.appendChild(this.windowEl),s){var n=this.windowEl.querySelector(".flowtext-window-content");let e=s.left;(e=e+600>window.innerWidth-20?window.innerWidth-600-20:e)<20&&(e=20);var s=s.bottom+8,l=Math.max(300,Math.min(window.innerHeight-s-20,500));n.style.maxHeight=l+"px",n.style.overflowY="auto",n.style.transform="none",n.style.left=e+"px",n.style.top=s+"px"}let t=this.windowEl.querySelector(".flowtext-search-input"),o=this.windowEl.querySelector(".flowtext-file-list");l=this.windowEl.querySelector(".flowtext-confirm-btn"),n=this.windowEl.querySelector(".flowtext-cancel-btn"),s=this.windowEl.querySelector(".flowtext-window-close");let i=e=>{o.innerHTML="",e.forEach(t=>{var e=document.createElement("div");e.className="flowtext-file-item";let i=document.createElement("input");i.type="checkbox",i.className="flowtext-file-checkbox",i.checked=this.selectedFiles.some(e=>e.path===t.path);var s=document.createElement("label"),n=(s.className="flowtext-file-label",document.createElement("span")),l=(n.className="flowtext-file-name",n.textContent=t.name,document.createElement("span")),n=(l.className="flowtext-file-extension",l.textContent=t.extension?"."+t.extension:"",s.appendChild(n),s.appendChild(l),e.appendChild(i),e.appendChild(s),o.appendChild(e),()=>{i.checked?this.selectedFiles.some(e=>e.path===t.path)||this.selectedFiles.push(t):this.selectedFiles=this.selectedFiles.filter(e=>e.path!==t.path)});i.addEventListener("change",n),this.eventListeners.push({element:i,event:"change",handler:n})})};i(this.files);var a=()=>{let s=t.value.toLowerCase();var e=this.files.filter(e=>{var t=e.name.toLowerCase().includes(s),i=e.extension&&e.extension.toLowerCase().includes(s),e=e.path&&e.path.toLowerCase().includes(s);return t||i||e});i(e)},a=(t.addEventListener("input",a),this.eventListeners.push({element:t,event:"input",handler:a}),e=>{e.stopPropagation(),this.onSelect(this.selectedFiles),this.close()}),l=(l.addEventListener("click",a),this.eventListeners.push({element:l,event:"click",handler:a}),e=>{e.stopPropagation(),this.close()}),a=(n.addEventListener("click",l),this.eventListeners.push({element:n,event:"click",handler:l}),e=>{e.stopPropagation(),this.close()});s.addEventListener("click",a),this.eventListeners.push({element:s,event:"click",handler:a});let e=e=>{this.windowEl.contains(e.target)||this.close()};setTimeout(()=>{document.addEventListener("click",e)},100),this.outsideClickHandler=e;n=e=>{e.stopPropagation()};this.windowEl.querySelector(".flowtext-window-content").addEventListener("click",n),this.eventListeners.push({element:this.windowEl.querySelector(".flowtext-window-content"),event:"click",handler:n})}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e.removeEventListener(t,i)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}}class FolderSelectionWindow{constructor(e,t,i){this.app=e,this.folders=t,this.onSelect=i,this.selectedFolders=[],this.windowEl=null,this.isOpen=!1,this.eventListeners=[],this.outsideClickHandler=null}open(t){if(!this.isOpen){if(this.isOpen=!0,this.windowEl=document.createElement("div"),this.windowEl.className="flowtext-folder-selection-window",this.windowEl.innerHTML=`
			<div class="flowtext-window-content">
				<div class="flowtext-window-header">
					<h2>é€‰æ‹©æ–‡ä»¶å¤¹</h2>
					<button class="flowtext-window-close">âœ•</button>
				</div>
				<div class="flowtext-window-body">
					<div class="flowtext-search-container">
						<input type="text" placeholder="æœç´¢æ–‡ä»¶å¤¹..." class="flowtext-search-input">
					</div>
					<div class="flowtext-folder-list"></div>
				</div>
				<div class="flowtext-window-buttons">
					<button class="flowtext-confirm-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-check-icon lucide-check"><path d="M20 6 9 17l-5-5"/></svg></button>
					<button class="flowtext-cancel-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg></button>
				</div>
			</div>
		`,document.body.appendChild(this.windowEl),t){var l=this.windowEl.querySelector(".flowtext-window-content");let e=t.left;(e=e+600>window.innerWidth-20?window.innerWidth-600-20:e)<20&&(e=20);var t=t.bottom+8,o=Math.max(300,Math.min(window.innerHeight-t-20,500));l.style.maxHeight=o+"px",l.style.overflowY="auto",l.style.transform="none",l.style.left=e+"px",l.style.top=t+"px"}let i=this.windowEl.querySelector(".flowtext-search-input"),n=this.windowEl.querySelector(".flowtext-folder-list");o=this.windowEl.querySelector(".flowtext-confirm-btn"),l=this.windowEl.querySelector(".flowtext-cancel-btn"),t=this.windowEl.querySelector(".flowtext-window-close");let s=e=>{n.innerHTML="",e.forEach(t=>{var e=document.createElement("div");e.className="flowtext-folder-item";let i=document.createElement("input");i.type="checkbox",i.className="flowtext-folder-checkbox",i.checked=this.selectedFolders.some(e=>e.path===t.path);var s=document.createElement("label"),s=(s.textContent=t.name||t.path,s.className="flowtext-folder-label",e.appendChild(i),e.appendChild(s),n.appendChild(e),()=>{i.checked?this.selectedFolders.some(e=>e.path===t.path)||this.selectedFolders.push(t):this.selectedFolders=this.selectedFolders.filter(e=>e.path!==t.path)});i.addEventListener("change",s),this.eventListeners.push({element:i,event:"change",handler:s})})};s(this.folders);var a=()=>{let t=i.value.toLowerCase();var e=this.folders.filter(e=>(e.name||e.path).toLowerCase().includes(t));s(e)},a=(i.addEventListener("input",a),this.eventListeners.push({element:i,event:"input",handler:a}),e=>{e.stopPropagation(),this.onSelect(this.selectedFolders),this.close()}),o=(o.addEventListener("click",a),this.eventListeners.push({element:o,event:"click",handler:a}),e=>{e.stopPropagation(),this.close()}),a=(l.addEventListener("click",o),this.eventListeners.push({element:l,event:"click",handler:o}),e=>{e.stopPropagation(),this.close()});t.addEventListener("click",a),this.eventListeners.push({element:t,event:"click",handler:a});let e=e=>{this.windowEl.contains(e.target)||this.close()};setTimeout(()=>{document.addEventListener("click",e)},100),this.outsideClickHandler=e;l=e=>{e.stopPropagation()};this.windowEl.querySelector(".flowtext-window-content").addEventListener("click",l),this.eventListeners.push({element:this.windowEl.querySelector(".flowtext-window-content"),event:"click",handler:l})}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e.removeEventListener(t,i)}),this.eventListeners=[],this.outsideClickHandler&&(document.removeEventListener("click",this.outsideClickHandler),this.outsideClickHandler=null),this.windowEl&&this.windowEl.parentNode&&this.windowEl.parentNode.removeChild(this.windowEl),this.windowEl=null)}}class AITextModifyModal{constructor(e,t,i,s=null,n=null,l="",o=!1){this.app=e,this.selectedText=t,this.onSubmit=i,this.plugin=s,this.modalTitle=n||(100<t.length?"AIå…¨æ–‡ä¿®æ”¹":"AIåŸæ–‡ä¿®æ”¹"),this.defaultPrompt=l,this.isFullTextMode=o,this.modalEl=null,this.inputEl=null,this.modelSelectEl=null,this.isOpen=!1,this.imageHandler=new ImageHandler,this.selectedContext={files:[],folders:[]},this.eventListeners=[]}addImagePreview(e,t){e=this.imageHandler.createImagePreview(e,e=>{});t.appendChild(e)}open(){try{if(!this.isOpen){this.isOpen=!0,this.chatHistory=this.chatHistory||[],this.modalEl=document.createElement("div"),this.modalEl.className="flowtext-ai-modify-modal",this.modalEl.innerHTML=`
				<div class="flowtext-modal-backdrop"></div>
				<div class="flowtext-modal-content">
					<div class="flowtext-modal-header">
						<span class="flowtext-modal-title"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>AI Chat</span>
						<div class="flowtext-header-buttons">
							<button class="flowtext-clear-btn" title="æ¸…ç©ºå¯¹è¯å†å²">æ¸…ç©º</button>
							<button class="flowtext-modal-close">âœ•</button>
						</div>
					</div>
					<div class="flowtext-modal-body">
						<div class="flowtext-chat-container">
							<div class="flowtext-initial-context">
								${this.selectedText?`
								<div class="flowtext-selected-text">
									<div class="flowtext-selected-text-header">
										<h4>åŸæ–‡å†…å®¹ï¼š</h4>
										<button class="flowtext-toggle-btn">â–¼</button>
									</div>
									<div class="flowtext-text-preview flowtext-collapsed"></div>
								</div>
							`:""}
								<div class="flowtext-image-previews-context"></div>
							</div>
							<div class="flowtext-chat-history"></div>
						</div>
						<div class="flowtext-input-container">
							<div class="flowtext-prompt-input">
								<textarea class="flowtext-modify-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æŒ‡ä»¤ï¼ˆ#è°ƒç”¨å¸¸ç”¨æç¤ºè¯ã€@é€‰æ‹©æ–‡ä»¶ï¼‰..." rows="3">${this.defaultPrompt}</textarea>
								<div class="flowtext-upload-section">
									<div class="flowtext-left-section">
										<select class="flowtext-model-select">
											${this.getModelOptions()}
										</select>
										<input type="file" class="flowtext-file-input" accept="image/*" multiple style="display: none;">
										<button class="flowtext-upload-btn" title="ä¸Šä¼ å›¾ç‰‡"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-image-up-icon lucide-image-up" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="M10.3 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10l-3.1-3.1a2 2 0 0 0-2.814.014L6 21"/><path d="m14 19.5 3-3 3 3"/><path d="M17 22v-5.5"/><circle cx="9" cy="9" r="2"/></svg></button>
										<div class="flowtext-context-buttons">
											<button class="flowtext-select-file-btn" title="é€‰æ‹©æ–‡ä»¶">
												<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-file-text">
													<path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
													<polyline points="14,2 14,8 20,8"/>
													<line x1="16" y1="13" x2="8" y2="13"/>
													<line x1="16" y1="17" x2="8" y2="17"/>
													<polyline points="10,9 9,9 8,9"/>
												</svg>
											</button>
											<button class="flowtext-select-folder-btn" title="é€‰æ‹©æ–‡ä»¶å¤¹">
												<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-folder">
													<path d="M4 20h16a2 2 0 0 0 2-2V8a2 2 0 0 0-2-2h-7.93a2 2 0 0 1-1.66-.9l-.82-1.2A2 2 0 0 0 7.93 3H4a2 2 0 0 0-2 2v13c0 1.1.9 2 2 2Z"/>
												</svg>
											</button>
										</div>
									</div>
									<button class="flowtext-submit-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send-icon lucide-send" style="display: inline-block; vertical-align: middle; margin-right: 4px;"><path d="m22 2-7 20-4-9-9-4Z"/><path d="M22 2 11 13"/></svg>å‘é€</button>
								</div>
								<div class="flowtext-image-previews"></div>
							</div>
						</div>
					</div>
				</div>
			`;var o=this.modalEl.querySelector(".flowtext-text-preview");o&&(o.textContent=this.selectedText),this.inputEl=this.modalEl.querySelector(".flowtext-modify-input"),this.modelSelectEl=this.modalEl.querySelector(".flowtext-model-select"),this.chatHistoryEl=this.modalEl.querySelector(".flowtext-chat-history");let s=this.modalEl.querySelector(".flowtext-submit-btn");var a=this.modalEl.querySelector(".flowtext-modal-close"),r=this.modalEl.querySelector(".flowtext-clear-btn"),d=this.modalEl.querySelector(".flowtext-modal-backdrop");let e=this.modalEl.querySelector(".flowtext-file-input");var c=this.modalEl.querySelector(".flowtext-upload-btn"),p=this.modalEl.querySelector(".flowtext-select-file-btn"),h=this.modalEl.querySelector(".flowtext-select-folder-btn");let n=this.modalEl.querySelector(".flowtext-image-previews");this.modalEl.querySelector(".flowtext-image-previews-context");let t=this.modalEl.querySelector(".flowtext-toggle-btn"),i=this.modalEl.querySelector(".flowtext-text-preview");var u=this.modalEl.querySelector(".flowtext-selected-text-header"),g=(this.contextSelector=new InputContextSelector(this.app,this.inputEl,e=>{}),this.contextSelector.convertToContentEditable(),this.inputEl=this.contextSelector.inputEl,async()=>{var t=this.contextSelector.getTextContent().trim(),i=(await this.processInlineImages(),this.imageHandler.getImages());let e=this.modelSelectEl?this.modelSelectEl.value:null;if(t||0!==i.length)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{this.isProcessing=!0,s.disabled=!0,s.textContent="å¤„ç†ä¸­...",this.addMessageToHistory("user",t,i),this.inputEl.textContent="",this.contextSelector.updatePlaceholder(),this.imageHandler.clearImages(),n.innerHTML="";let l=this.addLoadingMessage();try{var o=await this.getContextContent(),a=this.plugin.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);let e,s=(this.selectedText&&1e3<this.selectedText.length?e={selectedText:this.selectedText.trim(),beforeText:"",afterText:"",cursorPosition:a?a.editor.getCursor():null,filePath:a?a.editor.getValue():"",lineNumber:0,contextContent:o}:(e=a?TextContextExtractor.getContext(a.editor,this.selectedText,this.plugin.settings):{selectedText:this.selectedText,beforeText:"",afterText:""}).contextContent=o,this.modelSelectEl&&this.modelSelectEl.value,null),n=null;var r,d=await this.plugin.aiService.sendRequest("continue",e,t,i,this.chatHistory,e=>{var t,i;e.thinking&&e.thinking.trim()&&(!s&&((s=document.createElement("div")).className="flowtext-message flowtext-message-thinking",s.innerHTML=`
							<div class="flowtext-message-header">
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#f39c12" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-brain" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
									<path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 .556 6.588A4 4 0 1 0 12 18Z"/>
									<path d="M12 5a3 3 0 1 1 5.997.125 4 4 0 0 1 2.526 5.77 4 4 0 0 1-.556 6.588A4 4 0 1 1 12 18Z"/>
									<path d="M15 13a4.5 4.5 0 0 1-3-4 4.5 4.5 0 0 1-3 4"/>
									<path d="M17.599 6.5a3 3 0 0 0 .399-1.375"/>
									<path d="M6.003 5.125A3 3 0 0 0 6.401 6.5"/>
									<path d="M3.477 10.896a4 4 0 0 1 .585-.396"/>
									<path d="M19.938 10.5a4 4 0 0 1 .585.396"/>
									<path d="M6 18a4 4 0 0 1-1.967-.516"/>
									<path d="M19.967 17.484A4 4 0 0 1 18 18"/>
								</svg>
								<button class="flowtext-copy-btn" title="å¤åˆ¶å†…å®¹" style="display: inline-flex; background: transparent ;box-shadow: none;align-items: center;">
									<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
										<rect x="9" y="9" width="13" height="13" rx="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								</button>
								æ€è€ƒè¿‡ç¨‹
							</div>
							<div class="flowtext-message-content"></div>
						`,l&&l.parentNode?this.chatHistoryEl.insertBefore(s,l):this.chatHistoryEl.appendChild(s),t=s.querySelector(".flowtext-copy-btn"))&&(t.onclick=async()=>{var t=s.querySelector(".flowtext-message-content"),t=t?t.textContent:"";try{await navigator.clipboard.writeText(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){try{require("obsidian").clipboard.write(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){new Notice("å¤åˆ¶å¤±è´¥")}}}),t=s.querySelector(".flowtext-message-content"))&&(t.textContent=e.thinking),e.content&&e.content.trim()&&(n||((n=document.createElement("div")).className="flowtext-message flowtext-message-assistant",n.innerHTML='<div class="flowtext-message-content"></div>',(t=document.createElement("div")).className="flowtext-message-header flowtext-message-header-assistant",t.setAttribute("data-role","assistant"),t.innerHTML=`
								<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
									<path d="M12 8V4H8"/>
									<rect width="16" height="12" x="4" y="8" rx="2"/>
									<path d="M2 14h2"/>
									<path d="M20 14h2"/>
									<path d="M15 13v2"/>
									<path d="M9 13v2"/>
								</svg>
								<button class="flowtext-copy-btn" title="å¤åˆ¶å†…å®¹" style="display: inline-flex; background: transparent ;box-shadow: none;align-items: center;">
									<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
										<rect x="9" y="9" width="13" height="13" rx="2"></rect>
										<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
									</svg>
								</button>
								<button class="flowtext-apply-btn" title="åº”ç”¨åˆ°ç¬”è®°"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-reply-icon lucide-reply"><path d="M20 18v-2a4 4 0 0 0-4-4H4"/><path d="m9 17-5-5 5-5"/></svg></button>
							`,s&&s.parentNode?((i=s.parentNode).insertBefore(t,s.nextSibling),i.insertBefore(n,t.nextSibling)):l&&l.parentNode?((i=l.parentNode).insertBefore(t,l),i.insertBefore(n,l)):(this.chatHistoryEl.appendChild(t),this.chatHistoryEl.appendChild(n)),l&&l.parentNode&&(this.removeLoadingMessage(l),l=null),i=t.querySelector(".flowtext-apply-btn"),t=t.querySelector(".flowtext-copy-btn"),i&&(i.onclick=()=>{var e=n.querySelector(".flowtext-message-content"),e=e?e.textContent:"";this.applyToNote(e)}),t&&(t.onclick=async()=>{var t=n.querySelector(".flowtext-message-content"),t=t?t.textContent:"";try{await navigator.clipboard.writeText(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){try{require("obsidian").clipboard.write(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){new Notice("å¤åˆ¶å¤±è´¥")}}})),i=n.querySelector(".flowtext-message-content"))&&(i.textContent=e.content),this.chatHistoryEl&&(this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight)}),c=(l&&l.parentNode&&this.removeLoadingMessage(l),d.reasoning_content||""),p=d.content||"";c&&"string"==typeof c&&c.trim()&&this.chatHistory.push({role:"assistant",content:c,type:"thinking"}),p&&"string"==typeof p&&p.trim()?this.chatHistory.push({role:"assistant",content:p,type:"response"}):c||(r=p||"å“åº”å†…å®¹ä¸ºç©º",this.chatHistory.push({role:"assistant",content:r}),s)||n||this.addMessageToHistory("assistant",r)}catch(e){this.removeLoadingMessage(l),this.addMessageToHistory("error","å¤„ç†å¤±è´¥: "+e.message)}finally{this.isProcessing=!1,s.disabled=!1,s.textContent="å‘é€"}}else new Notice("è¯·è¾“å…¥æŒ‡ä»¤æˆ–ä¸Šä¼ å›¾ç‰‡")}),m=()=>{this.clearChatHistory()},v=()=>{this.close()},x=()=>{this.close()},w=e=>{this.contextSelector&&this.contextSelector.isOpen||("Enter"===e.key&&(e.ctrlKey||e.metaKey)?(e.preventDefault(),s.click()):"Escape"===e.key&&(e.preventDefault(),this.close()))},E=e=>{e.stopPropagation()},f=()=>e.click(),y=e=>{this.plugin&&this.plugin.settings&&(this.plugin.settings.currentModel=e.target.value,this.plugin.saveSettings())},b=(this.modelSelectEl&&(this.modelSelectEl.addEventListener("change",y),this.eventListeners.push({element:this.modelSelectEl,event:"change",handler:y})),e=>{this.imageHandler.handleFileSelect(e.target.files,e=>{this.addImagePreview(e,n)}),e.target.value=""}),k=e=>{this.imageHandler.handlePaste(e,e=>{this.addImagePreview(e,n)})},S=e=>{var t=this.contextSelector.getCursorPosition(),t=this.contextSelector.getTextContent().substring(0,t),i=t.lastIndexOf("@");-1===i||(t=t.substring(i+1)).includes(" ")||t.includes("\n")?this.contextSelector.close():this.contextSelector.show(i,t)};let l=()=>{i&&(i.classList.contains("flowtext-collapsed")?(i.classList.remove("flowtext-collapsed"),t.textContent="â–²"):(i.classList.add("flowtext-collapsed"),t.textContent="â–¼"))};var T=e=>{e&&e.target&&"function"==typeof e.target.closest&&e.target.closest(".flowtext-toggle-btn")||l()};s.onclick=g,a.onclick=v,r&&(r.onclick=m),t&&(t.onclick=l),u&&(u.onclick=T),d.onclick=x,c.onclick=f,p&&(p.onclick=()=>this.showFileSelector()),h&&(h.onclick=()=>this.showFolderSelector()),e.addEventListener("change",b),this.inputEl.addEventListener("keydown",w),this.inputEl.addEventListener("paste",k),this.inputEl.addEventListener("input",S),this.modalEl.querySelector(".flowtext-modal-content").onclick=E,this.eventListeners=[{element:s,event:"click",handler:g},{element:a,event:"click",handler:v},{element:d,event:"click",handler:x},{element:c,event:"click",handler:f},{element:e,event:"change",handler:b},{element:this.inputEl,event:"keydown",handler:w},{element:this.inputEl,event:"paste",handler:k},{element:this.inputEl,event:"input",handler:S},{element:this.modalEl.querySelector(".flowtext-modal-content"),event:"click",handler:E}],p&&this.eventListeners.push({element:p,event:"click",handler:()=>this.showFileSelector()}),h&&this.eventListeners.push({element:h,event:"click",handler:()=>this.showFolderSelector()}),r&&this.eventListeners.push({element:r,event:"click",handler:m}),t&&this.eventListeners.push({element:t,event:"click",handler:l}),u&&this.eventListeners.push({element:u,event:"click",handler:T}),this.setupDraggable(),document.body.appendChild(this.modalEl),setTimeout(()=>{this.inputEl&&this.inputEl.focus()},100)}}catch(e){}}moveSelection(e){0!==this.commonPrompts.length&&((e=this.selectedIndex+e)<0?this.selectedIndex=this.commonPrompts.length-1:e>=this.commonPrompts.length?this.selectedIndex=0:this.selectedIndex=e,this.updateSelection(this.selectedIndex))}updateSelection(e){this.modalEl&&0!==this.commonPrompts.length&&(this.selectedIndex=e,this.modalEl.querySelectorAll(".flowtext-prompt-item").forEach(e=>e.classList.remove("selected")),e=this.modalEl.querySelector(`[data-index="${e}"]`))&&(e.classList.add("selected"),e.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(e){e<0||e>=this.commonPrompts.length||((e=this.commonPrompts[e])&&this.onSelect&&this.onSelect(e.content),this.close())}close(){this.isOpen&&(this.isOpen=!1,this.contextSelector&&(this.contextSelector.close(),this.contextSelector=null),this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e&&"function"==typeof e.removeEventListener?e.removeEventListener(t,i):e&&"click"===t&&(e.onclick=null)}),this.eventListeners=[],this.imageHandler.clearImages(),this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null,this.inputEl=null,this.modelSelectEl=null,this.chatHistoryEl=null)}addLoadingMessage(){var e;return this.chatHistoryEl?((e=document.createElement("div")).className="flowtext-message flowtext-message-assistant flowtext-message-loading",e.setAttribute("data-role","assistant"),e.innerHTML=`
			<div class="flowtext-message-header">
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
					<path d="M12 8V4H8"/>
					<rect width="16" height="12" x="4" y="8" rx="2"/>
					<path d="M2 14h2"/>
					<path d="M20 14h2"/>
					<path d="M15 13v2"/>
					<path d="M9 13v2"/>
				</svg>
			</div>
			<div class="flowtext-message-content">
				<div class="flowtext-loading-animation">
					<div class="flowtext-loading-spinner"></div>
					<div class="flowtext-loading-dots">
						<span></span>
						<span></span>
						<span></span>
					</div>
					<div class="flowtext-loading-text">æ­£åœ¨æ€è€ƒä¸­...</div>
				</div>
			</div>
		`,this.chatHistoryEl.appendChild(e),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight,e):null}removeLoadingMessage(e){e&&e.parentNode&&e.parentNode.removeChild(e)}addMessageToHistory(t,i,s=[]){if(this.chatHistoryEl){this.chatHistory||(this.chatHistory=[]),"user"!==t&&"assistant"!==t||(n={role:t,content:i},"user"===t&&s&&0<s.length&&(n.content+=`

é™„åŠ å›¾ç‰‡ï¼šå…±${s.length}å¼ å›¾ç‰‡`),this.chatHistory.push(n));let e=document.createElement("div");if(e.className="flowtext-message flowtext-message-"+t,e.setAttribute("data-role",t),"user"===t){e.innerHTML=`<div class="flowtext-message-content">${this.escapeHtml(i)}</div>`;var n=document.createElement("div");if(n.className="flowtext-message-header flowtext-message-header-user",n.setAttribute("data-role","user"),n.innerHTML=`
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-user-round-icon lucide-circle-user-round" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
					<path d="M18 20a6 6 0 0 0-12 0"/>
					<circle cx="12" cy="10" r="4"/>
					<circle cx="12" cy="12" r="10"/>
				</svg>
				<button class="flowtext-copy-btn" title="å¤åˆ¶å†…å®¹" style="display: inline-flex;background: transparent ;box-shadow: none; align-items: center;">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
						<rect x="9" y="9" width="13" height="13" rx="2"></rect>
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
					</svg>
				</button>
			`,this.chatHistoryEl.appendChild(n),s&&0<s.length){let i=document.createElement("div");i.className="flowtext-message-images",s.forEach(e=>{var t=document.createElement("img");t.src=e,t.className="flowtext-message-image",i.appendChild(t)}),e.appendChild(i)}var s=n.querySelector(".flowtext-copy-btn");s&&(s.onclick=async()=>{var t=e.querySelector(".flowtext-message-content"),t=t?t.textContent:"";try{await navigator.clipboard.writeText(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){try{require("obsidian").clipboard.write(t),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){new Notice("å¤åˆ¶å¤±è´¥")}}})}else"assistant"===t?(e.innerHTML=`<div class="flowtext-message-content">${this.escapeHtml(i)}</div>`,(n=document.createElement("div")).className="flowtext-message-header flowtext-message-header-assistant",n.setAttribute("data-role","assistant"),n.innerHTML=`
				<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#863097" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot" style="display: inline-block; vertical-align: middle; margin-right: 4px;">
					<path d="M12 8V4H8"/>
					<rect width="16" height="12" x="4" y="8" rx="2"/>
					<path d="M2 14h2"/>
					<path d="M20 14h2"/>
					<path d="M15 13v2"/>
					<path d="M9 13v2"/>
				</svg>
				<button class="flowtext-copy-btn" title="å¤åˆ¶å†…å®¹" style="display: inline-flex;background: transparent ;box-shadow: none; align-items: center;">
					<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-copy">
						<rect x="9" y="9" width="13" height="13" rx="2"></rect>
						<path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
					</svg>
				</button>
				<button class="flowtext-apply-btn" title="åº”ç”¨åˆ°ç¬”è®°"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-reply-icon lucide-reply"><path d="M20 18v-2a4 4 0 0 0-4-4H4"/><path d="m9 17-5-5 5-5"/></svg></button>
			`,this.chatHistoryEl.appendChild(n),s=n.querySelector(".flowtext-apply-btn"),n=n.querySelector(".flowtext-copy-btn"),s&&(s.onclick=()=>{this.applyToNote(i)}),n&&(n.onclick=async()=>{try{await navigator.clipboard.writeText(i),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){try{require("obsidian").clipboard.write(i),new Notice("å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")}catch(e){new Notice("å¤åˆ¶å¤±è´¥")}}})):"error"===t&&(e.innerHTML=`
				<div class="flowtext-message-header">
					<span class="flowtext-message-role">é”™è¯¯</span>
				</div>
				<div class="flowtext-message-content flowtext-error-content">${this.escapeHtml(i)}</div>
			`);this.chatHistoryEl.appendChild(e),this.chatHistoryEl.scrollTop=this.chatHistoryEl.scrollHeight}}clearChatHistory(){this.chatHistoryEl&&(this.chatHistoryEl.innerHTML="",this.chatHistory=[])}applyToNote(e){try{var t,i,s,n,l,o,a=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);a&&a.editor?(this.isFullTextMode||this.selectedText&&1e3<this.selectedText.length?(t=a.editor.getCursor(),a.editor.setValue(e),i=a.editor.lineCount(),t.line<i?(s=a.editor.getLine(t.line).length,n=Math.min(t.ch,s),a.editor.setCursor({line:t.line,ch:n})):(l=i-1,o=a.editor.getLine(l).length,a.editor.setCursor({line:l,ch:o}))):(this.selectedText,a.editor.replaceSelection(e)),this.close()):new Notice("æ— æ³•æ‰¾åˆ°æ´»åŠ¨çš„ç¼–è¾‘å™¨")}catch(e){}}escapeHtml(e){var t=document.createElement("div");return t.textContent=e,t.innerHTML}getModelOptions(){if(!this.plugin)return'<option value="">ä½¿ç”¨é»˜è®¤æ¨¡å‹</option>';var e=this.plugin.getAvailableModels();let i=this.plugin.settings.currentModel;return 0===e.length?'<option value="">æ— å¯ç”¨æ¨¡å‹</option>':0===(e=e.filter(e=>"image"!==e.type)).length?'<option value="">æ— å¯ç”¨çš„æ–‡æœ¬æ¨¡å‹</option>':e.map(e=>{var t=e.id===i?"selected":"";return`<option value="${e.id}" ${t} data-type="${e.type||"text"}">${e.name}</option>`}).join("")}showFileSelector(){if(this.modalEl){let t=["md","txt","docx","doc","pdf","xlsx","xls","epub","mobi","csv","json"];var e=this.plugin.app.vault.getFiles().filter(e=>{e=e.extension.toLowerCase();return t.includes(e)}).map(e=>({name:e.basename,path:e.path,extension:e.extension.toLowerCase()})),i=this.modalEl.querySelector(".flowtext-modal-header");i&&(i=i.getBoundingClientRect(),new FileSelectionWindow(this.plugin.app,e,e=>{this.addFilesToContext(e)}).open(i))}}showFolderSelector(){var e,t;this.modalEl&&(e=this.plugin.app.vault.getAllLoadedFiles().filter(e=>e.children).map(e=>({name:e.name,path:e.path})),t=this.modalEl.querySelector(".flowtext-modal-header"))&&(t=t.getBoundingClientRect(),new FolderSelectionWindow(this.plugin.app,e,e=>{this.addFoldersToContext(e)}).open(t))}addFilesToContext(e){e.forEach(t=>{this.selectedContext.files.some(e=>e.path===t.path)||this.selectedContext.files.push(t)}),this.updateContextDisplay()}addFoldersToContext(e){e.forEach(t=>{this.selectedContext.folders.some(e=>e.path===t.path)||this.selectedContext.folders.push(t)}),this.updateContextDisplay()}updateContextDisplay(){if(this.modalEl){let i=this.modalEl.querySelector(".flowtext-image-previews-context");i&&(i.innerHTML="",this.selectedContext.files.forEach(e=>{var t=document.createElement("div");t.className="flowtext-context-item",t.innerHTML=`
				<span class="flowtext-context-icon">ğŸ“„</span>
				<span class="flowtext-context-name">${e.name}</span>
				<button class="flowtext-context-remove" data-type="file" data-path="${e.path}">Ã—</button>
			`,i.appendChild(t)}),this.selectedContext.folders.forEach(e=>{var t=document.createElement("div");t.className="flowtext-context-item",t.innerHTML=`
				<span class="flowtext-context-icon">ğŸ“</span>
				<span class="flowtext-context-name">${e.name}</span>
				<button class="flowtext-context-remove" data-type="folder" data-path="${e.path}">Ã—</button>
			`,i.appendChild(t)}),i.querySelectorAll(".flowtext-context-remove").forEach(i=>{i.onclick=e=>{e.stopPropagation();var e=i.getAttribute("data-type"),t=i.getAttribute("data-path");this.removeFromContext(e,t)}}))}}removeFromContext(e,t){"file"===e?this.selectedContext.files=this.selectedContext.files.filter(e=>e.path!==t):"folder"===e&&(this.selectedContext.folders=this.selectedContext.folders.filter(e=>e.path!==t)),this.updateContextDisplay()}clearContext(){this.selectedContext={files:[],folders:[]},this.updateContextDisplay()}async processInlineImages(){var e;if(this.contextSelector&&this.contextSelector.inputEl)for(e of this.contextSelector.inputEl.querySelectorAll(".flowtext-inline-tag")){var t=e.getAttribute("data-type"),i=e.getAttribute("data-path");if("image"===t)try{var s=this.plugin.app.vault.getAbstractFileByPath(i);if(s){var n=await this.plugin.app.vault.readBinary(s),l=new Uint8Array(n);let t="";for(let e=0;e<l.length;e++)t+=String.fromCharCode(l[e]);var o=btoa(t),a={jpg:"image/jpeg",jpeg:"image/jpeg",png:"image/png",gif:"image/gif",webp:"image/webp",bmp:"image/bmp",svg:"image/svg+xml"}[s.extension?.toLowerCase()||"png"]||"image/png",r=`data:${a};base64,`+o;let i={id:Date.now()+Math.random(),name:s.name,size:n.byteLength,type:a,base64:r,url:r,fromInline:!0};this.imageHandler.images.some(e=>e.name===i.name&&e.size===i.size)||this.imageHandler.images.push(i)}}catch(e){console.error("æ— æ³•è¯»å–å›¾ç‰‡: "+i,e),new Notice("æ— æ³•è¯»å–å›¾ç‰‡: "+i)}}}async getContextContent(){let t="";for(var i of this.selectedContext.files)try{var e,s=this.plugin.app.vault.getAbstractFileByPath(i.path);s?(e=await this.plugin.app.vault.read(s),t+=`

--- æ–‡ä»¶: ${i.path} ---
`+e):t+=`

--- æ–‡ä»¶: ${i.path} ---
[æ–‡ä»¶ä¸å­˜åœ¨]`}catch(e){t+=`

--- æ–‡ä»¶: ${i.path} ---
[æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹: ${e.message}]`}for(var n of this.selectedContext.folders)try{var l,o=this.plugin.app.vault.getAbstractFileByPath(n.path);if(o)for(l of await this.getAllMarkdownFilesRecursively(o))try{var a=await this.plugin.app.vault.read(l);t+=`

--- æ–‡ä»¶: ${l.path} ---
`+a}catch(e){t+=`

--- æ–‡ä»¶: ${l.path} ---
[æ— æ³•è¯»å–æ–‡ä»¶å†…å®¹: ${e.message}]`}else t+=`

--- æ–‡ä»¶å¤¹: ${n.path} ---
[æ–‡ä»¶å¤¹ä¸å­˜åœ¨]`}catch(e){t+=`

--- æ–‡ä»¶å¤¹: ${n.path} ---
[æ— æ³•è¯»å–æ–‡ä»¶å¤¹å†…å®¹: ${e.message}]`}return t}async getAllMarkdownFilesRecursively(e){let i=[];return(t=>{var e;for(e of this.plugin.app.vault.getFiles().filter(e=>e.path.startsWith(t.path+"/")||e.path===t.path))"md"===e.extension&&i.push(e)})(e),i}setupDraggable(){let t=this.modalEl.querySelector(".flowtext-modal-content"),i=this.modalEl.querySelector(".flowtext-modal-header");if(!t||!i)return;let s=!1,n,l,o,a,r=0,d=0;var e=e=>{e.target!==i&&!i.contains(e.target)||e.target.closest(".flowtext-modal-close")||e.target.closest(".flowtext-clear-btn")||e.target.closest(".flowtext-toggle-btn")||(a="touchstart"===e.type?(o=e.touches[0].clientX-r,e.touches[0].clientY-d):(o=e.clientX-r,e.clientY-d),s=!0,i.style.cursor="grabbing")},c=()=>{s=!1,i.style.cursor="grab"},p=e=>{s&&(e.preventDefault(),l="touchmove"===e.type?(n=e.touches[0].clientX-o,e.touches[0].clientY-a):(n=e.clientX-o,e.clientY-a),r=n,d=l,h(n,l,t))};let h=(e,t,i)=>{i.style.transform=`translate(${e}px, ${t}px)`};i.style.cursor="grab",i.style.userSelect="none",i.addEventListener("mousedown",e),document.addEventListener("mousemove",p),document.addEventListener("mouseup",c),i.addEventListener("touchstart",e,{passive:!1}),document.addEventListener("touchmove",p,{passive:!1}),document.addEventListener("touchend",c),this.dragEventListeners=[{element:i,event:"mousedown",handler:e},{element:document,event:"mousemove",handler:p},{element:document,event:"mouseup",handler:c},{element:i,event:"touchstart",handler:e},{element:document,event:"touchmove",handler:p},{element:document,event:"touchend",handler:c}]}close(){this.isOpen&&(this.isOpen=!1,this.dragEventListeners&&(this.dragEventListeners.forEach(({element:e,event:t,handler:i})=>{e.removeEventListener(t,i)}),this.dragEventListeners=[]),this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e&&i&&e.removeEventListener(t,i)}),this.eventListeners=[],this.contextSelector&&this.contextSelector.close(),this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}}class FlowTextSettingTab extends PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){let l=this.containerEl;l.empty(),l.createEl("h2",{text:"FlowText è®¾ç½®"});this.plugin.isPluginActivated||(e=l.createEl("div",{attr:{style:"background: var(--background-modifier-error); color: var(--text-error); padding: 15px; border-radius: 6px; margin-bottom: 20px; border: 1px solid var(--text-error);"}}),t=this.plugin.app.plugins[deobfuscateString(OBFUSCATED_MAPPINGS.enabledPlugins)].has(deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"])),e.innerHTML=t?`
					<h3 style="margin: 0 0 10px 0;">âš ï¸ error-cp</h3>
					<p style="margin: 0;">error-cp</p>
				`:`
					<h3 style="margin: 0 0 10px 0;">âš ï¸ error-cp</h3>
					<p style="margin: 0 0 8px 0;">error-cp</p>
					<p style="margin: 0; font-size: 0.9em;">è¯·å‰å¾€ï¼šè®¾ç½® â†’ ç¤¾åŒºæ’ä»¶ â†’ æ‰¾åˆ°"${deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"])}"å¹¶å¯ç”¨</p>
				`),l.createEl("h3",{text:"ä¾›åº”å•†ã€APIè®¾ç½®"}),l.createEl("p",{text:"APIKeyï¼ˆéœ€å¡«ï¼‰ï¼šé™¤ollamaå¤–ï¼Œéœ€åœ¨ä¾›åº”å•†APIå¯†é’¥ä¸­è®¾ç½®APIKey",attr:{style:"color: var(--text-muted); margin-bottom: 5px;"}}),l.createEl("p",{text:"Base URLï¼ˆå¯é€‰ï¼‰ï¼šå¯é€‰å¡«ç¬¬ä¸‰æ–¹URLï¼Œä½†å»ºè®®ä½¿ç”¨openaiå…¼å®¹çš„æ ¼å¼ï¼ˆé€šå¸¸urlæœ«å°¾åŒ…å«v1ï¼‰ï¼Œä½†ä¹Ÿæœ‰ä¾‹å¤–ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ— æ³•è°ƒç”¨æ¨¡å‹",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}});var e=l.createEl("table",{cls:"flowtext-config-table"}),t=e.createEl("thead").createEl("tr");t.createEl("th",{text:"ID"}),t.createEl("th",{text:"Type"}),t.createEl("th",{text:"API Key"}),t.createEl("th",{text:"Get API keys"}),t.createEl("th",{text:"Actions"});let o=e.createEl("tbody"),n=(Object.keys(this.plugin.settings.providers).forEach(t=>{var e=this.plugin.settings.providers[t],i=o.createEl("tr"),s=(i.createEl("td",{text:t}),i.createEl("td",{text:{openai:"OpenAI",anthropic:"Anthropic",gemini:"Gemini",deepseek:"DeepSeek",ollama:"Ollama"}[t]||t}),i.createEl("td",{cls:"flowtext-api-key-cell"})),s=(e.apiKey&&e.apiKey.trim()?(s.createEl("span",{text:"â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢",attr:{style:"color: var(--text-muted); margin-right: 8px;"}}),(n=s.createEl("button",{cls:"flowtext-settings-btn",attr:{title:"è®¾ç½®API Key"}})).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',n.onclick=()=>this.showApiKeyModal(t)):((n=s.createEl("button",{cls:"flowtext-settings-btn",attr:{title:"è®¾ç½®API Key"}})).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-settings-icon lucide-settings"><path d="M9.671 4.136a2.34 2.34 0 0 1 4.659 0 2.34 2.34 0 0 0 3.319 1.915 2.34 2.34 0 0 1 2.33 4.033 2.34 2.34 0 0 0 0 3.831 2.34 2.34 0 0 1-2.33 4.033 2.34 2.34 0 0 0-3.319 1.915 2.34 2.34 0 0 1-4.659 0 2.34 2.34 0 0 0-3.32-1.915 2.34 2.34 0 0 1-2.33-4.033 2.34 2.34 0 0 0 0-3.831A2.34 2.34 0 0 1 6.35 6.051a2.34 2.34 0 0 0 3.319-1.915"/><circle cx="12" cy="12" r="3"/></svg>',n.onclick=()=>this.showApiKeyModal(t)),i.createEl("td",{attr:{style:"text-align: left;"}})),n=e?.apiKeyLink,e=this.plugin.settings.apiKeyLinks?.[t],n=n||e||{openai:"https://platform.openai.com/api-keys",anthropic:"https://console.anthropic.com/",gemini:"https://aistudio.google.com/app/apikey",deepseek:"https://platform.deepseek.com/api_keys",ollama:"https://ollama.com/"}[t],e=(n?s.createEl("a",{text:"è·å–API Key",attr:{href:n,target:"_blank",style:"color: var(--text-accent); text-decoration: underline; font-size: 0.9em;"}}):s.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}}),i.createEl("td",{cls:"flowtext-actions-cell"}));["openai","anthropic","gemini","deepseek","ollama"].includes(t)?e.createEl("span",{text:"-",attr:{style:"color: var(--text-muted);"}}):(e.createEl("button",{text:"ç¼–è¾‘"}).onclick=()=>this.showEditProviderModal(t),e.createEl("button",{text:"åˆ é™¤"}).onclick=async()=>{var e;confirm(`ç¡®å®šè¦åˆ é™¤ä¾›åº”å•† "${t}" å—ï¼Ÿè¿™å°†åŒæ—¶åˆ é™¤è¯¥ä¾›åº”å•†ä¸‹çš„æ‰€æœ‰æ¨¡å‹ã€‚`)&&(Object.keys(this.plugin.settings.models).forEach(e=>{this.plugin.settings.models[e].provider===t&&delete this.plugin.settings.models[e]}),delete this.plugin.settings.providers[t],this.plugin.settings.models[this.plugin.settings.currentModel]?.provider===t&&(0<(e=Object.keys(this.plugin.settings.models).filter(e=>this.plugin.settings.models[e].enabled)).length?this.plugin.settings.currentModel=e[0]:this.plugin.settings.currentModel=""),await this.plugin.saveSettings(),this.display())})}),l.createEl("div",{attr:{style:"margin-top: 15px; margin-bottom: 20px;"}}).createEl("button",{text:"+ æ·»åŠ ä¾›åº”å•†",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;"}}).onclick=()=>this.showAddProviderModal(),l.createEl("h3",{text:"æ¨¡å‹è®¾ç½®",attr:{style:"margin-top: 30px;"}}),l.createEl("p",{text:"æŒ‰ç±»åˆ«ç®¡ç†AIæ¨¡å‹ï¼Œæ¯ä¸ªç±»åˆ«å…·æœ‰ä¸åŒçš„åŠŸèƒ½ç‰¹æ€§,å¯è‡ªè¡Œç‚¹å‡»ç¼–è¾‘æŒ‰é’®è°ƒæ•´æ¨¡å‹ç±»åˆ«",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),{}),i=(Object.keys(this.plugin.settings.models).forEach(e=>{var t=this.plugin.settings.models[e];let i=t.category;i||(i="image"===t.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT,t.category=i,this.plugin.saveSettings()),n[i]||(n[i]=[]),n[i].push({id:e,...t})}),[MODEL_CATEGORIES.THINKING,MODEL_CATEGORIES.VISION,MODEL_CATEGORIES.MULTIMODAL,MODEL_CATEGORIES.TEXT,MODEL_CATEGORIES.IMAGE].forEach(e=>{var t=n[e]||[],i=l.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-top: 20px; margin-bottom: 10px;"}});if(i.createEl("h4",{text:CATEGORY_ICONS[e]+" "+CATEGORY_NAMES[e],attr:{style:"margin: 0;"}}),i.createEl("button",{text:"+ æ·»åŠ æ¨¡å‹",attr:{style:"background: var(--interactive-accent); color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px;"}}).onclick=()=>this.showAddModelModal(e),0<t.length){var i=l.createEl("table",{cls:"flowtext-config-table"}),s=i.createEl("thead").createEl("tr");s.createEl("th",{text:"æ¥æº",attr:{style:"width: 60px; text-align: center;"}}),s.createEl("th",{text:"ID"}),s.createEl("th",{text:"Provider"}),s.createEl("th",{text:"Model"}),s.createEl("th",{text:"Enable"}),s.createEl("th",{text:"Actions"});let n=i.createEl("tbody");t.forEach(t=>{var e=n.createEl("tr"),i=e.createEl("td",{attr:{style:"text-align: center;"}});DEFAULT_MODEL_IDS.includes(t.id)?i.createEl("span",{text:"ğŸ ",attr:{title:"å†…ç½®æ¨¡å‹",style:"cursor: help; font-size: 16px;"}}):i.createEl("span",{text:"ğŸ‘¤",attr:{title:"è‡ªå®šä¹‰æ¨¡å‹",style:"cursor: help; font-size: 16px;"}}),e.createEl("td",{text:t.id}),e.createEl("td",{text:t.provider}),e.createEl("td",{text:t.name});let s=e.createEl("td",{cls:"flowtext-enable-cell"}).createEl("input",{type:"checkbox",attr:{checked:t.enabled?"checked":""}});s.onchange=async()=>{var e;this.plugin.settings.models[t.id].enabled=s.checked,await this.plugin.saveSettings(),s.checked||this.plugin.settings.currentModel!==t.id||0<(e=Object.keys(this.plugin.settings.models).filter(e=>this.plugin.settings.models[e].enabled)).length&&(this.plugin.settings.currentModel=e[0],await this.plugin.saveSettings(),this.display())};i=e.createEl("td",{cls:"flowtext-actions-cell"});i.createEl("button",{text:"ç¼–è¾‘"}).onclick=()=>this.showEditModelModal(t.id),i.createEl("button",{text:"åˆ é™¤"}).onclick=async()=>{var e;confirm(`ç¡®å®šè¦åˆ é™¤æ¨¡å‹ "${t.name}" å—ï¼Ÿ`)&&(this.plugin.settings.currentModel===t.id&&(0<(e=Object.keys(this.plugin.settings.models).filter(e=>e!==t.id)).length?this.plugin.settings.currentModel=e[0]:this.plugin.settings.currentModel=""),delete this.plugin.settings.models[t.id],await this.plugin.saveSettings(),this.display())}})}else l.createEl("p",{text:"æš‚æ— æ¨¡å‹ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ",attr:{style:"color: var(--text-muted); font-style: italic; margin-bottom: 15px;"}})}),new Setting(l).setName("å½“å‰æ¨¡å‹").setDesc("é€‰æ‹©å½“å‰ä½¿ç”¨çš„AIæ¨¡å‹").addDropdown(i=>{var e=Object.keys(this.plugin.settings.models).filter(e=>this.plugin.settings.models[e].enabled);e.forEach(e=>{var t=this.plugin.settings.models[e];i.addOption(e,t.name+` (${t.provider})`)}),e.includes(this.plugin.settings.currentModel)||0<e.length&&(this.plugin.settings.currentModel=e[0],this.plugin.saveSettings()),i.setValue(this.plugin.settings.currentModel||"").onChange(async e=>{this.plugin.settings.currentModel=e,await this.plugin.saveSettings()})}),new Setting(l).setName("æµ‹è¯•APIè¿æ¥").setDesc("æµ‹è¯•å½“å‰APIé…ç½®æ˜¯å¦æ­£å¸¸").addButton(t=>t.setButtonText("æµ‹è¯•è¿æ¥").onClick(async()=>{t.setButtonText("æµ‹è¯•ä¸­...");try{var e=await this.plugin.aiService.testConnection();e.success?new Notice("âœ… APIè¿æ¥æˆåŠŸ"):new Notice("âŒ APIè¿æ¥å¤±è´¥: "+e.message)}catch(e){new Notice("âŒ æµ‹è¯•å¤±è´¥: "+e.message)}finally{t.setButtonText("æµ‹è¯•è¿æ¥")}})),new Setting(l).setName("è¯·æ±‚è¶…æ—¶æ—¶é—´").setDesc("APIè¯·æ±‚è¶…æ—¶æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰").addText(e=>e.setPlaceholder("30000").setValue(String(this.plugin.settings.timeout)).onChange(async e=>{e=parseInt(e)||3e4;this.plugin.settings.timeout=e,await this.plugin.saveSettings()})),l.createEl("h3",{text:"åŠŸèƒ½è®¾ç½®"}),new Setting(l).setName("å¯ç”¨å³é”®èœå•").setDesc("åœ¨é€‰ä¸­æ–‡æœ¬æ—¶æ˜¾ç¤ºAIå¤„ç†é€‰é¡¹").addToggle(e=>e.setValue(this.plugin.settings.enableRightClick).onChange(async e=>{this.plugin.settings.enableRightClick=e,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new Setting(l).setName("å¯ç”¨@æˆ–è€…&ç¬¦å·è§¦å‘").setDesc("è¾“å…¥@æˆ–è€…&ç¬¦å·æ—¶å‘¼å‡ºç»­å†™å¯¹è¯æ¡†").addToggle(e=>e.setValue(this.plugin.settings.enableAtTrigger).onChange(async e=>{this.plugin.settings.enableAtTrigger=e,await this.plugin.saveSettings(),this.plugin.updateEventListeners()})),new Setting(l).setName("Geminiæ€è€ƒå¼ºåº¦").setDesc("æ§åˆ¶Geminiæ¨¡å‹çš„æ€è€ƒé‡ï¼Œä»…å¯¹Gemini 2.5ç³»åˆ—æ¨¡å‹æœ‰æ•ˆ").addDropdown(e=>e.addOption("none","æ— æ€è€ƒ").addOption("low","ä½å¼ºåº¦").addOption("medium","ä¸­ç­‰å¼ºåº¦").addOption("high","é«˜å¼ºåº¦").setValue(this.plugin.settings.geminiReasoningEffort||"low").onChange(async e=>{this.plugin.settings.geminiReasoningEffort=e,await this.plugin.saveSettings()})),l.createEl("h3",{text:"å…¨å±€è§„åˆ™è®¾ç½®"}),l.createEl("p",{text:"å…¨å±€è§„åˆ™ä¼šè‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰AIè¯·æ±‚ä¸­ï¼Œæ¯æ¬¡å¯¹è¯éƒ½éœ€è¦éµå¾ªå…¨å±€è§„åˆ™",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new Setting(l).setName("å¯ç”¨å…¨å±€è§„åˆ™").setDesc("å¼€å¯åï¼Œå…¨å±€è§„åˆ™å°†è‡ªåŠ¨åº”ç”¨åˆ°æ‰€æœ‰AIè¯·æ±‚ä¸­").addToggle(e=>e.setValue(this.plugin.settings.enableGlobalRules).onChange(async e=>{this.plugin.settings.enableGlobalRules=e,await this.plugin.saveSettings()})),new Setting(l).setName("ç®¡ç†å…¨å±€è§„åˆ™").setDesc("æ·»åŠ ã€ç¼–è¾‘å’Œç®¡ç†å…¨å±€è§„åˆ™").addButton(e=>e.setButtonText("æ‰“å¼€è§„åˆ™ç®¡ç†å™¨").onClick(()=>this.showRuleManager())),l.createEl("h3",{text:"æ–‡æœ¬å¤„ç†è®¾ç½®"}),new Setting(l).setName("ç»­å†™æ¨¡å¼").setDesc("æ™ºèƒ½ç»­å†™çš„åˆ›ä½œé£æ ¼").addDropdown(e=>e.addOption("creative","åˆ›æ„").addOption("logical","é€»è¾‘").addOption("balanced","å¹³è¡¡").setValue(this.plugin.settings.continueMode).onChange(async e=>{this.plugin.settings.continueMode=e,await this.plugin.saveSettings()})),new Setting(l).setName("ä¸Šä¸‹æ–‡å‰æ–‡æœ€å¤§è¡Œæ•°").setDesc("ç»­å†™æ¨¡å¼è·å–å…‰æ ‡å‰çš„æœ€å¤§è¡Œæ•°ï¼ˆé»˜è®¤ï¼š20ï¼‰").addText(e=>e.setPlaceholder(String(DEFAULT_SETTINGS.maxContextLines)).setValue(String(this.plugin.settings.maxContextLines||DEFAULT_SETTINGS.maxContextLines)).onChange(async e=>{e=parseInt(e)||DEFAULT_SETTINGS.maxContextLines;0<e?(this.plugin.settings.maxContextLines=e,await this.plugin.saveSettings()):new Notice("è¡Œæ•°å¿…é¡»ä¸ºæ­£æ•´æ•°")})),new Setting(l).setName("ä¸Šä¸‹æ–‡å‰æ–‡æœ€å¤§å­—ç¬¦æ•°").setDesc("ç»­å†™æ¨¡å¼æˆªå–å…‰æ ‡å‰æ–‡æœ¬çš„æœ€å¤§å­—ç¬¦æ•°ï¼ˆé»˜è®¤ï¼š3000ï¼‰").addText(e=>e.setPlaceholder(String(DEFAULT_SETTINGS.maxContextChars)).setValue(String(this.plugin.settings.maxContextChars||DEFAULT_SETTINGS.maxContextChars)).onChange(async e=>{e=parseInt(e)||DEFAULT_SETTINGS.maxContextChars;0<e?(this.plugin.settings.maxContextChars=e,await this.plugin.saveSettings()):new Notice("å­—ç¬¦æ•°å¿…é¡»ä¸ºæ­£æ•´æ•°")})),new Setting(l).setName("æœ€å¤§Tokenæ•°").setDesc("AIç”Ÿæˆæ–‡æœ¬çš„æœ€å¤§é•¿åº¦é™åˆ¶ï¼Œæ•°å€¼è¶Šå¤§ç”Ÿæˆå†…å®¹è¶Šé•¿ï¼ˆé»˜è®¤ï¼š5000ï¼‰ï¼Œçº¦1.5token/ä¸­æ–‡å­—").addText(e=>e.setPlaceholder("5000").setValue(String(this.plugin.settings.maxTokens)).onChange(async e=>{e=parseInt(e)||5e3;0<e?(this.plugin.settings.maxTokens=e,await this.plugin.saveSettings()):new Notice("Tokenæ•°å¿…é¡»ä¸ºæ­£æ•´æ•°")})),l.createEl("h3",{text:"å›¾ç‰‡è®¾ç½®"}),l.createEl("p",{text:"é…ç½®AIç”Ÿæˆå›¾ç‰‡çš„ä¿å­˜è·¯å¾„å’Œæ˜¾ç¤ºå¤§å°",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new Setting(l).setName("å›¾ç‰‡ä¿å­˜è·¯å¾„").setDesc("AIç”Ÿæˆå›¾ç‰‡çš„ä¿å­˜è·¯å¾„ï¼Œç›¸å¯¹äºåº“æ ¹ç›®å½•ï¼ˆé»˜è®¤ï¼šExtras/é™„ä»¶ï¼‰").addText(e=>e.setPlaceholder("Extras/é™„ä»¶").setValue(this.plugin.settings.imageSavePath||"Extras/é™„ä»¶").onChange(async e=>{let t=e.trim()||"Extras/é™„ä»¶";(t=t.startsWith("/")?t.substring(1):t).endsWith("/")&&(t=t.slice(0,-1)),this.plugin.settings.imageSavePath=t,await this.plugin.saveSettings()})),new Setting(l).setName("å›¾ç‰‡æ˜¾ç¤ºå¤§å°").setDesc("æ’å…¥å›¾ç‰‡æ—¶çš„ç­‰æ¯”ä¾‹ç¼©æ”¾æ•°å€¼ï¼Œç”¨äºMarkdownæ˜¾ç¤ºï¼ˆé»˜è®¤ï¼š300ï¼‰").addText(e=>e.setPlaceholder("300").setValue(String(this.plugin.settings.imageSize||300)).onChange(async e=>{e=parseInt(e)||300;0<e?(this.plugin.settings.imageSize=e,await this.plugin.saveSettings()):new Notice("å›¾ç‰‡å¤§å°å¿…é¡»ä¸ºæ­£æ•´æ•°")})),new Setting(l).setName("æŒ‡å¯¼å°ºåº¦ï¼ˆGuidance Scaleï¼‰").setDesc("æ¨¡å‹è¾“å‡ºç»“æœä¸promptçš„ä¸€è‡´ç¨‹åº¦ï¼Œå³ç”Ÿæˆå›¾åƒçš„è‡ªç”±åº¦ï¼šå€¼è¶Šå¤§ï¼Œæ¨¡å‹è‡ªç”±åº¦è¶Šå°ã€‚ä¸ç”¨æˆ·è¾“å…¥çš„æç¤ºè¯ç›¸å…³æ€§è¶Šå¼ºã€‚å–å€¼èŒƒå›´ï¼š[1, 10]ï¼Œé»˜è®¤å€¼ï¼š2.5").addText(e=>e.setPlaceholder("2.5").setValue(String(this.plugin.settings.guidanceScale||2.5)).onChange(async e=>{e=parseFloat(e)||2.5;1<=e&&e<=10?(this.plugin.settings.guidanceScale=e,await this.plugin.saveSettings()):new Notice("Guidance Scaleå¿…é¡»åœ¨1-10ä¹‹é—´")})),[{value:"1024x1024",label:"1024x1024 (1:1)"},{value:"864x1152",label:"864x1152 (3:4)"},{value:"1152x864",label:"1152x864 (4:3)"},{value:"1280x720",label:"1280x720 (16:9)"},{value:"720x1280",label:"720x1280 (9:16)"},{value:"832x1248",label:"832x1248 (2:3)"},{value:"1248x832",label:"1248x832 (3:2)"},{value:"1512x648",label:"1512x648 (21:9)"}]);if(new Setting(l).setName("å›¾ç‰‡ç”Ÿæˆå°ºå¯¸").setDesc("è®¾ç½®ç”Ÿæˆå›¾ç‰‡çš„å®½é«˜åƒç´ ï¼Œè¦æ±‚ä»‹äº [512 x 512, 2048 x 2048] ä¹‹é—´").addDropdown(t=>{i.forEach(e=>{t.addOption(e.value,e.label)}),t.setValue(this.plugin.settings.imageGenerationSize||"1024x1024"),t.onChange(async e=>{this.plugin.settings.imageGenerationSize=e,await this.plugin.saveSettings()})}),l.createEl("h3",{text:"å¸¸ç”¨æç¤ºè¯ç®¡ç†"}),l.createEl("p",{text:"ç®¡ç†å¸¸ç”¨æç¤ºè¯ï¼Œå¯åœ¨è¾“å…¥æ¡†ä¸­ä½¿ç”¨#ç¬¦å·å¿«é€Ÿè°ƒç”¨",attr:{style:"color: var(--text-muted); margin-bottom: 15px;"}}),new Setting(l).setName("æ·»åŠ æ–°æç¤ºè¯").setDesc("åˆ›å»ºä¸€ä¸ªæ–°çš„å¸¸ç”¨æç¤ºè¯").addButton(e=>e.setButtonText("æ·»åŠ æç¤ºè¯").onClick(()=>this.showPromptModal())),this.plugin.settings.commonPrompts&&0<this.plugin.settings.commonPrompts.length){let n=l.createEl("div",{attr:{style:"margin-top: 15px;"}});this.plugin.settings.commonPrompts.forEach((e,t)=>{var i=n.createEl("div",{attr:{style:"display: flex; align-items: center; justify-content: space-between; padding: 10px; margin-bottom: 8px; border: 1px solid var(--background-modifier-border); border-radius: 6px; background: var(--background-secondary);"}}),s=i.createEl("div",{attr:{style:"flex: 1;"}}),s=(s.createEl("div",{text:e.name||"æœªå‘½åæç¤ºè¯",attr:{style:"font-weight: bold; margin-bottom: 4px;"}}),s.createEl("div",{text:e.content&&100<e.content.length?e.content.substring(0,100)+"...":e.content||"",attr:{style:"color: var(--text-muted); font-size: 0.7em;"}}),i.createEl("div",{attr:{style:"display: flex; gap: 8px;"}}));s.createEl("button",{text:"ç¼–è¾‘",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--background-modifier-border); background: var(--background-primary); color: var(--text-normal); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.showPromptModal(t),s.createEl("button",{text:"åˆ é™¤",attr:{style:"padding: 4px 8px; font-size: 0.8em; border: 1px solid var(--text-error); background: var(--background-primary); color: var(--text-error); border-radius: 4px; cursor: pointer;"}}).onclick=()=>this.deletePrompt(t)})}else l.createEl("p",{text:"æš‚æ— å¸¸ç”¨æç¤ºè¯ï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ ",attr:{style:"color: var(--text-muted); font-style: italic; margin-top: 15px;"}})}showApiKeyModal(e){let t=new Modal(this.app);t.titleEl.setText(`è®¾ç½® ${e.toUpperCase()} é…ç½®`);var i=t.contentEl,s=this.plugin.settings.providers[e];i.createEl("label",{text:"API Key:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=i.createEl("input",{type:"password",placeholder:"è¯·è¾“å…¥API Key",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),l=(n.value=s?.apiKey||"",i.createEl("label",{text:"Base URL (å¯é€‰):",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),i.createEl("input",{type:"text",placeholder:"ä¾‹å¦‚: https://api.example.com/v1",value:s?.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));s=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),s.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close(),i=s.createEl("button",{text:"ä¿å­˜",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let o=async()=>{this.plugin.settings.providers[e]||(this.plugin.settings.providers[e]={...DEFAULT_SETTINGS.providers[e]}),this.plugin.settings.providers[e].apiKey=n.value.trim(),this.plugin.settings.providers[e].baseUrl=l.value.trim(),n.value.trim()&&(this.plugin.settings.providers[e].enabled=!0),await this.plugin.saveSettings(),new Notice(e.toUpperCase()+" é…ç½®å·²ä¿å­˜"),t.close(),this.display()};i.onclick=o;s=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),o())};n.addEventListener("keydown",s),l.addEventListener("keydown",s),t.open(),n.focus()}showProviderSettings(e){let t=new Modal(this.app);t.titleEl.setText(e.toUpperCase()+" ä¾›åº”å•†è®¾ç½®");var i=t.contentEl,s=this.plugin.settings.providers[e];i.createEl("label",{text:"Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let n=i.createEl("input",{type:"text",placeholder:"https://api.example.com/v1",value:s.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});var l=i.createEl("div",{attr:{style:"display: flex; align-items: center; margin-bottom: 15px;"}});l.createEl("label",{text:"å¯ç”¨ä¾›åº”å•†:",attr:{style:"margin-right: 10px; font-weight: bold;"}});let o=l.createEl("input",{type:"checkbox",attr:{checked:s.enabled?"checked":""}});l=i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),l.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close(),s=l.createEl("button",{text:"ä¿å­˜",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let a=async()=>{this.plugin.settings.providers[e].baseUrl=n.value,this.plugin.settings.providers[e].enabled=o.checked,await this.plugin.saveSettings(),new Notice(e.toUpperCase()+" è®¾ç½®å·²ä¿å­˜"),t.close(),this.display()};s.onclick=a;n.addEventListener("keydown",e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),a())}),t.open()}showPromptModal(s=null){let t=new Modal(this.app);t.titleEl.setText(null!==s?"ç¼–è¾‘æç¤ºè¯":"æ·»åŠ æ–°æç¤ºè¯");var e=t.contentEl;let n=null!==s,l=n&&this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[s]?this.plugin.settings.commonPrompts[s]:null,o=(n&&this.plugin.settings.commonPrompts,e.createEl("label",{text:"æç¤ºè¯åç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥æç¤ºè¯åç§°",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),a=(n&&l&&l.name&&(o.value=l.name),e.createEl("label",{text:"æç¤ºè¯å†…å®¹:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("textarea",{placeholder:"è¯·è¾“å…¥æç¤ºè¯å†…å®¹",attr:{style:"width: 100%; height: 120px; padding: 8px; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; resize: vertical; font-family: var(--font-text);"}}));n&&l&&l.content&&(a.value=l.content);e=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),e.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>t.close(),e=e.createEl("button",{text:n?"æ›´æ–°":"æ·»åŠ ",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let i=async()=>{let i=o.value.trim();var e=a.value.trim();i?e?-1!==this.plugin.settings.commonPrompts.findIndex((e,t)=>e.name===i&&t!==s)?new Notice("æç¤ºè¯åç§°å·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–åç§°"):(this.plugin.settings.commonPrompts||(this.plugin.settings.commonPrompts=[]),e={id:n?l.id:Date.now().toString(),name:i,content:e},n?this.plugin.settings.commonPrompts[s]=e:this.plugin.settings.commonPrompts.push(e),await this.plugin.saveSettings(),new Notice(n?"æç¤ºè¯å·²æ›´æ–°":"æç¤ºè¯å·²æ·»åŠ "),t.close(),this.display()):new Notice("è¯·è¾“å…¥æç¤ºè¯å†…å®¹"):new Notice("è¯·è¾“å…¥æç¤ºè¯åç§°")};e.onclick=i;e=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),i())};o.addEventListener("keydown",e),a.addEventListener("keydown",e),t.open(),o.focus()}async deletePrompt(e){if(this.plugin.settings.commonPrompts&&this.plugin.settings.commonPrompts[e]){let s=this.plugin.settings.commonPrompts[e];await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("ç¡®è®¤åˆ é™¤");var i=t.contentEl,i=(i.createEl("p",{text:`ç¡®å®šè¦åˆ é™¤æç¤ºè¯ "${s.name||"æœªå‘½åæç¤ºè¯"}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,attr:{style:"margin-bottom: 20px;"}}),i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));i.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>{t.close(),e(!1)},i.createEl("button",{text:"åˆ é™¤",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=()=>{t.close(),e(!0)},t.open()})&&(this.plugin.settings.commonPrompts.splice(e,1),await this.plugin.saveSettings(),new Notice("æç¤ºè¯å·²åˆ é™¤"),this.display())}}showRuleManager(){let e=new Modal(this.app);e.titleEl.setText("å…¨å±€è§„åˆ™ç®¡ç†å™¨"),e.modalEl.addClass("flowtext-rule-manager-modal");var t=e.contentEl,t=(t.empty(),t.createEl("div",{attr:{style:"min-height: 500px; display: flex; flex-direction: column;"}})),i=t.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid var(--background-modifier-border);"}}),s=i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}}),s=(s.createEl("button",{text:"æ–°å»ºè§„åˆ™",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showRuleEditor(e),s.createEl("button",{text:"ä»æç¤ºè¯åˆ›å»º",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.showTemplateSelector(e),i.createEl("div",{attr:{style:"display: flex; gap: 10px;"}})),i=(s.createEl("button",{text:"å¯¼å…¥è§„åˆ™",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.importRules(e),s.createEl("button",{text:"å¯¼å‡ºè§„åˆ™",attr:{style:"padding: 6px 12px;"}}).onclick=()=>this.exportRules(),t.createEl("div",{attr:{style:"flex: 1; overflow-y: auto;"}}));this.renderRuleList(i,e),e.open()}renderRuleList(l,o){l.empty();var e=this.plugin.ruleManager.getRules();if(0===e.length)l.createEl("div",{text:'æš‚æ— è§„åˆ™ï¼Œç‚¹å‡»"æ–°å»ºè§„åˆ™"æˆ–"ä»æ¨¡æ¿åˆ›å»º"å¼€å§‹æ·»åŠ ',attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});else{let i={},s=(e.forEach(e=>{var t=e.category||"custom";i[t]||(i[t]=[]),i[t].push(e)}),{writing:"å†™ä½œé£æ ¼",format:"æ ¼å¼è¦æ±‚",language:"è¯­è¨€è®¾ç½®",custom:"è‡ªå®šä¹‰è§„åˆ™"});Object.entries(i).forEach(([e,t])=>{l.createEl("h4",{text:s[e]||e,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),t.forEach(e=>{var t=l.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; background: var(--background-secondary);"}}),i=t.createEl("div",{attr:{style:"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;"}}),s=i.createEl("div",{attr:{style:"flex: 1;"}}),s=(s.createEl("h5",{text:e.name,attr:{style:"margin: 0 0 5px 0; font-weight: 600;"}}),e.description&&s.createEl("p",{text:e.description,attr:{style:"margin: 0; color: var(--text-muted); font-size: 0.9em;"}}),i.createEl("div",{attr:{style:"display: flex; gap: 8px; align-items: center;"}}));let n=s.createEl("input",{type:"checkbox",attr:{style:"margin-right: 5px;"}});n.checked=!1!==e.enabled,n.onchange=async()=>{try{this.plugin.ruleManager.toggleRule(e.id),new Notice(n.checked?"è§„åˆ™å·²å¯ç”¨":"è§„åˆ™å·²ç¦ç”¨")}catch(e){new Notice("æ“ä½œå¤±è´¥: "+e.message)}},s.createEl("button",{text:"ç¼–è¾‘",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>{this.showRuleEditor(o,e)},s.createEl("button",{text:"åˆ é™¤",cls:"mod-warning",attr:{style:"padding: 4px 8px; font-size: 0.8em;"}}).onclick=()=>this.deleteRule(e,o),e.content&&(t.createEl("div",{attr:{style:"background: var(--background-primary); padding: 10px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.85em; color: var(--text-muted); max-height: 100px; overflow-y: auto;"}}).textContent=200<e.content.length?e.content.substring(0,200)+"...":e.content)})})}}showRuleEditor(n,l=null){let o=new Modal(this.app);o.titleEl.setText(l?"ç¼–è¾‘è§„åˆ™":"æ–°å»ºè§„åˆ™"),o.modalEl.addClass("flowtext-rule-editor-modal");var e=o.contentEl,t=(e.empty(),e.createEl("div",{attr:{style:"display: flex; flex-direction: column; gap: 15px; min-width: 500px;"}}));t.createEl("label",{text:"è§„åˆ™åç§°",attr:{style:"font-weight: 600;"}});let a=t.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥è§„åˆ™åç§°",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),r=(l&&l.name&&(a.value=l.name),t.createEl("label",{text:"è§„åˆ™æè¿°",attr:{style:"font-weight: 600;"}}),t.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥è§„åˆ™æè¿°ï¼ˆå¯é€‰ï¼‰",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),d=(l&&l.description&&(r.value=l.description),t.createEl("label",{text:"è§„åˆ™åˆ†ç±»",attr:{style:"font-weight: 600;"}}),t.createEl("select",{attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));let i=l?l.category:"custom",c=([{value:"writing",text:"å†™ä½œé£æ ¼"},{value:"format",text:"æ ¼å¼è¦æ±‚"},{value:"language",text:"è¯­è¨€è®¾ç½®"},{value:"custom",text:"è‡ªå®šä¹‰è§„åˆ™"}].forEach(e=>{var t=d.createEl("option",{value:e.value,text:e.text});e.value===i&&(t.selected=!0)}),t.createEl("label",{text:"ä¼˜å…ˆçº§ (æ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœ€å¤§10)",attr:{style:"font-weight: 600;"}}),t.createEl("input",{type:"number",min:0,max:10,attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),p=(l&&void 0!==l.priority?c.value=l.priority:c.value=0,t.createEl("label",{text:"è§„åˆ™å†…å®¹",attr:{style:"font-weight: 600;"}}),t.createEl("textarea",{placeholder:"è¯·è¾“å…¥è§„åˆ™å†…å®¹ï¼Œè¿™äº›å†…å®¹å°†ä½œä¸ºç³»ç»Ÿæç¤ºè¯çš„ä¸€éƒ¨åˆ†",attr:{style:"padding: 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; min-height: 150px; font-family: var(--font-monospace); resize: vertical;"}}));l&&l.content&&(p.value=l.content);var s=t.createEl("div",{attr:{style:"display: flex; align-items: center; gap: 8px;"}});let h=s.createEl("input",{type:"checkbox"});h.checked=!l||!1!==l.enabled,s.createEl("label",{text:"å¯ç”¨æ­¤è§„åˆ™",attr:{style:"font-weight: 600;"}});s=t.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 20px;"}});s.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 8px 16px;"}}).onclick=()=>o.close();let u=s.createEl("button",{text:l?"æ›´æ–°":"åˆ›å»º",cls:"mod-cta",attr:{style:"padding: 8px 16px;"}});u.onclick=async()=>{var e=a.value.trim(),t=p.value.trim();if(e)if(t){var i=parseInt(c.value)||0;if(10<i)new Notice("ä¼˜å…ˆçº§ä¸èƒ½è¶…è¿‡10"),c.focus();else try{var s={name:e,description:r.value.trim(),category:d.value,priority:i,content:t,enabled:h.checked};l?(this.plugin.ruleManager.updateRule(l.id,s),new Notice("è§„åˆ™å·²æ›´æ–°")):(this.plugin.ruleManager.addRule(s),new Notice("è§„åˆ™å·²åˆ›å»º")),o.close(),this.renderRuleList(n.contentEl.querySelector('[style*="flex: 1"]'),n)}catch(e){new Notice("æ“ä½œå¤±è´¥: "+e.message)}}else new Notice("è¯·è¾“å…¥è§„åˆ™å†…å®¹"),p.focus();else new Notice("è¯·è¾“å…¥è§„åˆ™åç§°"),a.focus()},e.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&"Enter"===e.key&&(e.preventDefault(),u.click())}),o.open(),a.focus()}showTemplateSelector(n){let l=new Modal(this.app),o=(l.titleEl.setText("ä»æ¨¡æ¿åˆ›å»ºè§„åˆ™"),l).contentEl;o.empty();var e=this.plugin.ruleManager.getTemplates();if(0===e.length)o.createEl("p",{text:"æš‚æ— å¯ç”¨æ¨¡æ¿",attr:{style:"text-align: center; color: var(--text-muted); padding: 40px;"}});else{let i={},s=(e.forEach(e=>{var t=e.category||"custom";i[t]||(i[t]=[]),i[t].push(e)}),{writing:"å†™ä½œé£æ ¼",format:"æ ¼å¼è¦æ±‚",language:"è¯­è¨€è®¾ç½®",custom:"è‡ªå®šä¹‰æ¨¡æ¿"});Object.entries(i).forEach(([e,t])=>{o.createEl("h4",{text:s[e]||e,attr:{style:"margin: 20px 0 10px 0; color: var(--text-accent);"}}),t.forEach(e=>{let t=o.createEl("div",{attr:{style:"border: 1px solid var(--background-modifier-border); border-radius: 6px; padding: 15px; margin-bottom: 10px; cursor: pointer; transition: background-color 0.2s;"}});t.addEventListener("mouseenter",()=>{t.style.backgroundColor="var(--background-modifier-hover)"}),t.addEventListener("mouseleave",()=>{t.style.backgroundColor=""}),t.createEl("h5",{text:e.name,attr:{style:"margin: 0 0 8px 0; font-weight: 600;"}}),e.description&&t.createEl("p",{text:e.description,attr:{style:"margin: 0 0 10px 0; color: var(--text-muted); font-size: 0.9em;"}}),e.content&&(t.createEl("div",{attr:{style:"background: var(--background-primary); padding: 8px; border-radius: 4px; font-family: var(--font-monospace); font-size: 0.8em; color: var(--text-muted);"}}).textContent=100<e.content.length?e.content.substring(0,100)+"...":e.content),t.onclick=async()=>{try{this.plugin.ruleManager.createFromTemplate(e.id),new Notice("å·²ä»æ¨¡æ¿åˆ›å»ºè§„åˆ™: "+e.name),l.close(),this.renderRuleList(n.contentEl.querySelector('[style*="flex: 1"]'),n)}catch(e){new Notice("åˆ›å»ºå¤±è´¥: "+e.message)}}})}),l.open()}}async deleteRule(s,e){if(await new Promise(e=>{let t=new Modal(this.app);t.titleEl.setText("ç¡®è®¤åˆ é™¤");var i=t.contentEl,i=(i.createEl("p",{text:`ç¡®å®šè¦åˆ é™¤è§„åˆ™ "${s.name}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`,attr:{style:"margin-bottom: 20px;"}}),i.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px;"}}));i.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>{t.close(),e(!1)},i.createEl("button",{text:"åˆ é™¤",cls:"mod-warning",attr:{style:"padding: 6px 12px;"}}).onclick=()=>{t.close(),e(!0)},t.open()}))try{this.plugin.ruleManager.deleteRule(s.id),new Notice("è§„åˆ™å·²åˆ é™¤"),this.renderRuleList(e.contentEl.querySelector('[style*="flex: 1"]'),e)}catch(e){new Notice("åˆ é™¤å¤±è´¥: "+e.message)}}exportRules(){try{var e=this.plugin.ruleManager.exportRules(),t=JSON.stringify(e,null,2),i=new Blob([t],{type:"application/json"}),s=URL.createObjectURL(i),n=document.createElement("a");n.href=s,n.download=`flowtext-rules-${(new Date).toISOString().split("T")[0]}.json`,n.click(),URL.revokeObjectURL(s),new Notice("è§„åˆ™å·²å¯¼å‡º")}catch(e){new Notice("å¯¼å‡ºå¤±è´¥: "+e.message)}}importRules(n){var e=document.createElement("input");e.type="file",e.accept=".json",e.onchange=async e=>{e=e.target.files[0];if(e)try{var t=await e.text(),i=JSON.parse(t),s=this.plugin.ruleManager.importRules(i);new Notice(`æˆåŠŸå¯¼å…¥ ${s} æ¡è§„åˆ™`),this.renderRuleList(n.contentEl.querySelector('[style*="flex: 1"]'),n)}catch(e){new Notice("å¯¼å…¥å¤±è´¥: "+e.message)}},e.click()}showAddModelModal(s=null){let l=new Modal(this.app);l.titleEl.setText("æ·»åŠ æ–°æ¨¡å‹");var e=l.contentEl;e.createEl("label",{text:"æ¨¡å‹ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=e.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥æ¨¡å‹IDï¼ˆæ¨¡å‹èº«ä»½æ ‡è¯†ï¼Œé€šå¸¸ä¸å¸¦å‚æ•°ï¼Œä¾‹å¦‚ï¼šqwen2.5ã€deepseek-r1ï¼‰",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),a=(e.createEl("label",{text:"æ˜¾ç¤ºåç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥æ¨¡å‹æ˜¾ç¤ºåç§°ï¼ˆå¦‚ï¼šæˆ‘çš„è‡ªå®šä¹‰æ¨¡å‹ï¼‰",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),r=(e.createEl("label",{text:"ä¾›åº”å•†:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),d=(Object.keys(this.plugin.settings.providers).forEach(e=>{r.createEl("option",{value:e,text:e.toUpperCase()})}),e.createEl("label",{text:"å¸¦å‚æ•°çš„æ¨¡å‹åç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("p",{text:"å‘é€ç»™APIçš„å¸¦å‚æ•°çš„æ¨¡å‹åç§°ï¼Œå¦‚ï¼šqwen2.5:latestã€deepseek-r1:14bç­‰ï¼‰",attr:{style:"margin: 0 0 5px 0; color: var(--text-muted); font-size: 0.9em;"}}),e.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥å¸¦å‚æ•°çš„æ¨¡å‹åç§°",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),c=(e.createEl("label",{text:"æ¨¡å‹ç±»åˆ«:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("p",{text:"é€‰æ‹©æ¨¡å‹çš„åŠŸèƒ½ç±»åˆ«ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹æ¨¡å‹èƒ½åŠ›",attr:{style:"margin: 0 0 5px 0; color: var(--text-muted); font-size: 0.9em;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));[{value:MODEL_CATEGORIES.THINKING,text:CATEGORY_ICONS[MODEL_CATEGORIES.THINKING]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.THINKING]},{value:MODEL_CATEGORIES.VISION,text:CATEGORY_ICONS[MODEL_CATEGORIES.VISION]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.VISION]},{value:MODEL_CATEGORIES.MULTIMODAL,text:CATEGORY_ICONS[MODEL_CATEGORIES.MULTIMODAL]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.MULTIMODAL]},{value:MODEL_CATEGORIES.TEXT,text:CATEGORY_ICONS[MODEL_CATEGORIES.TEXT]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.TEXT]},{value:MODEL_CATEGORIES.IMAGE,text:CATEGORY_ICONS[MODEL_CATEGORIES.IMAGE]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.IMAGE]},{value:MODEL_CATEGORIES.VIDEO,text:CATEGORY_ICONS[MODEL_CATEGORIES.VIDEO]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.VIDEO]},{value:MODEL_CATEGORIES.LANGUAGE,text:CATEGORY_ICONS[MODEL_CATEGORIES.LANGUAGE]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.LANGUAGE]}].forEach(e=>{var t=c.createEl("option",{value:e.value,text:e.text}),i=s||MODEL_CATEGORIES.TEXT;e.value===i&&(t.selected=!0)});e=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),e.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>l.close(),e=e.createEl("button",{text:"æ·»åŠ ",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let t=async()=>{var e=o.value.trim(),t=a.value.trim(),i=r.value,s=d.value.trim(),n=c.value;e?t?s?this.plugin.settings.models[e]?new Notice("æ¨¡å‹IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ID"):(this.plugin.settings.models[e]={id:e,name:t,provider:i,actualModel:s,model:s,category:n,enabled:!0},await this.plugin.saveSettings(),new Notice("æ¨¡å‹å·²æ·»åŠ "),l.close(),this.display()):new Notice("è¯·è¾“å…¥å®é™…æ¨¡å‹åç§°"):new Notice("è¯·è¾“å…¥æ¨¡å‹æ˜¾ç¤ºåç§°"):new Notice("è¯·è¾“å…¥æ¨¡å‹ID")};e.onclick=t;e=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),t())};o.addEventListener("keydown",e),a.addEventListener("keydown",e),d.addEventListener("keydown",e),c.addEventListener("keydown",e),l.open(),o.focus()}showEditModelModal(o){let i=this.plugin.settings.models[o];if(!i){if(!(DEFAULT_SETTINGS&&DEFAULT_SETTINGS.models&&DEFAULT_SETTINGS.models[o]))return void new Notice("æ¨¡å‹ä¸å­˜åœ¨");this.plugin.settings.models[o]={...DEFAULT_SETTINGS.models[o]},i=this.plugin.settings.models[o],this.plugin.saveSettings()}let a=new Modal(this.app);a.titleEl.setText("ç¼–è¾‘æ¨¡å‹");var e=a.contentEl;e.createEl("label",{text:"æ¨¡å‹ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=e.createEl("input",{type:"text",value:o,placeholder:"è¯·è¾“å…¥æ¨¡å‹IDï¼ˆé€šå¸¸æ˜¯ä¸å¸¦å‚æ•°çš„æ¨¡å‹åç§°ï¼Œå¦‚ï¼šqwen2.5ã€deepseek-r1ï¼‰",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),d=(e.createEl("label",{text:"æ˜¾ç¤ºåç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",value:i.name,placeholder:"è¯·è¾“å…¥æ¨¡å‹æ˜¾ç¤ºåç§°ï¼ˆå¦‚ï¼šæˆ‘çš„è‡ªå®šä¹‰æ¨¡å‹ï¼‰",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),c=(e.createEl("label",{text:"ä¾›åº”å•†:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),p=(Object.keys(this.plugin.settings.providers).forEach(e=>{var t=c.createEl("option",{value:e,text:e.toUpperCase()});e===i.provider&&(t.selected=!0)}),e.createEl("label",{text:"å®é™…æ¨¡å‹åç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("p",{text:"è¿™æ˜¯å‘é€ç»™APIçš„å®é™…æ¨¡å‹åç§°ï¼ˆå¦‚ï¼šqwen2.5:latestã€deepseek-r1:14bç­‰ï¼‰",attr:{style:"margin: 0 0 5px 0; color: var(--text-muted); font-size: 0.9em;"}}),e.createEl("input",{type:"text",value:i.actualModel||i.model||"",placeholder:"è¯·è¾“å…¥å®é™…æ¨¡å‹åç§°",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),h=(e.createEl("label",{text:"æ¨¡å‹ç±»åˆ«:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("p",{text:"é€‰æ‹©æ¨¡å‹çš„åŠŸèƒ½ç±»åˆ«ï¼Œç”¨äºè‡ªåŠ¨æ£€æµ‹æ¨¡å‹èƒ½åŠ›",attr:{style:"margin: 0 0 5px 0; color: var(--text-muted); font-size: 0.9em;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));var t=[{value:MODEL_CATEGORIES.THINKING,text:CATEGORY_ICONS[MODEL_CATEGORIES.THINKING]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.THINKING]},{value:MODEL_CATEGORIES.VISION,text:CATEGORY_ICONS[MODEL_CATEGORIES.VISION]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.VISION]},{value:MODEL_CATEGORIES.MULTIMODAL,text:CATEGORY_ICONS[MODEL_CATEGORIES.MULTIMODAL]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.MULTIMODAL]},{value:MODEL_CATEGORIES.TEXT,text:CATEGORY_ICONS[MODEL_CATEGORIES.TEXT]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.TEXT]},{value:MODEL_CATEGORIES.IMAGE,text:CATEGORY_ICONS[MODEL_CATEGORIES.IMAGE]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.IMAGE]},{value:MODEL_CATEGORIES.VIDEO,text:CATEGORY_ICONS[MODEL_CATEGORIES.VIDEO]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.VIDEO]},{value:MODEL_CATEGORIES.LANGUAGE,text:CATEGORY_ICONS[MODEL_CATEGORIES.LANGUAGE]+" "+CATEGORY_NAMES[MODEL_CATEGORIES.LANGUAGE]}];let s=i.category;s=s||("image"===i.type?MODEL_CATEGORIES.IMAGE:MODEL_CATEGORIES.TEXT),t.forEach(e=>{var t=h.createEl("option",{value:e.value,text:e.text});e.value===s&&(t.selected=!0)});t=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),t.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>a.close(),e=t.createEl("button",{text:"ä¿å­˜",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let n=async()=>{var e,t=r.value.trim(),i=d.value.trim(),s=c.value,n=p.value.trim(),l=h.value;t?i?n?t!==o&&this.plugin.settings.models[t]?new Notice("æ¨¡å‹IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ID"):(t===o?this.plugin.settings.models[o]={...this.plugin.settings.models[o],name:i,provider:s,actualModel:n,model:n,category:l}:(e=this.plugin.settings.models[o],delete this.plugin.settings.models[o],this.plugin.settings.models[t]={id:t,name:i,provider:s,actualModel:n,model:n,enabled:!1!==e.enabled,category:l},this.plugin.settings.currentModel===o&&(this.plugin.settings.currentModel=t)),await this.plugin.saveSettings(),new Notice("æ¨¡å‹å·²æ›´æ–°"),a.close(),this.display()):new Notice("è¯·è¾“å…¥å®é™…æ¨¡å‹åç§°"):new Notice("è¯·è¾“å…¥æ¨¡å‹æ˜¾ç¤ºåç§°"):new Notice("è¯·è¾“å…¥æ¨¡å‹ID")};e.onclick=n;t=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),n())};r.addEventListener("keydown",t),d.addEventListener("keydown",t),p.addEventListener("keydown",t),h.addEventListener("keydown",t),a.open(),d.focus()}showAddProviderModal(){let l=new Modal(this.app);l.titleEl.setText("æ·»åŠ ä¾›åº”å•†");var e=l.contentEl;e.createEl("label",{text:"ä¾›åº”å•†ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=e.createEl("input",{type:"text",placeholder:"ä¾‹å¦‚: custom-provider",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),a=(e.createEl("label",{text:"æ˜¾ç¤ºåç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",placeholder:"ä¾‹å¦‚: è‡ªå®šä¹‰ä¾›åº”å•†",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),r=(e.createEl("label",{text:"ç±»å‹:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),d=(r.createEl("option",{text:"OpenAIå…¼å®¹",attr:{value:"openai"}}),r.createEl("option",{text:"Anthropicå…¼å®¹",attr:{value:"anthropic"}}),r.createEl("option",{text:"Geminiå…¼å®¹",attr:{value:"gemini"}}),r.createEl("option",{text:"Ollama",attr:{value:"ollama"}}),e.createEl("label",{text:"é»˜è®¤Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",placeholder:"ä¾‹å¦‚: https://api.example.com/v1",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}})),c=(e.createEl("label",{text:"API Keyè·å–é“¾æ¥ï¼ˆå¯é€‰ï¼‰:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",placeholder:"ä¾‹å¦‚: https://example.com/api-keys",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));e=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),e.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>l.close(),e=e.createEl("button",{text:"æ·»åŠ ",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let t=async()=>{var e=o.value.trim(),t=a.value.trim(),i=r.value,s=d.value.trim(),n=c.value.trim();e&&t&&i?this.plugin.settings.providers[e]?new Notice("ä¾›åº”å•†IDå·²å­˜åœ¨ï¼Œè¯·ä½¿ç”¨å…¶ä»–ID"):(this.plugin.settings.providers[e]={name:t,type:i,enabled:!0,apiKey:"",baseUrl:s||""},n&&(this.plugin.settings.apiKeyLinks||(this.plugin.settings.apiKeyLinks={}),this.plugin.settings.apiKeyLinks[e]=n),await this.plugin.saveSettings(),new Notice("ä¾›åº”å•†å·²æ·»åŠ "),l.close(),this.display()):new Notice("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ")};e.onclick=t;e=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),t())};o.addEventListener("keydown",e),a.addEventListener("keydown",e),d.addEventListener("keydown",e),c.addEventListener("keydown",e),l.open(),o.focus()}showEditProviderModal(n){let l=new Modal(this.app),i=this.plugin.settings.providers[n];l.titleEl.setText("ç¼–è¾‘ä¾›åº”å•†");var e=l.contentEl;e.createEl("label",{text:"ä¾›åº”å•†ID:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("input",{type:"text",value:n,attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-secondary); color: var(--text-muted);",disabled:"disabled"}}),e.createEl("label",{text:"æ˜¾ç¤ºåç§°:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let o=e.createEl("input",{type:"text",value:i.name||n,attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}),a=(e.createEl("label",{text:"ç±»å‹:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}}),e.createEl("select",{attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}}));[{value:"openai",text:"OpenAIå…¼å®¹"},{value:"anthropic",text:"Anthropicå…¼å®¹"},{value:"gemini",text:"Geminiå…¼å®¹"},{value:"ollama",text:"Ollama"}].forEach(e=>{var t=a.createEl("option",{text:e.text,attr:{value:e.value}});e.value===i.type&&(t.selected=!0)}),e.createEl("label",{text:"é»˜è®¤Base URL:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});let r=e.createEl("input",{type:"text",value:i.baseUrl||"",attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});e.createEl("label",{text:"API Keyè·å–é“¾æ¥ï¼ˆå¯é€‰ï¼‰:",attr:{style:"display: block; margin-bottom: 5px; font-weight: bold;"}});var t=this.plugin.settings.apiKeyLinks?.[n]||"";let d=e.createEl("input",{type:"text",value:t,attr:{style:"width: 100%; margin-bottom: 15px; border: 1px solid var(--background-modifier-border); border-radius: 4px;"}});t=e.createEl("div",{attr:{style:"display: flex; justify-content: flex-end; gap: 10px; margin-top: 15px;"}}),t.createEl("button",{text:"å–æ¶ˆ",attr:{style:"padding: 6px 12px;"}}).onclick=()=>l.close(),e=t.createEl("button",{text:"ä¿å­˜",cls:"mod-cta",attr:{style:"padding: 6px 12px;"}});let s=async()=>{var e=o.value.trim(),t=a.value,i=r.value.trim(),s=d.value.trim();e&&t?(this.plugin.settings.providers[n]={...this.plugin.settings.providers[n],name:e,type:t,baseUrl:i},this.plugin.settings.apiKeyLinks||(this.plugin.settings.apiKeyLinks={}),s?this.plugin.settings.apiKeyLinks[n]=s:delete this.plugin.settings.apiKeyLinks[n],await this.plugin.saveSettings(),new Notice("ä¾›åº”å•†å·²æ›´æ–°"),l.close(),this.display()):new Notice("è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µ")};e.onclick=s;t=e=>{"Enter"===e.key&&(e.ctrlKey||e.metaKey)&&(e.preventDefault(),s())};o.addEventListener("keydown",t),r.addEventListener("keydown",t),d.addEventListener("keydown",t),l.open(),o.focus()}}class GlobalRuleManager{constructor(e){this.plugin=e}getRules(){return this.plugin.settings.globalRules||[]}getActiveRules(){return this.getRules().filter(e=>!1!==e.enabled)}addRule(e){e={id:this.generateRuleId(),name:e.name||"æ–°è§„åˆ™",content:e.content||"",description:e.description||"",category:e.category||"custom",priority:e.priority||0,enabled:!1!==e.enabled,createdAt:Date.now(),updatedAt:Date.now()};return this.plugin.settings.globalRules||(this.plugin.settings.globalRules=[]),this.plugin.settings.globalRules.push(e),this.plugin.saveSettings(),e}updateRule(t,e){var i=this.getRules(),s=i.findIndex(e=>e.id===t);if(-1===s)throw new Error("è§„åˆ™ä¸å­˜åœ¨");return i[s]={...i[s],...e,updatedAt:Date.now()},this.plugin.saveSettings(),i[s]}deleteRule(t){var e=this.getRules(),i=e.findIndex(e=>e.id===t);if(-1===i)throw new Error("è§„åˆ™ä¸å­˜åœ¨");e.splice(i,1),this.plugin.saveSettings()}toggleRule(t){var e=this.getRules().find(e=>e.id===t);if(e)return e.enabled=!e.enabled,e.updatedAt=Date.now(),this.plugin.saveSettings(),e;throw new Error("è§„åˆ™ä¸å­˜åœ¨")}createFromTemplate(t){var e=(this.plugin.settings.ruleTemplates||[]).find(e=>e.id===t);if(e)return this.addRule({name:e.name,content:e.content,description:e.description,category:e.category});throw new Error("æ¨¡æ¿ä¸å­˜åœ¨")}getTemplates(){return this.plugin.settings.ruleTemplates||[]}getTemplatesByCategory(t){return this.getTemplates().filter(e=>e.category===t)}generateRuleId(){return"rule_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}exportRules(){return{version:"1.0",exportedAt:Date.now(),rules:this.getRules()}}importRules(e){if(!e||!e.rules||!Array.isArray(e.rules))throw new Error("å¯¼å…¥æ•°æ®æ ¼å¼é”™è¯¯");let t=0;return e.rules.forEach(e=>{try{this.addRule(e),t++}catch(e){}}),t}}function compareVersions(e,t){if(!e||!t)return 0;try{for(var i=e.split(".").map(e=>parseInt(e,10)||0),s=t.split(".").map(e=>parseInt(e,10)||0);i.length<3;)i.push(0);for(;s.length<3;)s.push(0);for(let e=0;e<3;e++){if(i[e]<s[e])return-1;if(i[e]>s[e])return 1}return 0}catch(e){return 0}}let nodeCrypto=null;try{nodeCrypto=require("crypto")}catch(e){nodeCrypto=null}function generateSimpleHash(t){let i=0;if(!t||0===t.length)return"0".repeat(64);for(let e=0;e<t.length;e++){var s=t.charCodeAt(e);i=(i<<5)-i+s,i&=i}return(Math.abs(i).toString(16)+t.length.toString(16)+Date.now().toString(16).slice(-8)).padStart(64,"0").slice(0,64)}function generateSecureHash(e,t=null){e=(t=t||`cp_salt_${Math.floor(Date.now()/864e5)}_security`)+e+t;if(nodeCrypto&&nodeCrypto.createHash)try{var i=nodeCrypto.createHash("sha256");return i.update(e),i.digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(e=>Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")).catch(()=>null)}catch(e){}return generateSimpleHash(e)}async function generatePluginFingerprint(e,t){try{var i={id:e.id||deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"]),version:e.version,author:e.author,name:e.name,path:(t||"").replace(/\\/g,"/"),minAppVersion:e.minAppVersion},s=generateSecureHash(JSON.stringify(i,Object.keys(i).sort()));return s&&"function"==typeof s.then?await s:s}catch(e){return null}}async function validatePluginIntegrity(e,t){try{var i,s,n,l,o,a;return await generatePluginFingerprint(e,t)?(i=deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"]),s=deobfuscateString(OBFUSCATED_MAPPINGS.ytmaps),n=deobfuscateString(OBFUSCATED_MAPPINGS["1.3.0"]),e.id===i&&e.author===s&&0<=compareVersions(e.version,n)&&(l=generateSecureHash(JSON.stringify({id:i,author:s})),o=generateSecureHash(JSON.stringify({id:e.id,author:e.author})),a=l&&"function"==typeof l.then?await l:l,(o&&"function"==typeof o.then?await o:o)===a)):!1}catch(e){return!1}}class FlowTextPlugin extends Plugin{constructor(){super(...arguments),this.settings=DEFAULT_SETTINGS,this.aiService=null,this.ruleManager=null,this.eventListeners=[],this.isProcessing=!1,this.isPluginActivated=!1,this.statusCheckInterval=null,this.securityCheckInterval=null,this.atTriggerTimeout=null}async onload(){initObfuscationSystem();var e=await this[deobfuscateString(OBFUSCATED_MAPPINGS.checkContentProtectionStatus)](),t=await this.validateDependencyPlugin();e&&t?(this.isPluginActivated=!0,await this.initializePluginFeatures()):this.isPluginActivated=!1}async checkContentProtectionStatus(){try{var e=this.app.plugins.plugins[deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"])];if(e){if(!this.app.plugins[deobfuscateString(OBFUSCATED_MAPPINGS.enabledPlugins)].has(deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"])))return!1;if(e.settings)return!0===e.settings[deobfuscateString(OBFUSCATED_MAPPINGS.isActivated)]&&e.settings[deobfuscateString(OBFUSCATED_MAPPINGS.deviceId)]&&0<e.settings[deobfuscateString(OBFUSCATED_MAPPINGS.deviceId)].trim().length&&!0===e.settings[deobfuscateString(OBFUSCATED_MAPPINGS.hasBeenActivated)]}return await this[deobfuscateString(OBFUSCATED_MAPPINGS.checkContentProtectionFile)]()}catch(e){return!1}}async checkContentProtectionFile(){try{var e,t,i;return this.app.plugins[deobfuscateString(OBFUSCATED_MAPPINGS.enabledPlugins)].has(deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"]))?(e=`.obsidian/plugins/${deobfuscateString(OBFUSCATED_MAPPINGS["obsidian-content-protection"])}/data.json`,t=await this.app.vault.adapter.read(e),!0===(i=JSON.parse(t))[deobfuscateString(OBFUSCATED_MAPPINGS.isActivated)]&&i[deobfuscateString(OBFUSCATED_MAPPINGS.deviceId)]&&0<i[deobfuscateString(OBFUSCATED_MAPPINGS.deviceId)].trim().length&&!0===i[deobfuscateString(OBFUSCATED_MAPPINGS.hasBeenActivated)]):!1}catch(e){return!1}}async validateDependencyPlugin(){try{var e,t,i=deobfuscateString(OBFUSCATED_MAPPINGS[".obsidian/plugins/obsidian-content-protection/manifest.json"]),s=await this.app.vault.adapter.read(i),n=JSON.parse(s),l=deobfuscateString(OBFUSCATED_MAPPINGS["1.3.0"]),o=n.version;return o?!(compareVersions(o,l)<0||(e=deobfuscateString(OBFUSCATED_MAPPINGS.ytmaps),n.author!==e)||!await validatePluginIntegrity(n,deobfuscateString(OBFUSCATED_MAPPINGS[".obsidian/plugins/obsidian-content-protection"]))||((t=generateSecureHash(`${n.id}:${n.author}:`+n.version))&&"function"==typeof t.then?!await t:!t)):!1}catch(e){return!1}}async initializePluginFeatures(){await this.loadSettings(),this.aiService=new AIService(this.settings,this.app),this.ruleManager=new GlobalRuleManager(this),this.addSettingTab(new FlowTextSettingTab(this.app,this)),this.addCommands(),this.updateEventListeners(),this.setupHeaderButton(),this.statusCheckInterval=window.setInterval(()=>{this[deobfuscateString(OBFUSCATED_MAPPINGS.checkAndUpdateStatus)]()},18e5)}async checkAndUpdateStatus(){var e=await this[deobfuscateString(OBFUSCATED_MAPPINGS.checkContentProtectionStatus)](),t=await this.validateDependencyPlugin();e&&t||!this.isPluginActivated?e&&t&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.disablePluginFeatures())}disablePluginFeatures(){try{if(this.isPluginActivated=!1,this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.cleanupEventListeners(),this.cleanupHeaderButton(),"function"==typeof this.onunload&&this.onunload(),this.app&&this.app.commands&&this.app.commands.commands){var e,t,i=[];for([e,t]of Object.entries(this.app.commands.commands))t.callback&&t.callback.toString().includes("FlowText")&&i.push(e);i.forEach(e=>{delete this.app.commands.commands[e]})}try{let e=this.app.plugins;e&&e.disablePlugin&&setTimeout(()=>{e.disablePlugin("flowtext")},100)}catch(e){}}catch(e){}}onunload(){try{this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.cleanupEventListeners()}catch(e){}}async loadSettings(){var e=await this.loadData();if(e&&0!==Object.keys(e).length){this.settings=Object.assign({},DEFAULT_SETTINGS,e);let i=!1;for(var[t,s]of Object.entries(DEFAULT_SETTINGS.providers))if(this.settings.providers[t]){var n,l,o=DEFAULT_SETTINGS.providers[t];for([n,l]of Object.entries(o))void 0===this.settings.providers[t][n]&&(this.settings.providers[t][n]=l,i=!0)}else this.settings.providers[t]={...s},i=!0;for(var[a,r]of Object.entries(DEFAULT_SETTINGS.models))if(this.settings.models[a]){var d,c,p=DEFAULT_SETTINGS.models[a];for([d,c]of Object.entries(p))void 0===this.settings.models[a][d]&&(this.settings.models[a][d]=c,i=!0)}else this.settings.models[a]={...r},i=!0;if(this.settings.maxTokens&&"object"==typeof this.settings.maxTokens&&(this.settings.maxTokens=this.settings.maxTokens.continue||5e3,i=!0),this.settings.imagePromptTemplates&&0<this.settings.imagePromptTemplates.length&&(this.settings.commonPrompts.some(e=>"RealisticsScenes"===e.id||"IllustrationsAndStickers"===e.id||"PicturesWithText"===e.id||"CommercialPhotography"===e.id)||(this.settings.commonPrompts.push(...this.settings.imagePromptTemplates),delete this.settings.imagePromptTemplates,i=!0)),this.settings.apiKey||this.settings.baseUrl||this.settings.model){let t="openai";var h=this.settings.model||"",e=this.settings.baseUrl||"";if(h.includes("claude")||e.includes("anthropic")?t="anthropic":h.includes("gemini")||e.includes("google")?t="gemini":(h.includes("deepseek")||e.includes("deepseek"))&&(t="deepseek"),this.settings.apiKey&&(this.settings.providers[t].apiKey=this.settings.apiKey,this.settings.providers[t].enabled=!0,delete this.settings.apiKey,i=!0),this.settings.baseUrl&&(this.settings.providers[t].baseUrl=this.settings.baseUrl,delete this.settings.baseUrl,i=!0),this.settings.model){let e=null;for(var[u,g]of Object.entries(this.settings.models))if(g.name===h||u===h){e=u;break}e?(this.settings.models[e].enabled=!0,this.settings.models[e].provider=t):(e=h.replace(/[^a-zA-Z0-9-_.]/g,"-"),this.settings.models[e]={id:e,name:h,provider:t,enabled:!0}),this.settings.currentModel=e,delete this.settings.model,i=!0}}0===Object.values(this.settings.models).filter(e=>e.enabled).length&&(this.settings.models["claude-3.7-sonnet"].enabled=!0,this.settings.currentModel="claude-3.7-sonnet",i=!0),this.settings.currentModel&&this.settings.models[this.settings.currentModel]?.enabled||(e=Object.keys(this.settings.models).find(e=>this.settings.models[e].enabled))&&(this.settings.currentModel=e,i=!0),i&&await this.saveSettings(),await this.ensureSettingsConsistency()}else this.settings={...DEFAULT_SETTINGS},await this.saveSettings()}async ensureSettingsConsistency(){let e=!1;for(var[t,i]of Object.entries(DEFAULT_SETTINGS.providers))if(this.settings.providers[t])for(var[s,n]of Object.entries(i))void 0===this.settings.providers[t][s]&&(this.settings.providers[t][s]=n,e=!0);else this.settings.providers[t]={...i},e=!0;for(var[l,o]of Object.entries(DEFAULT_SETTINGS.models))if(this.settings.models[l])for(var[a,r]of Object.entries(o))void 0===this.settings.models[l][a]&&(this.settings.models[l][a]=r,e=!0);else this.settings.models[l]={...o},e=!0;var d=Object.keys(this.settings.models).filter(e=>this.settings.models[e].enabled);0===d.length?(this.settings.models["claude-3.7-sonnet"].enabled=!0,this.settings.currentModel="claude-3.7-sonnet",e=!0):d.includes(this.settings.currentModel)||(this.settings.currentModel=d[0],e=!0),e&&await this.saveSettings()}async saveSettings(){await this.saveData(this.settings),this.aiService&&this.aiService.updateSettings(this.settings)}getAvailableModels(){return Object.values(this.settings.models).filter(e=>e.enabled).map(e=>({id:e.id,name:e.name,provider:e.provider}))}getEnabledProviders(){return Object.keys(this.settings.providers).filter(e=>this.settings.providers[e].enabled)}addCommands(){this.addCommand({id:"continue-writing",name:"æ™ºèƒ½ç»­å†™",callback:()=>{this.isPluginActivated?this.handleContinueWriting():(this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp"))}}),this.addCommand({id:"open-ai-chat",name:"æ‰“å¼€AIå¯¹è¯",callback:()=>{this.isPluginActivated?this.handleOpenAIChat():(this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp"))}})}updateEventListeners(){this.cleanupEventListeners(),this.settings.enableRightClick&&(this.setupRightClickListener(),this.setupPDFRightClickListener()),this.settings.enableAtTrigger&&this.setupAtTriggerListener()}setupRightClickListener(){this.registerEvent(this.app.workspace.on("editor-menu",(e,i,t)=>{if(t&&"markdown"===t.getViewType()){let t=i.getSelection();t.trim()&&(this.isPluginActivated?(e.addSeparator(),e.addItem(e=>{e.setTitle("ğŸ¤– AIåŸæ–‡ä¿®æ”¹").setIcon("bot").onClick(()=>this.handleAITextModify(t))})):(e.addSeparator(),e.addItem(e=>{e.setTitle("ğŸ¤– AIåŸæ–‡ä¿®æ”¹ (error-cp)").setIcon("bot").setDisabled(!0)})))}}))}setupPDFRightClickListener(){var e=e=>{e=e.target;if(e.closest(".pdf-viewer")||e.closest(".pdf-embed")||e.closest('[data-type="pdf"]')||e.closest('.workspace-leaf-content[data-type="pdf"]')){let t=window.getSelection().toString().trim();t&&this.isPluginActivated&&setTimeout(()=>{var e=document.querySelector(".menu-scroll");e&&!e.hasAttribute("flowtext-ai-processed")?(console.log("æ£€æµ‹åˆ°PDF++èœå•ï¼Œæ·»åŠ AIå¯¹è¯é€‰é¡¹"),this.addAIOptionToPdfMenu(e,t),e.setAttribute("flowtext-ai-processed","true")):(e=document.querySelector(".pdfflow-context-menu"))&&!e.hasAttribute("flowtext-ai-processed")?(console.log("æ£€æµ‹åˆ°PDF Flowèœå•ï¼Œæ·»åŠ AIå¯¹è¯é€‰é¡¹"),this.addAIOptionToPdfMenu(e,t),e.setAttribute("flowtext-ai-processed","true")):console.log("æœªæ£€æµ‹åˆ°PDF++æˆ–PDF Flowèœå•")},150)}};document.addEventListener("contextmenu",e,!0),this.eventListeners.push({element:document,event:"contextmenu",handler:e,useCapture:!0});let t=setInterval(()=>{var e=document.querySelector(".menu-scroll"),t=document.querySelector(".pdfflow-context-menu");e||t||document.querySelectorAll("[flowtext-ai-processed]").forEach(e=>{e.removeAttribute("flowtext-ai-processed")})},500);this.eventListeners.push({element:{clearInterval:()=>clearInterval(t)},event:"interval",handler:t})}addAIOptionToPdfMenu(t,i){var e=document.createElement("div");e.className="flowtext-menu-separator",e.style.cssText=`
			height: 1px;
			background: var(--background-modifier-border);
			margin: 4px 0;
		`,t.appendChild(e);let s=document.createElement("div");s.className="flowtext-pdf-menu-item",s.style.cssText=`
			padding: 8px 16px;
			cursor: pointer;
			display: flex;
			align-items: center;
			gap: 12px;
			color: var(--text-normal);
			font-size: 14px;
			transition: background-color 0.2s ease;
		`,s.innerHTML=`
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
			<span>AIå¯¹è¯</span>
		`,s.addEventListener("mouseenter",()=>{s.style.backgroundColor="var(--background-modifier-hover)"}),s.addEventListener("mouseleave",()=>{s.style.backgroundColor="transparent"}),s.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.handlePDFAIChat(i),t.remove()}),s.addEventListener("touchend",e=>{e.preventDefault(),e.stopPropagation(),this.handlePDFAIChat(i),t.remove()}),t.appendChild(s),console.log("AIå¯¹è¯é€‰é¡¹å·²æ·»åŠ åˆ°PDF++èœå•")}showPDFContextMenu(e,t,i){console.log("showPDFContextMenuè¢«è°ƒç”¨ï¼Œä½ç½®:",e,t,"é€‰ä¸­æ–‡æœ¬:",i);var s=document.querySelector(".pdfflow-context-menu");s&&s.remove();let n=document.createElement("div");n.className="pdfflow-context-menu",n.style.position="fixed",n.style.left=e+"px",n.style.top=t+"px",n.style.zIndex="10000";s=document.createElement("div");s.className="pdfflow-menu-item",s.innerHTML=`
			<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-circle">
				<path d="M7.9 20A9 9 0 1 0 4 16.1L2 22Z"/>
			</svg>
			<span>AIå¯¹è¯</span>
		`,s.onclick=e=>{e.stopPropagation(),this.handlePDFAIChat(i),n.remove()},n.appendChild(s),document.body.appendChild(n),console.log("PDFèœå•å·²æ·»åŠ åˆ°DOMï¼Œèœå•å…ƒç´ :",n),console.log("èœå•é¡¹æ•°é‡:",n.children.length);let l=e=>{n.contains(e.target)||(n.remove(),document.removeEventListener("click",l))};setTimeout(()=>{document.addEventListener("click",l)},100)}handlePDFAIChat(s){if(this.isPluginActivated)if(s&&s.trim())try{new AITextModifyModal(this.app,s,(e,t,i)=>{this.processPDFAIChat(s,e,t,i)},this,"ğŸ’¬ PDF AIå¯¹è¯","").open()}catch(e){console.error("æ‰“å¼€PDF AIå¯¹è¯çª—å£å¤±è´¥:",e)}else new Notice("è¯·å…ˆé€‰æ‹©PDFä¸­çš„æ–‡æœ¬");else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}handleOpenAIChat(){if(this.isPluginActivated)try{new AITextModifyModal(this.app,"",(e,t,i)=>{},this,"ğŸ’¬ AIå¯¹è¯","").open()}catch(e){console.error("æ‰“å¼€AIå¯¹è¯çª—å£å¤±è´¥:",e)}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}async processPDFAIChat(e,t,i=0,s){}setupAtTriggerListener(){let t=e=>{if("@"===e.key||e.shiftKey&&"2"===e.key||"&"===e.key||e.shiftKey&&"7"===e.key){var t=document.activeElement;if(!t||!t.classList.contains("flowtext-modify-input")&&!t.classList.contains("flowtext-continue-input")){let i=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);i&&i.editor&&(this.atTriggerTimeout&&(clearTimeout(this.atTriggerTimeout),this.atTriggerTimeout=null),this.atTriggerTimeout=setTimeout(()=>{var e=i.editor.getCursor(),e=i.editor.getLine(e.line).substring(0,e.ch),t=e.charAt(e.length-1);"@"!==t&&"&"!==t||e.endsWith("@@")||e.endsWith("&&")||(this.showAtTriggerModal(),this.atTriggerTimeout=null)},500))}}else if("#"===e.key||e.shiftKey&&"3"===e.key){let e=document.activeElement;e&&(e.classList.contains("flowtext-modify-input")||e.classList.contains("flowtext-continue-input"))&&setTimeout(()=>{this.showPromptSelectorModal(e)},50)}};document.addEventListener("keydown",t),this.eventListeners.push({element:document,event:"keydown",handler:t});var e=()=>{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);e&&e.editor&&(e=e.editor.cm?.dom||e.contentEl?.querySelector(".cm-editor"))&&!e.hasAttribute("data-flowtext-listener")&&(e.setAttribute("data-flowtext-listener","true"),e.addEventListener("keydown",t),this.eventListeners.push({element:e,event:"keydown",handler:t}))};this.app.workspace.on("active-leaf-change",e),this.eventListeners.push({element:this.app.workspace,event:"active-leaf-change",handler:e}),e()}cleanupEventListeners(){this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e&&i&&(e===this.app.workspace&&"function"==typeof e.off?e.off(t,i):"interval"===t?clearInterval(i):e.removeEventListener&&e.removeEventListener(t,i))}),this.eventListeners=[],document.querySelectorAll("[data-flowtext-listener]").forEach(e=>{e.removeAttribute("data-flowtext-listener")}),this.cleanupHeaderButton()}showAtTriggerModal(){var e;this.isPluginActivated?(e=this.getCursorPosition())&&new AtTriggerPopup(this.app,(e,t,i,s)=>{this.handleContinueWriting(e,t,i,s)},e,this).open():this.app.plugins.enabledPlugins.has("obsidian-content-protection")}showPromptSelectorModal(h){new PromptSelectorPopup(this.app,this,p=>{if("true"===h.contentEditable){let r=window.getSelection();if(!r.rangeCount)return;let d=r.getRangeAt(0),i="",c=(h.childNodes.forEach(e=>{var t;e.nodeType===Node.TEXT_NODE?i+=e.textContent:e.classList&&e.classList.contains("flowtext-inline-tag")&&(t=e.getAttribute("data-type"),e=e.getAttribute("data-path"),i+=`@[${t}:${e}]`)}),i.lastIndexOf("#"));if(-1!==c){let l=0,o=!1,a=e=>{if(!o)if(e.nodeType===Node.TEXT_NODE){var t,i=e.textContent.length;l+i>c?(t=c-l,s=e.textContent.substring(0,t),e.textContent.substring(1+t),e.textContent=s,t=document.createTextNode(p),e.nextSibling?e.parentNode.insertBefore(t,e.nextSibling):e.parentNode.appendChild(t),d.setStartAfter(t),d.collapse(!0),r.removeAllRanges(),r.addRange(d),o=!0):l+=i}else if(e.nodeType===Node.ELEMENT_NODE)if(e.classList&&e.classList.contains("flowtext-inline-tag")){var s=`@[${e.getAttribute("data-type")}:${e.getAttribute("data-path")}]`;l+=s.length}else for(var n of e.childNodes)if(a(n),o)return};for(var e of h.childNodes)if(a(e),o)break}else{var t=document.createTextNode(p);d.insertNode(t),d.setStartAfter(t),d.collapse(!0),r.removeAllRanges(),r.addRange(d)}}else{var i,t=h.value||"",s=t.lastIndexOf("#");-1!==s?(i=t.substring(0,s),s=t.substring(s+1),h.value=i+p+s):h.value=t+p}let n=h.closest(".flowtext-at-popup");n&&(n.setAttribute("data-prompt-selecting","true"),setTimeout(()=>{n&&n.removeAttribute("data-prompt-selecting")},100)),setTimeout(()=>{h.focus()},50)}).open(h)}getCursorPosition(){try{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(!e||!e.editor)return null;var t=e.containerEl.querySelector(".cm-editor");if(!t)return null;var i=e.editor.getCursor(),s=e.editor.coordsAtPos(i);if(s)return{left:s.left,top:s.top,height:s.bottom-s.top};var n=window.getSelection();if(n&&0<n.rangeCount){var l=n.getRangeAt(0).getBoundingClientRect();if(0<l.width||0<l.height)return{left:l.left,top:l.top,height:l.height||20}}var o=t.getBoundingClientRect();return{left:o.left+50,top:o.top+50,height:20}}catch(e){return null}}handleAITextProcess(n,t){if(this.isPluginActivated)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(e&&e.editor)if(n&&n.trim()){let s="",e="";switch(t){case"expand":s="è¯·æ‰©å±•è¿™æ®µæ–‡æœ¬ï¼Œå¢åŠ æ›´å¤šç»†èŠ‚å’Œå†…å®¹ï¼Œä¿æŒåŸæ„ä¸å˜ã€‚",e="ğŸ” AIæ–‡æœ¬æ‰©å±•";break;case"polish":s="è¯·æ¶¦è‰²è¿™æ®µæ–‡æœ¬ï¼Œæ”¹å–„è¯­è¨€è¡¨è¾¾å’Œæ–‡å­—æµç•…åº¦ï¼Œä¿æŒåŸæ„ä¸å˜ã€‚",e="âœ¨ AIæ–‡æœ¬æ¶¦è‰²";break;case"continue":s="è¯·åŸºäºè¿™æ®µæ–‡æœ¬ç»§ç»­å†™ä½œï¼Œä¿æŒé£æ ¼å’Œé€»è¾‘çš„è¿è´¯æ€§ã€‚",e="ğŸ“ AIæ–‡æœ¬ç»­å†™";break;case"summarize":s="è¯·æ€»ç»“è¿™æ®µæ–‡æœ¬çš„ä¸»è¦å†…å®¹å’Œè¦ç‚¹ã€‚",e="ğŸ“‹ AIæ–‡æœ¬æ€»ç»“";break;case"RealisticsScenes":s="ä¸€å¼ ä»¥[ç¯å¢ƒ]ä¸ºèƒŒæ™¯çš„ï¼Œå…·æœ‰[ä¸»ä½“]ã€[åŠ¨ä½œæˆ–è¡¨æƒ…]çš„é€¼çœŸ[é•œå¤´ç±»å‹]ç…§ç‰‡ã€‚åœºæ™¯ç”±[ç¯å…‰æè¿°]ç…§äº®ï¼Œè¥é€ [æƒ…ç»ª]æ°›å›´ã€‚ä½¿ç”¨[ç›¸æœº/é•œå¤´ç»†èŠ‚]æ‹æ‘„ï¼Œçªå‡º[å…³é”®çº¹ç†å’Œç»†èŠ‚]ã€‚å›¾åƒåº”é‡‡ç”¨[å®½é«˜æ¯”]æ ¼å¼ã€‚",e="ğŸŒ… é€¼çœŸåœºæ™¯";break;case"IllustrationsAndStickers":s="ä¸€ä¸ª[ä¸»é¢˜]çš„[é£æ ¼]è´´çº¸ï¼ŒåŒ…å«[ä¸»è¦ç‰¹å¾]å’Œ[é…è‰²æ–¹æ¡ˆ]ã€‚è®¾è®¡åº”åŒ…å«[çº¿æ¡æ ·å¼]å’Œ[é˜´å½±æ ·å¼]ã€‚èƒŒæ™¯å¿…é¡»é€æ˜ã€‚",e="ğŸŒ…  é£æ ¼åŒ–æ’ç”»å’Œè´´çº¸";break;case"PicturesWithText":s="ä¸º[å“ç‰Œ/æ¦‚å¿µ]åˆ›å»º[å›¾ç‰‡ç±»å‹]ï¼Œå¹¶åœ¨[å­—ä½“æ ·å¼]ä¸­æ·»åŠ æ–‡æœ¬â€œ[å¾…æ¸²æŸ“æ–‡æœ¬]â€ã€‚è®¾è®¡åº”ä¸º[æ ·å¼æè¿°]ï¼Œå¹¶é‡‡ç”¨[é…è‰²æ–¹æ¡ˆ]ã€‚",e="ğŸŒ…  æ–‡å­—å›¾ç‰‡";break;case"CommercialPhotography":s="ä¸€å¼ é«˜åˆ†è¾¨ç‡ã€å·¥ä½œå®¤ç¯å…‰ä¸‹çš„äº§å“ç…§ç‰‡ï¼Œä»¥[äº§å“æè¿°]ä¸ºèƒŒæ™¯ï¼Œå±•ç°[èƒŒæ™¯è¡¨é¢/æè¿°]ã€‚ç¯å…‰é‡‡ç”¨[ç…§æ˜è®¾ç½®ï¼Œä¾‹å¦‚ä¸‰ç‚¹å¼æŸ”å…‰ç®±]ï¼Œä»¥è¾¾åˆ°[ç…§æ˜ç›®çš„]ã€‚æ‹æ‘„è§’åº¦é‡‡ç”¨[è§’åº¦ç±»å‹]ï¼Œä»¥å±•ç°[ç‰¹å®šåŠŸèƒ½]ã€‚è¶…é€¼çœŸï¼Œæ¸…æ™°å¯¹ç„¦[å…³é”®ç»†èŠ‚]ã€‚[å®½é«˜æ¯”]ã€‚",e="ğŸŒ…  äº§å“æ¨¡å‹å’Œå•†ä¸šæ‘„å½±";break;default:s="è¯·å¤„ç†è¿™æ®µæ–‡æœ¬ã€‚",e="ğŸ¤– AIæ–‡æœ¬å¤„ç†"}try{new AITextModifyModal(this.app,n,(e,t,i)=>{this.processAITextModify(n,e||s,t,i)},this,e,s).open()}catch(e){}}else new Notice("è¯·å…ˆé€‰æ‹©è¦å¤„ç†çš„æ–‡æœ¬");else new Notice("è¯·åœ¨Markdownç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}handleAITextModify(s){if(this.isPluginActivated)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(e&&e.editor)if(s&&s.trim())try{new AITextModifyModal(this.app,s,(e,t,i)=>{this.processAITextModify(s,e,t,i)},this,null,"").open()}catch(e){}else new Notice("è¯·å…ˆé€‰æ‹©è¦ä¿®æ”¹çš„æ–‡æœ¬");else new Notice("è¯·åœ¨Markdownç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}async processAITextModify(t,i,s=[],o=null,a=!1){if(this.isPluginActivated)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{let l=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(l&&l.editor){var e=this.settings.currentModel,r=(o&&o!==e&&(this.settings.currentModel=o,this.aiService.updateSettings(this.settings)),this.isProcessing=!0,new Notice("AIæ­£åœ¨å¤„ç†ä¸­...",0));try{let n=a||t&&1e3<t.length,e;e=n?{selectedText:t.trim(),beforeText:"",afterText:"",cursorPosition:l.editor.getCursor(),filePath:l.editor.getValue(),lineNumber:0}:TextContextExtractor.getContext(l.editor,t,this.settings);var d=await this.aiService.sendRequest("continue",e,i,s,[]);r.hide(),new AIResultModal(this.app,t,d.content,e=>{var t,i,s;n?(i=l.editor.getCursor(),l.editor.setValue(e),t=l.editor.lineCount(),i.line<t?(s=l.editor.getLine(i.line).length,s=Math.min(i.ch,s),l.editor.setCursor({line:i.line,ch:s})):(i=t-1,s=l.editor.getLine(i).length,l.editor.setCursor({line:i,ch:s})),new Notice("å…¨æ–‡å·²æ›´æ–°")):(l.editor.replaceSelection(e),new Notice("æ–‡æœ¬å·²æ›´æ–°"))},()=>{this.processAITextModify(t,i,s,o,a)}).open()}catch(e){r.hide(),new Notice("å¤„ç†å¤±è´¥: "+e.message)}finally{this.isProcessing=!1,o&&o!==e&&(this.settings.currentModel=e,this.aiService.updateSettings(this.settings))}}else new Notice("è¯·åœ¨Markdownç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}async handleContinueWriting(e="",n=[],l=null,o=null){if(this.isPluginActivated)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{let s=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(s&&s.editor)if(e){var a=this.settings.currentModel,r=(l&&l!==a&&(this.settings.currentModel=l,this.aiService.updateSettings(this.settings)),this.isProcessing=!0,new Notice("AIæ­£åœ¨ç”Ÿæˆç»­å†™å†…å®¹...",0)),d=s.editor.getCursor(),c=s.editor.getLine(d.line),c=0<d.ch?c.charAt(d.ch-1):"",c=("@"!==c&&"&"!==c||(c={line:d.line,ch:d.ch-1},p={line:d.line,ch:d.ch},s.editor.replaceRange("",c,p),d.ch=d.ch-1),"flowtext-loading-"+Date.now()),p=`<span class="flowtext-loading" id="${c}">â³ AIæ­£åœ¨æ€è€ƒä¸­<span class="flowtext-dots">...</span></span>`;let t={line:d.line,ch:d.ch},i=(s.editor.replaceRange(p,d),{line:d.line,ch:d.ch+p.length});this.startLoadingAnimation(c);try{var h,u,g,m,v,x,w=this.settings.currentModel,E=this.settings.models[w];E&&"image"===E.type?(h={cursorPosition:t},u=await this.aiService.sendRequest("continue",h,e,n,[]),r.hide(),this.stopLoadingAnimation(c),s.editor.replaceRange(u.content,t,i),g={line:t.line,ch:t.ch+u.content.length},s.editor.setCursor(g),new Notice("å›¾ç‰‡ç”Ÿæˆå®Œæˆå¹¶å·²æ’å…¥")):(m=TextContextExtractor.getContext(s.editor,null,this.settings),o&&(m.additionalContext=o),v=await this.aiService.sendRequest("continue",m,e,n,[],e=>{e.content&&(s.editor.replaceRange(e.content,t,i),i.ch=t.ch+e.content.length)}),r.hide(),this.stopLoadingAnimation(c),this.aiService.isThinkingModel()||s.editor.replaceRange(v.content,t,i),x={line:t.line,ch:t.ch+v.content.length},s.editor.setCursor(x),new Notice("ç»­å†™å†…å®¹å·²æ’å…¥"))}catch(e){r.hide(),this.stopLoadingAnimation(c),s.editor.replaceRange("",t,i),s.editor.setCursor(t),new Notice("ç»­å†™å¤±è´¥: "+e.message)}finally{this.isProcessing=!1,l&&l!==a&&(this.settings.currentModel=a,this.aiService.updateSettings(this.settings))}}else this.showAtTriggerModal();else new Notice("è¯·åœ¨Markdownç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}startLoadingAnimation(t){let i=0;this.loadingInterval=setInterval(()=>{var e=document.getElementById(t);e?(e=e.querySelector(".flowtext-dots"))&&(i=(i+1)%4,e.textContent=".".repeat(i)):this.stopLoadingAnimation()},500)}stopLoadingAnimation(e){this.loadingInterval&&(clearInterval(this.loadingInterval),this.loadingInterval=null)}setupHeaderButton(){this.headerButtons=[],this.headerButtonListeners=[];let t=e=>{var t,i;e&&"markdown"===e.getViewType()&&(e=e.containerEl.querySelector(".view-header"))&&!e.querySelector(".flowtext-full-modify-btn")&&((t=document.createElement("button")).className="flowtext-full-modify-btn clickable-icon",t.setAttribute("aria-label","AIåŸæ–‡å¯¹è¯"),t.innerHTML=`
				<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-bot-icon lucide-bot"><path d="M12 8V4H8"/><rect width="16" height="12" x="4" y="8" rx="2"/><path d="M2 14h2"/><path d="M20 14h2"/><path d="M15 13v2"/><path d="M9 13v2"/></svg>
			`,t.addEventListener("click",i=()=>{this.isPluginActivated?this.handleFullTextModify():(this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp"))}),this.headerButtons.push(t),this.headerButtonListeners.push({element:t,event:"click",handler:i}),(i=e.querySelector(".view-actions"))?i.insertBefore(t,i.firstChild):e.appendChild(t))};var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView),e=(e&&t(e),()=>{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);e&&t(e)});this.app.workspace.on("active-leaf-change",e),this.headerButtonListeners.push({element:this.app.workspace,event:"active-leaf-change",handler:e})}cleanupHeaderButton(){this.headerButtonListeners&&(this.headerButtonListeners.forEach(({element:e,event:t,handler:i})=>{e&&"function"==typeof e.off?e.off(t,i):e&&"function"==typeof e.removeEventListener&&e.removeEventListener(t,i)}),this.headerButtonListeners=[]),this.headerButtons&&(this.headerButtons.forEach(e=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),this.headerButtons=[]),document.querySelectorAll(".flowtext-full-modify-btn").forEach(e=>{e.parentNode&&e.parentNode.removeChild(e)})}handleFullTextModify(){if(this.isPluginActivated)if(this.isProcessing)new Notice("æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å€™...");else{var e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(e&&e.editor){let s=e.editor.getValue();if(s&&s.trim())try{new AITextModifyModal(this.app,s,(e,t,i)=>{this.processAITextModify(s,e,t,i,!0)},this,null,"",!0).open()}catch(e){}else new Notice("æ–‡æ¡£å†…å®¹ä¸ºç©º")}else new Notice("è¯·åœ¨Markdownç¼–è¾‘å™¨ä¸­ä½¿ç”¨æ­¤åŠŸèƒ½")}else this.app.plugins.enabledPlugins.has("obsidian-content-protection"),new Notice("error-cp")}}class PromptSelectorPopup{constructor(e,t,i){this.app=e,this.plugin=t,this.onSelect=i,this.isOpen=!1,this.modalEl=null,this.eventListeners=[],this.selectedIndex=0,this.commonPrompts=[]}open(e){if(!this.isOpen){this.isOpen=!0;try{this.modalEl=document.createElement("div"),this.modalEl.className="flowtext-prompt-selector-popup";var t,i=this.plugin.settings.commonPrompts||[];this.commonPrompts=i,(this.selectedIndex=0)===this.commonPrompts.length?this.modalEl.innerHTML=`
					<div class="flowtext-prompt-list">
						<div class="flowtext-prompt-empty">æš‚æ— å¸¸ç”¨æç¤ºè¯ï¼Œè¯·åœ¨è®¾ç½®ä¸­æ·»åŠ </div>
					</div>
				`:(t=this.commonPrompts.map((e,t)=>`
					<div class="flowtext-prompt-item ${0===t?"selected":""}" data-index="${t}">
						<div class="flowtext-prompt-name">${e.name}</div>
						<div class="flowtext-prompt-preview">${e.content.substring(0,50)}${50<e.content.length?"...":""}</div>
					</div>
				`).join(""),this.modalEl.innerHTML=`
					<div class="flowtext-prompt-list">
						${t}
					</div>
				`);this.modalEl.querySelectorAll(".flowtext-prompt-item").forEach(t=>{var e=()=>{var e=parseInt(t.dataset.index);this.selectPrompt(e)},e=(t.addEventListener("click",e),this.eventListeners.push({element:t,event:"click",handler:e}),()=>{var e=parseInt(t.dataset.index);this.updateSelection(e)});t.addEventListener("mouseenter",e),this.eventListeners.push({element:t,event:"mouseenter",handler:e})});var s=e=>{e.target.closest(".flowtext-at-popup")||this.modalEl.contains(e.target)||this.close()},n=(document.addEventListener("click",s),this.eventListeners.push({element:document,event:"click",handler:s}),e=>{"Escape"===e.key?(e.preventDefault(),this.close()):"ArrowDown"===e.key?(e.preventDefault(),this.moveSelection(1)):"ArrowUp"===e.key?(e.preventDefault(),this.moveSelection(-1)):"Enter"===e.key&&(e.preventDefault(),this.selectPrompt(this.selectedIndex))});document.addEventListener("keydown",n),this.eventListeners.push({element:document,event:"keydown",handler:n}),document.body.appendChild(this.modalEl),this.positionPopup(e)}catch(e){}}}close(){this.isOpen&&(this.isOpen=!1,this.eventListeners.forEach(({element:e,event:t,handler:i})=>{e&&"function"==typeof e.removeEventListener&&e.removeEventListener(t,i)}),this.eventListeners=[],this.modalEl&&this.modalEl.parentNode&&this.modalEl.parentNode.removeChild(this.modalEl),this.modalEl=null)}positionPopup(i){if(this.modalEl&&i)try{var s=i.getBoundingClientRect(),n=this.modalEl.getBoundingClientRect(),l=window.innerWidth,o=window.innerHeight;let e=s.left,t=s.bottom+5;e+n.width>l&&(e=l-n.width-10),t+n.height>o&&(t=s.top-n.height-5),e=Math.max(10,e),t=Math.max(10,t),this.modalEl.style.position="fixed",this.modalEl.style.left=e+"px",this.modalEl.style.top=t+"px",this.modalEl.style.zIndex="1000"}catch(e){}}moveSelection(e){0!==this.commonPrompts.length&&((e=this.selectedIndex+e)<0?this.selectedIndex=this.commonPrompts.length-1:e>=this.commonPrompts.length?this.selectedIndex=0:this.selectedIndex=e,this.updateSelection(this.selectedIndex))}updateSelection(e){this.modalEl&&0!==this.commonPrompts.length&&(this.selectedIndex=e,this.modalEl.querySelectorAll(".flowtext-prompt-item").forEach(e=>e.classList.remove("selected")),e=this.modalEl.querySelector(`[data-index="${e}"]`))&&(e.classList.add("selected"),e.scrollIntoView({block:"nearest",behavior:"smooth"}))}selectPrompt(e){e<0||e>=this.commonPrompts.length||((e=this.commonPrompts[e])&&this.onSelect&&this.onSelect(e.content),this.close())}}module.exports=FlowTextPlugin;