let{Plugin,Setting,Notice,Menu,TFile,MarkdownView,Modal}=require("obsidian"),crypto=null;try{crypto=require("crypto")}catch(e){crypto=null}function decodeBase64(e){try{if("function"==typeof atob)return decodeURIComponent(escape(atob(e)))}catch(e){}try{if("undefined"!=typeof Buffer)return Buffer.from(e,"base64").toString("utf-8")}catch(e){}return""}let CP_ID_B64="b2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u",CP_AUTHOR_B64="eXRtYXBz",CP_MANIFEST_PATH_B64="Lm9ic2lkaWFuL3BsdWdpbnMvb2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9uL21hbmlmZXN0Lmpzb24=",CP_PLUGIN_PATH_B64="Lm9ic2lkaWFuL3BsdWdpbnMvb2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u";function compareVersions(e,t){if(!e||!t)return 0;try{for(var a=e.split(".").map(e=>parseInt(e,10)||0),i=t.split(".").map(e=>parseInt(e,10)||0);a.length<3;)a.push(0);for(;i.length<3;)i.push(0);for(let e=0;e<3;e++){if(a[e]<i[e])return-1;if(a[e]>i[e])return 1}return 0}catch(e){return 0}}function generateSecureHash(e,t=null){e=(t=t||`cp_salt_${Math.floor(Date.now()/864e5)}_security`)+e+t;if(crypto&&crypto.createHash)try{var a=crypto.createHash("sha256");return a.update(e),a.digest("hex")}catch(e){}if("undefined"!=typeof window&&window.crypto&&window.crypto.subtle)try{return window.crypto.subtle.digest("SHA-256",(new TextEncoder).encode(e)).then(e=>Array.from(new Uint8Array(e)).map(e=>e.toString(16).padStart(2,"0")).join("")).catch(()=>null)}catch(e){}return generateSimpleHash(e)}function generateSimpleHash(t){let a=0;if(0===t.length)return a.toString(16);for(let e=0;e<t.length;e++){var i=t.charCodeAt(e);a=(a<<5)-a+i,a&=a}return(Math.abs(a).toString(16)+t.length.toString(16)+Date.now().toString(16).slice(-8)).padStart(64,"0").slice(0,64)}async function generatePluginFingerprint(e,t){try{var a={id:e.id||"obsidian-content-protection",version:e.version,author:e.author,name:e.name,path:t.replace(/\\/g,"/"),minAppVersion:e.minAppVersion},i=generateSecureHash(JSON.stringify(a,Object.keys(a).sort()));return i&&"function"==typeof i.then?await i:i}catch(e){return null}}async function validatePluginIntegrity(e,t){try{var a,i,n,s,r;return await generatePluginFingerprint(e,t)?(a=decodeBase64(CP_ID_B64),i=decodeBase64(CP_AUTHOR_B64),e.id===a&&e.author===i&&0<=compareVersions(e.version,"1.3.0")&&(n=generateSecureHash(JSON.stringify({id:a,author:i})),s=generateSecureHash(JSON.stringify({id:e.id,author:e.author})),r=n&&"function"==typeof n.then?await n:n,(s&&"function"==typeof s.then?await s:s)===r)):!1}catch(e){return!1}}class DeleteFileAndAttachmentsModal extends Modal{constructor(e,t,a){super(e),this.plugin=t,this.file=a,this.attachments=[],this.deleteMode="system-trash"}async onOpen(){var e=this.contentEl,a=(e.empty(),e.createEl("h2",{text:"删除文件及其附件"}),e.createDiv("file-info"));if(a.createEl("h3",{text:"删除文件:"}),a.createEl("p",{text:this.file.path,cls:"file-path"}),await this.loadAttachments(),0<this.attachments.length){a=e.createDiv("attachments-info");a.createEl("h3",{text:`要删除的附件 (${this.attachments.length}):`});let t=a.createEl("ul",{cls:"attachment-list"});this.attachments.forEach(e=>{t.createEl("li").createEl("span",{text:e.path,cls:"attachment-path"})})}else e.createDiv("no-attachments").createEl("p",{text:"未找到仅由此文件引用的附件."});a=e.createDiv("delete-mode-section"),a.createEl("h3",{text:"删除模式:"}),a=a.createEl("select",{cls:"delete-mode-select"});a.createEl("option",{value:"obsidian-trash",text:"移至软件回收站（.trash文件夹)"});a.createEl("option",{value:"system-trash",text:"移至系统回收站"}).selected=!0,a.createEl("option",{value:"permanent",text:"永久删除"}),a.addEventListener("change",e=>{this.deleteMode=e.target.value});a=e.createDiv("button-area");a.createEl("button",{text:"Cancel",cls:"mod-cancel"}).addEventListener("click",()=>{this.close()}),a.createEl("button",{text:"Delete",cls:"mod-cta mod-warning"}).addEventListener("click",async()=>{await this.performDelete(),this.close()}),this.addStyles()}async loadAttachments(){try{this.app.metadataCache.trigger("resolve"),await new Promise(e=>setTimeout(e,100));var e,t=this.app.metadataCache.resolvedLinks,a=(this.attachments=[],t[this.file.path]);if(a){for(var[i,n]of Object.entries(a))i.match(/.*\.md$/)||this.isReferencedByOtherNotes(i,this.file)||(e=this.app.vault.getAbstractFileByPath(i))&&e instanceof TFile&&this.attachments.push(e);0===this.attachments.length&&await this.loadAttachmentsFallback()}else await this.loadAttachmentsFallback()}catch(e){await this.loadAttachmentsFallback()}}async loadAttachmentsFallback(){try{var e,t=await this.app.vault.read(this.file);for(e of this.extractAttachmentReferences(t)){var a,i=this.resolvePath(e,this.file.path);await this.isReferencedByOtherNotesFallback(i,this.file)||(a=this.app.vault.getAbstractFileByPath(i))&&a instanceof TFile&&this.attachments.push(a)}}catch(e){}}extractAttachmentReferences(e){var t=[],a=/!\[\[([^\]]+)\]\]/g;let i;for(;null!==(i=a.exec(e));){let e=i[1];(e=e.includes("|")?e.split("|")[0]:e).endsWith(".md")||t.push(e.trim())}for(var n=/!\[([^\]]*)\]\(([^)]+)\)/g;null!==(i=n.exec(e));){let e=i[2];(e=(e=e.includes("?")?e.split("?")[0]:e).includes("#")?e.split("#")[0]:e).startsWith("http")||e.endsWith(".md")||t.push(e.trim())}for(var s=/<img[^>]+src=["']([^"']+)["'][^>]*>/gi;null!==(i=s.exec(e));){let e=i[1];(e=(e=e.includes("?")?e.split("?")[0]:e).startsWith("app://local/")?e.replace("app://local/",""):e).startsWith("http")||e.endsWith(".md")||t.push(decodeURIComponent(e.trim()))}return[...new Set(t)]}resolvePath(e,t){let a=decodeURIComponent(e);return(a=a.startsWith("app://local/")?a.replace("app://local/",""):a).startsWith("/")?a.substring(1):(e=t.substring(0,t.lastIndexOf("/")))?e+"/"+a:a}isReferencedByOtherNotes(e,t){var a,i,n=this.app.metadataCache.resolvedLinks;for([a,i]of Object.entries(n))if(a!==t.path)for(var[s,r]of Object.entries(i))if(s===e)return!0;return!1}async isReferencedByOtherNotesFallback(e,t){var a;for(a of this.app.vault.getMarkdownFiles())if(a.path!==t.path)try{var i,n=await this.app.vault.read(a);for(i of this.extractAttachmentReferences(n))if(this.resolvePath(i,a.path)===e)return!0}catch(e){}return!1}async performDelete(){try{for(var e of this.attachments)await this.deleteFile(e);await this.deleteFile(this.file);this.attachments.length}catch(e){}}async deleteFile(e){try{switch(this.deleteMode){case"obsidian-trash":await this.app.vault.trash(e,!1);break;case"system-trash":await this.app.vault.trash(e,!0);break;case"permanent":await this.app.vault.delete(e);break;default:await this.app.vault.trash(e,!1)}}catch(e){throw e}}addStyles(){var e=document.createElement("style");e.textContent=`
            .file-info, .attachments-info, .no-attachments, .delete-mode-section {
                margin: 15px 0;
            }
            
            .file-path, .attachment-path {
                font-family: monospace;
                background: var(--background-secondary);
                padding: 4px 8px;
                border-radius: 4px;
                font-size: 0.9em;
            }
            
            .attachment-list {
                max-height: 200px;
                overflow-y: auto;
                margin: 10px 0;
            }
            
            .attachment-list li {
                margin: 5px 0;
            }
            
            .delete-mode-select {
                width: 100%;
                margin: 10px 0;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                color: var(--text-normal);
            }
            
            .button-area {
                display: flex;
                justify-content: flex-end;
                gap: 10px;
                margin-top: 20px;
                padding-top: 15px;
                border-top: 1px solid var(--background-modifier-border);
            }
            
            .button-area button {
                padding: 8px 16px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-size: 14px;
            }
            
            .mod-cancel {
                background: var(--background-secondary);
                color: var(--text-normal);
            }
            
            .mod-cancel:hover {
                background: var(--background-secondary-alt);
            }
            
            .mod-cta.mod-warning {
                background: var(--color-red);
                color: white;
            }
            
            .mod-cta.mod-warning:hover {
                background: var(--color-red-hover, #dc2626);
            }
        `,document.head.appendChild(e)}onClose(){var e=this.contentEl;e.empty()}}let DEFAULT_SETTINGS={objectStorage:{enabled:!1,provider:"tencent",tencent:{secretId:"",secretKey:"",bucket:"",region:"ap-beijing",endpoint:"",customDomain:"",pathPrefix:"images/"},aliyun:{accessKeyId:"",accessKeySecret:"",bucket:"",region:"oss-cn-hangzhou",endpoint:"",customDomain:"",pathPrefix:"images/"}},attachFlow:{enabled:!0,imageViewer:!0,dragResize:!0,maintainAspectRatio:!0},autoUpload:!1,clipboardUpload:!1,dragUpload:!1,deleteSourceFile:!0,retryCount:3,timeout:3e4,textWrap:{roundedWidth:200,circleSize:200},imageRename:{enabled:!1,showOnPaste:!0,prefix:""}};module.exports=class extends Plugin{constructor(e,t){super(e,t),this.isPluginActivated=!1,this.statusCheckInterval=null,this.securityCheckInterval=null,this.cloudFunctionVerified=!1,this.cloudFunctionTimeout=null,this.originalFetch=null,this.originalXMLHttpRequest=null,this.networkInterceptorActive=!1}async onload(){await this.validateDependencyPlugin()&&(await this.checkContentProtectionStatus()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,this.showActivationRequired()))}async validateDependencyPlugin(){try{var e=decodeBase64(CP_MANIFEST_PATH_B64),t=await this.app.vault.adapter.read(e),a=JSON.parse(t),i=a.version;if(!i)return!1;if(compareVersions(i,"1.3.0")<0)return!1;var n=decodeBase64(CP_AUTHOR_B64);if(a.author!==n)return!1;try{if(!await validatePluginIntegrity(a,decodeBase64(CP_PLUGIN_PATH_B64)))return!1;var s=generateSecureHash(`${a.id}:${a.author}:`+a.version);if(!(s&&"function"==typeof s.then?await s:s))return!1}catch(e){}return!0}catch(e){return!1}}async initializePluginFeatures(){this.startCloudFunctionListener(),this.startCloudFunctionTimeout(),this.statusCheckInterval=window.setInterval(()=>{this.checkAndUpdateStatus()},18e5),this.securityCheckInterval=window.setInterval(()=>{this.performSecurityCheck()||(this.isPluginActivated=!1,this.disablePluginFeatures())},3e5),await this.loadSettings(),this.addSettingTab(new ImagenSettingTab(this.app,this)),this.registerEvent(this.app.workspace.on("editor-menu",(e,n,t)=>{var a=n.getCursor();let s=null,r=-1;var i,o=n.getLine(a.line),l=a.ch,c=(e,t)=>{for(var a,i=[],n=/!\[\[([^\]|]+)(?:\|[^\]]*)?\]\]/g;null!==(a=n.exec(e));)i.push({match:a,linkType:"wiki",startPos:a.index,endPos:a.index+a[0].length,lineNum:t});for(var s,r=/!\[([^\]]*)\]\(([^\)]+)\)/g;null!==(s=r.exec(e));)i.push({match:s,linkType:"markdown",startPos:s.index,endPos:s.index+s[0].length,lineNum:t});return i},o=c(o,a.line);let h=null;for(i of o)if(l>=i.startPos&&l<=i.endPos){h=i;break}if(!h&&0<o.length){let e=1/0;for(var d of o){var p=Math.min(Math.abs(l-d.startPos),Math.abs(l-d.endPos));p<e&&(e=p,h=d)}}if(!h){var u,o=Math.max(0,a.line-2),g=Math.min(n.lineCount()-1,a.line+2);let t=[];for(let e=o;e<=g;e++)e!==a.line&&(u=c(n.getLine(e),e),t=t.concat(u));if(0<t.length){let e=1/0;for(var m of t){var f=Math.abs(m.lineNum-a.line);f<e&&(e=f,h=m)}}}if(h&&((s=h.match).linkType=h.linkType,r=h.lineNum),s){let t=s[0],a=s.linkType,i;i="wiki"===a?s[1]:s[2],e.addItem(e=>{e.setTitle("上传到对象存储").setIcon("cloud-upload").onClick(async()=>{this.isPluginActivated?await this.uploadAndConvertImageLink(n,r,i,t):this.app.plugins.enabledPlugins.has("obsidian-content-protection")})}),e.addItem(e=>{e.setTitle("图片文字环绕").setIcon("image").setSubmenu();e=e.submenu;e.addItem(e=>{e.setTitle("圆角文字环绕（居左）").setIcon("chevron-left").onClick(()=>{this.convertImageToTextWrap(n,r,t,i,a,"rounded-left")})}),e.addItem(e=>{e.setTitle("圆角文字环绕（居右）").setIcon("chevron-right").onClick(()=>{this.convertImageToTextWrap(n,r,t,i,a,"rounded-right")})}),e.addItem(e=>{e.setTitle("圆形文字环绕（居左）").setIcon("target").onClick(()=>{this.convertImageToTextWrap(n,r,t,i,a,"circle-left")})}),e.addItem(e=>{e.setTitle("圆形文字环绕（居右）").setIcon("dot-circle").onClick(()=>{this.convertImageToTextWrap(n,r,t,i,a,"circle-right")})})})}})),this.registerEvent(this.app.workspace.on("file-menu",(e,t)=>{t instanceof TFile&&"md"===t.extension&&e.addItem(e=>{e.setTitle("删除文件及其附件").setIcon("trash-2").onClick(async()=>{this.isPluginActivated?new DeleteFileAndAttachmentsModal(this.app,this,t).open():this.app.plugins.enabledPlugins.has("obsidian-content-protection")})})})),this.registerDomEvent(document,"paste",this.handlePaste.bind(this)),this.settings.imageRename.enabled&&!this.settings.objectStorage.enabled&&(this.fileCreateEventRef=this.registerEvent(this.app.vault.on("create",this.handleFileCreate.bind(this)))),(this.settings.dragUpload&&this.settings.objectStorage.enabled||this.settings.imageRename.enabled&&!this.settings.objectStorage.enabled)&&this.registerDragEvents(),this.settings.attachFlow.enabled&&this.initAttachFlowFeatures()}onunload(){this.cleanupAttachFlowFeatures()}cleanupAttachFlowFeatures(){var e=document.querySelector(".imagen-viewer"),e=(e&&e.remove(),document.querySelector(".imagen-resize-handle")),e=(e&&e.remove(),document.querySelector(".imagen-context-menu"));e&&e.remove(),this.boundMouseMove&&document.removeEventListener("mousemove",this.boundMouseMove),this.boundMouseUp&&document.removeEventListener("mouseup",this.boundMouseUp),this.boundKeyDown&&document.removeEventListener("keydown",this.boundKeyDown),this.boundMouseMove=null,this.boundMouseUp=null,this.boundKeyDown=null,this.isResizing=!1,this.resizeData=null}initAttachFlowFeatures(){this.settings.attachFlow.imageViewer&&this.registerDomEvent(document,"click",this.handleImageClick.bind(this)),this.settings.attachFlow.dragResize&&(this.registerDomEvent(document,"mousedown",this.handleImageMouseDown.bind(this)),this.registerDomEvent(document,"mousemove",this.handleImageMouseMove.bind(this)),this.registerDomEvent(document,"mouseleave",this.handleImageMouseLeave.bind(this)))}handleImageClick(e){var t,a;this.isPluginActivated&&"IMG"===(t=e.target).tagName&&(a=t.getBoundingClientRect(),e.clientX-a.left<a.width/2)&&(e.preventDefault(),e.stopPropagation(),a=this.getImageInfo(t))&&this.showImageViewer(a.src,a.alt,a.isExternal,t)}getStandardizedImagePath(a,i){try{let e="",t=(e=a.includes("/")?a.split("/").pop():a,(e=decodeURIComponent(e)).startsWith("app://local/")&&(e=e.replace("app://local/","")),"");i&&!(t=i.includes("/")?i.split("/").pop():i).includes(".")&&e.includes(".")&&(n=e.split(".").pop(),t+="."+n);var n,s,r,o=this.app.vault.getFiles();for(s of o)if(s.path===e||s.path===t)return s.path;for(r of o)if(r.name===e||r.name===t)return r.path;var l,c=e.split(".")[0],h=t.split(".")[0];for(l of o){var d=l.name.split(".")[0];if(d===c||d===h)return l.path}return null}catch(e){return null}}isExternalImage(e){return!!e&&(e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:image/")||e.startsWith("ftp://")||e.startsWith("ftps://"))}getImageInfo(e){var n=e.alt||"",t=e.src||"";if(this.isExternalImage(t))return{src:t,alt:n,isExternal:!0};t=this.getStandardizedImagePath(t,n);if(t)return{src:t,alt:n,isExternal:!1};t=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(t){var a,i=t.editor.getValue(),s=e.getAttribute("src"),r=e.getAttribute("alt"),o=[/!\[\[([^\]]+)\]\]/g,/!\[([^\]]*)\]\(([^)]+)\)/g,/<img[^>]+src=["']([^"']+)["'][^>]*>/g],l=[];for(let e=0;e<o.length;e++)for(var c,h=o[e];null!==(c=h.exec(i));){var d=c[1]||c[2];d&&(d=d.split("|")[0].trim(),l.push({path:d,alt:c[1]||"",index:c.index,fullMatch:c[0]}))}for(a of l){var p=a.path;if(this.isExternalImage(p)){if(s&&(s.includes(p)||p.includes(s)))return{src:p,alt:n||a.alt,isExternal:!0}}else{var u=this.app.vault.getAbstractFileByPath(p);if(u&&u instanceof TFile){var u=p.split("/").pop(),g=u.split(".")[0];if(n&&r){var m=n.split(".")[0],f=r.split(".")[0];if((n===r||m===f)&&(p.includes(n)||n.includes(u)||u.includes(n)||g===m||g.includes(m)||m.includes(g)))return{src:p,alt:n,isExternal:!1}}if(s){f=s.split("/").pop();if(f&&(f===u||f.includes(u)||u.includes(f)))return{src:p,alt:n,isExternal:!1}}}}}}var v,y,w,t=e.src;if(t){let i="";if(i=t.startsWith("app://local/")?decodeURIComponent(t.replace("app://local/","")).split("/").pop():t.startsWith("file://")?decodeURIComponent(t.replace("file://","")).split("/").pop():t.includes("/")?t.split("/").pop():t){t=this.app.vault.getFiles().find(e=>{var e=e.name,t=e.split(".")[0],a=i.split(".")[0];return e===i||e.includes(i)||i.includes(e)||t===a||t.includes(a)||a.includes(t)});if(t)return{src:t.path,alt:n,isExternal:!1}}}for(v of e.attributes)if(v.name.startsWith("data-")){var x=this.app.vault.getAbstractFileByPath(v.value);if(x&&x instanceof TFile)return{src:v.value,alt:n,isExternal:!1}}let b=e.parentElement,k=0;for(;b&&k<5;){if(b.hasAttribute("data-path")){var S=b.getAttribute("data-path"),C=this.app.vault.getAbstractFileByPath(S);if(C&&C instanceof TFile)return{src:S,alt:n,isExternal:!1}}for(y of b.querySelectorAll("a[href], [data-href]")){var E=y.getAttribute("href")||y.getAttribute("data-href");if(E&&E.includes(".")){var T=this.app.vault.getAbstractFileByPath(E);if(T&&T instanceof TFile)return{src:E,alt:n,isExternal:!1}}}b=b.parentElement,k++}if(n){let t=null,a=0;for(w of this.app.vault.getFiles().filter(e=>/\.(png|jpg|jpeg|gif|bmp|svg|webp)$/i.test(e.name))){var A=w.name,I=A.split(".")[0],M=n.split(".")[0];let e=0;(e=A===n||I===M?100:A.includes(n)||n.includes(A)||I.includes(M)||M.includes(I)?80:60*this.calculateStringSimilarity(M.toLowerCase(),I.toLowerCase()))>a&&50<e&&(a=e,t=w)}if(t)return{src:t.path,alt:n,isExternal:!1}}return null}calculateStringSimilarity(e,t){var a;return e===t?1:0===e.length||0===t.length?0:0===(a=e.length>t.length?e:t).length?1:(t=this.levenshteinDistance(a,t.length<e.length?t:e),(a.length-t)/a.length)}levenshteinDistance(a,i){var n=[];for(let e=0;e<=i.length;e++)n[e]=[e];for(let e=0;e<=a.length;e++)n[0][e]=e;for(let t=1;t<=i.length;t++)for(let e=1;e<=a.length;e++)i.charAt(t-1)===a.charAt(e-1)?n[t][e]=n[t-1][e-1]:n[t][e]=Math.min(n[t-1][e-1]+1,n[t][e-1]+1,n[t-1][e]+1);return n[i.length][a.length]}showImageViewer(a,e,t=!1,N){let i=null;if(!t){if(a)if(!(i=this.app.vault.getAbstractFileByPath(a))&&a.startsWith("app://local/")&&(n=decodeURIComponent(a.replace("app://local/","")),i=this.app.vault.getAbstractFileByPath(n)),!i&&a.includes("/")){let t=a.split("/").pop();var n=this.app.vault.getFiles();i=n.find(e=>e.name===t)}i&&i instanceof TFile}let s=document.createElement("div"),r=(s.className="imagen-viewer",s.style.cssText=`
             position: fixed;
             top: 0;
             left: 0;
             width: 100%;
             height: 100%;
             background: transparent;
             z-index: 10000;
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
         `,document.createElement("div")),p=(r.className="imagen-editor-toolbar",r.style.cssText=`
             position: absolute;
             bottom: 20px;
             left: 50%;
             transform: translateX(-50%);
             background: rgba(40, 40, 40, 0.95);
             border-radius: 8px;
             padding: 10px;
             display: flex;
             gap: 10px;
             align-items: center;
             z-index: 10001;
             box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
         `,document.createElement("div")),u=(p.className="imagen-canvas-container",p.style.cssText=`
             position: relative;
             max-width: 90%;
             max-height: 80%;
             display: flex;
             align-items: center;
             justify-content: center;
         `,document.createElement("canvas")),o=(u.className="imagen-editor-canvas",document.createElement("img"));o.alt=e,o.style.display="none";let l;if(t)l=a;else try{var c=this.app.vault.getAbstractFileByPath(a);if(c&&c instanceof TFile)l=this.app.vault.getResourcePath(c);else{let t=a.split("/").pop();var h=this.app.vault.getFiles().find(e=>e.name===t);l=h?this.app.vault.getResourcePath(h):a}}catch(e){l=a}let d=async(a,i=0)=>{var e;if(3<=i)(e=document.createElement("div")).style.cssText=`
                     position: absolute;
                     top: 50%;
                     left: 50%;
                     transform: translate(-50%, -50%);
                     background: rgba(255, 0, 0, 0.9);
                     color: white;
                     padding: 20px;
                     border-radius: 8px;
                     text-align: center;
                     z-index: 1000;
                     max-width: 500px;
                     word-wrap: break-word;
                 `,e.innerHTML=`
                     <h3>外部图片加载失败</h3>
                     <p>经过3次尝试仍无法加载图片</p>
                     <p><strong>可能原因：</strong></p>
                     <ul style="text-align: left; margin: 10px 0;">
                         <li>网站禁止外部访问图片</li>
                         <li>图片链接已失效</li>
                         <li>网络连接问题</li>
                         <li>服务器拒绝请求</li>
                     </ul>
                     <p style="font-size: 12px; opacity: 0.8;">URL: ${a}</p>
                     <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 8px 15px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
                 `,p.appendChild(e);else try{var n=await requestUrl({url:a,headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Referer:a.split("/").slice(0,3).join("/"),Accept:"image/*,*/*;q=0.8","Accept-Language":"zh-CN,zh;q=0.9,en;q=0.8","Cache-Control":"no-cache"}});if(400<=n.status)throw new Error(`HTTP ${n.status}: `+(403===n.status?"服务器拒绝访问":404===n.status?"图片不存在":"请求失败"));var s=n.headers["content-type"]||"image/jpeg",r=(s.startsWith("image/"),new Blob([n.arrayBuffer],{type:s}));let e=URL.createObjectURL(r),t=(o.src=e,o.onload);o.onload=()=>{URL.revokeObjectURL(e),t&&t()},o.onerror=()=>{URL.revokeObjectURL(e),setTimeout(()=>d(a,i+1),1e3)}}catch(e){setTimeout(()=>d(a,i+1),1e3)}};t?d(l):(o.onerror=e=>{var t=document.createElement("div");t.style.cssText=`
                  position: absolute;
                  top: 50%;
                  left: 50%;
                  transform: translate(-50%, -50%);
                  background: rgba(255, 165, 0, 0.8);
                  color: white;
                  padding: 20px;
                  border-radius: 8px;
                  text-align: center;
                  z-index: 1000;
              `,t.innerHTML=`
                  <h3>内部图片加载失败</h3>
                  <p>无法找到或加载图片文件</p>
                  <p>路径: ${a}</p>
                  <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px; background: white; color: black; border: none; border-radius: 4px; cursor: pointer;">关闭</button>
              `,p.appendChild(t)},o.src=l);let g=null,m="view";let f="#ff0000",v=5,y=1,w=1,x=0,b=0,k=!1,S=!1,C=0,E=0,T=()=>{u&&(u.style.transform=`translate(${x}px, ${b}px) scale(${w})`,u.style.transformOrigin="0 0")},A=(e,t)=>{var a=p.getBoundingClientRect(),e=e-a.left,t=t-a.top,a=(e-x)/w,e=(t-b)/w;return{x:Math.max(0,Math.min(u.width,a)),y:Math.max(0,Math.min(u.height,e))}},I={Canvas:function(e){return this.canvas=e,this.ctx=e.getContext("2d"),this.objects=[],this.isDrawingMode=!1,this.freeDrawingBrush={color:"#ff0000",width:5,opacity:1},this.backgroundImage=null,this.width=e.width,this.height=e.height,this.currentPath=[],this.paths=[],this}};I.Canvas.prototype={setDimensions:function(e){this.canvas.width=e.width,this.canvas.height=e.height,this.width=e.width,this.height=e.height},setBackgroundImage:function(e,t){this.backgroundImage=e,t&&t()},renderAll:function(){this.ctx.clearRect(0,0,this.width,this.height),this.backgroundImage&&this.ctx.drawImage(this.backgroundImage,0,0,this.width,this.height),this.shapes&&this.shapes.filter(e=>"mosaic"===e.type).forEach(e=>{this.ctx.save();var t=Math.min(e.startX,e.endX),a=Math.min(e.startY,e.endY),i=Math.abs(e.endX-e.startX),n=Math.abs(e.endY-e.startY);H(this.ctx,t,a,i,n,e.size),this.ctx.restore()}),this.paths.forEach(t=>{if(t.points&&1<t.points.length){this.ctx.beginPath(),this.ctx.strokeStyle=t.color,this.ctx.lineWidth=t.width,this.ctx.globalAlpha=t.opacity,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.moveTo(t.points[0].x,t.points[0].y);for(let e=1;e<t.points.length;e++)this.ctx.lineTo(t.points[e].x,t.points[e].y);this.ctx.stroke(),this.ctx.globalAlpha=1}}),this.shapes&&this.shapes.filter(e=>"mosaic"!==e.type).forEach(e=>{this.ctx.save(),this.ctx.strokeStyle=e.color,this.ctx.lineWidth=e.width,this.ctx.globalAlpha=e.opacity;var t=Math.min(e.startX,e.endX),a=Math.min(e.startY,e.endY),i=Math.abs(e.endX-e.startX),n=Math.abs(e.endY-e.startY);switch(e.type){case"rectangle":this.ctx.strokeRect(t,a,i,n);break;case"circle":var s=t+i/2,r=a+n/2,o=Math.min(i,n)/2;this.ctx.beginPath(),this.ctx.arc(s,r,o,0,2*Math.PI),this.ctx.stroke();break;case"ellipse":var s=t+i/2,r=a+n/2,o=i/2,l=n/2;this.ctx.beginPath(),this.ctx.ellipse(s,r,o,l,0,0,2*Math.PI),this.ctx.stroke();break;case"arrow":this.ctx.beginPath(),this.ctx.moveTo(e.startX,e.startY),this.ctx.lineTo(e.endX,e.endY),this.ctx.stroke();s=Math.atan2(e.endY-e.startY,e.endX-e.startX);this.ctx.beginPath(),this.ctx.moveTo(e.endX,e.endY),this.ctx.lineTo(e.endX-15*Math.cos(s-Math.PI/6),e.endY-15*Math.sin(s-Math.PI/6)),this.ctx.moveTo(e.endX,e.endY),this.ctx.lineTo(e.endX-15*Math.cos(s+Math.PI/6),e.endY-15*Math.sin(s+Math.PI/6)),this.ctx.stroke();break;case"highlight":this.ctx.fillStyle=e.color,this.ctx.globalAlpha=.5,this.ctx.fillRect(t,a,i,n)}this.ctx.restore()}),this.texts&&0<this.texts.length&&this.texts.forEach(e=>{this.ctx.save();var t=e.fontSize||20;this.ctx.font=`900 ${t}px Arial Black, Arial, sans-serif`,this.ctx.textAlign="left",this.ctx.textBaseline="top",this.ctx.shadowColor="rgba(0, 0, 0, 0.5)",this.ctx.shadowBlur=3,this.ctx.shadowOffsetX=2,this.ctx.shadowOffsetY=2,this.ctx.fillStyle=e.color||"#ff0000",this.ctx.fillText(e.text,e.x,e.y),this.ctx.shadowColor="transparent",this.ctx.shadowBlur=0,this.ctx.shadowOffsetX=0,this.ctx.shadowOffsetY=0,this.ctx.strokeStyle="white",this.ctx.lineWidth=t/4,this.ctx.lineJoin="round",this.ctx.strokeText(e.text,e.x,e.y),this.ctx.fillStyle=e.color||"#ff0000",this.ctx.fillText(e.text,e.x,e.y),this.ctx.restore()})},toDataURL:function(e={}){try{return this.canvas.toDataURL(e.format||"image/png",e.quality||1)}catch(e){throw e}},clear:function(){this.paths=[],this.shapes=[],this.renderAll()},dispose:function(){this.objects=[],this.paths=[],this.backgroundImage=null}};var n=(e,t,a=!1,i=null)=>{let n=document.createElement("button");var s;return n.className="imagen-tool-btn "+(a?"active":""),n.style.cssText=`
                  background: ${a?"#007acc":"rgba(255, 255, 255, 0.1)"};
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  border-radius: 4px;
                  padding: 6px 8px;
                  cursor: pointer;
                  font-size: 11px;
                  transition: all 0.2s ease;
                  display: flex;
                  align-items: center;
                  gap: 4px;
                  min-width: 32px;
                  justify-content: center;
              `,i&&((a=document.createElement("span")).className="imagen-icon",a.style.cssText=`
                      display: inline-flex;
                      align-items: center;
                      justify-content: center;
                      width: 16px;
                      height: 16px;
                  `,(s={eye:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-eye"><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></svg>',pencil:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-pencil"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>',"grid-3x3":'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="8" y="3" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="13" y="3" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="18" y="3" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="3" y="8" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="8" y="8" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="13" y="8" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="18" y="8" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="3" y="13" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="8" y="13" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="13" y="13" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="18" y="13" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="3" y="18" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="8" y="18" width="4" height="4" fill="currentColor" opacity="0.7"/><rect x="13" y="18" width="4" height="4" fill="currentColor" opacity="0.3"/><rect x="18" y="18" width="4" height="4" fill="currentColor" opacity="0.7"/</svg>',square:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-square"><rect width="18" height="18" x="3" y="3" rx="2"/></svg>',circle:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle"><circle cx="12" cy="12" r="10"/></svg>',arrow:'<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-move-down-left-icon lucide-move-down-left"><path d="M11 19H5V13"/><path d="M19 5L5 19"/></svg>',highlighter:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-highlighter"><path d="m9 11-6 6v3h9l3-3"/><path d="m22 12-4.6 4.6a2 2 0 0 1-2.8 0l-5.2-5.2a2 2 0 0 1 0-2.8L14 4"/></svg>',crop:'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-crop-icon lucide-crop"><path d="M6 2v14a2 2 0 0 0 2 2h14"/><path d="M18 22V8a2 2 0 0 0-2-2H2"/></svg>'})[i]?a.innerHTML=s[i]:(a.textContent=i.charAt(0).toUpperCase(),a.style.fontWeight="bold"),n.appendChild(a)),e&&(!i||40<n.offsetWidth)&&((s=document.createElement("span")).textContent=e,s.style.fontSize="10px",n.appendChild(s)),n.addEventListener("click",()=>{r.querySelectorAll(".imagen-tool-btn").forEach(e=>{e.classList.remove("active"),e.style.background="rgba(255, 255, 255, 0.1)"}),n.classList.add("active"),n.style.background="#007acc",m=t,g&&(g.isDrawingMode="draw"===t,u.style.cursor="draw"===t?"crosshair":"text"===t?"text":"default")}),n},e=(r.appendChild(n("查看","view",!0,"eye")),r.appendChild(n("绘制","draw",!1,"pencil")),r.appendChild(n("马赛克","mosaic",!1,"grid-3x3")),r.appendChild(n("方块","rectangle",!1,"square")),r.appendChild(n("圆形","circle",!1,"circle")),r.appendChild(n("箭头","arrow",!1,"arrow")),r.appendChild(n("高亮","highlight",!1,"highlighter")),r.appendChild(n("文字","text",!1,"type")),r.appendChild(n("裁切","crop",!1,"crop")),r.appendChild(((e=document.createElement("input")).type="color",e.value=f,e.style.cssText=`
                  width: 25px;
                  height: 30px;
                  border: none;
                  border-radius: 50%;
                  cursor: pointer;
                  background: none;
              `,e.addEventListener("change",e=>{f=e.target.value,g&&(g.freeDrawingBrush.color=f)}),e)),r.appendChild(((c=document.createElement("div")).style.cssText=`
                  display: flex;
                  align-items: center;
                  gap: 5px;
              `,(h=document.createElement("span")).textContent="大小:",h.style.color="white",h.style.fontSize="12px",h.style.width="30px",(n=document.createElement("input")).type="range",n.min="1",n.max="20",n.value=v,n.style.cssText=`
                  width: 60px;
                  height: 20px;
              `,n.addEventListener("input",e=>{v=parseInt(e.target.value),g&&(g.freeDrawingBrush.width=v)}),c.appendChild(h),c.appendChild(n),c)),document.createElement("button"));e.textContent="清除",e.style.cssText=`
              background: rgba(255, 100, 100, 0.8);
              color: white;
              border: 1px solid rgba(255, 255, 255, 0.2);
              border-radius: 4px;
              padding: 6px 12px;
              cursor: pointer;
              font-size: 12px;
          `,e.addEventListener("click",()=>{if(g){g.clear(),g.paths=[],g.shapes=[],g.mosaicAreas=[],g.texts=[];var a=document.querySelector(".imagen-text-input"),a=(a&&a.remove(),o.naturalWidth),i=o.naturalHeight,n=.9*window.innerWidth,s=.8*window.innerHeight;let e=a,t=i;(e>n||t>s)&&(a=n/e,i=s/t,n=Math.min(a,i),e*=n,t*=n),u.width=e,u.height=t,g.setDimensions({width:e,height:t}),g.setBackgroundImage(o,()=>{g.renderAll()});s=p.getBoundingClientRect(),a=s.width/2,i=s.height/2;x=a-e/2,b=i-t/2,T()}}),r.appendChild(e),!t&&i&&i instanceof TFile?((e=document.createElement("button")).textContent="保存",e.style.cssText=`
                  background: rgba(100, 255, 100, 0.8);
                  color: white;
                  border: 1px solid rgba(255, 255, 255, 0.2);
                  border-radius: 4px;
                  padding: 6px 12px;
                  cursor: pointer;
                  font-size: 12px;
              `,e.addEventListener("click",()=>{_()}),r.appendChild(e)):t?((e=document.createElement("span")).textContent="外部图片（仅查看）",e.style.cssText=`
                  color: rgba(255, 255, 255, 0.7);
                  font-size: 12px;
                  padding: 6px 12px;
              `,r.appendChild(e)):((t=document.createElement("span")).textContent="内部图片（无法保存）",t.style.cssText=`
                  color: rgba(255, 200, 100, 0.8);
                  font-size: 12px;
                  padding: 6px 12px;
              `,r.appendChild(t));let M=!(o.onload=()=>{var e=.9*window.innerWidth,t=.8*window.innerHeight;let a=o.naturalWidth,i=o.naturalHeight;(a>e||i>t)&&(e=e/a,t=t/i,e=Math.min(e,t),a*=e,i*=e),u.width=a,u.height=i,u.style.cssText=`
                  border: 1px solid rgba(255, 255, 255, 0.3);
                  cursor: default;
              `,(g=new I.Canvas(u)).setDimensions({width:a,height:i}),g.setBackgroundImage(o,()=>{g.renderAll(),R()}),g.freeDrawingBrush.color=f,g.freeDrawingBrush.width=v,g.freeDrawingBrush.opacity=y;t=p.getBoundingClientRect(),e=t.width/2,t=t.height/2;x=e-a/2,b=t-i/2,T()}),B=null,P=e=>{var t,a;g&&(M=!0,t=(a=A(e.clientX,e.clientY)).x,a=a.y,B={x:t,y:a},"draw"===m?g.currentPath={type:"draw",points:[{x:t,y:a}],color:f,width:v,opacity:y}:"mosaic"===m?g.currentShape={type:"mosaic",startX:t,startY:a,endX:t,endY:a,size:v}:"text"===m?V(t,a):"crop"===m?g.cropSelection={startX:t,startY:a,endX:t,endY:a}:["rectangle","circle","arrow","highlight"].includes(m)&&(e=e.shiftKey,e="circle"===m&&e?"ellipse":m,g.currentShape={type:e,startX:t,startY:a,endX:t,endY:a,color:f,width:v,opacity:"highlight"===m?.3:y}))},L=e=>{if(g&&M){var e=A(e.clientX,e.clientY),t=e.x,e=e.y;if("draw"===m&&g.currentPath){if(g.currentPath.points.push({x:t,y:e}),g.renderAll(),1<g.currentPath.points.length){var a=g.ctx,i=(a.beginPath(),a.strokeStyle=g.currentPath.color,a.lineWidth=g.currentPath.width,a.globalAlpha=g.currentPath.opacity,a.lineCap="round",a.lineJoin="round",g.currentPath.points);a.moveTo(i[0].x,i[0].y);for(let e=1;e<i.length;e++)a.lineTo(i[e].x,i[e].y);a.stroke(),a.globalAlpha=1}}else g.currentShape?(g.currentShape.endX=t,g.currentShape.endY=e,g.renderAll(),W(g.ctx,g.currentShape)):g.cropSelection&&(g.cropSelection.endX=t,g.cropSelection.endY=e,g.renderAll(),O(g.ctx,g.cropSelection))}},D=()=>{if(g&&M){let e=M=!1;var t,a,i,n;"draw"===m&&g.currentPath?(1<g.currentPath.points.length&&(g.paths.push({...g.currentPath}),e=!0),g.currentPath=[]):g.currentShape?(X(g,g.currentShape),g.currentShape=null,e=!0):g.cropSelection&&(n=g.cropSelection,t=Math.min(n.startX,n.endX),a=Math.min(n.startY,n.endY),i=Math.abs(n.endX-n.startX),n=Math.abs(n.endY-n.startY),10<i&&10<n&&(j(g,t,a,i,n),e=!0),g.cropSelection=null),g.renderAll(),e&&R()}},W=(e,t)=>{e.save(),e.strokeStyle=t.color,e.lineWidth=t.width,e.globalAlpha=t.opacity;var a=Math.min(t.startX,t.endX),i=Math.min(t.startY,t.endY),n=Math.abs(t.endX-t.startX),s=Math.abs(t.endY-t.startY);switch(t.type){case"rectangle":e.strokeRect(a,i,n,s);break;case"circle":var r=(t.startX+t.endX)/2,o=(t.startY+t.endY)/2,l=Math.min(n,s)/2;e.beginPath(),e.arc(r,o,l,0,2*Math.PI),e.stroke();break;case"ellipse":var r=(t.startX+t.endX)/2,o=(t.startY+t.endY)/2,l=n/2,c=s/2;e.beginPath(),e.ellipse(r,o,l,c,0,0,2*Math.PI),e.stroke();break;case"arrow":Y(e,t.startX,t.startY,t.endX,t.endY);break;case"highlight":e.fillStyle=t.color,e.globalAlpha=t.opacity||.3,e.fillRect(a,i,n,s);break;case"mosaic":H(e,a,i,n,s,t.size)}e.restore()},O=(e,t)=>{e.save();var a=Math.min(t.startX,t.endX),i=Math.min(t.startY,t.endY),n=Math.abs(t.endX-t.startX),t=Math.abs(t.endY-t.startY),a=Math.max(0,Math.min(e.canvas.width,a)),i=Math.max(0,Math.min(e.canvas.height,i)),n=Math.min(n,e.canvas.width-a),t=Math.min(t,e.canvas.height-i);0<n&&0<t&&(e.strokeStyle="#007ACC",e.lineWidth=2,e.setLineDash([8,4]),e.globalAlpha=.8,e.strokeRect(a,i,n,t),e.fillStyle="rgba(0, 122, 204, 0.1)",e.fillRect(a,i,n,t),e.fillStyle="#007ACC",e.globalAlpha=1,e.fillRect(a-3,i-3,6,6),e.fillRect(a+n-3,i-3,6,6),e.fillRect(a-3,i+t-3,6,6),e.fillRect(a+n-3,i+t-3,6,6)),e.restore()},j=(i,e,t,n,s)=>{let r=Math.max(0,Math.min(i.canvas.width-1,e)),o=Math.max(0,Math.min(i.canvas.height-1,t)),l=Math.min(n,i.canvas.width-r),c=Math.min(s,i.canvas.height-o);if(l<1||c<1)console.warn("Imagen: 裁切区域太小，无法执行裁切");else{var h,d,e=document.createElement("canvas"),t=(e.width=l,e.height=c,e.getContext("2d"));i.backgroundImage&&(n=i.backgroundImage.naturalWidth/i.canvas.width,s=i.backgroundImage.naturalHeight/i.canvas.height,h=r*n,d=o*s,n=l*n,s=c*s,t.drawImage(i.backgroundImage,h,d,n,s,0,0,l,c));let a=new Image;a.onload=()=>{i.canvas.width=l,i.canvas.height=c,i.width=l,i.height=c,i.ctx=i.canvas.getContext("2d"),i.backgroundImage=a,i.paths&&(i.paths=i.paths.map(e=>({...e,points:e.points?e.points.map(e=>({x:e.x-r,y:e.y-o})).filter(e=>0<=e.x&&0<=e.y&&e.x<l&&e.y<c):[]})).filter(e=>e.points&&0<e.points.length)),i.shapes&&(i.shapes=i.shapes.map(e=>({...e,startX:e.startX-r,startY:e.startY-o,endX:e.endX-r,endY:e.endY-o})).filter(e=>{var t=Math.min(e.startX,e.endX),a=Math.max(e.startX,e.endX),i=Math.min(e.startY,e.endY),e=Math.max(e.startY,e.endY);return 0<=a&&t<l&&0<=e&&i<c})),i.texts&&(i.texts=i.texts.map(e=>({...e,x:e.x-r,y:e.y-o})).filter(e=>0<=e.x&&0<=e.y&&e.x<l&&e.y<c)),i.mosaicAreas&&(i.mosaicAreas=[]),w=1;var e=p.getBoundingClientRect(),t=e.width/2,e=e.height/2;x=t-l/2,b=e-c/2,T(),i.renderAll()},a.src=e.toDataURL()}},X=(e,t)=>{e.shapes||(e.shapes=[]),e.shapes.push({...t})},Y=(e,t,a,i,n)=>{z(e,t,a,i,n,1)},z=(e,t,a,i,n,s)=>{var r=Math.sqrt((i-t)**2+(n-a)**2),o=Math.atan2(n-a,i-t),r=Math.min(25*s,Math.max(12*s,.15*r)),s=(e.save(),e.lineCap="round",e.lineJoin="round",e.shadowColor="rgba(0, 0, 0, 0.2)",e.shadowBlur=2*s,e.shadowOffsetX=+s,e.shadowOffsetY=+s,e.beginPath(),e.moveTo(t,a),e.lineTo(i-.7*r*Math.cos(o),n-.7*r*Math.sin(o)),e.stroke(),e.shadowColor="transparent",e.beginPath(),e.moveTo(i,n),i-r*Math.cos(o-Math.PI/7)),t=n-r*Math.sin(o-Math.PI/7),a=i-r*Math.cos(o+Math.PI/7),l=n-r*Math.sin(o+Math.PI/7);e.moveTo(i,n),e.lineTo(s,t),e.lineTo(i-.6*r*Math.cos(o),n-.6*r*Math.sin(o)),e.lineTo(a,l),e.closePath(),e.fillStyle=e.strokeStyle,e.fill(),e.stroke(),e.restore()},H=(e,t,a,i,n,s)=>{var r,o,l;i<=0||n<=0||(l=e.getImageData(t,a,i,n),(r=document.createElement("canvas")).width=i,r.height=n,(o=r.getContext("2d")).putImageData(l,0,0),l=Math.max(8,Math.floor(s)),U(o,0,0,i,n,l),e.drawImage(r,t,a))};let U=(e,t,a,c,h,i)=>{var d=Math.max(8,Math.floor(i));if(t=Math.floor(t),a=Math.floor(a),c=Math.floor(c),h=Math.floor(h),!(t<0||a<0||c<=0||h<=0))try{var n=e.getImageData(t,a,c,h),p=n.data;for(let l=0;l<h;l+=d)for(let o=0;o<c;o+=d){var u=Math.min(d,c-o),g=Math.min(d,h-l);let a=0,i=0,n=0,s=0,r=0;for(let t=0;t<g;t++)for(let e=0;e<u;e++){var m=4*((l+t)*c+(o+e));0<=m&&m<p.length-3&&(a+=p[m],i+=p[1+m],n+=p[2+m],s+=p[3+m],r++)}if(0<r){var f=Math.round(a/r),v=Math.round(i/r),y=Math.round(n/r),w=Math.round(s/r);for(let t=0;t<g;t++)for(let e=0;e<u;e++){var x=4*((l+t)*c+(o+e));0<=x&&x<p.length-3&&(p[x]=f,p[1+x]=v,p[2+x]=y,p[3+x]=w)}}}e.putImageData(n,t,a)}catch(e){e.name}},V=(a,i)=>{var e=p.querySelector(".imagen-text-input");e&&e.remove();let n=document.createElement("input");n.type="text",n.className="imagen-text-input",n.placeholder="输入文字...";u.getBoundingClientRect();var e=p.getBoundingClientRect(),t=a*w+x+e.left,e=i*w+b+e.top;n.style.cssText=`
                  position: fixed;
                  left: ${t}px;
                  top: ${e}px;
                  font-size: ${Math.max(20,Math.min(32,2*v))}px;
                  color: ${f};
                  z-index: 10001;
                  min-width: 100px;
              `,document.body.appendChild(n);let s=!0,r=(setTimeout(()=>{n.focus(),n.select(),s=!1},50),()=>{n&&n.parentNode&&n.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",l)}),o=e=>{var t;document.activeElement===n&&(e.stopPropagation(),"Enter"===e.key?((t=n.value.trim())&&q(a,i,t,f,Math.max(12,Math.min(32,2*v))),r()):"Escape"===e.key&&r())},l=e=>{s||e.target===n||r()};n.addEventListener("click",e=>{e.stopPropagation()}),n.addEventListener("mousedown",e=>{e.stopPropagation()}),document.addEventListener("keydown",o),n.addEventListener("blur",e=>{s||setTimeout(()=>{document.activeElement!==n&&n.parentNode&&r()},150)}),setTimeout(()=>{document.addEventListener("click",l)},100)},q=(e,t,a,i,n)=>{g.texts||(g.texts=[]);var s={type:"text",x:e,y:t,text:a,color:i,fontSize:n},s=(g.texts.push(s),g.renderAll(),g.ctx),n=(s.save(),1.3*n);s.font=`900 ${n}px Arial Black, Arial, sans-serif`,s.textBaseline="top",s.shadowColor="rgba(0, 0, 0, 0.8)",s.shadowBlur=Math.max(2,n/8),s.shadowOffsetX=Math.max(1,n/16),s.shadowOffsetY=Math.max(1,n/16),s.fillStyle=i,s.fillText(a,e,t),s.shadowColor="transparent",s.shadowBlur=0,s.shadowOffsetX=0,s.shadowOffsetY=0,s.strokeStyle="white",s.lineWidth=Math.max(2,n/4),s.lineJoin="round",s.strokeText(a,e,t),s.fillStyle=i,s.fillText(a,e,t),s.restore(),R()},_=(u.addEventListener("mousedown",P),u.addEventListener("mousemove",L),u.addEventListener("mouseup",D),u.addEventListener("mouseleave",D),async()=>{if(g)try{var e=document.createElement("canvas"),t=u.width!==o.naturalWidth||u.height!==o.naturalHeight;t?(e.width=u.width,e.height=u.height):(e.width=o.naturalWidth,e.height=o.naturalHeight);let c=e.getContext("2d",{willReadFrequently:!0}),h=(t?c.drawImage(u,0,0):c.drawImage(o,0,0),t?1:o.naturalWidth/u.width),d=t?1:o.naturalHeight/u.height;g.shapes&&g.shapes.filter(e=>"mosaic"===e.type).forEach(e=>{c.save();var t=Math.min(e.startX,e.endX)*h,a=Math.min(e.startY,e.endY)*d,i=Math.abs(e.endX-e.startX)*h,n=Math.abs(e.endY-e.startY)*d,e=Math.max(8,2*e.size);U(c,t,a,i,n,e),c.restore()}),g.paths&&g.paths.forEach(e=>{if(e.points&&1<e.points.length){c.beginPath(),c.strokeStyle=e.color,c.lineWidth=e.width*h,c.globalAlpha=e.opacity,c.lineCap="round",c.lineJoin="round";var t=e.points;c.moveTo(t[0].x*h,t[0].y*d);for(let e=1;e<t.length;e++)c.lineTo(t[e].x*h,t[e].y*d);c.stroke()}}),g.shapes&&g.shapes.filter(e=>"mosaic"!==e.type).forEach(e=>{c.save(),c.strokeStyle=e.color,c.lineWidth=e.width*h,c.globalAlpha=e.opacity;var t=Math.min(e.startX,e.endX)*h,a=Math.min(e.startY,e.endY)*d,i=Math.abs(e.endX-e.startX)*h,n=Math.abs(e.endY-e.startY)*d;switch(e.type){case"rectangle":c.strokeRect(t,a,i,n);break;case"circle":var s=(e.startX+e.endX)/2*h,r=(e.startY+e.endY)/2*d,o=Math.min(i,n)/2;c.beginPath(),c.arc(s,r,o,0,2*Math.PI),c.stroke();break;case"ellipse":var s=(e.startX+e.endX)/2*h,r=(e.startY+e.endY)/2*d,o=i/2,l=n/2;c.beginPath(),c.ellipse(s,r,o,l,0,0,2*Math.PI),c.stroke();break;case"arrow":s=e.startX*h,r=e.startY*d,o=e.endX*h,l=e.endY*d;z(c,s,r,o,l,h);break;case"highlight":c.fillStyle=e.color,c.fillRect(t,a,i,n)}c.restore()}),g.texts&&g.texts.forEach(e=>{c.save();var t=e.fontSize*h,a=e.x*h,i=e.y*d;c.font=`900 ${t}px Arial Black, Arial, sans-serif`,c.textBaseline="top",c.globalAlpha=1,c.shadowColor="rgba(0, 0, 0, 0.8)",c.shadowBlur=Math.max(2,t/8),c.shadowOffsetX=Math.max(1,t/16),c.shadowOffsetY=Math.max(1,t/16),c.fillStyle=e.color,c.fillText(e.text,a,i),c.shadowColor="transparent",c.shadowBlur=0,c.shadowOffsetX=0,c.shadowOffsetY=0,c.strokeStyle="white",c.lineWidth=Math.max(2,t/4),c.lineJoin="round",c.strokeText(e.text,a,i),c.fillStyle=e.color,c.fillText(e.text,a,i),c.restore()}),c.globalAlpha=1,e.toBlob(async e=>{if(e)try{var t=await e.arrayBuffer();if(i&&i instanceof TFile){await this.app.vault.modifyBinary(i,t);try{setTimeout(()=>{let r=i.name,o=i.path;var e=document.querySelectorAll("img");let l=0;e.forEach((a,t)=>{var e=a.src||"",i=a.alt||"",n=r.replace(/\.[^/.]+$/,""),s=o.replace(/\.[^/.]+$/,"");if(e.includes(r)||e.includes(o)||e.includes(n)||e.includes(s)||i.includes(r)||i.includes(n)||i.includes(o)||i.includes(s)||decodeURIComponent(e).includes(r)||decodeURIComponent(e).includes(o)||e.replace("app://local/","").includes(r)||e.replace("app://local/","").includes(o)){n=a.src,i=Date.now()+t;a.removeAttribute("width"),a.removeAttribute("height"),a.removeAttribute("data-width"),a.removeAttribute("data-height"),a.style.width="",a.style.height="",a.style.maxWidth="",a.style.maxHeight="",a.style.minWidth="",a.style.minHeight="",a.style.aspectRatio="",a.style.objectFit="",a.style.objectPosition="",a.style.display="none",a.style.display="";let e;n.includes("?")?(e=n.replace(/([?&])t=\d+/,"$1t="+i))===n&&(e=n+"&t="+i):e=n+"?t="+i,a.src=e,setTimeout(()=>{let e=()=>{a.removeAttribute("width"),a.removeAttribute("height"),a.style.width="",a.style.height="",a.style.maxWidth="100%",a.style.height="auto";var t=a.parentElement;if(t){t.style.display="none",t.offsetHeight,t.style.display="";let e=t.parentElement;for(;e&&e!==document.body;)e.style.display="none",e.offsetHeight,e.style.display="",e=e.parentElement}window.app&&window.app.workspace&&window.app.workspace.trigger("layout-change"),a.removeEventListener("load",e)};a.addEventListener("load",e),setTimeout(()=>{a.style.opacity="0.99",setTimeout(()=>{a.style.opacity="1",a.removeAttribute("width"),a.removeAttribute("height"),a.style.width="",a.style.height=""},10)},100)},20),l++}}),0===l&&e.forEach((i,n)=>{i.src&&setTimeout(()=>{var e=i.src,t=Date.now()+10*n;let a;e.includes("?")?(a=e.replace(/([?&])t=\d+/,"$1t="+t))===e&&(a=e+"&t="+t):a=e+"?t="+t,i.src=a},50+20*n)}),setTimeout(()=>{var e=new CustomEvent("imageRefresh",{detail:{fileName:r,filePath:o}}),e=(document.dispatchEvent(e),new CustomEvent("obsidian:image-reload",{detail:{fileName:r,filePath:o}}));document.dispatchEvent(e),"caches"in window&&caches.keys().then(e=>{e.forEach(e=>{caches.open(e).then(t=>{t.keys().then(e=>{e.forEach(e=>{(e.url.includes(r)||e.url.includes(o))&&t.delete(e)})})})})}),document.body.style.transform="translateZ(0)",document.body.style.backfaceVisibility="hidden",setTimeout(()=>{document.body.style.transform="",document.body.style.backfaceVisibility=""},10),setTimeout(()=>{window.dispatchEvent(new Event("resize"))},50),setTimeout(()=>{document.querySelectorAll("img").forEach(e=>{var t;e.src&&(e.src.includes(r)||e.src.includes(o))&&(t=window.getComputedStyle(e),e.style.width=t.width,e.style.height=t.height,setTimeout(()=>{e.style.width="",e.style.height=""},10))})},100)},200)},150)}catch(e){}try{setTimeout(()=>{"function"==typeof $&&$()},300)}catch(e){}}}catch(e){}},"image/png",.95)}catch(e){}}),K=e=>{var t;e.target===u&&(e.preventDefault(),w=1,t=(e=p.getBoundingClientRect()).width/2,e=e.height/2,x=t-u.width/2,b=e-u.height/2,T())},J=e=>{var t;e.target===u&&(w=1,t=(e=p.getBoundingClientRect()).width/2,e=e.height/2,x=t-u.width/2,b=e-u.height/2,T())},F=[],G=20,R=()=>{if(g){let e=null;try{e=g.toDataURL()}catch(e){}var t={canvasDataURL:e,texts:g.texts?JSON.parse(JSON.stringify(g.texts)):[],shapes:g.shapes?JSON.parse(JSON.stringify(g.shapes)):[],paths:g.paths?JSON.parse(JSON.stringify(g.paths)):[],mosaicAreas:g.mosaicAreas?JSON.parse(JSON.stringify(g.mosaicAreas)):[],canvasWidth:u.width,canvasHeight:u.height,backgroundImage:o?o.src:null,timestamp:Date.now()};F.push(t),F.length>G&&F.shift()}},Z=()=>{try{var e,t;0!==F.length&&(F.pop(),0===F.length?(g.clear(),g.texts=[],g.shapes=[],g.paths=[],g.mosaicAreas=[],o&&o.naturalWidth&&o.naturalHeight&&o.src&&(u.width=o.naturalWidth,u.height=o.naturalHeight,g.setDimensions({width:o.naturalWidth,height:o.naturalHeight}),g.setBackgroundImage(o,g.renderAll.bind(g)),e=p.getBoundingClientRect(),x=(e.width-u.width)/2,b=(e.height-u.height)/2,T()),g.renderAll()):((t=F[F.length-1]).canvasWidth&&t.canvasHeight&&(u.width=t.canvasWidth,u.height=t.canvasHeight,g.setDimensions({width:t.canvasWidth,height:t.canvasHeight})),g.texts=t.texts||[],g.shapes=t.shapes||[],g.paths=t.paths||[],g.mosaicAreas=t.mosaicAreas||[],t.backgroundImage&&o&&o.src?g.setBackgroundImage(o,g.renderAll.bind(g)):g.renderAll()))}catch(e){}},Q=e=>{"Escape"===e.key?$():" "===e.key||"Space"===e.code?(e.preventDefault(),k=!0,p.style.cursor="grab"):(e.ctrlKey||e.metaKey)&&"z"===e.key&&(e.preventDefault(),Z())},ee=e=>{" "!==e.key&&"Space"!==e.code||(e.preventDefault(),k=!1,S=!1,p.style.cursor="default")},te=e=>{k&&0===e.button&&(e.preventDefault(),S=!0,C=e.clientX,E=e.clientY,p.style.cursor="grabbing")},ae=e=>{var t,a;S&&k&&(e.preventDefault(),t=e.clientX-C,a=e.clientY-E,x+=t,b+=a,C=e.clientX,E=e.clientY,T())},ie=e=>{S&&(e.preventDefault(),S=!1,k?p.style.cursor="grab":p.style.cursor="default")},ne=e=>{e.target===s&&$()},$=()=>{u.removeEventListener("mousedown",P),u.removeEventListener("mousemove",L),u.removeEventListener("mouseup",D),u.removeEventListener("mouseleave",D),g&&(g.dispose(),g=null),document.removeEventListener("keydown",Q),document.removeEventListener("keyup",ee),document.removeEventListener("mousedown",te),document.removeEventListener("mousemove",ae),document.removeEventListener("mouseup",ie),s.removeEventListener("click",ne),p.removeEventListener("wheel",se),p.removeEventListener("contextmenu",K),p.removeEventListener("dblclick",J),document.body.removeChild(s)},se=e=>{e.preventDefault();var e=0<e.deltaY?.9:1.1,e=Math.max(.1,Math.min(5,w*e)),t=p.getBoundingClientRect(),a=t.width/2,i=t.height/2,n=u.getBoundingClientRect();n.left,t.left,t.top,w,x,u.width,w,b,u.height,w,x,u.width,b,u.height;x=a-u.width*e/2,b=i-u.height*e/2,w=e,T()};document.addEventListener("keydown",Q),document.addEventListener("keyup",ee),document.addEventListener("mousedown",te),document.addEventListener("mousemove",ae),document.addEventListener("mouseup",ie),s.addEventListener("click",ne),p.addEventListener("wheel",se,{passive:!1}),p.addEventListener("contextmenu",K),p.addEventListener("dblclick",J),p.appendChild(u),s.appendChild(r),s.appendChild(p),s.appendChild(o),document.body.appendChild(s)}handleImageMouseMove(e){var t,a,i=e.target;"IMG"===i.tagName&&(a=i.getBoundingClientRect(),t=e.clientX>a.right-10,a=a.bottom-10<e.clientY,i.style.cursor=t&&a?"nw-resize":t?"ew-resize":a?"ns-resize":"")}handleImageMouseLeave(e){e=e.target;"IMG"===e.tagName&&(e.style.cursor="")}handleImageMouseDown(e){var t,a,i=e.target;"IMG"===i.tagName&&(a=i.getBoundingClientRect(),t=e.clientX>a.right-10,a=a.bottom-10<e.clientY,t||a||t&&a)&&(e.preventDefault(),this.startImageResize(i,e,t,a))}startImageResize(r,e,o,l){let c=e.clientX,h=e.clientY,d=r.offsetWidth,p=r.offsetHeight,t=r.parentElement;for(;t&&"SPAN"!==t.tagName&&(t=t.parentElement)&&t!==document.body;);t&&"SPAN"===t.tagName&&!Array.from(t.classList).some(e=>e.startsWith("image-mask"))&&t.classList.contains("draggable");let u=d/p,g=e=>{e.preventDefault(),e.stopPropagation()},a=(o&&l?document.body.style.cursor="nw-resize":o?document.body.style.cursor="ew-resize":l&&(document.body.style.cursor="ns-resize"),e=>{r.addEventListener("click",g);var t,a=e.clientX-c,e=e.clientY-h;let i=d,n=p,s=(!1!==this.settings.attachFlow.maintainAspectRatio?(o&&l?(t=Math.abs(a),Math.abs(e)<=t?(i=Math.max(50,d+a),n=i/u):(n=Math.max(50,p+e),i=n*u)):o?(i=Math.max(50,d+a),n=i/u):l&&(n=Math.max(50,p+e),i=n*u),i<50&&(i=50,n=i/u),n<50&&(n=50,i=n*u)):(o&&(i=Math.max(50,d+a)),l&&(n=Math.max(50,p+e))),r.style.width=Math.round(i)+"px",r.style.height=Math.round(n)+"px",r.parentElement);for(;s&&"SPAN"!==s.tagName&&(s=s.parentElement)&&s!==document.body;);s&&"SPAN"===s.tagName&&(Array.from(s.classList).some(e=>e.startsWith("image-mask"))||s.classList.contains("draggable")?(s.style.width=Math.round(i)+"px",s.style.height=Math.round(n)+"px",this.updateSpanStyleInEditor(s,Math.round(i),Math.round(n))):(s.classList.contains("sidenote-L")||s.classList.contains("sidenote"))&&(t=s.querySelector("img"))&&(t.setAttribute("width",Math.round(i)),this.updateSidenoteImageWidthInEditor(s,Math.round(i))))}),i=()=>{document.body.style.cursor="",document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i);setTimeout(()=>{r.removeEventListener("click",g)},100),this.updateImageSizeInMarkdown(r)};document.addEventListener("mousemove",a),document.addEventListener("mouseup",i)}updateSpanStyleInEditor(e,i,t){try{var a=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(a){var n=a.editor.cm,s=n.posAtDOM(e);if(null!==s){var r=n.state.doc.lineAt(s),o=r.text,l=o.match(/<span[^>]*>/);if(l){var c=o.indexOf(l[0]),h=c+l[0].length;let e=l[0];e=e.includes("style=")?e.replace(/style\s*=\s*["']([^"']*?)["']/i,(e,t)=>{let a=t.replace(/width\s*:\s*[^;]+;?\s*/gi,"");return(a=(a=a.replace(/height\s*:\s*[^;]+;?\s*/gi,"")).replace(/;\s*;/g,";").replace(/^\s*;\s*/,"").replace(/\s*;\s*$/,""))&&!a.endsWith(";")?a+="; ":a&&(a+=" "),`style="${a+=`width: ${i}px; `}"`}):e.replace(/^<span/,`<span style="width: ${i}px; "`),n.dispatch({changes:{from:r.from+c,to:r.from+h,insert:e}})}}}}catch(e){}}updateSidenoteImageWidthInEditor(e,t){try{var a=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(a){var i=a.editor.cm,n=i.posAtDOM(e);if(null!==n){var s=i.state.doc.lineAt(n),r=s.text,o=/<img([^>]*?)>/,l=r.match(o);if(l){var c=l[0],h=l[1];let e;e=h.includes("width=")?c.replace(/width\s*=\s*["']?\d+["']?/i,`width="${t}"`):c.replace(/<img/,`<img width="${t}"`);var d=r.indexOf(c),p=d+c.length;i.dispatch({changes:{from:s.from+d,to:s.from+p,insert:e}})}}}}catch(e){}}updateImageSizeInMarkdown(e){var t,a,i,n,s,r,o=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);o&&(o=o.editor.cm,t=e.offsetWidth,a=o.posAtDOM(e),a=o.state.doc.lineAt(a),i=e.src,r=e.alt||"",n=null!=e.closest("table"),s=null!=e.closest(".callout"),i&&i.startsWith("http")?this.updateExternalImageLink(o,a,i,r,t,n,s):(r=e.closest(".internal-embed")?.getAttribute("src")||i,this.updateInternalImageLink(o,a,r,t,n,s)))}updateExternalImageLink(e,t,a,i,n,s,r){r||s?this.updateImageInBlock(e,t,a,i,n,s,r,"external"):1===(r=this.matchLineWithExternalLink(t.text,a,i,n,s)).length&&e.dispatch({changes:{from:t.from+r[0].from_ch,to:t.from+r[0].to_ch,insert:r[0].new_link}})}updateInternalImageLink(e,t,a,i,n,s){s||n?this.updateImageInBlock(e,t,a,null,i,n,s,"internal"):1===(s=this.matchLineWithInternalLink(t.text,a,i,n)).length&&e.dispatch({changes:{from:t.from+s[0].from_ch,to:t.from+s[0].to_ch,insert:s[0].new_link}})}updateImageInBlock(t,a,i,n,s,r,e,o){var l,c=r?"table":"callout",h={table:/^\s*\|/,callout:/^>/}[c],a=a.number,d=[],p=[];for(let e=a;e<=t.state.doc.lines;e++){var u=t.state.doc.line(e);if(!h.test(u.text))break;u="external"===o?this.matchLineWithExternalLink(u.text,i,n,s,r):this.matchLineWithInternalLink(u.text,i,s,r);d.push(...u),p.push(...new Array(u.length).fill(e))}for(let e=a-1;1<=e;e--){var g=t.state.doc.line(e);if(!h.test(g.text))break;g="external"===o?this.matchLineWithExternalLink(g.text,i,n,s,r):this.matchLineWithInternalLink(g.text,i,s,r);d.push(...g),p.push(...new Array(g.length).fill(e))}1===d.length&&(a=t.state.doc.line(p[0]),"table"==c?(l=(c=a.text).substring(0,d[0].from_ch)+d[0].new_link+c.substring(d[0].to_ch),t.dispatch({changes:{from:a.from,to:a.from+c.length,insert:l}})):t.dispatch({changes:{from:a.from+d[0].from_ch,to:a.from+d[0].to_ch,insert:d[0].new_link}}))}matchLineWithExternalLink(e,t,a,i,n){for(var s,r=[],o=/!\[[^\[\]]*?\]\([^\s\)\(\[\]\{\}']*\)/g;null!==(s=o.exec(e));){var l=s[0];if(l.includes(t)){var c=l.match(/\[.*?\]/g),h=c[0].substring(1,c[0].length-1);let e=h.replace(/\|\d+(\|\d+)?$/g,"");n&&(e=h.replace(/\\\|\d+(\|\d+)?$/g,""));c=l.substring(c[0].length+2,l.length-1);let t=n?`![${e}\\|${i}](${c})`:`![${e}|${i}](${c})`;/^\d*$/.test(h)&&(t=`![${i}](${c})`),r.push({old_link:l,new_link:t,from_ch:s.index,to_ch:s.index+l.length})}}return r}matchLineWithInternalLink(e,t,a,i){var n=/!\[\[[^\[\]]*?\]\]/g,s=/!\[[^\[\]]*?\]\([^\s\)\(\[\]\{\}']*\)/g,r=t.replace(/ /g,"%20");if(!e.includes(t)&&!e.includes(r))return[];var o=[];let l;for(;null!==(l=n.exec(e));){var c=l[0];if(c.includes(t)){var h,d=(i?c.replace(/\\\|/g,"|"):c).match(/!\[\[(.*?)(\||\]\])/),p=d?d[1]:"",u=c.match(/!\[\[.*?(\|(.*?))\]\]/);let e="";for(h of(u?u[1]:"").split("|"))/^\d+$/.test(h)||/^\s*$/.test(h)||(e=e+"|"+h);u=0!=a?e+"|"+a:e,u=i?u.replace(/\|/g,"\\|"):u;o.push({old_link:c,new_link:d?`![[${p}${u}]]`:`![[${t}${u}]]`,from_ch:l.index,to_ch:l.index+c.length})}}for(;null!==(l=s.exec(e));){var g=l[0];if(g.includes(r)){var m=g.match(/\[.*?\]/g),f=m[0].substring(1,m[0].length-1);let e=f.replace(/\|\d+(\|\d+)?$/g,"");i&&(e=f.replace(/\\\|\d+(\|\d+)?$/g,""));m=g.substring(m[0].length+2,g.length-1);let t=i?`![${e}\\|${a}](${m})`:`![${e}|${a}](${m})`;/^\d*$/.test(f)&&(t=`![${a}](${m})`),o.push({old_link:g,new_link:t,from_ch:l.index,to_ch:l.index+g.length})}}return o}escapeRegex(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}findImageLinkAtCursor(e,t){var a=/!\[([^\]]*)\]\(([^)]+)\)/g,i=/!\[\[([^\]|]+)(\|\d+)?\]\]/g;let n;for(;null!==(n=a.exec(e));)if(t>=n.index&&t<=n.index+n[0].length)return{type:"markdown",full:n[0],alt:n[1],src:n[2],start:n.index,end:n.index+n[0].length};for(;null!==(n=i.exec(e));)if(t>=n.index&&t<=n.index+n[0].length)return{type:"wiki",full:n[0],filename:n[1],size:n[2],start:n.index,end:n.index+n[0].length};return null}isLocalImage(e){return"wiki"===e.type||"markdown"===e.type&&!(e=e.src).startsWith("http://")&&!e.startsWith("https://")}renameImage(t,a){var i="wiki"===t.type?t.filename:t.src,n=prompt("请输入新的文件名:",i);if(n&&n!==i){var i=a.getCursor(),s=a.getLine(i.line);let e;e="wiki"===t.type?s.replace(t.full,`![[${n}${t.size||""}]]`):s.replace(t.full,`![${t.alt}](${n})`),a.setLine(i.line,e)}}copyImageToClipboard(e){e=e.src;fetch(e).then(e=>e.blob()).then(e=>{navigator.clipboard.write([new ClipboardItem({[e.type]:e})])}).catch(()=>{})}copyImageLink(e){e=e.src;navigator.clipboard.writeText(e).then(()=>{})}openInBrowser(e){window.open(e.src,"_blank")}deleteImageLink(e,t){var a;confirm("确定要删除这个图片链接吗？")&&(a=t.getCursor(),e=t.getLine(a.line).replace(e.full,""),t.setLine(a.line,e))}onunload(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.fileCreateEventRef&&(this.app.vault.offref(this.fileCreateEventRef),this.fileCreateEventRef=null),document.querySelectorAll(".imagen-viewer").forEach(e=>e.remove()),document.querySelectorAll(".imagen-rename-modal").forEach(e=>e.remove())}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData())}async saveSettings(){await this.saveData(this.settings)}reinitializeFileCreateListener(){this.settings.imageRename.enabled&&!this.settings.objectStorage.enabled?this.fileCreateEventRef||(this.fileCreateEventRef=this.registerEvent(this.app.vault.on("create",this.handleFileCreate.bind(this)))):this.fileCreateEventRef&&(this.app.vault.offref(this.fileCreateEventRef),this.fileCreateEventRef=null)}addContextMenu(e,t,a){let i=t.getCursor();let n=t.getLine(i.line).match(/!\[\[([^\]]+\.(png|jpg|jpeg|gif|bmp|webp|svg))\]\]/i);n&&this.settings.objectStorage.enabled&&e.addItem(e=>{e.setTitle("上传到对象存储").setIcon("upload").onClick(async()=>{await this.convertImageLinkToExternal(t,i.line,n[1])})})}async convertImageLinkToExternal(e,t,a){try{var i,n,s,r,o,l,c,h,d,p;this.isPluginActivated&&(i=a.split("|")[0],n=this.app.vault.getAbstractFileByPath(i))&&n instanceof TFile&&(s=await this.app.vault.readBinary(n),r=Buffer.from(s),(o=await this.uploadToObjectStorage(r,n.name)).success)&&(l=e.getLine(t),c=`![${i.split("/").pop()}${a.includes("|")?"|"+a.split("|")[1]:""}](${o.url})`,h=a.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),d=new RegExp(`!\\[\\[${h}\\]\\]`,"g"),p=l.replace(d,c),e.setLine(t,p))}catch(e){console.error("转换图片链接失败:",e)}}registerDragEvents(){this.registerDomEvent(document,"dragover",this.handleDragOver.bind(this)),this.registerDomEvent(document,"dragenter",this.handleDragEnter.bind(this)),this.registerDomEvent(document,"dragleave",this.handleDragLeave.bind(this)),this.registerDomEvent(document,"drop",this.handleDrop.bind(this))}handleDragOver(e){e.dataTransfer&&e.dataTransfer.types.includes("Files")&&(e.preventDefault(),e.dataTransfer.dropEffect="copy")}handleDragEnter(e){e.dataTransfer&&e.dataTransfer.types.includes("Files")&&(e.preventDefault(),e=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView))&&(e=e.containerEl.querySelector(".cm-editor"))&&(e.style.backgroundColor="rgba(0, 123, 255, 0.1)",e.style.border="2px dashed #007bff")}handleDragLeave(e){var t=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);t&&(t=t.containerEl.querySelector(".cm-editor"))&&(t.style.backgroundColor="",t.style.border="")}async handleDrop(e){var t,a,i,n;this.isPluginActivated&&(t=this.settings.dragUpload&&this.settings.objectStorage.enabled,a=this.settings.imageRename.enabled&&!this.settings.objectStorage.enabled,t||a)&&((i=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView))&&(n=i.containerEl.querySelector(".cm-editor"))&&(n.style.backgroundColor="",n.style.border=""),n=e.dataTransfer?.files)&&0!==n.length&&0!==(n=Array.from(n).filter(e=>e.type.startsWith("image/"))).length&&(e.preventDefault(),e.stopPropagation(),t?await this.handleDragUploadToStorage(n,i):a&&await this.handleDragRenameLocal(n,i))}async handleDragUploadToStorage(c,e){let h=e?e.editor:null,d=h?h.getCursor():null;var i=await(async(e=2e3)=>{var t=Date.now();let a=[];for(;Date.now()-t<e&&h&&d;){var i=h.lineCount(),n=Math.max(0,d.line-10),s=Math.min(i-1,d.line+10);a=[];for(let e=n;e<=s;e++)for(var r,o=h.getLine(e),l=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]/g;null!==(r=l.exec(o));)a.push({fullMatch:r[0],lineNumber:e,startIndex:r.index,endIndex:r.index+r[0].length,isWikiLink:!0,path:r[1],displayName:r[1].split("/").pop(),sizeParam:r[2]||"",distanceFromCursor:Math.abs(e-d.line)});if(a.length>=c.length)break;await new Promise(e=>setTimeout(e,50))}return a.sort((e,t)=>e.lineNumber!==t.lineNumber?e.lineNumber-t.lineNumber:e.startIndex-t.startIndex),a})();i.forEach((e,t)=>{});for(let t=0;t<c.length;t++){var a=c[t];try{var n=Buffer.from(await a.arrayBuffer()),s=this.generateFileName(a.name),r=await this.uploadToObjectStorage(n,s);if(r.success&&h){var o,l,p=h.getCursor();h.getLine(p.line);let e=!1;if(t<i.length){var u=i[t],g=h.getLine(u.lineNumber),m=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]/,f=g.match(m);if(f){f[0];var v=f[1],y=f[2]||"",w=`![${v.split("/").pop()}${y}](${r.url})`,x=g.replace(m,w);if(h.setLine(u.lineNumber,x),this.settings.deleteSourceFile&&v)try{await this.deleteSourceFileByPath(v)}catch(e){}e=!0;for(let a=t+1;a<i.length;a++)if(i[a].lineNumber===u.lineNumber){for(var b,k=h.getLine(u.lineNumber),S=[],C=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]/g;null!==(b=C.exec(k));)S.push({fullMatch:b[0],startIndex:b.index,endIndex:b.index+b[0].length,path:b[1],displayName:b[1].split("/").pop(),sizeParam:b[2]||""});let t=0;for(let e=a;e<i.length&&i[e].lineNumber===u.lineNumber;e++)t<S.length&&(i[e].startIndex=S[t].startIndex,i[e].endIndex=S[t].endIndex,i[e].fullMatch=S[t].fullMatch,t++)}}}e||(o=`![${a.name}](${r.url})`,0===t?h.replaceSelection(o):(l=h.getCursor(),h.setCursor(l.line,h.getLine(l.line).length),h.replaceSelection("\n"+o)))}}catch(e){console.error("拖拽上传失败:",e)}}}async handleDragRenameLocal(n,e){let o=e?e.editor:null,l=o?o.getCursor():null,s=()=>{if(!o||!l)return[];var e=o.lineCount(),t=Math.max(0,l.line-10),a=Math.min(e-1,l.line+10),i=[];for(let e=t;e<=a;e++)for(var n,s=o.getLine(e),r=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]/g;null!==(n=r.exec(s));)i.push({fullMatch:n[0],lineNumber:e,startIndex:n.index,endIndex:n.index+n[0].length,isWikiLink:!0,path:n[1],displayName:n[1].split("/").pop(),sizeParam:n[2]||""});return i},r=s();var a=await(async(e=2e3)=>{var t=Date.now();let a=[];for(;Date.now()-t<e;){var i=s();if((a=i.filter(t=>!r.some(e=>e.lineNumber===t.lineNumber&&e.startIndex===t.startIndex&&e.path===t.path))).length>=n.length)break;await new Promise(e=>setTimeout(e,50))}return a.sort((e,t)=>e.lineNumber!==t.lineNumber?e.lineNumber-t.lineNumber:e.startIndex-t.startIndex),a})();for(let t=0;t<Math.min(n.length,a.length);t++){n[t];var i=a[t];try{var c=i.path;let a=this.app.vault.getAbstractFileByPath(c);if(!(a&&a instanceof TFile)){let t=c.split("/").pop();var h=this.app.vault.getFiles();a=h.find(e=>e.name===t)}if(a&&a instanceof TFile){var d=a.basename,p=a.extension;let e=d;this.settings.imageRename.prefix&&(e=this.settings.imageRename.prefix+d);var u,g,m,f,v,y=await this.createRenameDialog(e,p);y&&y!==d&&(u=this.generateUniqueFileName(y,p,a.parent),g="/"===a.parent.path?u+"."+p:a.parent.path+`/${u}.`+p,await this.app.vault.rename(a,g),o)&&(m=o.getLine(i.lineNumber),f=i.isWikiLink?`![[${g}${i.sizeParam}]]`:`![](${g})`,v=m.substring(0,i.startIndex)+f+m.substring(i.endIndex),o.setLine(i.lineNumber,v))}}catch(e){console.error(`重命名第 ${t+1} 个文件失败:`,e)}}n.length>a.length&&(n.length,a.length)}generateFileName(e){return e}generateUUID(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})}async deleteSourceFileByPath(a){try{let e=null;if(!(e=this.app.vault.getAbstractFileByPath(a))){let t=a.split("/").pop();var i=this.app.vault.getFiles();e=i.find(e=>e.name===t)}var t,n,s;return e||(t=this.app.workspace.getActiveFile())&&(s="/"===(n=t.parent.path)?a:n+"/"+a,e=this.app.vault.getAbstractFileByPath(s)),!!(e&&e instanceof require("obsidian").TFile)&&(await this.app.vault.delete(e),!0)}catch(e){throw e}}async handleFileCreate(t){var e;t instanceof TFile&&this.isImageFile(t)&&(!this.settings.imageRename.enabled||this.settings.objectStorage.enabled||(e=t.basename,!/^Pasted image \d{14}$/.test(e))||3e3<Date.now()-t.stat.ctime||setTimeout(async()=>{var e=this.app.vault.getAbstractFileByPath(t.path);e&&e instanceof TFile&&await this.showImageRenameDialog(e)},200))}isImageFile(e){e=e.extension.toLowerCase();return["png","jpg","jpeg","gif","bmp","webp","svg"].includes(e)}async showImageRenameDialog(t){try{let e=t.basename;var a,i=t.extension,n=t.path,s=(this.settings.imageRename.enabled&&this.settings.imageRename.prefix&&this.settings.imageRename.prefix.trim()&&(a=this.settings.imageRename.prefix.trim(),e=""+a),await this.createRenameDialog(e,i));if(s&&s!==e){var r=this.generateUniqueFileName(s,i,t.parent),o="/"===t.parent.path?r+"."+i:t.parent.path+`/${r}.`+i;await this.updateImageLinksInEditor(n,o);try{var l=this.app.vault.getAbstractFileByPath(n);l&&await this.app.vault.rename(l,o)}catch(e){await this.updateImageLinksInEditor(o,n)}}}catch(e){}}createRenameDialog(g,m){return new Promise(t=>{let a=document.createElement("div");a.className="imagen-rename-modal",a.style.cssText=`
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;var e=document.createElement("div"),i=(e.style.cssText=`
                background: var(--background-secondary-alt);
                border: 1px solid var(--background-modifier-border);
                border-radius: 8px;
                padding: 20px;
                min-width: 400px;
                max-width: 500px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            `,document.createElement("h3")),n=(i.textContent="重命名图片",i.style.cssText=`
                margin: 0 0 15px 0;
                color: var(--text-normal);
                font-size: 16px;
            `,document.createElement("div")),s=(n.style.cssText=`
                margin-bottom: 20px;
            `,document.createElement("label"));s.textContent="新文件名:",s.style.cssText=`
                display: block;
                margin-bottom: 8px;
                color: var(--text-normal);
                font-size: 14px;
            `;let r=document.createElement("input");r.type="text",r.value=g,r.style.cssText=`
                width: 100%;
                padding: 8px 12px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                color: var(--text-normal);
                font-size: 14px;
                box-sizing: border-box;
            `;var o=document.createElement("div"),l=(o.textContent="文件扩展名: ."+m,o.style.cssText=`
                margin-top: 5px;
                font-size: 12px;
                color: var(--text-muted);
            `,document.createElement("div")),c=(l.style.cssText=`
                display: flex;
                justify-content: flex-end;
                gap: 10px;
            `,document.createElement("button")),h=(c.textContent="取消",c.style.cssText=`
                padding: 8px 16px;
                border: 1px solid var(--background-modifier-border);
                border-radius: 4px;
                background: var(--background-primary);
                color: var(--text-normal);
                cursor: pointer;
                font-size: 14px;
            `,document.createElement("button"));h.textContent="确认",h.style.cssText=`
                padding: 8px 16px;
                border: 1px solid var(--interactive-accent);
                border-radius: 4px;
                background: var(--interactive-accent);
                color: var(--text-on-accent);
                cursor: pointer;
                font-size: 14px;
            `,n.appendChild(s),n.appendChild(r),n.appendChild(o),l.appendChild(c),l.appendChild(h),e.appendChild(i),e.appendChild(n),e.appendChild(l),a.appendChild(e),document.body.appendChild(a),r.focus(),r.select();let d=()=>{document.body.removeChild(a)},p=()=>{var e=r.value.trim();d(),t(e)},u=()=>{d(),t(null)};h.addEventListener("click",p),c.addEventListener("click",u),a.addEventListener("click",e=>{e.target===a&&u()}),r.addEventListener("keydown",e=>{"Enter"===e.key?(e.preventDefault(),p()):"Escape"===e.key&&(e.preventDefault(),u())})})}generateUniqueFileName(e,t,a){let i=e,n=1;for(;;){var s=a&&"/"!==a.path?`${a.path}/${i}.`+t:i+"."+t;if(!this.app.vault.getAbstractFileByPath(s))break;if(i=e+" "+n,1e3<++n){i=e+" "+Date.now();break}}return i}async updateImageLinksInEditor(t,n){try{var s=this.app.workspace.getActiveViewOfType(MarkdownView);if(s){var r=s.editor,o=r.getValue(),l=t.split("/").pop();let a=n.split("/").pop(),e=o,i=0;var c=new RegExp(`!\\[\\[${this.escapeRegex(l)}(\\|[^\\]]*)?\\]\\]`,"g"),h=(o.match(c)&&(e=e.replace(c,(e,t)=>(i++,`![[${a}${t||""}]]`))),new RegExp(`!\\[([^\\]]*)\\]\\(${this.escapeRegex(t)}\\)`,"g")),d=o.match(h);(e=d?e.replace(h,(e,t)=>(i++,`![${t}](${n})`)):e)!==o&&r.setValue(e)}}catch(e){}}async handlePaste(e){if(this.isPluginActivated&&this.settings.clipboardUpload&&this.settings.objectStorage.enabled){var t=e.clipboardData?.items;if(t)for(var a of t)if(a.type.startsWith("image/")){e.preventDefault();var n=a.getAsFile();if(n){var n=Buffer.from(await n.arrayBuffer()),a=`image_${Date.now()}.`+this.getFileExtension(a.type),s=await this.uploadToObjectStorage(n,a);if(s.success){n=this.app.workspace.getActiveViewOfType(require("obsidian").MarkdownView);if(n){var r,o=n.editor,l=o.getCursor(),c=o.getLine(l.line),h=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]|!\[([^\]]*)\]\(([^)]+)\)/g;let i=!1;for(;null!==(r=h.exec(c));){var d=r.index,p=r.index+r[0].length;if(l.ch>=d&&l.ch<=p){let e="",t="",a="";r[1]?(a=r[1],e=a.split("/").pop(),t=r[2]||""):void 0!==r[3]&&(e=r[3]||"");var u=`![${e}${t}](${s.url})`,p=c.substring(0,d)+u+c.substring(p),p=(o.setLine(l.line,p),d+u.length);if(o.setCursor(l.line,p),r[1]&&this.settings.deleteSourceFile&&a)try{await this.deleteSourceFileByPath(a)}catch(e){}i=!0;break}}i||o.replaceSelection(`![](${s.url})`)}}else new Notice("上传失败: "+s.error)}break}}}getFileExtension(e){return{"image/png":"png","image/jpeg":"jpg","image/gif":"gif","image/bmp":"bmp","image/webp":"webp","image/svg+xml":"svg"}[e]||"png"}async uploadToObjectStorage(t,a){var i=this.settings.objectStorage.provider;try{let e;if("tencent"===i)e=await this.uploadToTencentCOS(t,a);else{if("aliyun"!==i)throw new Error("不支持的存储提供商: "+i);e=await this.uploadToAliyunOSS(t,a)}return e}catch(e){return console.error("上传到对象存储失败:",e),{success:!1,error:e.message}}}async uploadToTencentCOS(e,t){var a=this.settings.objectStorage.tencent;if(!(a.secretId&&a.secretKey&&a.bucket&&a.region))throw new Error("腾讯云COS配置不完整");var i=encodeURIComponent(t),n=this.settings.objectStorage.pathPrefix||"images/",s=n+i,r=`https://${`${a.bucket}.cos.${a.region}.myqcloud.com`}/`+s,o=await this.generateTencentCOSAuth(a,"PUT",n+t);let l;for(let t=1;t<=3;t++)try{var c=await this.fetchWithXHR({url:r,method:"PUT",headers:{Authorization:o,"Content-Type":"application/octet-stream"},body:e,timeout:3e4});if(200<=c.status&&c.status<300)return{success:!0,url:a.customDomain?a.customDomain.replace(/\/$/,"")+"/"+s:r};throw new Error("上传失败: HTTP "+c.status)}catch(e){if(l=e,!this.isRetryableError(e)||3===t)throw console.error("腾讯云COS上传最终失败:",e),e;await this.retryDelay(t)}throw l}async uploadToAliyunOSS(e,t){var a=this.settings.objectStorage.aliyun;if(!(a.accessKeyId&&a.accessKeySecret&&a.bucket&&a.region))throw new Error("阿里云OSS配置不完整");var t=encodeURIComponent(t),i=(this.settings.objectStorage.pathPrefix||"images/")+t,n=`${a.bucket}.${a.region}.aliyuncs.com`,s="https://"+n;let r;for(let t=1;t<=3;t++)try{var o,l=await this.generateAliyunOSSPostPolicy(a,i),c=new FormData,h=(c.append("key",i),c.append("policy",l.policy),c.append("OSSAccessKeyId",a.accessKeyId),c.append("signature",l.signature),c.append("file",new Blob([e])),await Promise.race([fetch(s,{method:"POST",body:c}),new Promise((e,t)=>setTimeout(()=>t(new Error("Request timeout")),3e4))]));if(200<=h.status&&h.status<300)return{success:!0,url:a.customDomain?a.customDomain.replace(/\/$/,"")+"/"+i:`https://${n}/`+i};throw o=await h.text(),new Error(`上传失败: HTTP ${h.status} - `+o)}catch(e){if(r=e,!this.isRetryableError(e)||3===t)throw console.error("阿里云OSS上传最终失败:",e),e;await this.retryDelay(t)}throw r}async generateTencentCOSAuth(e,t,a){var i=Math.floor(Date.now()/1e3),i=i+";"+(i+3600),n=await this.hmacSha1(i,e.secretKey),t=""+t.toLowerCase()+`
/${a}

host=${e.bucket}.cos.${e.region}.myqcloud.com
`,a=`sha1
${i}
${await this.sha1(t)}
`,t=await this.hmacSha1(a,n);return`q-sign-algorithm=sha1&q-ak=${e.secretId}&q-sign-time=${i}&q-key-time=${i}&q-header-list=host&q-url-param-list=&q-signature=`+t}async generateAliyunOSSPostPolicy(e,t){t={expiration:new Date(Date.now()+36e5).toISOString(),conditions:[{bucket:e.bucket},["eq","$key",t],["content-length-range",0,104857600]]},t=this.utf8ToBase64(JSON.stringify(t));return{policy:t,signature:await this.hmacSha1(t,e.accessKeySecret,"base64")}}async hmacSha1(t,a,i="hex"){try{var e,n,s,r,o,l;return void 0!==crypto&&crypto.subtle?(n=(e=new TextEncoder).encode(a),s=e.encode(t),r=await crypto.subtle.importKey("raw",n,{name:"HMAC",hash:"SHA-1"},!1,["sign"]),o=await crypto.subtle.sign("HMAC",r,s),l=Array.from(new Uint8Array(o)),"base64"===i?btoa(String.fromCharCode.apply(null,l)):l.map(e=>e.toString(16).padStart(2,"0")).join("")):this.hmacSha1Fallback(t,a,i)}catch(e){return this.hmacSha1Fallback(t,a,i)}}async sha1(t){try{var e,a;return void 0!==crypto&&crypto.subtle?(e=(new TextEncoder).encode(t),a=await crypto.subtle.digest("SHA-1",e),Array.from(new Uint8Array(a)).map(e=>e.toString(16).padStart(2,"0")).join("")):this.sha1Fallback(t)}catch(e){return this.sha1Fallback(t)}}hmacSha1Fallback(e,t,a="hex"){var i=this.sha1Fallback;for(64<t.length&&(t=i(t));t.length<64;)t+="\0";let n="",s="";for(let e=0;e<64;e++){var r=t.charCodeAt(e);n+=String.fromCharCode(54^r),s+=String.fromCharCode(92^r)}e=i(n+e),i=i(s+this.hexToString(e));return"base64"===a?this.hexToBase64(i):i}sha1Fallback(t){var l=(e,t)=>e<<t|e>>>32-t,e=t=>{let a="";for(let e=7;0<=e;e--){var i=t>>>4*e&15;a+=i.toString(16)}return a},a=(t=unescape(encodeURIComponent(t))).length,c=[];for(let e=0;e<a-3;e+=4){var i=t.charCodeAt(e)<<24|t.charCodeAt(e+1)<<16|t.charCodeAt(e+2)<<8|t.charCodeAt(e+3);c.push(i)}switch(a%4){case 0:c.push(2147483648);break;case 1:c.push(t.charCodeAt(a-1)<<24|8388608);break;case 2:c.push(t.charCodeAt(a-2)<<24|t.charCodeAt(a-1)<<16|32768);break;case 3:c.push(t.charCodeAt(a-3)<<24|t.charCodeAt(a-2)<<16|t.charCodeAt(a-1)<<8|128)}for(;c.length%16!=14;)c.push(0);c.push(a>>>29),c.push(a<<3&4294967295);var h=new Array(80);let d=1732584193,p=4023233417,u=2562383102,g=271733878,m=3285377520;for(let t=0;t<c.length;t+=16){for(let e=0;e<16;e++)h[e]=c[t+e];for(let e=16;e<80;e++)h[e]=l(h[e-3]^h[e-8]^h[e-14]^h[e-16],1);let i=d,n=p,s=u,r=g,o=m;for(let a=0;a<80;a++){let e,t;t=a<20?(e=n&s|~n&r,1518500249):a<40?(e=n^s^r,1859775393):a<60?(e=n&s|n&r|s&r,2400959708):(e=n^s^r,3395469782);var f=l(i,5)+e+o+t+h[a]&4294967295;o=r,r=s,s=l(n,30),n=i,i=f}d=d+i&4294967295,p=p+n&4294967295,u=u+s&4294967295,g=g+r&4294967295,m=m+o&4294967295}return e(d)+e(p)+e(u)+e(g)+e(m)}hexToString(t){let a="";for(let e=0;e<t.length;e+=2)a+=String.fromCharCode(parseInt(t.substr(e,2),16));return a}hexToBase64(e){e=this.hexToString(e);return btoa(e)}utf8ToBase64(i){try{return btoa(unescape(encodeURIComponent(i)))}catch(e){var n="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";let t="",a=0;for(var s=unescape(encodeURIComponent(i));a<s.length;){var r=s.charCodeAt(a++)<<16|(a<s.length?s.charCodeAt(a++):0)<<8|(a<s.length?s.charCodeAt(a++):0);t=(t=(t=(t+=n.charAt(r>>18&63))+n.charAt(r>>12&63))+(a-2<s.length?n.charAt(r>>6&63):"="))+(a-1<s.length?n.charAt(63&r):"=")}return t}}async uploadAndConvertImageLink(i,n,e,s){try{var t,r,o;if(this.isPluginActivated)if(this.settings.objectStorage.enabled){let a=null;if(!((a=this.app.vault.getAbstractFileByPath(e))&&a instanceof TFile)){let t=e.split("/").pop();var l=this.app.vault.getFiles();a=l.find(e=>e.name===t)}if(a&&a instanceof TFile||(t=this.app.workspace.getActiveFile())&&(o="/"===(r=t.parent.path)?e:r+"/"+e,a=this.app.vault.getAbstractFileByPath(o)),a&&a instanceof TFile){var c=await this.app.vault.readBinary(a),h=Buffer.from(c),d=await this.uploadToObjectStorage(h,a.name);if(d.success){var p,u=i.getLine(n),g=/!\[\[([^\]|]+)(\|[^\]]+)?\]\]/,m=s.match(g);let e=a.name,t="";m&&(p=m[1].split("/").pop(),e=p,m[2])&&(t=m[2]);var f=`![${e}${t}](${d.url})`,v=u.replace(s,f);if(i.setLine(n,v),this.settings.deleteSourceFile)try{await this.app.vault.delete(a)}catch(e){}}}}else new Notice("对象存储功能未启用，请在设置中启用")}catch(e){}}convertImageToTextWrap(t,a,i,n,e,s){try{n.split(".").pop().toLowerCase();var r=n.split("/").pop(),o={"rounded-left":"image-mask-rounded","rounded-right":"image-mask-rounded-R","circle-left":"image-mask-circle","circle-right":"image-mask-circle-R"}[s];if(o){var l=this.settings&&this.settings.textWrap&&"number"==typeof this.settings.textWrap.roundedWidth?this.settings.textWrap.roundedWidth:200,c=this.settings&&this.settings.textWrap&&"number"==typeof this.settings.textWrap.circleSize?this.settings.textWrap.circleSize:200;let e;var h,d=`<span class="${o}" style="${e="rounded-left"===s||"rounded-right"===s?`width: ${l}px;`:`width: ${c}px;height: ${c}px;`}"><img src="${n}" alt="${r}" style="width: 100%; height: 100%; object-fit: cover;"></span> `,p=t.getLine(a).replace(i,d),u=(t.setLine(a,p),p.indexOf(d));-1!==u&&"function"==typeof t.setCursor&&(h=u+d.length,t.setCursor({line:a,ch:h}))}}catch(e){console.error("转换图片文字环绕时出错:",e),new Notice("转换失败，请检查图片链接格式")}}getMimeType(e){return{png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg",gif:"image/gif",webp:"image/webp",svg:"image/svg+xml"}[e.toLowerCase()]||"application/octet-stream"}isRetryableError(e){if(e.message.includes("Network error")||e.message.includes("Request timeout")||e.message.includes("timeout"))return!0;e=e.message.match(/HTTP (\d+)/);if(e){e=parseInt(e[1]);if(408===e||500<=e&&e<600)return!0;if(400<=e&&e<500);}return!1}async retryDelay(e){let t=[1e3,2e3,4e3][e-1]||4e3;return new Promise(e=>setTimeout(e,t))}fetchWithXHR(s){return new Promise((e,t)=>{let a=new XMLHttpRequest;var i=s.timeout||3e4;let n;a.open(s.method||"GET",s.url),s.headers&&Object.keys(s.headers).forEach(e=>{a.setRequestHeader(e,s.headers[e])}),n=setTimeout(()=>{a.abort(),t(new Error("Request timeout"))},i),a.onload=function(){clearTimeout(n),200<=a.status&&a.status<300?e({ok:!0,status:a.status,text:()=>Promise.resolve(a.responseText),json:()=>Promise.resolve(JSON.parse(a.responseText))}):t(new Error(`HTTP ${a.status}: `+a.statusText))},a.onerror=function(){clearTimeout(n),t(new Error("Network error"))},a.onabort=function(){clearTimeout(n),t(new Error("Request timeout"))},a.send(s.body||null)})}};class ImagenSettingTab extends require("obsidian").PluginSettingTab{constructor(e,t){super(e,t),this.plugin=t}display(){var e=this.containerEl;e.empty(),this.addObjectStorageSettings(e),this.addOtherSettings(e)}addObjectStorageSettings(e){e.createEl("h3",{text:"对象存储设置"}),new Setting(e).setName("启用对象存储").setDesc("启用后可以将图片上传到对象存储服务").addToggle(e=>e.setValue(this.plugin.settings.objectStorage.enabled).onChange(async e=>{this.plugin.settings.objectStorage.enabled=e,await this.plugin.saveSettings(),this.plugin.reinitializeFileCreateListener(),this.display()})),this.plugin.settings.objectStorage.enabled&&(new Setting(e).setName("存储提供商").setDesc("选择对象存储服务提供商").addDropdown(e=>e.addOption("tencent","腾讯云 COS").addOption("aliyun","阿里云 OSS").setValue(this.plugin.settings.objectStorage.provider).onChange(async e=>{this.plugin.settings.objectStorage.provider=e,await this.plugin.saveSettings(),this.display()})),"tencent"===this.plugin.settings.objectStorage.provider?this.addTencentSettings(e):"aliyun"===this.plugin.settings.objectStorage.provider&&this.addAliyunSettings(e),this.addCommonStorageSettings(e),new Setting(e).setName("测试连接").setDesc("测试对象存储连接是否正常").addButton(e=>e.setButtonText("测试连接").setCta().onClick(async()=>{await this.testConnection()})))}addTencentSettings(e){e.createEl("h4",{text:"腾讯云 COS 配置"});let t=this.plugin.settings.objectStorage.tencent;new Setting(e).setName("SecretId").setDesc("腾讯云访问密钥 ID").addText(e=>e.setPlaceholder("请输入 SecretId").setValue(t.secretId).onChange(async e=>{t.secretId=e,await this.plugin.saveSettings()})),new Setting(e).setName("SecretKey").setDesc("腾讯云访问密钥").addText(e=>e.setPlaceholder("请输入 SecretKey").setValue(t.secretKey).onChange(async e=>{t.secretKey=e,await this.plugin.saveSettings()})),new Setting(e).setName("存储桶名称").setDesc("COS 存储桶名称").addText(e=>e.setPlaceholder("请输入存储桶名称").setValue(t.bucket).onChange(async e=>{t.bucket=e,await this.plugin.saveSettings()})),new Setting(e).setName("地域").setDesc("COS 存储桶所在地域").addText(e=>e.setPlaceholder("如：ap-beijing").setValue(t.region).onChange(async e=>{t.region=e,await this.plugin.saveSettings()})),new Setting(e).setName("自定义域名").setDesc("可选：使用自定义域名访问文件").addText(e=>e.setPlaceholder("https://your-domain.com").setValue(t.customDomain||"").onChange(async e=>{t.customDomain=e,await this.plugin.saveSettings()}))}addAliyunSettings(e){e.createEl("h4",{text:"阿里云 OSS 配置"});let t=this.plugin.settings.objectStorage.aliyun;new Setting(e).setName("AccessKey ID").setDesc("阿里云访问密钥 ID").addText(e=>e.setPlaceholder("请输入 AccessKey ID").setValue(t.accessKeyId).onChange(async e=>{t.accessKeyId=e,await this.plugin.saveSettings()})),new Setting(e).setName("AccessKey Secret").setDesc("阿里云访问密钥").addText(e=>e.setPlaceholder("请输入 AccessKey Secret").setValue(t.accessKeySecret).onChange(async e=>{t.accessKeySecret=e,await this.plugin.saveSettings()})),new Setting(e).setName("存储桶名称").setDesc("OSS 存储桶名称").addText(e=>e.setPlaceholder("请输入存储桶名称").setValue(t.bucket).onChange(async e=>{t.bucket=e,await this.plugin.saveSettings()})),new Setting(e).setName("地域节点").setDesc("OSS 存储桶所在地域节点").addText(e=>e.setPlaceholder("如：oss-cn-hangzhou").setValue(t.region).onChange(async e=>{t.region=e,await this.plugin.saveSettings()})),new Setting(e).setName("自定义域名").setDesc("可选：使用自定义域名访问文件").addText(e=>e.setPlaceholder("https://your-domain.com").setValue(t.customDomain||"").onChange(async e=>{t.customDomain=e,await this.plugin.saveSettings()}))}addCommonStorageSettings(e){e.createEl("h4",{text:"通用设置"}),new Setting(e).setName("文件路径前缀").setDesc("上传文件的路径前缀，如：images/").addText(e=>e.setPlaceholder("images/").setValue(this.plugin.settings.objectStorage.pathPrefix).onChange(async e=>{this.plugin.settings.objectStorage.pathPrefix=e,await this.plugin.saveSettings()}))}addOtherSettings(e){e.createEl("h3",{text:"上传设置"}),new Setting(e).setName("启用剪贴板上传").setDesc("粘贴图片时自动上传到对象存储").addToggle(e=>e.setValue(this.plugin.settings.clipboardUpload).onChange(async e=>{this.plugin.settings.clipboardUpload=e,await this.plugin.saveSettings()})),new Setting(e).setName("启用拖拽上传").setDesc("拖拽图片文件到编辑器时自动上传到对象存储").addToggle(e=>e.setValue(this.plugin.settings.dragUpload).onChange(async e=>{this.plugin.settings.dragUpload=e,await this.plugin.saveSettings(),(e&&this.plugin.settings.objectStorage.enabled||this.plugin.settings.imageRename.enabled&&!this.plugin.settings.objectStorage.enabled)&&this.plugin.registerDragEvents()})),new Setting(e).setName("上传后删除源文件").setDesc("上传成功后自动删除本地图片文件（默认开启）").addToggle(e=>e.setValue(this.plugin.settings.deleteSourceFile).onChange(async e=>{this.plugin.settings.deleteSourceFile=e,await this.plugin.saveSettings()})),e.createEl("h3",{text:"图片文字环绕"}),new Setting(e).setName("圆角文字环绕宽度").setDesc("单位：像素，仅应用于圆角文字环绕（左右）").addText(e=>e.setPlaceholder("如：200").setValue(String(this.plugin.settings.textWrap.roundedWidth)).onChange(async e=>{e=parseInt(e,10);!isNaN(e)&&0<e&&(this.plugin.settings.textWrap.roundedWidth=e,await this.plugin.saveSettings())})),new Setting(e).setName("圆形文字环绕大小").setDesc("单位：像素，同时作为宽度和高度应用于圆形文字环绕（左右）").addText(e=>e.setPlaceholder("如：200").setValue(String(this.plugin.settings.textWrap.circleSize)).onChange(async e=>{e=parseInt(e,10);!isNaN(e)&&0<e&&(this.plugin.settings.textWrap.circleSize=e,await this.plugin.saveSettings())})),e.createEl("h3",{text:"图片交互"}),new Setting(e).setName("启用图片放大查看器").setDesc("点击图片【左半部分】查看大图").addToggle(e=>e.setValue(this.plugin.settings.attachFlow.imageViewer).onChange(async e=>{this.plugin.settings.attachFlow.imageViewer=e,await this.plugin.saveSettings()})),new Setting(e).setName("启用拖拽调整大小").setDesc("允许通过拖拽图片边缘来调整图片大小").addToggle(e=>e.setValue(this.plugin.settings.attachFlow.dragResize).onChange(async e=>{this.plugin.settings.attachFlow.dragResize=e,await this.plugin.saveSettings()})),e.createEl("h3",{text:"图片重命名"});var t;new Setting(e).setName("启用图片重命名功能").setDesc("当对象存储未启用时，粘贴或拖拽图片后自动弹出重命名对话框（注意：此功能仅在对象存储关闭时生效）").addToggle(e=>e.setValue(this.plugin.settings.imageRename.enabled).onChange(async e=>{this.plugin.settings.imageRename.enabled=e,await this.plugin.saveSettings(),this.plugin.reinitializeFileCreateListener(),(this.plugin.settings.dragUpload&&this.plugin.settings.objectStorage.enabled||e&&!this.plugin.settings.objectStorage.enabled)&&this.plugin.registerDragEvents(),e&&!this.plugin.settings.objectStorage.enabled||e&&this.plugin.settings.objectStorage.enabled&&new Notice("对象存储已启用，图片重命名功能将不会生效"),this.display()}));this.plugin.settings.imageRename.enabled&&new Setting(e).setName("重命名前缀").setDesc("为重命名的图片文件添加前缀，如：screenshot_、image_等").addText(e=>e.setPlaceholder("如：screenshot_").setValue(this.plugin.settings.imageRename.prefix).onChange(async e=>{this.plugin.settings.imageRename.prefix=e,await this.plugin.saveSettings()})),this.plugin.settings.objectStorage.enabled?((t=e.createEl("div",{text:"⚠️ 当前对象存储已启用，图片重命名功能将不会生效",cls:"setting-item-description"})).style.color="var(--text-warning)",t.style.fontStyle="italic",t.style.marginTop="8px"):this.plugin.settings.imageRename.enabled&&((t=e.createEl("div",{text:"✅ 图片重命名功能已启用，粘贴或拖拽图片时将自动弹出重命名对话框",cls:"setting-item-description"})).style.color="var(--text-success)",t.style.fontStyle="italic",t.style.marginTop="8px")}async testConnection(){var t=new Notice("正在测试连接...",0);try{if(!this.plugin.settings.objectStorage.enabled)throw new Error("对象存储功能未启用");var e=this.plugin.settings.objectStorage.provider;if("tencent"===e)await this.testTencentConnection();else{if("aliyun"!==e)throw new Error("不支持的存储提供商: "+e);await this.testAliyunConnection()}t.hide(),new Notice("连接测试成功！")}catch(e){t.hide(),console.error("连接测试失败:",e),new Notice("连接测试失败: "+e.message)}}async testTencentConnection(){var e=this.plugin.settings.objectStorage.tencent;if(!(e.secretId&&e.secretKey&&e.bucket&&e.region))throw new Error("腾讯云COS配置不完整，请检查SecretId、SecretKey、存储桶名称和地域配置");if(e.secretId.length<10)throw new Error("SecretId格式不正确，长度过短");if(e.secretKey.length<10)throw new Error("SecretKey格式不正确，长度过短");if(!e.region.startsWith("ap-")&&!e.region.startsWith("na-")&&!e.region.startsWith("eu-"))throw new Error("地域格式不正确，应类似于 ap-beijing、na-siliconvalley 等");var t=`${e.bucket}.cos.${e.region}.myqcloud.com`,a=`https://${t}/`;try{var i=await this.plugin.generateTencentCOSAuth(e,"HEAD",""),n=await fetch(a,{method:"HEAD",headers:{Authorization:i,Host:t}});if(200!==n.status)throw 403===n.status?new Error("访问被拒绝，请检查SecretId、SecretKey是否正确，以及是否有存储桶访问权限"):404===n.status?new Error("存储桶不存在，请检查存储桶名称和地域是否正确"):new Error("连接失败: HTTP "+n.status)}catch(e){if(e.message.includes("Failed to fetch")||e.message.includes("Network error"))throw new Error("网络连接失败，请检查网络连接和地域配置是否正确");throw e}}async testAliyunConnection(){var e=this.plugin.settings.objectStorage.aliyun;if(!(e.accessKeyId&&e.accessKeySecret&&e.bucket&&e.region))throw new Error("阿里云OSS配置不完整，请检查AccessKeyId、AccessKeySecret、存储桶名称和地域节点配置");if(e.accessKeyId.length<10)throw new Error("AccessKeyId格式不正确，长度过短");if(e.accessKeySecret.length<10)throw new Error("AccessKeySecret格式不正确，长度过短");if(!e.region.startsWith("oss-"))throw new Error("地域节点格式不正确，应类似于 oss-cn-hangzhou、oss-cn-beijing 等");e=`https://${`${e.bucket}.${e.region}.aliyuncs.com`}/`;try{if("opaque"===(await fetch(e,{method:"HEAD",mode:"no-cors",cache:"no-cache"})).type)return}catch(e){}try{if("opaque"===(await fetch(e,{method:"GET",mode:"no-cors",cache:"no-cache"})).type)return}catch(e){}try{var t=await fetch(e,{method:"HEAD",cache:"no-cache"});if(200!==t.status)throw 403===t.status?new Error("访问被拒绝 (HTTP 403)。可能原因：\n1. AccessKeyId或AccessKeySecret不正确\n2. 存储桶访问权限不足\n3. 存储桶策略限制\n请检查OSS控制台中的访问密钥和存储桶权限设置"):404===t.status?new Error("存储桶不存在 (HTTP 404)。请检查：\n1. 存储桶名称是否正确\n2. 地域节点是否正确\n3. 存储桶是否已创建"):new Error(`连接失败: HTTP ${t.status} `+t.statusText)}catch(e){throw e.message.includes("CORS")||e.message.includes("Access-Control-Allow-Origin")?new Error("连接测试遇到跨域限制，但这不影响实际使用。\n如果上传功能正常，可以忽略此错误。\n如果上传失败，请检查：\n1. AccessKeyId和AccessKeySecret是否正确\n2. 存储桶权限设置\n3. 网络连接状态"):e.message.includes("Failed to fetch")||e.message.includes("Network error")||e.message.includes("net::ERR_FAILED")?new Error("网络连接失败。请检查：\n1. 网络连接是否正常\n2. 地域节点配置是否正确\n3. 防火墙或代理设置\n4. DNS解析是否正常"):e}}}Object.assign(module.exports.prototype,{startCloudFunctionListener(){this.networkInterceptorActive=!1},stopCloudFunctionListener(){this.networkInterceptorActive=!1},startCloudFunctionTimeout(){},clearCloudFunctionTimeout(){this.cloudFunctionTimeout&&(clearTimeout(this.cloudFunctionTimeout),this.cloudFunctionTimeout=null)},async checkContentProtectionStatus(){try{var e,t="obsidian-content-protection",a="plugins",i="settings",n="deviceId",s=this.app[a][a][t];if(s){if(!this.app[a].enabledPlugins.has(t))return!1;if(s[i])return!0===(e=s[i]).isActivated&&e[n]&&0<e[n].trim().length&&!0===e.hasBeenActivated}return await this.checkContentProtectionFile()}catch(e){return!1}},async checkContentProtectionFile(){try{var e,t,a="deviceId";return this.app.plugins.enabledPlugins.has("obsidian-content-protection")?(e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/data.json"),!0===(t=JSON.parse(e)).isActivated&&t[a]&&0<t[a].trim().length&&!0===t.hasBeenActivated):!1}catch(e){return!1}},async checkAndUpdateStatus(){var e=await this.checkContentProtectionStatus();!e&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):e&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())},disablePluginFeatures(){try{if(this.isPluginActivated=!1,this.stopCloudFunctionListener(),this.clearCloudFunctionTimeout(),this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null),this.securityCheckInterval&&(clearInterval(this.securityCheckInterval),this.securityCheckInterval=null),this.cleanupAttachFlowFeatures(),"function"==typeof this.onunload&&this.onunload(),this.app&&this.app.commands&&this.app.commands.commands){var e,t,a=[];for([e,t]of Object.entries(this.app.commands.commands))t.callback&&t.callback.toString().includes("Imagen")&&a.push(e);a.forEach(e=>{delete this.app.commands.commands[e]})}if(this.app&&this.app.setting&&this.app.setting.pluginTabs){var i=this.app.setting.pluginTabs;for(let e=i.length-1;0<=e;e--)if("imagen"===i[e].id){i.splice(e,1);break}}try{let e=this.app.plugins;e&&e.disablePlugin&&setTimeout(()=>{e.disablePlugin("imagen")},100)}catch(e){}}catch(e){}},showActivationRequired(){this.app.plugins.enabledPlugins.has("obsidian-content-protection")},performSecurityCheck(){try{var e,t,a,i;return this.isPluginActivated?(e="obsidian-content-protection",t="plugins",!!this.app[t].enabledPlugins.has(e)&&!(!(a=this.app[t][t][e])||!a.settings)&&!0===(i=a.settings).isActivated&&i.deviceId&&0<i.deviceId.trim().length&&!0===i.hasBeenActivated):!1}catch(e){return!1}}});