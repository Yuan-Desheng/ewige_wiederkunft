let{Plugin,Setting,PluginSettingTab,Modal,Notice,ItemView,WorkspaceLeaf}=require("obsidian"),http=require("http"),https=require("https"),URL=require("url").URL,shell=require("electron").shell,querystring=require("querystring"),crypto=require("crypto");function debounce(e,i){let a;return function(...t){a&&clearTimeout(a),a=setTimeout(()=>{e.apply(this,t)},i)}}function createDebouncedFunction(e,i){let a;function t(...t){a&&clearTimeout(a),a=setTimeout(()=>{e.apply(this,t)},i)}return t.cleanup=function(){a&&(clearTimeout(a),a=null)},t}function compareVersions(t,e){if(!t||!e)return 0;try{for(var i=t.split(".").map(t=>parseInt(t,10)||0),a=e.split(".").map(t=>parseInt(t,10)||0);i.length<3;)i.push(0);for(;a.length<3;)a.push(0);for(let t=0;t<3;t++){if(i[t]<a[t])return-1;if(i[t]>a[t])return 1}return 0}catch(t){return 0}}function generateSecureHash(t,e=null){try{e=e||`cp_salt_${Math.floor(Date.now()/864e5)}_security`;var i=crypto.createHash("sha256");return i.update(e+t+e),i.digest("hex")}catch(t){return null}}function generatePluginFingerprint(t,e){try{var i={id:t.id||CP_PLUGIN_ID,version:t.version,author:t.author,name:t.name,path:e.replace(/\\/g,"/"),minAppVersion:t.minAppVersion};return generateSecureHash(JSON.stringify(i,Object.keys(i).sort()))}catch(t){return null}}function decodeBase64(t){if(t&&"string"==typeof t){try{if("function"==typeof atob)return atob(t)}catch(t){}if("undefined"!=typeof Buffer&&"function"==typeof Buffer.from)try{return Buffer.from(t,"base64").toString("utf8")}catch(t){}}return""}let ENCODED_CP_PLUGIN_ID="b2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u",CP_PLUGIN_ID=decodeBase64(ENCODED_CP_PLUGIN_ID),ENCODED_CP_PLUGIN_DIR="Lm9ic2lkaWFuL3BsdWdpbnMvb2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u",CP_PLUGIN_DIR=decodeBase64(ENCODED_CP_PLUGIN_DIR);function validatePluginIntegrity(t,e){try{var i,a,s,n;return generatePluginFingerprint(t,e)?(i=decodeBase64("b2JzaWRpYW4tY29udGVudC1wcm90ZWN0aW9u"),a=decodeBase64("eXRtYXBz"),s=decodeBase64("MS4zLjA="),t.id===i&&t.author===a&&0<=compareVersions(t.version,s)&&(n=generateSecureHash(JSON.stringify({id:i,author:a})),generateSecureHash(JSON.stringify({id:t.id,author:t.author}))===n)):!1}catch(t){return!1}}class RRuleParser{static calculateNextDueDate(t,e){if(!t||!e)return null;try{var i=this.parseRRule(t),a=new Date(e);switch(i.FREQ){case"DAILY":return this.calculateDailyNext(a,i);case"WEEKLY":return this.calculateWeeklyNext(a,i);case"MONTHLY":return this.calculateMonthlyNext(a,i);case"YEARLY":return this.calculateYearlyNext(a,i);default:return null}}catch(t){return null}}static parseRRule(t){var e,i={};for(e of(t.startsWith("RRULE:")?t.substring(6):t).split(";")){var[a,s]=e.split("=");a&&s&&(i[a]=s)}return i}static calculateDailyNext(t,e){e=parseInt(e.INTERVAL)||1,t=new Date(t);return t.setDate(t.getDate()+e),t.toISOString()}static calculateWeeklyNext(e,i){var a=parseInt(i.INTERVAL)||1,e=new Date(e);if(i.BYDAY){i={SU:0,MO:1,TU:2,WE:3,TH:4,FR:5,SA:6}[i.BYDAY.split(",")[0]];if(void 0!==i){let t=i-e.getDay();t<=0?t+=7*a:1<a&&(t+=7*(a-1)),e.setDate(e.getDate()+t)}else e.setDate(e.getDate()+7*a)}else e.setDate(e.getDate()+7*a);return e.toISOString()}static calculateMonthlyNext(t,e){var i=parseInt(e.INTERVAL)||1,t=new Date(t);return e.BYMONTHDAY?(e=parseInt(e.BYMONTHDAY),t.setMonth(t.getMonth()+i),t.setDate(e)):t.setMonth(t.getMonth()+i),t.toISOString()}static calculateYearlyNext(t,e){e=parseInt(e.INTERVAL)||1,t=new Date(t);return t.setFullYear(t.getFullYear()+e),t.toISOString()}static hasRepeatRule(t){return t.repeatFlag&&""!==t.repeatFlag.trim()}}function translateRepeatFlag(e){if(!e||""===e)return"";var i='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#858585" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat-icon lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>';try{var a,s=e.startsWith("RRULE:")?e.substring(6):e,n={};for(a of s.split(";")){var[r,l]=a.split("=");r&&l&&(n[r]=l)}var d=n.FREQ,o=parseInt(n.INTERVAL)||1;let t="";switch(d){case"DAILY":t=1===o?"æ¯å¤©":`æ¯${o}å¤©`;break;case"WEEKLY":var c=n.BYDAY;if(c){let e={SU:"å‘¨æ—¥",MO:"å‘¨ä¸€",TU:"å‘¨äºŒ",WE:"å‘¨ä¸‰",TH:"å‘¨å››",FR:"å‘¨äº”",SA:"å‘¨å…­"};var h=c.split(",").map(t=>e[t]||t).join("ã€");t=1===o?"æ¯å‘¨"+h:`æ¯${o}å‘¨çš„`+h}else t=1===o?"æ¯å‘¨":`æ¯${o}å‘¨`;break;case"MONTHLY":var u=n.BYMONTHDAY;t=u?1===o?`æ¯æœˆ${u}æ—¥`:`æ¯${o}ä¸ªæœˆçš„${u}æ—¥`:1===o?"æ¯æœˆ":`æ¯${o}ä¸ªæœˆ`;break;case"YEARLY":var p=n.BYMONTH,g=n.BYMONTHDAY;t=p&&g?1===o?`æ¯å¹´${p}æœˆ${g}æ—¥`:`æ¯${o}å¹´çš„${p}æœˆ${g}æ—¥`:1===o?"æ¯å¹´":`æ¯${o}å¹´`;break;default:t="é‡å¤"}return t+" "+i}catch(t){return"é‡å¤ "+i}}class RepeatTaskManager{constructor(t){this.plugin=t}async createRepeatTaskCopy(s){if(!RRuleParser.hasRepeatRule(s))return null;try{var n=RRuleParser.calculateNextDueDate(s.repeatFlag,s.dueDate);if(!n)return null;let e=null;var t=new Date(n);if(s.startDate&&s.dueDate)try{var r=new Date(s.startDate),l=new Date(s.dueDate),d=Math.max(0,l.getTime()-r.getTime()),o=new Date(t.getTime()-d);e=o.toISOString()}catch(t){e=n}else if(s.startDate)try{var c=new Date(s.startDate),h=s.dueDate?new Date(s.dueDate):c,u=c.getTime()-h.getTime(),p=new Date(t.getTime()+u);e=p.toISOString()}catch(t){e=n}else e=n;let i={...s,id:this.generateTaskId(),didaId:null,status:0,completedTime:null,dueDate:n,startDate:e,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),etag:null},a=(delete i.completedTime,i.status=0,this.plugin.settings.tasks.filter(t=>t.parentId===s.didaId));if(s.items&&0<s.items.length?i.items=s.items.map(t=>({...t,id:this.generateItemId(),status:0,completedTime:null})):i.items=[],0<a.length){this.plugin.settings.tasks.push(i),await this.plugin.saveSettings();for(var g of a){var m={...g,id:this.generateTaskId(),didaId:null,status:0,completedTime:null,parentId:null,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),etag:null};this.plugin.settings.tasks.push(m)}await this.plugin.saveSettings(),this.plugin.settings.accessToken&&setTimeout(async()=>{try{await this.plugin.createTaskInDidaList(i),setTimeout(async()=>{var t,e=this.plugin.settings.tasks.find(t=>t.id===i.id);if(e&&e.didaId){for(t of this.plugin.settings.tasks.filter(e=>a.some(t=>t.title===e.title&&null===e.parentId&&e.id!==i.id)))t.parentId=e.didaId,await this.plugin.createTaskInDidaList(t);await this.plugin.saveSettings(),this.plugin.refreshTaskView()}},500)}catch(t){}},100)}else this.plugin.settings.tasks.push(i),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&setTimeout(async()=>{try{await this.plugin.createTaskInDidaList(i),this.plugin.refreshTaskView()}catch(t){}},100);return i}catch(t){return null}}generateTaskId(){return Date.now().toString()+Math.random().toString(36).substr(2,9)}generateItemId(){return Math.random().toString(36).substr(2,24)}}class NativeTaskSyncManager{constructor(t){this.plugin=t,this.taskRegex=/^(\s*)-\s*\[([ x])\]\s*(.+?)(\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-zA-Z0-9]+)\))?$/gm,this.isOnline=navigator.onLine,this.setupNetworkListeners()}setupNetworkListeners(){window.addEventListener("online",()=>{this.isOnline=!0}),window.addEventListener("offline",()=>{this.isOnline=!1})}checkNetworkConnection(){return this.isOnline}getNetworkStatus(){return this.isOnline}detectNativeTasks(t,i){var a=[],s=t.split("\n");let n=!1,r="";for(let e=0;e<s.length;e++){var l=s[e],d=l.match(/^(\s*)```(\w*)/);if(d)r=n?(n=!1,""):(n=!0,d[2]||"unknown");else if(!n){if(l.includes("`")){d=l.match(/^(\s*)-\s*\[([ x])\]\s*(.+)$/);if(d)if(d[3].match(/^`[^`]*`$/))continue}d=l.match(/^(\s*)-\s*\[([ x])\]\s*(.*)$/);if(d){var[,d,o,c]=d,o="x"===o,h=c.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-zA-Z0-9]+)\)/),h=h?h[1]:null,u=!!h;let t=c.trim();t=t.replace(/\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-zA-Z0-9]+\)\s*/g,"").trim();var p,c=c.match(/ğŸ“…\s*(\d{4}-\d{2}-\d{2})/),c=c?c[1]:null,g=t=t.replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim();g&&0!==g.length&&(p=this.generateTaskId(i,e,g),a.push({id:p,title:g,isCompleted:o,didaId:h,filePath:i,lineNumber:e,originalLine:l,indent:d,hasLink:u,taskDate:c}))}}}return a}generateTaskId(t,e,i){return(t+`:${e}:`+i).replace(/[^a-zA-Z0-9]/g,"_")}}let DEFAULT_SETTINGS={clientId:"",clientSecret:"",accessToken:"",refreshToken:"",autoSync:!0,syncInterval:5,serverPort:8080,showArchivedProjects:!1,tasks:[],autoCleanCompletedTasks:!1,autoCleanInterval:1,enableNativeTaskSync:!0,projectCollapsedStates:{},projectOrder:[],defaultViewMode:"task",timeBlockHourHeight:80,timeBlockStartHour:0},OAUTH_CONFIG={authUrl:"https://dida365.com/oauth/authorize",tokenUrl:"https://dida365.com/oauth/token",scope:"tasks:write tasks:read"},TASK_VIEW_TYPE="dida-task-view",TIME_BLOCK_VIEW_TYPE="dida-time-block-view";class TaskView extends ItemView{constructor(t,e){super(t),this.plugin=e,this.searchQuery="",this.isComposing=!1,this.viewMode="task",this.debouncedSearch=debounce(t=>{this.searchQuery!==t&&(this.searchQuery=t,this.renderTaskList({preserveSearch:!0}))},300)}async checkPluginStatusAndNotify(){return this.plugin.checkPluginStatusAndNotify()}getViewType(){return TASK_VIEW_TYPE}getDisplayText(){return"æ»´ç­”ä»»åŠ¡æ¸…å•"}getIcon(){return"check-square"}renderTaskTitleContent(t,e){for(;t.firstChild;)t.removeChild(t.firstChild);var i,a=/\[\^([^\]]+)\]/g;let s=0;for(var n=(e,i)=>{if(i){var a,s=/#[^\s#]+/g;let t=0;for(;null!==(a=s.exec(i));){a.index>t&&e.appendChild(document.createTextNode(i.slice(t,a.index)));e.createSpan({cls:"dida-task-tag",text:a[0]});t=a.index+a[0].length}t<i.length&&e.appendChild(document.createTextNode(i.slice(t)))}};null!==(i=a.exec(e));)i.index>s&&n(t,e.slice(s,i.index)),t.createEl("sup",{cls:"dida-task-footnote"}).textContent=`[${i[1]}]`,s=i.index+i[0].length;s<e.length&&n(t,e.slice(s))}async onOpen(){var t=this.containerEl.children[1];t.empty(),t.addClass("dida-task-view"),this.viewMode=this.plugin.settings.defaultViewMode||"task",this.renderTaskList()}async renderTaskList(t={}){var l=this.containerEl.children[1];let d;if(t&&t.preserveSearch){t=l.querySelector(".dida-task-list");d=t&&t.parentElement===l?(t.empty(),t):(l.empty(),l.createDiv("dida-task-list"))}else{l.empty();var t=l.createDiv("dida-task-header"),e=(t.createEl("h3").innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-circle-check-big-icon lucide-circle-check-big"><path d="M21.801 10A10 10 0 1 1 17 3.335" stroke="#183f9bff"/><path d="m9 11 3 3L22 4" stroke="#ff9800"/></svg> æ»´ç­”ä»»åŠ¡æ¸…å•',t.createEl("button",{cls:"dida-timeline-btn dida-time-block-toggle-btn"})),e=("timeblock"===this.viewMode?(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks-icon lucide-list-checks"><path d="M11 6h10"/><path d="M11 12h10"/><path d="M11 18h10"/><path d="m3 6 1 1 2-2"/><path d="m3 12 1 1 2-2"/><path d="m3 18 1 1 2-2"/></svg>',e.title="åˆ‡æ¢åˆ°ä»»åŠ¡åˆ—è¡¨"):(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-align-start-vertical-icon lucide-align-start-vertical"><rect width="9" height="6" x="6" y="14" rx="2"/><rect width="16" height="6" x="6" y="4" rx="2"/><path d="M2 2v20"/></svg>',e.title="åˆ‡æ¢åˆ°æ—¶é—´æ®µè§†å›¾"),e.onclick=()=>{this.toggleViewMode()},t.createEl("button",{cls:"dida-timeline-btn"})),e=(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-icon lucide-calendar-check"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg>',e.onclick=()=>{this.plugin.showTimelineView()},t.createEl("button",{cls:"dida-sync-btn"}));if(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-refresh-cw-icon lucide-refresh-cw"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>',e.onclick=async()=>{this.plugin.isPluginActivated?this.plugin.safeManualSync():await this.checkPluginStatusAndNotify()},"task"===this.viewMode){let e=l.createDiv("dida-search-container"),i=(e.style.position="relative",e.createEl("input",{type:"text",cls:"dida-search-input",placeholder:"æœç´¢ä»»åŠ¡..."})),a=(i.value=this.searchQuery,e.createEl("button",{cls:"dida-search-clear-btn"})),s=(a.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',a.style.display=this.searchQuery?"flex":"none",e.createEl("button",{cls:"dida-date-clear-btn"})),n=(s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>',s.style.display=this.dateFilter?"flex":"none",e.createDiv("dida-date-filter-dropdown"));n.style.cssText=`
                    position: absolute;
                    top: 100%;
                    left: 0;
                    width: 100px;
                    background: var(--background-primary);
                    border: 1px solid var(--background-modifier-border);
                    border-radius: 4px;
                    margin-top: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    z-index: 1000;
                    display: none;
                `,[{label:"å·²é€¾æœŸ",value:"overdue"},{label:"ä»Šå¤©",value:"today"},{label:"è¿‘3å¤©",value:"next3days"},{label:"è¿‘7å¤©",value:"next7days"}].forEach(t=>{let e=n.createDiv("dida-date-filter-option");e.textContent=t.label,e.style.cssText=`
                        padding: 8px 12px;
                        cursor: pointer;
                        transition: background 0.2s;
                    `,e.addEventListener("mouseenter",()=>{e.style.background="var(--background-modifier-hover)"}),e.addEventListener("mouseleave",()=>{e.style.background=""}),e.addEventListener("click",()=>{this.dateFilter=t.value,i.placeholder="ç­›é€‰ï¼š"+t.label,n.style.display="none",s.style.display="flex",this.renderTaskList({preserveSearch:!0})})});let t=n.createDiv("dida-date-filter-option");t.textContent="æ¸…é™¤ç­›é€‰",t.style.cssText=`
                    padding: 8px 12px;
                    cursor: pointer;
                    border-top: 1px solid var(--background-modifier-border);
                    color: var(--text-muted);
                `,t.addEventListener("mouseenter",()=>{t.style.background="var(--background-modifier-hover)"}),t.addEventListener("mouseleave",()=>{t.style.background=""}),t.addEventListener("click",()=>{this.dateFilter=null,i.placeholder="æœç´¢ä»»åŠ¡...",n.style.display="none",s.style.display="none",this.renderTaskList({preserveSearch:!0})});let r=t=>{e.contains(t.target)||(n.style.display="none")};i.addEventListener("focus",()=>{n.style.display="block"}),setTimeout(()=>{document.addEventListener("click",r)},100),this.eventCleanupHandlers||(this.eventCleanupHandlers=[]),this.eventCleanupHandlers.push(()=>{document.removeEventListener("click",r)}),i.addEventListener("compositionstart",()=>{this.isComposing=!0}),i.addEventListener("compositionend",t=>{this.isComposing=!1;t=t.target.value;a.style.display=t?"flex":"none",this.debouncedSearch(t)}),i.addEventListener("input",t=>{t=t.target.value;a.style.display=t?"flex":"none",this.isComposing||(n.style.display="none",this.debouncedSearch(t))}),a.addEventListener("click",()=>{i.value="",this.searchQuery="",a.style.display="none",this.renderTaskList({preserveSearch:!0})}),s.addEventListener("click",()=>{this.dateFilter=null,i.placeholder="æœç´¢ä»»åŠ¡...",n.style.display="none",s.style.display="none",this.renderTaskList({preserveSearch:!0})})}d=l.createDiv("dida-task-list")}if("timeblock"===this.viewMode)this.renderTimeBlockView(d);else{try{if("undefined"!=typeof navigator&&navigator&&!1===navigator.onLine)return d.empty(),void d.createEl("p",{text:"ç¦»çº¿ä¸­ï¼šDida syncä¸å¯ç”¨",cls:"dida-empty-state"})}catch(t){}t=this.plugin.settings.tasks||[];if(0===t.length)d.createEl("p",{text:"æš‚æ— ä»»åŠ¡ï¼Œè¯·å…ˆæ·»åŠ ä¸€äº›ä»»åŠ¡",cls:"dida-empty-state"});else{let o=new Map,c=new Map,r=(t.forEach((i,a)=>{if(!i.parentId&&2!==i.status){i.content="string"==typeof i.content?i.content:i.content||"";let t="æœ¬åœ°ä»»åŠ¡",e="local";i.projectName&&i.projectId?(t=i.projectName,e=i.projectId):i.projectId?e="inbox"===i.projectId||i.projectId.includes("inbox")?(t="æ”¶é›†ç®±","inbox"):(t=i.projectId,i.projectId):i.projectName&&(t=i.projectName,e=i.projectId||"inbox");var s=!0===i.projectClosed;if(this.plugin.settings.showArchivedProjects||!s){if(this.dateFilter){var n=new Date,r=(n.setHours(0,0,0,0),i.startDate?new Date(i.startDate):null);r&&r.setHours(0,0,0,0);let t=!1;if("overdue"===this.dateFilter?t=r&&r<n:"today"===this.dateFilter?t=r&&r.getTime()===n.getTime():"next3days"===this.dateFilter?((l=new Date(n)).setDate(l.getDate()+2),t=r&&n<=r&&r<=l):"next7days"===this.dateFilter&&((l=new Date(n)).setDate(l.getDate()+6),t=r&&n<=r&&r<=l),!t)return}if(this.searchQuery&&this.searchQuery.trim()){var n=this.searchQuery.toLowerCase().trim(),r=(i.title||"").toLowerCase(),l=(i.content||"").toLowerCase(),d=t.toLowerCase();if(!r.includes(n)&&!l.includes(n)&&!d.includes(n))return}o.has(t)||(o.set(t,[]),c.set(t,{name:t,id:e,isArchived:s})),o.get(t).push({...i,originalIndex:a})}}}),this.plugin.settings.projectOrder||[]);for(let[s,n]of Array.from(o.entries()).sort(([t],[e])=>{var i=r.indexOf(t),a=r.indexOf(e);return-1!==i&&-1!==a?i-a:-1!==i?-1:-1!==a?1:"æ”¶é›†ç®±"===t?-1:"æ”¶é›†ç®±"===e||"æœ¬åœ°ä»»åŠ¡"===t?1:"æœ¬åœ°ä»»åŠ¡"===e?-1:t.localeCompare(e)})){let e=c.get(s)||{name:s,id:"inbox"},i=d.createDiv("dida-project-header"),t;t="æ”¶é›†ç®±"===s?'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#da1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-inbox-icon lucide-inbox"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11 2 12v6a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2v-6l-3.45-6.89A2 2 0 0 0 16.76 4H7.24a2 2 0 0 0-1.79 1.11z"/></svg>':'<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#da1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-list-checks-icon lucide-list-checks"><path d="M13 5h8"/><path d="M13 12h8"/><path d="M13 19h8"/><path d="m3 17 2 2 4-4"/><path d="m3 7 2 2 4-4"/></svg>';var h=i.createEl("h4",{cls:e.isArchived?"dida-project-title archived":"dida-project-title"}),u=e.isArchived?'<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-archive-icon lucide-archive" style="margin-left: 5px;"><rect width="20" height="5" x="2" y="3" rx="1"/><path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8"/><path d="M9 15h6"/></svg>':"";let a=this.plugin.settings.tasks.filter(t=>{if(t.parentId)return!1;let e="æœ¬åœ°ä»»åŠ¡";return t.projectName&&t.projectId?e=t.projectName:t.projectId?e="inbox"===t.projectId||t.projectId.includes("inbox")?"æ”¶é›†ç®±":t.projectId:t.projectName&&(e=t.projectName),e===s});var p=this.plugin.settings.tasks.filter(e=>e.parentId&&a.some(t=>t.didaId===e.parentId)).length,p=(n.length,0<p?`${s} (${n.length}+${p})`:`${s} (${n.length})`),p=(h.innerHTML=t+` <span>${p}</span>`+u,h.onclick=()=>this.toggleProjectCollapse(i,w,s),h.setAttribute("draggable","true"),h.setAttribute("data-project-name",s),h.addEventListener("dragstart",t=>{t.stopPropagation(),i.classList.add("dragging"),t.dataTransfer.effectAllowed="move",t.dataTransfer.setData("text/plain",s)}),h.addEventListener("dragend",t=>{t.stopPropagation(),i.classList.remove("dragging"),document.querySelectorAll(".dida-project-header").forEach(t=>{t.classList.remove("drag-over")})}),i.addEventListener("dragover",t=>{t.preventDefault(),t.stopPropagation(),t.dataTransfer.dropEffect="move";t=document.querySelector(".dragging");t&&t!==i&&i.classList.add("drag-over")}),i.addEventListener("dragleave",t=>{t.stopPropagation(),t.target===i&&i.classList.remove("drag-over")}),i.addEventListener("drop",t=>{t.preventDefault(),t.stopPropagation(),i.classList.remove("drag-over");t=t.dataTransfer.getData("text/plain");t&&t!==s&&this.reorderProjects(t,s)}),i.createEl("button",{cls:"dida-project-add-task-btn"}));p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',p.onclick=t=>this.showAddTaskModal(s,e.id,t.target);let w=d.createDiv("dida-project-tasks");u=this.searchQuery&&this.searchQuery.trim(),h=!!this.dateFilter;u||h||!this.plugin.settings.projectCollapsedStates[s]||(w.classList.add("collapsed"),i.classList.add("collapsed")),n.sort((t,e)=>{t=t.startDate||t.dueDate,e=e.startDate||e.dueDate;return t||e?t?e?new Date(t)-new Date(e):-1:1:0}).forEach(a=>{let t=w.createDiv("dida-task-item");t.setAttribute("data-task-id",a.id);var s,e=t.createDiv("dida-task-main-row"),i=e.createDiv("dida-task-left-content"),e=e.createDiv("dida-task-right-buttons"),n=i.createEl("input",{type:"checkbox"}),r=(n.checked=2===a.status,debounce(()=>{this.toggleTask(a.originalIndex)},200)),n=(n.onchange=r,i.createEl("span",{cls:2===a.status?"dida-task-completed dida-task-title-clickable":"dida-task-title dida-task-title-clickable"}));this.renderTaskTitleContent(n,a.title||""),n.onclick=()=>this.toggleTaskDetails(t,a);let l=null;a.repeatFlag&&""!==a.repeatFlag.trim()&&(r=translateRepeatFlag(a.repeatFlag))&&((l=document.createElement("div")).className="dida-task-repeat-rule",l.innerHTML=r,t.appendChild(l));{let i="";try{if(a.isAllDay)i="å…¨å¤©";else{var d,o=!!a.startDate,c=!!a.dueDate;if(o||c){let t="",e="";o&&(s=new Date(a.startDate),h=String(s.getHours()).padStart(2,"0"),u=String(s.getMinutes()).padStart(2,"0"),t=h+":"+u),c&&(v=new Date(a.dueDate),y=String(v.getHours()).padStart(2,"0"),d=String(v.getMinutes()).padStart(2,"0"),e=y+":"+d),t&&e?i=t+"ï½"+e:t?i=t:e&&(i=e)}}}catch(t){i=""}i&&((o=document.createElement("span")).className="dida-task-reminder-inline",o.style.display="inline-flex",o.style.alignItems="center",o.innerHTML=i+'<svg xmlns="http://www.w3.org/2000/svg" width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="#6b6b6b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-timer-icon lucide-timer"><line x1="10" x2="14" y1="2" y2="2"/><line x1="12" x2="15" y1="14" y2="11"/><circle cx="12" cy="14" r="8"/></svg>',l?l.appendChild(o):((s=document.createElement("div")).className="dida-task-repeat-rule",s.appendChild(o),t.appendChild(s)))}a.items&&0<a.items.length&&(i=a.items.filter(t=>1===t.status).length,(n=document.createElement("span")).className="dida-subtask-count",n.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" id="item-text" fill="#4c4f69">
  <path d="M30.06666612625122,7.625000095367431Q30.06666612625122,7.221142095367432,30.35223712625122,6.935571095367432Q30.637808126251223,6.650000095367432,31.041666126251222,6.650000095367432L40.95836612625122,6.650000095367432Q41.362166126251225,6.650000095367432,41.64776612625122,6.935571095367432Q41.93336612625122,7.221140095367431,41.93336612625122,7.625000095367431Q41.93336612625122,8.028860095367431,41.64776612625122,8.314430095367431Q41.362166126251225,8.600000095367431,40.95836612625122,8.600000095367431L31.041666126251222,8.600000095367431Q30.637808126251223,8.600000095367431,30.35223712625122,8.314430095367431Q30.06666612625122,8.028860095367431,30.06666612625122,7.625000095367431ZM32.98332612625122,12.000000095367431Q32.98332612625122,11.596140095367431,33.26889612625122,11.310570095367432Q33.554476126251224,11.025000095367432,33.95832612625122,11.025000095367432L40.95836612625122,11.025000095367432Q41.362166126251225,11.025000095367432,41.64776612625122,11.310570095367432Q41.93336612625122,11.596140095367431,41.93336612625122,12.000000095367431Q41.93336612625122,12.403860095367431,41.64776612625122,12.689430095367431Q41.362166126251225,12.975000095367431,40.95836612625122,12.975000095367431L37.45832612625122,12.975000095367431L33.95832612625122,12.975000095367431Q33.554476126251224,12.975000095367431,33.26889612625122,12.689430095367431Q32.98332612625122,12.403860095367431,32.98332612625122,12.000000095367431ZM32.98332612625122,16.375000095367433Q32.98332612625122,15.971140095367431,33.26889612625122,15.685570095367432Q33.55446612625122,15.400000095367432,33.95832612625122,15.400000095367432L40.95836612625122,15.400000095367432Q41.362166126251225,15.400000095367432,41.64776612625122,15.685570095367432Q41.93336612625122,15.971140095367431,41.93336612625122,16.375000095367433Q41.93336612625122,16.778900095367433,41.64776612625122,17.064400095367432Q41.362166126251225,17.35000009536743,40.95836612625122,17.35000009536743L33.95832612625122,17.35000009536743Q33.55446612625122,17.35000009536743,33.26889612625122,17.064400095367432Q32.98332612625122,16.778900095367433,32.98332612625122,16.375000095367433Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
  <path d="M46.5,18.5L46.5,5.5Q46.5,3.84314,45.3284,2.671573Q44.1569,1.5,42.5,1.5L29.5,1.5Q27.84315,1.5,26.671573,2.671573Q25.5,3.84315,25.5,5.5L25.5,18.5Q25.5,20.1569,26.671573,21.3284Q27.84314,22.5,29.5,22.5L42.5,22.5Q44.1569,22.5,45.3284,21.3284Q46.5,20.1569,46.5,18.5ZM44.5,5.5L44.5,18.5Q44.5,19.3284,43.9142,19.9142Q43.3284,20.5,42.5,20.5L29.5,20.5Q28.67157,20.5,28.08579,19.9142Q27.5,19.3284,27.5,18.5L27.5,5.5Q27.5,4.67157,28.08579,4.08579Q28.67157,3.5,29.5,3.5L42.5,3.5Q43.3284,3.5,43.9142,4.08579Q44.5,4.67157,44.5,5.5Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
</svg>${i}/`+a.items.length,n.style.fontSize="0.8em",n.style.color="#666",n.style.marginLeft="2px",n.style.display="flex",n.style.alignItems="center",n.style.gap="2px",n.style.cursor="pointer",n.title="ç‚¹å‡»æŸ¥çœ‹æ£€æŸ¥é¡¹",n.onclick=()=>this.toggleTaskDetails(t,a,"check-items-tab"),e.appendChild(n));var h,u,r=this.plugin.settings.tasks.filter(t=>t.parentId===a.didaId),c=(a.didaId&&0<r.length&&(r.filter(t=>2!==t.status),h=r.filter(t=>2===t.status).length,(u=document.createElement("span")).className="dida-child-task-count",u.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 12 12" id="descendant-task-small" fill="#4c4f69">
  <path d="M1.2500016689300537,1.491542L1.2500016689300537,8.31342C1.2500016689300537,9.3755,2.1029426689300537,10.25,3.1650316689300535,10.25L6.995881668930053,10.25C7.272021668930054,10.25,7.500001668930054,10.02614,7.500001668930054,9.75C7.500001668930054,9.47386,7.2761416689300535,9.25,7.000001668930054,9.25L3.204551668930054,9.25C2.677361668930054,9.25,2.2500016689300537,8.82264,2.2500016689300537,8.295449999999999L2.2500016689300537,4.75L7.000001668930054,4.75C7.2761416689300535,4.75,7.500001668930054,4.52614,7.500001668930054,4.25C7.500001668930054,3.97386,7.2761416689300535,3.75,7.000001668930054,3.75L2.2500016689300537,3.75L2.2500016689300537,1.5C2.2500016689300537,1.223858,2.026143668930054,1,1.7500016689300537,1C1.4738596689300536,1,1.2500016689300537,1.2154,1.2500016689300537,1.491542ZM10.750001668930054,4.25Q10.750001668930054,4.34849,10.730781668930053,4.44509Q10.711571668930054,4.54169,10.673881668930054,4.632680000000001Q10.636191668930053,4.72368,10.581471668930053,4.8055699999999995Q10.526751668930054,4.88746,10.457111668930054,4.95711Q10.387461668930055,5.02675,10.305571668930053,5.08147Q10.223681668930054,5.13619,10.132681668930054,5.17388Q10.041691668930053,5.21157,9.945091668930054,5.23078Q9.848491668930054,5.25,9.750001668930054,5.25Q9.651511668930054,5.25,9.554911668930053,5.23078Q9.458311668930055,5.21157,9.367321668930053,5.17388Q9.276321668930054,5.13619,9.194431668930054,5.08147Q9.112541668930053,5.02675,9.042891668930054,4.95711Q8.973251668930054,4.88746,8.918531668930054,4.8055699999999995Q8.863811668930055,4.72368,8.826121668930053,4.632680000000001Q8.788431668930054,4.54169,8.769211668930055,4.44509Q8.750001668930054,4.34849,8.750001668930054,4.25Q8.750001668930054,4.15151,8.769211668930055,4.05491Q8.788431668930054,3.95831,8.826121668930053,3.86732Q8.863811668930055,3.77632,8.918531668930054,3.69443Q8.973251668930054,3.61254,9.042891668930054,3.54289Q9.112541668930053,3.47325,9.194431668930054,3.41853Q9.276321668930054,3.36381,9.367321668930053,3.32612Q9.458311668930055,3.28843,9.554911668930053,3.26921Q9.651511668930054,3.25,9.750001668930054,3.25Q9.848491668930054,3.25,9.945091668930054,3.26921Q10.041691668930053,3.28843,10.132681668930054,3.32612Q10.223681668930054,3.36381,10.305571668930053,3.41853Q10.387461668930055,3.47325,10.457111668930054,3.54289Q10.526751668930054,3.61254,10.581471668930053,3.69443Q10.636191668930053,3.77632,10.673881668930054,3.86732Q10.711571668930054,3.95831,10.730781668930053,4.05491Q10.750001668930054,4.15151,10.750001668930054,4.25ZM10.750001668930054,9.75Q10.750001668930054,9.84849,10.730781668930053,9.94509Q10.711571668930054,10.04169,10.673881668930054,10.13268Q10.636191668930053,10.22368,10.581471668930053,10.30557Q10.526751668930054,10.38746,10.457111668930054,10.45711Q10.387461668930055,10.52675,10.305571668930053,10.58147Q10.223681668930054,10.63619,10.132681668930054,10.67388Q10.041691668930053,10.71157,9.945091668930054,10.73078Q9.848491668930054,10.75,9.750001668930054,10.75Q9.651511668930054,10.75,9.554911668930053,10.73078Q9.458311668930055,10.71157,9.367321668930053,10.67388Q9.276321668930054,10.63619,9.194431668930054,10.58147Q9.112541668930053,10.52675,9.042891668930054,10.45711Q8.973251668930054,10.38746,8.918531668930054,10.30557Q8.863811668930055,10.22368,8.826121668930053,10.13268Q8.788431668930054,10.04169,8.769211668930055,9.94509Q8.750001668930054,9.84849,8.750001668930054,9.75Q8.750001668930054,9.65151,8.769211668930055,9.55491Q8.788431668930054,9.45831,8.826121668930053,9.36732Q8.863811668930055,9.27632,8.918531668930054,9.19443Q8.973251668930054,9.11254,9.042891668930054,9.04289Q9.112541668930053,8.97325,9.194431668930054,8.91853Q9.276321668930054,8.86381,9.367321668930053,8.82612Q9.458311668930055,8.78843,9.554911668930053,8.769210000000001Q9.651511668930054,8.75,9.750001668930054,8.75Q9.848491668930054,8.75,9.945091668930054,8.769210000000001Q10.041691668930053,8.78843,10.132681668930054,8.82612Q10.223681668930054,8.86381,10.305571668930053,8.91853Q10.387461668930055,8.97325,10.457111668930054,9.04289Q10.526751668930054,9.11254,10.581471668930053,9.19443Q10.636191668930053,9.27632,10.673881668930054,9.36732Q10.711571668930054,9.45831,10.730781668930053,9.55491Q10.750001668930054,9.65151,10.750001668930054,9.75Z" fill-rule="evenodd"></path>
</svg>${h}/`+r.length,u.style.fontSize="0.8em",u.style.color="#0066cc",u.style.marginLeft="2px",u.style.display="flex",u.style.alignItems="center",u.style.gap="2px",u.style.cursor="pointer",u.title="ç‚¹å‡»æŸ¥çœ‹å­ä»»åŠ¡",u.onclick=()=>this.toggleTaskDetails(t,a,"subtasks-tab"),e.appendChild(u)),e.createEl("span",{cls:"dida-task-due-date"}));if(a.startDate)try{var p=new Date(a.startDate),g=p.getMonth()+1,m=p.getDate(),k=(c.textContent=g+"/"+m,new Date);k.setHours(0,0,0,0),p.setHours(0,0,0,0),p<k?c.classList.add("overdue"):p.getTime()===k.getTime()&&c.classList.add("today")}catch(t){c.textContent=""}else c.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#da1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-x2-icon lucide-calendar-x-2"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M3 10h18"/><path d="m17 22 5-5"/><path d="m17 17 5 5"/></svg>',c.classList.add("no-date");c.style.cursor="pointer",c.title="ç‚¹å‡»è®¾ç½®å¼€å§‹æ—¶é—´",c.onclick=t=>{t.stopPropagation(),new DatePickerModal(this.app,a.startDate,(t,e)=>{this.updateTaskStartDate(a.originalIndex,t,e)},t.currentTarget,this.plugin,a.originalIndex).open()};var v=e.createEl("button",{cls:"dida-task-delete"}),y=(v.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',v.onclick=t=>{t.stopPropagation(),t.preventDefault(),window.confirm("ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ")&&this.deleteTask(a.originalIndex)},e.createEl("span",{cls:a.didaId?"dida-sync-status synced":"dida-sync-status unsynced"}));a.didaId?y.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-check-icon lucide-cloud-check"><path d="m17 15-5.5 5.5L9 18"/><path d="M5 17.743A7 7 0 1 1 15.71 10h1.79a4.5 4.5 0 0 1 1.5 8.742"/></svg>':y.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-cloud-alert-icon lucide-cloud-alert"><path d="M12 12v4"/><path d="M12 20h.01"/><path d="M17 18h.5a1 1 0 0 0 0-9h-1.79A7 7 0 1 0 7 17.708"/></svg>'})}}}}showAddTaskModal(r="æ”¶é›†ç®±",l="inbox",t=null){t=t||document.querySelector(".dida-project-add-task-btn");if(t){var d=document.querySelector(".dida-add-task-popup");d&&d.remove();let e=document.createElement("div");e.className="dida-add-task-popup",e.innerHTML=`
            <h4>æ·»åŠ ä»»åŠ¡åˆ° ${r}</h4>
            <input type="text" placeholder="è¾“å…¥ä»»åŠ¡æ ‡é¢˜..." class="task-title-input" />
            <div class="button-container">
                <button class="cancel-btn">å–æ¶ˆ</button>
                <button class="submit-btn">æ·»åŠ </button>
            </div>
        `,document.body.appendChild(e);d=t.getBoundingClientRect();e.style.right=window.innerWidth-d.right+"px",e.style.top=d.bottom+8+"px",e.classList.add("show");let i=e.querySelector(".task-title-input");i.focus();t=e.querySelector(".submit-btn"),d=e.querySelector(".cancel-btn");let a=()=>{e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},200)},s=()=>{var t=i.value.trim();t&&(this.plugin.addTask(t,r,l,!0),this.renderTaskList(),a())},n=(t.addEventListener("click",s),d.addEventListener("click",a),i.addEventListener("keydown",t=>{"Enter"===t.key?(t.preventDefault(),s()):"Escape"===t.key&&(t.preventDefault(),a())}),t=>{e.contains(t.target)||(a(),document.removeEventListener("click",n))});setTimeout(()=>{document.addEventListener("click",n)},100)}}toggleTaskDetails(h,m,u="task-tab"){document.querySelectorAll(".dida-task-details").forEach(t=>{h.contains(t)||t.remove()});let k=h.querySelector(".dida-task-details");if(k)k.remove();else{k=h.createDiv("dida-task-details");let g=null;if(void 0!==m.originalIndex&&this.plugin.settings.tasks[m.originalIndex]?g=this.plugin.settings.tasks[m.originalIndex]:m.didaId?g=this.plugin.settings.tasks.find(t=>t.didaId===m.didaId):m.id&&(g=this.plugin.settings.tasks.find(t=>t.id===m.id)),g){g.content="string"==typeof g.content?g.content:g.content||"",g.desc="string"==typeof g.desc?g.desc:g.desc||"",g.items=g.items||[];let i=k.createDiv("dida-task-tab-nav");var v=i.createEl("button",{text:"ä»»åŠ¡",cls:"task-tab"===u?"dida-tab-btn active":"dida-tab-btn"}),y=i.createEl("button",{text:"æ£€æŸ¥é¡¹",cls:"check-items-tab"===u?"dida-tab-btn active":"dida-tab-btn"}),w=i.createEl("button",{text:"å­ä»»åŠ¡",cls:"subtasks-tab"===u?"dida-tab-btn active":"dida-tab-btn"});let a=k.createDiv("dida-task-content-area");var f=a.createDiv("task-tab"===u?"dida-tab-content active":"dida-tab-content"),T=(f.id="task-tab",f.createDiv("dida-task-detail-title"));T.style.display="flex",T.style.alignItems="center",T.createEl("strong",{text:"æ ‡é¢˜ï¼š"});let s=T.createEl("input",{type:"text",value:g.title,cls:"dida-task-title-input"});s.style.flex="1";T=f.createDiv("dida-task-detail-content");let n="content",t=g.content||"";"CHECKLIST"===g.kind?(n="desc",t=g.desc||"",T.createEl("strong",{text:"æè¿°å†…å®¹ï¼š"})):T.createEl("strong",{text:"å†…å®¹ï¼š"});let r=T.createEl("textarea",{cls:"dida-task-content-textarea"}),p=(r.placeholder="å†…å®¹...",r.value=t,a.createDiv("check-items-tab"===u?"dida-tab-content active":"dida-tab-content"));p.id="check-items-tab";g.items&&g.items.length,g.items&&g.items.filter(t=>1===t.status).length,p.createDiv("dida-check-items-list");g.items&&0<g.items.length&&g.items.forEach((o,c)=>{let e=p.createDiv("dida-task-item dida-check-item"),h=e.createEl("input",{type:"checkbox",checked:1===o.status}),u=(h.onchange=()=>{var t,e,i,a,s,n,r,l,d;o.status=h.checked?1:0,h.checked?(t=(d=new Date).getFullYear(),e=String(d.getMonth()+1).padStart(2,"0"),i=String(d.getDate()).padStart(2,"0"),a=String(d.getHours()).padStart(2,"0"),s=String(d.getMinutes()).padStart(2,"0"),n=String(d.getSeconds()).padStart(2,"0"),d=d.getTimezoneOffset(),r=Math.abs(Math.floor(d/60)),l=Math.abs(d%60),d=(d<=0?"+":"-")+String(r).padStart(2,"0")+String(l).padStart(2,"0"),o.completedTime=t+`-${e}-${i}T${a}:${s}:`+n+d):o.completedTime=null,this.updateSubtask(m.originalIndex,c,o),h.checked?(u.classList.remove("dida-task-title-input"),u.classList.add("dida-task-completed")):(u.classList.remove("dida-task-completed"),u.classList.add("dida-task-title-input"))},e.createEl("input",{type:"text",value:o.title,cls:1===o.status?"dida-task-completed":"dida-task-title-input",placeholder:"æ£€æŸ¥é¡¹æ ‡é¢˜"}));u.onchange=()=>{o.title=u.value,this.updateSubtask(m.originalIndex,c,o)};var t=e.createEl("button",{cls:"dida-task-delete"});t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',t.onclick=t=>{t.stopPropagation(),t.preventDefault(),g.items.splice(c,1),this.updateTaskSubtasksImmediate(m.originalIndex,g.items),e.remove()}});let e=p.createEl("button",{cls:"dida-project-add-task-btn"}),l=(e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',e.style.position="absolute",e.style.top="0",e.style.right="0",e.title="æ·»åŠ æ£€æŸ¥é¡¹",e.onclick=()=>{g.items||(g.items=[]);var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"",status:0,sortOrder:g.items.length},t=(g.items.push(t),this.updateTaskSubtasks(m.originalIndex,g.items),p.empty(),g.items.length,g.items.filter(t=>1===t.status).length,g.items.forEach((o,c)=>{let e=p.createDiv("dida-task-item dida-check-item"),h=e.createEl("input",{type:"checkbox",checked:1===o.status}),u=(h.onchange=()=>{o.status=h.checked?1:0,h.checked?(t=(l=new Date).getFullYear(),e=String(l.getMonth()+1).padStart(2,"0"),i=String(l.getDate()).padStart(2,"0"),a=String(l.getHours()).padStart(2,"0"),s=String(l.getMinutes()).padStart(2,"0"),n=String(l.getSeconds()).padStart(2,"0"),l=l.getTimezoneOffset(),d=Math.abs(Math.floor(l/60)),r=Math.abs(l%60),l=(l<=0?"+":"-")+String(d).padStart(2,"0")+String(r).padStart(2,"0"),o.completedTime=t+`-${e}-${i}T${a}:${s}:`+n+l):o.completedTime=null,this.updateSubtask(m.originalIndex,c,o),h.checked?(u.classList.remove("dida-task-title-input"),u.classList.add("dida-task-completed")):(u.classList.remove("dida-task-completed"),u.classList.add("dida-task-title-input"));var t,e,i,a,s,n,r,l,d=p.closest(".dida-task-item");d&&this.updateTaskRowSubtaskCount(d,g)},e.createEl("input",{type:"text",value:o.title,cls:1===o.status?"dida-task-completed":"dida-task-title-input",placeholder:"æ£€æŸ¥é¡¹æ ‡é¢˜"}));u.onchange=()=>{o.title=u.value,this.updateSubtask(m.originalIndex,c,o)};var t=e.createEl("button",{cls:"dida-task-delete"});t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-delete-icon lucide-delete"><path d="M10 5a2 2 0 0 0-1.344.519l-6.328 5.74a1 1 0 0 0 0 1.481l6.328 5.741A2 2 0 0 0 10 19h10a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2z"/><path d="m12 9 6 6"/><path d="m18 9-6 6"/></svg>',t.onclick=t=>{t.stopPropagation(),t.preventDefault(),g.items.splice(c,1),this.updateTaskSubtasksImmediate(m.originalIndex,g.items),e.remove();t=p.closest(".dida-task-item");t&&this.updateTaskRowSubtaskCount(t,g)}}),p.appendChild(e),e.style.position="absolute",e.style.top="0",e.style.right="0",p.closest(".dida-task-item"));t&&this.updateTaskRowSubtaskCount(t,g)},a.createDiv("subtasks-tab"===u?"dida-tab-content active":"dida-tab-content"));l.id="subtasks-tab";f=this.plugin.settings.tasks.filter(t=>t.parentId===g.didaId),T=f.filter(t=>!(2===t.status)),u=(f.filter(t=>2===t.status).length,T.forEach((i,t)=>{var e=l.createDiv("dida-task-item dida-subtask-item");let a=e.createEl("input",{type:"checkbox",checked:2===i.status}),s=(a.onchange=()=>{let t=-1;var e;-1!==(t=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&((e=this.plugin.settings.tasks[t]).status=a.checked?2:0,e.completed=a.checked,e.updatedAt=(new Date).toISOString(),a.checked?e.completedTime=(new Date).toISOString().replace(/\.\d{3}Z$/,"Z"):e.completedTime=null,this.plugin.saveSettings(),this.plugin.settings.accessToken&&e.didaId&&this.plugin.updateTaskInDidaList(e),a.checked?(s.classList.remove("dida-task-title-input"),s.classList.add("dida-task-completed")):(s.classList.remove("dida-task-completed"),s.classList.add("dida-task-title-input")),(e=l.closest(".dida-task-item"))&&this.updateTaskRowChildCount(e,g),a.checked)&&this.refreshSubtaskArea(l,g)},e.createEl("input",{type:"text",value:i.title,cls:2===i.status?"dida-task-completed":"dida-task-title-input",placeholder:"å­ä»»åŠ¡æ ‡é¢˜"}));s.onchange=()=>{let t=-1;-1!==(t=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.settings.tasks[t].title=s.value,this.plugin.settings.tasks[t].updatedAt=(new Date).toISOString(),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t]),this.plugin.refreshTaskView())};e=e.createEl("button",{cls:"dida-task-delete"});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',e.onclick=t=>{t.stopPropagation(),t.preventDefault();let e=-1;-1!==(e=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.deleteTask(e),t=l.closest(".dida-task-item"))&&this.updateTaskRowChildCount(t,g)}}),l.createEl("button",{cls:"dida-project-add-task-btn"}));u.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',u.style.position="absolute",u.style.top="0",u.style.right="0",u.title="æ·»åŠ å­ä»»åŠ¡",u.onclick=()=>{var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"æ–°å­ä»»åŠ¡",content:"",completed:!1,status:0,didaId:null,projectId:g.projectId,projectName:g.projectName,parentId:g.didaId||g.id,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[]},t=(this.plugin.settings.tasks.push(t),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.createTaskInDidaList(t),this.refreshSubtaskArea(l,g),l.closest(".dida-task-item"));t&&this.updateTaskRowChildCount(t,g)};let d=t=>{a.querySelectorAll(".dida-tab-content").forEach(t=>{t.classList.remove("active")}),i.querySelectorAll(".dida-tab-btn").forEach(t=>{t.classList.remove("active")});var e=a.querySelector("#"+t),e=(e&&e.classList.add("active"),i.querySelector(`[data-tab="${t}"]`));e&&e.classList.add("active")},o=(v.setAttribute("data-tab","task-tab"),y.setAttribute("data-tab","check-items-tab"),w.setAttribute("data-tab","subtasks-tab"),v.onclick=()=>{d("task-tab")},y.onclick=()=>{d("check-items-tab")},w.onclick=()=>{d("subtasks-tab")},k.createDiv("dida-task-button-container"));f=o.createEl("button",{text:"ä¿å­˜",cls:"dida-task-save-btn mod-cta"});g.didaId&&this.plugin.findFilesWithDidaId(g.didaId).then(a=>{if(0<a.length){let t,e;e=1===a.length?(s=a[0].basename.replace(".md",""),t="ğŸ”— "+s,"è·³è½¬åˆ° "+a[0].basename):(t=`ğŸ”— ${a.length}ä¸ªæ–‡ä»¶`,`è·³è½¬åˆ°åŒ…å« @@${g.didaId} çš„ç¬”è®°æ–‡ä»¶ (${a.length}ä¸ª)`);let i=o.createEl("button",{text:t,cls:"dida-task-jump-btn mod-warning",title:e});i.onclick=async()=>{await this.plugin.jumpToDidaIdInFile(g.didaId,i)};var s=o.createEl("button",{cls:"dida-task-delete-link-btn",title:"åˆ é™¤markdownæ–‡æ¡£ä¸­çš„ä»»åŠ¡é“¾æ¥"});s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',s.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ–‡ä»¶ä¸­çš„ä»»åŠ¡é“¾æ¥å—ï¼Ÿ")&&(await this.plugin.deleteDidaIdFromMarkdown(g.didaId),k.remove())}}}).catch(t=>{});let c=async()=>{await this.saveTaskDetails(m.originalIndex,s.value,r.value,n);var t=h.querySelector(".dida-task-main-row");t&&(t=t.querySelector(".dida-task-title, .dida-task-completed"))&&this.renderTaskTitleContent(t,s.value.trim());let e=null;void 0!==m.originalIndex&&this.plugin.settings.tasks[m.originalIndex]?e=this.plugin.settings.tasks[m.originalIndex]:m.didaId?e=this.plugin.settings.tasks.find(t=>t.didaId===m.didaId):m.id&&(e=this.plugin.settings.tasks.find(t=>t.id===m.id)),e?(this.updateTaskRowChildCount(h,e),this.updateTaskRowSubtaskCount(h,e),k.remove(),setTimeout(()=>{this.syncTaskToDidaListInBackground(e)},0)):k.remove()};f.onclick=c,s.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),c())}),r.addEventListener("keydown",t=>{"Enter"===t.key&&t.ctrlKey&&(t.preventDefault(),c())}),setTimeout(()=>s.focus(),100)}}}refreshSubtaskArea(n,r){n.empty();var t=this.plugin.settings.tasks.filter(t=>r.didaId?t.parentId===r.didaId:t.parentId===r.id),e=t.filter(t=>2!==t.status),t=(t.filter(t=>2===t.status).length,e.forEach((i,t)=>{var e=n.createDiv("dida-task-item dida-subtask-item");let a=e.createEl("input",{type:"checkbox",checked:2===i.status}),s=(a.onchange=()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);-1!==t&&(this.plugin.toggleTask(t),a.checked?(s.classList.remove("dida-task-title-input"),s.classList.add("dida-task-completed")):(s.classList.remove("dida-task-completed"),s.classList.add("dida-task-title-input")),(t=n.closest(".dida-task-item"))&&this.updateTaskRowChildCount(t,r),a.checked)&&this.refreshSubtaskArea(n,r)},e.createEl("input",{type:"text",value:i.title,cls:2===i.status?"dida-task-completed":"dida-task-title-input",placeholder:"å­ä»»åŠ¡æ ‡é¢˜"}));s.onchange=()=>{let t=-1;-1!==(t=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.settings.tasks[t].title=s.value,this.plugin.settings.tasks[t].updatedAt=(new Date).toISOString(),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t]),this.plugin.refreshTaskView())};e=e.createEl("button",{cls:"dida-task-delete"});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',e.onclick=t=>{t.stopPropagation(),t.preventDefault();let e=-1;-1!==(e=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.deleteTask(e),this.refreshSubtaskArea(n,r),t=n.closest(".dida-task-item"))&&this.updateTaskRowChildCount(t,r)}}),n.createEl("button",{cls:"dida-project-add-task-btn"}));t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',t.style.position="absolute",t.style.top="0",t.style.right="0",t.title="æ·»åŠ å­ä»»åŠ¡",t.onclick=()=>{var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"æ–°å­ä»»åŠ¡",content:"",completed:!1,status:0,didaId:null,projectId:r.projectId,projectName:r.projectName,parentId:r.didaId||r.id,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[]},t=(this.plugin.settings.tasks.push(t),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.createTaskInDidaList(t),this.refreshSubtaskArea(n,r),n.closest(".dida-task-item"));t&&this.updateTaskRowChildCount(t,r)}}updateTaskRowChildCount(e,i){var t,a,s=e.querySelector(".dida-child-task-count"),n=this.plugin.settings.tasks.filter(t=>i.didaId?t.parentId===i.didaId:t.parentId===i.id),r=(n.filter(t=>2!==t.status),n.filter(t=>2===t.status).length);0<n.length?s?(s.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 12 12" id="descendant-task-small" fill="#4c4f69">
  <path d="M1.2500016689300537,1.491542L1.2500016689300537,8.31342C1.2500016689300537,9.3755,2.1029426689300537,10.25,3.1650316689300535,10.25L6.995881668930053,10.25C7.272021668930054,10.25,7.500001668930054,10.02614,7.500001668930054,9.75C7.500001668930054,9.47386,7.2761416689300535,9.25,7.000001668930054,9.25L3.204551668930054,9.25C2.677361668930054,9.25,2.2500016689300537,8.82264,2.2500016689300537,8.295449999999999L2.2500016689300537,4.75L7.000001668930054,4.75C7.2761416689300535,4.75,7.500001668930054,4.52614,7.500001668930054,4.25C7.500001668930054,3.97386,7.2761416689300535,3.75,7.000001668930054,3.75L2.2500016689300537,3.75L2.2500016689300537,1.5C2.2500016689300537,1.223858,2.026143668930054,1,1.7500016689300537,1C1.4738596689300536,1,1.2500016689300537,1.2154,1.2500016689300537,1.491542ZM10.750001668930054,4.25Q10.750001668930054,4.34849,10.730781668930053,4.44509Q10.711571668930054,4.54169,10.673881668930054,4.632680000000001Q10.636191668930053,4.72368,10.581471668930053,4.8055699999999995Q10.526751668930054,4.88746,10.457111668930054,4.95711Q10.387461668930055,5.02675,10.305571668930053,5.08147Q10.223681668930054,5.13619,10.132681668930054,5.17388Q10.041691668930053,5.21157,9.945091668930054,5.23078Q9.848491668930054,5.25,9.750001668930054,5.25Q9.651511668930054,5.25,9.554911668930053,5.23078Q9.458311668930055,5.21157,9.367321668930053,5.17388Q9.276321668930054,5.13619,9.194431668930054,5.08147Q9.112541668930053,5.02675,9.042891668930054,4.95711Q8.973251668930054,4.88746,8.918531668930054,4.8055699999999995Q8.863811668930055,4.72368,8.826121668930053,4.632680000000001Q8.788431668930054,4.54169,8.769211668930055,4.44509Q8.750001668930054,4.34849,8.750001668930054,4.25Q8.750001668930054,4.15151,8.769211668930055,4.05491Q8.788431668930054,3.95831,8.826121668930053,3.86732Q8.863811668930055,3.77632,8.918531668930054,3.69443Q8.973251668930054,3.61254,9.042891668930054,3.54289Q9.112541668930053,3.47325,9.194431668930054,3.41853Q9.276321668930054,3.36381,9.367321668930053,3.32612Q9.458311668930055,3.28843,9.554911668930053,3.26921Q9.651511668930054,3.25,9.750001668930054,3.25Q9.848491668930054,3.25,9.945091668930054,3.26921Q10.041691668930053,3.28843,10.132681668930054,3.32612Q10.223681668930054,3.36381,10.305571668930053,3.41853Q10.387461668930055,3.47325,10.457111668930054,3.54289Q10.526751668930054,3.61254,10.581471668930053,3.69443Q10.636191668930053,3.77632,10.673881668930054,3.86732Q10.711571668930054,3.95831,10.730781668930053,4.05491Q10.750001668930054,4.15151,10.750001668930054,4.25ZM10.750001668930054,9.75Q10.750001668930054,9.84849,10.730781668930053,9.94509Q10.711571668930054,10.04169,10.673881668930054,10.13268Q10.636191668930053,10.22368,10.581471668930053,10.30557Q10.526751668930054,10.38746,10.457111668930054,10.45711Q10.387461668930055,10.52675,10.305571668930053,10.58147Q10.223681668930054,10.63619,10.132681668930054,10.67388Q10.041691668930053,10.71157,9.945091668930054,10.73078Q9.848491668930054,10.75,9.750001668930054,10.75Q9.651511668930054,10.75,9.554911668930053,10.73078Q9.458311668930055,10.71157,9.367321668930053,10.67388Q9.276321668930054,10.63619,9.194431668930054,10.58147Q9.112541668930053,10.52675,9.042891668930054,10.45711Q8.973251668930054,10.38746,8.918531668930054,10.30557Q8.863811668930055,10.22368,8.826121668930053,10.13268Q8.788431668930054,10.04169,8.769211668930055,9.94509Q8.750001668930054,9.84849,8.750001668930054,9.75Q8.750001668930054,9.65151,8.769211668930055,9.55491Q8.788431668930054,9.45831,8.826121668930053,9.36732Q8.863811668930055,9.27632,8.918531668930054,9.19443Q8.973251668930054,9.11254,9.042891668930054,9.04289Q9.112541668930053,8.97325,9.194431668930054,8.91853Q9.276321668930054,8.86381,9.367321668930053,8.82612Q9.458311668930055,8.78843,9.554911668930053,8.769210000000001Q9.651511668930054,8.75,9.750001668930054,8.75Q9.848491668930054,8.75,9.945091668930054,8.769210000000001Q10.041691668930053,8.78843,10.132681668930054,8.82612Q10.223681668930054,8.86381,10.305571668930053,8.91853Q10.387461668930055,8.97325,10.457111668930054,9.04289Q10.526751668930054,9.11254,10.581471668930053,9.19443Q10.636191668930053,9.27632,10.673881668930054,9.36732Q10.711571668930054,9.45831,10.730781668930053,9.55491Q10.750001668930054,9.65151,10.750001668930054,9.75Z" fill-rule="evenodd"></path>
</svg>${r}/`+n.length,s.style.cursor="pointer",s.title="ç‚¹å‡»æŸ¥çœ‹å­ä»»åŠ¡",s.onclick=()=>{let t=null;void 0!==i.originalIndex&&this.plugin.settings.tasks[i.originalIndex]?t=this.plugin.settings.tasks[i.originalIndex]:i.didaId?t=this.plugin.settings.tasks.find(t=>t.didaId===i.didaId):i.id&&(t=this.plugin.settings.tasks.find(t=>t.id===i.id)),t?this.toggleTaskDetails(e,t,"subtasks-tab"):this.toggleTaskDetails(e,i,"subtasks-tab")}):(e.querySelector(".dida-task-main-row"),(t=e.querySelector(".dida-task-right-buttons"))&&((a=document.createElement("span")).className="dida-child-task-count",a.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 12 12" id="descendant-task-small" fill="#4c4f69">
  <path d="M1.2500016689300537,1.491542L1.2500016689300537,8.31342C1.2500016689300537,9.3755,2.1029426689300537,10.25,3.1650316689300535,10.25L6.995881668930053,10.25C7.272021668930054,10.25,7.500001668930054,10.02614,7.500001668930054,9.75C7.500001668930054,9.47386,7.2761416689300535,9.25,7.000001668930054,9.25L3.204551668930054,9.25C2.677361668930054,9.25,2.2500016689300537,8.82264,2.2500016689300537,8.295449999999999L2.2500016689300537,4.75L7.000001668930054,4.75C7.2761416689300535,4.75,7.500001668930054,4.52614,7.500001668930054,4.25C7.500001668930054,3.97386,7.2761416689300535,3.75,7.000001668930054,3.75L2.2500016689300537,3.75L2.2500016689300537,1.5C2.2500016689300537,1.223858,2.026143668930054,1,1.7500016689300537,1C1.4738596689300536,1,1.2500016689300537,1.2154,1.2500016689300537,1.491542ZM10.750001668930054,4.25Q10.750001668930054,4.34849,10.730781668930053,4.44509Q10.711571668930054,4.54169,10.673881668930054,4.632680000000001Q10.636191668930053,4.72368,10.581471668930053,4.8055699999999995Q10.526751668930054,4.88746,10.457111668930054,4.95711Q10.387461668930055,5.02675,10.305571668930053,5.08147Q10.223681668930054,5.13619,10.132681668930054,5.17388Q10.041691668930053,5.21157,9.945091668930054,5.23078Q9.848491668930054,5.25,9.750001668930054,5.25Q9.651511668930054,5.25,9.554911668930053,5.23078Q9.458311668930055,5.21157,9.367321668930053,5.17388Q9.276321668930054,5.13619,9.194431668930054,5.08147Q9.112541668930053,5.02675,9.042891668930054,4.95711Q8.973251668930054,4.88746,8.918531668930054,4.8055699999999995Q8.863811668930055,4.72368,8.826121668930053,4.632680000000001Q8.788431668930054,4.54169,8.769211668930055,4.44509Q8.750001668930054,4.34849,8.750001668930054,4.25Q8.750001668930054,4.15151,8.769211668930055,4.05491Q8.788431668930054,3.95831,8.826121668930053,3.86732Q8.863811668930055,3.77632,8.918531668930054,3.69443Q8.973251668930054,3.61254,9.042891668930054,3.54289Q9.112541668930053,3.47325,9.194431668930054,3.41853Q9.276321668930054,3.36381,9.367321668930053,3.32612Q9.458311668930055,3.28843,9.554911668930053,3.26921Q9.651511668930054,3.25,9.750001668930054,3.25Q9.848491668930054,3.25,9.945091668930054,3.26921Q10.041691668930053,3.28843,10.132681668930054,3.32612Q10.223681668930054,3.36381,10.305571668930053,3.41853Q10.387461668930055,3.47325,10.457111668930054,3.54289Q10.526751668930054,3.61254,10.581471668930053,3.69443Q10.636191668930053,3.77632,10.673881668930054,3.86732Q10.711571668930054,3.95831,10.730781668930053,4.05491Q10.750001668930054,4.15151,10.750001668930054,4.25ZM10.750001668930054,9.75Q10.750001668930054,9.84849,10.730781668930053,9.94509Q10.711571668930054,10.04169,10.673881668930054,10.13268Q10.636191668930053,10.22368,10.581471668930053,10.30557Q10.526751668930054,10.38746,10.457111668930054,10.45711Q10.387461668930055,10.52675,10.305571668930053,10.58147Q10.223681668930054,10.63619,10.132681668930054,10.67388Q10.041691668930053,10.71157,9.945091668930054,10.73078Q9.848491668930054,10.75,9.750001668930054,10.75Q9.651511668930054,10.75,9.554911668930053,10.73078Q9.458311668930055,10.71157,9.367321668930053,10.67388Q9.276321668930054,10.63619,9.194431668930054,10.58147Q9.112541668930053,10.52675,9.042891668930054,10.45711Q8.973251668930054,10.38746,8.918531668930054,10.30557Q8.863811668930055,10.22368,8.826121668930053,10.13268Q8.788431668930054,10.04169,8.769211668930055,9.94509Q8.750001668930054,9.84849,8.750001668930054,9.75Q8.750001668930054,9.65151,8.769211668930055,9.55491Q8.788431668930054,9.45831,8.826121668930053,9.36732Q8.863811668930055,9.27632,8.918531668930054,9.19443Q8.973251668930054,9.11254,9.042891668930054,9.04289Q9.112541668930053,8.97325,9.194431668930054,8.91853Q9.276321668930054,8.86381,9.367321668930053,8.82612Q9.458311668930055,8.78843,9.554911668930053,8.769210000000001Q9.651511668930054,8.75,9.750001668930054,8.75Q9.848491668930054,8.75,9.945091668930054,8.769210000000001Q10.041691668930053,8.78843,10.132681668930054,8.82612Q10.223681668930054,8.86381,10.305571668930053,8.91853Q10.387461668930055,8.97325,10.457111668930054,9.04289Q10.526751668930054,9.11254,10.581471668930053,9.19443Q10.636191668930053,9.27632,10.673881668930054,9.36732Q10.711571668930054,9.45831,10.730781668930053,9.55491Q10.750001668930054,9.65151,10.750001668930054,9.75Z" fill-rule="evenodd"></path>
</svg>${r}/`+n.length,a.style.fontSize="0.8em",a.style.color="#0066cc",a.style.marginLeft="2px",a.style.display="flex",a.style.alignItems="center",a.style.gap="2px",a.style.cursor="pointer",a.title="ç‚¹å‡»æŸ¥çœ‹å­ä»»åŠ¡",(r=t.querySelector(".dida-subtask-count"))&&r.nextSibling?t.insertBefore(a,r.nextSibling):t.insertBefore(a,t.firstChild),a.onclick=()=>{let t=null;void 0!==i.originalIndex&&this.plugin.settings.tasks[i.originalIndex]?t=this.plugin.settings.tasks[i.originalIndex]:i.didaId?t=this.plugin.settings.tasks.find(t=>t.didaId===i.didaId):i.id&&(t=this.plugin.settings.tasks.find(t=>t.id===i.id)),t?this.toggleTaskDetails(e,t,"subtasks-tab"):this.toggleTaskDetails(e,i,"subtasks-tab")})):s&&s.remove()}updateTaskRowSubtaskCount(e,i){var t,a,s=e.querySelector(".dida-subtask-count"),n=i.items?i.items.filter(t=>1===t.status).length:0,r=i.items?i.items.length:0;i.items&&0<i.items.length?s?(s.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" id="item-text" fill="#4c4f69">
  <path d="M30.06666612625122,7.625000095367431Q30.06666612625122,7.221142095367432,30.35223712625122,6.935571095367432Q30.637808126251223,6.650000095367432,31.041666126251222,6.650000095367432L40.95836612625122,6.650000095367432Q41.362166126251225,6.650000095367432,41.64776612625122,6.935571095367432Q41.93336612625122,7.221140095367431,41.93336612625122,7.625000095367431Q41.93336612625122,8.028860095367431,41.64776612625122,8.314430095367431Q41.362166126251225,8.600000095367431,40.95836612625122,8.600000095367431L31.041666126251222,8.600000095367431Q30.637808126251223,8.600000095367431,30.35223712625122,8.314430095367431Q30.06666612625122,8.028860095367431,30.06666612625122,7.625000095367431ZM32.98332612625122,12.000000095367431Q32.98332612625122,11.596140095367431,33.26889612625122,11.310570095367432Q33.554476126251224,11.025000095367432,33.95832612625122,11.025000095367432L40.95836612625122,11.025000095367432Q41.362166126251225,11.025000095367432,41.64776612625122,11.310570095367432Q41.93336612625122,11.596140095367431,41.93336612625122,12.000000095367431Q41.93336612625122,12.403860095367431,41.64776612625122,12.689430095367431Q41.362166126251225,12.975000095367431,40.95836612625122,12.975000095367431L37.45832612625122,12.975000095367431L33.95832612625122,12.975000095367431Q33.554476126251224,12.975000095367431,33.26889612625122,12.689430095367431Q32.98332612625122,12.403860095367431,32.98332612625122,12.000000095367431ZM32.98332612625122,16.375000095367433Q32.98332612625122,15.971140095367431,33.26889612625122,15.685570095367432Q33.55446612625122,15.400000095367432,33.95832612625122,15.400000095367432L40.95836612625122,15.400000095367432Q41.362166126251225,15.400000095367432,41.64776612625122,15.685570095367432Q41.93336612625122,15.971140095367431,41.93336612625122,16.375000095367433Q41.93336612625122,16.778900095367433,41.64776612625122,17.064400095367432Q41.362166126251225,17.35000009536743,40.95836612625122,17.35000009536743L33.95832612625122,17.35000009536743Q33.55446612625122,17.35000009536743,33.26889612625122,17.064400095367432Q32.98332612625122,16.778900095367433,32.98332612625122,16.375000095367433Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
  <path d="M46.5,18.5L46.5,5.5Q46.5,3.84314,45.3284,2.671573Q44.1569,1.5,42.5,1.5L29.5,1.5Q27.84315,1.5,26.671573,2.671573Q25.5,3.84315,25.5,5.5L25.5,18.5Q25.5,20.1569,26.671573,21.3284Q27.84314,22.5,29.5,22.5L42.5,22.5Q44.1569,22.5,45.3284,21.3284Q46.5,20.1569,46.5,18.5ZM44.5,5.5L44.5,18.5Q44.5,19.3284,43.9142,19.9142Q43.3284,20.5,42.5,20.5L29.5,20.5Q28.67157,20.5,28.08579,19.9142Q27.5,19.3284,27.5,18.5L27.5,5.5Q27.5,4.67157,28.08579,4.08579Q28.67157,3.5,29.5,3.5L42.5,3.5Q43.3284,3.5,43.9142,4.08579Q44.5,4.67157,44.5,5.5Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
</svg>${n}/`+r,s.style.cursor="pointer",s.title="ç‚¹å‡»æŸ¥çœ‹æ£€æŸ¥é¡¹",s.onclick=()=>{let t=null;void 0!==i.originalIndex&&this.plugin.settings.tasks[i.originalIndex]?t=this.plugin.settings.tasks[i.originalIndex]:i.didaId?t=this.plugin.settings.tasks.find(t=>t.didaId===i.didaId):i.id&&(t=this.plugin.settings.tasks.find(t=>t.id===i.id)),t?this.toggleTaskDetails(e,t,"check-items-tab"):this.toggleTaskDetails(e,i,"check-items-tab")}):(t=e.querySelector(".dida-task-right-buttons"))&&((a=document.createElement("span")).className="dida-subtask-count",a.innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" id="item-text" fill="#4c4f69">
  <path d="M30.06666612625122,7.625000095367431Q30.06666612625122,7.221142095367432,30.35223712625122,6.935571095367432Q30.637808126251223,6.650000095367432,31.041666126251222,6.650000095367432L40.95836612625122,6.650000095367432Q41.362166126251225,6.650000095367432,41.64776612625122,6.935571095367432Q41.93336612625122,7.221140095367431,41.93336612625122,7.625000095367431Q41.93336612625122,8.028860095367431,41.64776612625122,8.314430095367431Q41.362166126251225,8.600000095367431,40.95836612625122,8.600000095367431L31.041666126251222,8.600000095367431Q30.637808126251223,8.600000095367431,30.35223712625122,8.314430095367431Q30.06666612625122,8.028860095367431,30.06666612625122,7.625000095367431ZM32.98332612625122,12.000000095367431Q32.98332612625122,11.596140095367431,33.26889612625122,11.310570095367432Q33.554476126251224,11.025000095367432,33.95832612625122,11.025000095367432L40.95836612625122,11.025000095367432Q41.362166126251225,11.025000095367432,41.64776612625122,11.310570095367432Q41.93336612625122,11.596140095367431,41.93336612625122,12.000000095367431Q41.93336612625122,12.403860095367431,41.64776612625122,12.689430095367431Q41.362166126251225,12.975000095367431,40.95836612625122,12.975000095367431L37.45832612625122,12.975000095367431L33.95832612625122,12.975000095367431Q33.554476126251224,12.975000095367431,33.26889612625122,12.689430095367431Q32.98332612625122,12.403860095367431,32.98332612625122,12.000000095367431ZM32.98332612625122,16.375000095367433Q32.98332612625122,15.971140095367431,33.26889612625122,15.685570095367432Q33.55446612625122,15.400000095367432,33.95832612625122,15.400000095367432L40.95836612625122,15.400000095367432Q41.362166126251225,15.400000095367432,41.64776612625122,15.685570095367432Q41.93336612625122,15.971140095367431,41.93336612625122,16.375000095367433Q41.93336612625122,16.778900095367433,41.64776612625122,17.064400095367432Q41.362166126251225,17.35000009536743,40.95836612625122,17.35000009536743L33.95832612625122,17.35000009536743Q33.55446612625122,17.35000009536743,33.26889612625122,17.064400095367432Q32.98332612625122,16.778900095367433,32.98332612625122,16.375000095367433Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
  <path d="M46.5,18.5L46.5,5.5Q46.5,3.84314,45.3284,2.671573Q44.1569,1.5,42.5,1.5L29.5,1.5Q27.84315,1.5,26.671573,2.671573Q25.5,3.84315,25.5,5.5L25.5,18.5Q25.5,20.1569,26.671573,21.3284Q27.84314,22.5,29.5,22.5L42.5,22.5Q44.1569,22.5,45.3284,21.3284Q46.5,20.1569,46.5,18.5ZM44.5,5.5L44.5,18.5Q44.5,19.3284,43.9142,19.9142Q43.3284,20.5,42.5,20.5L29.5,20.5Q28.67157,20.5,28.08579,19.9142Q27.5,19.3284,27.5,18.5L27.5,5.5Q27.5,4.67157,28.08579,4.08579Q28.67157,3.5,29.5,3.5L42.5,3.5Q43.3284,3.5,43.9142,4.08579Q44.5,4.67157,44.5,5.5Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
</svg>${n}/`+r,a.style.fontSize="0.8em",a.style.color="#666",a.style.marginLeft="2px",a.style.display="flex",a.style.alignItems="center",a.style.gap="2px",a.style.cursor="pointer",a.title="ç‚¹å‡»æŸ¥çœ‹æ£€æŸ¥é¡¹",t.insertBefore(a,t.firstChild),a.onclick=()=>{let t=null;void 0!==i.originalIndex&&this.plugin.settings.tasks[i.originalIndex]?t=this.plugin.settings.tasks[i.originalIndex]:i.didaId?t=this.plugin.settings.tasks.find(t=>t.didaId===i.didaId):i.id&&(t=this.plugin.settings.tasks.find(t=>t.id===i.id)),t?this.toggleTaskDetails(e,t,"check-items-tab"):this.toggleTaskDetails(e,i,"check-items-tab")}):s&&s.remove()}async updateTaskStartDate(t,d,o=!1){let e=this.plugin.settings.tasks[t];if(e){var c,t=e.startDate,i=e.dueDate;let l;if(d instanceof Date){let t,e,i,a,s,n,r;r=o?(u=new Date(d.getFullYear(),d.getMonth(),d.getDate(),0,0,0,0),t=u.getUTCFullYear(),e=String(u.getUTCMonth()+1).padStart(2,"0"),i=String(u.getUTCDate()).padStart(2,"0"),a=String(u.getUTCHours()).padStart(2,"0"),s=String(u.getUTCMinutes()).padStart(2,"0"),n=String(u.getUTCSeconds()).padStart(2,"0"),"+0000"):(t=d.getFullYear(),e=String(d.getMonth()+1).padStart(2,"0"),i=String(d.getDate()).padStart(2,"0"),a=String(d.getHours()).padStart(2,"0"),s=String(d.getMinutes()).padStart(2,"0"),n=String(d.getSeconds()).padStart(2,"0"),u=d.getTimezoneOffset(),h=Math.abs(Math.floor(u/60)),c=Math.abs(u%60),(u<=0?"+":"-")+String(h).padStart(2,"0")+String(c).padStart(2,"0")),l=`${t}-${e}-${i}T${a}:${s}:`+n+r}else l=d;var h,u=t!==l;e.startDate=l,!(e.isAllDay=o)&&e.dueDate||(e.dueDate=l),e.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),u&&e.didaId&&(h=e.dueDate||l,await this.updateNativeTaskDueDate(e,i,h)),this.renderTaskList(),this.plugin.settings.accessToken&&e.didaId&&setTimeout(async()=>{try{await this.plugin.updateTaskInDidaList(e)}catch(t){}},0)}}async updateTaskDueDate(e,i,a=!1){let s=this.plugin.settings.tasks[e];if(s){var n,r,l,d,o,c,h,u,e=s.dueDate;let t;var p=e!==(t=i instanceof Date?(p=i.getFullYear(),n=String(i.getMonth()+1).padStart(2,"0"),r=String(i.getDate()).padStart(2,"0"),l=String(i.getHours()).padStart(2,"0"),d=String(i.getMinutes()).padStart(2,"0"),o=String(i.getSeconds()).padStart(2,"0"),c=i.getTimezoneOffset(),h=Math.abs(Math.floor(c/60)),u=Math.abs(c%60),p+`-${n}-${r}T${l}:${d}:`+o+((c<=0?"+":"-")+String(h).padStart(2,"0")+String(u).padStart(2,"0"))):i);s.dueDate=t,s.isAllDay=a,s.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),p&&s.didaId&&await this.updateNativeTaskDueDate(s,e,t),this.renderTaskList(),this.plugin.settings.accessToken&&s.didaId&&setTimeout(async()=>{try{await this.plugin.updateTaskInDidaList(s)}catch(t){}},0)}}async saveTaskDetails(t,e,i,a="content"){var s,n,t=this.plugin.settings.tasks[t];t&&((e=e.trim())?(s=t.title!==e,n=t.title,t.title=e,t.items&&0<t.items.length?(t.content=i,t.desc=i):"desc"===a?t.desc=i:t.content=i,t.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),s&&t.didaId&&await this.updateNativeTaskTitle(t,n,e)):new Notice("ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º"))}async updateNativeTaskDueDate(i,t,a){try{var s;this.plugin._isUpdatingNativeTaskStatus=!0;for(s of this.plugin.app.vault.getMarkdownFiles())try{var n,r=(await this.plugin.app.vault.read(s)).split("\n");let e=!1;for(let t=0;t<r.length;t++){var l,d,o=r[t];o.includes(`[ğŸ”—Dida](obsidian://dida-task?didaId=${i.didaId})`)&&((l=this.convertDidaDateToNativeFormat(a))?(d=o.match(/ğŸ“…\s*(\d{4}-\d{2}-\d{2})/),e=(r[t]=d?o.replace(/ğŸ“…\s*\d{4}-\d{2}-\d{2}/,`ğŸ“… ${l} `):o+` ğŸ“… ${l} `,!0)):null==a&&o.match(/ğŸ“…\s*(\d{4}-\d{2}-\d{2})/)&&(r[t]=o.replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim(),e=!0))}e&&(n=r.join("\n"),await this.plugin.app.vault.modify(s,n))}catch(t){}}catch(t){}finally{this.plugin._isUpdatingNativeTaskStatus=!1}}convertDidaDateToNativeFormat(t){if(!t)return null;try{var e=new Date(t);return e.getFullYear()+`-${String(e.getMonth()+1).padStart(2,"0")}-`+String(e.getDate()).padStart(2,"0")}catch(t){return null}}async updateNativeTaskTitle(i,a,s){try{var t;this.plugin._isUpdatingNativeTaskStatus=!0;for(t of this.plugin.app.vault.getMarkdownFiles())try{var n,r=(await this.plugin.app.vault.read(t)).split("\n");let e=!1;for(let t=0;t<r.length;t++){var l,d,o,c,h,u,p=r[t];p.includes(`[ğŸ”—Dida](obsidian://dida-task?didaId=${i.didaId})`)&&(l=p.match(/^(\s*-\s*\[[ x]\]\s*)/))&&(d=l[1],c=(o=p.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-zA-Z0-9]+\)/))?" "+o[0]:"",u=(h=p.match(/ğŸ“…\s*\d{4}-\d{2}-\d{2}/))?" "+h[0]:"",p.replace(/^\s*-\s*\[[ x]\]\s*/,"").replace(/\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-zA-Z0-9]+\)\s*/g,"").replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim()===a.trim())&&(r[t]=""+d+s+c+u,e=!0)}e&&(n=r.join("\n"),await this.plugin.app.vault.modify(t,n))}catch(t){}}catch(t){}finally{this.plugin._isUpdatingNativeTaskStatus=!1}}async updateNativeTaskStatus(i,a){try{var t;this.plugin._isUpdatingNativeTaskStatus=!0;for(t of this.plugin.app.vault.getMarkdownFiles())try{var s,n=(await this.plugin.app.vault.read(t)).split("\n");let e=!1;for(let t=0;t<n.length;t++){var r,l,d,o,c,h=n[t];h.includes(`[ğŸ”—Dida](obsidian://dida-task?didaId=${i.didaId})`)&&(l=(r=h.match(/^(\s*)/))?r[1]:"",d=h.match(/^(\s*)-\s*\[[ x]\]\s*(.*)/))&&(o=d[2],c=a?l+"- [x] ":l+"- [ ] ",n[t]=c+o,e=!0)}e&&(s=n.join("\n"),await this.plugin.app.vault.modify(t,s))}catch(t){}}catch(t){}finally{this.plugin._isUpdatingNativeTaskStatus=!1}}async syncTaskToDidaListInBackground(t){if(this.plugin.settings.accessToken&&t.didaId)try{await this.plugin.updateTaskInDidaList(t)}catch(t){}}async updateSubtask(t,e,i){let a=this.plugin.settings.tasks[t];a&&a.items&&(a.items[e]=i,a.items&&0<a.items.length&&(a.content&&!a.desc?a.desc=a.content:a.desc&&!a.content&&(a.content=a.desc)),a.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),setTimeout(()=>{this.syncTaskToDidaListInBackground(a)},0))}async updateTaskSubtasks(t,e){let i=this.plugin.settings.tasks[t];i&&((i.items=e)&&0<e.length&&(i.content&&!i.desc?i.desc=i.content:i.desc&&!i.content&&(i.content=i.desc)),i.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),setTimeout(()=>{this.syncTaskToDidaListInBackground(i)},0))}async updateTaskSubtasksImmediate(t,e){t=this.plugin.settings.tasks[t];t&&((t.items=e)&&0<e.length&&(t.content&&!t.desc?t.desc=t.content:t.desc&&!t.content&&(t.content=t.desc)),t.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),await this.syncTaskToDidaListInBackground(t))}async toggleTask(t){await this.plugin.toggleTask(t),this.renderTaskList()}async deleteTask(t){await this.plugin.deleteTask(t)}toggleProjectCollapse(t,e,i){e.classList.contains("collapsed")?(e.classList.remove("collapsed"),t.classList.remove("collapsed"),this.plugin.settings.projectCollapsedStates[i]=!1):(e.classList.add("collapsed"),t.classList.add("collapsed"),this.plugin.settings.projectCollapsedStates[i]=!0),this.plugin.saveSettings()}async reorderProjects(t,e){let a=new Map,i=(this.plugin.settings.tasks.forEach(i=>{if(!i.parentId&&2!==i.status){let t="æœ¬åœ°ä»»åŠ¡",e="local";i.projectName&&i.projectId?(t=i.projectName,e=i.projectId):i.projectId?e="inbox"===i.projectId||i.projectId.includes("inbox")?(t="æ”¶é›†ç®±","inbox"):(t=i.projectId,i.projectId):i.projectName&&(t=i.projectName,e=i.projectId||"inbox"),!this.plugin.settings.showArchivedProjects&&!0===i.projectClosed||a.has(t)||a.set(t,!0)}}),Array.from(a.keys())),s=this.plugin.settings.projectOrder||[];i.forEach(t=>{s.includes(t)||s.push(t)});var n=(s=s.filter(t=>i.includes(t))).indexOf(t),r=s.indexOf(e);-1!==n&&-1!==r&&(s.splice(n,1),r=s.indexOf(e),s.splice(r,0,t)),this.plugin.settings.projectOrder=s,await this.plugin.saveSettings(),await this.renderTaskList()}toggleViewMode(){this.viewMode="task"===this.viewMode?"timeblock":"task",this.renderTaskList()}renderTimeBlockView(t){t.empty(),t.addClass("dida-time-block-view"),this.selectedDate||(this.selectedDate=new Date),this.renderTimeBlockDateSelector(t),this.renderTimeBlocks(t)}renderTimeBlockDateSelector(t){var t=t.createDiv("dida-time-block-date-selector"),i=new Date(this.selectedDate),e=(i.setHours(0,0,0,0),i.getDay()),e=0===e?-6:1-e,a=new Date(i),e=(a.setDate(i.getDate()+e),e=i,e=new Date(Date.UTC(e.getFullYear(),e.getMonth(),e.getDate())),n=e.getUTCDay()||7,e.setUTCDate(e.getUTCDate()+4-n),n=new Date(Date.UTC(e.getUTCFullYear(),0,1)),Math.ceil(((e-n)/864e5+1)/7)),s=["ä¸€","äºŒ","ä¸‰","å››","äº”","å…­","æ—¥"],n=t.createDiv("dida-time-block-month-header"),r=n.createDiv("dida-time-block-month-title"),l=(i.getMonth()+1).toString().padStart(1,"0"),l=(r.createEl("span",{text:l+"æœˆ",cls:"dida-time-block-month-text"}),r.createEl("span",{text:" "+i.getFullYear(),cls:"dida-time-block-year-text"}),r.createEl("span",{text:`  ç¬¬${e}å‘¨`,cls:"dida-time-block-week-number-text"}),n.createDiv("dida-time-block-month-controls"));l.createEl("button",{text:"â€¹",cls:"dida-timeline-nav-btn"}).onclick=()=>{this.selectedDate.setDate(this.selectedDate.getDate()-7),this.renderTaskList()},l.createEl("button",{text:"ä»Šå¤©",cls:"dida-timeline-expand-btn"}).onclick=()=>{this.selectedDate=new Date,this.renderTaskList()},l.createEl("button",{text:"â€º",cls:"dida-timeline-nav-btn"}).onclick=()=>{this.selectedDate.setDate(this.selectedDate.getDate()+7),this.renderTaskList()};var d=t.createDiv("dida-time-block-date-nav").createDiv("dida-time-block-week");for(let e=0;e<7;e++){let t=new Date(a);t.setDate(a.getDate()+e);var o=d.createDiv("dida-time-block-week-day");o.createDiv("dida-time-block-weekday").textContent=""+s[e];o.createDiv("dida-time-block-date").textContent=String(t.getDate());var c=this.getTasksForDate(t),h=c.length;if(0<h){let e=c.filter(t=>2===t.status||t.completedTime&&""!==String(t.completedTime).trim());var c=c.filter(t=>!e.includes(t)),u=e.length,c=c.length,p=o.createDiv("dida-timeline-task-count"),g=Math.min(h,10);if(10<h)p.createEl("span",{text:"+"+h,cls:"dida-timeline-task-more"}).title=h+" ä¸ªä»»åŠ¡";else{var m=Math.ceil(g/5),c=Math.min(c,g);let e=c,i=Math.min(u,Math.max(0,g-c));for(let t=0;t<m;t++){var k=p.createDiv("dida-timeline-task-dots-row"),v=5*t,y=Math.min(5+v,g);for(let t=v;t<y;t++){let t="dida-timeline-task-dot";0<e?e--:0<i&&(i--,t="dida-timeline-task-dot dida-timeline-task-dot-completed"),k.createEl("span",{text:"â€¢",cls:t})}}p.title=h+" ä¸ªä»»åŠ¡"}}t.getFullYear()===i.getFullYear()&&t.getMonth()===i.getMonth()&&t.getDate()===i.getDate()&&o.addClass("is-selected"),o.onclick=()=>{this.selectedDate=new Date(t),this.renderTaskList()}}}renderTimeBlocks(t){var t=t.createDiv("dida-time-block-container"),e=this.getTasksForDate(this.selectedDate),i=e.filter(t=>this.isAllDayTask(t)),a=e.filter(t=>!this.isAllDayTask(t));0<i.length&&this.renderAllDayBlocks(t,i),this.renderTimeGrid(t,a),0===e.length&&(t.createDiv("dida-timeline-empty-state").innerHTML="<p>ä»Šå¤©æ²¡æœ‰ä»»åŠ¡</p>")}renderAllDayBlocks(t,e){let d=t.createDiv("dida-time-block-all-day-section").createDiv("dida-time-block-all-day-grid");e.forEach(s=>{let i=d.createDiv("dida-time-block-item dida-time-block-all-day"),a=(i.setAttribute("data-task-id",s.id),i.createEl("input",{type:"checkbox"})),n=(a.checked=2===s.status,a.onchange=async()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===s.didaId);-1!==t&&(await this.plugin.toggleTask(t),this.renderTaskList())},i.createEl("span",{cls:2===s.status?"dida-task-completed":"dida-task-title"})),r=(this.renderTaskTitleContent(n,s.title||""),n.contentEditable="true",n.style.outline="none",n.style.cursor="text",n.style.wordBreak="break-word",s.title),l=(n.onfocus=()=>{r=n.textContent},n.onblur=async()=>{var t=n.textContent.trim();if(t){if(t!==r){var e=this.plugin.settings.tasks.findIndex(t=>s.didaId?t.didaId===s.didaId:t.id===s.id);if(-1!==e){var e=this.plugin.settings.tasks[e],i=e.title;if(e.title=t,e.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&e.didaId&&this.plugin.syncTaskToDidaListInBackground(e),e.didaId){var a=this.app.workspace.getLeavesOfType("dida-task-view");if(0<a.length&&a[0].view.updateNativeTaskTitle)try{await a[0].view.updateNativeTaskTitle(e,i,t)}catch(t){}}this.renderTaskList()}}}else n.textContent=r},n.onkeydown=t=>{"Enter"===t.key&&(t.preventDefault(),n.blur())},i.createEl("button",{cls:"dida-task-delete"}));l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',l.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${s.title}"å—ï¼Ÿ`)&&-1!==(t=this.plugin.settings.tasks.findIndex(t=>s.didaId?t.didaId===s.didaId:t.id===s.id))&&await this.plugin.deleteTask(t)},i.onclick=t=>{var e=t.target;if(e!==a&&e!==n&&e!==l&&!l.contains(e)){t.stopPropagation();let a=this.plugin.settings.tasks.findIndex(t=>s.didaId?t.didaId===s.didaId:t.id===s.id);-1!==a&&(e=s.startDate||s.dueDate||this.selectedDate,new DatePickerModal(this.app,e,async(t,e,i)=>{t&&(await this.updateTaskStartDate(a,t,e),i)&&!e&&await this.updateTaskDueDate(a,i,!1)},i,this.plugin,a).open())}}})}renderTimeGrid(e,t){let k=e.createDiv("dida-time-block-time-section").createDiv("dida-time-block-time-grid"),v=this.plugin.settings.timeBlockStartHour||0;for(let t=0;t<24;t++){var i=(v+t)%24,a=k.createDiv("dida-time-block-hour");a.createDiv("dida-time-block-hour-label").textContent=i.toString().padStart(2,"0")+":00",a.createDiv("dida-time-block-hour-line")}var e=new Date,s=new Date(this.selectedDate);if(e.setHours(0,0,0,0),s.setHours(0,0,0,0),e.getTime()===s.getTime()){e=new Date,s=e.getHours(),e=e.getMinutes();let t=60*(s-v)+e;t<0&&(t+=1440);s=t/1440*100;k.createDiv("dida-time-block-now-line").style.top=s+"%"}k.addEventListener("mousedown",e=>{if(!(0!==e.button||e.target&&e.target.closest(".dida-time-block-task"))){let g=k.getBoundingClientRect(),m=k.offsetHeight;if(m){let s=e.clientY;let t=50;var i=g.left+t;let n=e.clientX<i+(g.right-i)/2?0:1,o=!1,c=null,r=null,h=null,u=()=>{c&&c.parentElement&&c.parentElement.removeChild(c),c=null,r=null,h=null,o=!1},l=async()=>{if(o&&c&&h){var i=h.textContent.trim();if(i){var a=c.offsetTop/m*100,s=(a+c.offsetHeight/m*100)/100*24*60;let t=Math.round(a/100*24*60+60*v),e=Math.round(s+60*v);1440<=t&&(t-=1440),1440<=e&&(e-=1440),t<0&&(t=0),e<0&&(e=0);var a=Math.floor(t/60),s=t%60,n=Math.floor(e/60),r=e%60,l=new Date(this.selectedDate),d=(l.setHours(0,0,0,0),new Date(l)),a=(d.setHours(a,s,0,0),new Date(l)),s=(a.setHours(n,r,0,0),(new Date).toISOString()),l={id:Date.now().toString(),title:i,content:"",desc:"",completed:!1,status:0,didaId:null,projectId:"inbox",projectName:"æ”¶é›†ç®±",createdAt:s,updatedAt:s,items:[],dueDate:a.toISOString(),startDate:d.toISOString(),isAllDay:!1,repeatFlag:null,reminders:[],completedTime:null,projectViewMode:"list",projectKind:"TASK",parentId:null,kind:"TEXT"};this.plugin.settings.tasks=this.plugin.settings.tasks||[],this.plugin.settings.tasks.push(l),await this.plugin.saveSettings(),u(),this.renderTaskList(),this.plugin.settings.accessToken&&this.plugin.createTaskInDidaList(l).catch(t=>{})}else u()}else u()},d=e=>{var e=e.clientY,i=e-s;if((o||!(Math.abs(i)<5))&&(o||(o=!0,(c=k.createDiv("dida-time-block-task dida-time-block-temp")).style.position="absolute",c.setAttribute("data-column",String(n)),0===n?c.style.left=t+"px":c.style.left=`calc(50% + ${t/2}px + 2.5px)`,c.style.width=`calc(50% - ${t/2}px - 2.5px)`,c.style.top="0",c.style.height="0",c.style.backgroundColor="var(--interactive-accent-hover)",c.style.opacity="0.8",(a=(i=c.createDiv("dida-time-block-task-content")).createEl("input",{type:"checkbox"})).disabled=!0,a.style.marginRight="8px",a.style.flexShrink="0",r=i.createDiv("dida-time-block-task-time"),(h=c.createDiv("dida-time-block-task-title")).contentEditable="true",h.style.outline="none",h.style.cursor="text",h.style.wordBreak="break-word",h.textContent=""),c)){var a=Math.max(g.top,Math.min(g.bottom,s)),i=Math.max(g.top,Math.min(g.bottom,e)),e=Math.min(a,i)-g.top;let t=Math.abs(i-a);i=15/1440*m,i=(t<i&&(t=i),e/m*100),e=t/m*100;c.style.top=i+"%",c.style.height=e+"%",(()=>{if(o&&c&&r){var i=c.offsetTop/m*100,a=(i+c.offsetHeight/m*100)/100*24*60;let t=Math.round(i/100*24*60+60*v),e=Math.round(a+60*v);1440<=t&&(t-=1440),1440<=e&&(e-=1440),t<0&&(t=0),e<0&&(e=0);var i=Math.floor(t/60).toString().padStart(2,"0"),a=(t%60).toString().padStart(2,"0"),s=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");r.textContent=i+`:${a} - ${s}:`+n}})()}},p=t=>{if(document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",p),!o||!c||!h)return void u();var e=c.offsetHeight,i=15/1440*m;if(!e||e<i/2)return void u();h.focus();let a=t=>{"Enter"===t.key?(t.preventDefault(),h.removeEventListener("keydown",a),h.removeEventListener("blur",s),l()):"Escape"===t.key&&(t.preventDefault(),h.removeEventListener("keydown",a),h.removeEventListener("blur",s),u())},s=()=>{h.removeEventListener("keydown",a),h.removeEventListener("blur",s),l()};h.addEventListener("keydown",a),h.addEventListener("blur",s)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",p)}}}),this.assignColumnsToTasks(t).forEach(({task:t,column:e})=>{this.renderTimeTaskBlock(k,t,e)})}assignColumnsToTasks(t){t=t.slice().sort((t,e)=>new Date(t.startDate).getTime()-new Date(e.startDate).getTime());let e=[],l=[[],[]];return t.forEach(t=>{var i=new Date(t.startDate).getTime(),a=new Date(t.dueDate).getTime();let s=-1;for(let e=0;e<2;e++){let t=!1;for(var n of l[e]){var r=new Date(n.startDate).getTime();if(i<new Date(n.dueDate).getTime()&&r<a){t=!0;break}}if(!t){s=e;break}}-1===s&&(s=0),l[s].push(t),e.push({task:t,column:s})}),e}getTaskColor(t){var e=(t.title||t.id||"").toString();let i=0;for(let t=0;t<e.length;t++)i=(i<<5)-i+e.charCodeAt(t),i|=0;return`hsl(${Math.abs(i)%360}, 35%, 90%)`}renderTimeTaskBlock(k,v,y=0){if(v.startDate&&v.dueDate){var w=new Date(v.startDate),f=new Date(v.dueDate),T=w.getHours(),w=w.getMinutes(),D=f.getHours(),f=f.getMinutes();let t=60*(T-(this.plugin.settings.timeBlockStartHour||0))+w;t<0&&(t+=1440);var S=t/1440*100;let e=60*D+f-(60*T+w);e<0&&(e+=1440);var x=e/1440*100;let h=k.createDiv("dida-time-block-task");h.setAttribute("data-task-id",v.id),h.setAttribute("data-column",y.toString()),h.style.top=S+"%",h.style.height=x+"%",h.style.backgroundColor=this.getTaskColor(v);h.style.left=0===y?"50px":"calc(50% + 25px + 2.5px)",h.style.width="calc(50% - 25px - 2.5px)";k=h.createDiv("dida-time-block-task-content");let a=k.createEl("input",{type:"checkbox"}),u=(a.checked=2===v.status,a.style.marginRight="8px",a.style.flexShrink="0",a.onchange=async t=>{t.stopPropagation();t=this.plugin.settings.tasks.findIndex(t=>t.didaId===v.didaId);-1!==t&&(await this.plugin.toggleTask(t),this.renderTaskList())},k.createDiv("dida-time-block-task-time")),i=T.toString().padStart(2,"0")+":"+w.toString().padStart(2,"0"),s=D.toString().padStart(2,"0")+":"+f.toString().padStart(2,"0"),n=(u.textContent=i+" - "+s,u.onclick=t=>{t.stopPropagation();let a=this.plugin.settings.tasks.findIndex(t=>v.didaId?t.didaId===v.didaId:t.id===v.id);-1!==a&&(t=v.startDate||v.dueDate||this.selectedDate,new DatePickerModal(this.app,t,async(t,e,i)=>{t&&(await this.updateTaskStartDate(a,t,e),i)&&!e&&await this.updateTaskDueDate(a,i,!1)},u,this.plugin,a).open())},h.createDiv("dida-time-block-task-title")),r=(this.renderTaskTitleContent(n,v.title||""),n.contentEditable="true",n.style.outline="none",n.style.cursor="text",n.style.wordBreak="break-word",2===v.status&&(n.style.textDecoration="line-through"),v.title),l=(n.onfocus=()=>{r=n.textContent},n.onblur=async()=>{var t=n.textContent.trim();if(t&&t!==r){var e=this.plugin.settings.tasks.findIndex(t=>t.didaId===v.didaId);if(-1!==e){var e=this.plugin.settings.tasks[e],i=e.title;if(e.title=t,e.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&e.didaId&&this.plugin.syncTaskToDidaListInBackground(e),e.didaId){var a=this.app.workspace.getLeavesOfType("dida-task-view");if(0<a.length&&a[0].view.updateNativeTaskTitle)try{await a[0].view.updateNativeTaskTitle(e,i,t)}catch(t){}}}}else t||(n.textContent=r)},n.onkeydown=t=>{"Enter"===t.key&&(t.preventDefault(),n.blur())},h.createEl("button",{cls:"dida-task-delete"})),d=(l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',l.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${v.title}"å—ï¼Ÿ`)&&-1!==(t=this.plugin.settings.tasks.findIndex(t=>v.didaId?t.didaId===v.didaId:t.id===v.id))&&await this.plugin.deleteTask(t)},null),o=null,c=()=>{d&&d.parentElement&&d.parentElement.removeChild(d),d=null,o&&(document.removeEventListener("keyup",o),o=null)},p=t=>{d&&(d.style.left=t.clientX+12+"px",d.style.top=t.clientY+12+"px")},g=t=>{var e;t.ctrlKey||t.metaKey?(d||((e=document.createElement("div")).className="dida-time-block-tooltip",e.textContent=`${i} - ${s}  Â·  `+(v.title||""),document.body.appendChild(e),d=e,o=t=>{t.ctrlKey||t.metaKey||c()},document.addEventListener("keyup",o)),p(t)):c()},m=(h.addEventListener("mouseenter",t=>{g(t)}),h.addEventListener("mousemove",t=>{g(t)}),h.addEventListener("mouseleave",()=>{c()}),60*D+f-(60*T+w));m<0&&(m+=1440);h.addEventListener("mousedown",i=>{var t=i.target;if(t!==a&&t!==n&&!n.contains(t)&&t!==l&&!l.contains(t)){i.preventDefault();let c=h.parentElement;if(c){let d=c.offsetHeight;if(d){let e=i.clientY,r=h.offsetTop,l=h.offsetHeight,t=i=>{i=i.clientY-e;let t=r+i;i=Math.max(0,d-l),i=(t=(t=t<0?0:t)>i?i:t)/d*100;if(h.style.top=i+"%",u&&h.parentElement){i=h.parentElement.offsetHeight||0;if(0<i){var a=h.offsetTop/i*100,i=(a+h.offsetHeight/i*100)/100*24*60,s=this.plugin.settings.timeBlockStartHour||0;let t=Math.round(a/100*24*60+60*s),e=Math.round(i+60*s);1440<=t&&(t-=1440),1440<=e&&(e-=1440),t<0&&(t=0),e<0&&(e=0);var a=Math.floor(t/60).toString().padStart(2,"0"),i=(t%60).toString().padStart(2,"0"),s=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");u.textContent=a+`:${i} - ${s}:`+n}}},o=async()=>{document.removeEventListener("mousemove",t),document.removeEventListener("mouseup",o);var i=c.offsetHeight;if(i){var i=h.offsetTop/i*100,a=this.plugin.settings.timeBlockStartHour||0;let t=Math.round(i/100*24*60+60*a),e=(1440<=t&&(t-=1440),(t=t<0?0:t)+m);1440<=e&&(e-=1440);var i=Math.floor(t/60),a=t%60,s=Math.floor(e/60),n=e%60,r=this.plugin.settings.tasks.findIndex(t=>t.didaId===v.didaId);if(-1!==r){var l=new Date(this.selectedDate),d=(l.setHours(0,0,0,0),new Date(l)),i=(d.setHours(i,a,0,0),new Date(l));if(i.setHours(s,n,0,0),this.plugin.settings.tasks[r].startDate=d.toISOString(),this.plugin.settings.tasks[r].dueDate=i.toISOString(),this.plugin.settings.tasks[r].updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&v.didaId)try{await this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[r])}catch(t){console.error("åŒæ­¥åˆ°æ»´ç­”æ¸…å•å¤±è´¥:",t)}this.renderTaskList()}}};document.addEventListener("mousemove",t),document.addEventListener("mouseup",o)}}}}),this.makeTaskBlockResizable(h,v,u)}}makeTaskBlockResizable(o,c,r){var t=o.createDiv("dida-time-block-resize-handle dida-time-block-resize-top"),e=o.createDiv("dida-time-block-resize-handle dida-time-block-resize-bottom");let h=!1,a=null,s=0,n=0,l=0,d=()=>{if(r){var i=o.parentElement?o.parentElement.offsetHeight:0;if(i){var a=o.offsetTop/i*100,i=(a+o.offsetHeight/i*100)/100*24*60,s=this.plugin.settings.timeBlockStartHour||0;let t=Math.round(a/100*24*60+60*s),e=Math.round(i+60*s);1440<=t&&(t-=1440),1440<=e&&(e-=1440),t<0&&(t=0),e<0&&(e=0);var a=Math.floor(t/60).toString().padStart(2,"0"),i=(t%60).toString().padStart(2,"0"),s=Math.floor(e/60).toString().padStart(2,"0"),n=(e%60).toString().padStart(2,"0");r.textContent=a+`:${i} - ${s}:`+n}}},i=(t,e)=>{h=!0,a=e,s=t.clientY,n=o.offsetHeight,l=o.offsetTop,t.preventDefault(),t.stopPropagation()};t.onmousedown=t=>i(t,"top"),e.onmousedown=t=>i(t,"bottom"),document.addEventListener("mousemove",t=>{var e,i;h&&(i=(t=t.clientY-s)/(e=o.parentElement.offsetHeight)*100,"top"===a?(i=Math.max(0,Math.min(100,l/e*100+i)),o.style.top=i+"%",i=Math.max(5,n-t),o.style.height=i/e*100+"%",d()):"bottom"===a&&(i=Math.max(5,n+t),o.style.height=i/e*100+"%",d()))}),document.addEventListener("mouseup",async()=>{if(h){h=!1;var i=o.parentElement.offsetHeight,a=o.offsetTop/i*100,i=(a+o.offsetHeight/i*100)/100*24*60,s=this.plugin.settings.timeBlockStartHour||0;let t=Math.round(a/100*24*60+60*s),e=Math.round(i+60*s);1440<=t&&(t-=1440),1440<=e&&(e-=1440),t<0&&(t=0),e<0&&(e=0);var a=Math.floor(t/60),i=t%60,s=Math.floor(e/60),n=e%60,r=this.plugin.settings.tasks.findIndex(t=>t.didaId===c.didaId);if(-1!==r){var l=new Date(this.selectedDate),d=(l.setHours(0,0,0,0),new Date(l)),a=(d.setHours(a,i,0,0),new Date(l));if(a.setHours(s,n,0,0),this.plugin.settings.tasks[r].startDate=d.toISOString(),this.plugin.settings.tasks[r].dueDate=a.toISOString(),this.plugin.settings.tasks[r].updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&c.didaId)try{await this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[r])}catch(t){console.error("åŒæ­¥åˆ°æ»´ç­”æ¸…å•å¤±è´¥:",t)}this.renderTaskList()}}})}getTasksForDate(t){var e=this.plugin.settings.tasks||[];let i=new Date(t);return i.setHours(0,0,0,0),e.filter(t=>!(t.parentId||!t.dueDate&&!t.startDate||(t=t.startDate||t.dueDate,(t=new Date(t)).setHours(0,0,0,0),t.getTime()!==i.getTime())))}isAllDayTask(t){return!!t.dueDate&&(void 0!==t.isAllDay?t.isAllDay:0===(t=new Date(t.dueDate)).getHours()&&0===t.getMinutes())}showTimelineView(){new TimelineViewModal(this.app,this.plugin).open()}async onClose(){this.eventCleanupHandlers&&(this.eventCleanupHandlers.forEach(t=>t()),this.eventCleanupHandlers=[])}}class TimelineViewModal{constructor(t,e){this.app=t,this.plugin=e,this.currentDate=new Date,this.selectedDate=new Date,this.isCalendarExpanded=!1,this.displayYear=(new Date).getFullYear(),this.displayMonth=(new Date).getMonth(),this.windowElement=null,this.overlayElement=null,this.contentEl=null,this.handleKeydown=this.handleKeydown.bind(this)}renderTimelineTaskTitleContent(t,e){for(;t.firstChild;)t.removeChild(t.firstChild);var i,a=/\[\^([^\]]+)\]/g;let s=0;for(var n=(e,i)=>{if(i){var a,s=/#[^\s#]+/g;let t=0;for(;null!==(a=s.exec(i));){a.index>t&&e.appendChild(document.createTextNode(i.slice(t,a.index)));e.createSpan({cls:"dida-task-tag",text:a[0]});t=a.index+a[0].length}t<i.length&&e.appendChild(document.createTextNode(i.slice(t)))}};null!==(i=a.exec(e));)i.index>s&&n(t,e.slice(s,i.index)),t.createEl("sup",{cls:"dida-task-footnote"}).textContent=`[${i[1]}]`,s=i.index+i[0].length;s<e.length&&n(t,e.slice(s))}open(){this.createCustomWindow(),this.renderTimelineView(),document.addEventListener("keydown",this.handleKeydown)}close(){this.windowElement&&(this.windowElement.remove(),this.windowElement=null),this.overlayElement&&(this.overlayElement.remove(),this.overlayElement=null),this.contentEl=null,document.removeEventListener("keydown",this.handleKeydown)}handleKeydown(t){"Escape"!==t.key&&"Esc"!==t.key||this.close()}createCustomWindow(){this.overlayElement=document.body.createDiv("dida-timeline-custom-window-overlay"),this.overlayElement.onclick=()=>this.close(),this.windowElement=document.body.createDiv("dida-timeline-custom-window");var t=this.windowElement.createDiv("dida-timeline-custom-window-header"),t=(t.createEl("h2",{cls:"dida-timeline-custom-window-title"}).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-check-icon lucide-calendar-check"><path d="M8 2v4"/><path d="M16 2v4"/><rect width="18" height="18" x="3" y="4" rx="2"/><path d="M3 10h18"/><path d="m9 16 2 2 4-4"/></svg> æ—¶é—´çº¿æ—¥å†è§†å›¾',t.createEl("button",{cls:"dida-timeline-custom-window-close"}));t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',t.onclick=()=>this.close(),this.contentEl=this.windowElement.createDiv("dida-timeline-custom-window-content"),this.windowElement.onclick=t=>t.stopPropagation()}renderTimelineView(){this.contentEl.empty(),this.renderDateSelector(this.contentEl),this.renderTimelineTasks(this.contentEl)}renderDateSelector(t){var t=t.createDiv("dida-timeline-date-selector"),e=t.createDiv("dida-timeline-month-nav");e.createEl("button",{text:"â€¹",cls:"dida-timeline-nav-btn"}).onclick=()=>{this.displayMonth--,this.displayMonth<0&&(this.displayMonth=11,this.displayYear--);var t=this.selectedDate?this.selectedDate.getDate():1;let e=new Date(this.displayYear,this.displayMonth,t);!isNaN(e.getTime())&&e.getMonth()===this.displayMonth||(e=new Date(this.displayYear,this.displayMonth,1)),this.selectedDate=e,this.renderTimelineView()},e.createDiv("dida-timeline-month-display").innerHTML=`${this.displayYear}å¹´${this.displayMonth+1}æœˆ`,e.createEl("button",{text:"â€º",cls:"dida-timeline-nav-btn"}).onclick=()=>{this.displayMonth++,11<this.displayMonth&&(this.displayMonth=0,this.displayYear++);var t=this.selectedDate?this.selectedDate.getDate():1;let e=new Date(this.displayYear,this.displayMonth,t);!isNaN(e.getTime())&&e.getMonth()===this.displayMonth||(e=new Date(this.displayYear,this.displayMonth,1)),this.selectedDate=e,this.renderTimelineView()},e.createEl("button",{text:this.isCalendarExpanded?"æ”¶èµ·":"å±•å¼€",cls:"dida-timeline-expand-btn"}).onclick=()=>{this.isCalendarExpanded=!this.isCalendarExpanded,this.renderTimelineView()};let i=t.createDiv("dida-timeline-week-header");["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(t=>{i.createEl("span",{text:t,cls:"dida-timeline-week-day"})});e=t.createDiv("dida-timeline-date-picker");this.renderDatePicker(e)}renderDatePicker(t){var e=new Date,i=this.selectedDate;this.isCalendarExpanded?this.renderFullMonth(t,e,i):this.renderCurrentWeek(t,e,i)}renderFullMonth(i,a,s){var t=new Date(this.displayYear,this.displayMonth,1),e=new Date(this.displayYear,this.displayMonth+1,0),n=new Date(t),e=(n.setDate(n.getDate()-t.getDay()),e.getDate()+t.getDay()),r=Math.ceil(e/7);for(let e=0;e<r;e++)for(let t=0;t<7;t++){var l=new Date(n);l.setDate(n.getDate()+7*e+t),this.createDateItem(i,l,a,s)}}renderCurrentWeek(e,i,a){var s=new Date(a);s.setDate(a.getDate()-a.getDay());for(let t=0;t<7;t++){var n=new Date(s);n.setDate(s.getDate()+t),this.createDateItem(e,n,i,a)}}createDateItem(t,e,i,a){var t=t.createDiv("dida-timeline-date-item"),s=(t.createEl("span",{text:e.getDate().toString(),cls:"dida-timeline-date-number"}),this.getTasksForDate(e)),n=s.length;let r=s.filter(t=>2===t.status||t.completedTime&&""!==String(t.completedTime).trim());var s=s.filter(t=>!r.includes(t)),l=r.length,s=s.length;if(0<n){var d=t.createDiv("dida-timeline-task-count"),o=(d.style.cssText=`
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 2px;
                font-size: 8px;
                color: var(--text-muted);
                line-height: 1;
            `,Math.min(n,10));if(10<n)d.createEl("span",{text:"+"+n,cls:"dida-timeline-task-more"}).style.cssText=`
                    font-size: 7px;
                    color: var(--text-muted);
                    line-height: 1;
                    font-weight: bold;
                `;else{var c=Math.ceil(o/5),s=Math.min(s,o);let i=s,a=Math.min(l,Math.max(0,o-s));for(let t=0;t<c;t++){var h=d.createDiv("dida-timeline-task-dots-row"),u=(h.style.cssText=`
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        gap: 1px;
                        line-height: 1;
                    `,5*t),p=Math.min(5+u,o);for(let t=u;t<p;t++){let t="dida-timeline-task-dot",e=!1;0<i?i--:0<a&&(a--,t="dida-timeline-task-dot dida-timeline-task-dot-completed",e=!0);var g=h.createEl("span",{text:"â€¢",cls:t});g.style.cssText=`
                            font-size: 10px;
                            line-height: 1;
                            font-weight: bold;
                        `,e&&(g.title="å·²å®Œæˆä»»åŠ¡")}}}d.title=n+" ä¸ªä»»åŠ¡"}this.isCalendarExpanded&&e.getMonth()!==this.displayMonth&&t.addClass("dida-timeline-other-month"),e.toDateString()===i.toDateString()&&t.addClass("dida-timeline-today"),e.toDateString()===a.toDateString()&&t.addClass("dida-timeline-selected"),t.onclick=()=>{this.selectedDate=e,this.renderTimelineView()}}renderTimelineTasks(t){var e=t.createDiv("dida-timeline-container").createDiv("dida-timeline-task-list"),i=this.getTasksForDate(this.selectedDate),a=i.filter(t=>this.isAllDayTask(t)),a=(0<a.length&&this.renderAllDayTasks(e,a),i.filter(t=>!this.isAllDayTask(t)));0<a.length&&this.renderTimeTasks(e,a),0===i.length&&(e.createDiv("dida-timeline-empty-state").innerHTML="<p>ä»Šå¤©æ²¡æœ‰ä»»åŠ¡</p>"),this.renderFloatingActionButton(t)}getTasksForDate(t){var e=this.plugin.settings.tasks||[];let i=new Date(t);return i.setHours(0,0,0,0),e.filter(t=>!t.parentId&&!!t.dueDate&&((t=new Date(t.dueDate)).setHours(0,0,0,0),t.getTime()===i.getTime()))}isAllDayTask(t){return!!t.dueDate&&(void 0!==t.isAllDay?t.isAllDay:0===(t=new Date(t.dueDate)).getHours()&&0===t.getMinutes())}renderAllDayTasks(t,e){let h=t.createDiv("dida-timeline-all-day-section").createDiv("dida-timeline-all-day-tasks");e.forEach(i=>{let t=h.createDiv("dida-timeline-task-item dida-timeline-all-day-task");t.setAttribute("data-task-id",i.id);var e=t.createDiv("dida-timeline-element-container");e.createDiv("dida-timeline-time-label").textContent="å…¨å¤©";let a=e.createEl("input",{type:"checkbox"}),s=(a.checked=2===i.status,t.createEl("span",{cls:2===i.status?"dida-timeline-task-completed dida-task-title-clickable":"dida-timeline-task-title dida-task-title-clickable"}));this.renderTimelineTaskTitleContent(s,i.title||"æ— æ ‡é¢˜ä»»åŠ¡"),s.onclick=()=>this.toggleTimelineTaskDetails(t,i),i.repeatFlag&&""!==i.repeatFlag.trim()&&(e=translateRepeatFlag(i.repeatFlag))&&((r=document.createElement("div")).className="dida-task-repeat-rule",r.innerHTML=e,r.style.fontSize="8px",r.style.color="#0066cc",r.style.marginTop="2px",r.style.marginLeft="20px",t.appendChild(r)),a.onchange=debounce(async()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);-1!==t&&(await this.plugin.toggleTask(t),a.checked?(s.classList.remove("dida-timeline-task-title"),s.classList.add("dida-timeline-task-completed")):(s.classList.remove("dida-timeline-task-completed"),s.classList.add("dida-timeline-task-title")))},200),i.items&&0<i.items.length&&(e=i.items.filter(t=>1===t.status).length,(r=t.createEl("span",{cls:"dida-subtask-count"})).innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" id="item-text" fill="#4c4f69">
  <path d="M30.06666612625122,7.625000095367431Q30.06666612625122,7.221142095367432,30.35223712625122,6.935571095367432Q30.637808126251223,6.650000095367432,31.041666126251222,6.650000095367432L40.95836612625122,6.650000095367432Q41.362166126251225,6.650000095367432,41.64776612625122,6.935571095367432Q41.93336612625122,7.221140095367431,41.93336612625122,7.625000095367431Q41.93336612625122,8.028860095367431,41.64776612625122,8.314430095367431Q41.362166126251225,8.600000095367431,40.95836612625122,8.600000095367431L31.041666126251222,8.600000095367431Q30.637808126251223,8.600000095367431,30.35223712625122,8.314430095367431Q30.06666612625122,8.028860095367431,30.06666612625122,7.625000095367431ZM32.98332612625122,12.000000095367431Q32.98332612625122,11.596140095367431,33.26889612625122,11.310570095367432Q33.554476126251224,11.025000095367432,33.95832612625122,11.025000095367432L40.95836612625122,11.025000095367432Q41.362166126251225,11.025000095367432,41.64776612625122,11.310570095367432Q41.93336612625122,11.596140095367431,41.93336612625122,12.000000095367431Q41.93336612625122,12.403860095367431,41.64776612625122,12.689430095367431Q41.362166126251225,12.975000095367431,40.95836612625122,12.975000095367431L37.45832612625122,12.975000095367431L33.95832612625122,12.975000095367431Q33.554476126251224,12.975000095367431,33.26889612625122,12.689430095367431Q32.98332612625122,12.403860095367431,32.98332612625122,12.000000095367431ZM32.98332612625122,16.375000095367433Q32.98332612625122,15.971140095367431,33.26889612625122,15.685570095367432Q33.55446612625122,15.400000095367432,33.95832612625122,15.400000095367432L40.95836612625122,15.400000095367432Q41.362166126251225,15.400000095367432,41.64776612625122,15.685570095367432Q41.93336612625122,15.971140095367431,41.93336612625122,16.375000095367433Q41.93336612625122,16.778900095367433,41.64776612625122,17.064400095367432Q41.362166126251225,17.35000009536743,40.95836612625122,17.35000009536743L33.95832612625122,17.35000009536743Q33.55446612625122,17.35000009536743,33.26889612625122,17.064400095367432Q32.98332612625122,16.778900095367433,32.98332612625122,16.375000095367433Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
  <path d="M46.5,18.5L46.5,5.5Q46.5,3.84314,45.3284,2.671573Q44.1569,1.5,42.5,1.5L29.5,1.5Q27.84315,1.5,26.671573,2.671573Q25.5,3.84315,25.5,5.5L25.5,18.5Q25.5,20.1569,26.671573,21.3284Q27.84314,22.5,29.5,22.5L42.5,22.5Q44.1569,22.5,45.3284,21.3284Q46.5,20.1569,46.5,18.5ZM44.5,5.5L44.5,18.5Q44.5,19.3284,43.9142,19.9142Q43.3284,20.5,42.5,20.5L29.5,20.5Q28.67157,20.5,28.08579,19.9142Q27.5,19.3284,27.5,18.5L27.5,5.5Q27.5,4.67157,28.08579,4.08579Q28.67157,3.5,29.5,3.5L42.5,3.5Q43.3284,3.5,43.9142,4.08579Q44.5,4.67157,44.5,5.5Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
</svg>${e}/`+i.items.length,r.style.fontSize="11px",r.style.color="#666",r.style.marginLeft="2px",r.style.display="flex",r.style.alignItems="center",r.style.gap="2px",r.style.cursor="pointer",r.title="ç‚¹å‡»æŸ¥çœ‹æ£€æŸ¥é¡¹",r.onclick=()=>this.toggleTimelineTaskDetails(t,i,"check-items-tab"));var n,e=this.plugin.settings.tasks.filter(t=>t.parentId===i.didaId),r=(i.didaId&&0<e.length&&(e.filter(t=>2!==t.status),r=e.filter(t=>2===t.status).length,(n=t.createEl("span",{cls:"dida-child-task-count"})).innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 12 12" id="descendant-task-small" fill="#4c4f69">
  <path d="M1.2500016689300537,1.491542L1.2500016689300537,8.31342C1.2500016689300537,9.3755,2.1029426689300537,10.25,3.1650316689300535,10.25L6.995881668930053,10.25C7.272021668930054,10.25,7.500001668930054,10.02614,7.500001668930054,9.75C7.500001668930054,9.47386,7.2761416689300535,9.25,7.000001668930054,9.25L3.204551668930054,9.25C2.677361668930054,9.25,2.2500016689300537,8.82264,2.2500016689300537,8.295449999999999L2.2500016689300537,4.75L7.000001668930054,4.75C7.2761416689300535,4.75,7.500001668930054,4.52614,7.500001668930054,4.25C7.500001668930054,3.97386,7.2761416689300535,3.75,7.000001668930054,3.75L2.2500016689300537,3.75L2.2500016689300537,1.5C2.2500016689300537,1.223858,2.026143668930054,1,1.7500016689300537,1C1.4738596689300536,1,1.2500016689300537,1.2154,1.2500016689300537,1.491542ZM10.750001668930054,4.25Q10.750001668930054,4.34849,10.730781668930053,4.44509Q10.711571668930054,4.54169,10.673881668930054,4.632680000000001Q10.636191668930053,4.72368,10.581471668930053,4.8055699999999995Q10.526751668930054,4.88746,10.457111668930054,4.95711Q10.387461668930055,5.02675,10.305571668930053,5.08147Q10.223681668930054,5.13619,10.132681668930054,5.17388Q10.041691668930053,5.21157,9.945091668930054,5.23078Q9.848491668930054,5.25,9.750001668930054,5.25Q9.651511668930054,5.25,9.554911668930053,5.23078Q9.458311668930055,5.21157,9.367321668930053,5.17388Q9.276321668930054,5.13619,9.194431668930054,5.08147Q9.112541668930053,5.02675,9.042891668930054,4.95711Q8.973251668930054,4.88746,8.918531668930054,4.8055699999999995Q8.863811668930055,4.72368,8.826121668930053,4.632680000000001Q8.788431668930054,4.54169,8.769211668930055,4.44509Q8.750001668930054,4.34849,8.750001668930054,4.25Q8.750001668930054,4.15151,8.769211668930055,4.05491Q8.788431668930054,3.95831,8.826121668930053,3.86732Q8.863811668930055,3.77632,8.918531668930054,3.69443Q8.973251668930054,3.61254,9.042891668930054,3.54289Q9.112541668930053,3.47325,9.194431668930054,3.41853Q9.276321668930054,3.36381,9.367321668930053,3.32612Q9.458311668930055,3.28843,9.554911668930053,3.26921Q9.651511668930054,3.25,9.750001668930054,3.25Q9.848491668930054,3.25,9.945091668930054,3.26921Q10.041691668930053,3.28843,10.132681668930054,3.32612Q10.223681668930054,3.36381,10.305571668930053,3.41853Q10.387461668930055,3.47325,10.457111668930054,3.54289Q10.526751668930054,3.61254,10.581471668930053,3.69443Q10.636191668930053,3.77632,10.673881668930054,3.86732Q10.711571668930054,3.95831,10.730781668930053,4.05491Q10.750001668930054,4.15151,10.750001668930054,4.25ZM10.750001668930054,9.75Q10.750001668930054,9.84849,10.730781668930053,9.94509Q10.711571668930054,10.04169,10.673881668930054,10.13268Q10.636191668930053,10.22368,10.581471668930053,10.30557Q10.526751668930054,10.38746,10.457111668930054,10.45711Q10.387461668930055,10.52675,10.305571668930053,10.58147Q10.223681668930054,10.63619,10.132681668930054,10.67388Q10.041691668930053,10.71157,9.945091668930054,10.73078Q9.848491668930054,10.75,9.750001668930054,10.75Q9.651511668930054,10.75,9.554911668930053,10.73078Q9.458311668930055,10.71157,9.367321668930053,10.67388Q9.276321668930054,10.63619,9.194431668930054,10.58147Q9.112541668930053,10.52675,9.042891668930054,10.45711Q8.973251668930054,10.38746,8.918531668930054,10.30557Q8.863811668930055,10.22368,8.826121668930053,10.13268Q8.788431668930054,10.04169,8.769211668930055,9.94509Q8.750001668930054,9.84849,8.750001668930054,9.75Q8.750001668930054,9.65151,8.769211668930055,9.55491Q8.788431668930054,9.45831,8.826121668930053,9.36732Q8.863811668930055,9.27632,8.918531668930054,9.19443Q8.973251668930054,9.11254,9.042891668930054,9.04289Q9.112541668930053,8.97325,9.194431668930054,8.91853Q9.276321668930054,8.86381,9.367321668930053,8.82612Q9.458311668930055,8.78843,9.554911668930053,8.769210000000001Q9.651511668930054,8.75,9.750001668930054,8.75Q9.848491668930054,8.75,9.945091668930054,8.769210000000001Q10.041691668930053,8.78843,10.132681668930054,8.82612Q10.223681668930054,8.86381,10.305571668930053,8.91853Q10.387461668930055,8.97325,10.457111668930054,9.04289Q10.526751668930054,9.11254,10.581471668930053,9.19443Q10.636191668930053,9.27632,10.673881668930054,9.36732Q10.711571668930054,9.45831,10.730781668930053,9.55491Q10.750001668930054,9.65151,10.750001668930054,9.75Z" fill-rule="evenodd"></path>
</svg>${r}/`+e.length,n.style.fontSize="0.8em",n.style.color="#0066cc",n.style.marginLeft="2px",n.style.display="flex",n.style.alignItems="center",n.style.gap="2px",n.style.cursor="pointer",n.title="ç‚¹å‡»æŸ¥çœ‹å­ä»»åŠ¡",n.onclick=()=>this.toggleTimelineTaskDetails(t,i,"subtasks-tab")),t.createEl("span",{cls:"dida-task-due-date"}));if(i.dueDate)try{var l=new Date(i.dueDate),d=l.getMonth()+1,o=l.getDate(),c=(r.textContent=d+"/"+o,new Date);c.setHours(0,0,0,0),l.setHours(0,0,0,0),l<c?r.classList.add("overdue"):l.getTime()===c.getTime()&&r.classList.add("today")}catch(t){r.textContent=""}else r.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#da1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-x2-icon lucide-calendar-x-2"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M3 10h18"/><path d="m17 22 5-5"/><path d="m17 17 5 5"/></svg>',r.classList.add("no-date");r.style.cursor="pointer",r.title="ç‚¹å‡»è®¾ç½®åˆ°æœŸæ—¥æœŸ",r.onclick=t=>{t.stopPropagation();let s=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);var e;-1!==s&&(e=i.startDate||i.dueDate||this.selectedDate,new DatePickerModal(this.app,e,async(t,e,i)=>{var a;t&&(0<(a=this.plugin.app.workspace.getLeavesOfType("dida-task-view")).length&&a[0].view.updateTaskStartDate&&(await a[0].view.updateTaskStartDate(s,t,e),i)&&!e&&a[0].view.updateTaskDueDate&&await a[0].view.updateTaskDueDate(s,i,!1),this.renderTimelineView(),this.plugin.refreshTaskView)&&this.plugin.refreshTaskView()},t.currentTarget,this.plugin,s).open())};e=t.createEl("button",{cls:"dida-task-delete"});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',e.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${i.title}"å—ï¼Ÿ`)&&-1!==(t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId))&&(await this.plugin.deleteTask(t),this.renderTimelineView())},i.repeat&&(t.createEl("span",{cls:"dida-timeline-repeat-icon"}).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat-icon lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>')})}renderTimeTasks(h,t){t.sort((t,e)=>new Date(t.dueDate)-new Date(e.dueDate)),t.forEach(i=>{let t=h.createDiv("dida-timeline-task-item dida-timeline-time-task");t.setAttribute("data-task-id",i.id);var e=t.createDiv("dida-timeline-element-container"),a=e.createDiv("dida-timeline-time-label"),s=new Date(i.startDate||i.dueDate).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit",hour12:!1});a.textContent=s;let n=e.createEl("input",{type:"checkbox"}),r=(n.checked=2===i.status,t.createEl("span",{cls:2===i.status?"dida-timeline-task-completed dida-task-title-clickable":"dida-timeline-task-title dida-task-title-clickable"}));this.renderTimelineTaskTitleContent(r,i.title||"æ— æ ‡é¢˜ä»»åŠ¡"),r.onclick=()=>this.toggleTimelineTaskDetails(t,i),i.repeatFlag&&""!==i.repeatFlag.trim()&&(a=translateRepeatFlag(i.repeatFlag))&&((s=document.createElement("div")).className="dida-task-repeat-rule",s.innerHTML=a,s.style.fontSize="8px",s.style.color="#0066cc",s.style.marginTop="2px",s.style.marginLeft="20px",t.appendChild(s)),n.onchange=async()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);-1!==t&&(await this.plugin.toggleTask(t),n.checked?(r.classList.remove("dida-timeline-task-title"),r.classList.add("dida-timeline-task-completed")):(r.classList.remove("dida-timeline-task-completed"),r.classList.add("dida-timeline-task-title")))},i.items&&0<i.items.length&&(e=i.items.filter(t=>1===t.status).length,(a=t.createEl("span",{cls:"dida-subtask-count"})).innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 24 24" id="item-text" fill="#4c4f69">
  <path d="M30.06666612625122,7.625000095367431Q30.06666612625122,7.221142095367432,30.35223712625122,6.935571095367432Q30.637808126251223,6.650000095367432,31.041666126251222,6.650000095367432L40.95836612625122,6.650000095367432Q41.362166126251225,6.650000095367432,41.64776612625122,6.935571095367432Q41.93336612625122,7.221140095367431,41.93336612625122,7.625000095367431Q41.93336612625122,8.028860095367431,41.64776612625122,8.314430095367431Q41.362166126251225,8.600000095367431,40.95836612625122,8.600000095367431L31.041666126251222,8.600000095367431Q30.637808126251223,8.600000095367431,30.35223712625122,8.314430095367431Q30.06666612625122,8.028860095367431,30.06666612625122,7.625000095367431ZM32.98332612625122,12.000000095367431Q32.98332612625122,11.596140095367431,33.26889612625122,11.310570095367432Q33.554476126251224,11.025000095367432,33.95832612625122,11.025000095367432L40.95836612625122,11.025000095367432Q41.362166126251225,11.025000095367432,41.64776612625122,11.310570095367432Q41.93336612625122,11.596140095367431,41.93336612625122,12.000000095367431Q41.93336612625122,12.403860095367431,41.64776612625122,12.689430095367431Q41.362166126251225,12.975000095367431,40.95836612625122,12.975000095367431L37.45832612625122,12.975000095367431L33.95832612625122,12.975000095367431Q33.554476126251224,12.975000095367431,33.26889612625122,12.689430095367431Q32.98332612625122,12.403860095367431,32.98332612625122,12.000000095367431ZM32.98332612625122,16.375000095367433Q32.98332612625122,15.971140095367431,33.26889612625122,15.685570095367432Q33.55446612625122,15.400000095367432,33.95832612625122,15.400000095367432L40.95836612625122,15.400000095367432Q41.362166126251225,15.400000095367432,41.64776612625122,15.685570095367432Q41.93336612625122,15.971140095367431,41.93336612625122,16.375000095367433Q41.93336612625122,16.778900095367433,41.64776612625122,17.064400095367432Q41.362166126251225,17.35000009536743,40.95836612625122,17.35000009536743L33.95832612625122,17.35000009536743Q33.55446612625122,17.35000009536743,33.26889612625122,17.064400095367432Q32.98332612625122,16.778900095367433,32.98332612625122,16.375000095367433Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
  <path d="M46.5,18.5L46.5,5.5Q46.5,3.84314,45.3284,2.671573Q44.1569,1.5,42.5,1.5L29.5,1.5Q27.84315,1.5,26.671573,2.671573Q25.5,3.84315,25.5,5.5L25.5,18.5Q25.5,20.1569,26.671573,21.3284Q27.84314,22.5,29.5,22.5L42.5,22.5Q44.1569,22.5,45.3284,21.3284Q46.5,20.1569,46.5,18.5ZM44.5,5.5L44.5,18.5Q44.5,19.3284,43.9142,19.9142Q43.3284,20.5,42.5,20.5L29.5,20.5Q28.67157,20.5,28.08579,19.9142Q27.5,19.3284,27.5,18.5L27.5,5.5Q27.5,4.67157,28.08579,4.08579Q28.67157,3.5,29.5,3.5L42.5,3.5Q43.3284,3.5,43.9142,4.08579Q44.5,4.67157,44.5,5.5Z" fill-rule="evenodd" transform="matrix(-1 0 0 1 48 0)"></path>
</svg>${e}/`+i.items.length,a.style.fontSize="0.8em",a.style.color="#666",a.style.marginLeft="2px",a.style.display="flex",a.style.alignItems="center",a.style.gap="2px",a.style.cursor="pointer",a.title="ç‚¹å‡»æŸ¥çœ‹æ£€æŸ¥é¡¹",a.onclick=()=>this.toggleTimelineTaskDetails(t,i,"check-items-tab"));s=this.plugin.settings.tasks.filter(t=>t.parentId===i.didaId),i.didaId&&0<s.length&&(s.filter(t=>2!==t.status),e=s.filter(t=>2===t.status).length,(a=t.createEl("span",{cls:"dida-child-task-count"})).innerHTML=`<svg xmlns="http://www.w3.org/2000/svg" width="13" height="13" viewBox="0 0 12 12" id="descendant-task-small" fill="#4c4f69">
  <path d="M1.2500016689300537,1.491542L1.2500016689300537,8.31342C1.2500016689300537,9.3755,2.1029426689300537,10.25,3.1650316689300535,10.25L6.995881668930053,10.25C7.272021668930054,10.25,7.500001668930054,10.02614,7.500001668930054,9.75C7.500001668930054,9.47386,7.2761416689300535,9.25,7.000001668930054,9.25L3.204551668930054,9.25C2.677361668930054,9.25,2.2500016689300537,8.82264,2.2500016689300537,8.295449999999999L2.2500016689300537,4.75L7.000001668930054,4.75C7.2761416689300535,4.75,7.500001668930054,4.52614,7.500001668930054,4.25C7.500001668930054,3.97386,7.2761416689300535,3.75,7.000001668930054,3.75L2.2500016689300537,3.75L2.2500016689300537,1.5C2.2500016689300537,1.223858,2.026143668930054,1,1.7500016689300537,1C1.4738596689300536,1,1.2500016689300537,1.2154,1.2500016689300537,1.491542ZM10.750001668930054,4.25Q10.750001668930054,4.34849,10.730781668930053,4.44509Q10.711571668930054,4.54169,10.673881668930054,4.632680000000001Q10.636191668930053,4.72368,10.581471668930053,4.8055699999999995Q10.526751668930054,4.88746,10.457111668930054,4.95711Q10.387461668930055,5.02675,10.305571668930053,5.08147Q10.223681668930054,5.13619,10.132681668930054,5.17388Q10.041691668930053,5.21157,9.945091668930054,5.23078Q9.848491668930054,5.25,9.750001668930054,5.25Q9.651511668930054,5.25,9.554911668930053,5.23078Q9.458311668930055,5.21157,9.367321668930053,5.17388Q9.276321668930054,5.13619,9.194431668930054,5.08147Q9.112541668930053,5.02675,9.042891668930054,4.95711Q8.973251668930054,4.88746,8.918531668930054,4.8055699999999995Q8.863811668930055,4.72368,8.826121668930053,4.632680000000001Q8.788431668930054,4.54169,8.769211668930055,4.44509Q8.750001668930054,4.34849,8.750001668930054,4.25Q8.750001668930054,4.15151,8.769211668930055,4.05491Q8.788431668930054,3.95831,8.826121668930053,3.86732Q8.863811668930055,3.77632,8.918531668930054,3.69443Q8.973251668930054,3.61254,9.042891668930054,3.54289Q9.112541668930053,3.47325,9.194431668930054,3.41853Q9.276321668930054,3.36381,9.367321668930053,3.32612Q9.458311668930055,3.28843,9.554911668930053,3.26921Q9.651511668930054,3.25,9.750001668930054,3.25Q9.848491668930054,3.25,9.945091668930054,3.26921Q10.041691668930053,3.28843,10.132681668930054,3.32612Q10.223681668930054,3.36381,10.305571668930053,3.41853Q10.387461668930055,3.47325,10.457111668930054,3.54289Q10.526751668930054,3.61254,10.581471668930053,3.69443Q10.636191668930053,3.77632,10.673881668930054,3.86732Q10.711571668930054,3.95831,10.730781668930053,4.05491Q10.750001668930054,4.15151,10.750001668930054,4.25ZM10.750001668930054,9.75Q10.750001668930054,9.84849,10.730781668930053,9.94509Q10.711571668930054,10.04169,10.673881668930054,10.13268Q10.636191668930053,10.22368,10.581471668930053,10.30557Q10.526751668930054,10.38746,10.457111668930054,10.45711Q10.387461668930055,10.52675,10.305571668930053,10.58147Q10.223681668930054,10.63619,10.132681668930054,10.67388Q10.041691668930053,10.71157,9.945091668930054,10.73078Q9.848491668930054,10.75,9.750001668930054,10.75Q9.651511668930054,10.75,9.554911668930053,10.73078Q9.458311668930055,10.71157,9.367321668930053,10.67388Q9.276321668930054,10.63619,9.194431668930054,10.58147Q9.112541668930053,10.52675,9.042891668930054,10.45711Q8.973251668930054,10.38746,8.918531668930054,10.30557Q8.863811668930055,10.22368,8.826121668930053,10.13268Q8.788431668930054,10.04169,8.769211668930055,9.94509Q8.750001668930054,9.84849,8.750001668930054,9.75Q8.750001668930054,9.65151,8.769211668930055,9.55491Q8.788431668930054,9.45831,8.826121668930053,9.36732Q8.863811668930055,9.27632,8.918531668930054,9.19443Q8.973251668930054,9.11254,9.042891668930054,9.04289Q9.112541668930053,8.97325,9.194431668930054,8.91853Q9.276321668930054,8.86381,9.367321668930053,8.82612Q9.458311668930055,8.78843,9.554911668930053,8.769210000000001Q9.651511668930054,8.75,9.750001668930054,8.75Q9.848491668930054,8.75,9.945091668930054,8.769210000000001Q10.041691668930053,8.78843,10.132681668930054,8.82612Q10.223681668930054,8.86381,10.305571668930053,8.91853Q10.387461668930055,8.97325,10.457111668930054,9.04289Q10.526751668930054,9.11254,10.581471668930053,9.19443Q10.636191668930053,9.27632,10.673881668930054,9.36732Q10.711571668930054,9.45831,10.730781668930053,9.55491Q10.750001668930054,9.65151,10.750001668930054,9.75Z" fill-rule="evenodd"></path>
</svg>${e}/`+s.length,a.style.fontSize="0.8em",a.style.color="#0066cc",a.style.marginLeft="2px",a.style.display="flex",a.style.alignItems="center",a.style.gap="2px",a.style.cursor="pointer",a.title="ç‚¹å‡»æŸ¥çœ‹å­ä»»åŠ¡",a.onclick=()=>this.toggleTimelineTaskDetails(t,i,"subtasks-tab")),e=t.createEl("span",{cls:"dida-task-due-date"});if(i.dueDate)try{var l=new Date(i.dueDate),d=l.getMonth()+1,o=l.getDate(),c=(e.textContent=d+"/"+o,new Date);c.setHours(0,0,0,0),l.setHours(0,0,0,0),l<c?e.classList.add("overdue"):l.getTime()===c.getTime()&&e.classList.add("today")}catch(t){e.textContent=""}else e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#da1b1b" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-calendar-x2-icon lucide-calendar-x-2"><path d="M8 2v4"/><path d="M16 2v4"/><path d="M21 13V6a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h8"/><path d="M3 10h18"/><path d="m17 22 5-5"/><path d="m17 17 5 5"/></svg>',e.classList.add("no-date");e.style.cursor="pointer",e.title="ç‚¹å‡»è®¾ç½®åˆ°æœŸæ—¥æœŸ",e.onclick=t=>{t.stopPropagation();let s=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);var e;-1!==s&&(e=i.startDate||i.dueDate||this.selectedDate,new DatePickerModal(this.app,e,async(t,e,i)=>{var a;t&&(0<(a=this.plugin.app.workspace.getLeavesOfType("dida-task-view")).length&&a[0].view.updateTaskStartDate&&(await a[0].view.updateTaskStartDate(s,t,e),i)&&!e&&a[0].view.updateTaskDueDate&&await a[0].view.updateTaskDueDate(s,i,!1),this.renderTimelineView(),this.plugin.refreshTaskView)&&this.plugin.refreshTaskView()},t.currentTarget,this.plugin,s).open())};s=t.createEl("button",{cls:"dida-task-delete"});s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',s.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm(`ç¡®å®šè¦åˆ é™¤ä»»åŠ¡"${i.title}"å—ï¼Ÿ`)&&-1!==(t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId))&&(await this.plugin.deleteTask(t),this.renderTimelineView())},i.repeat&&(t.createEl("span",{cls:"dida-timeline-repeat-icon"}).innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-repeat-icon lucide-repeat"><path d="m17 2 4 4-4 4"/><path d="M3 11v-1a4 4 0 0 1 4-4h14"/><path d="m7 22-4-4 4-4"/><path d="M21 13v1a4 4 0 0 1-4 4H3"/></svg>')})}toggleTimelineTaskDetails(u,e,p="task-tab"){document.querySelectorAll(".dida-task-details").forEach(t=>{u.contains(t)||t.remove()});let g=u.querySelector(".dida-task-details");if(g)g.remove();else{g=u.createDiv("dida-task-details");let h=null;if(void 0!==e.originalIndex&&this.plugin.settings.tasks[e.originalIndex]?h=this.plugin.settings.tasks[e.originalIndex]:e.didaId?h=this.plugin.settings.tasks.find(t=>t.didaId===e.didaId):e.id&&(h=this.plugin.settings.tasks.find(t=>t.id===e.id)),h){h.content="string"==typeof h.content?h.content:h.content||"",h.desc="string"==typeof h.desc?h.desc:h.desc||"",h.items=h.items||[];let i=g.createDiv("dida-task-tab-nav");var m=i.createEl("button",{text:"ä»»åŠ¡",cls:"task-tab"===p?"dida-tab-btn active":"dida-tab-btn"}),k=i.createEl("button",{text:"æ£€æŸ¥é¡¹",cls:"check-items-tab"===p?"dida-tab-btn active":"dida-tab-btn"}),v=i.createEl("button",{text:"å­ä»»åŠ¡",cls:"subtasks-tab"===p?"dida-tab-btn active":"dida-tab-btn"});let a=g.createDiv("dida-task-content-area");var y=a.createDiv("task-tab"===p?"dida-tab-content active":"dida-tab-content"),w=(y.id="task-tab",y.createDiv("dida-task-detail-title"));w.createEl("strong",{text:"æ ‡é¢˜ï¼š"});let t=w.createEl("input",{type:"text",value:h.title,cls:"dida-task-title-input"});w=y.createDiv("dida-task-detail-content");let e=h.content||"",s="è¯·è¾“å…¥ä»»åŠ¡å†…å®¹...",n=("CHECKLIST"===h.kind?(e=h.desc||"",s="è¯·è¾“å…¥ä»»åŠ¡æè¿°å†…å®¹...",w.createEl("strong",{text:"æè¿°å†…å®¹ï¼š"})):w.createEl("strong",{text:"å†…å®¹ï¼š"}),w.createEl("textarea",{placeholder:s,cls:"dida-task-content-textarea"})),r=(n.value=e,g.createDiv("dida-task-button-container")),l=r.createEl("button",{text:"ä¿å­˜",cls:"dida-task-save-btn mod-cta"}),d=(h.didaId&&this.plugin.findFilesWithDidaId(h.didaId).then(a=>{if(0<a.length){let t,e;e=1===a.length?(s=a[0].basename.replace(".md",""),t="ğŸ”— "+s,"è·³è½¬åˆ° "+a[0].basename):(t=`ğŸ”— ${a.length}ä¸ªæ–‡ä»¶`,`è·³è½¬åˆ°åŒ…å« @@${h.didaId} çš„ç¬”è®°æ–‡ä»¶ (${a.length}ä¸ª)`);let i=r.createEl("button",{text:t,cls:"dida-task-jump-btn mod-warning",title:e});i.onclick=async()=>{await this.plugin.jumpToDidaIdInFile(h.didaId,i)};var s=r.createEl("button",{cls:"dida-task-delete-link-btn",title:"åˆ é™¤markdownæ–‡æ¡£ä¸­çš„ä»»åŠ¡é“¾æ¥"});s.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',s.onclick=async t=>{t.stopPropagation(),t.preventDefault(),confirm("ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æ–‡ä»¶ä¸­çš„ä»»åŠ¡é“¾æ¥å—ï¼Ÿ")&&(await this.plugin.deleteDidaIdFromMarkdown(h.didaId),g.remove())}}}).catch(t=>{}),l.onclick=async()=>{var e=t.value.trim(),i=n.value.trim();if(e){var a=this.plugin.settings.tasks.findIndex(t=>t.didaId===h.didaId);if(-1!==a){let t=this.plugin.settings.tasks[a];t.title=e,t.content=i,t.desc=i,t.updatedAt=(new Date).toISOString(),await this.plugin.saveSettings();a=u.querySelector(".dida-timeline-task-title, .dida-timeline-task-completed");a&&this.renderTimelineTaskTitleContent(a,e),g.remove(),this.plugin.refreshTaskView(),setTimeout(()=>{this.plugin.syncTaskToDidaListInBackground(t)},0)}}},a.createDiv("check-items-tab"===p?"dida-tab-content active":"dida-tab-content"));d.id="check-items-tab";h.items&&h.items.length,h.items&&h.items.filter(t=>1===t.status).length,d.createDiv("dida-check-items-list");h.items&&0<h.items.length&&h.items.forEach((e,i)=>{let a=d.createDiv("dida-task-item dida-check-item"),s=a.createEl("input",{type:"checkbox",checked:1===e.status}),n=(s.onchange=()=>{e.status=s.checked?1:0;let t=this.plugin.settings.tasks.findIndex(t=>t.didaId===h.didaId);-1!==t&&(this.plugin.settings.tasks[t].items[i]=e,this.plugin.saveSettings(),this.plugin.settings.accessToken)&&this.plugin.settings.tasks[t].didaId&&setTimeout(()=>{this.plugin.syncTaskToDidaListInBackground(this.plugin.settings.tasks[t])},0),s.checked?(n.classList.remove("dida-task-title-input"),n.classList.add("dida-task-completed")):(n.classList.remove("dida-task-completed"),n.classList.add("dida-task-title-input"))},a.createEl("input",{type:"text",value:e.title,cls:1===e.status?"dida-task-completed":"dida-task-title-input",placeholder:"æ£€æŸ¥é¡¹æ ‡é¢˜"}));n.onchange=()=>{e.title=n.value;var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===h.didaId);-1!==t&&(this.plugin.settings.tasks[t].items[i]=e,this.plugin.saveSettings())};var t=a.createEl("button",{cls:"dida-task-delete"});t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',t.onclick=async t=>{t.stopPropagation(),t.preventDefault();t=this.plugin.settings.tasks.findIndex(t=>t.didaId===h.didaId);-1!==t&&(this.plugin.settings.tasks[t].items.splice(i,1),this.plugin.settings.tasks[t].updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&await this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t]),a.remove())}});y=d.createEl("button",{cls:"dida-project-add-task-btn"});y.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',y.style.position="absolute",y.style.top="0",y.style.right="0",y.title="æ·»åŠ æ£€æŸ¥é¡¹",y.onclick=()=>{var t,e=this.plugin.settings.tasks.findIndex(t=>t.didaId===h.didaId);-1!==e&&(this.plugin.settings.tasks[e].items||(this.plugin.settings.tasks[e].items=[]),t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"",status:0,sortOrder:this.plugin.settings.tasks[e].items.length},this.plugin.settings.tasks[e].items.push(t),this.plugin.saveSettings(),this.refreshTimelineCheckItemsArea(d,h))};let o=a.createDiv("subtasks-tab"===p?"dida-tab-content active":"dida-tab-content");o.id="subtasks-tab";w=this.plugin.settings.tasks.filter(t=>t.parentId===h.didaId),y=w.filter(t=>2!==t.status),p=(w.filter(t=>2===t.status).length,y.forEach((i,t)=>{var e=o.createDiv("dida-task-item dida-subtask-item");let a=e.createEl("input",{type:"checkbox",checked:2===i.status}),s=(a.onchange=()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);-1!==t&&(this.plugin.toggleTask(t),a.checked?(s.classList.remove("dida-task-title-input"),s.classList.add("dida-task-completed")):(s.classList.remove("dida-task-completed"),s.classList.add("dida-task-title-input")),a.checked)&&this.refreshTimelineSubtaskArea(o,h)},e.createEl("input",{type:"text",value:i.title,cls:2===i.status?"dida-task-completed":"dida-task-title-input",placeholder:"å­ä»»åŠ¡æ ‡é¢˜"}));s.onchange=()=>{let t=-1;-1!==(t=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.settings.tasks[t].title=s.value,this.plugin.settings.tasks[t].updatedAt=(new Date).toISOString(),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t]),this.plugin.refreshTaskView())};e=e.createEl("button",{cls:"dida-task-delete"});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',e.onclick=t=>{t.stopPropagation(),t.preventDefault();let e=-1;-1!==(e=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.deleteTask(e),this.refreshTimelineSubtaskArea(o,h))}}),o.createEl("button",{cls:"dida-project-add-task-btn"}));p.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',p.style.position="absolute",p.style.top="0",p.style.right="0",p.title="æ·»åŠ å­ä»»åŠ¡",p.onclick=async()=>{var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"æ–°å­ä»»åŠ¡",content:"",completed:!1,status:0,didaId:null,projectId:h.projectId,projectName:h.projectName,parentId:h.didaId||h.id,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[]};if(this.plugin.settings.tasks.push(t),this.plugin.saveSettings(),this.plugin.settings.accessToken)try{await this.plugin.createTaskInDidaList(t)}catch(t){}this.refreshTimelineSubtaskArea(o,h)};let c=t=>{a.querySelectorAll(".dida-tab-content").forEach(t=>{t.classList.remove("active")}),i.querySelectorAll(".dida-tab-btn").forEach(t=>{t.classList.remove("active")});var e=a.querySelector("#"+t),e=(e&&e.classList.add("active"),i.querySelector(`[data-tab="${t}"]`));e&&e.classList.add("active")};m.setAttribute("data-tab","task-tab"),m.onclick=()=>c("task-tab"),k.setAttribute("data-tab","check-items-tab"),k.onclick=()=>c("check-items-tab"),v.setAttribute("data-tab","subtasks-tab"),v.onclick=()=>c("subtasks-tab"),t.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),l.click())}),n.addEventListener("keydown",t=>{"Enter"===t.key&&t.ctrlKey&&(t.preventDefault(),l.click())}),setTimeout(()=>t.focus(),100)}}}refreshTimelineCheckItemsArea(r,l){r.empty();let d=this.plugin.settings.tasks.findIndex(t=>t.didaId===l.didaId);if(-1!==d){let n=this.plugin.settings.tasks[d];n.items&&n.items.length,n.items&&n.items.filter(t=>1===t.status).length;n.items&&0<n.items.length&&n.items.forEach((t,e)=>{var i=r.createDiv("dida-task-item dida-check-item");let a=i.createEl("input",{type:"checkbox",checked:1===t.status}),s=(a.onchange=()=>{t.status=a.checked?1:0,this.plugin.settings.tasks[d].items[e]=t,this.plugin.saveSettings(),this.plugin.syncTaskToDidaListInBackground(n),a.checked?(s.classList.remove("dida-task-title-input"),s.classList.add("dida-task-completed")):(s.classList.remove("dida-task-completed"),s.classList.add("dida-task-title-input"))},i.createEl("input",{type:"text",value:t.title,cls:1===t.status?"dida-task-completed":"dida-task-title-input",placeholder:"æ£€æŸ¥é¡¹æ ‡é¢˜"}));s.onchange=()=>{t.title=s.value,this.plugin.settings.tasks[d].items[e]=t,this.plugin.saveSettings()};i=i.createEl("button",{cls:"dida-task-delete"});i.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',i.onclick=async t=>{t.stopPropagation(),t.preventDefault(),this.plugin.settings.tasks[d].items.splice(e,1),this.plugin.settings.tasks[d].updatedAt=(new Date).toISOString(),await this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[d].didaId&&await this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[d]),this.refreshTimelineCheckItemsArea(r,l)}});var t=r.createEl("button",{cls:"dida-project-add-task-btn"});t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',t.style.position="absolute",t.style.top="0",t.style.right="0",t.title="æ·»åŠ æ£€æŸ¥é¡¹",t.onclick=()=>{this.plugin.settings.tasks[d].items||(this.plugin.settings.tasks[d].items=[]);var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"",status:0,sortOrder:this.plugin.settings.tasks[d].items.length};this.plugin.settings.tasks[d].items.push(t),this.plugin.saveSettings(),this.refreshTimelineCheckItemsArea(r,l)}}}refreshTimelineSubtaskArea(n,r){n.empty();var t=this.plugin.settings.tasks.filter(t=>r.didaId?t.parentId===r.didaId:t.parentId===r.id),e=t.filter(t=>2!==t.status),t=(t.filter(t=>2===t.status).length,e.forEach((i,t)=>{var e=n.createDiv("dida-task-item dida-subtask-item");let a=e.createEl("input",{type:"checkbox",checked:2===i.status}),s=(a.onchange=()=>{var t=this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId);-1!==t&&(this.plugin.toggleTask(t),a.checked?(s.classList.remove("dida-task-title-input"),s.classList.add("dida-task-completed")):(s.classList.remove("dida-task-completed"),s.classList.add("dida-task-title-input")),a.checked)&&this.refreshTimelineSubtaskArea(n,r)},e.createEl("input",{type:"text",value:i.title,cls:2===i.status?"dida-task-completed":"dida-task-title-input",placeholder:"å­ä»»åŠ¡æ ‡é¢˜"}));s.onchange=()=>{let t=-1;-1!==(t=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.settings.tasks[t].title=s.value,this.plugin.settings.tasks[t].updatedAt=(new Date).toISOString(),this.plugin.saveSettings(),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t]),this.plugin.refreshTaskView())};e=e.createEl("button",{cls:"dida-task-delete"});e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x-icon lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>',e.onclick=t=>{t.stopPropagation(),t.preventDefault();let e=-1;-1!==(e=i.didaId?this.plugin.settings.tasks.findIndex(t=>t.didaId===i.didaId):this.plugin.settings.tasks.findIndex(t=>t.id===i.id))&&(this.plugin.deleteTask(e),this.refreshTimelineSubtaskArea(n,r))}}),n.createEl("button",{cls:"dida-project-add-task-btn"}));t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',t.style.position="absolute",t.style.top="0",t.style.right="0",t.title="æ·»åŠ å­ä»»åŠ¡",t.onclick=async()=>{var t={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:"æ–°å­ä»»åŠ¡",content:"",completed:!1,status:0,didaId:null,projectId:r.projectId,projectName:r.projectName,parentId:r.didaId,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[]};if(this.plugin.settings.tasks.push(t),this.plugin.saveSettings(),this.plugin.settings.accessToken)try{await this.plugin.createTaskInDidaList(t)}catch(t){}this.refreshTimelineSubtaskArea(n,r)}}renderFloatingActionButton(t){t=t.createDiv("dida-timeline-fab");t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-plus-icon lucide-plus"><path d="M5 12h14"/><path d="M12 5v14"/></svg>',t.onclick=()=>{this.plugin.showAddTaskToProjectModal()}}async updateTimelineTaskDueDate(t,e,i){var a=this.plugin.app.workspace.getLeavesOfType("dida-task-view");0<a.length&&a[0].view.updateTaskDueDate?await a[0].view.updateTaskDueDate(t,e,i):(a=this.plugin.settings.tasks[t],await this.plugin.saveTaskDetails(t,a.title,a.content||a.desc||"","content",e,i),this.plugin.settings.accessToken&&this.plugin.settings.tasks[t].didaId&&setTimeout(async()=>{try{await this.plugin.updateTaskInDidaList(this.plugin.settings.tasks[t])}catch(t){}},0)),this.renderTimelineView()}showAddTaskModal(){new AddTaskModal(this.app,t=>{t={title:t,completed:!1,status:0,dueDate:this.selectedDate.toISOString(),projectName:"æ”¶é›†ç®±",projectId:"inbox",content:"",hasTime:!1};this.plugin.settings.tasks.push(t),this.plugin.saveSettings(),this.renderTimelineView()},"æ”¶é›†ç®±").open()}}class TaskActionMenu{constructor(t,e,i,a,s){this.app=t,this.plugin=e,this.editor=i,this.cursor=a,this.onAction=s,this.showingDateMenu=!1,this.menuElement=null,this.isOpen=!1,this.selectedIndex=0,this.menuItems=[],this.initialTaskInfo=this.extractInitialTaskInfo()}extractInitialTaskInfo(){try{if(!this.editor||!this.cursor)return null;var i=this.editor.getLine(this.cursor.line);if(!i)return null;var a=i.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/);if(!a)return null;let e=a[1];var s=this.plugin.settings.tasks.find(t=>t.didaId===e);if(!s)return null;var n,r=s.title||"";let t=null;s.dueDate&&(n=s.dueDate.match(/(\d{4}-\d{2}-\d{2})/),t=n?n[1]:null);var l=s.status||0;return{didaId:e,title:r,date:t,status:l,line:this.cursor.line}}catch(t){return null}}extractTaskInfo(){try{if(this.editor&&this.cursor){var t=this.editor.getLine(this.cursor.line);if(t){var e=t.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/),i=t.match(/^(\s*)-\s\[[ x]\]\s*(.+)$/);if(e&&i){var a=e[1];let t=i[2].trim();return{didaId:a,title:t=(t=t.replace(/\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-f0-9]+\)\s*/g,"").trim()).replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim(),line:this.cursor.line}}}}return null}catch(t){return null}}isSamePosition(t,e){return!(!this.editor||!this.cursor||this.editor!==t||this.cursor.line!==e.line||!t.getLine(e.line).match(/^(\s*)-\s\[\s\]\s(.*)$/))}open(){var t;this.isOpen&&this.menuElement||(0<(t=document.querySelectorAll(".task-action-menu-inline")).length&&t.forEach(t=>{t!==this.menuElement&&t.remove()}),this.createMenuElement(),this.positionMenu(),this.bindEvents(),this.isOpen=!0,this.showingDateMenu=!1,this.renderMainMenu())}createMenuElement(){this.menuElement=document.createElement("div"),this.menuElement.addClass("task-action-menu-inline"),document.body.appendChild(this.menuElement)}positionMenu(){if(this.menuElement&&this.editor)try{this.menuElement.style.position="fixed",this.menuElement.style.zIndex="1000",this.menuElement.style.visibility="visible";let t=null;if(this.editor.coordsAtPos&&"function"==typeof this.editor.coordsAtPos)try{t=this.editor.coordsAtPos(this.cursor)}catch(t){}if(!t&&this.editor.cm&&this.editor.cm.coordsAtPos)try{var e=this.editor.posToOffset(this.cursor);t=this.editor.cm.coordsAtPos(e)}catch(t){}if(!t&&this.editor.cursorCoords&&"function"==typeof this.editor.cursorCoords)try{t=this.editor.cursorCoords(!0,"window")}catch(t){}if(t&&void 0!==t.left&&void 0!==t.top)this.menuElement.style.left=t.left+"px",this.menuElement.style.top=t.top+20+"px";else{let t=null;if(this.editor.cm&&this.editor.cm.dom?t=this.editor.cm.dom:this.editor.getInputField&&"function"==typeof this.editor.getInputField?t=this.editor.getInputField():this.editor.dom&&(t=this.editor.dom),!t)return;{var i,a,s=t.querySelectorAll(".cm-line"),n=this.editor.getLine(this.cursor.line);let e=null;for(let t=0;t<s.length;t++)if(s[t].textContent.replace(/ğŸ“…\s*\d{4}-\d{2}-\d{2}/,"").replace(/\[\[.*?\]\]/g,"").trim()===n.replace(/ğŸ“…\s*\d{4}-\d{2}-\d{2}/,"").replace(/\[\[.*?\]\]/g,"").trim()){e=s[t];break}e?(i=e.getBoundingClientRect(),this.menuElement.style.left=i.left+"px",this.menuElement.style.top=i.bottom+5+"px"):(a=t.getBoundingClientRect(),this.menuElement.style.left=a.left+"px",this.menuElement.style.top=a.bottom+5+"px")}}var r,l=this.menuElement.getBoundingClientRect(),d=window.innerHeight,o=window.innerWidth;l.bottom>d&&(r=parseInt(this.menuElement.style.top),this.menuElement.style.top=r-l.height-40+"px"),o<l.right&&(this.menuElement.style.left=o-l.width-10+"px"),l.left<10&&(this.menuElement.style.left="10px")}catch(t){}}bindEvents(){this.keyHandler=t=>{"Escape"===t.key?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.close()):"ArrowDown"===t.key?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigateDown()):"ArrowUp"===t.key?(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.navigateUp()):"Enter"===t.key&&(t.preventDefault(),t.stopPropagation(),t.stopImmediatePropagation(),this.selectCurrentItem())},document.addEventListener("keydown",this.keyHandler,!0),this.clickOutsideHandler=t=>{this.menuElement&&!this.menuElement.contains(t.target)&&this.close()},setTimeout(()=>{document.addEventListener("click",this.clickOutsideHandler)},100),this.scrollHandler=()=>{this.isOpen&&this.menuElement&&this.positionMenu()};var t=this.editor?.cm?.scrollDOM||this.editor?.scrollDOM||document.querySelector(".workspace-leaf-content");t&&t.addEventListener("scroll",this.scrollHandler,{passive:!0}),window.addEventListener("scroll",this.scrollHandler,{passive:!0})}close(){var t;this.isOpen&&(this.detectAndSyncChanges(),this.keyHandler&&(document.removeEventListener("keydown",this.keyHandler,!0),this.keyHandler=null),this.clickOutsideHandler&&(document.removeEventListener("click",this.clickOutsideHandler),this.clickOutsideHandler=null),this.scrollHandler&&((t=this.editor?.cm?.scrollDOM||this.editor?.scrollDOM||document.querySelector(".workspace-leaf-content"))&&t.removeEventListener("scroll",this.scrollHandler),window.removeEventListener("scroll",this.scrollHandler),this.scrollHandler=null),this.menuElement&&(this.menuElement.remove(),this.menuElement=null),this.plugin&&this.plugin.currentTaskActionMenu===this&&(this.plugin.currentTaskActionMenu=null),this.isOpen=!1)}detectAndSyncChanges(){try{if(this.plugin&&this.plugin.settings&&this.plugin.settings.enableNativeTaskSync&&(this.editor&&this.cursor)){var d=this.editor.getLine(this.cursor.line);if(d){var o=d.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/);if(o){let i=o[1];let a=!!d.match(/^(\s*)-\s\[x\]/i)?2:0;var c=d.match(/^(\s*)-\s\[[ x]\]\s*(.+)$/);let t=c?c[2].trim():"";t=(t=t.replace(/\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-f0-9]+\)\s*/g,"").trim()).replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim();var h,u,p=/^(\s*)-\s\[[ x]\]\s*(.+)ğŸ“…\s*(\d{4}-\d{2}-\d{2})(.*)$/,g=d.match(p);let e=g?g[2].trim():t,s=g?g[3]:null,n=!1,r=!1,l=!1;this.initialTaskInfo?(t&&t!==this.initialTaskInfo.title&&(n=!0),h=this.initialTaskInfo.date||null,s!==h&&(r=!0),u=this.initialTaskInfo.status||0,a!==u&&(l=!0)):(n=!!t,r=!!s),n&&t?setTimeout(()=>{try{this.plugin.handleTitleChange(i,t)}catch(t){}},100):n,r&&s?setTimeout(()=>{try{this.plugin.handleDateChange(i,s,e)}catch(t){}},150):r,l&&setTimeout(async()=>{try{let t=this.plugin.settings.tasks.find(t=>t.didaId===i);var e;t&&(2==a&&RRuleParser.hasRepeatRule(t)?-1!==(e=this.plugin.settings.tasks.findIndex(t=>t.didaId===i))&&await this.plugin.toggleTask(e):(this.plugin.updateTaskStatusDirectly(t,a),await this.plugin.saveSettings(),this.plugin.refreshTaskView(),this.plugin.settings.accessToken&&setTimeout(async()=>{try{await this.plugin.toggleTaskInDidaList(t)}catch(t){}},0)))}catch(t){}},200)}}}}catch(t){}}async checkAndSyncTitleChange(){try{if(this.initialTaskInfo&&this.plugin.settings.enableNativeTaskSync){let t=this.extractTaskInfoFromLine(this.initialTaskInfo.line);t&&t.didaId===this.initialTaskInfo.didaId&&t.title!==this.initialTaskInfo.title&&(this.plugin.isTaskActionInProgress?setTimeout(()=>{this.plugin.handleTitleChange(t.didaId,t.title)},1e3):setTimeout(()=>{this.plugin.handleTitleChange(t.didaId,t.title)},100))}}catch(t){}}extractTaskInfoFromLine(e){try{if(this.editor){var t=this.editor.getLine(e);if(t){var i=t.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/),a=t.match(/^(\s*)-\s\[[ x]\]\s*(.+)$/);if(i&&a){var s=i[1];let t=a[2].trim();return{didaId:s,title:t=(t=t.replace(/\s*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=[a-f0-9]+\)\s*/g,"").trim()).replace(/\s*ğŸ“…\s*\d{4}-\d{2}-\d{2}\s*/g,"").trim(),line:e}}}}return null}catch(t){return null}}renderMainMenu(){var t,e;this.menuElement&&(this.menuElement.empty(),this.selectedIndex=0,this.menuItems=[],this.menuElement.createEl("div",{cls:"task-action-menu-title"}).textContent="é€‰æ‹©æ“ä½œ",(e=(t=this.menuElement.createEl("div",{cls:"task-action-menu-options"})).createEl("div",{cls:"task-action-menu-option",text:"ğŸ”— åŒæ­¥åˆ°æ»´ç­”"})).addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.close(),this.onAction("sync")}),this.menuItems.push(e),(e=t.createEl("div",{cls:"task-action-menu-option",text:"ğŸ“… åˆ°æœŸæ—¥æœŸ"})).addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.showingDateMenu=!0,this.renderDateMenu()}),this.menuItems.push(e),this.updateSelectedItem())}renderDateMenu(){if(this.menuElement){this.menuElement.empty(),this.selectedIndex=0,this.menuItems=[],this.menuElement.createEl("div",{cls:"task-action-menu-title"}).textContent="é€‰æ‹©æ—¥æœŸ",this.menuElement.createEl("div",{cls:"task-action-menu-back",text:"â† è¿”å›"}).addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.showingDateMenu=!1,this.renderMainMenu()});let i=this.menuElement.createEl("div",{cls:"task-action-menu-options"});this.getDateOptions().forEach(e=>{var t=i.createEl("div",{cls:"task-action-menu-option",text:e.label});t.addEventListener("click",t=>{t.preventDefault(),t.stopPropagation(),this.close(),this.onAction("date",{date:e.date})}),this.menuItems.push(t)}),this.updateSelectedItem()}}getDateOptions(){var t=new Date,e=[],i=(e.push({label:`ä»Šå¤© (${this.formatDate(t)})`,date:this.formatDate(t)}),new Date(t)),i=(i.setDate(t.getDate()+1),e.push({label:`æ˜å¤© (${this.formatDate(i)})`,date:this.formatDate(i)}),new Date(t)),i=(i.setDate(t.getDate()+2),e.push({label:`åå¤© (${this.formatDate(i)})`,date:this.formatDate(i)}),new Date(t)),a=(6-t.getDay()+7)%7,a=(0==a?i.setDate(t.getDate()+7):i.setDate(t.getDate()+a),e.push({label:`æ˜ŸæœŸå…­ (${this.formatDate(i)})`,date:this.formatDate(i)}),new Date(t)),i=(7-t.getDay())%7;return 0==i?a.setDate(t.getDate()+7):a.setDate(t.getDate()+i),e.push({label:`æ˜ŸæœŸæ—¥ (${this.formatDate(a)})`,date:this.formatDate(a)}),e}navigateDown(){0!==this.menuItems.length&&(this.selectedIndex=(this.selectedIndex+1)%this.menuItems.length,this.updateSelectedItem())}navigateUp(){0!==this.menuItems.length&&(this.selectedIndex=(this.selectedIndex-1+this.menuItems.length)%this.menuItems.length,this.updateSelectedItem())}updateSelectedItem(){0!==this.menuItems.length&&(this.menuItems.forEach(t=>{t.removeClass("task-action-menu-option-selected")}),this.menuItems[this.selectedIndex])&&(this.menuItems[this.selectedIndex].addClass("task-action-menu-option-selected"),this.menuItems[this.selectedIndex].scrollIntoView({block:"nearest",behavior:"smooth"}))}selectCurrentItem(){0!==this.menuItems.length&&this.menuItems[this.selectedIndex]&&this.menuItems[this.selectedIndex].click()}formatDate(t){return t.getFullYear()+`-${String(t.getMonth()+1).padStart(2,"0")}-`+String(t.getDate()).padStart(2,"0")}onClose(){var t=this.contentEl;t.empty()}}class AddTaskModal extends Modal{constructor(t,e,i="æ”¶é›†ç®±"){super(t),this.onSubmit=e,this.projectName=i}onOpen(){var t=this.contentEl;t.empty(),t.createEl("h2",{text:"æ·»åŠ æ–°ä»»åŠ¡åˆ° "+this.projectName});let e=t.createDiv().createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜"});e.style.width="100%",e.style.marginBottom="10px";t=t.createDiv();t.style.textAlign="right",t.createEl("button",{text:"å–æ¶ˆ"}).onclick=()=>this.close();let i=t.createEl("button",{text:"æ·»åŠ ",cls:"mod-cta"});i.style.marginLeft="10px",i.onclick=()=>{var t=e.value.trim();t&&(this.onSubmit(t),this.close())},e.addEventListener("keypress",t=>{"Enter"===t.key&&i.click()}),setTimeout(()=>e.focus(),100)}onClose(){var t=this.contentEl;t.empty()}}class DatePickerModal{constructor(t,e,i,a,s=null,n=null){this.app=t,this.currentDate=e?new Date(e):null,this.onDateSelect=i,this.triggerElement=a,this.selectedDate=this.currentDate,this.container=null,this.overlay=null,this.plugin=s,this.taskIndex=n,this.selectedDate?(this.isAllDay=0===this.selectedDate.getHours()&&0===this.selectedDate.getMinutes(),this.selectedHour=this.selectedDate.getHours(),this.selectedMinute=this.selectedDate.getMinutes()):(this.isAllDay=!1,t=new Date,this.selectedHour=t.getHours(),this.selectedMinute=t.getMinutes()),this.plugin&&null!=this.taskIndex&&(e=this.plugin.settings.tasks[this.taskIndex])&&("boolean"==typeof e.isAllDay&&(this.isAllDay=e.isAllDay),i=e.startDate||e.dueDate)&&(a=new Date(i),isNaN(a.getTime())||(this.selectedDate=a,this.selectedHour=a.getHours(),this.selectedMinute=a.getMinutes()));s=new Date,s.setHours(s.getHours()+1),n=5*Math.ceil(s.getMinutes()/5);60<=n?(s.setHours(s.getHours()+1),s.setMinutes(0)):s.setMinutes(n),this.endHour=s.getHours(),this.endMinute=s.getMinutes(),this.plugin&&null!==this.taskIndex&&(t=this.plugin.settings.tasks[this.taskIndex])&&t.dueDate&&(e=new Date(t.dueDate),isNaN(e.getTime())||(this.endHour=e.getHours(),this.endMinute=e.getMinutes()))}open(){this.createOverlay(),this.createContainer(),this.positionContainer(),this.renderContent(),this.setupEventListeners()}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="dida-calendar-overlay",document.body.appendChild(this.overlay)}createContainer(){this.container=document.createElement("div"),this.container.className="dida-calendar-popup",document.body.appendChild(this.container)}positionContainer(){if(this.triggerElement){var i=this.triggerElement.getBoundingClientRect();let t=i.bottom+5,e=i.left;t+400>window.innerHeight&&(t=i.top-400-5),(e=e+320>window.innerWidth?window.innerWidth-320-10:e)<10&&(e=10),this.container.style.position="fixed",this.container.style.top=t+"px",this.container.style.left=e+"px",this.container.style.zIndex="1000"}}renderContent(){this.container.innerHTML="";var t=this.container.createEl("h3",{cls:"dida-calendar-title"}),e=this.container.createEl("div",{cls:"dida-calendar-container"}),i=new Date,i=(this.displayYear=(this.selectedDate||i).getFullYear(),this.displayMonth=(this.selectedDate||i).getMonth(),this.renderCalendar(e),t.createEl("div",{cls:"dida-time-container"})),e=i.createEl("div",{cls:"dida-allday-container"}),a=e.createEl("input",{type:"checkbox",cls:"dida-allday-checkbox"});a.checked=this.isAllDay,e.createEl("label",{text:"å…¨å¤©",cls:"dida-allday-label"});let s=i.createEl("span",{text:"ï½œæ—¶é—´æ®µ",cls:"dida-time-label"}),n=i.createDiv("dida-time-select-container"),r=(n.style.cssText="display: inline-block; position: relative; margin-right: 5px;",n.createEl("div",{text:this.selectedHour.toString().padStart(2,"0"),cls:"dida-time-display"})),l=(r.style.cssText="font-size: 12px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); cursor: pointer; min-width: 25px; text-align: center; user-select: none;",n.createDiv("dida-time-dropdown"));l.style.cssText="font-size: 12px; position: absolute; top: 100%; left: 0; background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1003; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);";for(let i=0;i<24;i++){let t=l.createEl("div",{text:i.toString().padStart(2,"0"),cls:"dida-time-option"});t.style.cssText="padding: 5px 10px; cursor: pointer; border-bottom: 1px solid var(--background-modifier-border); user-select: none;",i===this.selectedHour&&(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"),t.onclick=t=>{t.stopPropagation(),this.selectedHour=i,r.textContent=i.toString().padStart(2,"0"),l.style.display="none",l.querySelectorAll(".dida-time-option").forEach((t,e)=>{e===i?(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"):(t.style.background="",t.style.color="")})},t.onmouseenter=()=>{i!==this.selectedHour&&(t.style.background="var(--background-modifier-hover)")},t.onmouseleave=()=>{i!==this.selectedHour&&(t.style.background="")}}r.onclick=t=>{t.stopPropagation();t="block"===l.style.display;l.style.display=t?"none":"block"};let d=i.createEl("span",{text:":"}),o=i.createDiv("dida-time-select-container"),c=(o.style.cssText="display: inline-block; position: relative; margin-left: 5px;",o.createEl("div",{text:(5*Math.floor(this.selectedMinute/5)).toString().padStart(2,"0"),cls:"dida-time-display"})),h=(c.style.cssText="font-size: 12px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); cursor: pointer; min-width: 25px; text-align: center; user-select: none;",o.createDiv("dida-time-dropdown"));h.style.cssText="font-size: 12px; position: absolute; top: 100%; left: 0; background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1003; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);";for(let i=0;i<60;i+=5){let t=h.createEl("div",{text:i.toString().padStart(2,"0"),cls:"dida-time-option"});t.style.cssText="padding: 5px 10px; cursor: pointer; border-bottom: 1px solid var(--background-modifier-border); user-select: none;",i===5*Math.floor(this.selectedMinute/5)&&(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"),t.onclick=t=>{t.stopPropagation(),this.selectedMinute=i,c.textContent=i.toString().padStart(2,"0"),h.style.display="none",h.querySelectorAll(".dida-time-option").forEach((t,e)=>{5*e===i?(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"):(t.style.background="",t.style.color="")})},t.onmouseenter=()=>{i!==5*Math.floor(this.selectedMinute/5)&&(t.style.background="var(--background-modifier-hover)")},t.onmouseleave=()=>{i!==5*Math.floor(this.selectedMinute/5)&&(t.style.background="")}}c.onclick=t=>{t.stopPropagation();t="block"===h.style.display;h.style.display=t?"none":"block"};let u=t.createEl("div",{cls:"dida-time-container"}),p=(u.createEl("span",{text:"ï½",cls:"dida-time-label"}),u.createDiv("dida-time-select-container")),g=(p.style.cssText="display: inline-block; position: relative; margin-right: 5px;",p.createEl("div",{text:this.endHour.toString().padStart(2,"0"),cls:"dida-time-display"})),m=(g.style.cssText="font-size: 12px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); cursor: pointer; min-width: 25px; text-align: center; user-select: none;",p.createDiv("dida-time-dropdown"));m.style.cssText="font-size: 12px; position: absolute; top: 100%; left: 0; background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1003; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);";for(let i=0;i<24;i++){let t=m.createEl("div",{text:i.toString().padStart(2,"0"),cls:"dida-time-option"});t.style.cssText="padding: 5px 10px; cursor: pointer; border-bottom: 1px solid var(--background-modifier-border); user-select: none;",i===this.endHour&&(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"),t.onclick=t=>{t.stopPropagation(),this.endHour=i,g.textContent=i.toString().padStart(2,"0"),m.style.display="none",m.querySelectorAll(".dida-time-option").forEach((t,e)=>{e===i?(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"):(t.style.background="",t.style.color="")})},t.onmouseenter=()=>{i!==this.endHour&&(t.style.background="var(--background-modifier-hover)")},t.onmouseleave=()=>{i!==this.endHour&&(t.style.background="")}}g.onclick=t=>{t.stopPropagation();t="block"===m.style.display;m.style.display=t?"none":"block"},u.createEl("span",{text:":"});let k=u.createDiv("dida-time-select-container"),v=(k.style.cssText="display: inline-block; position: relative; margin-left: 5px;",k.createEl("div",{text:(5*Math.floor(this.endMinute/5)).toString().padStart(2,"0"),cls:"dida-time-display"})),y=(v.style.cssText="font-size: 12px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-normal); cursor: pointer; min-width: 25px; text-align: center; user-select: none;",k.createDiv("dida-time-dropdown"));y.style.cssText="font-size: 12px; position: absolute; top: 100%; left: 0; background: var(--background-primary); border: 1px solid var(--background-modifier-border); border-radius: 4px; max-height: 150px; overflow-y: auto; z-index: 1003; display: none; box-shadow: 0 2px 8px rgba(0,0,0,0.1);";for(let i=0;i<60;i+=5){let t=y.createEl("div",{text:i.toString().padStart(2,"0"),cls:"dida-time-option"});t.style.cssText="padding: 5px 10px; cursor: pointer; border-bottom: 1px solid var(--background-modifier-border); user-select: none;",i===5*Math.floor(this.endMinute/5)&&(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"),t.onclick=t=>{t.stopPropagation(),this.endMinute=i,v.textContent=i.toString().padStart(2,"0"),y.style.display="none",y.querySelectorAll(".dida-time-option").forEach((t,e)=>{5*e===i?(t.style.background="var(--interactive-accent)",t.style.color="var(--text-on-accent)"):(t.style.background="",t.style.color="")})},t.onmouseenter=()=>{i!==5*Math.floor(this.endMinute/5)&&(t.style.background="var(--background-modifier-hover)")},t.onmouseleave=()=>{i!==5*Math.floor(this.endMinute/5)&&(t.style.background="")}}v.onclick=t=>{t.stopPropagation();t="block"===y.style.display;y.style.display=t?"none":"block"};let w=()=>{var t=!this.isAllDay;s.style.display=t?"inline-block":"none",n.style.display=t?"inline-block":"none",o.style.display=t?"inline-block":"none",d.style.display=t?"inline-block":"none",u.style.display=t?"flex":"none"},f=(w(),a.onchange=t=>{var e;this.selectedDate||((e=new Date).setHours(0,0,0,0),this.selectedDate=e),this.isAllDay=t.target.checked,w()},t=>{n.contains(t.target)||(l.style.display="none"),o.contains(t.target)||(h.style.display="none"),p.contains(t.target)||(m.style.display="none"),k.contains(t.target)||(y.style.display="none")});setTimeout(()=>{this.closeDropdownsHandler=f,document.addEventListener("click",f)},100);e=this.container.createEl("div",{cls:"dida-calendar-buttons"});e.createEl("button",{text:"æ¸…é™¤"}).onclick=async()=>{if(this.plugin&&null!=this.taskIndex){let t=this.plugin.settings.tasks[this.taskIndex];if(t){t.startDate,t.dueDate;t.startDate=null,t.dueDate=null,t.isAllDay=!1,t.repeatFlag=null,t.updatedAt=(new Date).toISOString();try{await this.plugin.saveSettings()}catch(t){}try{this.plugin.refreshTaskView&&this.plugin.refreshTaskView()}catch(t){}this.plugin.settings.accessToken&&t.didaId&&setTimeout(async()=>{try{await this.plugin.updateTaskInDidaList(t)}catch(t){}},0)}}else"function"==typeof this.onDateSelect&&this.onDateSelect(null,this.isAllDay);this.close()},e.createEl("button",{text:"ä»Šå¤©"}).onclick=()=>{var t=new Date;this.isAllDay?t.setHours(0,0,0,0):t.setHours(this.selectedHour,this.selectedMinute,0,0),this.onDateSelect(t,this.isAllDay),this.close()};let T=e.createEl("button",{text:"é‡å¤è®¾ç½®"});T.onclick=()=>{this.showRepeatSettings(T)},e.createEl("button",{text:"å–æ¶ˆ"}).onclick=()=>this.close(),e.createEl("button",{text:"ç¡®è®¤",cls:"mod-cta"}).onclick=()=>{if(this.selectedDate){var t=new Date(this.selectedDate);let e=null;if(!this.isAllDay&&this.plugin&&null!==this.taskIndex){var i=this.plugin.settings.tasks[this.taskIndex];if(i)if(this.onDateSelect.toString().includes("updateTaskStartDate")){var a=new Date(this.selectedDate),s=new Date(a.getFullYear(),a.getMonth(),a.getDate(),this.selectedHour,this.selectedMinute,0,0);let t=new Date(a.getFullYear(),a.getMonth(),a.getDate(),this.endHour,this.endMinute,0,0);var a=(t=t.getTime()<s.getTime()?new Date(s.getTime()+36e5):t).getFullYear(),s=String(t.getMonth()+1).padStart(2,"0"),n=String(t.getDate()).padStart(2,"0"),r=String(t.getHours()).padStart(2,"0"),l=String(t.getMinutes()).padStart(2,"0"),d=String(t.getSeconds()).padStart(2,"0"),o=t.getTimezoneOffset(),c=Math.abs(Math.floor(o/60)),h=Math.abs(o%60),o=(o<=0?"+":"-")+String(c).padStart(2,"0")+String(h).padStart(2,"0");i.dueDate=a+`-${s}-${n}T${r}:${l}:`+d+o,i.isAllDay=this.isAllDay,e=t}}if(!this.isAllDay&&!e){c=new Date(this.selectedDate),h=new Date(c.getFullYear(),c.getMonth(),c.getDate(),this.selectedHour,this.selectedMinute,0,0);let t=new Date(c.getFullYear(),c.getMonth(),c.getDate(),this.endHour,this.endMinute,0,0);t.getTime()<h.getTime()&&(t=new Date(h.getTime()+36e5)),e=t}this.isAllDay?t.setHours(0,0,0,0):t.setHours(this.selectedHour,this.selectedMinute,0,0),e?this.onDateSelect(t,this.isAllDay,e):this.onDateSelect(t,this.isAllDay)}this.close()}}setupEventListeners(){this.overlay.onclick=t=>{"SELECT"===t.target.tagName||t.target.closest("select")||t.target.closest(".dida-calendar-popup")||this.close()},this.container.onclick=t=>{"SELECT"===t.target.tagName||t.target.closest("select")||t.stopPropagation()},this.container.addEventListener("mousedown",t=>{"SELECT"!==t.target.tagName&&!t.target.closest("select")||t.stopPropagation()},!0),this.container.addEventListener("click",t=>{"SELECT"!==t.target.tagName&&!t.target.closest("select")||t.stopPropagation()},!0),this.escapeHandler=t=>{"Escape"===t.key&&this.close()},document.addEventListener("keydown",this.escapeHandler)}renderCalendar(s){s.empty();var t=s.createDiv("dida-calendar-nav");t.createEl("button",{text:"â€¹"}).onclick=()=>{this.displayMonth--,this.displayMonth<0&&(this.displayMonth=11,this.displayYear--),this.renderCalendar(s)},t.createEl("span",{text:`${this.displayYear}å¹´${this.displayMonth+1}æœˆ`,cls:"dida-calendar-month-label"});t.createEl("button",{text:"â€º"}).onclick=()=>{this.displayMonth++,11<this.displayMonth&&(this.displayMonth=0,this.displayYear++),this.renderCalendar(s)};let e=s.createDiv("dida-calendar-week-header");["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach(t=>{e.createEl("div",{text:t,cls:"dida-calendar-week-day"})});var n=s.createDiv("dida-calendar-grid"),t=new Date(this.displayYear,this.displayMonth,1),r=(new Date(this.displayYear,this.displayMonth+1,0),new Date(t));r.setDate(r.getDate()-t.getDay());for(let a=0;a<6;a++)for(let i=0;i<7;i++){let t=new Date(r),e=(t.setDate(r.getDate()+7*a+i),n.createEl("div",{text:t.getDate().toString(),cls:"dida-calendar-day"}));t.getMonth()!==this.displayMonth&&e.classList.add("other-month");var l=new Date;l.setHours(0,0,0,0),t.setHours(0,0,0,0),t.getTime()===l.getTime()&&e.classList.add("today"),this.selectedDate&&((l=new Date(this.selectedDate)).setHours(0,0,0,0),t.getTime()===l.getTime())&&e.classList.add("selected"),e.onclick=()=>{s.querySelectorAll(".dida-calendar-day.selected").forEach(t=>{t.classList.remove("selected")}),e.classList.add("selected"),this.selectedDate=new Date(t)}}}close(){this.closeDropdownsHandler&&(document.removeEventListener("click",this.closeDropdownsHandler),this.closeDropdownsHandler=null),this.overlay&&(this.overlay.remove(),this.overlay=null),this.container&&(this.container.remove(),this.container=null),this.escapeHandler&&(document.removeEventListener("keydown",this.escapeHandler),this.escapeHandler=null)}showRepeatSettings(t=null){new CompactRepeatSettings(this.app,e=>{if(this.repeatFlag=e,void 0!==this.taskIndex&&this.plugin){let t=this.plugin.settings.tasks[this.taskIndex];if(t){t.repeatFlag=e,t.updatedAt=(new Date).toISOString(),this.plugin.saveSettings(),this.plugin.refreshTaskView();try{var i=this.plugin.getTaskViewSafely();i&&i.updateTaskRowRepeatRule&&i.updateTaskRowRepeatRule(t)}catch(t){}this.plugin.settings.accessToken&&t.didaId&&setTimeout(async()=>{try{await this.plugin.updateTaskInDidaList(t)}catch(t){}},0)}}},t).show()}}class CompactRepeatSettings{constructor(t,e,i=null){this.app=t,this.onRepeatSet=e,this.triggerElement=i,this.repeatType="none",this.interval=1,this.weekDay=0,this.monthDay=1,this.month=1,this.overlay=null,this.container=null}show(){this.createOverlay(),this.createContainer(),this.positionContainer(),this.renderContent(),this.addEventListeners(),document.body.appendChild(this.overlay),requestAnimationFrame(()=>{this.overlay.classList.add("show")})}hide(){this.overlay&&(this.overlay.classList.remove("show"),setTimeout(()=>{this.overlay&&this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay),this.overlay=null,this.container=null},200))}createOverlay(){this.overlay=document.createElement("div"),this.overlay.className="dida-compact-repeat-overlay"}createContainer(){this.container=document.createElement("div"),this.container.className="dida-compact-repeat-container",this.overlay.appendChild(this.container)}positionContainer(){if(this.triggerElement){var i=this.triggerElement.getBoundingClientRect();let t=i.top-200-50,e=i.left+i.width/2-140-25;t<10&&(t=i.bottom+10),e<10?e=10:e+280>window.innerWidth-10&&(e=window.innerWidth-280-10),this.container.style.position="fixed",this.container.style.top=t+"px",this.container.style.left=e+"px",this.container.style.zIndex="10001",this.overlay.style.justifyContent="flex-start",this.overlay.style.alignItems="flex-start"}}renderContent(){this.container.innerHTML="";var t=document.createElement("div");t.className="dida-compact-repeat-title",t.textContent="é‡å¤è®¾ç½®",this.container.appendChild(t);let i=document.createElement("div");i.className="dida-compact-repeat-types";[{value:"none",label:"ä¸é‡å¤"},{value:"daily",label:"æ¯å¤©"},{value:"weekly",label:"æ¯å‘¨"},{value:"monthly",label:"æ¯æœˆ"},{value:"yearly",label:"æ¯å¹´"}].forEach(t=>{var e=document.createElement("button");e.className="dida-compact-repeat-type-btn",t.value===this.repeatType&&e.classList.add("active"),e.textContent=t.label,e.onclick=()=>this.selectType(t.value),i.appendChild(e)}),this.container.appendChild(i),"none"!==this.repeatType&&this.renderDetails();var t=document.createElement("div"),e=(t.className="dida-compact-repeat-buttons",document.createElement("button")),a=(e.className="dida-compact-repeat-btn cancel",e.textContent="å–æ¶ˆ",e.onclick=()=>this.hide(),document.createElement("button"));a.className="dida-compact-repeat-btn confirm",a.textContent="ç¡®è®¤",a.onclick=()=>this.confirm(),t.appendChild(e),t.appendChild(a),this.container.appendChild(t)}renderDetails(){var t=this.container.querySelector(".dida-compact-repeat-details"),e=(t&&t.remove(),document.createElement("div"));switch(e.className="dida-compact-repeat-details",this.repeatType){case"daily":this.renderDailyDetails(e);break;case"weekly":this.renderWeeklyDetails(e);break;case"monthly":this.renderMonthlyDetails(e);break;case"yearly":this.renderYearlyDetails(e)}t=this.container.querySelector(".dida-compact-repeat-buttons");this.container.insertBefore(e,t)}renderDailyDetails(t){var e=document.createElement("div");e.className="dida-compact-interval-container",e.innerHTML=`
            <label>æ¯</label>
            <input type="number" min="1" max="365" value="${this.interval}" class="interval-input">
            <label>å¤©</label>
        `;let i=e.querySelector(".interval-input");i.onchange=()=>{this.interval=parseInt(i.value)||1},t.appendChild(e)}renderWeeklyDetails(t){var e=document.createElement("div");e.className="dida-compact-interval-container",e.innerHTML=`
            <label>æ¯</label>
            <input type="number" min="1" max="52" value="${this.interval}" class="interval-input">
            <label>å‘¨</label>
        `;let i=e.querySelector(".interval-input"),a=(i.onchange=()=>{this.interval=parseInt(i.value)||1},t.appendChild(e),document.createElement("div"));a.className="dida-compact-weekday-container";["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach((t,e)=>{let i=document.createElement("button");i.className="dida-compact-weekday-btn",i.textContent=t,e===this.weekDay&&i.classList.add("active"),i.onclick=()=>{a.querySelectorAll(".dida-compact-weekday-btn").forEach(t=>t.classList.remove("active")),i.classList.add("active"),this.weekDay=e},a.appendChild(i)}),t.appendChild(a)}renderMonthlyDetails(t){var e=document.createElement("div");e.className="dida-compact-interval-container",e.innerHTML=`
            <label>æ¯</label>
            <input type="number" min="1" max="12" value="${this.interval}" class="interval-input">
            <label>æœˆçš„ç¬¬</label>
            <input type="number" min="1" max="31" value="${this.monthDay}" class="day-input">
            <label>æ—¥</label>
        `;let i=e.querySelector(".interval-input"),a=e.querySelector(".day-input");i.onchange=()=>{this.interval=parseInt(i.value)||1},a.onchange=()=>{this.monthDay=parseInt(a.value)||1},t.appendChild(e)}renderYearlyDetails(t){var e=document.createElement("div");e.className="dida-compact-interval-container",e.innerHTML=`
            <label>æ¯</label>
            <input type="number" min="1" max="10" value="${this.interval}" class="interval-input">
            <label>å¹´çš„</label>
            <input type="number" min="1" max="12" value="${this.month}" class="month-input">
            <label>æœˆ</label>
            <input type="number" min="1" max="31" value="${this.monthDay}" class="day-input">
            <label>æ—¥</label>
        `;let i=e.querySelector(".interval-input"),a=e.querySelector(".month-input"),s=e.querySelector(".day-input");i.onchange=()=>{this.interval=parseInt(i.value)||1},a.onchange=()=>{this.month=parseInt(a.value)||1},s.onchange=()=>{this.monthDay=parseInt(s.value)||1},t.appendChild(e)}selectType(t){this.repeatType=t,this.renderContent()}addEventListeners(){this.overlay.onclick=t=>{t.target===this.overlay&&this.hide()},this.escapeHandler=t=>{"Escape"===t.key&&this.hide()},document.addEventListener("keydown",this.escapeHandler)}confirm(){let t="";"none"!==this.repeatType&&(t=this.generateRRule()),this.onRepeatSet&&this.onRepeatSet(t),this.hide()}generateRRule(){let t="RRULE:";switch(this.repeatType){case"daily":t+="FREQ=DAILY;INTERVAL="+this.interval;break;case"weekly":t+=`FREQ=WEEKLY;INTERVAL=${this.interval};BYDAY=`+["SU","MO","TU","WE","TH","FR","SA"][this.weekDay];break;case"monthly":t+=`FREQ=MONTHLY;INTERVAL=${this.interval};BYMONTHDAY=`+this.monthDay;break;case"yearly":t+=`FREQ=YEARLY;INTERVAL=${this.interval};BYMONTH=${this.month};BYMONTHDAY=`+this.monthDay}return t}destroy(){this.escapeHandler&&document.removeEventListener("keydown",this.escapeHandler),this.hide()}}class RepeatSettingsModal extends Modal{constructor(t,e){super(t),this.onRepeatSet=e,this.repeatType="none",this.interval=1,this.weekDay=0,this.monthDay=1,this.month=1,this.yearWeekDay=0,this.yearWeekNumber=1}onOpen(){var t=this.contentEl,e=(t.empty(),t.addClass("dida-repeat-settings-modal"),t.createEl("h2",{text:"é‡å¤è®¾ç½®"}),t.createDiv("dida-repeat-type-container"));e.createEl("h3",{text:"é‡å¤ç±»å‹"});let i=e.createEl("select",{cls:"dida-repeat-type-select"}),a=([{value:"none",label:"ä¸é‡å¤"},{value:"daily",label:"æ¯å¤©"},{value:"weekly",label:"æ¯å‘¨"},{value:"monthly",label:"æ¯æœˆ"},{value:"yearly",label:"æ¯å¹´"},{value:"custom",label:"è‡ªå®šä¹‰"}].forEach(t=>{var e=i.createEl("option",{value:t.value,text:t.label});t.value===this.repeatType&&(e.selected=!0)}),t.createDiv("dida-repeat-details-container"));i.onchange=()=>{this.repeatType=i.value,this.renderDetails(a)},this.renderDetails(a);e=t.createDiv("dida-repeat-buttons");e.createEl("button",{text:"å–æ¶ˆ"}).onclick=()=>this.close(),e.createEl("button",{text:"ç¡®è®¤",cls:"mod-cta"}).onclick=()=>{var t=this.generateRRULE();this.onRepeatSet(t),this.close()}}renderDetails(t){t.empty(),"none"!==this.repeatType&&("daily"===this.repeatType?this.renderDailySettings(t):"weekly"===this.repeatType?this.renderWeeklySettings(t):"monthly"===this.repeatType?this.renderMonthlySettings(t):"yearly"===this.repeatType?this.renderYearlySettings(t):"custom"===this.repeatType&&this.renderCustomSettings(t))}renderDailySettings(t){t=t.createDiv("dida-daily-settings"),t.createEl("h4",{text:"æ¯æ—¥é‡å¤è®¾ç½®"}),t=t.createDiv("dida-interval-container");t.createEl("span",{text:"æ¯"});let e=t.createEl("input",{type:"number",value:this.interval.toString(),cls:"dida-interval-input"});e.min="1",e.max="365",e.onchange=()=>{this.interval=parseInt(e.value)||1},t.createEl("span",{text:"å¤©é‡å¤ä¸€æ¬¡"})}renderWeeklySettings(t){var t=t.createDiv("dida-weekly-settings"),e=(t.createEl("h4",{text:"æ¯å‘¨é‡å¤è®¾ç½®"}),t.createDiv("dida-interval-container"));e.createEl("span",{text:"æ¯"});let i=e.createEl("input",{type:"number",value:this.interval.toString(),cls:"dida-interval-input"});i.min="1",i.max="52",i.onchange=()=>{this.interval=parseInt(i.value)||1},e.createEl("span",{text:"å‘¨é‡å¤ä¸€æ¬¡"});e=t.createDiv("dida-weekday-container");e.createEl("span",{text:"åœ¨æ˜ŸæœŸï¼š"});let a=e.createEl("select",{cls:"dida-weekday-select"});["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach((t,e)=>{t=a.createEl("option",{value:e.toString(),text:"æ˜ŸæœŸ"+t});e===this.weekDay&&(t.selected=!0)}),a.onchange=()=>{this.weekDay=parseInt(a.value)}}renderMonthlySettings(t){var t=t.createDiv("dida-monthly-settings"),e=(t.createEl("h4",{text:"æ¯æœˆé‡å¤è®¾ç½®"}),t.createDiv("dida-interval-container"));e.createEl("span",{text:"æ¯"});let i=e.createEl("input",{type:"number",value:this.interval.toString(),cls:"dida-interval-input"});i.min="1",i.max="12",i.onchange=()=>{this.interval=parseInt(i.value)||1},e.createEl("span",{text:"æœˆé‡å¤ä¸€æ¬¡"});e=t.createDiv("dida-monthday-container");e.createEl("span",{text:"åœ¨æ¯æœˆç¬¬"});let a=e.createEl("input",{type:"number",value:this.monthDay.toString(),cls:"dida-monthday-input"});a.min="1",a.max="31",a.onchange=()=>{this.monthDay=parseInt(a.value)||1},e.createEl("span",{text:"æ—¥"})}renderYearlySettings(t){var t=t.createDiv("dida-yearly-settings"),e=(t.createEl("h4",{text:"æ¯å¹´é‡å¤è®¾ç½®"}),t.createDiv("dida-interval-container"));e.createEl("span",{text:"æ¯"});let i=e.createEl("input",{type:"number",value:this.interval.toString(),cls:"dida-interval-input"});i.min="1",i.max="10",i.onchange=()=>{this.interval=parseInt(i.value)||1},e.createEl("span",{text:"å¹´é‡å¤ä¸€æ¬¡"});e=t.createDiv("dida-month-container");e.createEl("span",{text:"åœ¨"});let a=e.createEl("select",{cls:"dida-month-select"});for(let t=1;t<=12;t++){var s=a.createEl("option",{value:t.toString(),text:t+"æœˆ"});t===this.month&&(s.selected=!0)}a.onchange=()=>{this.month=parseInt(a.value)};e=t.createDiv("dida-yearday-container");e.createEl("span",{text:"ç¬¬"});let n=e.createEl("input",{type:"number",value:this.monthDay.toString(),cls:"dida-yearday-input"});n.min="1",n.max="31",n.onchange=()=>{this.monthDay=parseInt(n.value)||1},e.createEl("span",{text:"æ—¥"});e=t.createDiv("dida-or-container");e.createEl("span",{text:"æˆ–è€…é€‰æ‹©ç¬¬"});let r=e.createEl("input",{type:"number",value:this.yearWeekNumber.toString(),cls:"dida-week-number-input"});r.min="1",r.max="5",r.onchange=()=>{this.yearWeekNumber=parseInt(r.value)||1},e.createEl("span",{text:"ä¸ª"});let l=e.createEl("select",{cls:"dida-year-weekday-select"});["æ—¥","ä¸€","äºŒ","ä¸‰","å››","äº”","å…­"].forEach((t,e)=>{t=l.createEl("option",{value:e.toString(),text:"æ˜ŸæœŸ"+t});e===this.yearWeekDay&&(t.selected=!0)}),l.onchange=()=>{this.yearWeekDay=parseInt(l.value)}}renderCustomSettings(t){t=t.createDiv("dida-custom-settings"),t.createEl("h4",{text:"è‡ªå®šä¹‰é‡å¤è®¾ç½®"}),t=t.createDiv("dida-rrule-container"),t.createEl("label",{text:"ç›´æ¥è¾“å…¥RRULEæ ¼å¼ï¼š"}),t=t.createEl("textarea",{cls:"dida-rrule-input",placeholder:"ä¾‹å¦‚ï¼šRRULE:FREQ=DAILY;INTERVAL=1"});t.rows=3,this.customRRule=t}generateRRULE(){if("none"===this.repeatType)return"";if("custom"===this.repeatType)return this.customRRule?this.customRRule.value.trim():"";let t="RRULE:";switch(this.repeatType){case"daily":t+="FREQ=DAILY;INTERVAL="+this.interval;break;case"weekly":t+=`FREQ=WEEKLY;WKST=SU;INTERVAL=${this.interval};BYDAY=`+["SU","MO","TU","WE","TH","FR","SA"][this.weekDay];break;case"monthly":t+=`FREQ=MONTHLY;INTERVAL=${this.interval};BYMONTHDAY=`+this.monthDay;break;case"yearly":0<this.yearWeekNumber&&0<=this.yearWeekDay?t+=`FREQ=YEARLY;INTERVAL=${this.interval};BYMONTH=${this.month};BYDAY=`+this.yearWeekNumber+["SU","MO","TU","WE","TH","FR","SA"][this.yearWeekDay]:t+=`FREQ=YEARLY;INTERVAL=${this.interval};BYMONTH=${this.month};BYMONTHDAY=`+this.monthDay}return t}onClose(){var t=this.contentEl;t.empty()}}class AuthUrlModal extends Modal{constructor(t,e,i){super(t),this.authUrl=e,this.redirectUri=i}onOpen(){var t=this.contentEl,e=(t.empty(),t.createEl("h2",{text:"OAuthè®¤è¯"}),t.createEl("p",{text:"æ— æ³•è‡ªåŠ¨æ‰“å¼€æµè§ˆå™¨ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶ä»¥ä¸‹é“¾æ¥åˆ°æµè§ˆå™¨ä¸­å®Œæˆè®¤è¯ï¼š"}),t.createDiv());e.style.cssText="background: #f5f5f5; padding: 10px; border-radius: 5px; margin: 10px 0; word-break: break-all;",e.createEl("code",{text:this.authUrl}),t.createEl("button",{text:"å¤åˆ¶é“¾æ¥"}).onclick=()=>{navigator.clipboard.writeText(this.authUrl)},t.createEl("h3",{text:"é‡è¦æç¤ºï¼š"}),t.createEl("p",{text:"è¯·ç¡®ä¿åœ¨æ»´ç­”æ¸…å•å¼€å‘è€…åå°é…ç½®çš„é‡å®šå‘URIä¸ºï¼š"+this.redirectUri}),t.createEl("p",{text:"å®Œæˆè®¤è¯åï¼Œæµè§ˆå™¨ä¼šè‡ªåŠ¨è·³è½¬åˆ°æœ¬åœ°æœåŠ¡å™¨å®Œæˆæˆæƒæµç¨‹ã€‚"}),t.createEl("button",{text:"å…³é—­"}).onclick=()=>this.close()}onClose(){var t=this.contentEl;t.empty()}}class DidaSyncSettingTab extends PluginSettingTab{constructor(t,e){super(t,e),this.plugin=e}display(){var t=this.containerEl,e=(t.empty(),t.createEl("h2",{text:"æ»´ç­”æ¸…å•åŒæ­¥è®¾ç½®"}),t.createDiv()),i=(e.createEl("h3",{text:"OAuthé…ç½®"}),e.createDiv()),i=(i.style.cssText="margin: 10px 0;",i.createEl("p",{text:"ç¬¬1æ­¥ï¼šè¯·å¤åˆ¶ä¸‹é¢çš„é“¾æ¥åˆ°æµè§ˆå™¨â†’è¿›å…¥åˆ°æ»´ç­”æ¸…å•å¼€å‘è€…åå°ï¼ˆéœ€è¦ç™»å…¥ä½ çš„æ»´ç­”æ¸…å•è´¦å·ï¼‰â†’Manage Appsåˆ›å»ºåº”ç”¨â†’è‡ªåŠ¨è·å–Client IDå’ŒClient Secretâ†’å¡«å…¥åˆ°ä¸‹é¢çš„è®¾ç½®çª—å£"}),i.createDiv());i.style.cssText="display: flex; align-items: center; gap: 10px; background: transparent; padding: 8px; border-radius: 5px;",i.createEl("code",{text:"https://developer.dida365.com/manage"});i.createEl("button",{text:"å¤åˆ¶",cls:"mod-small"}).onclick=()=>{navigator.clipboard.writeText("https://developer.dida365.com/manage"),new Notice("å¼€å‘è€…åå°é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿")};i=e.createDiv(),i.style.cssText="margin: 10px 0;",i.createEl("p",{text:"ç¬¬2æ­¥ï¼šè¯·å°†ä¸‹é¢çš„URIå¤åˆ¶ç²˜è´´åˆ°æ»´ç­”æ¸…å•å¼€å‘è€…åå°çš„OAuth redirect URLâ†’Saveä¿å­˜â†’ç‚¹å‡»OAuthè®¤è¯æŒ‰é’®"}),i=e.createDiv(),i.style.cssText="background: transparent; padding: 10px; border-radius: 5px; margin: 10px 0;",i.createEl("strong",{text:"é‡å®šå‘URIé…ç½®ï¼š"}),i.createEl("br"),e=i.createDiv();e.style.cssText="display: flex; align-items: center; gap: 10px; margin: 5px 0;",e.createEl("code",{text:`http://localhost:${this.plugin.settings.serverPort}/callback`}),e.createEl("button",{text:"å¤åˆ¶",cls:"mod-small"}).onclick=()=>{navigator.clipboard.writeText(`http://localhost:${this.plugin.settings.serverPort}/callback`),new Notice("é‡å®šå‘URIå·²å¤åˆ¶åˆ°å‰ªè´´æ¿")};i.createEl("p").innerHTML='ä¸Šè¿°æ–‡å­—æ•™ç¨‹è‹¥æœ‰ä¸æ˜ï¼Œå¯ä»¥<a href="https://ytmaps.vip/paly/guide/DidaSync%E9%AA%8C%E8%AF%81%E6%95%99%E7%A8%8B.html" target="_blank">ç‚¹å‡»è¿™é‡Œè§‚çœ‹è§†é¢‘æ•™ç¨‹</a><br><font color="#c87902ff">â‰ï¸è‹¥ç½‘é¡µæ˜¾ç¤ºè®¤è¯æˆåŠŸï¼Œä½†æ˜¯æ’ä»¶è®¾ç½®è¿˜æ˜¾ç¤ºâ€œæœªè®¤è¯â€ï¼Œä¸è¦ç€æ€¥ï¼Œç­‰å¾…ä¸€ä¼šå„¿é‡å¯Obsidian</font><br>ç¡®ä¿ä½ çš„ç½‘ç»œç¯å¢ƒæ­£å¸¸ï¼ˆç§‘å­¦ä¸Šç½‘ã€æ ¡å›­ç½‘æˆ–å¯¼è‡´è®¤è¯å¤±è´¥ï¼‰',new Setting(t).setName("Client ID").setDesc("æ»´ç­”æ¸…å•åº”ç”¨çš„Client ID").addText(t=>t.setPlaceholder("è¾“å…¥Client ID").setValue(this.plugin.settings.clientId).onChange(async t=>{this.plugin.settings.clientId=t,await this.plugin.saveSettings()})),new Setting(t).setName("Client Secret").setDesc("æ»´ç­”æ¸…å•åº”ç”¨çš„Client Secret").addText(t=>t.setPlaceholder("è¾“å…¥Client Secret").setValue(this.plugin.settings.clientSecret).onChange(async t=>{this.plugin.settings.clientSecret=t,await this.plugin.saveSettings()})),new Setting(t).setName("æœåŠ¡å™¨ç«¯å£").setDesc("OAuthå›è°ƒæœåŠ¡å™¨ç«¯å£ï¼ˆä¿®æ”¹åéœ€è¦æ›´æ–°é‡å®šå‘URIé…ç½®ï¼‰").addText(t=>{var e=debounce(async t=>{t=parseInt(t)||8080;this.plugin.settings.serverPort=t,await this.plugin.saveSettings(),this.updateRedirectUriDisplay(t)},300);t.setPlaceholder("8080").setValue(this.plugin.settings.serverPort.toString()).onChange(e)}),new Setting(t).setName("OAuthè®¤è¯").setDesc("ç‚¹å‡»å¼€å§‹OAuthè®¤è¯æµç¨‹").addButton(t=>t.setButtonText("å¼€å§‹è®¤è¯").onClick(()=>{this.plugin.startOAuthFlow()}));e=t.createDiv(),e.style.cssText="margin: 10px 0; padding: 10px; border-radius: 5px;",this.plugin.settings.accessToken?(e.style.color="#06dc38ff",e.textContent="âœ“ å·²è®¤è¯"):(e.style.backgroundColor="#f8d7da",e.style.color="#c30014ff",e.textContent="âœ— æœªè®¤è¯"),t.createEl("h3",{text:"åˆæ¬¡ä½¿ç”¨"}),t.createEl("p",{text:"ç‚¹å‡»çª—å£å³ä¸‹è§’çŠ¶æ€æ â€œæ»´ç­”æ¸…å•â€å›¾æ ‡æ‰“å¼€æ»´ç­”ä»»åŠ¡æ¸…å•"}),t.createEl("h3",{text:"åŒæ­¥è®¾ç½®"}),new Setting(t).setName("è‡ªåŠ¨åŒæ­¥").setDesc("å¯ç”¨åä¼šå®šæœŸä»æ»´ç­”æ¸…å•åŒæ­¥ä»»åŠ¡").addToggle(t=>t.setValue(this.plugin.settings.autoSync).onChange(async t=>{this.plugin.settings.autoSync=t,await this.plugin.saveSettings(),this.plugin.setupAutoSync()})),new Setting(t).setName("æ˜¾ç¤ºå½’æ¡£é¡¹ç›®").setDesc("é€‰æ‹©æ˜¯å¦åœ¨ä»»åŠ¡æ¸…å•ä¸­æ˜¾ç¤ºå·²å½’æ¡£çš„é¡¹ç›®").addDropdown(t=>t.addOption("false","éšè—å½’æ¡£é¡¹ç›®").addOption("true","æ˜¾ç¤ºå½’æ¡£é¡¹ç›®").setValue(this.plugin.settings.showArchivedProjects.toString()).onChange(async t=>{this.plugin.settings.showArchivedProjects="true"===t,await this.plugin.saveSettings(),this.plugin.refreshTaskView()})),new Setting(t).setName("åŒæ­¥é—´éš”").setDesc("è‡ªåŠ¨ä»æ»´ç­”æ¸…å•åŒæ­¥çš„é—´éš”æ—¶é—´ï¼ˆåˆ†é’Ÿï¼‰").addSlider(t=>t.setLimits(5,120,5).setValue(this.plugin.settings.syncInterval).setDynamicTooltip().onChange(async t=>{this.plugin.settings.syncInterval=t,await this.plugin.saveSettings(),this.plugin.setupAutoSync()})),new Setting(t).setName("æ‰‹åŠ¨åŒæ­¥").setDesc("ç«‹å³æ‰§è¡ŒåŒå‘åŒæ­¥").addButton(t=>t.setButtonText("å¼€å§‹åŒæ­¥").onClick(async()=>{this.plugin.isPluginActivated?this.plugin.manualSync():await this.plugin.checkPluginStatusAndNotify()})),t.createEl("h3",{text:"ä¸»ä»»åŠ¡è§†å›¾è®¾ç½®"}),new Setting(t).setName("é»˜è®¤è§†å›¾æ¨¡å¼").setDesc("å³ä¾§è¾¹æ æ‰“å¼€ä»»åŠ¡æ¸…å•æ—¶é»˜è®¤æ˜¾ç¤ºçš„è§†å›¾ç±»å‹").addDropdown(t=>t.addOption("task","ä»»åŠ¡åˆ—è¡¨").addOption("timeblock","æ—¶é—´æ®µè§†å›¾").setValue(this.plugin.settings.defaultViewMode||"task").onChange(async t=>{this.plugin.settings.defaultViewMode=t,await this.plugin.saveSettings()})),new Setting(t).setName("æ—¶é—´å—æ¯å°æ—¶é«˜åº¦").setDesc("æ—¶é—´æ®µè§†å›¾ä¸­æ¯å°æ—¶çš„é«˜åº¦ï¼ˆåƒç´ ï¼‰ï¼Œè°ƒæ•´åéœ€è¦åˆ‡æ¢è§†å›¾æ‰èƒ½ç”Ÿæ•ˆ").addSlider(t=>t.setLimits(50,100,5).setValue(this.plugin.settings.timeBlockHourHeight||80).setDynamicTooltip().onChange(async t=>{this.plugin.settings.timeBlockHourHeight=t,await this.plugin.saveSettings(),document.documentElement.style.setProperty("--dida-hour-height",t+"px")})),new Setting(t).setName("æ—¶é—´æ®µè§†å›¾èµ·å§‹æ—¶é—´").setDesc("è‡ªå®šä¹‰è®¾ç½®æ—¶é—´æ®µè§†å›¾çš„èµ·å§‹æ—¶é—´ï¼ˆä¿æŒ24å°æ—¶åˆ»åº¦ï¼‰").addDropdown(e=>{for(let t=0;t<24;t++){var i=t.toString().padStart(2,"0")+":00";e.addOption(t.toString(),i)}e.setValue((this.plugin.settings.timeBlockStartHour||0).toString()).onChange(async t=>{this.plugin.settings.timeBlockStartHour=parseInt(t),await this.plugin.saveSettings(),this.plugin.refreshTaskView()})}),t.createEl("h3",{text:"è‡ªåŠ¨æ¸…ç†è®¾ç½®"}),i=t.createDiv(),i.style.cssText="padding: 10px; border-radius: 5px; margin: 10px 0; color: #6c757d;",i.innerHTML="<strong>è¯´æ˜ï¼š</strong>å¯ç”¨è‡ªåŠ¨æ¸…ç†åŠŸèƒ½åï¼Œæ’ä»¶ä¼šåœ¨æ¯æ¬¡å¯åŠ¨æ—¶ï¼ˆå»¶è¿Ÿ30ç§’ï¼‰è‡ªåŠ¨æ¸…ç†æŒ‡å®šæ—¶é—´ä¹‹å‰çš„å·²å®Œæˆä»»åŠ¡æ•°æ®ï¼Œä»¥ä¿æŒæ•°æ®æ–‡ä»¶çš„æ•´æ´ã€‚æ­¤æ“ä½œä»…æ¸…ç†æœ¬åœ°æ•°æ®ï¼Œä¸ä¼šå½±å“æ»´ç­”æ¸…å•äº‘ç«¯æ•°æ®ã€‚",new Setting(t).setName("è‡ªåŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡").setDesc("å¯ç”¨åä¼šåœ¨æ’ä»¶å¯åŠ¨æ—¶è‡ªåŠ¨æ¸…ç†æŒ‡å®šæ—¶é—´ä¹‹å‰çš„å·²å®Œæˆä»»åŠ¡æ•°æ®").addToggle(t=>t.setValue(this.plugin.settings.autoCleanCompletedTasks).onChange(async t=>{this.plugin.settings.autoCleanCompletedTasks=t,await this.plugin.saveSettings()})),new Setting(t).setName("æ¸…ç†é—´éš”").setDesc("è‡ªåŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡çš„æ—¶é—´é—´éš”ï¼ˆæœˆæ•°ï¼‰").addDropdown(e=>{for(let t=1;t<=12;t++)e.addOption(t.toString(),t+"ä¸ªæœˆ");e.setValue(this.plugin.settings.autoCleanInterval.toString()).onChange(async t=>{this.plugin.settings.autoCleanInterval=parseInt(t),await this.plugin.saveSettings()})}),t.createEl("h3",{text:"åŸç”Ÿä»»åŠ¡åŒæ­¥è®¾ç½®"}),e=t.createDiv(),e.style.cssText="padding: 10px; border-radius: 5px; margin: 10px 0; color: #0066cc;",e.innerHTML='<strong>è¯´æ˜ï¼š</strong>åŸç”Ÿä»»åŠ¡åŒæ­¥åŠŸèƒ½æ”¯æŒæ‰‹åŠ¨åŒæ­¥Obsidianä¸­çš„åŸç”Ÿä»»åŠ¡æ ¼å¼ï¼ˆ- [ ] ï¼‰åˆ°æ»´ç­”æ¸…å•ã€‚å¯ç”¨åï¼Œè¾“å…¥"- [ ] "æ—¶ä¼šå¼¹å‡ºæ“ä½œèœå•ï¼Œå¯é€‰æ‹©åŒæ­¥åˆ°æ»´ç­”æ¸…å•æˆ–æ·»åŠ åˆ°æœŸæ—¥æœŸã€‚åŒæ­¥åä¼šåœ¨ä»»åŠ¡åæ·»åŠ é“¾æ¥ï¼Œæ–¹ä¾¿è·³è½¬åˆ°æ»´ç­”æ¸…å•æŸ¥çœ‹è¯¦æƒ…ã€‚',new Setting(t).setName("å¯ç”¨åŸç”Ÿä»»åŠ¡åŒæ­¥").setDesc('å¯ç”¨åå¯ä»¥æ‰‹åŠ¨åŒæ­¥ObsidianåŸç”Ÿä»»åŠ¡æ ¼å¼åˆ°æ»´ç­”æ¸…å•ï¼Œè¾“å…¥"- [ ] "æ—¶æ˜¾ç¤ºæ“ä½œèœå•').addToggle(t=>t.setValue(this.plugin.settings.enableNativeTaskSync).onChange(async t=>{this.plugin.settings.enableNativeTaskSync=t,await this.plugin.saveSettings()})),t.createEl("h3",{text:"æ•°æ®é‡ç½®"}),i=t.createDiv();i.style.cssText="padding: 10px; border-radius: 5px; margin: 10px 0; color: #856404; border: 1px solid #ffeaa7;",i.innerHTML="<strong>âš ï¸ è­¦å‘Šï¼š</strong>æ­¤æ“ä½œå°†å®Œå…¨æ¸…ç©ºæœ¬åœ°ä»»åŠ¡æ•°æ®ï¼Œå¹¶ä»æ»´ç­”æ¸…å•äº‘ç«¯é‡æ–°è·å–æœ€æ–°æ•°æ®ã€‚æ­¤æ“ä½œä¸å¯é€†ï¼Œå»ºè®®å¤‡ä»½ä»“åº“åä½¿ç”¨ã€‚(é€‚ç”¨äºObsidianæœ¬åœ°ä»»åŠ¡æ•°æ®å·²ç»ç ´åã€å¼‚å¸¸ç­‰æƒ…å†µï¼‰",new Setting(t).setName("é‡ç½®ä»»åŠ¡æ•°æ®").setDesc("æ¸…ç©ºæœ¬åœ°ä»»åŠ¡æ•°æ®,å¹¶é‡æ–°ä»äº‘ç«¯è·å–ä»»åŠ¡åˆ°ä½ çš„Obsidian").addButton(t=>t.setButtonText("é‡ç½®æ•°æ®").setWarning().onClick(async()=>{this.plugin.isPluginActivated?this.plugin.settings.accessToken?confirm('ç¡®å®šè¦é‡ç½®ä»»åŠ¡æ•°æ®å—ï¼Ÿ\n\næ­¤æ“ä½œå°†ï¼š\nâ€¢ å®Œå…¨æ¸…ç©ºæœ¬åœ°ä»»åŠ¡æ•°æ®\nâ€¢ é‡æ–°ä»æ»´ç­”æ¸…å•äº‘ç«¯è·å–æ•°æ®\nâ€¢ æ­¤æ“ä½œä¸å¯é€†\n\nç‚¹å‡»"ç¡®å®š"ç»§ç»­ï¼Œç‚¹å‡»"å–æ¶ˆ"æ”¾å¼ƒæ“ä½œã€‚')&&await this.plugin.resetTaskData():new Notice("è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯"):await this.plugin.checkPluginStatusAndNotify()}))}updateRedirectUriDisplay(t){var e,i,a;for(e of this.containerEl.querySelectorAll("code"))e.textContent.includes("/callback")&&(e.textContent=`http://localhost:${t}/callback`);for(i of this.containerEl.querySelectorAll("button"))"å¤åˆ¶"===i.textContent&&i.onclick&&(a=i.previousElementSibling)&&"CODE"===a.tagName&&a.textContent.includes("/callback")&&(i.onclick=()=>{navigator.clipboard.writeText(`http://localhost:${t}/callback`),new Notice("é‡å®šå‘URIå·²å¤åˆ¶åˆ°å‰ªè´´æ¿")})}}module.exports=class extends Plugin{constructor(t,e){super(t,e),this.isPluginActivated=!1,this.repeatTaskManager=null,this.taskActionMenuDebounceTimer=null,this.dateChangeDebounceTimer=null,this.lastTaskMenuTriggerTime=0,this.currentTaskActionMenu=null,this.isTaskActionInProgress=!1}async onload(){await this.checkContentProtectionStatus()?(this.isPluginActivated=!0,await this.initializePluginFeatures()):(this.isPluginActivated=!1,await this.showActivationRequired())}async initializePluginFeatures(){this.isReverseUpdating=!1,await this.loadSettings(),document.documentElement.style.setProperty("--dida-hour-height",`${this.settings.timeBlockHourHeight||80}px`),this.repeatTaskManager=new RepeatTaskManager(this),this.nativeTaskSyncManager=new NativeTaskSyncManager(this),this.registerView(TASK_VIEW_TYPE,t=>new TaskView(t,this)),this.registerView(TIME_BLOCK_VIEW_TYPE,t=>new DidaTimeBlockView(t,this)),this.addCommand({id:"open-task-list",name:"æ‰“å¼€æ»´ç­”ä»»åŠ¡æ¸…å•",callback:()=>this.openTaskView()}),this.addCommand({id:"manual-sync",name:"æ‰‹åŠ¨åŒå‘åŒæ­¥",callback:()=>this.manualSync()}),this.addCommand({id:"add-task-to-project",name:"åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»»åŠ¡",callback:()=>this.showAddTaskToProjectModal()}),this.initializeMarkdownTaskLink(),this.addRibbonIcon("calendar-check","æ»´ç­”æ—¶é—´çº¿è§†å›¾",()=>{this.showTimelineView()}),this.createStatusBarItem(),this.setupAutoSync(),this._handleOnlineForAutoSync=()=>{try{if(this.settings.autoSync&&this.settings.accessToken&&this.setupAutoSync(),this.settings.accessToken){this.updateStatusBar("å·²è¿æ¥"),this.refreshTaskView();try{this.safeManualSync()}catch(t){}}}catch(t){}},this._handleOfflineForAutoSync=()=>{try{this.clearAutoSync(),this.updateStatusBar("ç¦»çº¿ä¸­"),this.refreshTaskView()}catch(t){}},window.addEventListener("online",this._handleOnlineForAutoSync),window.addEventListener("offline",this._handleOfflineForAutoSync),this.registerEvent(this.app.workspace.on("layout-change",()=>{this._cachedTaskLeaf&&this._cachedTaskLeaf.isDestroyed&&(this._cachedTaskLeaf=null)})),this.registerEvent(this.app.vault.on("modify",async r=>{if(!this._isUpdatingNativeTaskStatus&&this.settings.enableNativeTaskSync&&"md"===r.extension){let i=r.path;this._nativeTaskSyncTimeouts||(this._nativeTaskSyncTimeouts=new Map),this._nativeTaskSyncTimeouts.has(i)&&clearTimeout(this._nativeTaskSyncTimeouts.get(i));var t=setTimeout(async()=>{if(this._nativeTaskSyncTimeouts.delete(i),!this._isUpdatingNativeTaskStatus)try{var t=await this.app.vault.read(r),e=this.nativeTaskSyncManager.detectNativeTasks(t,r.path);let a=!1;for(let i of e)if(i.hasLink&&i.didaId){let e=this.settings.tasks.find(t=>t.didaId===i.didaId);if(e){var s=i.isCompleted?2:0;if(e.status!==s)if(2==s&&RRuleParser.hasRepeatRule(e)){var n=this.settings.tasks.findIndex(t=>t.didaId===e.didaId);if(-1!==n)try{this._isUpdatingNativeTaskStatus=!0,await this.toggleTask(n),a=!0}catch(t){this.updateTaskStatusDirectly(e,s),a=!0}finally{this._isUpdatingNativeTaskStatus=!1}}else this.updateTaskStatusDirectly(e,s),a=!0,this.settings.accessToken&&setTimeout(async()=>{try{await this.toggleTaskInDidaList(e)}catch(t){}},0)}}a&&(await this.saveSettings(),this.refreshTaskView())}catch(t){(!this._lastErrorTime||3e4<Date.now()-this._lastErrorTime)&&(this._lastErrorTime=Date.now())}},2e3);this._nativeTaskSyncTimeouts.set(i,t)}})),this.addSettingTab(new DidaSyncSettingTab(this.app,this)),this.settings.accessToken&&setTimeout(async()=>{try{await this.safeManualSync()}catch(t){}},2e3),this.settings.autoCleanCompletedTasks&&setTimeout(async()=>{try{await this.autoCleanCompletedTasks()}catch(t){}},3e4)}onunload(){this.clearAutoSync();try{this._handleOnlineForAutoSync&&(window.removeEventListener("online",this._handleOnlineForAutoSync),this._handleOnlineForAutoSync=null),this._handleOfflineForAutoSync&&(window.removeEventListener("offline",this._handleOfflineForAutoSync),this._handleOfflineForAutoSync=null)}catch(t){}this.cleanupOAuthServer(),this._cachedTaskLeaf=null,this._nativeTaskSyncTimeout&&clearTimeout(this._nativeTaskSyncTimeout),this._taskStatusChangeTimeout&&clearTimeout(this._taskStatusChangeTimeout),this._lastErrorTime=null}async checkContentProtectionStatus(){try{var t;return this.app.plugins.enabledPlugins.has(CP_PLUGIN_ID)?!!await this.validateContentProtectionManifest()&&((t=this.app.plugins.plugins[CP_PLUGIN_ID])&&t.settings?!0===t.settings.isActivated&&t.settings.deviceId&&0<t.settings.deviceId.trim().length&&!0===t.settings.hasBeenActivated:await this.checkContentProtectionFile()):!1}catch(t){return!1}}async validateContentProtectionManifest(){try{var t=CP_PLUGIN_DIR+"/manifest.json",e=await this.app.vault.adapter.read(t),i=JSON.parse(e),a=i.version;if(!a)return!1;if(compareVersions(a,"1.3.0")<0)return!1;if("ytmaps"!==i.author)return!1;try{if(!validatePluginIntegrity(i,".obsidian/plugins/obsidian-content-protection"))return!1;if(!generateSecureHash(`${i.id}:${i.author}:`+i.version))return!1}catch(t){}return!0}catch(t){return!1}}async checkContentProtectionFile(){try{var t,e,i;return this.app.plugins.enabledPlugins.has(CP_PLUGIN_ID)?(t=CP_PLUGIN_DIR+"/data.json",e=await this.app.vault.adapter.read(t),!0===(i=JSON.parse(e)).isActivated&&i.deviceId&&0<i.deviceId.trim().length&&!0===i.hasBeenActivated):!1}catch(t){return!1}}async checkAndUpdateStatus(){var t=await this.checkContentProtectionStatus();!t&&this.isPluginActivated?(this.isPluginActivated=!1,this.disablePluginFeatures()):t&&!this.isPluginActivated&&(this.isPluginActivated=!0,await this.initializePluginFeatures())}disablePluginFeatures(){this.statusCheckInterval&&(clearInterval(this.statusCheckInterval),this.statusCheckInterval=null)}async checkPluginStatusAndNotify(){return!!await this.checkContentProtectionStatus()||(await this.showActivationRequired(),!1)}async showActivationRequired(){var t=this.app.plugins.enabledPlugins.has("obsidian-content-protection");if(t&&!await this.validateContentProtectionManifest())try{var e=await this.app.vault.adapter.read(".obsidian/plugins/obsidian-content-protection/manifest.json"),i=JSON.parse(e);i.version&&compareVersions(i.version,"1.3.0")}catch(t){}}async openTaskView(){var t=this.app.workspace;let e=null;var i=t.getLeavesOfType(TASK_VIEW_TYPE);0<i.length?e=i[0]:await(e=t.getRightLeaf(!1)).setViewState({type:TASK_VIEW_TYPE,active:!0}),t.revealLeaf(e),this.settings.accessToken&&await this.syncFromDidaList()}async addTask(t,e="æ”¶é›†ç®±",i="inbox",a=!0,s=null){t={id:Date.now().toString(),title:t,content:"",completed:!1,status:0,didaId:null,projectId:i,projectName:e,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[],dueDate:s};if(this.settings.tasks=this.settings.tasks||[],this.settings.tasks.push(t),await this.saveSettings(),this.refreshTaskView(),a&&this.settings.accessToken)try{await this.createTaskInDidaList(t),this.refreshTaskView()}catch(t){this.refreshTaskView()}return t}async updateTaskContent(e,i){if(this.settings.tasks&&!(e>=this.settings.tasks.length)){let t=this.settings.tasks[e];t.content=i,t.updatedAt=(new Date).toISOString(),await this.saveSettings(),this.settings.accessToken&&t.didaId&&setTimeout(()=>{this.updateTaskContentInDidaList(t).catch(t=>{})},0)}}async updateTaskContentInDidaList(t){if(t.didaId){var e,i={id:t.didaId,title:t.title,content:t.content||"",desc:t.desc||"",status:t.status};t.items&&Array.isArray(t.items)&&0<t.items.length&&(e=t.content||t.desc||"",i.content=e,i.desc=e),t.projectId&&"inbox"!==t.projectId&&(i.projectId=t.projectId),void 0!==t.dueDate&&(null===t.dueDate?i.dueDate=null:t.dueDate.endsWith("Z")?i.dueDate=t.dueDate.replace("Z","+0000"):i.dueDate=t.dueDate),t.startDate&&(i.startDate=t.startDate),void 0!==t.isAllDay&&(i.isAllDay=t.isAllDay),t.parentId&&(i.parentId=t.parentId),t.items&&Array.isArray(t.items)&&(i.items=t.items),"string"==typeof t.repeatFlag&&(e=t.repeatFlag.trim(),i.repeatFlag=""===e?"":e);try{var a=await this.makeAuthenticatedRequest("https://api.dida365.com/open/v1/task/"+t.didaId,{method:"POST",body:JSON.stringify(i)});if(!a.ok)throw await a.text(),new Error("æ›´æ–°ä»»åŠ¡å¤±è´¥: "+a.status);t.updatedAt=(new Date).toISOString(),await this.saveSettings()}catch(t){throw t}}}async toggleTask(t){if(this.settings.tasks&&!(t>=this.settings.tasks.length)){let e=this.settings.tasks[t];if(2===e.status)e.status=0,e.completedTime=null;else{e.status=2;var t=new Date,i=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),s=String(t.getDate()).padStart(2,"0"),n=String(t.getHours()).padStart(2,"0"),r=String(t.getMinutes()).padStart(2,"0"),l=String(t.getSeconds()).padStart(2,"0"),t=t.getTimezoneOffset(),d=Math.abs(Math.floor(t/60)),o=Math.abs(t%60),t=(t<=0?"+":"-")+String(d).padStart(2,"0")+String(o).padStart(2,"0");if(e.completedTime=i+`-${a}-${s}T${n}:${r}:`+l+t,RRuleParser.hasRepeatRule(e)&&this.repeatTaskManager)try{await this.repeatTaskManager.createRepeatTaskCopy(e)}catch(t){}}var c,h,u,p,g,m,k,v,y;if(e.updatedAt=(new Date).toISOString(),2===e.status&&e.didaId)for(let t of this.settings.tasks.filter(t=>t.parentId===e.didaId))2!==t.status&&(t.status=2,c=(y=new Date).getFullYear(),h=String(y.getMonth()+1).padStart(2,"0"),u=String(y.getDate()).padStart(2,"0"),p=String(y.getHours()).padStart(2,"0"),g=String(y.getMinutes()).padStart(2,"0"),m=String(y.getSeconds()).padStart(2,"0"),y=y.getTimezoneOffset(),k=Math.abs(Math.floor(y/60)),v=Math.abs(y%60),y=(y<=0?"+":"-")+String(k).padStart(2,"0")+String(v).padStart(2,"0"),t.completedTime=c+`-${h}-${u}T${p}:${g}:`+m+y,t.updatedAt=(new Date).toISOString(),this.settings.accessToken)&&t.didaId&&setTimeout(()=>{this.toggleTaskInDidaList(t).catch(t=>{})},0);await this.saveSettings(),this.settings.accessToken&&e.didaId&&setTimeout(()=>{this.toggleTaskInDidaList(e).catch(t=>{})},0),this.refreshTaskView(),e.didaId&&setTimeout(()=>{var t=this.getTaskViewSafely();t&&t.updateNativeTaskStatus&&t.updateNativeTaskStatus(e,2===e.status).catch(t=>{})},500)}}updateTaskStatusDirectly(t,e){var i,a,s,n,r,l,d,o;t.status=e,t.updatedAt=(new Date).toISOString(),2===e?(i=(e=new Date).getFullYear(),a=String(e.getMonth()+1).padStart(2,"0"),s=String(e.getDate()).padStart(2,"0"),n=String(e.getHours()).padStart(2,"0"),r=String(e.getMinutes()).padStart(2,"0"),l=String(e.getSeconds()).padStart(2,"0"),e=e.getTimezoneOffset(),d=Math.abs(Math.floor(e/60)),o=Math.abs(e%60),e=(e<=0?"+":"-")+String(d).padStart(2,"0")+String(o).padStart(2,"0"),t.completedTime=i+`-${a}-${s}T${n}:${r}:`+l+e):t.completedTime=null}async deleteTask(e){if(this.settings.tasks&&!(e>=this.settings.tasks.length)){let t=this.settings.tasks[e];if(this.settings.tasks.splice(e,1),await this.saveSettings(),this.refreshTaskView(),t.didaId){try{await this.deleteDidaIdFromMarkdown(t.didaId)}catch(t){}this.settings.accessToken&&setTimeout(async()=>{try{t.status;t.status=2,t.completedTime=(new Date).toISOString(),await this.updateTaskInDidaList(t),await this.deleteTaskInDidaList(t.didaId,t.projectId)}catch(t){}},0)}}}async deleteTaskInBackground(t,e){try{await this.deleteTaskInDidaList(t,e);try{await this.syncFromDidaList()}catch(t){}}catch(t){}}async autoCleanCompletedTasks(){if(this.settings.autoCleanCompletedTasks){var t,i=new Date,a=this.settings.autoCleanInterval;let e=new Date(i);e.setMonth(e.getMonth()-a),0!==this.settings.tasks.filter(t=>"completed"===t.status&&t.completedTime).filter(t=>new Date(t.completedTime)<e).length&&(t=this.settings.tasks.length,this.settings.tasks=this.settings.tasks.filter(t=>"completed"!==t.status||!t.completedTime||new Date(t.completedTime)>=e),this.settings.tasks.length,await this.saveSettings(),this.refreshTaskView())}}async resetTaskData(){try{var t=this.settings.tasks.length;this.settings.tasks=[],await this.saveSettings(),this.refreshTaskView(),new Notice(`å·²æ¸…ç©º ${t} ä¸ªæœ¬åœ°ä»»åŠ¡æ•°æ®`),setTimeout(async()=>{try{new Notice("æ­£åœ¨ä»æ»´ç­”æ¸…å•äº‘ç«¯è·å–æœ€æ–°æ•°æ®..."),await this.syncFromDidaList();var t=this.settings.tasks.length;new Notice(`é‡ç½®å®Œæˆï¼å·²ä»äº‘ç«¯è·å– ${t} ä¸ªä»»åŠ¡æ•°æ®`)}catch(t){}},1e3)}catch(t){}}async loadSettings(){this.settings=Object.assign({},DEFAULT_SETTINGS,await this.loadData()),this.settings.tasks||(this.settings.tasks=[]),this.settings.tasks.forEach(t=>{void 0===t.content&&(t.content=""),void 0===t.desc&&(t.desc=""),void 0===t.items&&(t.items=[])}),void 0===this.settings.autoCleanCompletedTasks&&(this.settings.autoCleanCompletedTasks=!1),void 0===this.settings.autoCleanInterval&&(this.settings.autoCleanInterval=1),void 0===this.settings.projectCollapsedStates&&(this.settings.projectCollapsedStates={}),await this.saveSettings()}async saveSettings(){await this.saveData(this.settings)}async saveTaskDetails(i,a,s,t=0,n=void 0,r=void 0){i=this.settings.tasks[i];if(i){a=a.trim();if(a){var l,d,o,c,h,u,p,g,m,k=i.title!==a,v=i.title,y=i.dueDate;let t=!1,e=n;void 0!==n&&(n instanceof Date&&(l=n.getFullYear(),d=String(n.getMonth()+1).padStart(2,"0"),o=String(n.getDate()).padStart(2,"0"),c=String(n.getHours()).padStart(2,"0"),h=String(n.getMinutes()).padStart(2,"0"),u=String(n.getSeconds()).padStart(2,"0"),p=n.getTimezoneOffset(),g=Math.abs(Math.floor(p/60)),m=Math.abs(p%60),p=(p<=0?"+":"-")+String(g).padStart(2,"0")+String(m).padStart(2,"0"),e=l+`-${d}-${o}T${c}:${h}:`+u+p),t=y!==e),i.title=a,void 0!==n&&(i.dueDate=e,void 0!==r)&&(i.isAllDay=r),i.content=s,i.desc=s,i.updatedAt=(new Date).toISOString(),await this.saveSettings(),k&&i.didaId&&0<(g=this.app.workspace.getLeavesOfType("dida-task-view")).length&&g[0].view.updateNativeTaskTitle&&await g[0].view.updateNativeTaskTitle(i,v,a),t&&i.didaId&&0<(m=this.app.workspace.getLeavesOfType("dida-task-view")).length&&m[0].view.updateNativeTaskDueDate&&await m[0].view.updateNativeTaskDueDate(i,y,e)}else new Notice("ä»»åŠ¡æ ‡é¢˜ä¸èƒ½ä¸ºç©º")}}async syncTaskToDidaListInBackground(t){if(this.settings.accessToken&&t.didaId)try{await this.updateTaskInDidaList(t)}catch(t){}}createStatusBarItem(){this.statusBarItem||(this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("æœªè¿æ¥"),this.statusBarItem.addEventListener("click",()=>{this.settings.accessToken?this.openTaskView():this.startOAuthFlow()}))}updateStatusBar(e){if(this.statusBarItem){let t=e;try{"undefined"!=typeof navigator&&navigator&&!1===navigator.onLine&&(t="ç¦»çº¿ä¸­")}catch(t){}this.statusBarItem.setText("æ»´ç­”æ¸…å•: "+t)}}setupAutoSync(){if(this.clearAutoSync(),this.settings.autoSync&&this.settings.accessToken){try{if("undefined"!=typeof navigator&&navigator&&!1===navigator.onLine)return}catch(t){}this.autoSyncInterval=setInterval(()=>{this.syncFromDidaList()},60*this.settings.syncInterval*1e3)}}clearAutoSync(){this.autoSyncInterval&&(clearInterval(this.autoSyncInterval),this.autoSyncInterval=null)}getRedirectUri(){return`http://localhost:${this.settings.serverPort}/callback`}async startOAuthFlow(){if(this.settings.clientId&&this.settings.clientSecret)if(this.oauthInProgress)new Notice("OAuthè®¤è¯æ­£åœ¨è¿›è¡Œä¸­...");else try{this.oauthInProgress=!0,this.updateStatusBar("è®¤è¯ä¸­..."),await this.startOAuthServer();var e=this.buildAuthUrl();try{await shell.openExternal(e)}catch(t){new AuthUrlModal(this.app,e,this.getRedirectUri()).open()}}catch(t){new Notice("OAuthè®¤è¯å¯åŠ¨å¤±è´¥: "+t.message),this.updateStatusBar("è®¤è¯å¤±è´¥"),this.oauthInProgress=!1}else new Notice("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®Client IDå’ŒClient Secret")}buildAuthUrl(){var t=new URLSearchParams({client_id:this.settings.clientId,redirect_uri:this.getRedirectUri(),response_type:"code",scope:OAUTH_CONFIG.scope});return OAUTH_CONFIG.authUrl+"?"+t.toString()}async startOAuthServer(){return this.oauthServer&&(this.oauthServer.close(),this.oauthServer=null),new Promise((t,e)=>{this.oauthServer=http.createServer((t,e)=>{var i,t=new URL(t.url,"http://localhost:"+this.settings.serverPort);"/callback"===t.pathname?(i=t.searchParams.get("code"),(t=t.searchParams.get("error"))?(e.writeHead(400,{"Content-Type":"text/html; charset=utf-8"}),e.end(`
                            <html>
                                <head><title>è®¤è¯å¤±è´¥</title></head>
                                <body>
                                    <h1>OAuthè®¤è¯å¤±è´¥</h1>
                                    <p>é”™è¯¯: ${t}</p>
                                    <p>è¯·å…³é—­æ­¤é¡µé¢å¹¶é‡è¯•ã€‚</p>
                                </body>
                            </html>
                        `),this.handleOAuthError(t)):i?(e.writeHead(200,{"Content-Type":"text/html; charset=utf-8"}),e.end(`
                            <html>
                                <head><title>è®¤è¯æˆåŠŸ</title></head>
                                <body>
                                    <h1>OAuthè®¤è¯æˆåŠŸ!</h1>
                                    <p>æ‚¨å¯ä»¥å…³é—­æ­¤é¡µé¢ï¼Œè¿”å›Obsidianç»§ç»­ä½¿ç”¨ã€‚</p>
                                    <script>setTimeout(() => window.close(), 3000);</script>
                                </body>
                            </html>
                        `),this.handleOAuthCallback(i)):(e.writeHead(400,{"Content-Type":"text/html; charset=utf-8"}),e.end(`
                            <html>
                                <head><title>è®¤è¯å¤±è´¥</title></head>
                                <body>
                                    <h1>è®¤è¯å¤±è´¥</h1>
                                    <p>æœªæ”¶åˆ°æˆæƒç ï¼Œè¯·é‡è¯•ã€‚</p>
                                </body>
                            </html>
                        `),this.handleOAuthError("æœªæ”¶åˆ°æˆæƒç "))):(e.writeHead(404,{"Content-Type":"text/plain"}),e.end("Not Found"))}),this.oauthServer.on("error",t=>{e(t)}),this.oauthServer.listen(this.settings.serverPort,"localhost",()=>{t()}),this.oauthTimeout=setTimeout(()=>{this.handleOAuthError("OAuthè®¤è¯è¶…æ—¶")},6e5)})}cleanupOAuthServer(){this.oauthTimeout&&(clearTimeout(this.oauthTimeout),this.oauthTimeout=null),this.oauthServer&&(this.oauthServer.close(),this.oauthServer=null),this.oauthInProgress=!1}async handleOAuthCallback(t){try{var e=await this.exchangeCodeForToken(t);this.settings.accessToken=e.access_token,this.settings.refreshToken=e.refresh_token,await this.saveSettings(),new Notice("OAuthè®¤è¯æˆåŠŸ!"),this.updateStatusBar("å·²è¿æ¥"),this.setupAutoSync()}catch(t){new Notice("è®¤è¯å¤±è´¥: "+t.message),this.updateStatusBar("è®¤è¯å¤±è´¥")}finally{this.cleanupOAuthServer()}}handleOAuthError(t){new Notice("OAuthè®¤è¯å¤±è´¥: "+t),this.updateStatusBar("è®¤è¯å¤±è´¥"),this.cleanupOAuthServer()}async exchangeCodeForToken(i){return new Promise((a,s)=>{var t=querystring.stringify({grant_type:"authorization_code",client_id:this.settings.clientId,client_secret:this.settings.clientSecret,code:i,redirect_uri:this.getRedirectUri()}),e={hostname:"dida365.com",port:443,path:"/oauth/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(t)}},e=https.request(e,e=>{let i="";e.on("data",t=>{i+=t}),e.on("end",()=>{if(200===e.statusCode)try{var t=JSON.parse(i);a(t)}catch(t){s(new Error("è§£ætokenå“åº”å¤±è´¥: "+t.message))}else s(new Error(`Tokenè¯·æ±‚å¤±è´¥: ${e.statusCode} `+i))})});e.on("error",t=>{s(new Error("Tokenè¯·æ±‚ç½‘ç»œé”™è¯¯: "+t.message))}),e.write(t),e.end()})}async refreshAccessToken(){if(this.settings.refreshToken)return new Promise((a,s)=>{var t=querystring.stringify({grant_type:"refresh_token",client_id:this.settings.clientId,client_secret:this.settings.clientSecret,refresh_token:this.settings.refreshToken}),e={hostname:"dida365.com",port:443,path:"/oauth/token",method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded","Content-Length":Buffer.byteLength(t)}},e=https.request(e,e=>{let i="";e.on("data",t=>{i+=t}),e.on("end",async()=>{if(200===e.statusCode)try{var t=JSON.parse(i);this.settings.accessToken=t.access_token,t.refresh_token&&(this.settings.refreshToken=t.refresh_token),await this.saveSettings(),a(t)}catch(t){s(new Error("è§£ætokenå“åº”å¤±è´¥: "+t.message))}else s(new Error("Tokenåˆ·æ–°å¤±è´¥"))})});e.on("error",t=>{s(new Error("Tokenåˆ·æ–°ç½‘ç»œé”™è¯¯: "+t.message))}),e.write(t),e.end()});throw new Error("æ²¡æœ‰refresh token")}async makeAuthenticatedRequest(i,o={}){if(this.settings.accessToken)return o.body,new Promise((a,s)=>{var t=new URL(i),e="https:"===t.protocol;let n=e?https:http,r=o.body||"",l=o.method||"GET",d={hostname:t.hostname,port:t.port||(e?443:80),path:t.pathname+t.search,method:l,headers:{Authorization:"Bearer "+this.settings.accessToken,"Content-Type":"application/json","User-Agent":"Obsidian-DidaSync-Plugin/1.0",...o.headers}};r&&"GET"!==l&&(d.headers["Content-Length"]=Buffer.byteLength(r));e=n.request(d,e=>{let i="";e.on("data",t=>{i+=t}),e.on("end",async()=>{if(401===e.statusCode)try{await this.refreshAccessToken(),d.headers.Authorization="Bearer "+this.settings.accessToken;var t=n.request(d,t=>{let e="";t.on("data",t=>{e+=t}),t.on("end",()=>{a({ok:200<=t.statusCode&&t.statusCode<300,status:t.statusCode,json:()=>Promise.resolve(JSON.parse(e)),text:()=>Promise.resolve(e)})})});t.on("error",s),r&&"GET"!==l&&t.write(r),t.end()}catch(t){this.settings.accessToken="",this.settings.refreshToken="",await this.saveSettings(),this.updateStatusBar("æœªè¿æ¥"),s(new Error("è®¤è¯å·²è¿‡æœŸï¼Œè¯·é‡æ–°è¿›è¡ŒOAuthè®¤è¯"))}else a({ok:200<=e.statusCode&&e.statusCode<300,status:e.statusCode,json:()=>Promise.resolve(JSON.parse(i)),text:()=>Promise.resolve(i)})})});e.on("error",t=>{s(new Error("ç½‘ç»œè¯·æ±‚é”™è¯¯: "+t.message))}),r&&"GET"!==l&&e.write(r),e.end()});throw new Error("æœªè®¤è¯ï¼Œè¯·å…ˆè¿›è¡ŒOAuthè®¤è¯")}async syncToDidaList(){if(this.settings.accessToken)try{this.updateStatusBar("åŒæ­¥ä¸­...");var e,i=this.settings.tasks||[];let t=0;for(e of i)e.didaId?await this.updateTaskInDidaList(e):(await this.createTaskInDidaList(e),t++);this.updateStatusBar("å·²è¿æ¥")}catch(t){this.updateStatusBar("åŒæ­¥å¤±è´¥")}else new Notice("è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯")}async syncFromDidaList(){if(this.settings.accessToken){if(!this.isReverseUpdating)try{this.updateStatusBar("åŒæ­¥ä¸­...");var e,n=[];let t=0,a=new Map;try{var i=await this.makeAuthenticatedRequest("https://api.dida365.com/open/v1/project");if(i.ok){var s,r=await i.json();if(Array.isArray(r)){r.forEach(t=>{var e={id:t.id,name:t.name,color:t.color,closed:t.closed,groupId:t.groupId,viewMode:t.viewMode,permission:t.permission,kind:t.kind};a.set(t.id,e)}),a.has("inbox")||a.set("inbox",{id:"inbox",name:"æ”¶é›†ç®±",color:"#F18181",closed:!1,groupId:null,viewMode:"list",permission:"write",kind:"TASK"});for(let i of r)for(s of[`https://api.dida365.com/open/v1/project/${i.id}/task`,`https://api.dida365.com/open/v1/project/${i.id}/data`,"https://api.dida365.com/open/v1/task?projectId="+i.id])try{var l=await this.makeAuthenticatedRequest(s);if(l.ok){var d=await l.json();let t=[];if(Array.isArray(d)?t=d:d&&d.tasks&&Array.isArray(d.tasks)?t=d.tasks:d&&d.data&&Array.isArray(d.data)&&(t=d.data),0<t.length){t.forEach(t=>{var e=a.get(i.id);t.projectId=i.id,t.projectName=i.name,t.projectColor=e?.color,t.projectClosed=e?.closed,t.projectViewMode=e?.viewMode,t.projectKind=e?.kind,t.projectPermission=e?.permission}),n.push(...t);break}}}catch(t){}}}}catch(t){}try{for(e of["https://api.dida365.com/open/v1/project/inbox/task","https://api.dida365.com/open/v1/project/inbox/data","https://api.dida365.com/open/v1/task?projectId=inbox","https://api.dida365.com/open/v1/task"])try{var o=await this.makeAuthenticatedRequest(e);if(o.ok){var c=await o.json();let t=[];if(Array.isArray(c)?t=e.includes("/task")&&!e.includes("projectId")?c.filter(t=>!t.projectId||"inbox"===t.projectId||null===t.projectId):c:c&&c.tasks&&Array.isArray(c.tasks)?t=c.tasks:c&&c.data&&Array.isArray(c.data)&&(t=c.data),0<t.length){let e=a.get("inbox"),i=(t.forEach(t=>{t.projectId=t.projectId||"inbox",t.projectName="æ”¶é›†ç®±",t.projectColor=e?.color,t.projectClosed=e?.closed,t.projectViewMode=e?.viewMode,t.projectKind=e?.kind,t.projectPermission=e?.permission}),new Set(n.map(t=>t.id)));var h=t.filter(t=>!i.has(t.id));n.push(...h);break}}}catch(t){}}catch(t){}if(0<n.length)for(let s of n){var u=this.settings.tasks.findIndex(t=>t.didaId===s.id);if(-1===u){var p=a.get(s.projectId)||{id:s.projectId,name:s.projectName||"æœªçŸ¥é¡¹ç›®"};await this.createTaskFromDida(s,p),t++}else{let i=this.settings.tasks[u],a=!1;var g,m,k,v,y,w,f,T,D,S,x,b,I=(t,e)=>{if(t.etag&&e.etag)return t.etag!==e.etag;t=t.modifiedTime||t.createdTime,e=e.updatedAt;if(!t&&!e)return!0;if(!t)return!1;if(!e)return!0;try{var i=new Date(t),a=new Date(e);return-3e4<i.getTime()-a.getTime()}catch(t){return!1}};if(s.title&&s.title!==i.title&&I(s,i)){let e=i.title;i.title=s.title,a=!0,i.didaId&&setTimeout(()=>{this.isReverseUpdating=!0,this.app.workspace.getLeavesOfType(TASK_VIEW_TYPE).forEach(t=>{t.view instanceof TaskView&&t.view.updateNativeTaskTitle(i,e,s.title)}),setTimeout(()=>{this.isReverseUpdating=!1},1e3)},500)}if("CHECKLIST"===s.kind?(s.desc!==i.desc&&(i.desc=s.desc||"",a=!0),s.content!==i.content&&(i.content=s.content||"",a=!0)):(s.content&&s.content!==i.content&&(i.content=s.content,a=!0),s.desc!==i.desc&&(i.desc=s.desc||"",a=!0)),void 0!==s.dueDate&&s.dueDate!==i.dueDate&&I(s,i)){let e=i.dueDate;i.dueDate=s.dueDate,a=!0,i.didaId&&setTimeout(()=>{this.app.workspace.getLeavesOfType(TASK_VIEW_TYPE).forEach(t=>{t.view instanceof TaskView&&t.view.updateNativeTaskDueDate(i,e,s.dueDate)})},100)}if(void 0!==s.startDate&&s.startDate!==i.startDate&&(i.startDate=s.startDate,a=!0),void 0!==s.etag&&s.etag!==i.etag&&(i.etag=s.etag,a=!0),void 0!==s.isAllDay&&s.isAllDay!==i.isAllDay&&(i.isAllDay=s.isAllDay,a=!0),void 0!==s.kind&&s.kind!==i.kind&&(i.kind=s.kind,a=!0),void 0!==s.reminders&&JSON.stringify(s.reminders)!==JSON.stringify(i.reminders)&&(i.reminders=s.reminders,a=!0),void 0!==s.repeatFlag&&s.repeatFlag!==i.repeatFlag&&(i.repeatFlag=s.repeatFlag,a=!0),void 0!==s.status&&s.status!==i.status&&(i.status=s.status,a=!0),void 0!==s.status&&s.status!==i.status&&(i.status=s.status,a=!0),2===s.status)if(s.completedTime){let t=null;"number"==typeof s.completedTime?(m=(g=new Date(s.completedTime)).getFullYear(),k=String(g.getMonth()+1).padStart(2,"0"),v=String(g.getDate()).padStart(2,"0"),y=String(g.getHours()).padStart(2,"0"),w=String(g.getMinutes()).padStart(2,"0"),f=String(g.getSeconds()).padStart(2,"0"),T=g.getTimezoneOffset(),D=Math.abs(Math.floor(T/60)),S=Math.abs(T%60),x=(T<=0?"+":"-")+String(D).padStart(2,"0")+String(S).padStart(2,"0"),t=m+`-${k}-${v}T${y}:${w}:`+f+x):"string"==typeof s.completedTime&&(t=s.completedTime),t&&i.completedTime!==t&&(i.completedTime=t,a=!0)}else i.completedTime&&(i.completedTime=null,a=!0);else i.completedTime&&(i.completedTime=null,a=!0);void 0!==s.projectId&&s.projectId!==i.projectId&&(i.projectId=s.projectId,a=!0),void 0!==s.projectName&&s.projectName!==i.projectName&&(i.projectName=s.projectName,a=!0),void 0!==s.projectColor&&s.projectColor!==i.projectColor&&(i.projectColor=s.projectColor,a=!0),void 0!==s.projectClosed&&s.projectClosed!==i.projectClosed&&(i.projectClosed=s.projectClosed,a=!0),void 0!==s.projectViewMode&&s.projectViewMode!==i.projectViewMode&&(i.projectViewMode=s.projectViewMode,a=!0),void 0!==s.projectKind&&s.projectKind!==i.projectKind&&(i.projectKind=s.projectKind,a=!0),void 0!==s.projectPermission&&s.projectPermission!==i.projectPermission&&(i.projectPermission=s.projectPermission,a=!0),void 0!==s.items&&JSON.stringify(s.items)!==JSON.stringify(i.items)&&(b=s.items.map(t=>{var e,i,a,s,n,r,l,d,o;return t.completedTime&&"number"==typeof t.completedTime?(e=(o=new Date(t.completedTime)).getFullYear(),i=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0"),s=String(o.getHours()).padStart(2,"0"),n=String(o.getMinutes()).padStart(2,"0"),r=String(o.getSeconds()).padStart(2,"0"),o=o.getTimezoneOffset(),l=Math.abs(Math.floor(o/60)),d=Math.abs(o%60),o=(o<=0?"+":"-")+String(l).padStart(2,"0")+String(d).padStart(2,"0"),{...t,completedTime:e+`-${i}-${a}T${s}:${n}:`+r+o}):t}),i.items=b,a=!0),void 0!==s.parentId&&s.parentId!==i.parentId&&(i.parentId=s.parentId,a=!0),a&&(i.updatedAt=(new Date).toISOString(),s.etag&&(i.etag=s.etag),await this.saveSettings(),t++)}}var E,L=await this.syncDeletedTasks(n),M=await this.markExtraTasksAsCompleted(n),C=await this.markCompletedNativeTasksWithLinks(n);(0<t||0<L||0<M||0<C)&&(E=[],0<t&&E.push(`åŒæ­¥/æ›´æ–° ${t} ä¸ªä»»åŠ¡`),0<L&&E.push(`åˆ é™¤ ${L} ä¸ªä»»åŠ¡`),0<M&&E.push(`æ ‡è®° ${M} ä¸ªä»»åŠ¡ä¸ºå·²å®Œæˆ`),0<C)&&E.push(`æ ‡è®° ${C} ä¸ªåŸç”Ÿä»»åŠ¡ä¸ºå·²å®Œæˆ`),this.updateStatusBar("å·²è¿æ¥"),this.refreshTaskView()}catch(t){t.message.includes("404")||t.message.includes("405")||t.message.includes("401"),this.updateStatusBar("åŒæ­¥å¤±è´¥")}}else new Notice("è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯")}async processSyncData(t){let a=0;if(t&&t.syncTaskBean&&t.syncTaskBean.update)for(let i of t.syncTaskBean.update){var s=this.settings.tasks.findIndex(t=>t.didaId===i.id);if(-1===s)await this.createTaskFromDida(i),a++;else{var n,r,l,d,o,c,h,u,p,s=this.settings.tasks[s];let e=!1;if(i.title&&i.title!==s.title&&(s.title=i.title,e=!0),"CHECKLIST"===i.kind?(i.desc!==s.desc&&(s.desc=i.desc||"",e=!0),i.content!==s.content&&(s.content=i.content||"",e=!0)):(i.content&&i.content!==s.content&&(s.content=i.content,e=!0),i.desc!==s.desc&&(s.desc=i.desc||"",e=!0)),void 0!==i.status&&i.status!==s.status&&0!==s.status&&(s.status=i.status,e=!0),void 0!==i.projectId&&i.projectId!==s.projectId&&(s.projectId=i.projectId,e=!0),void 0!==i.projectName&&i.projectName!==s.projectName&&(s.projectName=i.projectName,e=!0),2===i.status){if(0!==s.status)if(i.completedTime){let t=null;"number"==typeof i.completedTime?(n=(p=new Date(i.completedTime)).getFullYear(),r=String(p.getMonth()+1).padStart(2,"0"),l=String(p.getDate()).padStart(2,"0"),d=String(p.getHours()).padStart(2,"0"),o=String(p.getMinutes()).padStart(2,"0"),c=String(p.getSeconds()).padStart(2,"0"),p=p.getTimezoneOffset(),h=Math.abs(Math.floor(p/60)),u=Math.abs(p%60),p=(p<=0?"+":"-")+String(h).padStart(2,"0")+String(u).padStart(2,"0"),t=n+`-${r}-${l}T${d}:${o}:`+c+p):"string"==typeof i.completedTime&&(t=i.completedTime),t&&s.completedTime!==t&&(s.completedTime=t,e=!0)}else s.completedTime&&(s.completedTime=null,e=!0)}else s.completedTime&&(s.completedTime=null,e=!0);e&&(s.updatedAt=(new Date).toISOString(),await this.saveSettings(),a++)}}a,this.updateStatusBar("å·²è¿æ¥"),this.refreshTaskView()}async manualSync(){if(this.isPluginActivated)if(this.settings.accessToken)try{this.updateStatusBar("åŒå‘åŒæ­¥ä¸­..."),await this.syncToDidaList(),await this.syncFromDidaList()}catch(t){}else new Notice("è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯");else await this.checkPluginStatusAndNotify()}async safeManualSync(){if(this.isPluginActivated)if(this.settings.accessToken)try{this.updateStatusBar("åŒå‘åŒæ­¥ä¸­..."),await this.syncNewTasksToDidaList(),await new Promise(t=>setTimeout(t,1e3)),await this.syncFromDidaList()}catch(t){}else new Notice("è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯");else await this.checkPluginStatusAndNotify()}async syncNewTasksToDidaList(){var i=(this.settings.tasks||[]).filter(t=>!t.didaId);if(0!==i.length){let t=0,e=0;for(var a of i)try{await this.createTaskInDidaList(a),++t%2==0&&await new Promise(t=>setTimeout(t,1e3))}catch(t){if(e++,(t.message.includes("exceed_query_limit")||t.message.includes("500"))&&await new Promise(t=>setTimeout(t,5e3)),3<e)throw new Error("åŒæ­¥é”™è¯¯è¿‡å¤šï¼Œå·²åœæ­¢åŒæ­¥")}t}}async syncDeletedTasks(t){let i=new Set(t.map(t=>t.id));t=this.settings.tasks.filter(t=>t.didaId).filter(e=>{if(i.has(e.didaId))return!1;if(2===e.status)return e.items&&Array.isArray(e.items)&&0<e.items.length||this.settings.tasks.some(t=>t.parentId===e.didaId),!1;if(e.updatedAt){var t=new Date(e.updatedAt);if((new Date-t)/36e5<24)return!1}return!0});if(0===t.length)return 0;let a=0;for(let e of t)try{var s=this.settings.tasks.findIndex(t=>t.didaId===e.didaId);-1!==s&&(this.settings.tasks.splice(s,1),a++)}catch(t){}return 0<a&&await this.saveSettings(),a}async markExtraTasksAsCompleted(t){let e=new Set(t.map(t=>t.id));t=this.settings.tasks.filter(t=>t.didaId).filter(t=>!e.has(t.didaId)&&2!==t.status);if(0===t.length)return 0;let i=0;for(let e of t)try{var a,s,n,r,l,d,o,c,h,u,p,g=this.settings.tasks.findIndex(t=>t.didaId===e.didaId);-1!==g&&(this.settings.tasks[g].status=2,s=(a=new Date).getFullYear(),n=String(a.getMonth()+1).padStart(2,"0"),r=String(a.getDate()).padStart(2,"0"),l=String(a.getHours()).padStart(2,"0"),d=String(a.getMinutes()).padStart(2,"0"),o=String(a.getSeconds()).padStart(2,"0"),c=a.getTimezoneOffset(),h=Math.abs(Math.floor(c/60)),u=Math.abs(c%60),p=(c<=0?"+":"-")+String(h).padStart(2,"0")+String(u).padStart(2,"0"),this.settings.tasks[g].parentId||(this.settings.tasks[g].completedTime=s+`-${n}-${r}T${l}:${d}:`+o+p),this.settings.tasks[g].updatedAt=(new Date).toISOString(),i++)}catch(t){}return 0<i&&await this.saveSettings(),i}async markCompletedNativeTasksWithLinks(t){if(!Array.isArray(t)||0===t.length)return 0;let e=new Set(t.map(t=>t.id)),i=0;try{var a;for(a of this.app.vault.getMarkdownFiles())try{var s=await this.app.vault.read(a),n=this.nativeTaskSyncManager.detectNativeTasks(s,a.path).filter(t=>t.hasLink&&t.didaId&&!t.isCompleted&&!e.has(t.didaId));if(0<n.length){var r,l,d=s.split("\n");for(l of n){var o,c,h=l.lineNumber;h<d.length&&(c=(o=d[h]).replace(/^(\s*-\s*)\[\s*\](\s*.*)$/,"$1[x]$2"))!==o&&(d[h]=c,i++)}0<i&&(r=d.join("\n"),await this.app.vault.modify(a,r))}}catch(t){}}catch(t){}return i}async createTaskInDidaList(e){var t,i={title:e.title,content:e.content||"",desc:e.desc||""};if(e.items&&Array.isArray(e.items)&&0<e.items.length&&(t=e.content||e.desc||"",i.content=t,i.desc=t),e.projectId&&"inbox"!==e.projectId&&(i.projectId=e.projectId),e.parentId&&(i.parentId=e.parentId),e.items&&Array.isArray(e.items)&&(i.items=e.items),void 0!==e.dueDate)if(null===e.dueDate)i.dueDate=null;else{let t=e.dueDate;(t=t instanceof Date?t.toISOString():t).endsWith("Z")&&(t=t.replace("Z","+0000")),i.dueDate=t}if(void 0!==e.startDate)if(null===e.startDate)i.startDate=null;else{let t=e.startDate;"string"==typeof(t=t instanceof Date?t.toISOString():t)&&t.endsWith("Z")&&(t=t.replace("Z","+0000")),i.startDate=t}void 0!==e.isAllDay&&(i.isAllDay=e.isAllDay),"string"==typeof e.repeatFlag&&(t=e.repeatFlag.trim(),i.repeatFlag=""===t?"":t);try{var a,s,n=await this.makeAuthenticatedRequest("https://api.dida365.com/open/v1/task",{method:"POST",body:JSON.stringify(i)});if(n.ok)return s=await n.json(),e.didaId=s.id,e.updatedAt=(new Date).toISOString(),e.etag=s.etag||null,e.status=s.status||0,e.parentId||(e.completedTime=s.completedTime||null),e.dueDate=s.dueDate||null,e.startDate=s.startDate||null,e.isAllDay=s.isAllDay||!1,e.kind=s.kind||"TEXT",e.projectViewMode=s.projectViewMode||"list",e.projectKind=s.projectKind||"TASK",e.parentId=s.parentId||null,s.items&&Array.isArray(s.items)&&0<s.items.length&&(e.items=s.items),e.reminders=s.reminders||[],e.repeatFlag=s.repeatFlag||null,await this.saveSettings(),s;throw a=await n.text(),new Error(`åˆ›å»ºä»»åŠ¡å¤±è´¥: ${n.status} - `+a)}catch(t){throw t}}async updateTaskInDidaList(e){if(e.didaId){var t,i,a,s,n,r,l,d,o,c=!(!e.startDate||!e.dueDate||e.startDate===e.dueDate),h=e.content||e.desc||"",h={id:e.didaId,title:e.title,content:h,desc:h,status:e.status};if(e.projectId&&"inbox"!==e.projectId&&(h.projectId=e.projectId),void 0!==e.dueDate)if(null===e.dueDate)h.dueDate=null;else{let t=e.dueDate;(t=t instanceof Date?t.toISOString():t).endsWith("Z")&&(t=t.replace("Z","+0000")),h.dueDate=t}if(void 0!==e.startDate)if(null===e.startDate)h.startDate=null;else{let t=e.startDate;"string"==typeof(t=t instanceof Date?t.toISOString():t)&&t.endsWith("Z")&&(t=t.replace("Z","+0000")),h.startDate=t}else void 0!==e.dueDate&&(h.startDate=h.dueDate);void 0!==e.isAllDay&&(h.isAllDay=e.isAllDay,e.isAllDay)&&(h.timeZone="Asia/Shanghai"),e.parentId&&(h.parentId=e.parentId),e.items&&Array.isArray(e.items)&&(h.items=e.items),e.reminders&&Array.isArray(e.reminders)&&(h.reminders=e.reminders),"string"==typeof e.repeatFlag&&(r=e.repeatFlag.trim(),h.repeatFlag=""===r?"":r),2!==e.status||e.parentId||e.completedTime||(o=(r=new Date).getFullYear(),t=String(r.getMonth()+1).padStart(2,"0"),i=String(r.getDate()).padStart(2,"0"),a=String(r.getHours()).padStart(2,"0"),s=String(r.getMinutes()).padStart(2,"0"),n=String(r.getSeconds()).padStart(2,"0"),r=r.getTimezoneOffset(),l=Math.abs(Math.floor(r/60)),d=Math.abs(r%60),o=o+`-${t}-${i}T${a}:${s}:`+n+((r<=0?"+":"-")+String(l).padStart(2,"0")+String(d).padStart(2,"0")),e.completedTime=h.completedTime=o);try{var u=await this.makeAuthenticatedRequest("https://api.dida365.com/open/v1/task/"+e.didaId,{method:"POST",body:JSON.stringify(h)});if(!u.ok)throw await u.text(),new Error("æ›´æ–°ä»»åŠ¡å¤±è´¥: "+u.status);var p=await u.json();p.isAllDay&&p.timeZone,c||(void 0!==p.dueDate&&(e.dueDate=p.dueDate),void 0!==p.startDate&&(e.startDate=p.startDate),e.dueDate&&!e.startDate?e.startDate=e.dueDate:e.startDate&&!e.dueDate&&(e.dueDate=e.startDate)),e.updatedAt=(new Date).toISOString(),await this.saveSettings()}catch(t){throw t}}}async deleteTaskInDidaList(t,e="inbox"){try{var i=await this.makeAuthenticatedRequest(`https://api.dida365.com/open/v1/project/${e}/task/`+t,{method:"DELETE"});if(!i.ok)throw new Error("åˆ é™¤ä»»åŠ¡å¤±è´¥: "+i.status)}catch(t){throw t}}async createTaskFromDida(t,e=null){let i=t.content||"",a=t.desc||"";t.items&&Array.isArray(t.items)&&0<t.items.length&&(s=i||a||"",i=s,a=s);var s={id:Date.now().toString()+Math.random().toString(36).substr(2,9),title:t.title,content:i,desc:a,didaId:t.id,projectId:t.projectId||"inbox",projectName:e?e.name:t.projectName||"æ”¶é›†ç®±",createdAt:t.createdTime||(new Date).toISOString(),updatedAt:(new Date).toISOString(),dueDate:t.dueDate||null,startDate:t.startDate||null,etag:t.etag||null,isAllDay:t.isAllDay||!1,kind:t.kind||"TEXT",reminders:t.reminders||[],repeatFlag:t.repeatFlag||null,status:t.status||0,completedTime:null,projectColor:t.projectColor||e?.color,projectClosed:t.projectClosed||e?.closed,projectViewMode:t.projectViewMode||e?.viewMode,projectKind:t.projectKind||e?.kind,projectPermission:t.projectPermission||e?.permission,parentId:t.parentId||null,items:t.items&&Array.isArray(t.items)?t.items.map(t=>{var e,i,a,s,n,r,l,d,o;return t.completedTime&&"number"==typeof t.completedTime?(e=(o=new Date(t.completedTime)).getFullYear(),i=String(o.getMonth()+1).padStart(2,"0"),a=String(o.getDate()).padStart(2,"0"),s=String(o.getHours()).padStart(2,"0"),n=String(o.getMinutes()).padStart(2,"0"),r=String(o.getSeconds()).padStart(2,"0"),o=o.getTimezoneOffset(),l=Math.abs(Math.floor(o/60)),d=Math.abs(o%60),o=(o<=0?"+":"-")+String(l).padStart(2,"0")+String(d).padStart(2,"0"),{...t,completedTime:e+`-${i}-${a}T${s}:${n}:`+r+o}):t}):[]};return this.settings.tasks.push(s),await this.saveSettings(),s}async toggleTaskInDidaList(t){if(t.didaId)try{var e=t.projectId||"inbox";if(!t.completed||1!==t.completed&&2!==t.completed&&!0!==t.completed)await this.updateTaskInDidaList(t);else{var i=await this.makeAuthenticatedRequest(`https://api.dida365.com/open/v1/project/${e}/task/${t.didaId}/complete`,{method:"POST"});if(!i.ok)throw new Error("å®Œæˆä»»åŠ¡å¤±è´¥: "+i.status)}}catch(t){throw t}}refreshTaskView(){this.app.workspace.getLeavesOfType(TASK_VIEW_TYPE).forEach(t=>{t.view instanceof TaskView&&t.view.renderTaskList()})}async showAddTaskToProjectModal(){this.isPluginActivated?new AddTaskToProjectModal(this.app,this).open():await this.checkPluginStatusAndNotify()}async showTimelineView(){if(this.isPluginActivated){try{if("undefined"!=typeof navigator&&navigator&&!1===navigator.onLine)return void new Notice("å½“å‰å¤„äºç¦»çº¿çŠ¶æ€ï¼Œæ—¶é—´çº¿è§†å›¾ä¸å¯ç”¨")}catch(t){}new TimelineViewModal(this.app,this).open()}else await this.checkPluginStatusAndNotify()}async getTasksFromProject(t){if(!this.settings.accessToken)return[];try{var e;for(e of[`https://api.dida365.com/open/v1/project/${t}/task`,`https://api.dida365.com/open/v1/project/${t}/data`,"https://api.dida365.com/open/v1/task?projectId="+t])try{var i=await this.makeAuthenticatedRequest(e);if(i.ok){var a=await i.json();let t=[];return Array.isArray(a)?t=a:a&&a.tasks&&Array.isArray(a.tasks)?t=a.tasks:a&&a.data&&Array.isArray(a.data)&&(t=a.data),t}}catch(t){}return[]}catch(t){return[]}}initializeMarkdownTaskLink(){this.registerEvent(this.app.workspace.on("editor-change",(t,e)=>{this.handleEditorChange(t,e)})),this.registerEvent(this.app.workspace.on("click",t=>{this.handleTaskLinkClick(t)})),this.registerEvent(this.app.workspace.on("file-open",()=>{this.setupDidaLinkHandler()})),this.setupDidaLinkHandler(),this.registerObsidianProtocolHandler("dida-task",t=>{let e=null;t.didaId?e=t.didaId:t.action?e=t.action.split("/")[1]:"string"==typeof t&&(e=t.split("/").pop()),e&&this.openTaskDetails(e)})}handleEditorChange(e,t){try{if(e&&e.getCursor&&e.getLine&&!this._isUpdatingNativeTaskStatus){let t=e.getCursor();var a=e.getLine(t.line),i=a.substring(0,t.ch);if(i.endsWith("@@")&&setTimeout(()=>{this.showTaskSuggestions(e,t)},10),this.settings.enableNativeTaskSync){var s=a.match(/^(\s*)-\s\[x\]\s.*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/i),n=a.match(/^(\s*)-\s\[\s\]\s.*\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/);if(s||n){let i=(s||n)[2];var r=!!s;let a=this.settings.tasks.find(t=>t.didaId===i);if(a){let e=r?2:0;if(a.status!==e)return this._taskStatusChangeTimeout&&clearTimeout(this._taskStatusChangeTimeout),void(this._taskStatusChangeTimeout=setTimeout(async()=>{try{var t;this._isUpdatingNativeTaskStatus=!0,2==e&&RRuleParser.hasRepeatRule(a)?-1!==(t=this.settings.tasks.findIndex(t=>t.didaId===i))&&await this.toggleTask(t):(this.updateTaskStatusDirectly(a,e),await this.saveSettings(),this.refreshTaskView(),this.settings.accessToken&&setTimeout(async()=>{try{await this.toggleTaskInDidaList(a)}catch(t){}},0))}catch(t){}finally{this._isUpdatingNativeTaskStatus=!1,this._taskStatusChangeTimeout=null}},300))}}if(this.taskActionMenuDebounceTimer&&(clearTimeout(this.taskActionMenuDebounceTimer),this.taskActionMenuDebounceTimer=null),i.match(/^(\s*)-\s\[\s\]\s(.*)$/)){if(this.isTaskActionInProgress)return;if(this.currentTaskActionMenu&&this.currentTaskActionMenu.isOpen&&this.currentTaskActionMenu.isSamePosition(e,t))return;if(Date.now()-this.lastTaskMenuTriggerTime<300)return;this.taskActionMenuDebounceTimer=setTimeout(()=>{this.lastTaskMenuTriggerTime=Date.now(),this.showTaskActionMenu(e,t),this.taskActionMenuDebounceTimer=null},150)}else this.currentTaskActionMenu&&this.currentTaskActionMenu.isOpen&&(this.currentTaskActionMenu.close(),this.currentTaskActionMenu=null)}this.dateChangeDebounceTimer&&(clearTimeout(this.dateChangeDebounceTimer),this.dateChangeDebounceTimer=null);var l=/^(\s*)-\s\[\s\]\s*(.+)ğŸ“…\s*(\d{4}-\d{2}-\d{2})(.*)$/,d=a.match(l);if(d){let e=d[2].trim(),i=d[3];var o=a.match(/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([a-f0-9]+)\)/);if(o){let t=o[1];this.isTaskActionInProgress||(this.dateChangeDebounceTimer=setTimeout(()=>{this.handleDateChange(t,i,e),this.dateChangeDebounceTimer=null},500))}}}}catch(t){}}showTaskSuggestions(s,n){try{var t,r=new TaskSuggestionPopup(this.app,this,s,n,t=>{this.insertTaskLink(s,n,t)});let a=null;if(s.cm&&s.cm.dom?a=s.cm.dom:s.getInputField&&"function"==typeof s.getInputField?a=s.getInputField():s.dom?a=s.dom:(t=this.app.workspace.getActiveViewOfType("markdown"))&&t.editor&&(a=t.editor.cm?.dom||t.editor.dom),a){var l=a.getBoundingClientRect();let e=l.top,i=l.left;if(s.cm&&s.cm.cursorCoords)try{var d=s.cm.cursorCoords(n,"page");e=d.top,i=d.left}catch(t){e=l.top+20*n.line+20,i=l.left+20}else e=l.top+20*n.line+20,i=l.left+20;let t=null;if(s.cm&&s.cm.dom)try{var o=s.cm.dom.querySelectorAll(".cm-line"),c=s.getLine(n.line);let a=-1;for(let t=0;t<o.length;t++)if(o[t].textContent.trim()===c.trim()){a=t;break}if(-1===a)for(let t=0;t<o.length;t++)if(o[t].textContent.includes("@@")){a=t;break}if(-1===a){var h=n.line;let e=-1,i=1/0;for(let t=0;t<o.length;t++){var u=o[t].offsetTop,p=Math.round(u/32),g=Math.abs(p-h);g<i&&(i=g,e=t)}-1!==e&&(a=e)}t=0<=a?o[a]:o[0]}catch(t){}r.open();var m,k,v=r.element,y=(v.style.position="fixed",v.style.width="400px",v.style.maxHeight="300px",v.style.overflowY="auto",v.style.zIndex="1000",v.style.backgroundColor="var(--background-primary)",v.style.border="1px solid var(--background-modifier-border)",v.style.borderRadius="8px",v.style.boxShadow="0 8px 32px rgba(0, 0, 0, 0.15)",v.style.padding="16px",t?(m=t.getBoundingClientRect(),v.style.left=m.left+"px",v.style.top=m.bottom+5+"px"):(v.style.left=l.left+"px",v.style.top=l.bottom+5+"px"),v.getBoundingClientRect()),w=window.innerHeight,f=window.innerWidth;y.bottom>w&&(t?(k=t.getBoundingClientRect(),v.style.top=k.top-y.height-5+"px"):v.style.top=e-y.height-5+"px"),f<y.right&&(v.style.left=f-y.width-10+"px"),y.left<10&&(v.style.left="10px")}}catch(t){}}insertTaskLink(t,e,i){var a=t.getLine(e.line),s=a.substring(0,e.ch-2),a=a.substring(e.ch),i=`[@@${i.title||"æ— æ ‡é¢˜ä»»åŠ¡"}](obsidian://dida-task?didaId=${i.didaId})`,a=(t.setLine(e.line,s+i+a),{line:e.line,ch:s.length+i.length});t.setCursor(a)}showTaskActionMenu(i,a){try{var t;!this.settings.enableNativeTaskSync||this.currentTaskActionMenu&&this.currentTaskActionMenu.isOpen&&this.currentTaskActionMenu.isSamePosition(i,a)||(this.currentTaskActionMenu&&(this.currentTaskActionMenu.close(),this.currentTaskActionMenu=null),t=new TaskActionMenu(this.app,this,i,a,(t,e)=>{this.handleTaskAction(i,a,t,e)}),(this.currentTaskActionMenu=t).open())}catch(t){}}async handleTaskAction(t,e,i,a){try{this.isTaskActionInProgress=!0;var s=t.getLine(e.line);"sync"===i?await this.syncTaskToDidaList(t,e,s):"date"===i&&this.addDateToTask(t,e,s,a.date),setTimeout(()=>{this.isTaskActionInProgress=!1},500)}catch(t){setTimeout(()=>{this.isTaskActionInProgress=!1},100)}}async syncTaskToDidaList(e,i,t){try{if(this.settings.accessToken){var a=t.match(/^(\s*)-\s\[\s\]\s*(.+)$/);if(a){var s=a[1],n=a[2].trim();if(n){var r,l,d,o=/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([^)]+)\)/,c=n.match(o);if(c)c[1],new Notice("â„¹ï¸ ä»»åŠ¡å·²åŒæ­¥ï¼Œæ— éœ€å†æ¬¡åŒæ­¥",3e3);else{let t=n;(t=(t=(t=(t=t.replace(/ğŸ“…\s*\d{4}-\d{2}-\d{2}/g,"").trim()).replace(/\[ğŸ”—[^\]]*\]\([^)]*\)/g,"").trim()).replace(/\[[^\]]*\]\([^)]*\)/g,"").trim()).replace(/\s+/g," ").trim())&&((r=await this.createTaskDirectly(t))&&r.id?(l=s+`- [ ] ${n} [ğŸ”—Dida](${"obsidian://dida-task?didaId="+r.id}) `,e.setLine(i.line,l),d={id:Date.now().toString(),title:t,content:"",completed:!1,status:0,didaId:r.id,projectId:r.projectId||"inbox",projectName:"æ”¶é›†ç®±",createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),items:[],dueDate:null,etag:r.etag||"",completedTime:null,startDate:null,isAllDay:!1,kind:"TEXT",projectViewMode:"list",projectKind:"TASK",reminders:[],repeatFlag:null,desc:"",projectColor:"#F18181",projectClosed:!1,projectPermission:"write",parentId:null},this.settings.tasks.push(d),await this.saveSettings(),new Notice("âœ… ä»»åŠ¡å·²åŒæ­¥åˆ°æ»´ç­”æ¸…å•",3e3),this.refreshTaskView()):new Notice("âŒ åŒæ­¥å¤±è´¥ï¼Œè¯·é‡è¯•"))}}else new Notice("âŒ ä»»åŠ¡å†…å®¹ä¸èƒ½ä¸ºç©º")}else new Notice("âŒ æ— æ³•è¯†åˆ«ä»»åŠ¡æ ¼å¼")}else new Notice("âŒ è¯·å…ˆè¿›è¡ŒOAuthè®¤è¯")}catch(t){let e="åŒæ­¥å¤±è´¥";t.message.includes("401")?e="æœªç»æˆæƒ":t.message.includes("403")?e="ç¦æ­¢è®¿é—®":t.message.includes("404")?e="æœªæ‰¾åˆ°":t.message&&(e="åŒæ­¥å¤±è´¥: "+t.message),new Notice("âŒ "+e,5e3)}}async createTaskDirectly(t){t={title:t,content:"",desc:""};try{var e,i=await this.makeAuthenticatedRequest("https://api.dida365.com/open/v1/task",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(i.ok)return await i.json();throw e=await i.text(),new Error(`APIè°ƒç”¨å¤±è´¥: ${i.status} - `+e)}catch(t){throw t}}async addDateToTask(i,a,t,r){try{var e=t.match(/^(\s*)-\s\[\s\]\s*(.+)$/);if(e){var s=e[1],n=e[2].trim(),l=/ğŸ“…\s*\d{4}-\d{2}-\d{2}/,d=l.test(n),o=/\[ğŸ”—Dida\]\(obsidian:\/\/dida-task\?didaId=([^)]+)\)/,c=n.match(o);if(c){let t;t=d?s+"- [ ] "+n.replace(l,`ğŸ“… ${r} `):s+`- [ ] ${n} ğŸ“… ${r} `,i.setLine(a.line,t);let e=c[1];var h,u,p,g,m,k=this.settings.tasks.find(t=>t.didaId===e);if(k){let t;let n=t=r.includes("T")?r:(h=new Date,u=r.split("-"),p=parseInt(u[0]),g=parseInt(u[1])-1,m=parseInt(u[2]),new Date(p,g,m,h.getHours(),h.getMinutes(),h.getSeconds()).toISOString());if(k.startDate&&k.dueDate&&k.startDate!==k.dueDate){var v=r.split("-");let i=parseInt(v[0]),a=parseInt(v[1])-1,s=parseInt(v[2]);var y=t=>{try{var e=new Date(t);return isNaN(e.getTime())?n:new Date(i,a,s,e.getHours(),e.getMinutes(),e.getSeconds()).toISOString()}catch(t){return n}};k.startDate=y(k.startDate),k.dueDate=y(k.dueDate)}else k.dueDate=n,k.startDate=n,k.isAllDay=!0;k.updatedAt=(new Date).toISOString(),await this.saveSettings(),await this.updateTaskInDidaList(k),this.refreshTaskView()}}else new Notice("è¯·å…ˆåŒæ­¥åˆ°æ»´ç­”æ¸…å•ï¼Œå†è®¾ç½®åˆ°æœŸæ—¥æœŸ")}else new Notice("æ— æ³•è¯†åˆ«ä»»åŠ¡æ ¼å¼")}catch(t){let e="æ·»åŠ æ—¥æœŸå¤±è´¥";t.message.includes("401")?e="æœªç»æˆæƒ":t.message.includes("403")?e="ç¦æ­¢è¿æ¥":t.message.includes("404")?e="æœªæ‰¾åˆ°":t.message&&(e="æ·»åŠ æ—¥æœŸå¤±è´¥: "+t.message),new Notice("âŒ "+e)}}async handleDateChange(e,r,t){try{var i,a,s,l,d,o=this.settings.tasks.find(t=>t.didaId===e);if(o){let t;let n=t=r.includes("T")?r:(i=new Date,a=r.split("-"),s=parseInt(a[0]),l=parseInt(a[1])-1,d=parseInt(a[2]),new Date(s,l,d,i.getHours(),i.getMinutes(),i.getSeconds()).toISOString());if(o.startDate&&o.dueDate&&o.startDate!==o.dueDate){var c=r.split("-");let i=parseInt(c[0]),a=parseInt(c[1])-1,s=parseInt(c[2]);var h=t=>{try{var e=new Date(t);return isNaN(e.getTime())?n:new Date(i,a,s,e.getHours(),e.getMinutes(),e.getSeconds()).toISOString()}catch(t){return n}},u=h(o.startDate),p=h(o.dueDate);if(o.startDate===u&&o.dueDate===p)return;o.startDate=u,o.dueDate=p}else{if(o.dueDate===n&&o.startDate===n)return;o.dueDate=n,o.startDate=n,o.isAllDay=!0}o.updatedAt=(new Date).toISOString(),await this.saveSettings(),await this.updateTaskInDidaList(o),this.refreshTaskView()}}catch(t){let e="åŒæ­¥æ—¥æœŸå˜æ›´å¤±è´¥";t.message.includes("401")?e="æœªç»æˆæƒ":t.message.includes("403")?e="ç¦æ­¢è¿æ¥":t.message.includes("404")?e="æœªæ‰¾åˆ°":t.message&&(e="åŒæ­¥æ—¥æœŸå˜æ›´å¤±è´¥: "+t.message),new Notice("âŒ "+e)}}async handleTitleChange(e,t){try{var i=this.settings.tasks.find(t=>t.didaId===e);i&&i.title!==t&&(i.title=t,i.updatedAt=(new Date).toISOString(),await this.saveSettings(),await this.updateTaskInDidaList(i),this.refreshTaskView(),new Notice("âœ… å·²åŒæ­¥æ ‡é¢˜å˜æ›´åˆ°æ»´ç­”æ¸…å•"))}catch(t){let e="åŒæ­¥æ ‡é¢˜å˜æ›´å¤±è´¥";t.message.includes("401")?e="æœªç»æˆæƒ":t.message.includes("403")?e="ç¦æ­¢è¿æ¥":t.message.includes("404")?e="æœªæ‰¾åˆ°":t.message&&(e="åŒæ­¥æ ‡é¢˜å˜æ›´å¤±è´¥: "+t.message),new Notice("âŒ "+e)}}handleTaskLinkClick(e){var t,i=e.target;if("A"===i.tagName&&i.href&&i.href.includes("obsidian://dida-task/"))t=i.href.split("obsidian://dida-task/")[1],this.openTaskDetails(t),e.preventDefault(),e.stopPropagation();else{let t=i;for(;t&&t!==document.body;){var a=(t.textContent||t.innerText||"").match(/@@([a-zA-Z0-9]+)/);if(a)return a=a[1],this.openTaskDetails(a),e.preventDefault(),void e.stopPropagation();t=t.parentElement}}}openTaskDetails(e){let i=this.settings.tasks.find(t=>t.didaId===e);i?this.openTaskViewWithCache().then(()=>{this.showTaskDetailsInViewOptimized(i)}).catch(t=>{this.showTaskDetailsInView(i)}):new Notice("è¯¥ä»»åŠ¡å·²å®Œæˆ")}async openTaskViewWithCache(){var e=this.app.workspace;if(this._cachedTaskLeaf&&!this._cachedTaskLeaf.isDestroyed)e.revealLeaf(this._cachedTaskLeaf);else{let t=null;var i=e.getLeavesOfType(TASK_VIEW_TYPE);0<i.length?t=i[0]:await(t=e.getRightLeaf(!1)).setViewState({type:TASK_VIEW_TYPE,active:!0}),this._cachedTaskLeaf=t,e.revealLeaf(t),this.registerEvent(t.on("close",()=>{this._cachedTaskLeaf===t&&(this._cachedTaskLeaf=null)}))}}showTaskDetailsInViewOptimized(i){try{var t,e,a,s,n,r,l=document.querySelector(`[data-task-id="${i.id}"]`);l?l.classList.contains("dida-timeline-task-item")?(t=this.getTimelineModalSafely())&&t.toggleTimelineTaskDetails?(t.toggleTimelineTaskDetails(l,i),this.scrollToTaskItem(l)):(e=l.querySelector(".dida-timeline-task-title, .dida-task-title-clickable"))&&(a=new Event("click",{bubbles:!0}),e.dispatchEvent(a),this.scrollToTaskItem(l)):(s=this.getTaskViewSafely())&&s.toggleTaskDetails?(s.toggleTaskDetails(l,i),this.scrollToTaskItem(l)):(n=l.querySelector(".dida-task-title, .dida-task-title-clickable"))?(r=new Event("click",{bubbles:!0}),n.dispatchEvent(r),this.scrollToTaskItem(l)):this.showTaskDetailsInView(i):(this.refreshTaskView(),requestAnimationFrame(()=>{var t,e=document.querySelector(`[data-task-id="${i.id}"]`);e?e.classList.contains("dida-timeline-task-item")?(t=this.getTimelineModalSafely())&&t.toggleTimelineTaskDetails&&(t.toggleTimelineTaskDetails(e,i),this.scrollToTaskItem(e)):(t=this.getTaskViewSafely())&&t.toggleTaskDetails?(t.toggleTaskDetails(e,i),this.scrollToTaskItem(e)):this.showTaskDetailsInView(i):this.showTaskDetailsInView(i)}))}catch(t){this.showTaskDetailsInView(i)}}getTaskViewSafely(){try{var t=this.app.workspace.getLeavesOfType(TASK_VIEW_TYPE);if(0<t.length){var e=t[0].view;if(e&&"function"==typeof e.toggleTaskDetails)return e}if(this._cachedTaskLeaf&&!this._cachedTaskLeaf.isDestroyed()){var i=this._cachedTaskLeaf.view;if(i&&"function"==typeof i.toggleTaskDetails)return i}return null}catch(t){return null}}getTimelineModalSafely(){try{var t;for(t of document.querySelectorAll(".modal"))if(t.querySelector(".dida-timeline-modal")||t.querySelector(".dida-timeline-container")){var e=this.app.workspace.getActiveModal();if(e&&"function"==typeof e.toggleTimelineTaskDetails)return e}return null}catch(t){return null}}clearTaskViewCache(){this._cachedTaskLeaf=null}scrollToTaskItem(t){if(t)try{t.scrollIntoView({behavior:"smooth",block:"center",inline:"nearest"}),t.style.transition="background-color 0.3s ease",t.style.backgroundColor="var(--background-modifier-hover)",setTimeout(()=>{t.style.backgroundColor="",t.style.transition=""},3e3)}catch(t){}}async findFilesWithDidaId(t){var e,i=[];for(e of this.app.vault.getMarkdownFiles())try{var a=await this.app.vault.read(e);new RegExp(`\\[[^\\]]*\\]\\(obsidian://dida-task\\?didaId=${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g").test(a)&&i.push(e)}catch(t){}return i}async jumpToDidaIdInFile(t,e=null){var i,a=await this.findFilesWithDidaId(t);0!==a.length&&(1===a.length?(i=a[0],await this.openFileAndLocateDidaId(i,t)):e?this.showFileSelectionDropdown(a,t,e):this.showFileSelectionModal(a,t))}async openFileAndLocateDidaId(t,d){try{let e=null;var i;for(i of this.app.workspace.getLeavesOfType("markdown"))if(i.view&&i.view.file&&i.view.file.path===t.path){e=i;break}e?this.app.workspace.setActiveLeaf(e):e=await this.app.workspace.openLinkText(t.path,"",!0),setTimeout(async()=>{let t=e.view;if(t&&t.editor){var a,s=t.editor.getValue(),n=s.split("\n");let e=-1,i=0;for(let t=0;t<n.length;t++){var r=n[t],l=r.match(/^(\s*)-\s*\[([ x])\]\s*(.+)/);if(l)if(new RegExp(`\\[[^\\]]*\\]\\(obsidian://dida-task\\?didaId=${d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`).test(r)){e=t,i=l[1].length;break}}-1!==e?(a={line:e,ch:i},t.editor.setCursor(a),t.editor.scrollIntoView(a,!0),a=n[e].length,t.editor.addHighlights([{line:e,from:0,to:a}]),setTimeout(()=>{t.editor&&t.editor.removeHighlights&&t.editor.removeHighlights()},3e3)):(a=new RegExp(`\\[[^\\]]*\\]\\(obsidian://dida-task\\?didaId=${d.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`,"g").exec(s))&&(a=a.index,a=(s=s.substring(0,a).split("\n")).length-1,s=s[s.length-1].length,t.editor.setCursor({line:a,ch:s}),t.editor.scrollIntoView({line:a,ch:s},!0))}},100)}catch(t){}}showFileSelectionDropdown(t,i,e){let a=document.createElement("div"),s=(a.className="dida-file-dropdown",a.createDiv("dida-file-list"));t.forEach(t=>{var e=s.createDiv("dida-file-item");e.createEl("span",{text:t.basename,cls:"dida-file-name"}),e.createEl("span",{text:t.path,cls:"dida-file-path"}),e.onclick=async()=>{a.remove(),await this.openFileAndLocateDidaId(t,i)}});t=e.getBoundingClientRect();a.style.position="absolute",a.style.top=t.bottom+5+"px",a.style.left=t.left+"px",a.style.zIndex="1000",document.body.appendChild(a);let n=t=>{a.contains(t.target)||e.contains(t.target)||(a.remove(),document.removeEventListener("click",n))};setTimeout(()=>{document.addEventListener("click",n)},100)}async deleteDidaIdFromMarkdown(t){try{this._isUpdatingNativeTaskStatus=!0;var e=await this.findFilesWithDidaId(t);if(0!==e.length)for(var i of e)try{var a=await this.app.vault.read(i),s=a.split("\n");let e=new RegExp(`\\[ğŸ”—Dida\\]\\(obsidian://dida-task\\?didaId=${t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\)`);var n=s.filter(t=>!e.test(t)).join("\n");n!==a&&await this.app.vault.modify(i,n)}catch(t){}}catch(t){}finally{this._isUpdatingNativeTaskStatus=!1}}showFileSelectionModal(t,i){let a=new Modal(this.app);a.titleEl.setText("é€‰æ‹©åŒ…å«ä»»åŠ¡é“¾æ¥çš„æ–‡ä»¶");var e=a.contentEl.createDiv();e.createEl("p",{text:`æ‰¾åˆ° ${t.length} ä¸ªåŒ…å«ä»»åŠ¡é“¾æ¥çš„æ–‡ä»¶:`});let s=e.createDiv("file-selection-list");t.forEach(t=>{var e=s.createDiv("file-item");e.createEl("span",{text:t.basename,cls:"file-name"}),e.createEl("span",{text:t.path,cls:"file-path"}),e.onclick=async()=>{a.close(),await this.openFileAndLocateDidaId(t,i)}}),a.open()}showTaskDetailsInView(t){var e,i,a,s;for(e of document.querySelectorAll(".dida-task-item, .dida-timeline-task-item"))if(e.getAttribute("data-task-id")===t.id)return void(e.classList.contains("dida-timeline-task-item")?(i=this.getTimelineModalSafely())&&i.toggleTimelineTaskDetails?(i.toggleTimelineTaskDetails(e,t),this.scrollToTaskItem(e)):(i=e.querySelector(".dida-timeline-task-title, .dida-task-title-clickable"))&&(a=new Event("click",{bubbles:!0}),i.dispatchEvent(a),this.scrollToTaskItem(e)):(i=e.querySelector(".dida-task-title, .dida-task-title-clickable"))?(a=new Event("click",{bubbles:!0}),i.dispatchEvent(a),this.scrollToTaskItem(e)):(s=this.getTaskViewSafely())&&(s.toggleTaskDetails(e,t),this.scrollToTaskItem(e)))}setupDidaLinkHandler(){new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{t.nodeType===Node.ELEMENT_NODE&&t.querySelectorAll('a[href*="obsidian://dida-task/"]').forEach(i=>{i.addEventListener("click",t=>{var e=i.href.split("obsidian://dida-task/")[1];this.openTaskDetails(e),t.preventDefault(),t.stopPropagation()})})})})}).observe(document.body,{childList:!0,subtree:!0})}};class AddTaskToProjectModal extends Modal{constructor(t,e){super(t),this.plugin=e,this.selectedDate=null,this.selectedEndDate=null,this.isAllDay=!1}onOpen(){var s=this.contentEl,n=(s.empty(),s.createEl("h2",{text:"åœ¨é¡¹ç›®ä¸­æ·»åŠ ä»»åŠ¡"}),this.getAvailableProjects());if(0===n.length)s.createEl("p",{text:"æ²¡æœ‰å¯ç”¨çš„é¡¹ç›®ï¼Œè¯·å…ˆåŒæ­¥æˆ–åˆ›å»ºé¡¹ç›®",cls:"dida-empty-state"});else{var r=s.createDiv(),l=(r.style.cssText="display: flex; gap: 15px; margin: 20px 0; align-items: flex-end;",r.createDiv());l.style.cssText="flex: 1;",l.createEl("label",{text:"é€‰æ‹©é¡¹ç›®ï¼š"});let e=l.createEl("select",{cls:"dida-project-select"});e.style.cssText="width: 100%; margin-top: 5px;",n.forEach(t=>{e.createEl("option",{value:JSON.stringify(t),text:t.name})});l=r.createEl("button",{text:"ğŸ“…",cls:"dida-date-btn"});l.style.cssText="width: 32px; height: 32px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-muted); cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; flex-shrink: 0;";let a=r.createEl("span",{text:"æœªè®¾ç½®",cls:"dida-date-display"});a.style.cssText="flex: 1; padding: 6px 8px; border: 1px solid var(--background-modifier-border); border-radius: 4px; background: var(--background-primary); color: var(--text-muted); font-size: 12px; display: flex; align-items: center;";n=s.createDiv();n.style.cssText="margin: 20px 0;",n.createEl("label",{text:"ä»»åŠ¡æ ‡é¢˜ï¼š"});let t=n.createEl("input",{type:"text",placeholder:"è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜",cls:"dida-task-title-input"});t.style.cssText="width: 100%; margin-top: 5px;",l.onclick=t=>{new DatePickerModal(this.app,this.selectedDate||new Date,(t,e,i)=>{this.selectedDate=t,this.selectedEndDate=i||null,this.isAllDay=e,this.selectedDate?(t=this.selectedDate.toLocaleDateString("zh-CN"),e?a.textContent=t+" å…¨å¤©":(i=this.selectedDate.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),e=(this.selectedEndDate||this.selectedDate).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"}),a.textContent=t+` ${i}ï½`+e),a.style.color="var(--text-normal)"):(a.textContent="æœªè®¾ç½®",a.style.color="var(--text-muted)")},t.currentTarget,null,null).open()};r=s.createDiv();r.style.cssText="text-align: right; margin-top: 20px;",r.createEl("button",{text:"å–æ¶ˆ"}).onclick=()=>this.close();let i=r.createEl("button",{text:"æ·»åŠ ä»»åŠ¡",cls:"mod-cta"});i.style.marginLeft="10px",i.onclick=async()=>{var i=JSON.parse(e.value),a=t.value.trim();if(a){let t=null,e=null;this.selectedDate&&(t=this.selectedDate.toISOString(),e=this.isAllDay?t:(this.selectedEndDate||this.selectedDate).toISOString());a={id:Date.now().toString(),title:a,content:"",completed:!1,status:0,completedTime:null,didaId:null,projectId:i.id,projectName:i.name,createdAt:(new Date).toISOString(),updatedAt:(new Date).toISOString(),startDate:t,dueDate:e,isAllDay:this.isAllDay||!1},i=(this.plugin.settings.tasks=this.plugin.settings.tasks||[],this.plugin.settings.tasks.push(a),this.plugin.saveSettings(),this.plugin.refreshTaskView(),document.querySelector(".dida-timeline-date-item.dida-timeline-selected"));if(i&&i.click(),this.plugin.settings.accessToken)try{await this.plugin.createTaskInDidaList(a),this.plugin.refreshTaskView(),i&&i.click()}catch(t){this.plugin.refreshTaskView(),i&&i.click()}this.close()}else new Notice("è¯·è¾“å…¥ä»»åŠ¡æ ‡é¢˜")},t.addEventListener("keypress",t=>{"Enter"===t.key&&i.click()}),setTimeout(()=>t.focus(),100)}}getAvailableProjects(){let e=[];e.push({id:"inbox",name:"æ”¶é›†ç®±"});var t=this.plugin.settings.tasks||[];let i=new Map;return t.forEach(t=>{var e;t.projectName&&t.projectId&&(e=t.projectId+"-"+t.projectName,i.has(e)||i.set(e,{id:t.projectId,name:t.projectName}))}),i.forEach(t=>{"inbox"!==t.id&&"æ”¶é›†ç®±"!==t.name&&e.push(t)}),e.sort((t,e)=>"æ”¶é›†ç®±"===t.name?-1:"æ”¶é›†ç®±"===e.name?1:t.name.localeCompare(e.name)),e}onClose(){var t=this.contentEl;t.empty()}}class TaskSuggestionPopup{constructor(t,e,i,a,s){this.app=t,this.plugin=e,this.editor=i,this.cursor=a,this.onSelect=s,this.filteredTasks=[],this.selectedIndex=0,this.searchTerm="",this.element=null}open(){this.element=document.createElement("div"),this.element.className="dida-task-suggestion-popup",this.searchTerm="",this.filterTasks(),this.renderSuggestions(),this.setupEventListeners(),document.body.appendChild(this.element)}getFilteredTasks(){return(this.plugin.settings.tasks||[]).filter(t=>!t.parentId&&!(t.completed&&(2===t.completed||!0===t.completed)||2===t.status||!this.plugin.settings.showArchivedProjects&&!0===t.projectClosed))}renderSuggestions(){this.element.innerHTML="";var t=document.createElement("div");t.className="dida-search-container";let e=document.createElement("input"),i=(e.type="text",e.className="dida-search-input",e.placeholder="æœç´¢ä»»åŠ¡æˆ–è¾“å…¥æ–°ä»»åŠ¡æ ‡é¢˜ï¼ˆEnterç¡®è®¤ï¼‰...",e.value=this.searchTerm,!1);if(e.addEventListener("compositionstart",()=>{i=!0}),e.addEventListener("compositionend",()=>{i=!1,this.searchTerm=e.value,this.filterTasks(),this.renderSuggestions()}),e.addEventListener("input",t=>{this.searchTerm=t.target.value,i||(this.filterTasks(),this.renderSuggestions())}),e.addEventListener("keydown",t=>{"Escape"===t.key&&(t.preventDefault(),this.close())}),t.appendChild(e),this.element.appendChild(t),setTimeout(()=>{e.focus()},10),this.searchTerm&&((t=document.createElement("div")).className="dida-search-hint",t.textContent=`æœç´¢ç»“æœ: ${this.filteredTasks.length} ä¸ªä»»åŠ¡`,this.element.appendChild(t)),0===this.filteredTasks.length)(t=document.createElement("div")).className="dida-no-tasks",t.textContent=this.searchTerm?"æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡ï¼ŒæŒ‰Enteråˆ›å»ºæ–°ä»»åŠ¡":"æ²¡æœ‰æ‰¾åˆ°ä»»åŠ¡",this.element.appendChild(t);else{let s=document.createElement("div");s.className="dida-suggestions-container",this.element.appendChild(s),this.filteredTasks.forEach((t,e)=>{var i,a=document.createElement("div"),e=(a.className="dida-suggestion-item "+(e===this.selectedIndex&&0<=this.selectedIndex?"selected":""),a.setAttribute("data-index",e),document.createElement("div"));e.className="dida-suggestion-title",e.textContent=t.title||"æ— æ ‡é¢˜ä»»åŠ¡",t.projectName&&((i=document.createElement("div")).className="dida-suggestion-project",i.textContent="é¡¹ç›®: "+t.projectName,a.appendChild(i)),t.completed&&e.classList.add("completed"),a.appendChild(e),s.appendChild(a)})}}setupEventListeners(){this.element.addEventListener("keydown",t=>{if(t.target.classList.contains("dida-search-input"))switch(t.key){case"ArrowDown":t.preventDefault(),0<this.filteredTasks.length&&(this.selectedIndex=this.selectedIndex<0?0:Math.min(this.selectedIndex+1,this.filteredTasks.length-1),this.renderSuggestions());break;case"ArrowUp":t.preventDefault(),0<this.filteredTasks.length&&(this.selectedIndex=this.selectedIndex<0?this.filteredTasks.length-1:Math.max(this.selectedIndex-1,0),this.renderSuggestions());break;case"Enter":t.preventDefault(),0<=this.selectedIndex&&this.selectedIndex<this.filteredTasks.length?this.selectTask():this.searchTerm.trim()&&this.createNewTask(this.searchTerm.trim())}else switch(t.key){case"ArrowDown":t.preventDefault(),0<this.filteredTasks.length&&(this.selectedIndex=this.selectedIndex<0?0:Math.min(this.selectedIndex+1,this.filteredTasks.length-1),this.renderSuggestions());break;case"ArrowUp":t.preventDefault(),0<this.filteredTasks.length&&(this.selectedIndex=this.selectedIndex<0?this.filteredTasks.length-1:Math.max(this.selectedIndex-1,0),this.renderSuggestions());break;case"Enter":t.preventDefault(),0<=this.selectedIndex&&this.selectedIndex<this.filteredTasks.length?this.selectTask():this.searchTerm.trim()&&this.createNewTask(this.searchTerm.trim());break;case"Escape":t.preventDefault(),this.close();break;case"Backspace":""===this.searchTerm&&(t.preventDefault(),this.close());break;default:1===t.key.length&&(this.searchTerm+=t.key,this.filterTasks(),this.renderSuggestions())}}),this.element.addEventListener("click",t=>{t=t.target.closest(".dida-suggestion-item");t&&(this.selectedIndex=parseInt(t.getAttribute("data-index")),this.selectTask())}),document.addEventListener("click",this.handleOutsideClick.bind(this))}handleOutsideClick(t){this.element&&!this.element.contains(t.target)&&this.close()}filterTasks(){var t=this.getFilteredTasks();this.searchTerm?this.filteredTasks=t.filter(t=>t.title&&t.title.toLowerCase().includes(this.searchTerm.toLowerCase())||t.projectName&&t.projectName.toLowerCase().includes(this.searchTerm.toLowerCase())).sort((t,e)=>new Date(e.updatedAt||e.createdAt)-new Date(t.updatedAt||t.createdAt)):this.filteredTasks=t.sort((t,e)=>new Date(e.updatedAt||e.createdAt)-new Date(t.updatedAt||t.createdAt)),this.selectedIndex=-1}selectTask(){var t;0<this.filteredTasks.length&&0<=this.selectedIndex&&this.selectedIndex<this.filteredTasks.length&&this.onSelect&&(t=this.filteredTasks[this.selectedIndex],this.onSelect(t)),this.close()}async createNewTask(t){this.close();try{let e=await this.plugin.addTask(t,"æ”¶é›†ç®±","inbox");var i,a=this.plugin.settings.tasks.find(t=>t.id===e.id);a&&a.didaId?this.plugin.insertTaskLink(this.editor,this.cursor,a):(i={...a||e,didaId:a?.id||e.id},this.plugin.insertTaskLink(this.editor,this.cursor,i))}catch(t){}}close(){this.element&&(document.removeEventListener("click",this.handleOutsideClick.bind(this)),document.body.removeChild(this.element),this.element=null)}}